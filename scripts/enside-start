#!/bin/bash

###############################################################################
#                                                                             #
#        ğŸ¯ ENSIDE START - SISTEMA COMPLETO EM UM COMANDO ğŸ¯                #
#                                                                             #
#  Executa TUDO em sequÃªncia:                                                #
#  1. Mata processos antigos                                                 #
#  2. Inicia Web Server (Python)                                             #
#  3. Abre 4 interfaces no Chrome                                            #
#                                                                             #
###############################################################################

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

clear

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                           â•‘"
echo "â•‘         ğŸ¯ ENSIDE START - INICIANDO SISTEMA COMPLETO ğŸ¯                  â•‘"
echo "â•‘                                                                           â•‘"
echo "â•‘         Web Server + 4 Interfaces + Chrome AutomÃ¡tico                     â•‘"
echo "â•‘                                                                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

EVOLUTION_DIR="/Users/andersonenside/evolution"
PUBLIC_DIR="$EVOLUTION_DIR/public"
WEB_PORT=9999

# ============================================================================
# FASE 1: Parar processos antigos
# ============================================================================

echo -e "${CYAN}[FASE 1/3] ğŸ§¹ Parando processos antigos...${NC}"
pkill -9 -f "python3.*http.server" 2>/dev/null || true
sleep 1
echo -e "${GREEN}âœ… Processos limpos${NC}"
echo ""

# ============================================================================
# FASE 2: Iniciar Web Server
# ============================================================================

echo -e "${CYAN}[FASE 2/3] ğŸŒ Iniciando Web Server...${NC}"
cd "$PUBLIC_DIR" || exit 1

python3 -m http.server $WEB_PORT > /tmp/web-server.log 2>&1 &
WEB_PID=$!
echo $WEB_PID > /tmp/web-server.pid

sleep 2

if ps -p $WEB_PID > /dev/null 2>&1; then
    echo -e "${GREEN}âœ… Web Server rodando na porta $WEB_PORT (PID: $WEB_PID)${NC}"
else
    echo -e "${RED}âŒ Erro ao iniciar Web Server!${NC}"
    cat /tmp/web-server.log
    exit 1
fi
echo ""

# ============================================================================
# FASE 3: Abrir interfaces no Chrome
# ============================================================================

echo -e "${CYAN}[FASE 3/3] ğŸ“– Abrindo interfaces no Chrome...${NC}"
echo ""

# URLs dos 4 HTMLs principais (com caminhos relativos corrigidos)
declare -a urls=(
    "http://localhost:$WEB_PORT/evolution-manager.html"
    "http://localhost:$WEB_PORT/ENSIDE_MASTER_v19.0_INTEGRADO.html"
    "http://localhost:$WEB_PORT/ENSIDE_MASTER_v20.0_UNIFICADO.html"
    "http://localhost:$WEB_PORT/centro-controle.html"
)

declare -a names=(
    "Evolution Manager"
    "Interface v19"
    "Interface v20"
    "Centro de Controle"
)

# Abrir cada URL no Chrome
for i in "${!urls[@]}"; do
    url="${urls[$i]}"
    name="${names[$i]}"
    
    echo -e "  ${GREEN}âœ…${NC} Abrindo: $name"
    echo "     URL: $url"
    
    open -a "Google Chrome" "$url" 2>/dev/null || open "$url" 2>/dev/null || true
    sleep 1
done

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                           â•‘"
echo "â•‘                 âœ… SISTEMA PRONTO E OPERACIONAL! âœ…                     â•‘"
echo "â•‘                                                                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo -e "${CYAN}ğŸ“ ACESSOS DISPONÃVEIS:${NC}"
echo ""
echo "  LOCAL (Seu computador):"
echo "    ğŸŒ Evolution Manager:     http://localhost:$WEB_PORT/evolution-manager.html"
echo "    ğŸ“± Interface v19:         http://localhost:$WEB_PORT/ENSIDE_MASTER_v19.0_INTEGRADO.html"
echo "    ğŸ“± Interface v20:         http://localhost:$WEB_PORT/ENSIDE_MASTER_v20.0_UNIFICADO.html"
echo "    ğŸ›ï¸  Centro de Controle:    http://localhost:$WEB_PORT/centro-controle.html"
echo ""
echo "  PRODUÃ‡ÃƒO (Vercel - Online):"
echo "    ğŸš€ API:                   https://evolution-rust.vercel.app"
echo ""

echo -e "${CYAN}ğŸ” CREDENCIAIS CONFIGURADAS:${NC}"
echo ""
echo "    API Key:  429683C4C977415CAAFCCE10F7D57E11"
echo "    InstÃ¢ncia: enside_whatsapp"
echo "    Provider: Baileys (WhatsApp Web)"
echo ""

echo -e "${YELLOW}ğŸ’¡ COMANDOS ÃšTEIS:${NC}"
echo ""
echo "  Abrir interfaces novamente:"
echo "    ${CYAN}$ enside-start${NC}"
echo ""
echo "  Ver status completo:"
echo "    ${CYAN}$ enside-status${NC}"
echo ""
echo "  Parar Web Server:"
echo "    ${CYAN}$ pkill -f 'http.server'${NC}"
echo ""
echo "  Ver logs:"
echo "    ${CYAN}$ tail -f /tmp/web-server.log${NC}"
echo ""

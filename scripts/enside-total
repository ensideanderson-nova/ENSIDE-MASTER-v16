#!/bin/bash

###############################################################################
#                                                                             #
#        ğŸš€ ENSIDE TOTAL - UM COMANDO PARA TUDO! ğŸš€                          #
#                                                                             #
#  Executa sequÃªncia completa:                                               #
#  1. âœ… Verifica prÃ©-requisitos                                             #
#  2. ğŸ§¹ Limpa processos antigos                                             #
#  3. ğŸ³ Inicia Docker (PostgreSQL + Redis)                                  #
#  4. ğŸ“¦ Instala/Atualiza dependÃªncias                                       #
#  5. ğŸ”¨ Compila Evolution API                                               #
#  6. ğŸš€ Inicia Evolution API                                                #
#  7. ğŸŒ Inicia Web Server (Python)                                          #
#  8. ğŸ“– Abre 4 HTMLs no Chrome (Evolution configurada)                       #
#                                                                             #
###############################################################################

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# VariÃ¡veis
EVOLUTION_DIR="/Users/andersonenside/evolution"
PUBLIC_DIR="$EVOLUTION_DIR/public"
API_PORT=8080
WEB_PORT=9999

# ============================================================================
# FUNÃ‡Ã•ES AUXILIARES
# ============================================================================

log_header() {
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

log_info() {
    echo -e "${YELLOW}â„¹ï¸  $1${NC}"
}

log_step() {
    echo -e "${CYAN}$1${NC}"
}

# ============================================================================
# FASE 1: VERIFICAR PRÃ‰-REQUISITOS
# ============================================================================

phase_1_check_prerequisites() {
    log_header "[FASE 1/8] ğŸ” Verificando PrÃ©-requisitos..."
    
    local all_ok=true
    
    # Docker
    if command -v docker &> /dev/null; then
        DOCKER_VERSION=$(docker --version | awk '{print $3}' | cut -d, -f1)
        log_success "Docker instalado ($DOCKER_VERSION)"
    else
        log_error "Docker nÃ£o encontrado"
        all_ok=false
    fi
    
    # Docker Compose
    if command -v docker-compose &> /dev/null; then
        DC_VERSION=$(docker-compose --version | awk '{print $3}' | cut -d, -f1)
        log_success "Docker Compose instalado ($DC_VERSION)"
    else
        log_error "Docker Compose nÃ£o encontrado"
        all_ok=false
    fi
    
    # Node.js
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node --version)
        log_success "Node.js instalado ($NODE_VERSION)"
    else
        log_error "Node.js nÃ£o encontrado"
        all_ok=false
    fi
    
    # npm
    if command -v npm &> /dev/null; then
        NPM_VERSION=$(npm --version)
        log_success "npm instalado (v$NPM_VERSION)"
    else
        log_error "npm nÃ£o encontrado"
        all_ok=false
    fi
    
    # Python3
    if command -v python3 &> /dev/null; then
        PYTHON_VERSION=$(python3 --version | awk '{print $2}')
        log_success "Python3 instalado ($PYTHON_VERSION)"
    else
        log_error "Python3 nÃ£o encontrado"
        all_ok=false
    fi
    
    if [ "$all_ok" = true ]; then
        log_success "Todos os prÃ©-requisitos OK"
    else
        log_error "Alguns prÃ©-requisitos estÃ£o faltando!"
        return 1
    fi
}

# ============================================================================
# FASE 2: LIMPAR PROCESSOS ANTIGOS
# ============================================================================

phase_2_cleanup_old_processes() {
    log_header "[FASE 2/8] ğŸ§¹ Limpando Processos Antigos..."
    
    log_info "Parando processos antigos..."
    
    # Parar Node.js
    pkill -9 -f "node.*dist/main.js" 2>/dev/null || true
    pkill -9 -f "npm.*start" 2>/dev/null || true
    
    # Parar Python
    pkill -9 -f "python3.*http.server" 2>/dev/null || true
    
    sleep 1
    
    log_success "Processos antigos removidos"
}

# ============================================================================
# FASE 3: INICIAR DOCKER SERVICES
# ============================================================================

phase_3_start_docker_services() {
    log_header "[FASE 3/8] ğŸ³ Iniciando Docker Services (PostgreSQL + Redis)..."
    
    cd "$EVOLUTION_DIR" || return 1
    
    log_info "Iniciando Docker Compose..."
    docker-compose up -d 2>&1 | grep -E "Running|created|already running" || true
    
    sleep 3
    
    # Verificar PostgreSQL
    if docker ps | grep -q "postgres"; then
        log_success "PostgreSQL iniciado"
    else
        log_error "PostgreSQL pode nÃ£o ter iniciado"
    fi
    
    # Verificar Redis
    if docker ps | grep -q "redis"; then
        log_success "Redis iniciado"
    else
        log_error "Redis pode nÃ£o ter iniciado"
    fi
}

# ============================================================================
# FASE 4: INSTALAR/ATUALIZAR DEPENDÃŠNCIAS
# ============================================================================

phase_4_install_dependencies() {
    log_header "[FASE 4/8] ğŸ“¦ Instalando/Atualizando DependÃªncias..."
    
    cd "$EVOLUTION_DIR" || return 1
    
    if [ ! -d "node_modules" ]; then
        log_info "Instalando dependÃªncias (primeira vez)..."
        npm install --silent 2>&1 | tail -3
    else
        log_info "DependÃªncias jÃ¡ instaladas, atualizando..."
        npm update --silent 2>&1 | tail -1
    fi
    
    log_success "DependÃªncias prontas"
}

# ============================================================================
# FASE 5: COMPILAR EVOLUTION API
# ============================================================================

phase_5_compile_api() {
    log_header "[FASE 5/8] ğŸ”¨ Compilando Evolution API..."
    
    cd "$EVOLUTION_DIR" || return 1
    
    if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
        log_info "Compilando TypeScript..."
        npm run build 2>&1 | tail -5
        log_success "CompilaÃ§Ã£o concluÃ­da"
    else
        log_success "API jÃ¡ compilada"
    fi
}

# ============================================================================
# FASE 6: INICIAR EVOLUTION API
# ============================================================================

phase_6_start_evolution_api() {
    log_header "[FASE 6/8] ğŸš€ Iniciando Evolution API..."
    
    cd "$EVOLUTION_DIR" || return 1
    
    # Iniciar em background
    log_info "Iniciando servidor API na porta $API_PORT..."
    npm start > /tmp/evolution-api.log 2>&1 &
    local API_PID=$!
    echo $API_PID > /tmp/evolution-api.pid
    
    log_info "Aguardando API inicializar..."
    sleep 5
    
    # Verificar se a API estÃ¡ rodando
    if ps -p $API_PID > /dev/null 2>&1; then
        log_success "Evolution API iniciada (PID: $API_PID)"
    else
        log_error "Falha ao iniciar Evolution API"
        tail -20 /tmp/evolution-api.log
        return 1
    fi
    
    # Aguardar API estar pronta
    local attempts=0
    while [ $attempts -lt 10 ]; do
        if curl -s http://localhost:$API_PORT/health > /dev/null 2>&1; then
            log_success "API respondendo no http://localhost:$API_PORT"
            break
        fi
        attempts=$((attempts + 1))
        sleep 1
    done
}

# ============================================================================
# FASE 7: INICIAR WEB SERVER
# ============================================================================

phase_7_start_web_server() {
    log_header "[FASE 7/8] ğŸŒ Iniciando Web Server (Python)..."
    
    cd "$PUBLIC_DIR" || return 1
    
    log_info "Parando servidor antigo..."
    pkill -9 -f "python3.*http.server" 2>/dev/null || true
    sleep 1
    
    log_info "Iniciando servidor na porta $WEB_PORT..."
    python3 -m http.server $WEB_PORT > /tmp/web-server.log 2>&1 &
    local WEB_PID=$!
    echo $WEB_PID > /tmp/web-server.pid
    
    sleep 1
    
    if ps -p $WEB_PID > /dev/null 2>&1; then
        log_success "Web Server iniciado (PID: $WEB_PID)"
        log_success "Acesso em http://localhost:$WEB_PORT"
    else
        log_error "Falha ao iniciar Web Server"
        return 1
    fi
}

# ============================================================================
# FASE 8: ABRIR INTERFACES HTML
# ============================================================================

phase_8_open_html_interfaces() {
    log_header "[FASE 8/8] ğŸ“– Abrindo Interfaces HTML no Chrome..."
    
    # Array com os 4 HTMLs principais
    local htmls=(
        "evolution-manager.html"
        "ENSIDE_MASTER_v19.0_INTEGRADO.html"
        "ENSIDE_MASTER_v20.0_UNIFICADO.html"
        "centro-controle.html"
    )
    
    log_info "Abrindo interfaces com Evolution API configurada..."
    echo ""
    
    for i in "${!htmls[@]}"; do
        local html="${htmls[$i]}"
        local file="$PUBLIC_DIR/$html"
        
        if [ -f "$file" ]; then
            local url="file://$file"
            log_step "  [$((i+1))/4] Abrindo: $html"
            
            # Usar open para abrir no Chrome
            open -a "Google Chrome" "$url" 2>/dev/null || \
            open "$url" 2>/dev/null || true
            
            sleep 1
        else
            log_error "Arquivo nÃ£o encontrado: $html"
        fi
    done
    
    echo ""
    log_success "Todas as interfaces foram abertas no Chrome!"
}

# ============================================================================
# RESUMO FINAL
# ============================================================================

show_final_summary() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                                           â•‘"
    echo "â•‘                  âœ… SISTEMA 100% OPERACIONAL! âœ…                        â•‘"
    echo "â•‘                                                                           â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    echo -e "${GREEN}ğŸ“Š RESUMO DE SERVIÃ‡OS:${NC}"
    echo ""
    echo "  ğŸ³ Docker:"
    docker ps --format "table {{.Names}}\t{{.Status}}" 2>/dev/null || echo "    N/A"
    echo ""
    
    echo -e "${GREEN}ğŸŒ ACESSOS:${NC}"
    echo "  â€¢ Evolution API:  http://localhost:$API_PORT"
    echo "  â€¢ Web Server:     http://localhost:$WEB_PORT"
    echo "  â€¢ Chrome:         4 abas abertas"
    echo ""
    
    echo -e "${GREEN}ğŸ“ LOGS:${NC}"
    echo "  â€¢ API:        /tmp/evolution-api.log"
    echo "  â€¢ Web Server: /tmp/web-server.log"
    echo ""
    
    echo -e "${GREEN}ğŸ”§ PARAR SERVIÃ‡OS:${NC}"
    echo "  $ docker-compose down"
    echo "  $ pkill -f 'npm start'"
    echo "  $ pkill -f 'http.server'"
    echo ""
}

# ============================================================================
# FUNÃ‡ÃƒO PRINCIPAL
# ============================================================================

main() {
    clear
    
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                                           â•‘"
    echo "â•‘          ğŸš€ ENSIDE TOTAL - SISTEMA COMPLETO EM UM COMANDO! ğŸš€            â•‘"
    echo "â•‘                                                                           â•‘"
    echo "â•‘   Docker + PostgreSQL + Redis + Evolution API + 4 HTMLs + Chrome         â•‘"
    echo "â•‘                                                                           â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    # Executar todas as fases
    phase_1_check_prerequisites || exit 1
    phase_2_cleanup_old_processes || exit 1
    phase_3_start_docker_services || exit 1
    phase_4_install_dependencies || exit 1
    phase_5_compile_api || exit 1
    phase_6_start_evolution_api || exit 1
    phase_7_start_web_server || exit 1
    phase_8_open_html_interfaces || exit 1
    
    # Mostrar resumo
    show_final_summary
}

# ============================================================================
# EXECUTAR
# ============================================================================

main

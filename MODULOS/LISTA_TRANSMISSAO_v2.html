<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Transmiss√£o - ENSIDE CRM v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; min-height: 100vh; padding: 20px; }
        .card { background: rgba(30, 41, 59, 0.9); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .search-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 12px; color: white; width: 100%; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(0,0,0,0.3); }
        tr:hover { background: rgba(14,165,233,0.1); }
        .checkbox { width: 20px; height: 20px; cursor: pointer; }
        .selected-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; padding: 15px 30px; border-top: 2px solid #0ea5e9; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-fornecedor { background: #22c55e; color: white; }
        .badge-cliente { background: #3b82f6; color: white; }
        .badge-transportador { background: #f59e0b; color: white; }
        .badge-representante { background: #8b5cf6; color: white; }
        select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; color: white; }
        .stats-bar { display: flex; gap: 20px; margin-bottom: 15px; }
        .stat-item { background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 8px; }
        .stat-number { font-size: 1.5rem; font-weight: 700; color: #0ea5e9; }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 10px;">üìã Lista de Transmiss√£o WhatsApp v2</h1>
        <p style="color: #94a3b8; margin-bottom: 20px;">Pesquise, selecione contatos e crie listas para envio em massa - CORRIGIDO</p>
        
        <!-- Estat√≠sticas -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="statTotal">0</div>
                <div style="color: #94a3b8; font-size: 0.8rem;">Total Contatos</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statFornecedores" style="color: #22c55e;">0</div>
                <div style="color: #94a3b8; font-size: 0.8rem;">Fornecedores</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statClientes" style="color: #3b82f6;">0</div>
                <div style="color: #94a3b8; font-size: 0.8rem;">Clientes</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statTransportadores" style="color: #f59e0b;">0</div>
                <div style="color: #94a3b8; font-size: 0.8rem;">Transportadores</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statRepresentantes" style="color: #8b5cf6;">0</div>
                <div style="color: #94a3b8; font-size: 0.8rem;">Representantes</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card">
            <h3 style="font-weight: 600; margin-bottom: 15px;">üîç Filtrar Contatos</h3>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                <input type="text" id="searchNome" class="search-input" placeholder="Buscar por nome..." onkeyup="filtrarContatos()">
                <select id="filterCategoria" onchange="filtrarContatos()">
                    <option value="">Todas Categorias</option>
                    <option value="FORNECEDOR">üå≤ Fornecedor</option>
                    <option value="CLIENTE">üë§ Cliente</option>
                    <option value="TRANSPORTADOR">üöö Transportador</option>
                    <option value="REPRESENTANTE">üíº Representante</option>
                </select>
                <select id="filterSubcategoria" onchange="filtrarContatos()">
                    <option value="">Todas Subcategorias</option>
                </select>
                <button class="btn btn-danger" onclick="limparFiltros()">‚ùå Limpar Filtros</button>
            </div>
        </div>

        <!-- A√ß√µes -->
        <div class="card" style="display: flex; gap: 15px; align-items: center;">
            <button class="btn btn-primary" onclick="selecionarTodosFiltrados()">‚òëÔ∏è Selecionar Filtrados</button>
            <button class="btn btn-warning" onclick="desmarcarTodos()">‚¨ú Desmarcar Todos</button>
            <button class="btn btn-success" onclick="sincronizarPlanilha()">üîÑ Sincronizar Planilha</button>
            <span id="totalContatos" style="margin-left: auto; color: #94a3b8;">Carregando...</span>
        </div>

        <!-- Tabela -->
        <div class="card" style="max-height: 500px; overflow-y: auto; margin-bottom: 80px;">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" class="checkbox" onclick="toggleTodos(this)"></th>
                        <th>Nome</th>
                        <th>WhatsApp</th>
                        <th>Categoria</th>
                        <th>Subcategoria</th>
                    </tr>
                </thead>
                <tbody id="tabelaContatos"></tbody>
            </table>
        </div>
    </div>

    <!-- Barra de Selecionados -->
    <div class="selected-bar">
        <div>
            <span style="font-size: 1.2rem; font-weight: 700;">üì± <span id="qtdSelecionados">0</span> contatos selecionados</span>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <input type="text" id="nomeLista" class="search-input" style="width: 250px;" placeholder="Nome da lista...">
            <button class="btn btn-primary" onclick="salvarListaSemEnviar()" style="font-size: 1rem;">
                üíæ SALVAR LISTA
            </button>
            <button class="btn btn-success" onclick="criarListaEEnviar()" style="font-size: 1.1rem;">
                üì§ CRIAR E ENVIAR
            </button>
        </div>
    </div>

    <script>
        const SPREADSHEET_ID = '1FiP885Or0ncyRG_ZZaAvM2vP0sHhDzhLFYifYLjKyIE';
        let todosContatos = [];
        let contatosFiltrados = [];
        let selecionados = new Set();
        let subcategorias = new Set();

        async function carregarContatos() {
            try {
                document.getElementById('totalContatos').textContent = 'Carregando...';
                
                const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=CONTATOS`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                
                // Mapear colunas corretamente:
                // A=0 (checkbox), B=1 (NOME), C=2 (TELEFONE), D=3 (CATEGORIA), E=4 (SUBCATEGORIA)
                todosContatos = json.table.rows.slice(1).map((row, idx) => {
                    const categoria = String(row.c[3]?.v || '').toUpperCase().trim();
                    const subcategoria = String(row.c[4]?.v || '').trim();
                    
                    if (subcategoria) subcategorias.add(subcategoria);
                    
                    return {
                        id: idx,
                        nome: String(row.c[1]?.v || '').trim(),
                        telefone: String(row.c[2]?.v || '').trim(),
                        categoria: categoria,
                        subcategoria: subcategoria
                    };
                }).filter(c => c.nome && c.telefone);
                
                contatosFiltrados = [...todosContatos];
                
                // Atualizar dropdown de subcategorias
                atualizarSubcategorias();
                
                // Atualizar estat√≠sticas
                atualizarEstatisticas();
                
                renderizarTabela();
                document.getElementById('totalContatos').textContent = `${todosContatos.length} contatos carregados`;
                
                console.log('‚úÖ Contatos carregados:', todosContatos.length);
                console.log('Categorias encontradas:', [...new Set(todosContatos.map(c => c.categoria))]);
                
            } catch (error) {
                console.error('Erro ao carregar:', error);
                document.getElementById('totalContatos').textContent = 'Erro ao carregar - Clique em Sincronizar';
            }
        }

        function atualizarSubcategorias() {
            const select = document.getElementById('filterSubcategoria');
            select.innerHTML = '<option value="">Todas Subcategorias</option>';
            [...subcategorias].sort().forEach(sub => {
                select.innerHTML += `<option value="${sub}">${sub}</option>`;
            });
        }

        function atualizarEstatisticas() {
            const stats = {
                total: todosContatos.length,
                fornecedores: todosContatos.filter(c => c.categoria === 'FORNECEDOR').length,
                clientes: todosContatos.filter(c => c.categoria === 'CLIENTE').length,
                transportadores: todosContatos.filter(c => c.categoria === 'TRANSPORTADOR').length,
                representantes: todosContatos.filter(c => c.categoria === 'REPRESENTANTE').length
            };
            
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statFornecedores').textContent = stats.fornecedores;
            document.getElementById('statClientes').textContent = stats.clientes;
            document.getElementById('statTransportadores').textContent = stats.transportadores;
            document.getElementById('statRepresentantes').textContent = stats.representantes;
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabelaContatos');
            const maxRows = 500; // Mostrar mais linhas
            
            tbody.innerHTML = contatosFiltrados.slice(0, maxRows).map(c => `
                <tr>
                    <td><input type="checkbox" class="checkbox" data-id="${c.id}" ${selecionados.has(c.id) ? 'checked' : ''} onchange="toggleSelecao(${c.id})"></td>
                    <td><strong>${c.nome}</strong></td>
                    <td>${formatarTelefone(c.telefone)}</td>
                    <td><span class="badge badge-${c.categoria.toLowerCase()}">${c.categoria || 'N/A'}</span></td>
                    <td>${c.subcategoria || '-'}</td>
                </tr>
            `).join('');
            
            atualizarContador();
            
            if (contatosFiltrados.length > maxRows) {
                tbody.innerHTML += `<tr><td colspan="5" style="text-align: center; color: #f59e0b;">
                    ‚ö†Ô∏è Mostrando ${maxRows} de ${contatosFiltrados.length} contatos. Use os filtros para refinar.
                </td></tr>`;
            }
        }

        function formatarTelefone(tel) {
            const nums = String(tel).replace(/\D/g, '');
            if (nums.length === 13) return `+${nums.slice(0,2)} (${nums.slice(2,4)}) ${nums.slice(4,9)}-${nums.slice(9)}`;
            if (nums.length === 11) return `(${nums.slice(0,2)}) ${nums.slice(2,7)}-${nums.slice(7)}`;
            return tel;
        }

        function filtrarContatos() {
            const nome = document.getElementById('searchNome').value.toLowerCase().trim();
            const categoria = document.getElementById('filterCategoria').value.toUpperCase();
            const subcategoria = document.getElementById('filterSubcategoria').value;
            
            console.log('üîç Filtros:', { nome, categoria, subcategoria });
            
            contatosFiltrados = todosContatos.filter(c => {
                // Filtro por nome
                if (nome && !c.nome.toLowerCase().includes(nome)) return false;
                
                // Filtro por categoria (case insensitive)
                if (categoria && c.categoria !== categoria) {
                    console.log(`Categoria n√£o bate: ${c.categoria} !== ${categoria}`);
                    return false;
                }
                
                // Filtro por subcategoria
                if (subcategoria && c.subcategoria !== subcategoria) return false;
                
                return true;
            });
            
            console.log(`‚úÖ Filtrados: ${contatosFiltrados.length} de ${todosContatos.length}`);
            document.getElementById('totalContatos').textContent = `${contatosFiltrados.length} de ${todosContatos.length} contatos`;
            renderizarTabela();
        }

        function limparFiltros() {
            document.getElementById('searchNome').value = '';
            document.getElementById('filterCategoria').value = '';
            document.getElementById('filterSubcategoria').value = '';
            contatosFiltrados = [...todosContatos];
            document.getElementById('totalContatos').textContent = `${todosContatos.length} contatos`;
            renderizarTabela();
        }

        function toggleSelecao(id) {
            if (selecionados.has(id)) selecionados.delete(id);
            else selecionados.add(id);
            atualizarContador();
        }

        function toggleTodos(checkbox) {
            contatosFiltrados.slice(0, 500).forEach(c => {
                if (checkbox.checked) selecionados.add(c.id);
                else selecionados.delete(c.id);
            });
            renderizarTabela();
        }

        function selecionarTodosFiltrados() {
            contatosFiltrados.forEach(c => selecionados.add(c.id));
            renderizarTabela();
            alert(`‚úÖ ${contatosFiltrados.length} contatos selecionados!`);
        }

        function desmarcarTodos() {
            selecionados.clear();
            renderizarTabela();
        }

        function atualizarContador() {
            document.getElementById('qtdSelecionados').textContent = selecionados.size;
        }

        function sincronizarPlanilha() {
            todosContatos = [];
            selecionados.clear();
            subcategorias.clear();
            carregarContatos();
        }

        // Salvar lista na planilha (sem enviar)
        async function salvarListaSemEnviar() {
            if (selecionados.size === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos 1 contato!');
                return;
            }
            
            const nomeLista = document.getElementById('nomeLista').value || 'Lista ' + new Date().toLocaleDateString('pt-BR');
            const contatos = todosContatos.filter(c => selecionados.has(c.id));
            
            // Determinar categoria predominante
            const categorias = contatos.map(c => c.categoria);
            const categoriaPredominante = categorias.sort((a,b) =>
                categorias.filter(v => v===a).length - categorias.filter(v => v===b).length
            ).pop() || 'MISTA';
            
            // Coletar telefones
            const telefones = contatos.map(c => c.telefone.replace(/\D/g, '')).join(',');
            
            alert(`üíæ Lista "${nomeLista}" salva!

‚úÖ ${contatos.length} contatos
üè∑Ô∏è Categoria: ${categoriaPredominante}

‚û°Ô∏è Abra a planilha MINHAS_LISTAS para ver`);
            
            // Abrir planilha para adicionar manualmente
            window.open(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit#gid=1114979046`, '_blank');
        }

        // Configura√ß√£o da Evolution API
        const EVOLUTION_CONFIG = {
            url: 'https://evolution-api-latest-poc1.onrender.com',
            apiKey: 'evolution-api-enside-2024-secret',
            instance: 'ENSIDE'
        };

        async function criarListaEEnviar() {
            if (selecionados.size === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos 1 contato!');
                return;
            }
            
            const nomeLista = document.getElementById('nomeLista').value || 'Lista ' + new Date().toLocaleDateString('pt-BR');
            const contatos = todosContatos.filter(c => selecionados.has(c.id));
            
            const mensagem = prompt('Digite a mensagem para enviar:', 'üå≤ Ol√°! Somos a ENSIDE MADEIRAS. Confira nossas ofertas de eucalipto tratado!');
            if (!mensagem) return;
            
            if (!confirm(`üì® Enviar mensagem para ${contatos.length} contatos?\n\nLista: ${nomeLista}\nMensagem: ${mensagem.substring(0, 50)}...`)) {
                return;
            }
            
            // Mostrar progresso
            const progressDiv = document.createElement('div');
            progressDiv.id = 'progressoEnvio';
            progressDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 30px; border-radius: 12px; border: 2px solid #0ea5e9; z-index: 9999; min-width: 400px; text-align: center;';
            progressDiv.innerHTML = '<h3 style="color: #0ea5e9;">üì® Enviando...</h3><p>Preparando...</p>';
            document.body.appendChild(progressDiv);
            
            let enviados = 0, erros = 0;
            
            for (const contato of contatos) {
                let numero = contato.telefone.replace(/\D/g, '');
                if (numero.length === 11 || numero.length === 10) numero = '55' + numero;
                
                progressDiv.innerHTML = `
                    <h3 style="color: #0ea5e9;">üì® Enviando...</h3>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin: 15px 0;">
                        <div style="background: #22c55e; width: ${Math.round(((enviados + erros) / contatos.length) * 100)}%; height: 20px;"></div>
                    </div>
                    <p>‚úÖ ${enviados} | ‚ùå ${erros} | Total: ${contatos.length}</p>
                    <p style="color: #94a3b8; font-size: 0.9em;">Enviando para: ${contato.nome}</p>
                `;
                
                try {
                    const response = await fetch(`${EVOLUTION_CONFIG.url}/message/sendText/${EVOLUTION_CONFIG.instance}`, {
                        method: 'POST',
                        headers: { 'apikey': EVOLUTION_CONFIG.apiKey, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ number: numero, text: mensagem })
                    });
                    if (response.ok) enviados++;
                    else erros++;
                } catch (e) {
                    erros++;
                }
                
                await new Promise(r => setTimeout(r, 2500));
            }
            
            document.body.removeChild(progressDiv);
            alert(`üì® Envio conclu√≠do!\n\n‚úÖ Enviados: ${enviados}\n‚ùå Erros: ${erros}\nüìä Total: ${contatos.length}`);
            
            selecionados.clear();
            renderizarTabela();
        }

        // Inicializar
        carregarContatos();
    </script>
</body>
</html>
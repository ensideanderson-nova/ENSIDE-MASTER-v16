<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Transmiss√£o - ENSIDE CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; min-height: 100vh; padding: 20px; }
        .card { background: rgba(30, 41, 59, 0.9); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .search-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 12px; color: white; width: 100%; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(0,0,0,0.3); }
        tr:hover { background: rgba(14,165,233,0.1); }
        .checkbox { width: 20px; height: 20px; cursor: pointer; }
        .selected-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; padding: 15px 30px; border-top: 2px solid #0ea5e9; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-green { background: #22c55e; }
        .badge-blue { background: #3b82f6; }
        .badge-orange { background: #f59e0b; }
        select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; color: white; }
    </style>
<script src="CONFIG/INTEGRACAO_COMPLETA.js"></script><script src="CONFIG/ESPECIALISTA_IA.js"></script></head>
<body>
    <div class="max-w-7xl mx-auto">
        <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 10px;">üìã Lista de Transmiss√£o WhatsApp</h1>
        <p style="color: #94a3b8; margin-bottom: 20px;">Pesquise, selecione contatos e crie listas para envio em massa</p>
        
        <!-- Filtros -->
        <div class="card">
            <h3 style="font-weight: 600; margin-bottom: 15px;">üîç Filtrar Contatos</h3>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                <input type="text" id="searchNome" class="search-input" placeholder="Buscar por nome..." onkeyup="filtrarContatos()">
                <select id="filterCategoria" onchange="filtrarContatos()">
                    <option value="">Todas Categorias</option>
                    <option value="FORNECEDOR">Fornecedor</option>
                    <option value="CLIENTE">Cliente</option>
                    <option value="TRANSPORTADOR">Transportador</option>
                    <option value="REPRESENTANTE">Representante</option>
                </select>
                <select id="filterStatus" onchange="filtrarContatos()">
                    <option value="">Todos Status</option>
                    <option value="ATIVO">Ativo</option>
                    <option value="VIP">VIP</option>
                    <option value="NOVO">Novo</option>
                </select>
                <select id="filterUF" onchange="filtrarContatos()">
                    <option value="">Todos Estados</option>
                    <option value="SP">S√£o Paulo</option>
                    <option value="PR">Paran√°</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="RJ">Rio de Janeiro</option>
                </select>
            </div>
        </div>

        <!-- A√ß√µes -->
        <div class="card" style="display: flex; gap: 15px; align-items: center;">
            <button class="btn btn-primary" onclick="selecionarTodos()">‚òëÔ∏è Selecionar Todos</button>
            <button class="btn btn-warning" onclick="desmarcarTodos()">‚¨ú Desmarcar Todos</button>
            <button class="btn btn-success" onclick="sincronizarPlanilha()">üîÑ Sincronizar Planilha</button>
            <span id="totalContatos" style="margin-left: auto; color: #94a3b8;">Carregando...</span>
        </div>

        <!-- Tabela -->
        <div class="card" style="max-height: 500px; overflow-y: auto; margin-bottom: 80px;">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" class="checkbox" onclick="toggleTodos(this)"></th>
                        <th>Nome</th>
                        <th>WhatsApp</th>
                        <th>Categoria</th>
                        <th>Cidade/UF</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tabelaContatos"></tbody>
            </table>
        </div>
    </div>

    <!-- Barra de Selecionados -->
    <div class="selected-bar">
        <div>
            <span style="font-size: 1.2rem; font-weight: 700;">üì± <span id="qtdSelecionados">0</span> contatos selecionados</span>
        </div>
        <div style="display: flex; gap: 15px;">
            <input type="text" id="nomeLista" class="search-input" style="width: 250px;" placeholder="Nome da lista...">
            <button class="btn btn-success" onclick="criarLista()" style="font-size: 1.1rem;">
                üì§ CRIAR LISTA E ENVIAR
            </button>
        </div>
    </div>

    <script>
        const SPREADSHEET_ID = '1FiP885Or0ncyRG_ZZaAvM2vP0sHhDzhLFYifYLjKyIE';
        let todosContatos = [];
        let contatosFiltrados = [];
        let selecionados = new Set();

        async function carregarContatos() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=CONTATOS`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                
                todosContatos = json.table.rows.slice(1).map((row, idx) => ({
                    id: idx,
                    nome: row.c[1]?.v || '',           // Coluna B = NOME
                    telefone: String(row.c[2]?.v || ''), // Coluna C = TELEFONE
                    categoria: row.c[3]?.v || '',       // Coluna D = CATEGORIA
                    subcategoria: row.c[4]?.v || '',    // Coluna E = SUBCATEGORIA
                    cidade: '',
                    uf: '',
                    status: 'ATIVO'
                })).filter(c => c.nome && c.telefone && c.telefone.length >= 10);
                
                contatosFiltrados = [...todosContatos];
                renderizarTabela();
                document.getElementById('totalContatos').textContent = `${todosContatos.length} contatos carregados`;
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('totalContatos').textContent = 'Erro ao carregar';
            }
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabelaContatos');
            tbody.innerHTML = contatosFiltrados.slice(0, 200).map(c => `
                <tr>
                    <td><input type="checkbox" class="checkbox" data-id="${c.id}" ${selecionados.has(c.id) ? 'checked' : ''} onchange="toggleSelecao(${c.id})"></td>
                    <td><strong>${c.nome}</strong></td>
                    <td>${formatarTelefone(c.telefone)}</td>
                    <td><span class="badge ${getBadgeClass(c.categoria)}">${c.categoria}</span></td>
                    <td>${c.cidade}/${c.uf}</td>
                    <td><span class="badge ${c.status === 'VIP' ? 'badge-orange' : 'badge-green'}">${c.status}</span></td>
                </tr>
            `).join('');
            atualizarContador();
        }

        function formatarTelefone(tel) {
            const nums = tel.replace(/\D/g, '');
            if (nums.length === 13) return `+${nums.slice(0,2)} (${nums.slice(2,4)}) ${nums.slice(4,9)}-${nums.slice(9)}`;
            return tel;
        }

        function getBadgeClass(cat) {
            const classes = { 'FORNECEDOR': 'badge-green', 'CLIENTE': 'badge-blue', 'TRANSPORTADOR': 'badge-orange' };
            return classes[cat] || 'badge-blue';
        }

        function filtrarContatos() {
            const nome = document.getElementById('searchNome').value.toLowerCase();
            const categoria = document.getElementById('filterCategoria').value;
            const status = document.getElementById('filterStatus').value;
            const uf = document.getElementById('filterUF').value;
            
            console.log('Filtros aplicados:', { nome, categoria, status, uf });
            console.log('Total contatos antes do filtro:', todosContatos.length);
            
            contatosFiltrados = todosContatos.filter(c => {
                // Filtro por nome
                if (nome && !c.nome.toLowerCase().includes(nome)) return false;
                
                // Filtro por categoria (case insensitive)
                if (categoria && c.categoria.toUpperCase() !== categoria.toUpperCase()) return false;
                
                // Filtro por status (case insensitive)
                if (status && c.status.toUpperCase() !== status.toUpperCase()) return false;
                
                // Filtro por UF (case insensitive)
                if (uf && c.uf.toUpperCase() !== uf.toUpperCase()) return false;
                
                return true;
            });
            
            console.log('Total contatos ap√≥s filtro:', contatosFiltrados.length);
            document.getElementById('totalContatos').textContent = `${contatosFiltrados.length} contatos filtrados de ${todosContatos.length}`;
            renderizarTabela();
        }

        function toggleSelecao(id) {
            if (selecionados.has(id)) selecionados.delete(id);
            else selecionados.add(id);
            atualizarContador();
        }

        function toggleTodos(checkbox) {
            contatosFiltrados.slice(0, 200).forEach(c => {
                if (checkbox.checked) selecionados.add(c.id);
                else selecionados.delete(c.id);
            });
            renderizarTabela();
        }

        function selecionarTodos() {
            contatosFiltrados.forEach(c => selecionados.add(c.id));
            renderizarTabela();
        }

        function desmarcarTodos() {
            selecionados.clear();
            renderizarTabela();
        }

        function atualizarContador() {
            document.getElementById('qtdSelecionados').textContent = selecionados.size;
        }

        function sincronizarPlanilha() {
            todosContatos = [];
            selecionados.clear();
            carregarContatos();
        }

        // Configura√ß√£o da Evolution API - LOCALHOST (Docker)
        const EVOLUTION_CONFIG = {
            url: 'http://localhost:8080',
            apiKey: '919AA333-AE59-4B06-B1EF-C9A9F9C8C0F6',
            instance: 'enside'
        };

        // Fun√ß√£o para enviar mensagem com retry
        async function enviarMensagemComRetry(numero, mensagem, maxRetries = 2) {
            for (let tentativa = 1; tentativa <= maxRetries; tentativa++) {
                try {
                    const response = await fetch(`${EVOLUTION_CONFIG.url}/message/sendText/${EVOLUTION_CONFIG.instance}`, {
                        method: 'POST',
                        headers: {
                            'apikey': EVOLUTION_CONFIG.apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            number: numero,
                            textMessage: { text: mensagem }
                        })
                    });
                    
                    if (response.ok) {
                        return { success: true, data: await response.json() };
                    }
                    
                    const errorText = await response.text();
                    console.warn(`Tentativa ${tentativa}/${maxRetries} falhou:`, errorText);
                    
                    if (tentativa < maxRetries) {
                        await new Promise(r => setTimeout(r, 3000)); // Esperar 3s antes de retry
                    }
                } catch (error) {
                    console.warn(`Tentativa ${tentativa}/${maxRetries} erro:`, error);
                    if (tentativa < maxRetries) {
                        await new Promise(r => setTimeout(r, 3000));
                    }
                }
            }
            return { success: false };
        }

        // Fun√ß√£o para acordar a API (warm up)
        async function acordarAPI() {
            try {
                const response = await fetch(`${EVOLUTION_CONFIG.url}/instance/fetchInstances`, {
                    headers: { 'apikey': EVOLUTION_CONFIG.apiKey }
                });
                return response.ok;
            } catch (e) {
                return false;
            }
        }

        async function criarLista() {
            if (selecionados.size === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos 1 contato!');
                return;
            }
            
            const nomeLista = document.getElementById('nomeLista').value || 'Lista ' + new Date().toLocaleDateString();
            let contatos = todosContatos.filter(c => selecionados.has(c.id));
            
            // Limitar a 30 contatos para teste
            const LIMITE = 30;
            if (contatos.length > LIMITE) {
                if (!confirm(`‚ö†Ô∏è Voc√™ selecionou ${contatos.length} contatos.\n\nDeseja enviar apenas para os primeiros ${LIMITE}?`)) {
                    return;
                }
                contatos = contatos.slice(0, LIMITE);
            }
            
            // Perguntar a mensagem
            const mensagem = prompt('Digite a mensagem para enviar:', 'üå≤ Ol√°! Somos a ENSIDE MADEIRAS. Confira nossas ofertas de eucalipto tratado!');
            if (!mensagem) return;
            
            // Confirmar envio
            if (!confirm(`üì® Enviar mensagem para ${contatos.length} contatos?\n\nLista: ${nomeLista}\nMensagem: ${mensagem.substring(0, 50)}...`)) {
                return;
            }
            
            // Criar elemento de progresso
            const progressDiv = document.createElement('div');
            progressDiv.id = 'progressoEnvio';
            progressDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 30px; border-radius: 12px; border: 2px solid #0ea5e9; z-index: 9999; min-width: 400px; text-align: center;';
            progressDiv.innerHTML = '<h3 style="color: #0ea5e9; margin-bottom: 15px;">üì® Preparando envio...</h3><p>Acordando servidor da API...</p>';
            document.body.appendChild(progressDiv);
            
            // Acordar a API primeiro
            console.log('üîÑ Acordando Evolution API...');
            await acordarAPI();
            await new Promise(r => setTimeout(r, 2000)); // Esperar 2s ap√≥s acordar
            
            progressDiv.innerHTML = '<h3 style="color: #0ea5e9; margin-bottom: 15px;">üì® Enviando mensagens...</h3><p>Iniciando...</p>';
            
            let enviados = 0;
            let erros = 0;
            
            for (const contato of contatos) {
                // Formatar n√∫mero
                let numero = contato.telefone.replace(/\D/g, '');
                if (numero.length === 11 || numero.length === 10) {
                    numero = '55' + numero;
                }
                
                // Atualizar progresso - enviando
                progressDiv.innerHTML = `
                    <h3 style="color: #0ea5e9; margin-bottom: 15px;">üì® Enviando mensagens...</h3>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin: 15px 0;">
                        <div style="background: linear-gradient(90deg, #22c55e, #16a34a); width: ${Math.round(((enviados + erros) / contatos.length) * 100)}%; height: 25px; transition: width 0.3s;"></div>
                    </div>
                    <p>‚úÖ Enviados: ${enviados} | ‚ùå Erros: ${erros} | Total: ${contatos.length}</p>
                    <p style="color: #94a3b8; font-size: 0.9em; margin-top: 10px;">Enviando para: ${contato.nome} (${numero})</p>
                `;
                
                const resultado = await enviarMensagemComRetry(numero, mensagem);
                
                if (resultado.success) {
                    enviados++;
                    console.log(`‚úÖ Enviado para ${contato.nome}: ${numero}`);
                } else {
                    erros++;
                    console.error(`‚ùå Falha ao enviar para ${contato.nome}: ${numero}`);
                }
                
                // Delay entre mensagens (evitar bloqueio do WhatsApp)
                await new Promise(resolve => setTimeout(resolve, 2500));
            }
            
            // Remover progresso e mostrar resultado
            document.body.removeChild(progressDiv);
            
            alert(`üì® Envio conclu√≠do!\n\n‚úÖ Enviados: ${enviados}\n‚ùå Erros: ${erros}\nüìä Total: ${contatos.length}\n\nLista: ${nomeLista}`);
            
            // Limpar sele√ß√£o
            selecionados.clear();
            renderizarTabela();
        }

        // Inicializar
        carregarContatos();
    </script>
</body>
</html>
#!/bin/bash

#################################
# ENSIDE - Sistema Completo v19.0
# Inicializa Docker, APIs e Interface Web
#################################

PROJECT_DIR="/Users/andersonenside/evolution"
API_URL="http://localhost:8080"
WEB_URL="http://localhost:9999"
DOCKER_TIMEOUT=120

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ ENSIDE MASTER v19.0 - INICIANDO SISTEMA${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

cd "$PROJECT_DIR"

# 1. VERIFICAR DOCKER
echo -e "${YELLOW}1๏ธโฃ  Verificando Docker...${NC}"
if ! command -v docker &> /dev/null; then
  echo -e "${RED}โ Docker nรฃo estรก instalado${NC}"
  echo "   Instale Docker em: https://www.docker.com/products/docker-desktop"
  exit 1
fi

# 2. INICIAR DOCKER SE NรO ESTIVER RODANDO
echo -e "${YELLOW}2๏ธโฃ  Iniciando Docker Desktop...${NC}"
if ! docker info > /dev/null 2>&1; then
  echo "   โณ Docker nรฃo estรก rodando, iniciando..."
  echo "   ๐ณ Abrindo Docker Desktop..."
  open -a Docker
  sleep 15
else
  echo -e "${GREEN}โ Docker jรก estรก rodando${NC}"
fi

# 3. VERIFICAR E PARAR CONTAINERS ANTIGOS
echo -e "${YELLOW}3๏ธโฃ  Limpando containers antigos...${NC}"
docker-compose down 2>/dev/null || true
sleep 2

# 4. INICIAR DOCKER COMPOSE
echo -e "${YELLOW}4๏ธโฃ  Iniciando serviรงos Docker...${NC}"
echo "   ๐ฆ PostgreSQL (5432)"
echo "   ๐ฆ Redis (6379)"
echo "   ๐ฆ Evolution API (8080)"
echo "   ๐ฆ RabbitMQ (5672/15672)"
echo ""

docker-compose up -d

echo -e "${GREEN}โ Containers iniciados${NC}"

# 5. AGUARDAR SERVIรOS
echo ""
echo -e "${YELLOW}5๏ธโฃ  Aguardando serviรงos ficarem saudรกveis...${NC}"

COUNTER=0
while [ $COUNTER -lt $DOCKER_TIMEOUT ]; do
  # Verificar PostgreSQL
  if docker exec evolution_postgres pg_isready -U evolution > /dev/null 2>&1; then
    echo -e "${GREEN}โ PostgreSQL online${NC}"
    break
  fi
  
  COUNTER=$((COUNTER + 2))
  if [ $((COUNTER % 10)) -eq 0 ]; then
    echo "   โณ Aguardando... ($COUNTER/$DOCKER_TIMEOUT segundos)"
  fi
  sleep 2
done

sleep 5

# Verificar Redis
if docker exec evolution_redis redis-cli ping > /dev/null 2>&1; then
  echo -e "${GREEN}โ Redis online${NC}"
else
  echo -e "${YELLOW}โ๏ธ  Redis ainda inicializando...${NC}"
fi

# Verificar API
COUNTER=0
API_READY=false
while [ $COUNTER -lt 60 ]; do
  if curl -s "$API_URL/health" > /dev/null 2>&1; then
    echo -e "${GREEN}โ Evolution API online${NC}"
    API_READY=true
    break
  fi
  COUNTER=$((COUNTER + 2))
  if [ $((COUNTER % 10)) -eq 0 ]; then
    echo "   โณ Aguardando API... ($COUNTER/60 segundos)"
  fi
  sleep 2
done

# Se API nรฃo respondeu, avisa mas continua
if [ "$API_READY" = false ]; then
  echo -e "${YELLOW}โ๏ธ  API Evolution nรฃo respondeu ainda (pode estar inicializando)${NC}"
fi

# 6. INICIAR SERVIDOR WEB LOCAL
echo ""
echo -e "${YELLOW}6๏ธโฃ  Iniciando servidor web local (porta 9999)...${NC}"

cd "$PROJECT_DIR"

# Parar servidor antigo na porta 9999
lsof -ti :9999 | xargs kill -9 2>/dev/null || true
sleep 2

# Iniciar novo servidor
python3 -m http.server 9999 --directory "$PROJECT_DIR" > /tmp/web_server.log 2>&1 &
WEB_PID=$!

sleep 3

# Verificar se servidor respondeu
if curl -s http://localhost:9999 > /dev/null 2>&1; then
  echo -e "${GREEN}โ Servidor web iniciado (PID: $WEB_PID)${NC}"
else
  echo -e "${RED}โ Erro ao iniciar servidor web${NC}"
  cat /tmp/web_server.log
  exit 1
fi

# 7. STATUS DOS SERVIรOS
echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ SISTEMA ENSIDE COMPLETAMENTE INICIADO!${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

echo -e "${YELLOW}๐ SERVIรOS DISPONรVEIS:${NC}"
echo ""
echo -e "  ${GREEN}โ PostgreSQL${NC}        โ localhost:5432 (evolution/evolution_password)"
echo -e "  ${GREEN}โ Redis${NC}             โ localhost:6379"
echo -e "  ${GREEN}โ RabbitMQ${NC}          โ localhost:5672 (Admin: 15672)"
echo -e "  ${GREEN}โ Evolution API${NC}     โ $API_URL"
echo -e "  ${GREEN}โ Servidor Web${NC}      โ $WEB_URL"
echo ""

# 8. BUSCAR INFORMAรรES DE INSTรNCIAS E REDIS
echo -e "${YELLOW}๐ก INFORMAรรES DE CONEXรO:${NC}"
echo ""

# Redis Info
if docker exec evolution_redis redis-cli PING > /dev/null 2>&1; then
  REDIS_MEMORY=$(docker exec evolution_redis redis-cli INFO memory | grep used_memory_human | cut -d: -f2 | tr -d '\r')
  REDIS_KEYS=$(docker exec evolution_redis redis-cli DBSIZE | awk '{print $2}')
  echo -e "  ${GREEN}Redis${NC}:"
  echo "    โข Memรณria: $REDIS_MEMORY"
  echo "    โข Chaves: $REDIS_KEYS"
fi

# PostgreSQL Info
if docker exec evolution_postgres pg_isready -U evolution > /dev/null 2>&1; then
  POSTGRES_DBS=$(docker exec evolution_postgres psql -U evolution -l 2>/dev/null | grep evolution | wc -l)
  echo -e "  ${GREEN}PostgreSQL${NC}:"
  echo "    โข Bancos: $POSTGRES_DBS"
  echo "    โข User: evolution"
fi

# Evolution API Instances (se API estiver pronta)
if [ "$API_READY" = true ]; then
  echo -e "  ${GREEN}Evolution API${NC}:"
  echo "    โข Status: โ Online"
  echo "    โข URL: http://localhost:8080"
  INSTANCES=$(curl -s "$API_URL/instances" 2>/dev/null | grep -o '"key"' | wc -l)
  if [ $INSTANCES -gt 0 ]; then
    echo "    โข Instรขncias: $INSTANCES"
  fi
fi

echo ""

echo -e "${YELLOW}๐ ACESSAR INTERFACE:${NC}"
echo ""
echo -e "  ${BLUE}http://localhost:9999/public/index-v19-funcional.html${NC}"
echo ""
echo -e "${YELLOW}๐ง FERRAMENTAS ADMINISTRATIVAS:${NC}"
echo ""
echo -e "  RabbitMQ Admin:  ${BLUE}http://localhost:15672${NC} (guest/guest)"
echo -e "  Evolution API:   ${BLUE}http://localhost:8080${NC}"
echo ""

# 8. ABRIR NO NAVEGADOR (INTERFACE PRINCIPAL)
echo -e "${YELLOW}7๏ธโฃ  Abrindo interface no navegador...${NC}"

MAIN_URL="$WEB_URL/public/index-v19-funcional.html"

echo -e "   ๐ ${BLUE}$MAIN_URL${NC}"
echo ""

# Tentar abrir em Firefox
if command -v firefox &> /dev/null; then
  firefox "$MAIN_URL" > /dev/null 2>&1 &
  echo -e "   ${GREEN}โ Firefox aberto${NC}"
# Tentar Chrome
elif command -v google-chrome &> /dev/null; then
  google-chrome "$MAIN_URL" > /dev/null 2>&1 &
  echo -e "   ${GREEN}โ Chrome aberto${NC}"
# Tentar Safari (macOS)
elif command -v open &> /dev/null; then
  open -a Safari "$MAIN_URL" 2>/dev/null &
  echo -e "   ${GREEN}โ Safari aberto${NC}"
# Fallback genรฉrico
else
  open "$MAIN_URL" 2>/dev/null &
  echo -e "   ${GREEN}โ Navegador padrรฃo aberto${NC}"
fi

sleep 2

# 9. RESUMO
echo ""
echo -e "${YELLOW}๐ CREDENCIAIS E CONFIGURAรรES:${NC}"
echo ""
echo "  ๐ฆ PostgreSQL:"
echo "    โข Host: localhost:5432"
echo "    โข Database: evolution_db"
echo "    โข User: evolution"
echo "    โข Password: evolution_password"
echo ""
echo "  โก Redis:"
echo "    โข Host: localhost:6379"
echo "    โข Sem senha"
echo ""
echo "  ๐ฐ RabbitMQ:"
echo "    โข Host: localhost:5672"
echo "    โข Admin URL: http://localhost:15672"
echo "    โข User: guest"
echo "    โข Password: guest"
echo ""
echo "  ๐ Evolution API:"
echo "    โข Base URL: http://localhost:8080"
echo "    โข Health Check: http://localhost:8080/health"
echo ""

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โจ Sistema pronto! Enjoy! ๐${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# 10. MANTER SCRIPT RODANDO COM LOGS
echo -e "${YELLOW}๐ Monitorando logs em tempo real - pressione Ctrl+C para parar${NC}"
echo ""

# Mostrar logs do Docker
docker-compose logs -f --tail=50

#!/bin/bash

#################################
# ENSIDE - Sistema Completo v19.0
# Inicializa Docker, APIs e Interface Web
#################################

set -e

PROJECT_DIR="/Users/andersonenside/evolution"
API_URL="http://localhost:8080"
WEB_URL="http://localhost:9999"
DOCKER_TIMEOUT=120

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ ENSIDE MASTER v19.0 - INICIANDO SISTEMA${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

cd "$PROJECT_DIR"

# 1. VERIFICAR DOCKER
echo -e "${YELLOW}1๏ธโฃ  Verificando Docker...${NC}"
if ! command -v docker &> /dev/null; then
  echo -e "${RED}โ Docker nรฃo estรก instalado${NC}"
  echo "   Instale Docker em: https://www.docker.com/products/docker-desktop"
  exit 1
fi

# 2. INICIAR DOCKER SE NรO ESTIVER RODANDO
echo -e "${YELLOW}2๏ธโฃ  Iniciando Docker Desktop...${NC}"
if ! docker info > /dev/null 2>&1; then
  echo "   โณ Docker nรฃo estรก rodando, iniciando..."
  open -a Docker
  sleep 10
fi

# 3. VERIFICAR E PARAR CONTAINERS ANTIGOS
echo -e "${YELLOW}3๏ธโฃ  Limpando containers antigos...${NC}"
docker-compose down 2>/dev/null || true
sleep 2

# 4. INICIAR DOCKER COMPOSE
echo -e "${YELLOW}4๏ธโฃ  Iniciando serviรงos Docker...${NC}"
echo "   ๐ฆ PostgreSQL (5432)"
echo "   ๐ฆ Redis (6379)"
echo "   ๐ฆ Evolution API (8080)"
echo "   ๐ฆ RabbitMQ (5672/15672)"
echo ""

docker-compose up -d

echo -e "${GREEN}โ Containers iniciados${NC}"

# 5. AGUARDAR SERVIรOS
echo ""
echo -e "${YELLOW}5๏ธโฃ  Aguardando serviรงos ficarem saudรกveis...${NC}"

COUNTER=0
while [ $COUNTER -lt $DOCKER_TIMEOUT ]; do
  # Verificar PostgreSQL
  if docker exec evolution_postgres pg_isready -U evolution > /dev/null 2>&1; then
    echo -e "${GREEN}โ PostgreSQL online${NC}"
    break
  fi
  
  COUNTER=$((COUNTER + 2))
  if [ $((COUNTER % 10)) -eq 0 ]; then
    echo "   โณ Aguardando... ($COUNTER/$DOCKER_TIMEOUT segundos)"
  fi
  sleep 2
done

sleep 5

# Verificar Redis
if docker exec evolution_redis redis-cli ping > /dev/null 2>&1; then
  echo -e "${GREEN}โ Redis online${NC}"
else
  echo -e "${YELLOW}โ๏ธ  Redis ainda inicializando...${NC}"
fi

# Verificar API
COUNTER=0
while [ $COUNTER -lt 60 ]; do
  if curl -s "$API_URL/health" > /dev/null 2>&1; then
    echo -e "${GREEN}โ Evolution API online${NC}"
    break
  fi
  COUNTER=$((COUNTER + 2))
  if [ $((COUNTER % 10)) -eq 0 ]; then
    echo "   โณ Aguardando API... ($COUNTER/60 segundos)"
  fi
  sleep 2
done

# 6. INICIAR SERVIDOR WEB LOCAL
echo ""
echo -e "${YELLOW}6๏ธโฃ  Iniciando servidor web local (porta 9999)...${NC}"

cd "$PROJECT_DIR/public"

# Parar servidor antigo
pkill -f "python3.*http.server.*9999" 2>/dev/null || true
sleep 1

# Iniciar novo servidor
python3 -m http.server 9999 > /tmp/web_server.log 2>&1 &
WEB_PID=$!

sleep 2

if kill -0 $WEB_PID 2>/dev/null; then
  echo -e "${GREEN}โ Servidor web iniciado (PID: $WEB_PID)${NC}"
else
  echo -e "${RED}โ Erro ao iniciar servidor web${NC}"
  exit 1
fi

# 7. STATUS DOS SERVIรOS
echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ SISTEMA ENSIDE COMPLETAMENTE INICIADO!${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

echo -e "${YELLOW}๐ SERVIรOS DISPONรVEIS:${NC}"
echo ""
echo -e "  ${GREEN}โ PostgreSQL${NC}        โ localhost:5432"
echo -e "  ${GREEN}โ Redis${NC}             โ localhost:6379"
echo -e "  ${GREEN}โ RabbitMQ${NC}          โ localhost:5672 (admin: 15672)"
echo -e "  ${GREEN}โ Evolution API${NC}     โ $API_URL"
echo -e "  ${GREEN}โ Servidor Web${NC}      โ $WEB_URL"
echo ""

echo -e "${YELLOW}๐ ACESSAR INTERFACE:${NC}"
echo ""
echo -e "  ${BLUE}http://localhost:9999/public/index-v19-funcional.html${NC}"
echo ""

# 8. ABRIR NO NAVEGADOR
echo -e "${YELLOW}7๏ธโฃ  Abrindo navegador...${NC}"

# Tentar Firefox
if command -v firefox &> /dev/null; then
  open -a Firefox "$WEB_URL/public/index-v19-funcional.html" 2>/dev/null || true
# Tentar Chrome
elif command -v "Google Chrome" &> /dev/null; then
  open -a "Google Chrome" "$WEB_URL/public/index-v19-funcional.html" 2>/dev/null || true
# Safari como fallback
else
  open "$WEB_URL/public/index-v19-funcional.html" 2>/dev/null || true
fi

sleep 1

# 9. RESUMO
echo ""
echo -e "${YELLOW}๐ INFORMAรรES DE ACESSO:${NC}"
echo ""
echo "  API Evolution:"
echo "    โข URL: http://localhost:8080"
echo "    โข Health: http://localhost:8080/health"
echo ""
echo "  Banco de Dados:"
echo "    โข Host: localhost"
echo "    โข Porta: 5432"
echo "    โข User: evolution"
echo "    โข Password: evolution_password"
echo ""
echo "  Redis Cache:"
echo "    โข Host: localhost"
echo "    โข Porta: 6379"
echo ""
echo "  RabbitMQ:"
echo "    โข URL: amqp://localhost:5672"
echo "    โข Admin: http://localhost:15672"
echo "    โข User: guest"
echo "    โข Password: guest"
echo ""

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โจ Sistema pronto! Enjoy! ๐${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# 10. MANTER SCRIPT RODANDO COM LOGS
echo -e "${YELLOW}๐ Monitorando logs (pressione Ctrl+C para parar):${NC}"
echo ""

# Mostrar logs do Docker
docker-compose logs -f --tail=50

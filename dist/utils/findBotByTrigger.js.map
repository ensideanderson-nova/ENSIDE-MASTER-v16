{"version":3,"sources":["../../src/utils/findBotByTrigger.ts","../../src/utils/advancedOperatorsSearch.ts"],"sourcesContent":["import { advancedOperatorsSearch } from './advancedOperatorsSearch';\n\nexport const findBotByTrigger = async (botRepository: any, content: string, instanceId: string) => {\n  // Check for triggerType 'all' or 'none' (both should match any message)\n  const findTriggerAllOrNone = await botRepository.findFirst({\n    where: {\n      enabled: true,\n      triggerType: {\n        in: ['all', 'none'],\n      },\n      instanceId: instanceId,\n    },\n  });\n\n  if (findTriggerAllOrNone) {\n    return findTriggerAllOrNone;\n  }\n\n  const findTriggerAdvanced = await botRepository.findMany({\n    where: {\n      enabled: true,\n      triggerType: 'advanced',\n      instanceId: instanceId,\n    },\n  });\n  for (const advanced of findTriggerAdvanced) {\n    if (advancedOperatorsSearch(content, advanced.triggerValue)) {\n      return advanced;\n    }\n  }\n\n  // Check for exact match\n  const findTriggerEquals = await botRepository.findFirst({\n    where: {\n      enabled: true,\n      triggerType: 'keyword',\n      triggerOperator: 'equals',\n      triggerValue: content,\n      instanceId: instanceId,\n    },\n  });\n\n  if (findTriggerEquals) {\n    return findTriggerEquals;\n  }\n\n  // Check for regex match\n  const findRegex = await botRepository.findMany({\n    where: {\n      enabled: true,\n      triggerType: 'keyword',\n      triggerOperator: 'regex',\n      instanceId: instanceId,\n    },\n  });\n\n  let findTriggerRegex = null;\n\n  for (const regex of findRegex) {\n    const regexValue = new RegExp(regex.triggerValue);\n\n    if (regexValue.test(content)) {\n      findTriggerRegex = regex;\n      break;\n    }\n  }\n\n  if (findTriggerRegex) return findTriggerRegex;\n\n  // Check for startsWith match\n  const findStartsWith = await botRepository.findMany({\n    where: {\n      enabled: true,\n      triggerType: 'keyword',\n      triggerOperator: 'startsWith',\n      instanceId: instanceId,\n    },\n  });\n\n  let findTriggerStartsWith = null;\n\n  for (const startsWith of findStartsWith) {\n    if (content.startsWith(startsWith.triggerValue)) {\n      findTriggerStartsWith = startsWith;\n      break;\n    }\n  }\n\n  if (findTriggerStartsWith) return findTriggerStartsWith;\n\n  // Check for endsWith match\n  const findEndsWith = await botRepository.findMany({\n    where: {\n      enabled: true,\n      triggerType: 'keyword',\n      triggerOperator: 'endsWith',\n      instanceId: instanceId,\n    },\n  });\n\n  let findTriggerEndsWith = null;\n\n  for (const endsWith of findEndsWith) {\n    if (content.endsWith(endsWith.triggerValue)) {\n      findTriggerEndsWith = endsWith;\n      break;\n    }\n  }\n\n  if (findTriggerEndsWith) return findTriggerEndsWith;\n\n  // Check for contains match\n  const findContains = await botRepository.findMany({\n    where: {\n      enabled: true,\n      triggerType: 'keyword',\n      triggerOperator: 'contains',\n      instanceId: instanceId,\n    },\n  });\n\n  let findTriggerContains = null;\n\n  for (const contains of findContains) {\n    if (content.includes(contains.triggerValue)) {\n      findTriggerContains = contains;\n      break;\n    }\n  }\n\n  if (findTriggerContains) return findTriggerContains;\n\n  return null;\n};\n","function normalizeString(str: string): string {\n  return str\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .toLowerCase();\n}\n\nexport function advancedOperatorsSearch(data: string, query: string): boolean {\n  const filters = query.split(' ').reduce((acc: Record<string, string[]>, filter) => {\n    const [operator, ...values] = filter.split(':');\n    const value = values.join(':');\n\n    if (!acc[operator]) {\n      acc[operator] = [];\n    }\n    acc[operator].push(value);\n    return acc;\n  }, {});\n\n  const normalizedItem = normalizeString(data);\n\n  return Object.entries(filters).every(([operator, values]) => {\n    return values.some((val) => {\n      const subValues = val.split(',');\n      return subValues.every((subVal) => {\n        const normalizedSubVal = normalizeString(subVal);\n\n        switch (operator.toLowerCase()) {\n          case 'contains':\n            return normalizedItem.includes(normalizedSubVal);\n          case 'notcontains':\n            return !normalizedItem.includes(normalizedSubVal);\n          case 'startswith':\n            return normalizedItem.startsWith(normalizedSubVal);\n          case 'endswith':\n            return normalizedItem.endsWith(normalizedSubVal);\n          case 'exact':\n            return normalizedItem === normalizedSubVal;\n          default:\n            return false;\n        }\n      });\n    });\n  });\n}\n"],"mappings":"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","names":["findBotByTrigger_exports","__export","findBotByTrigger","__toCommonJS","normalizeString","str","normalize","replace","toLowerCase","advancedOperatorsSearch","data","query","filters","split","reduce","acc","filter","operator","values","value","join","push","normalizedItem","Object","entries","every","some","val","subVal","normalizedSubVal","includes","startsWith","endsWith","findBotByTrigger","__name","botRepository","content","instanceId","findTriggerAllOrNone","findFirst","where","enabled","triggerType","in","findTriggerAdvanced","findMany","advanced","advancedOperatorsSearch","triggerValue","findTriggerEquals","triggerOperator","findRegex","findTriggerRegex","regex","RegExp","test","findStartsWith","findTriggerStartsWith","startsWith","findEndsWith","findTriggerEndsWith","endsWith","findContains","findTriggerContains","contains","includes"]}
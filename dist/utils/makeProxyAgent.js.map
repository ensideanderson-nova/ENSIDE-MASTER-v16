{"version":3,"sources":["../../src/utils/makeProxyAgent.ts"],"sourcesContent":["import { socksDispatcher } from 'fetch-socks';\nimport { HttpsProxyAgent } from 'https-proxy-agent';\nimport { SocksProxyAgent } from 'socks-proxy-agent';\nimport { ProxyAgent } from 'undici';\n\ntype Proxy = {\n  host: string;\n  password?: string;\n  port: string;\n  protocol: string;\n  username?: string;\n};\n\nfunction selectProxyAgent(proxyUrl: string): HttpsProxyAgent<string> | SocksProxyAgent {\n  const url = new URL(proxyUrl);\n\n  // NOTE: The following constants are not used in the function but are defined for clarity.\n  // When a proxy URL is used to build the URL object, the protocol returned by procotol's property contains a `:` at\n  // the end so, we add the protocol constants without the `:` to avoid confusion.\n  const PROXY_HTTP_PROTOCOL = 'http:';\n  const PROXY_SOCKS_PROTOCOL = 'socks:';\n  const PROXY_SOCKS5_PROTOCOL = 'socks5:';\n\n  switch (url.protocol) {\n    case PROXY_HTTP_PROTOCOL:\n      return new HttpsProxyAgent(url);\n    case PROXY_SOCKS_PROTOCOL:\n    case PROXY_SOCKS5_PROTOCOL: {\n      let urlSocks = '';\n\n      if (url.username && url.password) {\n        urlSocks = `socks://${url.username}:${url.password}@${url.hostname}:${url.port}`;\n      } else {\n        urlSocks = `socks://${url.hostname}:${url.port}`;\n      }\n\n      return new SocksProxyAgent(urlSocks);\n    }\n    default:\n      throw new Error(`Unsupported proxy protocol: ${url.protocol}`);\n  }\n}\n\nexport function makeProxyAgent(proxy: Proxy | string): HttpsProxyAgent<string> | SocksProxyAgent {\n  if (typeof proxy === 'string') {\n    return selectProxyAgent(proxy);\n  }\n\n  const { host, password, port, protocol, username } = proxy;\n  let proxyUrl = `${protocol}://${host}:${port}`;\n\n  if (username && password) {\n    proxyUrl = `${protocol}://${username}:${password}@${host}:${port}`;\n  }\n\n  return selectProxyAgent(proxyUrl);\n}\n\nexport function makeProxyAgentUndici(proxy: Proxy | string): ProxyAgent {\n  let proxyUrl: string;\n  let protocol: string;\n\n  if (typeof proxy === 'string') {\n    const url = new URL(proxy);\n    protocol = url.protocol.replace(':', '');\n    proxyUrl = proxy;\n  } else {\n    const { host, password, port, protocol: proto, username } = proxy;\n    protocol = (proto || 'http').replace(':', '');\n\n    if (protocol === 'socks') {\n      protocol = 'socks5';\n    }\n\n    const auth = username && password ? `${username}:${password}@` : '';\n    proxyUrl = `${protocol}://${auth}${host}:${port}`;\n  }\n\n  protocol = protocol.toLowerCase();\n\n  const PROXY_HTTP_PROTOCOL = 'http';\n  const PROXY_HTTPS_PROTOCOL = 'https';\n  const PROXY_SOCKS4_PROTOCOL = 'socks4';\n  const PROXY_SOCKS5_PROTOCOL = 'socks5';\n\n  switch (protocol) {\n    case PROXY_HTTP_PROTOCOL:\n    case PROXY_HTTPS_PROTOCOL:\n      return new ProxyAgent(proxyUrl);\n\n    case PROXY_SOCKS4_PROTOCOL:\n    case PROXY_SOCKS5_PROTOCOL: {\n      let type: 4 | 5 = 5;\n\n      if (PROXY_SOCKS4_PROTOCOL === protocol) type = 4;\n\n      const url = new URL(proxyUrl);\n\n      return socksDispatcher({\n        type: type,\n        host: url.hostname,\n        port: Number(url.port),\n        userId: url.username || undefined,\n        password: url.password || undefined,\n      });\n    }\n\n    default:\n      throw new Error(`Unsupported proxy protocol: ${protocol}`);\n  }\n}\n"],"mappings":"+cAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,oBAAAE,EAAA,yBAAAC,IAAA,eAAAC,EAAAJ,GAAA,IAAAK,EAAgC,uBAChCC,EAAgC,6BAChCC,EAAgC,6BAChCC,EAA2B,kBAU3B,SAASC,EAAiBC,EAAgB,CACxC,IAAMC,EAAM,IAAIC,IAAIF,CAAAA,EAKdG,EAAsB,QACtBC,EAAuB,SACvBC,EAAwB,UAE9B,OAAQJ,EAAIK,SAAQ,CAClB,KAAKH,EACH,OAAO,IAAII,kBAAgBN,CAAAA,EAC7B,KAAKG,EACL,KAAKC,EAAuB,CAC1B,IAAIG,EAAW,GAEf,OAAIP,EAAIQ,UAAYR,EAAIS,SACtBF,EAAW,WAAWP,EAAIQ,QAAQ,IAAIR,EAAIS,QAAQ,IAAIT,EAAIU,QAAQ,IAAIV,EAAIW,IAAI,GAE9EJ,EAAW,WAAWP,EAAIU,QAAQ,IAAIV,EAAIW,IAAI,GAGzC,IAAIC,kBAAgBL,CAAAA,CAC7B,CACA,QACE,MAAM,IAAIM,MAAM,+BAA+Bb,EAAIK,QAAQ,EAAE,CACjE,CACF,CA5BSP,EAAAA,EAAAA,oBA8BF,SAASgB,EAAeC,EAAqB,CAClD,GAAI,OAAOA,GAAU,SACnB,OAAOjB,EAAiBiB,CAAAA,EAG1B,GAAM,CAAEC,KAAAA,EAAMP,SAAAA,EAAUE,KAAAA,EAAMN,SAAAA,EAAUG,SAAAA,CAAQ,EAAKO,EACjDhB,EAAW,GAAGM,CAAAA,MAAcW,CAAAA,IAAQL,CAAAA,GAExC,OAAIH,GAAYC,IACdV,EAAW,GAAGM,CAAAA,MAAcG,CAAAA,IAAYC,CAAAA,IAAYO,CAAAA,IAAQL,CAAAA,IAGvDb,EAAiBC,CAAAA,CAC1B,CAbgBe,EAAAA,EAAAA,kBAeT,SAASG,EAAqBF,EAAqB,CACxD,IAAIhB,EACAM,EAEJ,GAAI,OAAOU,GAAU,SAEnBV,EADY,IAAIJ,IAAIc,CAAAA,EACLV,SAASa,QAAQ,IAAK,EAAA,EACrCnB,EAAWgB,MACN,CACL,GAAM,CAAEC,KAAAA,EAAMP,SAAAA,EAAUE,KAAAA,EAAMN,SAAUc,EAAOX,SAAAA,CAAQ,EAAKO,EAC5DV,GAAYc,GAAS,QAAQD,QAAQ,IAAK,EAAA,EAEtCb,IAAa,UACfA,EAAW,UAGb,IAAMe,EAAOZ,GAAYC,EAAW,GAAGD,CAAAA,IAAYC,CAAAA,IAAc,GACjEV,EAAW,GAAGM,CAAAA,MAAce,CAAAA,GAAOJ,CAAAA,IAAQL,CAAAA,EAC7C,CAEAN,EAAWA,EAASgB,YAAW,EAE/B,IAAMnB,EAAsB,OACtBoB,EAAuB,QACvBC,EAAwB,SACxBnB,EAAwB,SAE9B,OAAQC,EAAAA,CACN,KAAKH,EACL,KAAKoB,EACH,OAAO,IAAIE,aAAWzB,CAAAA,EAExB,KAAKwB,EACL,KAAKnB,EAAuB,CAC1B,IAAIqB,EAAc,EAEdF,IAA0BlB,IAAUoB,EAAO,GAE/C,IAAMzB,EAAM,IAAIC,IAAIF,CAAAA,EAEpB,SAAO2B,mBAAgB,CACrBD,KAAMA,EACNT,KAAMhB,EAAIU,SACVC,KAAMgB,OAAO3B,EAAIW,IAAI,EACrBiB,OAAQ5B,EAAIQ,UAAYqB,OACxBpB,SAAUT,EAAIS,UAAYoB,MAC5B,CAAA,CACF,CAEA,QACE,MAAM,IAAIhB,MAAM,+BAA+BR,CAAAA,EAAU,CAC7D,CACF,CApDgBY,EAAAA,EAAAA","names":["makeProxyAgent_exports","__export","makeProxyAgent","makeProxyAgentUndici","__toCommonJS","import_fetch_socks","import_https_proxy_agent","import_socks_proxy_agent","import_undici","selectProxyAgent","proxyUrl","url","URL","PROXY_HTTP_PROTOCOL","PROXY_SOCKS_PROTOCOL","PROXY_SOCKS5_PROTOCOL","protocol","HttpsProxyAgent","urlSocks","username","password","hostname","port","SocksProxyAgent","Error","makeProxyAgent","proxy","host","makeProxyAgentUndici","replace","proto","auth","toLowerCase","PROXY_HTTPS_PROTOCOL","PROXY_SOCKS4_PROTOCOL","ProxyAgent","type","socksDispatcher","Number","userId","undefined"]}
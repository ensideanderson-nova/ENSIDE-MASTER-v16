{"version":3,"sources":["../../../../src/api/integrations/event/event.schema.ts","../../../../src/api/integrations/event/event.controller.ts","../../../../src/api/integrations/event/pusher/pusher.schema.ts","../../../../src/api/integrations/event/webhook/webhook.schema.ts"],"sourcesContent":["import { JSONSchema7 } from 'json-schema';\nimport { v4 } from 'uuid';\n\nimport { EventController } from './event.controller';\n\nexport * from '@api/integrations/event/pusher/pusher.schema';\nexport * from '@api/integrations/event/webhook/webhook.schema';\n\nexport const eventSchema: JSONSchema7 = {\n  $id: v4(),\n  type: 'object',\n  properties: {\n    websocket: {\n      $ref: '#/$defs/event',\n    },\n    rabbitmq: {\n      $ref: '#/$defs/event',\n    },\n    nats: {\n      $ref: '#/$defs/event',\n    },\n    sqs: {\n      $ref: '#/$defs/event',\n    },\n    kafka: {\n      $ref: '#/$defs/event',\n    },\n  },\n  $defs: {\n    event: {\n      type: 'object',\n      properties: {\n        enabled: { type: 'boolean', enum: [true, false] },\n        events: {\n          type: 'array',\n          minItems: 0,\n          items: {\n            type: 'string',\n            enum: EventController.events,\n          },\n        },\n      },\n      required: ['enabled'],\n    },\n  },\n};\n","import { EventDto } from '@api/integrations/event/event.dto';\nimport { PrismaRepository } from '@api/repository/repository.service';\nimport { WAMonitoringService } from '@api/services/monitor.service';\nimport { wa } from '@api/types/wa.types';\n\nexport type EmitData = {\n  instanceName: string;\n  origin: string;\n  event: string;\n  data: any;\n  serverUrl: string;\n  dateTime: string;\n  sender: string;\n  apiKey?: string;\n  local?: boolean;\n  integration?: string[];\n  extra?: Record<string, any>;\n};\n\nexport interface EventControllerInterface {\n  set(instanceName: string, data: any): Promise<any>;\n  get(instanceName: string): Promise<any>;\n  emit({\n    instanceName,\n    origin,\n    event,\n    data,\n    serverUrl,\n    dateTime,\n    sender,\n    apiKey,\n    local,\n    extra,\n  }: EmitData): Promise<void>;\n}\n\nexport class EventController {\n  public prismaRepository: PrismaRepository;\n  protected waMonitor: WAMonitoringService;\n  private integrationStatus: boolean;\n  private integrationName: string;\n\n  constructor(\n    prismaRepository: PrismaRepository,\n    waMonitor: WAMonitoringService,\n    integrationStatus: boolean,\n    integrationName: string,\n  ) {\n    this.prisma = prismaRepository;\n    this.monitor = waMonitor;\n    this.status = integrationStatus;\n    this.name = integrationName;\n  }\n\n  public set prisma(prisma: PrismaRepository) {\n    this.prismaRepository = prisma;\n  }\n\n  public get prisma() {\n    return this.prismaRepository;\n  }\n\n  public set monitor(waMonitor: WAMonitoringService) {\n    this.waMonitor = waMonitor;\n  }\n\n  public get monitor() {\n    return this.waMonitor;\n  }\n\n  public set name(name: string) {\n    this.integrationName = name;\n  }\n\n  public get name() {\n    return this.integrationName;\n  }\n\n  public set status(status: boolean) {\n    this.integrationStatus = status;\n  }\n\n  public get status() {\n    return this.integrationStatus;\n  }\n\n  public async set(instanceName: string, data: EventDto): Promise<wa.LocalEvent> {\n    if (!this.status) {\n      return;\n    }\n\n    if (!data[this.name]?.enabled) {\n      data[this.name].events = [];\n    } else {\n      if (0 === data[this.name].events.length) {\n        data[this.name].events = EventController.events;\n      }\n    }\n\n    return this.prisma[this.name].upsert({\n      where: {\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\n      },\n      update: {\n        enabled: data[this.name]?.enabled,\n        events: data[this.name].events,\n      },\n      create: {\n        enabled: data[this.name]?.enabled,\n        events: data[this.name].events,\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\n      },\n    });\n  }\n\n  public async get(instanceName: string): Promise<wa.LocalEvent> {\n    if (!this.status) {\n      return;\n    }\n\n    if (undefined === this.monitor.waInstances[instanceName]) {\n      return null;\n    }\n\n    const data = await this.prisma[this.name].findUnique({\n      where: {\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\n      },\n    });\n\n    if (!data) {\n      return null;\n    }\n\n    return data;\n  }\n\n  public static readonly events = [\n    'APPLICATION_STARTUP',\n    'QRCODE_UPDATED',\n    'MESSAGES_SET',\n    'MESSAGES_UPSERT',\n    'MESSAGES_EDITED',\n    'MESSAGES_UPDATE',\n    'MESSAGES_DELETE',\n    'SEND_MESSAGE',\n    'SEND_MESSAGE_UPDATE',\n    'CONTACTS_SET',\n    'CONTACTS_UPSERT',\n    'CONTACTS_UPDATE',\n    'PRESENCE_UPDATE',\n    'CHATS_SET',\n    'CHATS_UPSERT',\n    'CHATS_UPDATE',\n    'CHATS_DELETE',\n    'GROUPS_UPSERT',\n    'GROUP_UPDATE',\n    'GROUP_PARTICIPANTS_UPDATE',\n    'CONNECTION_UPDATE',\n    'LABELS_EDIT',\n    'LABELS_ASSOCIATION',\n    'CALL',\n    'TYPEBOT_START',\n    'TYPEBOT_CHANGE_STATUS',\n    'REMOVE_INSTANCE',\n    'LOGOUT_INSTANCE',\n    'INSTANCE_CREATE',\n    'INSTANCE_DELETE',\n    'STATUS_INSTANCE',\n  ];\n}\n","import { JSONSchema7 } from 'json-schema';\nimport { v4 } from 'uuid';\n\nimport { EventController } from '../event.controller';\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\n  const properties = {};\n  propertyNames.forEach(\n    (property) =>\n      (properties[property] = {\n        minLength: 1,\n        description: `The \"${property}\" cannot be empty`,\n      }),\n  );\n  return {\n    if: {\n      propertyNames: {\n        enum: [...propertyNames],\n      },\n    },\n    then: { properties },\n  };\n};\nexport const pusherSchema: JSONSchema7 = {\n  $id: v4(),\n  type: 'object',\n  properties: {\n    pusher: {\n      type: 'object',\n      properties: {\n        enabled: { type: 'boolean' },\n        appId: { type: 'string' },\n        key: { type: 'string' },\n        secret: { type: 'string' },\n        cluster: { type: 'string' },\n        useTLS: { type: 'boolean' },\n        events: {\n          type: 'array',\n          minItems: 0,\n          items: {\n            type: 'string',\n            enum: EventController.events,\n          },\n        },\n      },\n      required: ['enabled', 'appId', 'key', 'secret', 'cluster', 'useTLS'],\n      ...isNotEmpty('enabled', 'appId', 'key', 'secret', 'cluster', 'useTLS'),\n    },\n  },\n  required: ['pusher'],\n};\n","import { JSONSchema7 } from 'json-schema';\nimport { v4 } from 'uuid';\n\nimport { EventController } from '../event.controller';\n\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\n  const properties = {};\n  propertyNames.forEach(\n    (property) =>\n      (properties[property] = {\n        minLength: 1,\n        description: `The \"${property}\" cannot be empty`,\n      }),\n  );\n  return {\n    if: {\n      propertyNames: {\n        enum: [...propertyNames],\n      },\n    },\n    then: { properties },\n  };\n};\n\nexport const webhookSchema: JSONSchema7 = {\n  $id: v4(),\n  type: 'object',\n  properties: {\n    webhook: {\n      type: 'object',\n      properties: {\n        enabled: { type: 'boolean' },\n        url: { type: 'string' },\n        headers: { type: 'object' },\n        byEvents: { type: 'boolean' },\n        base64: { type: 'boolean' },\n        events: {\n          type: 'array',\n          minItems: 0,\n          items: {\n            type: 'string',\n            enum: EventController.events,\n          },\n        },\n      },\n      required: ['enabled', 'url'],\n      ...isNotEmpty('enabled', 'url'),\n    },\n  },\n  required: ['webhook'],\n};\n"],"mappings":"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","names":["v4","EventController","prismaRepository","waMonitor","integrationStatus","integrationName","prisma","monitor","status","name","set","instanceName","data","enabled","events","length","upsert","where","instanceId","waInstances","update","create","get","undefined","findUnique","__publicField","_EventController","v4","isNotEmpty","__name","propertyNames","properties","forEach","property","minLength","description","if","enum","then","pusherSchema","$id","v4","type","pusher","enabled","appId","key","secret","cluster","useTLS","events","minItems","items","EventController","required","v4","isNotEmpty","__name","propertyNames","properties","forEach","property","minLength","description","if","enum","then","webhookSchema","$id","v4","type","webhook","enabled","url","headers","byEvents","base64","events","minItems","items","EventController","required","eventSchema","$id","v4","type","properties","websocket","$ref","rabbitmq","nats","sqs","kafka","$defs","event","enabled","enum","events","minItems","items","EventController","required"]}
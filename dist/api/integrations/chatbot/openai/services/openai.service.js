var z=Object.create;var L=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty;var re=(t,s,e)=>s in t?L(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e;var C=(t,s)=>L(t,"name",{value:s,configurable:!0});var te=(t,s)=>{for(var e in s)L(t,e,{get:s[e],enumerable:!0})},f=(t,s,e,E)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of ee(s))!Ee.call(t,r)&&r!==e&&L(t,r,{get:()=>s[r],enumerable:!(E=Z(s,r))||E.enumerable});return t};var P=(t,s,e)=>(e=t!=null?z(se(t)):{},f(s||!t||!t.__esModule?L(e,"default",{value:t,enumerable:!0}):e,t)),Se=t=>f(L({},"__esModule",{value:!0}),t);var u=(t,s,e)=>re(t,typeof s!="symbol"?s+"":s,e);var Ae={};te(Ae,{OpenaiService:()=>H});module.exports=Se(Ae);var I={WHATSAPP_BUSINESS:"WHATSAPP-BUSINESS",WHATSAPP_BAILEYS:"WHATSAPP-BAILEYS",EVOLUTION:"EVOLUTION"};var m=require("class-validator"),b=P(require("dotenv"));b.default.config();var h=class h{constructor(){u(this,"env");this.loadEnv()}get(s){return this.env[s]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{NAME:process.env?.SERVER_NAME||"evolution",TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY,EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",FRAME_MAX:Number.parseInt(process.env.RABBITMQ_FRAME_MAX)||8192,EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},NATS:{ENABLED:process.env?.NATS_ENABLED==="true",GLOBAL_ENABLED:process.env?.NATS_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.NATS_PREFIX_KEY,EXCHANGE_NAME:process.env?.NATS_EXCHANGE_NAME||"evolution_exchange",URI:process.env.NATS_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.NATS_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.NATS_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.NATS_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.NATS_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.NATS_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.NATS_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.NATS_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.NATS_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.NATS_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.NATS_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.NATS_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.NATS_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.NATS_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.NATS_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.NATS_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.NATS_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.NATS_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.NATS_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.NATS_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.NATS_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.NATS_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.NATS_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.NATS_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.NATS_EVENTS_CALL==="true",TYPEBOT_START:process.env?.NATS_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",GLOBAL_ENABLED:process.env?.SQS_GLOBAL_ENABLED==="true",GLOBAL_FORCE_SINGLE_QUEUE:process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE==="true",GLOBAL_PREFIX_NAME:process.env?.SQS_GLOBAL_PREFIX_NAME||"global",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||"",MAX_PAYLOAD_SIZE:Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE??"1048576"),EVENTS:{APPLICATION_STARTUP:process.env?.SQS_GLOBAL_APPLICATION_STARTUP==="true",CALL:process.env?.SQS_GLOBAL_CALL==="true",CHATS_DELETE:process.env?.SQS_GLOBAL_CHATS_DELETE==="true",CHATS_SET:process.env?.SQS_GLOBAL_CHATS_SET==="true",CHATS_UPDATE:process.env?.SQS_GLOBAL_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.SQS_GLOBAL_CHATS_UPSERT==="true",CONNECTION_UPDATE:process.env?.SQS_GLOBAL_CONNECTION_UPDATE==="true",CONTACTS_SET:process.env?.SQS_GLOBAL_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.SQS_GLOBAL_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.SQS_GLOBAL_CONTACTS_UPSERT==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE==="true",GROUPS_UPDATE:process.env?.SQS_GLOBAL_GROUPS_UPDATE==="true",GROUPS_UPSERT:process.env?.SQS_GLOBAL_GROUPS_UPSERT==="true",LABELS_ASSOCIATION:process.env?.SQS_GLOBAL_LABELS_ASSOCIATION==="true",LABELS_EDIT:process.env?.SQS_GLOBAL_LABELS_EDIT==="true",LOGOUT_INSTANCE:process.env?.SQS_GLOBAL_LOGOUT_INSTANCE==="true",MESSAGES_DELETE:process.env?.SQS_GLOBAL_MESSAGES_DELETE==="true",MESSAGES_EDITED:process.env?.SQS_GLOBAL_MESSAGES_EDITED==="true",MESSAGES_SET:process.env?.SQS_GLOBAL_MESSAGES_SET==="true",MESSAGES_UPDATE:process.env?.SQS_GLOBAL_MESSAGES_UPDATE==="true",MESSAGES_UPSERT:process.env?.SQS_GLOBAL_MESSAGES_UPSERT==="true",PRESENCE_UPDATE:process.env?.SQS_GLOBAL_PRESENCE_UPDATE==="true",QRCODE_UPDATED:process.env?.SQS_GLOBAL_QRCODE_UPDATED==="true",REMOVE_INSTANCE:process.env?.SQS_GLOBAL_REMOVE_INSTANCE==="true",SEND_MESSAGE:process.env?.SQS_GLOBAL_SEND_MESSAGE==="true",TYPEBOT_CHANGE_STATUS:process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS==="true",TYPEBOT_START:process.env?.SQS_GLOBAL_TYPEBOT_START==="true"}},KAFKA:{ENABLED:process.env?.KAFKA_ENABLED==="true",CLIENT_ID:process.env?.KAFKA_CLIENT_ID||"evolution-api",BROKERS:process.env?.KAFKA_BROKERS?.split(",")||["localhost:9092"],CONNECTION_TIMEOUT:Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT||"3000"),REQUEST_TIMEOUT:Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT||"30000"),GLOBAL_ENABLED:process.env?.KAFKA_GLOBAL_ENABLED==="true",CONSUMER_GROUP_ID:process.env?.KAFKA_CONSUMER_GROUP_ID||"evolution-api-consumers",TOPIC_PREFIX:process.env?.KAFKA_TOPIC_PREFIX||"evolution",NUM_PARTITIONS:Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS||"1"),REPLICATION_FACTOR:Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR||"1"),AUTO_CREATE_TOPICS:process.env?.KAFKA_AUTO_CREATE_TOPICS==="true",EVENTS:{APPLICATION_STARTUP:process.env?.KAFKA_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.KAFKA_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.KAFKA_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.KAFKA_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.KAFKA_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.KAFKA_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.KAFKA_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.KAFKA_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.KAFKA_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.KAFKA_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.KAFKA_EVENTS_CONTACTS_SET==="true",CONTACTS_UPSERT:process.env?.KAFKA_EVENTS_CONTACTS_UPSERT==="true",CONTACTS_UPDATE:process.env?.KAFKA_EVENTS_CONTACTS_UPDATE==="true",PRESENCE_UPDATE:process.env?.KAFKA_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.KAFKA_EVENTS_CHATS_SET==="true",CHATS_UPSERT:process.env?.KAFKA_EVENTS_CHATS_UPSERT==="true",CHATS_UPDATE:process.env?.KAFKA_EVENTS_CHATS_UPDATE==="true",CHATS_DELETE:process.env?.KAFKA_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.KAFKA_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.KAFKA_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.KAFKA_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.KAFKA_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.KAFKA_EVENTS_CALL==="true",TYPEBOT_START:process.env?.KAFKA_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS==="true"},SASL:process.env?.KAFKA_SASL_ENABLED==="true"?{ENABLED:!0,MECHANISM:process.env?.KAFKA_SASL_MECHANISM||"plain",USERNAME:process.env?.KAFKA_SASL_USERNAME||"",PASSWORD:process.env?.KAFKA_SASL_PASSWORD||""}:void 0,SSL:process.env?.KAFKA_SSL_ENABLED==="true"?{ENABLED:!0,REJECT_UNAUTHORIZED:process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED!=="false",CA:process.env?.KAFKA_SSL_CA,KEY:process.env?.KAFKA_SSL_KEY,CERT:process.env?.KAFKA_SSL_CERT}:void 0},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true",ALLOWED_HOSTS:process.env?.WEBSOCKET_ALLOWED_HOSTS},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:(0,m.isBooleanString)(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:(0,m.isBooleanString)(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""},REQUEST:{TIMEOUT_MS:Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS)||3e4},RETRY:{MAX_ATTEMPTS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS)||10,INITIAL_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS)||5,USE_EXPONENTIAL_BACKOFF:process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF!=="false",MAX_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS)||300,JITTER_FACTOR:Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR)||.2,NON_RETRYABLE_STATUS_CODES:process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(",").map(Number)||[400,401,403,404,422]}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome"},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},N8N:{ENABLED:process.env?.N8N_ENABLED==="true"},EVOAI:{ENABLED:process.env?.EVOAI_ENABLED==="true"},FLOWISE:{ENABLED:process.env?.FLOWISE_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION,SKIP_POLICY:process.env?.S3_SKIP_POLICY==="true",SAVE_VIDEO:process.env?.S3_SAVE_VIDEO==="true"},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"},METRICS:{ENABLED:process.env?.PROMETHEUS_METRICS==="true",AUTH_REQUIRED:process.env?.METRICS_AUTH_REQUIRED==="true",USER:process.env?.METRICS_USER,PASSWORD:process.env?.METRICS_PASSWORD,ALLOWED_IPS:process.env?.METRICS_ALLOWED_IPS},TELEMETRY:{ENABLED:process.env?.TELEMETRY_ENABLED===void 0||process.env?.TELEMETRY_ENABLED==="true",URL:process.env?.TELEMETRY_URL},PROXY:{HOST:process.env?.PROXY_HOST,PORT:process.env?.PROXY_PORT,PROTOCOL:process.env?.PROXY_PROTOCOL,USERNAME:process.env?.PROXY_USERNAME,PASSWORD:process.env?.PROXY_PASSWORD},AUDIO_CONVERTER:{API_URL:process.env?.API_AUDIO_CONVERTER,API_KEY:process.env?.API_AUDIO_CONVERTER_KEY},FACEBOOK:{APP_ID:process.env?.FACEBOOK_APP_ID,CONFIG_ID:process.env?.FACEBOOK_CONFIG_ID,USER_TOKEN:process.env?.FACEBOOK_USER_TOKEN},SENTRY:{DSN:process.env?.SENTRY_DSN},EVENT_EMITTER:{MAX_LISTENERS:Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS)||50}}}};C(h,"ConfigService");var M=h,l=new M;var y=P(require("axios")),w=P(require("fs"));var Te=JSON.parse(w.default.readFileSync("./package.json","utf8")),B=C(async t=>{let s=l.get("TELEMETRY");if(!s.ENABLED||t==="/")return;let e={route:t,apiVersion:`${Te.version}`,timestamp:new Date},E=s.URL&&s.URL!==""?s.URL:"https://log.evolution-api.com/telemetry";y.default.post(E,e).then(()=>{}).catch(()=>{})},"sendTelemetry");var U=P(require("axios")),X=require("baileys"),k=require("class-validator"),q=P(require("form-data")),J=P(require("openai")),j=P(require("pino"));var F=P(require("dayjs")),Y=P(require("fs"));var _e=JSON.parse(Y.default.readFileSync("./package.json","utf8")),x=C(t=>(0,F.default)(t).toDate().toString().replace(/\sGMT.+/,""),"formatDateLog"),D=(function(t){return t.LOG="\x1B[32m",t.INFO="\x1B[34m",t.WARN="\x1B[33m",t.ERROR="\x1B[31m",t.DEBUG="\x1B[36m",t.VERBOSE="\x1B[37m",t.DARK="\x1B[30m",t})(D||{});var W=(function(t){return t.LOG="\x1B[32m%s\x1B[0m",t.DARK="\x1B[30m%s\x1B[0m",t.INFO="\x1B[34m%s\x1B[0m",t.WARN="\x1B[33m%s\x1B[0m",t.ERROR="\x1B[31m%s\x1B[0m",t.DEBUG="\x1B[36m%s\x1B[0m",t.VERBOSE="\x1B[37m%s\x1B[0m",t})(W||{}),Q=(function(t){return t.LOG="LOG",t.WARN="WARN",t.INFO="INFO",t.DARK="DARK",t.ERROR="ERROR",t.DEBUG="DEBUG",t.VERBOSE="VERBOSE",t})(Q||{}),$=(function(t){return t.LOG="\x1B[42m",t.INFO="\x1B[44m",t.WARN="\x1B[43m",t.DARK="\x1B[40m",t.ERROR="\x1B[41m",t.DEBUG="\x1B[46m",t.VERBOSE="\x1B[47m",t})($||{}),G=class G{constructor(s="Logger"){u(this,"configService",l);u(this,"context");u(this,"instance",null);this.context=s}setContext(s){this.context=s}setInstance(s){this.instance=s}console(s,e){let E=[];this.configService.get("LOG").LEVEL.forEach(T=>E.push(Q[T]));let r=typeof s;E.includes(e)&&(l.get("LOG").COLOR?(console.log("\x1B[1m"+W[e],"[Evolution API]","\x1B[1m"+D[e],this.instance?`[${this.instance}]`:"","\x1B[1m"+D[e],`v${_e.version}`,"\x1B[1m"+D[e],process.pid.toString(),"\x1B[0m","\x1B[1m"+D[e],"-","\x1B[1m\x1B[37m",`${x(Date.now())}  `,"\x1B[0m",D[e]+$[e]+"\x1B[1m",`${e} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,D[e]+"\x1B[1m",`[${r}]\x1B[0m`,D[e],r!=="object"?s:"","\x1B[0m"),r==="object"&&console.log(s,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${x(Date.now())}  `,`${e} `,`[${this.context}]`,`[${r}]`,s))}log(s){this.console(s,"LOG")}info(s){this.console(s,"INFO")}warn(s){this.console(s,"WARN")}error(s){this.console(s,"ERROR")}verbose(s){this.console(s,"VERBOSE")}debug(s){this.console(s,"DEBUG")}dark(s){this.console(s,"DARK")}};C(G,"Logger");var v=G;var V=class V{constructor(s,e,E,r){u(this,"logger");u(this,"waMonitor");u(this,"prismaRepository");u(this,"configService");this.waMonitor=s,this.prismaRepository=e,this.logger=new v(E),this.configService=r}isImageMessage(s){return s.includes("imageMessage")}isAudioMessage(s){return s.includes("audioMessage")}isJSON(s){try{return JSON.parse(s),!0}catch{return!1}}getMediaType(s){let e=s.split(".").pop()?.toLowerCase(),E=["jpg","jpeg","png","gif","bmp","webp"],r=["mp3","wav","aac","ogg"],T=["mp4","avi","mkv","mov"],o=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return E.includes(e||"")?"image":r.includes(e||"")?"audio":T.includes(e||"")?"video":o.includes(e||"")?"document":null}async createNewSession(s,e,E){try{let r=typeof e.pushName=="object"&&e.pushName?.pushName?e.pushName.pushName:typeof e.pushName=="string"?e.pushName:null,T=typeof e.remoteJid=="object"&&e.remoteJid?.remoteJid?e.remoteJid.remoteJid:e.remoteJid;return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:T,pushName:r,sessionId:T,status:"opened",awaitUser:!1,botId:e.botId,instanceId:s.instanceId,type:E}})}}catch(r){this.logger.error(r);return}}async process(s,e,E,r,T,o,S,_){try{if(!r){await this.initNewSession(s,e,E,T,r,o,S,_);return}if(r.status==="paused")return;let n=T?.keywordFinish||"",A=o.toLowerCase().trim();if(n.length>0&&A===n.toLowerCase()){await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}});return}await this.sendMessageToBot(s,r,T,E,e,S||"",o,_),await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"opened",awaitUser:!0}})}catch(n){this.logger.error(`Error in process: ${n}`);return}}async sendMessageWhatsApp(s,e,E,r,T=!0){if(!E)return;let o=/!?\[(.*?)\]\((.*?)\)/g,S="",_=0,n,A=r?.splitMessages??!1;for(;(n=o.exec(E))!==null;){let[a,N,c]=n,R=this.getMediaType(c),p=E.slice(_,n.index);if(p&&(S+=p),R){S.trim()&&(await this.sendFormattedText(s,e,S.trim(),r,A,T),S="");try{R==="audio"?await s.audioWhatsapp({number:e.includes("@lid")?e:e.split("@")[0],delay:r?.delayMessage||1e3,audio:c,caption:N}):await s.mediaMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:r?.delayMessage||1e3,mediatype:R,media:c,caption:N,fileName:R==="document"?N||"document":void 0},null,!1)}catch(O){this.logger.error(`Error sending media: ${O}`),S+=`${N}: ${c}`}}else S+=a;_=o.lastIndex}if(_<E.length){let a=E.slice(_);a.trim()&&(S+=a)}S.trim()&&await this.sendFormattedText(s,e,S.trim(),r,A,T)}splitMessageByDoubleLineBreaks(s){return s.split(`

`).filter(e=>e.trim().length>0)}async sendSingleMessage(s,e,E,r,T=!0){let o=r?.timePerChar??0,n=Math.min(Math.max(E.length*o,1e3),2e4);this.logger.debug(`[BaseChatbot] Sending single message with linkPreview: ${T}`),s.integration===I.WHATSAPP_BAILEYS&&(await s.client.presenceSubscribe(e),await s.client.sendPresenceUpdate("composing",e)),await new Promise(A=>{setTimeout(async()=>{await s.textMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:r?.delayMessage||1e3,text:E,linkPreview:T},!1),A()},n)}),s.integration===I.WHATSAPP_BAILEYS&&await s.client.sendPresenceUpdate("paused",e)}async sendFormattedText(s,e,E,r,T,o=!0){if(T){let S=this.splitMessageByDoubleLineBreaks(E);this.logger.debug(`[BaseChatbot] Splitting message into ${S.length} parts`);for(let _=0;_<S.length;_++){let n=S[_];this.logger.debug(`[BaseChatbot] Sending message part ${_+1}/${S.length}`),await this.sendSingleMessage(s,e,n,r,o)}this.logger.debug("[BaseChatbot] All message parts sent successfully")}else this.logger.debug("[BaseChatbot] Sending single message"),await this.sendSingleMessage(s,e,E,r,o)}async initNewSession(s,e,E,r,T,o,S,_){if(!T){let n=typeof S=="object"&&S?.pushName?S.pushName:typeof S=="string"?S:null,A=await this.createNewSession({instanceName:s.instanceName,instanceId:s.instanceId},{remoteJid:e,pushName:n,botId:E.id},this.getBotType());if(!A||!A.session){this.logger.error("Failed to create new session");return}T=A.session}await this.prismaRepository.integrationSession.update({where:{id:T.id},data:{status:"opened",awaitUser:!1}}),await this.sendMessageToBot(s,T,r,E,e,S||"",o,_)}};C(V,"BaseChatbotService");var d=V;var K=class K extends d{constructor(e,E,r){super(e,E,"OpenaiService",r);u(this,"client")}getBotType(){return"openai"}initClient(e){return this.client=new J.default({apiKey:e}),this.client}async process(e,E,r,T,o,S,_,n){try{if(this.logger.log(`Starting process for remoteJid: ${E}, bot type: ${r.botType}`),S.startsWith("audioMessage|")&&n){this.logger.log("Detected audio message, attempting to transcribe");let N=await this.prismaRepository.openaiCreds.findUnique({where:{id:r.openaiCredsId}});if(!N){this.logger.error(`OpenAI credentials not found. CredsId: ${r.openaiCredsId}`);return}this.initClient(N.apiKey);let c=await this.speechToText(n,e);if(c)this.logger.log(`Audio transcribed: ${c}`),S=c;else{this.logger.error("Failed to transcribe audio"),await this.sendMessageWhatsApp(e,E,"Sorry, I couldn't transcribe your audio message. Could you please type your message instead?",o,!0);return}}else{let N=await this.prismaRepository.openaiCreds.findUnique({where:{id:r.openaiCredsId}});if(!N){this.logger.error(`OpenAI credentials not found. CredsId: ${r.openaiCredsId}`);return}this.initClient(N.apiKey)}let A=o?.keywordFinish||"",a=S.toLowerCase().trim();if(A.length>0&&a===A.toLowerCase()){o?.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:T.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.delete({where:{id:T.id}}),await B("/openai/session/finish");return}if(!T){let N={remoteJid:E,pushName:_,botId:r.id},c=await this.createNewSession({instanceName:e.instanceName,instanceId:e.instanceId},N,this.getBotType());await this.initNewSession(e,E,r,o,c.session,S,_,n),await B("/openai/session/start");return}if(T.status==="paused"){await this.prismaRepository.integrationSession.update({where:{id:T.id},data:{status:"opened",awaitUser:!0}});return}await this.sendMessageToBot(e,T,o,r,E,_||"",S,n)}catch(A){this.logger.error(`Error in process: ${A.message||JSON.stringify(A)}`);return}}async sendMessageToBot(e,E,r,T,o,S,_,n){if(this.logger.log(`Sending message to bot for remoteJid: ${o}, bot type: ${T.botType}`),!this.client){this.logger.log("Client not initialized, initializing now");let A=await this.prismaRepository.openaiCreds.findUnique({where:{id:T.openaiCredsId}});if(!A){this.logger.error(`OpenAI credentials not found in sendMessageToBot. CredsId: ${T.openaiCredsId}`);return}this.initClient(A.apiKey)}try{let A;T.botType==="assistant"?(this.logger.log("Processing with Assistant API"),A=await this.processAssistantMessage(e,E,T,o,S,!1,_,n)):(this.logger.log("Processing with ChatCompletion API"),A=await this.processChatCompletionMessage(e,T,o,_,n)),this.logger.log(`Got response from OpenAI: ${A?.substring(0,50)}${A?.length>50?"...":""}`),A?(this.logger.log("Sending message to WhatsApp"),await this.sendMessageWhatsApp(e,o,A,r,!0)):this.logger.error("No message to send to WhatsApp"),await this.prismaRepository.integrationSession.update({where:{id:E.id},data:{status:"opened",awaitUser:!0}})}catch(A){this.logger.error(`Error in sendMessageToBot: ${A.message||JSON.stringify(A)}`),A.response&&this.logger.error(`API Response data: ${JSON.stringify(A.response.data||{})}`);return}}async processAssistantMessage(e,E,r,T,o,S,_,n){let A={role:S?"assistant":"user",content:[{type:"text",text:_}]};if(this.isImageMessage(_)){let p=_.split("|");if(n.message.mediaUrl||n.message.base64){let O=n.message.base64||null;if(n.message.mediaUrl&&(0,k.isURL)(n.message.mediaUrl)){let i=await U.default.get(n.message.mediaUrl,{responseType:"arraybuffer"});O=Buffer.from(i.data).toString("base64")}O&&(A.content=[{type:"text",text:p[2]||_},{type:"image_url",image_url:{url:O}}])}else{let O=p[1].split("?")[0];A.content=[{type:"text",text:p[2]||_},{type:"image_url",image_url:{url:O}}]}}let a=E.sessionId;if((!a||a===T)&&(a=(await this.client.beta.threads.create()).id,await this.prismaRepository.integrationSession.update({where:{id:E.id},data:{sessionId:a}}),this.logger.log(`Created new thread ID: ${a} for session: ${E.id}`)),await this.client.beta.threads.messages.create(a,A),S)return B("/message/sendText"),"";let N=await this.client.beta.threads.runs.create(a,{assistant_id:r.assistantId});e.integration===I.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(T),await e.client.sendPresenceUpdate("composing",T));let c=await this.getAIResponse(a,N.id,r.functionUrl,T,o);e.integration===I.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",T);let R="I couldn't generate a proper response. Please try again.";try{let p=c?.data||[];if(p.length>0){let O=p[0]?.content||[];if(O.length>0){let i=O[0];i&&"text"in i&&i.text&&"value"in i.text&&(R=i.text.value)}}}catch(p){this.logger.error(`Error extracting response text: ${p}`)}return await this.prismaRepository.integrationSession.update({where:{id:E.id},data:{status:"opened",awaitUser:!0,sessionId:a}}),R}async processChatCompletionMessage(e,E,r,T,o){if(this.logger.log("Starting processChatCompletionMessage"),!this.client){this.logger.log("Client not initialized in processChatCompletionMessage, initializing now");let i=await this.prismaRepository.openaiCreds.findUnique({where:{id:E.openaiCredsId}});if(!i)return this.logger.error(`OpenAI credentials not found. CredsId: ${E.openaiCredsId}`),"Error: OpenAI credentials not found";this.initClient(i.apiKey)}if(!E.model)return this.logger.error("OpenAI model not defined"),"Error: OpenAI model not configured";this.logger.log(`Using model: ${E.model}, max tokens: ${E.maxTokens||500}`);let S=await this.prismaRepository.integrationSession.findFirst({where:{remoteJid:r,botId:E.id,status:"opened"}}),_=[];if(S&&S.context)try{_=(typeof S.context=="string"?JSON.parse(S.context):S.context).history||[],this.logger.log(`Retrieved conversation history from session, ${_.length} messages`)}catch(i){this.logger.error(`Error parsing session context: ${i.message}`),_=[]}this.logger.log(`Bot data - systemMessages: ${JSON.stringify(E.systemMessages||[])}`),this.logger.log(`Bot data - assistantMessages: ${JSON.stringify(E.assistantMessages||[])}`),this.logger.log(`Bot data - userMessages: ${JSON.stringify(E.userMessages||[])}`);let A=(E.systemMessages||[]).map(i=>({role:"system",content:i})),N=(E.assistantMessages||[]).map(i=>({role:"assistant",content:i})),R=(E.userMessages||[]).map(i=>({role:"user",content:i})),p={role:"user",content:[{type:"text",text:T}]};if(this.isImageMessage(T)){this.logger.log("Found image message");let i=T.split("|");if(o.message.mediaUrl||o.message.base64)p.content=[{type:"text",text:i[2]||T},{type:"image_url",image_url:{url:o.message.base64||o.message.mediaUrl}}];else{let g=i[1].split("?")[0];p.content=[{type:"text",text:i[2]||T},{type:"image_url",image_url:{url:g}}]}}let O=[...A,...N,...R,..._,p];this.logger.log(`Final messages payload: ${JSON.stringify(O)}`),e.integration===I.WHATSAPP_BAILEYS&&(this.logger.log("Setting typing indicator"),await e.client.presenceSubscribe(r),await e.client.sendPresenceUpdate("composing",r));try{this.logger.log("Sending request to OpenAI API");let i=await this.client.chat.completions.create({model:E.model,messages:O,max_tokens:E.maxTokens||500});e.integration===I.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",r);let g=i.choices[0].message.content;return this.logger.log(`Received response from OpenAI: ${JSON.stringify(i.choices[0])}`),_.push(p),_.push({role:"assistant",content:g}),_.length>10&&(_=_.slice(_.length-10)),S&&(await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{context:JSON.stringify({history:_})}}),this.logger.log(`Updated session with conversation history, now ${_.length} messages`)),g}catch(i){return this.logger.error(`Error calling OpenAI: ${i.message||JSON.stringify(i)}`),i.response&&(this.logger.error(`API Response status: ${i.response.status}`),this.logger.error(`API Response data: ${JSON.stringify(i.response.data||{})}`)),`Sorry, there was an error: ${i.message||"Unknown error"}`}}async getAIResponse(e,E,r,T,o){let S=await this.client.beta.threads.runs.retrieve(e,E),_=60,n=1e3;for(;S.status!=="completed"&&S.status!=="failed"&&S.status!=="cancelled"&&S.status!=="expired"&&_>0;){if(await new Promise(A=>setTimeout(A,n)),S=await this.client.beta.threads.runs.retrieve(e,E),S.status==="requires_action"&&S.required_action?.type==="submit_tool_outputs"){let A=S.required_action.submit_tool_outputs.tool_calls,a=[];for(let N of A)if(r)try{let c=JSON.parse(N.function.arguments);c.remoteJid=T,c.pushName=o;let R=await U.default.post(r,{functionName:N.function.name,functionArguments:c});a.push({tool_call_id:N.id,output:JSON.stringify(R.data)})}catch(c){this.logger.error(`Error calling function: ${c}`),a.push({tool_call_id:N.id,output:JSON.stringify({error:"Function call failed"})})}else a.push({tool_call_id:N.id,output:JSON.stringify({error:"No function URL configured"})});await this.client.beta.threads.runs.submitToolOutputs(e,E,{tool_outputs:a})}_--}return S.status==="completed"?await this.client.beta.threads.messages.list(e):(this.logger.error(`Assistant run failed with status: ${S.status}`),{data:[{content:[{text:{value:"Failed to get a response from the assistant."}}]}]})}isImageMessage(e){return e.includes("imageMessage")}async speechToText(e,E){let r=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:E.instanceId}});if(!r)return this.logger.error(`OpenAI settings not found. InstanceId: ${E.instanceId}`),null;let T=await this.prismaRepository.openaiCreds.findUnique({where:{id:r.openaiCredsId}});if(!T)return this.logger.error(`OpenAI credentials not found. CredsId: ${r.openaiCredsId}`),null;let o;e.message.mediaUrl?o=await U.default.get(e.message.mediaUrl,{responseType:"arraybuffer"}).then(a=>Buffer.from(a.data,"binary")):e.message.base64?o=Buffer.from(e.message.base64,"base64"):o=await(0,X.downloadMediaMessage)({key:e.key,message:e?.message},"buffer",{},{logger:(0,j.default)({level:"error"}),reuploadRequest:E});let S=this.configService.get("LANGUAGE").includes("pt")?"pt":this.configService.get("LANGUAGE"),_=new q.default;_.append("file",o,"audio.ogg"),_.append("model","whisper-1"),_.append("language",S);let n=T?.apiKey||this.configService.get("OPENAI").API_KEY_GLOBAL;return(await U.default.post("https://api.openai.com/v1/audio/transcriptions",_,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${n}`}}))?.data?.text}};C(K,"OpenaiService");var H=K;0&&(module.exports={OpenaiService});
//# sourceMappingURL=openai.service.js.map
var Z=Object.create;var i=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var EE=Object.getOwnPropertyNames;var eE=Object.getPrototypeOf,SE=Object.prototype.hasOwnProperty;var sE=(S,E,e)=>E in S?i(S,E,{enumerable:!0,configurable:!0,writable:!0,value:e}):S[E]=e;var R=(S,E)=>i(S,"name",{value:E,configurable:!0});var TE=(S,E)=>{for(var e in E)i(S,e,{get:E[e],enumerable:!0})},Y=(S,E,e,T)=>{if(E&&typeof E=="object"||typeof E=="function")for(let s of EE(E))!SE.call(S,s)&&s!==e&&i(S,s,{get:()=>E[s],enumerable:!(T=z(E,s))||T.enumerable});return S};var G=(S,E,e)=>(e=S!=null?Z(eE(S)):{},Y(E||!S||!S.__esModule?i(e,"default",{value:S,enumerable:!0}):e,S)),_E=S=>Y(i({},"__esModule",{value:!0}),S);var O=(S,E,e)=>sE(S,typeof E!="symbol"?E+"":E,e);var rE={};TE(rE,{EvoaiService:()=>b});module.exports=_E(rE);var u={WHATSAPP_BUSINESS:"WHATSAPP-BUSINESS",WHATSAPP_BAILEYS:"WHATSAPP-BAILEYS",EVOLUTION:"EVOLUTION"};var f=G(require("axios")),k=require("baileys"),J=require("class-validator"),h=require("uuid");var y=G(require("dayjs")),w=G(require("fs"));var l=require("class-validator"),W=G(require("dotenv"));W.default.config();var m=class m{constructor(){O(this,"env");this.loadEnv()}get(E){return this.env[E]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{NAME:process.env?.SERVER_NAME||"evolution",TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY,EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",FRAME_MAX:Number.parseInt(process.env.RABBITMQ_FRAME_MAX)||8192,EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},NATS:{ENABLED:process.env?.NATS_ENABLED==="true",GLOBAL_ENABLED:process.env?.NATS_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.NATS_PREFIX_KEY,EXCHANGE_NAME:process.env?.NATS_EXCHANGE_NAME||"evolution_exchange",URI:process.env.NATS_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.NATS_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.NATS_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.NATS_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.NATS_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.NATS_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.NATS_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.NATS_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.NATS_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.NATS_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.NATS_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.NATS_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.NATS_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.NATS_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.NATS_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.NATS_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.NATS_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.NATS_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.NATS_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.NATS_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.NATS_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.NATS_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.NATS_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.NATS_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.NATS_EVENTS_CALL==="true",TYPEBOT_START:process.env?.NATS_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",GLOBAL_ENABLED:process.env?.SQS_GLOBAL_ENABLED==="true",GLOBAL_FORCE_SINGLE_QUEUE:process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE==="true",GLOBAL_PREFIX_NAME:process.env?.SQS_GLOBAL_PREFIX_NAME||"global",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||"",MAX_PAYLOAD_SIZE:Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE??"1048576"),EVENTS:{APPLICATION_STARTUP:process.env?.SQS_GLOBAL_APPLICATION_STARTUP==="true",CALL:process.env?.SQS_GLOBAL_CALL==="true",CHATS_DELETE:process.env?.SQS_GLOBAL_CHATS_DELETE==="true",CHATS_SET:process.env?.SQS_GLOBAL_CHATS_SET==="true",CHATS_UPDATE:process.env?.SQS_GLOBAL_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.SQS_GLOBAL_CHATS_UPSERT==="true",CONNECTION_UPDATE:process.env?.SQS_GLOBAL_CONNECTION_UPDATE==="true",CONTACTS_SET:process.env?.SQS_GLOBAL_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.SQS_GLOBAL_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.SQS_GLOBAL_CONTACTS_UPSERT==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE==="true",GROUPS_UPDATE:process.env?.SQS_GLOBAL_GROUPS_UPDATE==="true",GROUPS_UPSERT:process.env?.SQS_GLOBAL_GROUPS_UPSERT==="true",LABELS_ASSOCIATION:process.env?.SQS_GLOBAL_LABELS_ASSOCIATION==="true",LABELS_EDIT:process.env?.SQS_GLOBAL_LABELS_EDIT==="true",LOGOUT_INSTANCE:process.env?.SQS_GLOBAL_LOGOUT_INSTANCE==="true",MESSAGES_DELETE:process.env?.SQS_GLOBAL_MESSAGES_DELETE==="true",MESSAGES_EDITED:process.env?.SQS_GLOBAL_MESSAGES_EDITED==="true",MESSAGES_SET:process.env?.SQS_GLOBAL_MESSAGES_SET==="true",MESSAGES_UPDATE:process.env?.SQS_GLOBAL_MESSAGES_UPDATE==="true",MESSAGES_UPSERT:process.env?.SQS_GLOBAL_MESSAGES_UPSERT==="true",PRESENCE_UPDATE:process.env?.SQS_GLOBAL_PRESENCE_UPDATE==="true",QRCODE_UPDATED:process.env?.SQS_GLOBAL_QRCODE_UPDATED==="true",REMOVE_INSTANCE:process.env?.SQS_GLOBAL_REMOVE_INSTANCE==="true",SEND_MESSAGE:process.env?.SQS_GLOBAL_SEND_MESSAGE==="true",TYPEBOT_CHANGE_STATUS:process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS==="true",TYPEBOT_START:process.env?.SQS_GLOBAL_TYPEBOT_START==="true"}},KAFKA:{ENABLED:process.env?.KAFKA_ENABLED==="true",CLIENT_ID:process.env?.KAFKA_CLIENT_ID||"evolution-api",BROKERS:process.env?.KAFKA_BROKERS?.split(",")||["localhost:9092"],CONNECTION_TIMEOUT:Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT||"3000"),REQUEST_TIMEOUT:Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT||"30000"),GLOBAL_ENABLED:process.env?.KAFKA_GLOBAL_ENABLED==="true",CONSUMER_GROUP_ID:process.env?.KAFKA_CONSUMER_GROUP_ID||"evolution-api-consumers",TOPIC_PREFIX:process.env?.KAFKA_TOPIC_PREFIX||"evolution",NUM_PARTITIONS:Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS||"1"),REPLICATION_FACTOR:Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR||"1"),AUTO_CREATE_TOPICS:process.env?.KAFKA_AUTO_CREATE_TOPICS==="true",EVENTS:{APPLICATION_STARTUP:process.env?.KAFKA_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.KAFKA_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.KAFKA_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.KAFKA_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.KAFKA_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.KAFKA_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.KAFKA_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.KAFKA_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.KAFKA_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.KAFKA_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.KAFKA_EVENTS_CONTACTS_SET==="true",CONTACTS_UPSERT:process.env?.KAFKA_EVENTS_CONTACTS_UPSERT==="true",CONTACTS_UPDATE:process.env?.KAFKA_EVENTS_CONTACTS_UPDATE==="true",PRESENCE_UPDATE:process.env?.KAFKA_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.KAFKA_EVENTS_CHATS_SET==="true",CHATS_UPSERT:process.env?.KAFKA_EVENTS_CHATS_UPSERT==="true",CHATS_UPDATE:process.env?.KAFKA_EVENTS_CHATS_UPDATE==="true",CHATS_DELETE:process.env?.KAFKA_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.KAFKA_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.KAFKA_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.KAFKA_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.KAFKA_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.KAFKA_EVENTS_CALL==="true",TYPEBOT_START:process.env?.KAFKA_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS==="true"},SASL:process.env?.KAFKA_SASL_ENABLED==="true"?{ENABLED:!0,MECHANISM:process.env?.KAFKA_SASL_MECHANISM||"plain",USERNAME:process.env?.KAFKA_SASL_USERNAME||"",PASSWORD:process.env?.KAFKA_SASL_PASSWORD||""}:void 0,SSL:process.env?.KAFKA_SSL_ENABLED==="true"?{ENABLED:!0,REJECT_UNAUTHORIZED:process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED!=="false",CA:process.env?.KAFKA_SSL_CA,KEY:process.env?.KAFKA_SSL_KEY,CERT:process.env?.KAFKA_SSL_CERT}:void 0},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true",ALLOWED_HOSTS:process.env?.WEBSOCKET_ALLOWED_HOSTS},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:(0,l.isBooleanString)(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:(0,l.isBooleanString)(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""},REQUEST:{TIMEOUT_MS:Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS)||3e4},RETRY:{MAX_ATTEMPTS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS)||10,INITIAL_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS)||5,USE_EXPONENTIAL_BACKOFF:process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF!=="false",MAX_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS)||300,JITTER_FACTOR:Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR)||.2,NON_RETRYABLE_STATUS_CODES:process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(",").map(Number)||[400,401,403,404,422]}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome"},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},N8N:{ENABLED:process.env?.N8N_ENABLED==="true"},EVOAI:{ENABLED:process.env?.EVOAI_ENABLED==="true"},FLOWISE:{ENABLED:process.env?.FLOWISE_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION,SKIP_POLICY:process.env?.S3_SKIP_POLICY==="true",SAVE_VIDEO:process.env?.S3_SAVE_VIDEO==="true"},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"},METRICS:{ENABLED:process.env?.PROMETHEUS_METRICS==="true",AUTH_REQUIRED:process.env?.METRICS_AUTH_REQUIRED==="true",USER:process.env?.METRICS_USER,PASSWORD:process.env?.METRICS_PASSWORD,ALLOWED_IPS:process.env?.METRICS_ALLOWED_IPS},TELEMETRY:{ENABLED:process.env?.TELEMETRY_ENABLED===void 0||process.env?.TELEMETRY_ENABLED==="true",URL:process.env?.TELEMETRY_URL},PROXY:{HOST:process.env?.PROXY_HOST,PORT:process.env?.PROXY_PORT,PROTOCOL:process.env?.PROXY_PROTOCOL,USERNAME:process.env?.PROXY_USERNAME,PASSWORD:process.env?.PROXY_PASSWORD},AUDIO_CONVERTER:{API_URL:process.env?.API_AUDIO_CONVERTER,API_KEY:process.env?.API_AUDIO_CONVERTER_KEY},FACEBOOK:{APP_ID:process.env?.FACEBOOK_APP_ID,CONFIG_ID:process.env?.FACEBOOK_CONFIG_ID,USER_TOKEN:process.env?.FACEBOOK_USER_TOKEN},SENTRY:{DSN:process.env?.SENTRY_DSN},EVENT_EMITTER:{MAX_LISTENERS:Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS)||50}}}};R(m,"ConfigService");var H=m,K=new H;var AE=JSON.parse(w.default.readFileSync("./package.json","utf8")),Q=R(S=>(0,y.default)(S).toDate().toString().replace(/\sGMT.+/,""),"formatDateLog"),C=(function(S){return S.LOG="\x1B[32m",S.INFO="\x1B[34m",S.WARN="\x1B[33m",S.ERROR="\x1B[31m",S.DEBUG="\x1B[36m",S.VERBOSE="\x1B[37m",S.DARK="\x1B[30m",S})(C||{});var X=(function(S){return S.LOG="\x1B[32m%s\x1B[0m",S.DARK="\x1B[30m%s\x1B[0m",S.INFO="\x1B[34m%s\x1B[0m",S.WARN="\x1B[33m%s\x1B[0m",S.ERROR="\x1B[31m%s\x1B[0m",S.DEBUG="\x1B[36m%s\x1B[0m",S.VERBOSE="\x1B[37m%s\x1B[0m",S})(X||{}),$=(function(S){return S.LOG="LOG",S.WARN="WARN",S.INFO="INFO",S.DARK="DARK",S.ERROR="ERROR",S.DEBUG="DEBUG",S.VERBOSE="VERBOSE",S})($||{}),j=(function(S){return S.LOG="\x1B[42m",S.INFO="\x1B[44m",S.WARN="\x1B[43m",S.DARK="\x1B[40m",S.ERROR="\x1B[41m",S.DEBUG="\x1B[46m",S.VERBOSE="\x1B[47m",S})(j||{}),g=class g{constructor(E="Logger"){O(this,"configService",K);O(this,"context");O(this,"instance",null);this.context=E}setContext(E){this.context=E}setInstance(E){this.instance=E}console(E,e){let T=[];this.configService.get("LOG").LEVEL.forEach(A=>T.push($[A]));let s=typeof E;T.includes(e)&&(K.get("LOG").COLOR?(console.log("\x1B[1m"+X[e],"[Evolution API]","\x1B[1m"+C[e],this.instance?`[${this.instance}]`:"","\x1B[1m"+C[e],`v${AE.version}`,"\x1B[1m"+C[e],process.pid.toString(),"\x1B[0m","\x1B[1m"+C[e],"-","\x1B[1m\x1B[37m",`${Q(Date.now())}  `,"\x1B[0m",C[e]+j[e]+"\x1B[1m",`${e} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,C[e]+"\x1B[1m",`[${s}]\x1B[0m`,C[e],s!=="object"?E:"","\x1B[0m"),s==="object"&&console.log(E,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${Q(Date.now())}  `,`${e} `,`[${this.context}]`,`[${s}]`,E))}log(E){this.console(E,"LOG")}info(E){this.console(E,"INFO")}warn(E){this.console(E,"WARN")}error(E){this.console(E,"ERROR")}verbose(E){this.console(E,"VERBOSE")}debug(E){this.console(E,"DEBUG")}dark(E){this.console(E,"DARK")}};R(g,"Logger");var M=g;var d=class d{constructor(E,e,T,s){O(this,"logger");O(this,"waMonitor");O(this,"prismaRepository");O(this,"configService");this.waMonitor=E,this.prismaRepository=e,this.logger=new M(T),this.configService=s}isImageMessage(E){return E.includes("imageMessage")}isAudioMessage(E){return E.includes("audioMessage")}isJSON(E){try{return JSON.parse(E),!0}catch{return!1}}getMediaType(E){let e=E.split(".").pop()?.toLowerCase(),T=["jpg","jpeg","png","gif","bmp","webp"],s=["mp3","wav","aac","ogg"],A=["mp4","avi","mkv","mov"],t=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return T.includes(e||"")?"image":s.includes(e||"")?"audio":A.includes(e||"")?"video":t.includes(e||"")?"document":null}async createNewSession(E,e,T){try{let s=typeof e.pushName=="object"&&e.pushName?.pushName?e.pushName.pushName:typeof e.pushName=="string"?e.pushName:null,A=typeof e.remoteJid=="object"&&e.remoteJid?.remoteJid?e.remoteJid.remoteJid:e.remoteJid;return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:A,pushName:s,sessionId:A,status:"opened",awaitUser:!1,botId:e.botId,instanceId:E.instanceId,type:T}})}}catch(s){this.logger.error(s);return}}async process(E,e,T,s,A,t,r,o){try{if(!s){await this.initNewSession(E,e,T,A,s,t,r,o);return}if(s.status==="paused")return;let _=A?.keywordFinish||"",n=t.toLowerCase().trim();if(_.length>0&&n===_.toLowerCase()){await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}});return}await this.sendMessageToBot(E,s,A,T,e,r||"",t,o),await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"opened",awaitUser:!0}})}catch(_){this.logger.error(`Error in process: ${_}`);return}}async sendMessageWhatsApp(E,e,T,s,A=!0){if(!T)return;let t=/!?\[(.*?)\]\((.*?)\)/g,r="",o=0,_,n=s?.splitMessages??!1;for(;(_=t.exec(T))!==null;){let[P,I,D]=_,p=this.getMediaType(D),U=T.slice(o,_.index);if(U&&(r+=U),p){r.trim()&&(await this.sendFormattedText(E,e,r.trim(),s,n,A),r="");try{p==="audio"?await E.audioWhatsapp({number:e.includes("@lid")?e:e.split("@")[0],delay:s?.delayMessage||1e3,audio:D,caption:I}):await E.mediaMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:s?.delayMessage||1e3,mediatype:p,media:D,caption:I,fileName:p==="document"?I||"document":void 0},null,!1)}catch(a){this.logger.error(`Error sending media: ${a}`),r+=`${I}: ${D}`}}else r+=P;o=t.lastIndex}if(o<T.length){let P=T.slice(o);P.trim()&&(r+=P)}r.trim()&&await this.sendFormattedText(E,e,r.trim(),s,n,A)}splitMessageByDoubleLineBreaks(E){return E.split(`

`).filter(e=>e.trim().length>0)}async sendSingleMessage(E,e,T,s,A=!0){let t=s?.timePerChar??0,_=Math.min(Math.max(T.length*t,1e3),2e4);this.logger.debug(`[BaseChatbot] Sending single message with linkPreview: ${A}`),E.integration===u.WHATSAPP_BAILEYS&&(await E.client.presenceSubscribe(e),await E.client.sendPresenceUpdate("composing",e)),await new Promise(n=>{setTimeout(async()=>{await E.textMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:s?.delayMessage||1e3,text:T,linkPreview:A},!1),n()},_)}),E.integration===u.WHATSAPP_BAILEYS&&await E.client.sendPresenceUpdate("paused",e)}async sendFormattedText(E,e,T,s,A,t=!0){if(A){let r=this.splitMessageByDoubleLineBreaks(T);this.logger.debug(`[BaseChatbot] Splitting message into ${r.length} parts`);for(let o=0;o<r.length;o++){let _=r[o];this.logger.debug(`[BaseChatbot] Sending message part ${o+1}/${r.length}`),await this.sendSingleMessage(E,e,_,s,t)}this.logger.debug("[BaseChatbot] All message parts sent successfully")}else this.logger.debug("[BaseChatbot] Sending single message"),await this.sendSingleMessage(E,e,T,s,t)}async initNewSession(E,e,T,s,A,t,r,o){if(!A){let _=typeof r=="object"&&r?.pushName?r.pushName:typeof r=="string"?r:null,n=await this.createNewSession({instanceName:E.instanceName,instanceId:E.instanceId},{remoteJid:e,pushName:_,botId:T.id},this.getBotType());if(!n||!n.session){this.logger.error("Failed to create new session");return}A=n.session}await this.prismaRepository.integrationSession.update({where:{id:A.id},data:{status:"opened",awaitUser:!1}}),await this.sendMessageToBot(E,A,s,T,e,r||"",t,o)}};R(d,"BaseChatbotService");var V=d;var F=class F extends V{constructor(e,T,s,A){super(e,T,"EvoaiService",s);O(this,"openaiService");this.openaiService=A}getBotType(){return"evoai"}async sendMessageToBot(e,T,s,A,t,r,o,_){try{this.logger.debug(`[EvoAI] Sending message to bot with content: ${o}`);let n=o;if(this.isAudioMessage(o)&&_)try{this.logger.debug("[EvoAI] Downloading audio for Whisper transcription");let N=await this.openaiService.speechToText(_,e);N&&(n=`[audio] ${N}`)}catch(N){this.logger.error(`[EvoAI] Failed to transcribe audio: ${N}`)}let P=A.agentUrl;if(!P){this.logger.error("No EvoAI endpoint defined");return}let I=`req-${(0,h.v4)().substring(0,8)}`,D=t.split("@")[0]||(0,h.v4)(),p=[{type:"text",text:n}];if(this.isImageMessage(o)&&_){let N=o.split("|");p[0].text=N[2]||o;try{if(_.message.mediaUrl||_.message.base64){let c=_.message.base64||null;if(_.message.mediaUrl&&(0,J.isURL)(_.message.mediaUrl)){let L=await f.default.get(_.message.mediaUrl,{responseType:"arraybuffer"});c=Buffer.from(L.data).toString("base64")}c&&p.push({type:"file",file:{name:_.key.id+".jpeg",mimeType:"image/jpeg",bytes:c}})}else{let c=await(0,k.downloadMediaMessage)(_,"buffer",{}),L=Buffer.from(c).toString("base64"),q=N[2]||`${_.key?.id||"image"}.jpg`;p.push({type:"file",file:{name:q,mimeType:"image/jpeg",bytes:L}})}}catch(c){this.logger.error(`[EvoAI] Failed to process image: ${c}`)}}let U={jsonrpc:"2.0",id:I,method:"message/send",params:{contextId:T.sessionId,message:{role:"user",parts:p,messageId:D,metadata:{messageKey:_?.key}},metadata:{remoteJid:t,pushName:r,fromMe:_?.key?.fromMe,instanceName:e.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:e.token}}};this.logger.debug(`[EvoAI] Sending request to: ${P}`);let a=JSON.parse(JSON.stringify(U));a?.params?.message?.parts&&(a.params.message.parts=a.params.message.parts.map(N=>N.type==="file"&&N.file&&N.file.bytes?{...N,file:{...N.file,bytes:"[base64 omitted]"}}:N)),this.logger.debug(`[EvoAI] Payload: ${JSON.stringify(a)}`),e.integration===u.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(t),await e.client.sendPresenceUpdate("composing",t));let x=await f.default.post(P,U,{headers:{"x-api-key":A.apiKey,"Content-Type":"application/json"}});this.logger.debug(`[EvoAI] Response: ${JSON.stringify(x.data)}`),e.integration===u.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",t);let B,v=x?.data?.result;if(v?.artifacts&&Array.isArray(v.artifacts)&&v.artifacts.length>0){let N=v.artifacts[0];if(N?.parts&&Array.isArray(N.parts)){let c=N.parts.find(L=>L.type==="text"&&L.text);c&&(B=c.text)}}this.logger.debug(`[EvoAI] Extracted message to send: ${B}`),B&&await this.sendMessageWhatsApp(e,t,B,s,!0)}catch(n){this.logger.error(`[EvoAI] Error sending message: ${n?.response?.data?JSON.stringify(n.response.data):n}`);return}}};R(F,"EvoaiService");var b=F;0&&(module.exports={EvoaiService});
//# sourceMappingURL=evoai.service.js.map
{"version":3,"sources":["../../../../../../src/config/env.config.ts","../../../../../../src/config/logger.config.ts","../../../../../../src/api/integrations/chatbot/chatwoot/libs/postgres.client.ts","../../../../../../src/api/integrations/chatbot/chatwoot/utils/chatwoot-import-helper.ts","../../../../../../src/api/types/wa.types.ts","../../../../../../src/api/integrations/chatbot/chatwoot/services/chatwoot.service.ts","../../../../../../src/utils/i18n.ts","../../../../../../src/utils/sendTelemetry.ts"],"sourcesContent":["import { isBooleanString } from 'class-validator';\nimport dotenv from 'dotenv';\n\ndotenv.config();\n\nexport type HttpServer = {\n  NAME: string;\n  TYPE: 'http' | 'https';\n  PORT: number;\n  URL: string;\n  DISABLE_DOCS: boolean;\n  DISABLE_MANAGER: boolean;\n};\n\nexport type HttpMethods = 'POST' | 'GET' | 'PUT' | 'DELETE';\nexport type Cors = {\n  ORIGIN: string[];\n  METHODS: HttpMethods[];\n  CREDENTIALS: boolean;\n};\n\nexport type LogBaileys = 'fatal' | 'error' | 'warn' | 'info' | 'debug' | 'trace';\n\nexport type LogLevel = 'ERROR' | 'WARN' | 'DEBUG' | 'INFO' | 'LOG' | 'VERBOSE' | 'DARK' | 'WEBHOOKS' | 'WEBSOCKET';\n\nexport type Log = {\n  LEVEL: LogLevel[];\n  COLOR: boolean;\n  BAILEYS: LogBaileys;\n};\n\nexport type ProviderSession = {\n  ENABLED: boolean;\n  HOST: string;\n  PORT: string;\n  PREFIX: string;\n};\n\nexport type SaveData = {\n  INSTANCE: boolean;\n  HISTORIC: boolean;\n  NEW_MESSAGE: boolean;\n  MESSAGE_UPDATE: boolean;\n  CONTACTS: boolean;\n  CHATS: boolean;\n  LABELS: boolean;\n  IS_ON_WHATSAPP: boolean;\n  IS_ON_WHATSAPP_DAYS: number;\n};\n\nexport type DBConnection = {\n  URI: string;\n  CLIENT_NAME: string;\n};\nexport type Database = {\n  CONNECTION: DBConnection;\n  PROVIDER: string;\n  SAVE_DATA: SaveData;\n  DELETE_DATA: DeleteData;\n};\n\nexport type DeleteData = {\n  LOGICAL_MESSAGE_DELETE: boolean;\n};\nexport type EventsRabbitmq = {\n  APPLICATION_STARTUP: boolean;\n  INSTANCE_CREATE: boolean;\n  INSTANCE_DELETE: boolean;\n  QRCODE_UPDATED: boolean;\n  MESSAGES_SET: boolean;\n  MESSAGES_UPSERT: boolean;\n  MESSAGES_EDITED: boolean;\n  MESSAGES_UPDATE: boolean;\n  MESSAGES_DELETE: boolean;\n  SEND_MESSAGE: boolean;\n  SEND_MESSAGE_UPDATE: boolean;\n  CONTACTS_SET: boolean;\n  CONTACTS_UPDATE: boolean;\n  CONTACTS_UPSERT: boolean;\n  PRESENCE_UPDATE: boolean;\n  CHATS_SET: boolean;\n  CHATS_UPDATE: boolean;\n  CHATS_DELETE: boolean;\n  CHATS_UPSERT: boolean;\n  CONNECTION_UPDATE: boolean;\n  LABELS_EDIT: boolean;\n  LABELS_ASSOCIATION: boolean;\n  GROUPS_UPSERT: boolean;\n  GROUP_UPDATE: boolean;\n  GROUP_PARTICIPANTS_UPDATE: boolean;\n  CALL: boolean;\n  TYPEBOT_START: boolean;\n  TYPEBOT_CHANGE_STATUS: boolean;\n};\n\nexport type Rabbitmq = {\n  ENABLED: boolean;\n  URI: string;\n  FRAME_MAX: number;\n  EXCHANGE_NAME: string;\n  GLOBAL_ENABLED: boolean;\n  EVENTS: EventsRabbitmq;\n  PREFIX_KEY?: string;\n};\n\nexport type Nats = {\n  ENABLED: boolean;\n  URI: string;\n  EXCHANGE_NAME: string;\n  GLOBAL_ENABLED: boolean;\n  EVENTS: EventsRabbitmq;\n  PREFIX_KEY?: string;\n};\n\nexport type Sqs = {\n  ENABLED: boolean;\n  GLOBAL_ENABLED: boolean;\n  GLOBAL_FORCE_SINGLE_QUEUE: boolean;\n  GLOBAL_PREFIX_NAME: string;\n  ACCESS_KEY_ID: string;\n  SECRET_ACCESS_KEY: string;\n  ACCOUNT_ID: string;\n  REGION: string;\n  MAX_PAYLOAD_SIZE: number;\n  EVENTS: {\n    APPLICATION_STARTUP: boolean;\n    CALL: boolean;\n    CHATS_DELETE: boolean;\n    CHATS_SET: boolean;\n    CHATS_UPDATE: boolean;\n    CHATS_UPSERT: boolean;\n    CONNECTION_UPDATE: boolean;\n    CONTACTS_SET: boolean;\n    CONTACTS_UPDATE: boolean;\n    CONTACTS_UPSERT: boolean;\n    GROUP_PARTICIPANTS_UPDATE: boolean;\n    GROUPS_UPDATE: boolean;\n    GROUPS_UPSERT: boolean;\n    LABELS_ASSOCIATION: boolean;\n    LABELS_EDIT: boolean;\n    LOGOUT_INSTANCE: boolean;\n    MESSAGES_DELETE: boolean;\n    MESSAGES_EDITED: boolean;\n    MESSAGES_SET: boolean;\n    MESSAGES_UPDATE: boolean;\n    MESSAGES_UPSERT: boolean;\n    PRESENCE_UPDATE: boolean;\n    QRCODE_UPDATED: boolean;\n    REMOVE_INSTANCE: boolean;\n    SEND_MESSAGE: boolean;\n    TYPEBOT_CHANGE_STATUS: boolean;\n    TYPEBOT_START: boolean;\n  };\n};\n\nexport type Kafka = {\n  ENABLED: boolean;\n  CLIENT_ID: string;\n  BROKERS: string[];\n  CONNECTION_TIMEOUT: number;\n  REQUEST_TIMEOUT: number;\n  GLOBAL_ENABLED: boolean;\n  CONSUMER_GROUP_ID: string;\n  TOPIC_PREFIX: string;\n  NUM_PARTITIONS: number;\n  REPLICATION_FACTOR: number;\n  AUTO_CREATE_TOPICS: boolean;\n  EVENTS: EventsRabbitmq;\n  SASL?: {\n    ENABLED: boolean;\n    MECHANISM: string;\n    USERNAME: string;\n    PASSWORD: string;\n  };\n  SSL?: {\n    ENABLED: boolean;\n    REJECT_UNAUTHORIZED: boolean;\n    CA?: string;\n    KEY?: string;\n    CERT?: string;\n  };\n};\n\nexport type Websocket = {\n  ENABLED: boolean;\n  GLOBAL_EVENTS: boolean;\n  ALLOWED_HOSTS?: string;\n};\n\nexport type WaBusiness = {\n  TOKEN_WEBHOOK: string;\n  URL: string;\n  VERSION: string;\n  LANGUAGE: string;\n};\n\nexport type EventsWebhook = {\n  APPLICATION_STARTUP: boolean;\n  INSTANCE_CREATE: boolean;\n  INSTANCE_DELETE: boolean;\n  QRCODE_UPDATED: boolean;\n  MESSAGES_SET: boolean;\n  MESSAGES_UPSERT: boolean;\n  MESSAGES_EDITED: boolean;\n  MESSAGES_UPDATE: boolean;\n  MESSAGES_DELETE: boolean;\n  SEND_MESSAGE: boolean;\n  SEND_MESSAGE_UPDATE: boolean;\n  CONTACTS_SET: boolean;\n  CONTACTS_UPDATE: boolean;\n  CONTACTS_UPSERT: boolean;\n  PRESENCE_UPDATE: boolean;\n  CHATS_SET: boolean;\n  CHATS_UPDATE: boolean;\n  CHATS_DELETE: boolean;\n  CHATS_UPSERT: boolean;\n  CONNECTION_UPDATE: boolean;\n  LABELS_EDIT: boolean;\n  LABELS_ASSOCIATION: boolean;\n  GROUPS_UPSERT: boolean;\n  GROUP_UPDATE: boolean;\n  GROUP_PARTICIPANTS_UPDATE: boolean;\n  CALL: boolean;\n  TYPEBOT_START: boolean;\n  TYPEBOT_CHANGE_STATUS: boolean;\n  ERRORS: boolean;\n  ERRORS_WEBHOOK: string;\n};\n\nexport type EventsPusher = {\n  APPLICATION_STARTUP: boolean;\n  INSTANCE_CREATE: boolean;\n  INSTANCE_DELETE: boolean;\n  QRCODE_UPDATED: boolean;\n  MESSAGES_SET: boolean;\n  MESSAGES_UPSERT: boolean;\n  MESSAGES_EDITED: boolean;\n  MESSAGES_UPDATE: boolean;\n  MESSAGES_DELETE: boolean;\n  SEND_MESSAGE: boolean;\n  SEND_MESSAGE_UPDATE: boolean;\n  CONTACTS_SET: boolean;\n  CONTACTS_UPDATE: boolean;\n  CONTACTS_UPSERT: boolean;\n  PRESENCE_UPDATE: boolean;\n  CHATS_SET: boolean;\n  CHATS_UPDATE: boolean;\n  CHATS_DELETE: boolean;\n  CHATS_UPSERT: boolean;\n  CONNECTION_UPDATE: boolean;\n  LABELS_EDIT: boolean;\n  LABELS_ASSOCIATION: boolean;\n  GROUPS_UPSERT: boolean;\n  GROUP_UPDATE: boolean;\n  GROUP_PARTICIPANTS_UPDATE: boolean;\n  CALL: boolean;\n  TYPEBOT_START: boolean;\n  TYPEBOT_CHANGE_STATUS: boolean;\n};\n\nexport type ApiKey = { KEY: string };\n\nexport type Auth = {\n  API_KEY: ApiKey;\n  EXPOSE_IN_FETCH_INSTANCES: boolean;\n};\n\nexport type DelInstance = number | boolean;\n\nexport type Language = string | 'en';\n\nexport type GlobalWebhook = {\n  URL: string;\n  ENABLED: boolean;\n  WEBHOOK_BY_EVENTS: boolean;\n};\n\nexport type GlobalPusher = {\n  ENABLED: boolean;\n  APP_ID: string;\n  KEY: string;\n  SECRET: string;\n  CLUSTER: string;\n  USE_TLS: boolean;\n};\n\nexport type CacheConfRedis = {\n  ENABLED: boolean;\n  URI: string;\n  PREFIX_KEY: string;\n  TTL: number;\n  SAVE_INSTANCES: boolean;\n};\nexport type CacheConfLocal = {\n  ENABLED: boolean;\n  TTL: number;\n};\nexport type SslConf = { PRIVKEY: string; FULLCHAIN: string };\nexport type Webhook = {\n  GLOBAL?: GlobalWebhook;\n  EVENTS: EventsWebhook;\n  REQUEST?: {\n    TIMEOUT_MS?: number;\n  };\n  RETRY?: {\n    MAX_ATTEMPTS?: number;\n    INITIAL_DELAY_SECONDS?: number;\n    USE_EXPONENTIAL_BACKOFF?: boolean;\n    MAX_DELAY_SECONDS?: number;\n    JITTER_FACTOR?: number;\n    NON_RETRYABLE_STATUS_CODES?: number[];\n  };\n};\nexport type Pusher = { ENABLED: boolean; GLOBAL?: GlobalPusher; EVENTS: EventsPusher };\nexport type ConfigSessionPhone = { CLIENT: string; NAME: string };\nexport type QrCode = { LIMIT: number; COLOR: string };\nexport type Typebot = { ENABLED: boolean; API_VERSION: string; SEND_MEDIA_BASE64: boolean };\nexport type Chatwoot = {\n  ENABLED: boolean;\n  MESSAGE_DELETE: boolean;\n  MESSAGE_READ: boolean;\n  BOT_CONTACT: boolean;\n  IMPORT: {\n    DATABASE: {\n      CONNECTION: {\n        URI: string;\n      };\n    };\n    PLACEHOLDER_MEDIA_MESSAGE: boolean;\n  };\n};\nexport type Openai = { ENABLED: boolean; API_KEY_GLOBAL?: string };\nexport type Dify = { ENABLED: boolean };\nexport type N8n = { ENABLED: boolean };\nexport type Evoai = { ENABLED: boolean };\nexport type Flowise = { ENABLED: boolean };\n\nexport type S3 = {\n  ACCESS_KEY: string;\n  SECRET_KEY: string;\n  ENDPOINT: string;\n  BUCKET_NAME: string;\n  ENABLE: boolean;\n  PORT?: number;\n  USE_SSL?: boolean;\n  REGION?: string;\n  SKIP_POLICY?: boolean;\n  SAVE_VIDEO?: boolean;\n};\n\nexport type CacheConf = { REDIS: CacheConfRedis; LOCAL: CacheConfLocal };\nexport type Metrics = {\n  ENABLED: boolean;\n  AUTH_REQUIRED: boolean;\n  USER?: string;\n  PASSWORD?: string;\n  ALLOWED_IPS?: string;\n};\n\nexport type Telemetry = {\n  ENABLED: boolean;\n  URL?: string;\n};\n\nexport type Proxy = {\n  HOST?: string;\n  PORT?: string;\n  PROTOCOL?: string;\n  USERNAME?: string;\n  PASSWORD?: string;\n};\n\nexport type AudioConverter = {\n  API_URL?: string;\n  API_KEY?: string;\n};\n\nexport type Facebook = {\n  APP_ID?: string;\n  CONFIG_ID?: string;\n  USER_TOKEN?: string;\n};\n\nexport type Sentry = {\n  DSN?: string;\n};\n\nexport type EventEmitter = {\n  MAX_LISTENERS: number;\n};\n\nexport type Production = boolean;\n\nexport interface Env {\n  SERVER: HttpServer;\n  CORS: Cors;\n  SSL_CONF: SslConf;\n  PROVIDER: ProviderSession;\n  DATABASE: Database;\n  RABBITMQ: Rabbitmq;\n  NATS: Nats;\n  SQS: Sqs;\n  KAFKA: Kafka;\n  WEBSOCKET: Websocket;\n  WA_BUSINESS: WaBusiness;\n  LOG: Log;\n  DEL_INSTANCE: DelInstance;\n  DEL_TEMP_INSTANCES: boolean;\n  LANGUAGE: Language;\n  WEBHOOK: Webhook;\n  PUSHER: Pusher;\n  CONFIG_SESSION_PHONE: ConfigSessionPhone;\n  QRCODE: QrCode;\n  TYPEBOT: Typebot;\n  CHATWOOT: Chatwoot;\n  OPENAI: Openai;\n  DIFY: Dify;\n  N8N: N8n;\n  EVOAI: Evoai;\n  FLOWISE: Flowise;\n  CACHE: CacheConf;\n  S3?: S3;\n  AUTHENTICATION: Auth;\n  METRICS: Metrics;\n  TELEMETRY: Telemetry;\n  PROXY: Proxy;\n  AUDIO_CONVERTER: AudioConverter;\n  FACEBOOK: Facebook;\n  SENTRY: Sentry;\n  EVENT_EMITTER: EventEmitter;\n  PRODUCTION?: Production;\n}\n\nexport type Key = keyof Env;\n\nexport class ConfigService {\n  constructor() {\n    this.loadEnv();\n  }\n\n  private env: Env;\n\n  public get<T = any>(key: Key) {\n    return this.env[key] as T;\n  }\n\n  private loadEnv() {\n    this.env = this.envProcess();\n    this.env.PRODUCTION = process.env?.NODE_ENV === 'PROD';\n    if (process.env?.DOCKER_ENV === 'true') {\n      this.env.SERVER.TYPE = process.env.SERVER_TYPE as 'http' | 'http';\n      this.env.SERVER.PORT = Number.parseInt(process.env.SERVER_PORT) || 8080;\n    }\n  }\n\n  private envProcess(): Env {\n    return {\n      SERVER: {\n        NAME: process.env?.SERVER_NAME || 'evolution',\n        TYPE: (process.env.SERVER_TYPE as 'http' | 'https') || 'http',\n        PORT: Number.parseInt(process.env.SERVER_PORT) || 8080,\n        URL: process.env.SERVER_URL,\n        DISABLE_DOCS: process.env?.SERVER_DISABLE_DOCS === 'true',\n        DISABLE_MANAGER: process.env?.SERVER_DISABLE_MANAGER === 'true',\n      },\n      CORS: {\n        ORIGIN: process.env.CORS_ORIGIN?.split(',') || ['*'],\n        METHODS:\n          (process.env.CORS_METHODS?.split(',') as HttpMethods[]) ||\n          (['POST', 'GET', 'PUT', 'DELETE'] as HttpMethods[]),\n        CREDENTIALS: process.env?.CORS_CREDENTIALS === 'true',\n      },\n      SSL_CONF: {\n        PRIVKEY: process.env?.SSL_CONF_PRIVKEY || '',\n        FULLCHAIN: process.env?.SSL_CONF_FULLCHAIN || '',\n      },\n      PROVIDER: {\n        ENABLED: process.env?.PROVIDER_ENABLED === 'true',\n        HOST: process.env.PROVIDER_HOST,\n        PORT: process.env?.PROVIDER_PORT || '5656',\n        PREFIX: process.env?.PROVIDER_PREFIX || 'evolution',\n      },\n      DATABASE: {\n        CONNECTION: {\n          URI: process.env.DATABASE_CONNECTION_URI || '',\n          CLIENT_NAME: process.env.DATABASE_CONNECTION_CLIENT_NAME || 'evolution',\n        },\n        PROVIDER: process.env.DATABASE_PROVIDER || 'postgresql',\n        SAVE_DATA: {\n          INSTANCE: process.env?.DATABASE_SAVE_DATA_INSTANCE === 'true',\n          NEW_MESSAGE: process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE === 'true',\n          MESSAGE_UPDATE: process.env?.DATABASE_SAVE_MESSAGE_UPDATE === 'true',\n          CONTACTS: process.env?.DATABASE_SAVE_DATA_CONTACTS === 'true',\n          CHATS: process.env?.DATABASE_SAVE_DATA_CHATS === 'true',\n          HISTORIC: process.env?.DATABASE_SAVE_DATA_HISTORIC === 'true',\n          LABELS: process.env?.DATABASE_SAVE_DATA_LABELS === 'true',\n          IS_ON_WHATSAPP: process.env?.DATABASE_SAVE_IS_ON_WHATSAPP === 'true',\n          IS_ON_WHATSAPP_DAYS: Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS ?? '7'),\n        },\n        DELETE_DATA: {\n          LOGICAL_MESSAGE_DELETE: process.env?.DATABASE_DELETE_MESSAGE === 'true',\n        },\n      },\n      RABBITMQ: {\n        ENABLED: process.env?.RABBITMQ_ENABLED === 'true',\n        GLOBAL_ENABLED: process.env?.RABBITMQ_GLOBAL_ENABLED === 'true',\n        PREFIX_KEY: process.env?.RABBITMQ_PREFIX_KEY,\n        EXCHANGE_NAME: process.env?.RABBITMQ_EXCHANGE_NAME || 'evolution_exchange',\n        URI: process.env.RABBITMQ_URI || '',\n        FRAME_MAX: Number.parseInt(process.env.RABBITMQ_FRAME_MAX) || 8192,\n        EVENTS: {\n          APPLICATION_STARTUP: process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP === 'true',\n          INSTANCE_CREATE: process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE === 'true',\n          INSTANCE_DELETE: process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE === 'true',\n          QRCODE_UPDATED: process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED === 'true',\n          MESSAGES_SET: process.env?.RABBITMQ_EVENTS_MESSAGES_SET === 'true',\n          MESSAGES_UPSERT: process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT === 'true',\n          MESSAGES_EDITED: process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED === 'true',\n          MESSAGES_UPDATE: process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE === 'true',\n          MESSAGES_DELETE: process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE === 'true',\n          SEND_MESSAGE: process.env?.RABBITMQ_EVENTS_SEND_MESSAGE === 'true',\n          SEND_MESSAGE_UPDATE: process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE === 'true',\n          CONTACTS_SET: process.env?.RABBITMQ_EVENTS_CONTACTS_SET === 'true',\n          CONTACTS_UPDATE: process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE === 'true',\n          CONTACTS_UPSERT: process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT === 'true',\n          PRESENCE_UPDATE: process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE === 'true',\n          CHATS_SET: process.env?.RABBITMQ_EVENTS_CHATS_SET === 'true',\n          CHATS_UPDATE: process.env?.RABBITMQ_EVENTS_CHATS_UPDATE === 'true',\n          CHATS_UPSERT: process.env?.RABBITMQ_EVENTS_CHATS_UPSERT === 'true',\n          CHATS_DELETE: process.env?.RABBITMQ_EVENTS_CHATS_DELETE === 'true',\n          CONNECTION_UPDATE: process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE === 'true',\n          LABELS_EDIT: process.env?.RABBITMQ_EVENTS_LABELS_EDIT === 'true',\n          LABELS_ASSOCIATION: process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION === 'true',\n          GROUPS_UPSERT: process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT === 'true',\n          GROUP_UPDATE: process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE === 'true',\n          GROUP_PARTICIPANTS_UPDATE: process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE === 'true',\n          CALL: process.env?.RABBITMQ_EVENTS_CALL === 'true',\n          TYPEBOT_START: process.env?.RABBITMQ_EVENTS_TYPEBOT_START === 'true',\n          TYPEBOT_CHANGE_STATUS: process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS === 'true',\n        },\n      },\n      NATS: {\n        ENABLED: process.env?.NATS_ENABLED === 'true',\n        GLOBAL_ENABLED: process.env?.NATS_GLOBAL_ENABLED === 'true',\n        PREFIX_KEY: process.env?.NATS_PREFIX_KEY,\n        EXCHANGE_NAME: process.env?.NATS_EXCHANGE_NAME || 'evolution_exchange',\n        URI: process.env.NATS_URI || '',\n        EVENTS: {\n          APPLICATION_STARTUP: process.env?.NATS_EVENTS_APPLICATION_STARTUP === 'true',\n          INSTANCE_CREATE: process.env?.NATS_EVENTS_INSTANCE_CREATE === 'true',\n          INSTANCE_DELETE: process.env?.NATS_EVENTS_INSTANCE_DELETE === 'true',\n          QRCODE_UPDATED: process.env?.NATS_EVENTS_QRCODE_UPDATED === 'true',\n          MESSAGES_SET: process.env?.NATS_EVENTS_MESSAGES_SET === 'true',\n          MESSAGES_UPSERT: process.env?.NATS_EVENTS_MESSAGES_UPSERT === 'true',\n          MESSAGES_EDITED: process.env?.NATS_EVENTS_MESSAGES_EDITED === 'true',\n          MESSAGES_UPDATE: process.env?.NATS_EVENTS_MESSAGES_UPDATE === 'true',\n          MESSAGES_DELETE: process.env?.NATS_EVENTS_MESSAGES_DELETE === 'true',\n          SEND_MESSAGE: process.env?.NATS_EVENTS_SEND_MESSAGE === 'true',\n          SEND_MESSAGE_UPDATE: process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE === 'true',\n          CONTACTS_SET: process.env?.NATS_EVENTS_CONTACTS_SET === 'true',\n          CONTACTS_UPDATE: process.env?.NATS_EVENTS_CONTACTS_UPDATE === 'true',\n          CONTACTS_UPSERT: process.env?.NATS_EVENTS_CONTACTS_UPSERT === 'true',\n          PRESENCE_UPDATE: process.env?.NATS_EVENTS_PRESENCE_UPDATE === 'true',\n          CHATS_SET: process.env?.NATS_EVENTS_CHATS_SET === 'true',\n          CHATS_UPDATE: process.env?.NATS_EVENTS_CHATS_UPDATE === 'true',\n          CHATS_UPSERT: process.env?.NATS_EVENTS_CHATS_UPSERT === 'true',\n          CHATS_DELETE: process.env?.NATS_EVENTS_CHATS_DELETE === 'true',\n          CONNECTION_UPDATE: process.env?.NATS_EVENTS_CONNECTION_UPDATE === 'true',\n          LABELS_EDIT: process.env?.NATS_EVENTS_LABELS_EDIT === 'true',\n          LABELS_ASSOCIATION: process.env?.NATS_EVENTS_LABELS_ASSOCIATION === 'true',\n          GROUPS_UPSERT: process.env?.NATS_EVENTS_GROUPS_UPSERT === 'true',\n          GROUP_UPDATE: process.env?.NATS_EVENTS_GROUPS_UPDATE === 'true',\n          GROUP_PARTICIPANTS_UPDATE: process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE === 'true',\n          CALL: process.env?.NATS_EVENTS_CALL === 'true',\n          TYPEBOT_START: process.env?.NATS_EVENTS_TYPEBOT_START === 'true',\n          TYPEBOT_CHANGE_STATUS: process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS === 'true',\n        },\n      },\n      SQS: {\n        ENABLED: process.env?.SQS_ENABLED === 'true',\n        GLOBAL_ENABLED: process.env?.SQS_GLOBAL_ENABLED === 'true',\n        GLOBAL_FORCE_SINGLE_QUEUE: process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE === 'true',\n        GLOBAL_PREFIX_NAME: process.env?.SQS_GLOBAL_PREFIX_NAME || 'global',\n        ACCESS_KEY_ID: process.env.SQS_ACCESS_KEY_ID || '',\n        SECRET_ACCESS_KEY: process.env.SQS_SECRET_ACCESS_KEY || '',\n        ACCOUNT_ID: process.env.SQS_ACCOUNT_ID || '',\n        REGION: process.env.SQS_REGION || '',\n        MAX_PAYLOAD_SIZE: Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE ?? '1048576'),\n        EVENTS: {\n          APPLICATION_STARTUP: process.env?.SQS_GLOBAL_APPLICATION_STARTUP === 'true',\n          CALL: process.env?.SQS_GLOBAL_CALL === 'true',\n          CHATS_DELETE: process.env?.SQS_GLOBAL_CHATS_DELETE === 'true',\n          CHATS_SET: process.env?.SQS_GLOBAL_CHATS_SET === 'true',\n          CHATS_UPDATE: process.env?.SQS_GLOBAL_CHATS_UPDATE === 'true',\n          CHATS_UPSERT: process.env?.SQS_GLOBAL_CHATS_UPSERT === 'true',\n          CONNECTION_UPDATE: process.env?.SQS_GLOBAL_CONNECTION_UPDATE === 'true',\n          CONTACTS_SET: process.env?.SQS_GLOBAL_CONTACTS_SET === 'true',\n          CONTACTS_UPDATE: process.env?.SQS_GLOBAL_CONTACTS_UPDATE === 'true',\n          CONTACTS_UPSERT: process.env?.SQS_GLOBAL_CONTACTS_UPSERT === 'true',\n          GROUP_PARTICIPANTS_UPDATE: process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE === 'true',\n          GROUPS_UPDATE: process.env?.SQS_GLOBAL_GROUPS_UPDATE === 'true',\n          GROUPS_UPSERT: process.env?.SQS_GLOBAL_GROUPS_UPSERT === 'true',\n          LABELS_ASSOCIATION: process.env?.SQS_GLOBAL_LABELS_ASSOCIATION === 'true',\n          LABELS_EDIT: process.env?.SQS_GLOBAL_LABELS_EDIT === 'true',\n          LOGOUT_INSTANCE: process.env?.SQS_GLOBAL_LOGOUT_INSTANCE === 'true',\n          MESSAGES_DELETE: process.env?.SQS_GLOBAL_MESSAGES_DELETE === 'true',\n          MESSAGES_EDITED: process.env?.SQS_GLOBAL_MESSAGES_EDITED === 'true',\n          MESSAGES_SET: process.env?.SQS_GLOBAL_MESSAGES_SET === 'true',\n          MESSAGES_UPDATE: process.env?.SQS_GLOBAL_MESSAGES_UPDATE === 'true',\n          MESSAGES_UPSERT: process.env?.SQS_GLOBAL_MESSAGES_UPSERT === 'true',\n          PRESENCE_UPDATE: process.env?.SQS_GLOBAL_PRESENCE_UPDATE === 'true',\n          QRCODE_UPDATED: process.env?.SQS_GLOBAL_QRCODE_UPDATED === 'true',\n          REMOVE_INSTANCE: process.env?.SQS_GLOBAL_REMOVE_INSTANCE === 'true',\n          SEND_MESSAGE: process.env?.SQS_GLOBAL_SEND_MESSAGE === 'true',\n          TYPEBOT_CHANGE_STATUS: process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS === 'true',\n          TYPEBOT_START: process.env?.SQS_GLOBAL_TYPEBOT_START === 'true',\n        },\n      },\n      KAFKA: {\n        ENABLED: process.env?.KAFKA_ENABLED === 'true',\n        CLIENT_ID: process.env?.KAFKA_CLIENT_ID || 'evolution-api',\n        BROKERS: process.env?.KAFKA_BROKERS?.split(',') || ['localhost:9092'],\n        CONNECTION_TIMEOUT: Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT || '3000'),\n        REQUEST_TIMEOUT: Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT || '30000'),\n        GLOBAL_ENABLED: process.env?.KAFKA_GLOBAL_ENABLED === 'true',\n        CONSUMER_GROUP_ID: process.env?.KAFKA_CONSUMER_GROUP_ID || 'evolution-api-consumers',\n        TOPIC_PREFIX: process.env?.KAFKA_TOPIC_PREFIX || 'evolution',\n        NUM_PARTITIONS: Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS || '1'),\n        REPLICATION_FACTOR: Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR || '1'),\n        AUTO_CREATE_TOPICS: process.env?.KAFKA_AUTO_CREATE_TOPICS === 'true',\n        EVENTS: {\n          APPLICATION_STARTUP: process.env?.KAFKA_EVENTS_APPLICATION_STARTUP === 'true',\n          INSTANCE_CREATE: process.env?.KAFKA_EVENTS_INSTANCE_CREATE === 'true',\n          INSTANCE_DELETE: process.env?.KAFKA_EVENTS_INSTANCE_DELETE === 'true',\n          QRCODE_UPDATED: process.env?.KAFKA_EVENTS_QRCODE_UPDATED === 'true',\n          MESSAGES_SET: process.env?.KAFKA_EVENTS_MESSAGES_SET === 'true',\n          MESSAGES_UPSERT: process.env?.KAFKA_EVENTS_MESSAGES_UPSERT === 'true',\n          MESSAGES_EDITED: process.env?.KAFKA_EVENTS_MESSAGES_EDITED === 'true',\n          MESSAGES_UPDATE: process.env?.KAFKA_EVENTS_MESSAGES_UPDATE === 'true',\n          MESSAGES_DELETE: process.env?.KAFKA_EVENTS_MESSAGES_DELETE === 'true',\n          SEND_MESSAGE: process.env?.KAFKA_EVENTS_SEND_MESSAGE === 'true',\n          SEND_MESSAGE_UPDATE: process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE === 'true',\n          CONTACTS_SET: process.env?.KAFKA_EVENTS_CONTACTS_SET === 'true',\n          CONTACTS_UPSERT: process.env?.KAFKA_EVENTS_CONTACTS_UPSERT === 'true',\n          CONTACTS_UPDATE: process.env?.KAFKA_EVENTS_CONTACTS_UPDATE === 'true',\n          PRESENCE_UPDATE: process.env?.KAFKA_EVENTS_PRESENCE_UPDATE === 'true',\n          CHATS_SET: process.env?.KAFKA_EVENTS_CHATS_SET === 'true',\n          CHATS_UPSERT: process.env?.KAFKA_EVENTS_CHATS_UPSERT === 'true',\n          CHATS_UPDATE: process.env?.KAFKA_EVENTS_CHATS_UPDATE === 'true',\n          CHATS_DELETE: process.env?.KAFKA_EVENTS_CHATS_DELETE === 'true',\n          CONNECTION_UPDATE: process.env?.KAFKA_EVENTS_CONNECTION_UPDATE === 'true',\n          LABELS_EDIT: process.env?.KAFKA_EVENTS_LABELS_EDIT === 'true',\n          LABELS_ASSOCIATION: process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION === 'true',\n          GROUPS_UPSERT: process.env?.KAFKA_EVENTS_GROUPS_UPSERT === 'true',\n          GROUP_UPDATE: process.env?.KAFKA_EVENTS_GROUPS_UPDATE === 'true',\n          GROUP_PARTICIPANTS_UPDATE: process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE === 'true',\n          CALL: process.env?.KAFKA_EVENTS_CALL === 'true',\n          TYPEBOT_START: process.env?.KAFKA_EVENTS_TYPEBOT_START === 'true',\n          TYPEBOT_CHANGE_STATUS: process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS === 'true',\n        },\n        SASL:\n          process.env?.KAFKA_SASL_ENABLED === 'true'\n            ? {\n                ENABLED: true,\n                MECHANISM: process.env?.KAFKA_SASL_MECHANISM || 'plain',\n                USERNAME: process.env?.KAFKA_SASL_USERNAME || '',\n                PASSWORD: process.env?.KAFKA_SASL_PASSWORD || '',\n              }\n            : undefined,\n        SSL:\n          process.env?.KAFKA_SSL_ENABLED === 'true'\n            ? {\n                ENABLED: true,\n                REJECT_UNAUTHORIZED: process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED !== 'false',\n                CA: process.env?.KAFKA_SSL_CA,\n                KEY: process.env?.KAFKA_SSL_KEY,\n                CERT: process.env?.KAFKA_SSL_CERT,\n              }\n            : undefined,\n      },\n      WEBSOCKET: {\n        ENABLED: process.env?.WEBSOCKET_ENABLED === 'true',\n        GLOBAL_EVENTS: process.env?.WEBSOCKET_GLOBAL_EVENTS === 'true',\n        ALLOWED_HOSTS: process.env?.WEBSOCKET_ALLOWED_HOSTS,\n      },\n      PUSHER: {\n        ENABLED: process.env?.PUSHER_ENABLED === 'true',\n        GLOBAL: {\n          ENABLED: process.env?.PUSHER_GLOBAL_ENABLED === 'true',\n          APP_ID: process.env?.PUSHER_GLOBAL_APP_ID || '',\n          KEY: process.env?.PUSHER_GLOBAL_KEY || '',\n          SECRET: process.env?.PUSHER_GLOBAL_SECRET || '',\n          CLUSTER: process.env?.PUSHER_GLOBAL_CLUSTER || '',\n          USE_TLS: process.env?.PUSHER_GLOBAL_USE_TLS === 'true',\n        },\n        EVENTS: {\n          APPLICATION_STARTUP: process.env?.PUSHER_EVENTS_APPLICATION_STARTUP === 'true',\n          INSTANCE_CREATE: process.env?.PUSHER_EVENTS_INSTANCE_CREATE === 'true',\n          INSTANCE_DELETE: process.env?.PUSHER_EVENTS_INSTANCE_DELETE === 'true',\n          QRCODE_UPDATED: process.env?.PUSHER_EVENTS_QRCODE_UPDATED === 'true',\n          MESSAGES_SET: process.env?.PUSHER_EVENTS_MESSAGES_SET === 'true',\n          MESSAGES_UPSERT: process.env?.PUSHER_EVENTS_MESSAGES_UPSERT === 'true',\n          MESSAGES_EDITED: process.env?.PUSHER_EVENTS_MESSAGES_EDITED === 'true',\n          MESSAGES_UPDATE: process.env?.PUSHER_EVENTS_MESSAGES_UPDATE === 'true',\n          MESSAGES_DELETE: process.env?.PUSHER_EVENTS_MESSAGES_DELETE === 'true',\n          SEND_MESSAGE: process.env?.PUSHER_EVENTS_SEND_MESSAGE === 'true',\n          SEND_MESSAGE_UPDATE: process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE === 'true',\n          CONTACTS_SET: process.env?.PUSHER_EVENTS_CONTACTS_SET === 'true',\n          CONTACTS_UPDATE: process.env?.PUSHER_EVENTS_CONTACTS_UPDATE === 'true',\n          CONTACTS_UPSERT: process.env?.PUSHER_EVENTS_CONTACTS_UPSERT === 'true',\n          PRESENCE_UPDATE: process.env?.PUSHER_EVENTS_PRESENCE_UPDATE === 'true',\n          CHATS_SET: process.env?.PUSHER_EVENTS_CHATS_SET === 'true',\n          CHATS_UPDATE: process.env?.PUSHER_EVENTS_CHATS_UPDATE === 'true',\n          CHATS_UPSERT: process.env?.PUSHER_EVENTS_CHATS_UPSERT === 'true',\n          CHATS_DELETE: process.env?.PUSHER_EVENTS_CHATS_DELETE === 'true',\n          CONNECTION_UPDATE: process.env?.PUSHER_EVENTS_CONNECTION_UPDATE === 'true',\n          LABELS_EDIT: process.env?.PUSHER_EVENTS_LABELS_EDIT === 'true',\n          LABELS_ASSOCIATION: process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION === 'true',\n          GROUPS_UPSERT: process.env?.PUSHER_EVENTS_GROUPS_UPSERT === 'true',\n          GROUP_UPDATE: process.env?.PUSHER_EVENTS_GROUPS_UPDATE === 'true',\n          GROUP_PARTICIPANTS_UPDATE: process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE === 'true',\n          CALL: process.env?.PUSHER_EVENTS_CALL === 'true',\n          TYPEBOT_START: process.env?.PUSHER_EVENTS_TYPEBOT_START === 'true',\n          TYPEBOT_CHANGE_STATUS: process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS === 'true',\n        },\n      },\n      WA_BUSINESS: {\n        TOKEN_WEBHOOK: process.env.WA_BUSINESS_TOKEN_WEBHOOK || 'evolution',\n        URL: process.env.WA_BUSINESS_URL || 'https://graph.facebook.com',\n        VERSION: process.env.WA_BUSINESS_VERSION || 'v18.0',\n        LANGUAGE: process.env.WA_BUSINESS_LANGUAGE || 'en',\n      },\n      LOG: {\n        LEVEL:\n          (process.env?.LOG_LEVEL?.split(',') as LogLevel[]) ||\n          (['ERROR', 'WARN', 'DEBUG', 'INFO', 'LOG', 'VERBOSE', 'DARK', 'WEBHOOKS', 'WEBSOCKET'] as LogLevel[]),\n        COLOR: process.env?.LOG_COLOR === 'true',\n        BAILEYS: (process.env?.LOG_BAILEYS as LogBaileys) || 'error',\n      },\n      DEL_INSTANCE: isBooleanString(process.env?.DEL_INSTANCE)\n        ? process.env.DEL_INSTANCE === 'true'\n        : Number.parseInt(process.env.DEL_INSTANCE) || false,\n      DEL_TEMP_INSTANCES: isBooleanString(process.env?.DEL_TEMP_INSTANCES)\n        ? process.env.DEL_TEMP_INSTANCES === 'true'\n        : true,\n      LANGUAGE: process.env?.LANGUAGE || 'en',\n      WEBHOOK: {\n        GLOBAL: {\n          URL: process.env?.WEBHOOK_GLOBAL_URL || '',\n          ENABLED: process.env?.WEBHOOK_GLOBAL_ENABLED === 'true',\n          WEBHOOK_BY_EVENTS: process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS === 'true',\n        },\n        EVENTS: {\n          APPLICATION_STARTUP: process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP === 'true',\n          INSTANCE_CREATE: process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE === 'true',\n          INSTANCE_DELETE: process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE === 'true',\n          QRCODE_UPDATED: process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED === 'true',\n          MESSAGES_SET: process.env?.WEBHOOK_EVENTS_MESSAGES_SET === 'true',\n          MESSAGES_UPSERT: process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT === 'true',\n          MESSAGES_EDITED: process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED === 'true',\n          MESSAGES_UPDATE: process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE === 'true',\n          MESSAGES_DELETE: process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE === 'true',\n          SEND_MESSAGE: process.env?.WEBHOOK_EVENTS_SEND_MESSAGE === 'true',\n          SEND_MESSAGE_UPDATE: process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE === 'true',\n          CONTACTS_SET: process.env?.WEBHOOK_EVENTS_CONTACTS_SET === 'true',\n          CONTACTS_UPDATE: process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE === 'true',\n          CONTACTS_UPSERT: process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT === 'true',\n          PRESENCE_UPDATE: process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE === 'true',\n          CHATS_SET: process.env?.WEBHOOK_EVENTS_CHATS_SET === 'true',\n          CHATS_UPDATE: process.env?.WEBHOOK_EVENTS_CHATS_UPDATE === 'true',\n          CHATS_UPSERT: process.env?.WEBHOOK_EVENTS_CHATS_UPSERT === 'true',\n          CHATS_DELETE: process.env?.WEBHOOK_EVENTS_CHATS_DELETE === 'true',\n          CONNECTION_UPDATE: process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE === 'true',\n          LABELS_EDIT: process.env?.WEBHOOK_EVENTS_LABELS_EDIT === 'true',\n          LABELS_ASSOCIATION: process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION === 'true',\n          GROUPS_UPSERT: process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT === 'true',\n          GROUP_UPDATE: process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE === 'true',\n          GROUP_PARTICIPANTS_UPDATE: process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE === 'true',\n          CALL: process.env?.WEBHOOK_EVENTS_CALL === 'true',\n          TYPEBOT_START: process.env?.WEBHOOK_EVENTS_TYPEBOT_START === 'true',\n          TYPEBOT_CHANGE_STATUS: process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS === 'true',\n          ERRORS: process.env?.WEBHOOK_EVENTS_ERRORS === 'true',\n          ERRORS_WEBHOOK: process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK || '',\n        },\n        REQUEST: {\n          TIMEOUT_MS: Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS) || 30000,\n        },\n        RETRY: {\n          MAX_ATTEMPTS: Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS) || 10,\n          INITIAL_DELAY_SECONDS: Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS) || 5,\n          USE_EXPONENTIAL_BACKOFF: process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF !== 'false',\n          MAX_DELAY_SECONDS: Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS) || 300,\n          JITTER_FACTOR: Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR) || 0.2,\n          NON_RETRYABLE_STATUS_CODES: process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(',').map(Number) || [\n            400, 401, 403, 404, 422,\n          ],\n        },\n      },\n      CONFIG_SESSION_PHONE: {\n        CLIENT: process.env?.CONFIG_SESSION_PHONE_CLIENT || 'Evolution API',\n        NAME: process.env?.CONFIG_SESSION_PHONE_NAME || 'Chrome',\n      },\n      QRCODE: {\n        LIMIT: Number.parseInt(process.env.QRCODE_LIMIT) || 30,\n        COLOR: process.env.QRCODE_COLOR || '#198754',\n      },\n      TYPEBOT: {\n        ENABLED: process.env?.TYPEBOT_ENABLED === 'true',\n        API_VERSION: process.env?.TYPEBOT_API_VERSION || 'old',\n        SEND_MEDIA_BASE64: process.env?.TYPEBOT_SEND_MEDIA_BASE64 === 'true',\n      },\n      CHATWOOT: {\n        ENABLED: process.env?.CHATWOOT_ENABLED === 'true',\n        MESSAGE_DELETE: process.env.CHATWOOT_MESSAGE_DELETE === 'true',\n        MESSAGE_READ: process.env.CHATWOOT_MESSAGE_READ === 'true',\n        BOT_CONTACT: !process.env.CHATWOOT_BOT_CONTACT || process.env.CHATWOOT_BOT_CONTACT === 'true',\n        IMPORT: {\n          DATABASE: {\n            CONNECTION: {\n              URI: process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI || '',\n            },\n          },\n          PLACEHOLDER_MEDIA_MESSAGE: process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE === 'true',\n        },\n      },\n      OPENAI: {\n        ENABLED: process.env?.OPENAI_ENABLED === 'true',\n        API_KEY_GLOBAL: process.env?.OPENAI_API_KEY_GLOBAL || null,\n      },\n      DIFY: {\n        ENABLED: process.env?.DIFY_ENABLED === 'true',\n      },\n      N8N: {\n        ENABLED: process.env?.N8N_ENABLED === 'true',\n      },\n      EVOAI: {\n        ENABLED: process.env?.EVOAI_ENABLED === 'true',\n      },\n      FLOWISE: {\n        ENABLED: process.env?.FLOWISE_ENABLED === 'true',\n      },\n      CACHE: {\n        REDIS: {\n          ENABLED: process.env?.CACHE_REDIS_ENABLED === 'true',\n          URI: process.env?.CACHE_REDIS_URI || '',\n          PREFIX_KEY: process.env?.CACHE_REDIS_PREFIX_KEY || 'evolution-cache',\n          TTL: Number.parseInt(process.env?.CACHE_REDIS_TTL) || 604800,\n          SAVE_INSTANCES: process.env?.CACHE_REDIS_SAVE_INSTANCES === 'true',\n        },\n        LOCAL: {\n          ENABLED: process.env?.CACHE_LOCAL_ENABLED === 'true',\n          TTL: Number.parseInt(process.env?.CACHE_REDIS_TTL) || 86400,\n        },\n      },\n      S3: {\n        ACCESS_KEY: process.env?.S3_ACCESS_KEY,\n        SECRET_KEY: process.env?.S3_SECRET_KEY,\n        ENDPOINT: process.env?.S3_ENDPOINT,\n        BUCKET_NAME: process.env?.S3_BUCKET,\n        ENABLE: process.env?.S3_ENABLED === 'true',\n        PORT: Number.parseInt(process.env?.S3_PORT || '9000'),\n        USE_SSL: process.env?.S3_USE_SSL === 'true',\n        REGION: process.env?.S3_REGION,\n        SKIP_POLICY: process.env?.S3_SKIP_POLICY === 'true',\n        SAVE_VIDEO: process.env?.S3_SAVE_VIDEO === 'true',\n      },\n      AUTHENTICATION: {\n        API_KEY: {\n          KEY: process.env.AUTHENTICATION_API_KEY || 'BQYHJGJHJ',\n        },\n        EXPOSE_IN_FETCH_INSTANCES: process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES === 'true',\n      },\n      METRICS: {\n        ENABLED: process.env?.PROMETHEUS_METRICS === 'true',\n        AUTH_REQUIRED: process.env?.METRICS_AUTH_REQUIRED === 'true',\n        USER: process.env?.METRICS_USER,\n        PASSWORD: process.env?.METRICS_PASSWORD,\n        ALLOWED_IPS: process.env?.METRICS_ALLOWED_IPS,\n      },\n      TELEMETRY: {\n        ENABLED: process.env?.TELEMETRY_ENABLED === undefined || process.env?.TELEMETRY_ENABLED === 'true',\n        URL: process.env?.TELEMETRY_URL,\n      },\n      PROXY: {\n        HOST: process.env?.PROXY_HOST,\n        PORT: process.env?.PROXY_PORT,\n        PROTOCOL: process.env?.PROXY_PROTOCOL,\n        USERNAME: process.env?.PROXY_USERNAME,\n        PASSWORD: process.env?.PROXY_PASSWORD,\n      },\n      AUDIO_CONVERTER: {\n        API_URL: process.env?.API_AUDIO_CONVERTER,\n        API_KEY: process.env?.API_AUDIO_CONVERTER_KEY,\n      },\n      FACEBOOK: {\n        APP_ID: process.env?.FACEBOOK_APP_ID,\n        CONFIG_ID: process.env?.FACEBOOK_CONFIG_ID,\n        USER_TOKEN: process.env?.FACEBOOK_USER_TOKEN,\n      },\n      SENTRY: {\n        DSN: process.env?.SENTRY_DSN,\n      },\n      EVENT_EMITTER: {\n        MAX_LISTENERS: Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS) || 50,\n      },\n    };\n  }\n}\n\nexport const configService = new ConfigService();\n","import dayjs from 'dayjs';\nimport fs from 'fs';\n\nimport { configService, Log } from './env.config';\nconst packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));\n\nconst formatDateLog = (timestamp: number) =>\n  dayjs(timestamp)\n    .toDate()\n    .toString()\n    .replace(/\\sGMT.+/, '');\n\nenum Color {\n  LOG = '\\x1b[32m',\n  INFO = '\\x1b[34m',\n  WARN = '\\x1b[33m',\n  ERROR = '\\x1b[31m',\n  DEBUG = '\\x1b[36m',\n  VERBOSE = '\\x1b[37m',\n  DARK = '\\x1b[30m',\n}\n\nenum Command {\n  RESET = '\\x1b[0m',\n  BRIGHT = '\\x1b[1m',\n  UNDERSCORE = '\\x1b[4m',\n}\n\nenum Level {\n  LOG = Color.LOG + '%s' + Command.RESET,\n  DARK = Color.DARK + '%s' + Command.RESET,\n  INFO = Color.INFO + '%s' + Command.RESET,\n  WARN = Color.WARN + '%s' + Command.RESET,\n  ERROR = Color.ERROR + '%s' + Command.RESET,\n  DEBUG = Color.DEBUG + '%s' + Command.RESET,\n  VERBOSE = Color.VERBOSE + '%s' + Command.RESET,\n}\n\nenum Type {\n  LOG = 'LOG',\n  WARN = 'WARN',\n  INFO = 'INFO',\n  DARK = 'DARK',\n  ERROR = 'ERROR',\n  DEBUG = 'DEBUG',\n  VERBOSE = 'VERBOSE',\n}\n\nenum Background {\n  LOG = '\\x1b[42m',\n  INFO = '\\x1b[44m',\n  WARN = '\\x1b[43m',\n  DARK = '\\x1b[40m',\n  ERROR = '\\x1b[41m',\n  DEBUG = '\\x1b[46m',\n  VERBOSE = '\\x1b[47m',\n}\n\nexport class Logger {\n  private readonly configService = configService;\n  private context: string;\n\n  constructor(context = 'Logger') {\n    this.context = context;\n  }\n\n  private instance = null;\n\n  public setContext(value: string) {\n    this.context = value;\n  }\n\n  public setInstance(value: string) {\n    this.instance = value;\n  }\n\n  private console(value: any, type: Type) {\n    const types: Type[] = [];\n\n    this.configService.get<Log>('LOG').LEVEL.forEach((level) => types.push(Type[level]));\n\n    const typeValue = typeof value;\n    if (types.includes(type)) {\n      if (configService.get<Log>('LOG').COLOR) {\n        console.log(\n          /*Command.UNDERSCORE +*/ Command.BRIGHT + Level[type],\n          '[Evolution API]',\n          Command.BRIGHT + Color[type],\n          this.instance ? `[${this.instance}]` : '',\n          Command.BRIGHT + Color[type],\n          `v${packageJson.version}`,\n          Command.BRIGHT + Color[type],\n          process.pid.toString(),\n          Command.RESET,\n          Command.BRIGHT + Color[type],\n          '-',\n          Command.BRIGHT + Color.VERBOSE,\n          `${formatDateLog(Date.now())}  `,\n          Command.RESET,\n          Color[type] + Background[type] + Command.BRIGHT,\n          `${type} ` + Command.RESET,\n          Color.WARN + Command.BRIGHT,\n          `[${this.context}]` + Command.RESET,\n          Color[type] + Command.BRIGHT,\n          `[${typeValue}]` + Command.RESET,\n          Color[type],\n          typeValue !== 'object' ? value : '',\n          Command.RESET,\n        );\n        typeValue === 'object' ? console.log(/*Level.DARK,*/ value, '\\n') : '';\n      } else {\n        console.log(\n          '[Evolution API]',\n          this.instance ? `[${this.instance}]` : '',\n          process.pid.toString(),\n          '-',\n          `${formatDateLog(Date.now())}  `,\n          `${type} `,\n          `[${this.context}]`,\n          `[${typeValue}]`,\n          value,\n        );\n      }\n    }\n  }\n\n  public log(value: any) {\n    this.console(value, Type.LOG);\n  }\n\n  public info(value: any) {\n    this.console(value, Type.INFO);\n  }\n\n  public warn(value: any) {\n    this.console(value, Type.WARN);\n  }\n\n  public error(value: any) {\n    this.console(value, Type.ERROR);\n  }\n\n  public verbose(value: any) {\n    this.console(value, Type.VERBOSE);\n  }\n\n  public debug(value: any) {\n    this.console(value, Type.DEBUG);\n  }\n\n  public dark(value: any) {\n    this.console(value, Type.DARK);\n  }\n}\n","import { Chatwoot, configService } from '@config/env.config';\nimport { Logger } from '@config/logger.config';\nimport postgresql from 'pg';\n\nconst { Pool } = postgresql;\n\nclass Postgres {\n  private logger = new Logger('Postgres');\n  private pool;\n  private connected = false;\n\n  getConnection(connectionString: string) {\n    if (this.connected) {\n      return this.pool;\n    } else {\n      this.pool = new Pool({\n        connectionString,\n        ssl: {\n          rejectUnauthorized: false,\n        },\n      });\n\n      this.pool.on('error', () => {\n        this.logger.error('postgres disconnected');\n        this.connected = false;\n      });\n\n      try {\n        this.connected = true;\n      } catch (e) {\n        this.connected = false;\n        this.logger.error('postgres connect exception caught: ' + e);\n        return null;\n      }\n\n      return this.pool;\n    }\n  }\n\n  getChatwootConnection() {\n    const uri = configService.get<Chatwoot>('CHATWOOT').IMPORT.DATABASE.CONNECTION.URI;\n\n    return this.getConnection(uri);\n  }\n}\n\nexport const postgresClient = new Postgres();\n","import { InstanceDto } from '@api/dto/instance.dto';\nimport { ChatwootDto } from '@api/integrations/chatbot/chatwoot/dto/chatwoot.dto';\nimport { postgresClient } from '@api/integrations/chatbot/chatwoot/libs/postgres.client';\nimport { ChatwootService } from '@api/integrations/chatbot/chatwoot/services/chatwoot.service';\nimport { Chatwoot, configService } from '@config/env.config';\nimport { Logger } from '@config/logger.config';\nimport { inbox } from '@figuro/chatwoot-sdk';\nimport { Chatwoot as ChatwootModel, Contact, Message } from '@prisma/client';\nimport { proto } from 'baileys';\n\ntype ChatwootUser = {\n  user_type: string;\n  user_id: number;\n};\n\ntype FksChatwoot = {\n  phone_number: string;\n  contact_id: string;\n  conversation_id: string;\n};\n\ntype firstLastTimestamp = {\n  first: number;\n  last: number;\n};\n\ntype IWebMessageInfo = Omit<proto.IWebMessageInfo, 'key'> & Partial<Pick<proto.IWebMessageInfo, 'key'>>;\n\nclass ChatwootImport {\n  private logger = new Logger('ChatwootImport');\n  private repositoryMessagesCache = new Map<string, Set<string>>();\n  private historyMessages = new Map<string, Message[]>();\n  private historyContacts = new Map<string, Contact[]>();\n\n  public getRepositoryMessagesCache(instance: InstanceDto) {\n    return this.repositoryMessagesCache.has(instance.instanceName)\n      ? this.repositoryMessagesCache.get(instance.instanceName)\n      : null;\n  }\n\n  public setRepositoryMessagesCache(instance: InstanceDto, repositoryMessagesCache: Set<string>) {\n    this.repositoryMessagesCache.set(instance.instanceName, repositoryMessagesCache);\n  }\n\n  public deleteRepositoryMessagesCache(instance: InstanceDto) {\n    this.repositoryMessagesCache.delete(instance.instanceName);\n  }\n\n  public addHistoryMessages(instance: InstanceDto, messagesRaw: Message[]) {\n    const actualValue = this.historyMessages.has(instance.instanceName)\n      ? this.historyMessages.get(instance.instanceName)\n      : [];\n    this.historyMessages.set(instance.instanceName, [...actualValue, ...messagesRaw]);\n  }\n\n  public addHistoryContacts(instance: InstanceDto, contactsRaw: Contact[]) {\n    const actualValue = this.historyContacts.has(instance.instanceName)\n      ? this.historyContacts.get(instance.instanceName)\n      : [];\n    this.historyContacts.set(instance.instanceName, actualValue.concat(contactsRaw));\n  }\n\n  public deleteHistoryMessages(instance: InstanceDto) {\n    this.historyMessages.delete(instance.instanceName);\n  }\n\n  public deleteHistoryContacts(instance: InstanceDto) {\n    this.historyContacts.delete(instance.instanceName);\n  }\n\n  public clearAll(instance: InstanceDto) {\n    this.deleteRepositoryMessagesCache(instance);\n    this.deleteHistoryMessages(instance);\n    this.deleteHistoryContacts(instance);\n  }\n\n  public getHistoryMessagesLenght(instance: InstanceDto) {\n    return this.historyMessages.get(instance.instanceName)?.length ?? 0;\n  }\n\n  public async importHistoryContacts(instance: InstanceDto, provider: ChatwootDto) {\n    try {\n      if (this.getHistoryMessagesLenght(instance) > 0) {\n        return;\n      }\n\n      const pgClient = postgresClient.getChatwootConnection();\n\n      let totalContactsImported = 0;\n\n      const contacts = this.historyContacts.get(instance.instanceName) || [];\n      if (contacts.length === 0) {\n        return 0;\n      }\n\n      let contactsChunk: Contact[] = this.sliceIntoChunks(contacts, 3000);\n      while (contactsChunk.length > 0) {\n        const labelSql = `SELECT id FROM labels WHERE title = '${provider.nameInbox}' AND account_id = ${provider.accountId} LIMIT 1`;\n\n        let labelId = (await pgClient.query(labelSql))?.rows[0]?.id;\n\n        if (!labelId) {\n          // creating label in chatwoot db and getting the id\n          const sqlLabel = `INSERT INTO labels (title, color, show_on_sidebar, account_id, created_at, updated_at) VALUES ('${provider.nameInbox}', '#34039B', true, ${provider.accountId}, NOW(), NOW()) RETURNING id`;\n\n          labelId = (await pgClient.query(sqlLabel))?.rows[0]?.id;\n        }\n\n        // inserting contacts in chatwoot db\n        let sqlInsert = `INSERT INTO contacts\n          (name, phone_number, account_id, identifier, created_at, updated_at) VALUES `;\n        const bindInsert = [provider.accountId];\n\n        for (const contact of contactsChunk) {\n          const isGroup = this.isIgnorePhoneNumber(contact.remoteJid);\n\n          const contactName = isGroup ? `${contact.pushName} (GROUP)` : contact.pushName;\n          bindInsert.push(contactName);\n          const bindName = `$${bindInsert.length}`;\n\n          let bindPhoneNumber: string;\n          if (!isGroup) {\n            bindInsert.push(`+${contact.remoteJid.split('@')[0]}`);\n            bindPhoneNumber = `$${bindInsert.length}`;\n          } else {\n            bindPhoneNumber = 'NULL';\n          }\n          bindInsert.push(contact.remoteJid);\n          const bindIdentifier = `$${bindInsert.length}`;\n\n          sqlInsert += `(${bindName}, ${bindPhoneNumber}, $1, ${bindIdentifier}, NOW(), NOW()),`;\n        }\n        if (sqlInsert.slice(-1) === ',') {\n          sqlInsert = sqlInsert.slice(0, -1);\n        }\n        sqlInsert += ` ON CONFLICT (identifier, account_id)\n                       DO UPDATE SET\n                        name = EXCLUDED.name,\n                        phone_number = EXCLUDED.phone_number,\n                        updated_at = NOW()`;\n\n        totalContactsImported += (await pgClient.query(sqlInsert, bindInsert))?.rowCount ?? 0;\n\n        const sqlTags = `SELECT id FROM tags WHERE name = '${provider.nameInbox}' LIMIT 1`;\n\n        const tagData = (await pgClient.query(sqlTags))?.rows[0];\n        let tagId = tagData?.id;\n\n        const sqlTag = `INSERT INTO tags (name, taggings_count) VALUES ('${provider.nameInbox}', ${totalContactsImported}) ON CONFLICT (name) DO UPDATE SET taggings_count = tags.taggings_count + ${totalContactsImported} RETURNING id`;\n\n        tagId = (await pgClient.query(sqlTag))?.rows[0]?.id;\n\n        await pgClient.query(sqlTag);\n\n        let sqlInsertLabel = `INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) VALUES `;\n\n        contactsChunk.forEach((contact) => {\n          const bindTaggableId = `(SELECT id FROM contacts WHERE identifier = '${contact.remoteJid}' AND account_id = ${provider.accountId})`;\n          sqlInsertLabel += `($1, $2, ${bindTaggableId}, $3, NOW()),`;\n        });\n\n        if (sqlInsertLabel.slice(-1) === ',') {\n          sqlInsertLabel = sqlInsertLabel.slice(0, -1);\n        }\n\n        await pgClient.query(sqlInsertLabel, [tagId, 'Contact', 'labels']);\n\n        contactsChunk = this.sliceIntoChunks(contacts, 3000);\n      }\n\n      this.deleteHistoryContacts(instance);\n\n      return totalContactsImported;\n    } catch (error) {\n      this.logger.error(`Error on import history contacts: ${error.toString()}`);\n    }\n  }\n\n  public async getExistingSourceIds(sourceIds: string[], conversationId?: number): Promise<Set<string>> {\n    try {\n      const existingSourceIdsSet = new Set<string>();\n\n      if (sourceIds.length === 0) {\n        return existingSourceIdsSet;\n      }\n\n      // Ensure all sourceIds are consistently prefixed with 'WAID:' as required by downstream systems and database queries.\n      const formattedSourceIds = sourceIds.map((sourceId) => `WAID:${sourceId.replace('WAID:', '')}`);\n      const pgClient = postgresClient.getChatwootConnection();\n\n      const params = conversationId ? [formattedSourceIds, conversationId] : [formattedSourceIds];\n\n      const query = conversationId\n        ? 'SELECT source_id FROM messages WHERE source_id = ANY($1) AND conversation_id = $2'\n        : 'SELECT source_id FROM messages WHERE source_id = ANY($1)';\n\n      const result = await pgClient.query(query, params);\n      for (const row of result.rows) {\n        existingSourceIdsSet.add(row.source_id);\n      }\n\n      return existingSourceIdsSet;\n    } catch (error) {\n      this.logger.error(`Error on getExistingSourceIds: ${error.toString()}`);\n      return new Set<string>();\n    }\n  }\n\n  public async importHistoryMessages(\n    instance: InstanceDto,\n    chatwootService: ChatwootService,\n    inbox: inbox,\n    provider: ChatwootModel,\n  ) {\n    try {\n      const pgClient = postgresClient.getChatwootConnection();\n\n      const chatwootUser = await this.getChatwootUser(provider);\n      if (!chatwootUser) {\n        throw new Error('User not found to import messages.');\n      }\n\n      let totalMessagesImported = 0;\n\n      let messagesOrdered = this.historyMessages.get(instance.instanceName) || [];\n      if (messagesOrdered.length === 0) {\n        return 0;\n      }\n\n      // ordering messages by number and timestamp asc\n      messagesOrdered.sort((a, b) => {\n        const aKey = a.key as {\n          remoteJid: string;\n        };\n\n        const bKey = b.key as {\n          remoteJid: string;\n        };\n\n        const aMessageTimestamp = a.messageTimestamp as any as number;\n        const bMessageTimestamp = b.messageTimestamp as any as number;\n\n        return parseInt(aKey.remoteJid) - parseInt(bKey.remoteJid) || aMessageTimestamp - bMessageTimestamp;\n      });\n\n      const allMessagesMappedByPhoneNumber = this.createMessagesMapByPhoneNumber(messagesOrdered);\n      // Map structure: +552199999999 => { first message timestamp from number, last message timestamp from number}\n      const phoneNumbersWithTimestamp = new Map<string, firstLastTimestamp>();\n      allMessagesMappedByPhoneNumber.forEach((messages: Message[], phoneNumber: string) => {\n        phoneNumbersWithTimestamp.set(phoneNumber, {\n          first: messages[0]?.messageTimestamp as any as number,\n          last: messages[messages.length - 1]?.messageTimestamp as any as number,\n        });\n      });\n\n      const existingSourceIds = await this.getExistingSourceIds(messagesOrdered.map((message: any) => message.key.id));\n      messagesOrdered = messagesOrdered.filter((message: any) => !existingSourceIds.has(message.key.id));\n      // processing messages in batch\n      const batchSize = 4000;\n      let messagesChunk: Message[] = this.sliceIntoChunks(messagesOrdered, batchSize);\n      while (messagesChunk.length > 0) {\n        // Map structure: +552199999999 => Message[]\n        const messagesByPhoneNumber = this.createMessagesMapByPhoneNumber(messagesChunk);\n\n        if (messagesByPhoneNumber.size > 0) {\n          const fksByNumber = await this.selectOrCreateFksFromChatwoot(\n            provider,\n            inbox,\n            phoneNumbersWithTimestamp,\n            messagesByPhoneNumber,\n          );\n\n          // inserting messages in chatwoot db\n          let sqlInsertMsg = `INSERT INTO messages\n            (content, processed_message_content, account_id, inbox_id, conversation_id, message_type, private, content_type,\n            sender_type, sender_id, source_id, created_at, updated_at) VALUES `;\n          const bindInsertMsg = [provider.accountId, inbox.id];\n\n          messagesByPhoneNumber.forEach((messages: any[], phoneNumber: string) => {\n            const fksChatwoot = fksByNumber.get(phoneNumber);\n\n            messages.forEach((message) => {\n              if (!message.message) {\n                return;\n              }\n\n              if (!fksChatwoot?.conversation_id || !fksChatwoot?.contact_id) {\n                return;\n              }\n\n              const contentMessage = this.getContentMessage(chatwootService, message);\n              if (!contentMessage) {\n                return;\n              }\n\n              bindInsertMsg.push(contentMessage);\n              const bindContent = `$${bindInsertMsg.length}`;\n\n              bindInsertMsg.push(fksChatwoot.conversation_id);\n              const bindConversationId = `$${bindInsertMsg.length}`;\n\n              bindInsertMsg.push(message.key.fromMe ? '1' : '0');\n              const bindMessageType = `$${bindInsertMsg.length}`;\n\n              bindInsertMsg.push(message.key.fromMe ? chatwootUser.user_type : 'Contact');\n              const bindSenderType = `$${bindInsertMsg.length}`;\n\n              bindInsertMsg.push(message.key.fromMe ? chatwootUser.user_id : fksChatwoot.contact_id);\n              const bindSenderId = `$${bindInsertMsg.length}`;\n\n              bindInsertMsg.push('WAID:' + message.key.id);\n              const bindSourceId = `$${bindInsertMsg.length}`;\n\n              bindInsertMsg.push(message.messageTimestamp as number);\n              const bindmessageTimestamp = `$${bindInsertMsg.length}`;\n\n              sqlInsertMsg += `(${bindContent}, ${bindContent}, $1, $2, ${bindConversationId}, ${bindMessageType}, FALSE, 0,\n                  ${bindSenderType},${bindSenderId},${bindSourceId}, to_timestamp(${bindmessageTimestamp}), to_timestamp(${bindmessageTimestamp})),`;\n            });\n          });\n          if (bindInsertMsg.length > 2) {\n            if (sqlInsertMsg.slice(-1) === ',') {\n              sqlInsertMsg = sqlInsertMsg.slice(0, -1);\n            }\n            totalMessagesImported += (await pgClient.query(sqlInsertMsg, bindInsertMsg))?.rowCount ?? 0;\n          }\n        }\n        messagesChunk = this.sliceIntoChunks(messagesOrdered, batchSize);\n      }\n\n      this.deleteHistoryMessages(instance);\n      this.deleteRepositoryMessagesCache(instance);\n\n      const providerData: ChatwootDto = {\n        ...provider,\n        ignoreJids: Array.isArray(provider.ignoreJids) ? provider.ignoreJids.map((event) => String(event)) : [],\n      };\n\n      this.importHistoryContacts(instance, providerData);\n\n      return totalMessagesImported;\n    } catch (error) {\n      this.logger.error(`Error on import history messages: ${error.toString()}`);\n\n      this.deleteHistoryMessages(instance);\n      this.deleteRepositoryMessagesCache(instance);\n    }\n  }\n\n  public async selectOrCreateFksFromChatwoot(\n    provider: ChatwootModel,\n    inbox: inbox,\n    phoneNumbersWithTimestamp: Map<string, firstLastTimestamp>,\n    messagesByPhoneNumber: Map<string, Message[]>,\n  ): Promise<Map<string, FksChatwoot>> {\n    const pgClient = postgresClient.getChatwootConnection();\n\n    const bindValues = [provider.accountId, inbox.id];\n    const phoneNumberBind = Array.from(messagesByPhoneNumber.keys())\n      .map((phoneNumber) => {\n        const phoneNumberTimestamp = phoneNumbersWithTimestamp.get(phoneNumber);\n\n        if (phoneNumberTimestamp) {\n          bindValues.push(phoneNumber);\n          let bindStr = `($${bindValues.length},`;\n\n          bindValues.push(phoneNumberTimestamp.first);\n          bindStr += `$${bindValues.length},`;\n\n          bindValues.push(phoneNumberTimestamp.last);\n          return `${bindStr}$${bindValues.length})`;\n        }\n      })\n      .join(',');\n\n    // select (or insert when necessary) data from tables contacts, contact_inboxes, conversations from chatwoot db\n    const sqlFromChatwoot = `WITH\n              phone_number AS (\n                SELECT phone_number, created_at::INTEGER, last_activity_at::INTEGER FROM (\n                  VALUES \n                   ${phoneNumberBind}\n                 ) as t (phone_number, created_at, last_activity_at)\n              ),\n\n              only_new_phone_number AS (\n                SELECT * FROM phone_number\n                WHERE phone_number NOT IN (\n                  SELECT phone_number\n                  FROM contacts\n                    JOIN contact_inboxes ci ON ci.contact_id = contacts.id AND ci.inbox_id = $2\n                    JOIN conversations con ON con.contact_inbox_id = ci.id \n                      AND con.account_id = $1\n                      AND con.inbox_id = $2\n                      AND con.contact_id = contacts.id\n                  WHERE contacts.account_id = $1\n                )\n              ),\n\n              new_contact AS (\n                INSERT INTO contacts (name, phone_number, account_id, identifier, created_at, updated_at)\n                SELECT REPLACE(p.phone_number, '+', ''), p.phone_number, $1, CONCAT(REPLACE(p.phone_number, '+', ''),\n                  '@s.whatsapp.net'), to_timestamp(p.created_at), to_timestamp(p.last_activity_at)\n                FROM only_new_phone_number AS p\n                ON CONFLICT(identifier, account_id) DO UPDATE SET updated_at = EXCLUDED.updated_at\n                RETURNING id, phone_number, created_at, updated_at\n              ),\n\n              new_contact_inbox AS (\n                INSERT INTO contact_inboxes (contact_id, inbox_id, source_id, created_at, updated_at)\n                SELECT new_contact.id, $2, gen_random_uuid(), new_contact.created_at, new_contact.updated_at\n                FROM new_contact \n                RETURNING id, contact_id, created_at, updated_at\n              ),\n\n              new_conversation AS (\n                INSERT INTO conversations (account_id, inbox_id, status, contact_id,\n                  contact_inbox_id, uuid, last_activity_at, created_at, updated_at)\n                SELECT $1, $2, 0, new_contact_inbox.contact_id, new_contact_inbox.id, gen_random_uuid(),\n                  new_contact_inbox.updated_at, new_contact_inbox.created_at, new_contact_inbox.updated_at\n                FROM new_contact_inbox\n                RETURNING id, contact_id\n              )\n\n              SELECT new_contact.phone_number, new_conversation.contact_id, new_conversation.id AS conversation_id\n              FROM new_conversation \n              JOIN new_contact ON new_conversation.contact_id = new_contact.id\n\n              UNION\n\n              SELECT p.phone_number, c.id contact_id, con.id conversation_id\n                FROM phone_number p\n              JOIN contacts c ON c.phone_number = p.phone_number\n              JOIN contact_inboxes ci ON ci.contact_id = c.id AND ci.inbox_id = $2\n              JOIN conversations con ON con.contact_inbox_id = ci.id AND con.account_id = $1\n                AND con.inbox_id = $2 AND con.contact_id = c.id`;\n\n    const fksFromChatwoot = await pgClient.query(sqlFromChatwoot, bindValues);\n\n    return new Map(fksFromChatwoot.rows.map((item: FksChatwoot) => [item.phone_number, item]));\n  }\n\n  public async getChatwootUser(provider: ChatwootModel): Promise<ChatwootUser> {\n    try {\n      const pgClient = postgresClient.getChatwootConnection();\n\n      const sqlUser = `SELECT owner_type AS user_type, owner_id AS user_id\n                         FROM access_tokens\n                       WHERE token = $1`;\n\n      return (await pgClient.query(sqlUser, [provider.token]))?.rows[0] || false;\n    } catch (error) {\n      this.logger.error(`Error on getChatwootUser: ${error.toString()}`);\n    }\n  }\n\n  public createMessagesMapByPhoneNumber(messages: Message[]): Map<string, Message[]> {\n    return messages.reduce((acc: Map<string, Message[]>, message: Message) => {\n      const key = message?.key as {\n        remoteJid: string;\n      };\n      if (!this.isIgnorePhoneNumber(key?.remoteJid)) {\n        const phoneNumber = key?.remoteJid?.split('@')[0];\n        if (phoneNumber) {\n          const phoneNumberPlus = `+${phoneNumber}`;\n          const messages = acc.has(phoneNumberPlus) ? acc.get(phoneNumberPlus) : [];\n          messages.push(message);\n          acc.set(phoneNumberPlus, messages);\n        }\n      }\n\n      return acc;\n    }, new Map());\n  }\n\n  public async getContactsOrderByRecentConversations(\n    inbox: inbox,\n    provider: ChatwootModel,\n    limit = 50,\n  ): Promise<{ id: number; phone_number: string; identifier: string }[]> {\n    try {\n      const pgClient = postgresClient.getChatwootConnection();\n\n      const sql = `SELECT contacts.id, contacts.identifier, contacts.phone_number\n                     FROM conversations\n                   JOIN contacts ON contacts.id = conversations.contact_id\n                   WHERE conversations.account_id = $1\n                     AND inbox_id = $2\n                   ORDER BY conversations.last_activity_at DESC\n                   LIMIT $3`;\n\n      return (await pgClient.query(sql, [provider.accountId, inbox.id, limit]))?.rows;\n    } catch (error) {\n      this.logger.error(`Error on get recent conversations: ${error.toString()}`);\n    }\n  }\n\n  public getContentMessage(chatwootService: ChatwootService, msg: IWebMessageInfo) {\n    const contentMessage = chatwootService.getConversationMessage(msg.message);\n    if (contentMessage) {\n      return contentMessage;\n    }\n\n    if (!configService.get<Chatwoot>('CHATWOOT').IMPORT.PLACEHOLDER_MEDIA_MESSAGE) {\n      return '';\n    }\n\n    const types = {\n      documentMessage: msg.message.documentMessage,\n      documentWithCaptionMessage: msg.message.documentWithCaptionMessage?.message?.documentMessage,\n      imageMessage: msg.message.imageMessage,\n      videoMessage: msg.message.videoMessage,\n      audioMessage: msg.message.audioMessage,\n      stickerMessage: msg.message.stickerMessage,\n      templateMessage: msg.message.templateMessage?.hydratedTemplate?.hydratedContentText,\n    };\n\n    const typeKey = Object.keys(types).find((key) => types[key] !== undefined && types[key] !== null);\n    switch (typeKey) {\n      case 'documentMessage': {\n        const doc = msg.message.documentMessage;\n        const fileName = doc?.fileName || 'document';\n        const caption = doc?.caption ? ` ${doc.caption}` : '';\n        return `_<File: ${fileName}${caption}>_`;\n      }\n\n      case 'documentWithCaptionMessage': {\n        const doc = msg.message.documentWithCaptionMessage?.message?.documentMessage;\n        const fileName = doc?.fileName || 'document';\n        const caption = doc?.caption ? ` ${doc.caption}` : '';\n        return `_<File: ${fileName}${caption}>_`;\n      }\n\n      case 'templateMessage': {\n        const template = msg.message.templateMessage?.hydratedTemplate;\n        return (\n          (template?.hydratedTitleText ? `*${template.hydratedTitleText}*\\n` : '') +\n          (template?.hydratedContentText || '')\n        );\n      }\n\n      case 'imageMessage':\n        return '_<Image Message>_';\n\n      case 'videoMessage':\n        return '_<Video Message>_';\n\n      case 'audioMessage':\n        return '_<Audio Message>_';\n\n      case 'stickerMessage':\n        return '_<Sticker Message>_';\n\n      default:\n        return '';\n    }\n  }\n\n  public sliceIntoChunks(arr: any[], chunkSize: number) {\n    return arr.splice(0, chunkSize);\n  }\n\n  public isGroup(remoteJid: string) {\n    return remoteJid.includes('@g.us');\n  }\n\n  public isIgnorePhoneNumber(remoteJid: string) {\n    return this.isGroup(remoteJid) || remoteJid === 'status@broadcast' || remoteJid === '0@s.whatsapp.net';\n  }\n\n  public updateMessageSourceID(messageId: string | number, sourceId: string) {\n    const pgClient = postgresClient.getChatwootConnection();\n\n    const sql = `UPDATE messages SET source_id = $1, status = 0, created_at = NOW(), updated_at = NOW() WHERE id = $2;`;\n\n    return pgClient.query(sql, [`WAID:${sourceId}`, messageId]);\n  }\n}\n\nexport const chatwootImport = new ChatwootImport();\n","/* eslint-disable @typescript-eslint/no-namespace */\nimport { JsonValue } from '@prisma/client/runtime/library';\nimport { AuthenticationState, WAConnectionState } from 'baileys';\n\nexport enum Events {\n  APPLICATION_STARTUP = 'application.startup',\n  INSTANCE_CREATE = 'instance.create',\n  INSTANCE_DELETE = 'instance.delete',\n  QRCODE_UPDATED = 'qrcode.updated',\n  CONNECTION_UPDATE = 'connection.update',\n  STATUS_INSTANCE = 'status.instance',\n  MESSAGES_SET = 'messages.set',\n  MESSAGES_UPSERT = 'messages.upsert',\n  MESSAGES_EDITED = 'messages.edited',\n  MESSAGES_UPDATE = 'messages.update',\n  MESSAGES_DELETE = 'messages.delete',\n  SEND_MESSAGE = 'send.message',\n  SEND_MESSAGE_UPDATE = 'send.message.update',\n  CONTACTS_SET = 'contacts.set',\n  CONTACTS_UPSERT = 'contacts.upsert',\n  CONTACTS_UPDATE = 'contacts.update',\n  PRESENCE_UPDATE = 'presence.update',\n  CHATS_SET = 'chats.set',\n  CHATS_UPDATE = 'chats.update',\n  CHATS_UPSERT = 'chats.upsert',\n  CHATS_DELETE = 'chats.delete',\n  GROUPS_UPSERT = 'groups.upsert',\n  GROUPS_UPDATE = 'groups.update',\n  GROUP_PARTICIPANTS_UPDATE = 'group-participants.update',\n  CALL = 'call',\n  TYPEBOT_START = 'typebot.start',\n  TYPEBOT_CHANGE_STATUS = 'typebot.change-status',\n  LABELS_EDIT = 'labels.edit',\n  LABELS_ASSOCIATION = 'labels.association',\n  CREDS_UPDATE = 'creds.update',\n  MESSAGING_HISTORY_SET = 'messaging-history.set',\n  REMOVE_INSTANCE = 'remove.instance',\n  LOGOUT_INSTANCE = 'logout.instance',\n}\n\nexport declare namespace wa {\n  export type QrCode = {\n    count?: number;\n    pairingCode?: string;\n    base64?: string;\n    code?: string;\n  };\n\n  export type Instance = {\n    id?: string;\n    qrcode?: QrCode;\n    pairingCode?: string;\n    authState?: { state: AuthenticationState; saveCreds: () => void };\n    name?: string;\n    ownerJid?: string;\n    wuid?: string;\n    profileName?: string;\n    profilePictureUrl?: string;\n    token?: string;\n    number?: string;\n    integration?: string;\n    businessId?: string;\n  };\n\n  export type LocalChatwoot = {\n    enabled?: boolean;\n    accountId?: string;\n    token?: string;\n    url?: string;\n    nameInbox?: string;\n    signMsg?: boolean;\n    signDelimiter?: string;\n    number?: string;\n    reopenConversation?: boolean;\n    conversationPending?: boolean;\n    mergeBrazilContacts?: boolean;\n    importContacts?: boolean;\n    importMessages?: boolean;\n    daysLimitImportMessages?: number;\n  };\n\n  export type LocalSettings = {\n    rejectCall?: boolean;\n    msgCall?: string;\n    groupsIgnore?: boolean;\n    alwaysOnline?: boolean;\n    readMessages?: boolean;\n    readStatus?: boolean;\n    syncFullHistory?: boolean;\n    wavoipToken?: string;\n  };\n\n  export type LocalEvent = {\n    enabled?: boolean;\n    events?: JsonValue;\n  };\n\n  export type LocalWebHook = LocalEvent & {\n    url?: string;\n    headers?: JsonValue;\n    webhookByEvents?: boolean;\n    webhookBase64?: boolean;\n  };\n\n  export type LocalPusher = LocalEvent & {\n    appId?: string;\n    key?: string;\n    secret?: string;\n    cluster?: string;\n    useTLS?: boolean;\n  };\n\n  type Session = {\n    remoteJid?: string;\n    sessionId?: string;\n    createdAt?: number;\n  };\n\n  export type LocalProxy = {\n    enabled?: boolean;\n    host?: string;\n    port?: string;\n    protocol?: string;\n    username?: string;\n    password?: string;\n  };\n\n  export type StateConnection = {\n    instance?: string;\n    state?: WAConnectionState | 'refused';\n    statusReason?: number;\n  };\n\n  export type StatusMessage = 'ERROR' | 'PENDING' | 'SERVER_ACK' | 'DELIVERY_ACK' | 'READ' | 'DELETED' | 'PLAYED';\n}\n\nexport const TypeMediaMessage = [\n  'imageMessage',\n  'documentMessage',\n  'audioMessage',\n  'videoMessage',\n  'stickerMessage',\n  'ptvMessage',\n];\n\nexport const MessageSubtype = [\n  'ephemeralMessage',\n  'documentWithCaptionMessage',\n  'viewOnceMessage',\n  'viewOnceMessageV2',\n];\n\nexport const Integration = {\n  WHATSAPP_BUSINESS: 'WHATSAPP-BUSINESS',\n  WHATSAPP_BAILEYS: 'WHATSAPP-BAILEYS',\n  EVOLUTION: 'EVOLUTION',\n};\n","import { InstanceDto } from '@api/dto/instance.dto';\nimport { Options, Quoted, SendAudioDto, SendMediaDto, SendTextDto } from '@api/dto/sendMessage.dto';\nimport { ChatwootDto } from '@api/integrations/chatbot/chatwoot/dto/chatwoot.dto';\nimport { postgresClient } from '@api/integrations/chatbot/chatwoot/libs/postgres.client';\nimport { chatwootImport } from '@api/integrations/chatbot/chatwoot/utils/chatwoot-import-helper';\nimport { PrismaRepository } from '@api/repository/repository.service';\nimport { CacheService } from '@api/services/cache.service';\nimport { WAMonitoringService } from '@api/services/monitor.service';\nimport { Events } from '@api/types/wa.types';\nimport { Chatwoot, ConfigService, Database, HttpServer } from '@config/env.config';\nimport { Logger } from '@config/logger.config';\nimport ChatwootClient, {\n  ChatwootAPIConfig,\n  contact,\n  contact_inboxes,\n  conversation,\n  conversation_show,\n  generic_id,\n  inbox,\n} from '@figuro/chatwoot-sdk';\nimport { request as chatwootRequest } from '@figuro/chatwoot-sdk/dist/core/request';\nimport { Chatwoot as ChatwootModel, Contact as ContactModel, Message as MessageModel } from '@prisma/client';\nimport i18next from '@utils/i18n';\nimport { sendTelemetry } from '@utils/sendTelemetry';\nimport axios from 'axios';\nimport { WAMessageContent, WAMessageKey } from 'baileys';\nimport dayjs from 'dayjs';\nimport FormData from 'form-data';\nimport { Jimp, JimpMime } from 'jimp';\nimport { parsePhoneNumberFromString } from 'libphonenumber-js';\nimport Long from 'long';\nimport mimeTypes from 'mime-types';\nimport path from 'path';\nimport { Readable } from 'stream';\n\ninterface ChatwootMessage {\n  messageId?: number;\n  inboxId?: number;\n  conversationId?: number;\n  contactInboxSourceId?: string;\n  isRead?: boolean;\n}\n\nexport class ChatwootService {\n  private readonly logger = new Logger('ChatwootService');\n\n  // Lock polling delay\n  private readonly LOCK_POLLING_DELAY_MS = 300; // Delay between lock status checks\n\n  private provider: any;\n\n  constructor(\n    private readonly waMonitor: WAMonitoringService,\n    private readonly configService: ConfigService,\n    private readonly prismaRepository: PrismaRepository,\n    private readonly cache: CacheService,\n  ) {}\n\n  private pgClient = postgresClient.getChatwootConnection();\n\n  private async getProvider(instance: InstanceDto): Promise<ChatwootModel | null> {\n    const cacheKey = `${instance.instanceName}:getProvider`;\n    if (await this.cache.has(cacheKey)) {\n      const provider = (await this.cache.get(cacheKey)) as ChatwootModel;\n\n      return provider;\n    }\n\n    const provider = await this.waMonitor.waInstances[instance.instanceName]?.findChatwoot();\n\n    if (!provider) {\n      this.logger.warn('provider not found');\n      return null;\n    }\n\n    this.cache.set(cacheKey, provider);\n\n    return provider;\n  }\n\n  private async clientCw(instance: InstanceDto) {\n    const provider = await this.getProvider(instance);\n\n    if (!provider) {\n      this.logger.error('provider not found');\n      return null;\n    }\n\n    this.provider = provider;\n\n    const client = new ChatwootClient({\n      config: this.getClientCwConfig(),\n    });\n\n    return client;\n  }\n\n  public getClientCwConfig(): ChatwootAPIConfig & { nameInbox: string; mergeBrazilContacts: boolean } {\n    return {\n      basePath: this.provider.url,\n      with_credentials: true,\n      credentials: 'include',\n      token: this.provider.token,\n      nameInbox: this.provider.nameInbox,\n      mergeBrazilContacts: this.provider.mergeBrazilContacts,\n    };\n  }\n\n  public getCache() {\n    return this.cache;\n  }\n\n  public async create(instance: InstanceDto, data: ChatwootDto) {\n    await this.waMonitor.waInstances[instance.instanceName].setChatwoot(data);\n\n    if (data.autoCreate) {\n      this.logger.log('Auto create chatwoot instance');\n      const urlServer = this.configService.get<HttpServer>('SERVER').URL;\n\n      await this.initInstanceChatwoot(\n        instance,\n        data.nameInbox ?? instance.instanceName.split('-cwId-')[0],\n        `${urlServer}/chatwoot/webhook/${encodeURIComponent(instance.instanceName)}`,\n        true,\n        data.number,\n        data.organization,\n        data.logo,\n      );\n    }\n    return data;\n  }\n\n  public async find(instance: InstanceDto): Promise<ChatwootDto> {\n    try {\n      return await this.waMonitor.waInstances[instance.instanceName].findChatwoot();\n    } catch {\n      this.logger.error('chatwoot not found');\n      return { enabled: null, url: '' };\n    }\n  }\n\n  public async getContact(instance: InstanceDto, id: number) {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    if (!id) {\n      this.logger.warn('id is required');\n      return null;\n    }\n\n    const contact = await client.contact.getContactable({\n      accountId: this.provider.accountId,\n      id,\n    });\n\n    if (!contact) {\n      this.logger.warn('contact not found');\n      return null;\n    }\n\n    return contact;\n  }\n\n  public async initInstanceChatwoot(\n    instance: InstanceDto,\n    inboxName: string,\n    webhookUrl: string,\n    qrcode: boolean,\n    number: string,\n    organization?: string,\n    logo?: string,\n  ) {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    const findInbox: any = await client.inboxes.list({\n      accountId: this.provider.accountId,\n    });\n\n    const checkDuplicate = findInbox.payload.map((inbox) => inbox.name).includes(inboxName);\n\n    let inboxId: number;\n\n    this.logger.log('Creating chatwoot inbox');\n    if (!checkDuplicate) {\n      const data = {\n        type: 'api',\n        webhook_url: webhookUrl,\n      };\n\n      const inbox = await client.inboxes.create({\n        accountId: this.provider.accountId,\n        data: {\n          name: inboxName,\n          channel: data as any,\n        },\n      });\n\n      if (!inbox) {\n        this.logger.warn('inbox not found');\n        return null;\n      }\n\n      inboxId = inbox.id;\n    } else {\n      const inbox = findInbox.payload.find((inbox) => inbox.name === inboxName);\n\n      if (!inbox) {\n        this.logger.warn('inbox not found');\n        return null;\n      }\n\n      inboxId = inbox.id;\n    }\n    this.logger.log(`Inbox created - inboxId: ${inboxId}`);\n\n    if (!this.configService.get<Chatwoot>('CHATWOOT').BOT_CONTACT) {\n      this.logger.log('Chatwoot bot contact is disabled');\n\n      return true;\n    }\n\n    this.logger.log('Creating chatwoot bot contact');\n    const contact =\n      (await this.findContact(instance, '123456')) ||\n      ((await this.createContact(\n        instance,\n        '123456',\n        inboxId,\n        false,\n        organization ? organization : 'EvolutionAPI',\n        logo ? logo : 'https://evolution-api.com/files/evolution-api-favicon.png',\n      )) as any);\n\n    if (!contact) {\n      this.logger.warn('contact not found');\n      return null;\n    }\n\n    const contactId = contact.id || contact.payload.contact.id;\n    this.logger.log(`Contact created - contactId: ${contactId}`);\n\n    if (qrcode) {\n      this.logger.log('QR code enabled');\n      const data = {\n        contact_id: contactId.toString(),\n        inbox_id: inboxId.toString(),\n      };\n\n      const conversation = await client.conversations.create({\n        accountId: this.provider.accountId,\n        data,\n      });\n\n      if (!conversation) {\n        this.logger.warn('conversation not found');\n        return null;\n      }\n\n      let contentMsg = 'init';\n\n      if (number) {\n        contentMsg = `init:${number}`;\n      }\n\n      const message = await client.messages.create({\n        accountId: this.provider.accountId,\n        conversationId: conversation.id,\n        data: {\n          content: contentMsg,\n          message_type: 'outgoing',\n        },\n      });\n\n      if (!message) {\n        this.logger.warn('conversation not found');\n        return null;\n      }\n      this.logger.log('Init message sent');\n    }\n\n    return true;\n  }\n\n  public async createContact(\n    instance: InstanceDto,\n    phoneNumber: string,\n    inboxId: number,\n    isGroup: boolean,\n    name?: string,\n    avatar_url?: string,\n    jid?: string,\n  ) {\n    try {\n      const client = await this.clientCw(instance);\n\n      if (!client) {\n        this.logger.warn('client not found');\n        return null;\n      }\n\n      let data: any = {};\n      if (!isGroup) {\n        data = {\n          inbox_id: inboxId,\n          name: name || phoneNumber,\n          identifier: jid,\n          avatar_url: avatar_url,\n        };\n\n        if ((jid && jid.includes('@')) || !jid) {\n          data['phone_number'] = `+${phoneNumber}`;\n        }\n      } else {\n        data = {\n          inbox_id: inboxId,\n          name: name || phoneNumber,\n          identifier: phoneNumber,\n          avatar_url: avatar_url,\n        };\n      }\n\n      const contact = await client.contacts.create({\n        accountId: this.provider.accountId,\n        data,\n      });\n\n      if (!contact) {\n        this.logger.warn('contact not found');\n        return null;\n      }\n\n      const findContact = await this.findContact(instance, phoneNumber);\n\n      const contactId = findContact?.id;\n\n      await this.addLabelToContact(this.provider.nameInbox, contactId);\n\n      return contact;\n    } catch (error) {\n      if ((error.status === 422 || error.response?.status === 422) && jid) {\n        this.logger.warn(`Contact with identifier ${jid} creation failed (422). Checking if it already exists...`);\n        const existingContact = await this.findContactByIdentifier(instance, jid);\n        if (existingContact) {\n          const contactId = existingContact.id;\n          await this.addLabelToContact(this.provider.nameInbox, contactId);\n          return existingContact;\n        }\n      }\n\n      this.logger.error('Error creating contact');\n      console.log(error);\n      return null;\n    }\n  }\n\n  public async updateContact(instance: InstanceDto, id: number, data: any) {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    if (!id) {\n      this.logger.warn('id is required');\n      return null;\n    }\n\n    try {\n      const contact = await client.contacts.update({\n        accountId: this.provider.accountId,\n        id,\n        data,\n      });\n\n      return contact;\n    } catch {\n      return null;\n    }\n  }\n\n  public async addLabelToContact(nameInbox: string, contactId: number) {\n    try {\n      const uri = this.configService.get<Chatwoot>('CHATWOOT').IMPORT.DATABASE.CONNECTION.URI;\n\n      if (!uri) return false;\n\n      const sqlTags = `SELECT id, taggings_count FROM tags WHERE name = $1 LIMIT 1`;\n      const tagData = (await this.pgClient.query(sqlTags, [nameInbox]))?.rows[0];\n      let tagId = tagData?.id;\n      const taggingsCount = tagData?.taggings_count || 0;\n\n      const sqlTag = `INSERT INTO tags (name, taggings_count) \n                      VALUES ($1, $2) \n                      ON CONFLICT (name) \n                      DO UPDATE SET taggings_count = tags.taggings_count + 1 \n                      RETURNING id`;\n\n      tagId = (await this.pgClient.query(sqlTag, [nameInbox, taggingsCount + 1]))?.rows[0]?.id;\n\n      const sqlCheckTagging = `SELECT 1 FROM taggings \n                               WHERE tag_id = $1 AND taggable_type = 'Contact' AND taggable_id = $2 AND context = 'labels' LIMIT 1`;\n\n      const taggingExists = (await this.pgClient.query(sqlCheckTagging, [tagId, contactId]))?.rowCount > 0;\n\n      if (!taggingExists) {\n        const sqlInsertLabel = `INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) \n                                VALUES ($1, 'Contact', $2, 'labels', NOW())`;\n\n        await this.pgClient.query(sqlInsertLabel, [tagId, contactId]);\n      }\n\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  public async findContactByIdentifier(instance: InstanceDto, identifier: string) {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    // Direct search by query (q) - most common way to search by identifier/email/phone\n    const contact = (await (client as any).get('contacts/search', {\n      params: {\n        q: identifier,\n        sort: 'name',\n      },\n    })) as any;\n\n    if (contact && contact.data && contact.data.payload && contact.data.payload.length > 0) {\n      return contact.data.payload[0];\n    }\n\n    // Fallback for older API versions or different response structures\n    if (contact && contact.payload && contact.payload.length > 0) {\n      return contact.payload[0];\n    }\n\n    // Try search by attribute\n    const contactByAttr = (await (client as any).post('contacts/filter', {\n      payload: [\n        {\n          attribute_key: 'identifier',\n          filter_operator: 'equal_to',\n          values: [identifier],\n          query_operator: null,\n        },\n      ],\n    })) as any;\n\n    if (contactByAttr && contactByAttr.payload && contactByAttr.payload.length > 0) {\n      return contactByAttr.payload[0];\n    }\n\n    // Check inside data property if using axios interceptors wrapper\n    if (contactByAttr && contactByAttr.data && contactByAttr.data.payload && contactByAttr.data.payload.length > 0) {\n      return contactByAttr.data.payload[0];\n    }\n\n    return null;\n  }\n\n  public async findContact(instance: InstanceDto, phoneNumber: string) {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    let query: any;\n    const isGroup = phoneNumber.includes('@g.us');\n\n    if (!isGroup) {\n      query = `+${phoneNumber}`;\n    } else {\n      query = phoneNumber;\n    }\n\n    let contact: any;\n\n    if (isGroup) {\n      contact = await client.contacts.search({\n        accountId: this.provider.accountId,\n        q: query,\n      });\n    } else {\n      contact = await chatwootRequest(this.getClientCwConfig(), {\n        method: 'POST',\n        url: `/api/v1/accounts/${this.provider.accountId}/contacts/filter`,\n        body: {\n          payload: this.getFilterPayload(query),\n        },\n      });\n    }\n\n    if (!contact && contact?.payload?.length === 0) {\n      this.logger.warn('contact not found');\n      return null;\n    }\n\n    if (!isGroup) {\n      return contact.payload.length > 1 ? this.findContactInContactList(contact.payload, query) : contact.payload[0];\n    } else {\n      return contact.payload.find((contact) => contact.identifier === query);\n    }\n  }\n\n  private async mergeContacts(baseId: number, mergeId: number) {\n    try {\n      const contact = await chatwootRequest(this.getClientCwConfig(), {\n        method: 'POST',\n        url: `/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,\n        body: {\n          base_contact_id: baseId,\n          mergee_contact_id: mergeId,\n        },\n      });\n\n      return contact;\n    } catch {\n      this.logger.error('Error merging contacts');\n      return null;\n    }\n  }\n\n  private async mergeBrazilianContacts(contacts: any[]) {\n    try {\n      const contact = await chatwootRequest(this.getClientCwConfig(), {\n        method: 'POST',\n        url: `/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,\n        body: {\n          base_contact_id: contacts.find((contact) => contact.phone_number.length === 14)?.id,\n          mergee_contact_id: contacts.find((contact) => contact.phone_number.length === 13)?.id,\n        },\n      });\n\n      return contact;\n    } catch {\n      this.logger.error('Error merging contacts');\n      return null;\n    }\n  }\n\n  private findContactInContactList(contacts: any[], query: string) {\n    const phoneNumbers = this.getNumbers(query);\n    const searchableFields = this.getSearchableFields();\n\n    // eslint-disable-next-line prettier/prettier\n    if (contacts.length === 2 && this.getClientCwConfig().mergeBrazilContacts && query.startsWith('+55')) {\n      const contact = this.mergeBrazilianContacts(contacts);\n      if (contact) {\n        return contact;\n      }\n    }\n\n    const phone = phoneNumbers.reduce(\n      (savedNumber, number) => (number.length > savedNumber.length ? number : savedNumber),\n      '',\n    );\n\n    const contact_with9 = contacts.find((contact) => contact.phone_number === phone);\n    if (contact_with9) {\n      return contact_with9;\n    }\n\n    for (const contact of contacts) {\n      for (const field of searchableFields) {\n        if (contact[field] && phoneNumbers.includes(contact[field])) {\n          return contact;\n        }\n      }\n    }\n\n    return null;\n  }\n\n  private getNumbers(query: string) {\n    const numbers = [];\n    numbers.push(query);\n\n    if (query.startsWith('+55') && query.length === 14) {\n      const withoutNine = query.slice(0, 5) + query.slice(6);\n      numbers.push(withoutNine);\n    } else if (query.startsWith('+55') && query.length === 13) {\n      const withNine = query.slice(0, 5) + '9' + query.slice(5);\n      numbers.push(withNine);\n    }\n\n    return numbers;\n  }\n\n  private getSearchableFields() {\n    return ['phone_number'];\n  }\n\n  private getFilterPayload(query: string) {\n    const filterPayload = [];\n\n    const numbers = this.getNumbers(query);\n    const fieldsToSearch = this.getSearchableFields();\n\n    fieldsToSearch.forEach((field, index1) => {\n      numbers.forEach((number, index2) => {\n        const queryOperator = fieldsToSearch.length - 1 === index1 && numbers.length - 1 === index2 ? null : 'OR';\n        filterPayload.push({\n          attribute_key: field,\n          filter_operator: 'equal_to',\n          values: [number.replace('+', '')],\n          query_operator: queryOperator,\n        });\n      });\n    });\n\n    return filterPayload;\n  }\n\n  public async createConversation(instance: InstanceDto, body: any) {\n    const isLid = body.key.addressingMode === 'lid';\n    const isGroup = body.key.remoteJid.endsWith('@g.us');\n    const phoneNumber = isLid && !isGroup ? body.key.remoteJidAlt : body.key.remoteJid;\n    const { remoteJid } = body.key;\n    const cacheKey = `${instance.instanceName}:createConversation-${remoteJid}`;\n    const lockKey = `${instance.instanceName}:lock:createConversation-${remoteJid}`;\n    const maxWaitTime = 5000; // 5 seconds\n    const client = await this.clientCw(instance);\n    if (!client) return null;\n\n    try {\n      // Processa atualizao de contatos j criados @lid\n      if (phoneNumber && remoteJid && !isGroup) {\n        const contact = await this.findContact(instance, phoneNumber.split('@')[0]);\n        if (contact && contact.identifier !== remoteJid) {\n          this.logger.verbose(\n            `Identifier needs update: (contact.identifier: ${contact.identifier}, phoneNumber: ${phoneNumber}, body.key.remoteJidAlt: ${remoteJid}`,\n          );\n          const updateContact = await this.updateContact(instance, contact.id, {\n            identifier: phoneNumber,\n            phone_number: `+${phoneNumber.split('@')[0]}`,\n          });\n\n          if (updateContact === null) {\n            const baseContact = await this.findContact(instance, phoneNumber.split('@')[0]);\n            if (baseContact) {\n              await this.mergeContacts(baseContact.id, contact.id);\n              this.logger.verbose(\n                `Merge contacts: (${baseContact.id}) ${baseContact.phone_number} and (${contact.id}) ${contact.phone_number}`,\n              );\n            }\n          }\n        }\n      }\n      this.logger.verbose(`--- Start createConversation ---`);\n      this.logger.verbose(`Instance: ${JSON.stringify(instance)}`);\n\n      // If it already exists in the cache, return conversationId\n      if (await this.cache.has(cacheKey)) {\n        const conversationId = (await this.cache.get(cacheKey)) as number;\n        this.logger.verbose(`Found conversation to: ${phoneNumber}, conversation ID: ${conversationId}`);\n        let conversationExists: any;\n        try {\n          conversationExists = await client.conversations.get({\n            accountId: this.provider.accountId,\n            conversationId: conversationId,\n          });\n          this.logger.verbose(\n            `Conversation exists: ID: ${conversationExists.id} - Name: ${conversationExists.meta.sender.name} - Identifier: ${conversationExists.meta.sender.identifier}`,\n          );\n        } catch (error) {\n          this.logger.error(`Error getting conversation: ${error}`);\n          conversationExists = false;\n        }\n        if (!conversationExists) {\n          this.logger.verbose('Conversation does not exist, re-calling createConversation');\n          this.cache.delete(cacheKey);\n          return await this.createConversation(instance, body);\n        }\n        return conversationId;\n      }\n\n      // If lock already exists, wait until release or timeout\n      if (await this.cache.has(lockKey)) {\n        this.logger.verbose(`Operao de criao j em andamento para ${remoteJid}, aguardando resultado...`);\n        const start = Date.now();\n        while (await this.cache.has(lockKey)) {\n          if (Date.now() - start > maxWaitTime) {\n            this.logger.warn(`Timeout aguardando lock para ${remoteJid}`);\n            break;\n          }\n          await new Promise((res) => setTimeout(res, this.LOCK_POLLING_DELAY_MS));\n          if (await this.cache.has(cacheKey)) {\n            const conversationId = (await this.cache.get(cacheKey)) as number;\n            this.logger.verbose(`Resolves creation of: ${remoteJid}, conversation ID: ${conversationId}`);\n            return conversationId;\n          }\n        }\n      }\n\n      // Adquire lock\n      await this.cache.set(lockKey, true, 30);\n      this.logger.verbose(`Bloqueio adquirido para: ${lockKey}`);\n\n      try {\n        /*\n        Double check after lock\n        Utilizei uma nova verificao para evitar que outra thread execute entre o terminio do while e o set lock\n        */\n        if (await this.cache.has(cacheKey)) {\n          return (await this.cache.get(cacheKey)) as number;\n        }\n\n        const chatId = isGroup ? remoteJid : phoneNumber.split('@')[0].split(':')[0];\n        let nameContact = !body.key.fromMe ? body.pushName : chatId;\n        const filterInbox = await this.getInbox(instance);\n        if (!filterInbox) return null;\n\n        if (isGroup) {\n          this.logger.verbose(`Processing group conversation`);\n          const group = await this.waMonitor.waInstances[instance.instanceName].client.groupMetadata(chatId);\n          this.logger.verbose(`Group metadata: JID:${group.JID} - Subject:${group?.subject || group?.Name}`);\n\n          const participantJid = isLid && !body.key.fromMe ? body.key.participantAlt : body.key.participant;\n          nameContact = `${group.subject} (GROUP)`;\n\n          const picture_url = await this.waMonitor.waInstances[instance.instanceName].profilePicture(\n            participantJid.split('@')[0],\n          );\n          this.logger.verbose(`Participant profile picture URL: ${JSON.stringify(picture_url)}`);\n\n          const findParticipant = await this.findContact(instance, participantJid.split('@')[0]);\n\n          if (findParticipant) {\n            this.logger.verbose(\n              `Found participant: ID:${findParticipant.id} - Name: ${findParticipant.name} - identifier: ${findParticipant.identifier}`,\n            );\n            if (!findParticipant.name || findParticipant.name === chatId) {\n              await this.updateContact(instance, findParticipant.id, {\n                name: body.pushName,\n                avatar_url: picture_url.profilePictureUrl || null,\n              });\n            }\n          } else {\n            await this.createContact(\n              instance,\n              participantJid.split('@')[0].split(':')[0],\n              filterInbox.id,\n              false,\n              body.pushName,\n              picture_url.profilePictureUrl || null,\n              participantJid,\n            );\n          }\n        }\n\n        const picture_url = await this.waMonitor.waInstances[instance.instanceName].profilePicture(chatId);\n        this.logger.verbose(`Contact profile picture URL: ${JSON.stringify(picture_url)}`);\n\n        this.logger.verbose(`Searching contact for: ${chatId}`);\n        let contact = await this.findContact(instance, chatId);\n\n        if (contact) {\n          this.logger.verbose(`Found contact: ID:${contact.id} - Name:${contact.name}`);\n          if (!body.key.fromMe) {\n            const waProfilePictureFile =\n              picture_url?.profilePictureUrl?.split('#')[0].split('?')[0].split('/').pop() || '';\n            const chatwootProfilePictureFile = contact?.thumbnail?.split('#')[0].split('?')[0].split('/').pop() || '';\n            const pictureNeedsUpdate = waProfilePictureFile !== chatwootProfilePictureFile;\n            const nameNeedsUpdate = !contact.name || contact.name === chatId;\n            this.logger.verbose(`Picture needs update: ${pictureNeedsUpdate}`);\n            this.logger.verbose(`Name needs update: ${nameNeedsUpdate}`);\n            if (pictureNeedsUpdate || nameNeedsUpdate) {\n              contact = await this.updateContact(instance, contact.id, {\n                ...(nameNeedsUpdate && { name: nameContact }),\n                ...(waProfilePictureFile === '' && { avatar: null }),\n                ...(pictureNeedsUpdate && { avatar_url: picture_url?.profilePictureUrl }),\n              });\n            }\n          }\n        } else {\n          contact = await this.createContact(\n            instance,\n            chatId,\n            filterInbox.id,\n            isGroup,\n            nameContact,\n            picture_url.profilePictureUrl || null,\n            phoneNumber,\n          );\n        }\n\n        if (!contact) {\n          this.logger.warn(`Contact not created or found`);\n          return null;\n        }\n\n        const contactId = contact?.payload?.id || contact?.payload?.contact?.id || contact?.id;\n        this.logger.verbose(`Contact ID: ${contactId}`);\n\n        const contactConversations = (await client.contacts.listConversations({\n          accountId: this.provider.accountId,\n          id: contactId,\n        })) as any;\n\n        if (!contactConversations || !contactConversations.payload) {\n          this.logger.error(`No conversations found or payload is undefined`);\n          return null;\n        }\n\n        let inboxConversation = contactConversations.payload.find(\n          (conversation) => conversation.inbox_id == filterInbox.id,\n        );\n        if (inboxConversation) {\n          if (this.provider.reopenConversation) {\n            this.logger.verbose(\n              `Found conversation in reopenConversation mode: ID: ${inboxConversation.id} - Name: ${inboxConversation.meta.sender.name} - Identifier: ${inboxConversation.meta.sender.identifier}`,\n            );\n            if (inboxConversation && this.provider.conversationPending && inboxConversation.status !== 'open') {\n              await client.conversations.toggleStatus({\n                accountId: this.provider.accountId,\n                conversationId: inboxConversation.id,\n                data: {\n                  status: 'pending',\n                },\n              });\n            }\n          } else {\n            inboxConversation = contactConversations.payload.find(\n              (conversation) =>\n                conversation && conversation.status !== 'resolved' && conversation.inbox_id == filterInbox.id,\n            );\n            this.logger.verbose(`Found conversation: ${JSON.stringify(inboxConversation)}`);\n          }\n\n          if (inboxConversation) {\n            this.logger.verbose(`Returning existing conversation ID: ${inboxConversation.id}`);\n            this.cache.set(cacheKey, inboxConversation.id, 1800);\n            return inboxConversation.id;\n          }\n        }\n\n        const data = {\n          contact_id: contactId.toString(),\n          inbox_id: filterInbox.id.toString(),\n        };\n\n        if (this.provider.conversationPending) {\n          data['status'] = 'pending';\n        }\n\n        const conversation = await client.conversations.create({\n          accountId: this.provider.accountId,\n          data,\n        });\n\n        if (!conversation) {\n          this.logger.warn(`Conversation not created or found`);\n          return null;\n        }\n\n        this.logger.verbose(`New conversation created of ${remoteJid} with ID: ${conversation.id}`);\n        this.cache.set(cacheKey, conversation.id, 1800);\n        return conversation.id;\n      } finally {\n        await this.cache.delete(lockKey);\n        this.logger.verbose(`Block released for: ${lockKey}`);\n      }\n    } catch (error) {\n      this.logger.error(`Error in createConversation: ${error}`);\n      return null;\n    }\n  }\n\n  public async getInbox(instance: InstanceDto): Promise<inbox | null> {\n    const cacheKey = `${instance.instanceName}:getInbox`;\n    if (await this.cache.has(cacheKey)) {\n      return (await this.cache.get(cacheKey)) as inbox;\n    }\n\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    const inbox = (await client.inboxes.list({\n      accountId: this.provider.accountId,\n    })) as any;\n\n    if (!inbox) {\n      this.logger.warn('inbox not found');\n      return null;\n    }\n\n    const findByName = inbox.payload.find((inbox) => inbox.name === this.getClientCwConfig().nameInbox);\n\n    if (!findByName) {\n      this.logger.warn('inbox not found');\n      return null;\n    }\n\n    this.cache.set(cacheKey, findByName);\n    return findByName;\n  }\n\n  public async createMessage(\n    instance: InstanceDto,\n    conversationId: number,\n    content: string,\n    messageType: 'incoming' | 'outgoing' | undefined,\n    privateMessage?: boolean,\n    attachments?: {\n      content: unknown;\n      encoding: string;\n      filename: string;\n    }[],\n    messageBody?: any,\n    sourceId?: string,\n    quotedMsg?: MessageModel,\n  ) {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    const replyToIds = await this.getReplyToIds(messageBody, instance);\n\n    const sourceReplyId = quotedMsg?.chatwootMessageId || null;\n\n    const message = await client.messages.create({\n      accountId: this.provider.accountId,\n      conversationId: conversationId,\n      data: {\n        content: content,\n        message_type: messageType,\n        attachments: attachments,\n        private: privateMessage || false,\n        source_id: sourceId,\n        content_attributes: {\n          ...replyToIds,\n        },\n        source_reply_id: sourceReplyId ? sourceReplyId.toString() : null,\n      },\n    });\n\n    if (!message) {\n      this.logger.warn('message not found');\n      return null;\n    }\n\n    return message;\n  }\n\n  public async getOpenConversationByContact(\n    instance: InstanceDto,\n    inbox: inbox,\n    contact: generic_id & contact,\n  ): Promise<conversation> {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    const conversations = (await client.contacts.listConversations({\n      accountId: this.provider.accountId,\n      id: contact.id,\n    })) as any;\n\n    return (\n      conversations.payload.find(\n        (conversation) => conversation.inbox_id === inbox.id && conversation.status === 'open',\n      ) || undefined\n    );\n  }\n\n  public async createBotMessage(\n    instance: InstanceDto,\n    content: string,\n    messageType: 'incoming' | 'outgoing' | undefined,\n    attachments?: {\n      content: unknown;\n      encoding: string;\n      filename: string;\n    }[],\n  ) {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    const contact = await this.findContact(instance, '123456');\n\n    if (!contact) {\n      this.logger.warn('contact not found');\n      return null;\n    }\n\n    const filterInbox = await this.getInbox(instance);\n\n    if (!filterInbox) {\n      this.logger.warn('inbox not found');\n      return null;\n    }\n\n    const conversation = await this.getOpenConversationByContact(instance, filterInbox, contact);\n\n    if (!conversation) {\n      this.logger.warn('conversation not found');\n      return;\n    }\n\n    const message = await client.messages.create({\n      accountId: this.provider.accountId,\n      conversationId: conversation.id,\n      data: {\n        content: content,\n        message_type: messageType,\n        attachments: attachments,\n      },\n    });\n\n    if (!message) {\n      this.logger.warn('message not found');\n      return null;\n    }\n\n    return message;\n  }\n\n  private async sendData(\n    conversationId: number,\n    fileStream: Readable,\n    fileName: string,\n    messageType: 'incoming' | 'outgoing' | undefined,\n    content?: string,\n    instance?: InstanceDto,\n    messageBody?: any,\n    sourceId?: string,\n    quotedMsg?: MessageModel,\n  ) {\n    if (sourceId && this.isImportHistoryAvailable()) {\n      const messageAlreadySaved = await chatwootImport.getExistingSourceIds([sourceId], conversationId);\n      if (messageAlreadySaved) {\n        if (messageAlreadySaved.size > 0) {\n          this.logger.warn('Message already saved on chatwoot');\n          return null;\n        }\n      }\n    }\n    const data = new FormData();\n\n    if (content) {\n      data.append('content', content);\n    }\n\n    data.append('message_type', messageType);\n\n    data.append('attachments[]', fileStream, { filename: fileName });\n\n    const sourceReplyId = quotedMsg?.chatwootMessageId || null;\n\n    if (messageBody && instance) {\n      const replyToIds = await this.getReplyToIds(messageBody, instance);\n\n      if (replyToIds.in_reply_to || replyToIds.in_reply_to_external_id) {\n        const content = JSON.stringify({\n          ...replyToIds,\n        });\n        data.append('content_attributes', content);\n      }\n    }\n\n    if (sourceReplyId) {\n      data.append('source_reply_id', sourceReplyId.toString());\n    }\n\n    if (sourceId) {\n      data.append('source_id', sourceId);\n    }\n\n    const config = {\n      method: 'post',\n      maxBodyLength: Infinity,\n      url: `${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${conversationId}/messages`,\n      headers: {\n        api_access_token: this.provider.token,\n        ...data.getHeaders(),\n      },\n      data: data,\n    };\n\n    try {\n      const { data } = await axios.request(config);\n\n      return data;\n    } catch (error) {\n      this.logger.error(error);\n    }\n  }\n\n  public async createBotQr(\n    instance: InstanceDto,\n    content: string,\n    messageType: 'incoming' | 'outgoing' | undefined,\n    fileStream?: Readable,\n    fileName?: string,\n  ) {\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      this.logger.warn('client not found');\n      return null;\n    }\n\n    if (!this.configService.get<Chatwoot>('CHATWOOT').BOT_CONTACT) {\n      this.logger.log('Chatwoot bot contact is disabled');\n\n      return true;\n    }\n\n    const contact = await this.findContact(instance, '123456');\n\n    if (!contact) {\n      this.logger.warn('contact not found');\n      return null;\n    }\n\n    const filterInbox = await this.getInbox(instance);\n\n    if (!filterInbox) {\n      this.logger.warn('inbox not found');\n      return null;\n    }\n\n    const conversation = await this.getOpenConversationByContact(instance, filterInbox, contact);\n\n    if (!conversation) {\n      this.logger.warn('conversation not found');\n      return;\n    }\n\n    const data = new FormData();\n\n    if (content) {\n      data.append('content', content);\n    }\n\n    data.append('message_type', messageType);\n\n    if (fileStream && fileName) {\n      data.append('attachments[]', fileStream, { filename: fileName });\n    }\n\n    const config = {\n      method: 'post',\n      maxBodyLength: Infinity,\n      url: `${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${conversation.id}/messages`,\n      headers: {\n        api_access_token: this.provider.token,\n        ...data.getHeaders(),\n      },\n      data: data,\n    };\n\n    try {\n      const { data } = await axios.request(config);\n\n      return data;\n    } catch (error) {\n      this.logger.error(error);\n    }\n  }\n\n  public async sendAttachment(waInstance: any, number: string, media: any, caption?: string, options?: Options) {\n    try {\n      const parsedMedia = path.parse(decodeURIComponent(media));\n      let mimeType = mimeTypes.lookup(parsedMedia?.ext) || '';\n      let fileName = parsedMedia?.name + parsedMedia?.ext;\n\n      if (!mimeType) {\n        const parts = media.split('/');\n        fileName = decodeURIComponent(parts[parts.length - 1]);\n\n        const response = await axios.get(media, {\n          responseType: 'arraybuffer',\n        });\n        mimeType = response.headers['content-type'];\n      }\n\n      let type = 'document';\n\n      switch (mimeType.split('/')[0]) {\n        case 'image':\n          type = 'image';\n          break;\n        case 'video':\n          type = 'video';\n          break;\n        case 'audio':\n          type = 'audio';\n          break;\n        default:\n          type = 'document';\n          break;\n      }\n\n      if (type === 'audio') {\n        const data: SendAudioDto = {\n          number: number,\n          audio: media,\n          delay: Math.floor(Math.random() * (2000 - 500 + 1)) + 500,\n          quoted: options?.quoted,\n        };\n\n        sendTelemetry('/message/sendWhatsAppAudio');\n\n        const messageSent = await waInstance?.audioWhatsapp(data, null, true);\n\n        return messageSent;\n      }\n\n      const documentExtensions = ['.gif', '.svg', '.tiff', '.tif', '.dxf', '.dwg'];\n      if (type === 'image' && parsedMedia && documentExtensions.includes(parsedMedia?.ext)) {\n        type = 'document';\n      }\n\n      const data: SendMediaDto = {\n        number: number,\n        mediatype: type as any,\n        fileName: fileName,\n        media: media,\n        delay: 1200,\n        quoted: options?.quoted,\n      };\n\n      sendTelemetry('/message/sendMedia');\n\n      if (caption) {\n        data.caption = caption;\n      }\n\n      const messageSent = await waInstance?.mediaMessage(data, null, true);\n\n      return messageSent;\n    } catch (error) {\n      this.logger.error(error);\n      throw error; // Re-throw para que o erro seja tratado pelo caller\n    }\n  }\n\n  public async onSendMessageError(instance: InstanceDto, conversation: number, error?: any) {\n    this.logger.verbose(`onSendMessageError ${JSON.stringify(error)}`);\n\n    const client = await this.clientCw(instance);\n\n    if (!client) {\n      return;\n    }\n\n    if (error && error?.status === 400 && error?.message[0]?.exists === false) {\n      client.messages.create({\n        accountId: this.provider.accountId,\n        conversationId: conversation,\n        data: {\n          content: `${i18next.t('cw.message.numbernotinwhatsapp')}`,\n          message_type: 'outgoing',\n          private: true,\n        },\n      });\n\n      return;\n    }\n\n    client.messages.create({\n      accountId: this.provider.accountId,\n      conversationId: conversation,\n      data: {\n        content: i18next.t('cw.message.notsent', {\n          error: error ? `_${error.toString()}_` : '',\n        }),\n        message_type: 'outgoing',\n        private: true,\n      },\n    });\n  }\n\n  public async receiveWebhook(instance: InstanceDto, body: any) {\n    try {\n      await new Promise((resolve) => setTimeout(resolve, 500));\n\n      const client = await this.clientCw(instance);\n\n      if (!client) {\n        this.logger.warn('client not found');\n        return null;\n      }\n\n      if (\n        this.provider.reopenConversation === false &&\n        body.event === 'conversation_status_changed' &&\n        body.status === 'resolved' &&\n        body.meta?.sender?.identifier\n      ) {\n        const keyToDelete = `${instance.instanceName}:createConversation-${body.meta.sender.identifier}`;\n        this.cache.delete(keyToDelete);\n      }\n\n      if (\n        !body?.conversation ||\n        body.private ||\n        (body.event === 'message_updated' && !body.content_attributes?.deleted)\n      ) {\n        return { message: 'bot' };\n      }\n\n      const chatId =\n        body.conversation.meta.sender?.identifier || body.conversation.meta.sender?.phone_number.replace('+', '');\n      // Chatwoot to Whatsapp\n      const messageReceived = body.content\n        ? body.content\n            .replaceAll(/(?<!\\*)\\*((?!\\s)([^\\n*]+?)(?<!\\s))\\*(?!\\*)/g, '_$1_') // Substitui * por _\n            .replaceAll(/\\*{2}((?!\\s)([^\\n*]+?)(?<!\\s))\\*{2}/g, '*$1*') // Substitui ** por *\n            .replaceAll(/~{2}((?!\\s)([^\\n*]+?)(?<!\\s))~{2}/g, '~$1~') // Substitui ~~ por ~\n            .replaceAll(/(?<!`)`((?!\\s)([^`*]+?)(?<!\\s))`(?!`)/g, '```$1```') // Substitui ` por ```\n        : body.content;\n\n      const senderName = body?.conversation?.messages[0]?.sender?.available_name || body?.sender?.name;\n      const waInstance = this.waMonitor.waInstances[instance.instanceName];\n      instance.instanceId = waInstance.instanceId;\n\n      if (body.event === 'message_updated' && body.content_attributes?.deleted) {\n        const message = await this.prismaRepository.message.findFirst({\n          where: {\n            chatwootMessageId: body.id,\n            instanceId: instance.instanceId,\n          },\n        });\n\n        if (message) {\n          const key = message.key as WAMessageKey;\n\n          await waInstance?.client.sendMessage(key.remoteJid, { delete: key });\n\n          await this.prismaRepository.message.deleteMany({\n            where: {\n              instanceId: instance.instanceId,\n              chatwootMessageId: body.id,\n            },\n          });\n        }\n        return { message: 'bot' };\n      }\n\n      const cwBotContact = this.configService.get<Chatwoot>('CHATWOOT').BOT_CONTACT;\n\n      if (chatId === '123456' && body.message_type === 'outgoing') {\n        const command = messageReceived.replace('/', '');\n\n        if (cwBotContact && (command.includes('init') || command.includes('iniciar'))) {\n          const state = waInstance?.connectionStatus?.state;\n\n          if (state !== 'open') {\n            const number = command.split(':')[1];\n            await waInstance.connectToWhatsapp(number);\n          } else {\n            await this.createBotMessage(\n              instance,\n              i18next.t('cw.inbox.alreadyConnected', {\n                inboxName: body.inbox.name,\n              }),\n              'incoming',\n            );\n          }\n        }\n\n        if (command === 'clearcache') {\n          waInstance.clearCacheChatwoot();\n          await this.createBotMessage(\n            instance,\n            i18next.t('cw.inbox.clearCache', {\n              inboxName: body.inbox.name,\n            }),\n            'incoming',\n          );\n        }\n\n        if (command === 'status') {\n          const state = waInstance?.connectionStatus?.state;\n\n          if (!state) {\n            await this.createBotMessage(\n              instance,\n              i18next.t('cw.inbox.notFound', {\n                inboxName: body.inbox.name,\n              }),\n              'incoming',\n            );\n          }\n\n          if (state) {\n            await this.createBotMessage(\n              instance,\n              i18next.t('cw.inbox.status', {\n                inboxName: body.inbox.name,\n                state: state,\n              }),\n              'incoming',\n            );\n          }\n        }\n\n        if (cwBotContact && (command === 'disconnect' || command === 'desconectar')) {\n          const msgLogout = i18next.t('cw.inbox.disconnect', {\n            inboxName: body.inbox.name,\n          });\n\n          await this.createBotMessage(instance, msgLogout, 'incoming');\n\n          await waInstance?.client?.logout('Log out instance: ' + instance.instanceName);\n          await waInstance?.client?.ws?.close();\n        }\n      }\n\n      if (body.message_type === 'outgoing' && body?.conversation?.messages?.length && chatId !== '123456') {\n        if (body?.conversation?.messages[0]?.source_id?.substring(0, 5) === 'WAID:') {\n          return { message: 'bot' };\n        }\n\n        if (!waInstance && body.conversation?.id) {\n          this.onSendMessageError(instance, body.conversation?.id, 'Instance not found');\n          return { message: 'bot' };\n        }\n\n        let formatText: string;\n        if (senderName === null || senderName === undefined) {\n          formatText = messageReceived;\n        } else {\n          const formattedDelimiter = this.provider.signDelimiter\n            ? this.provider.signDelimiter.replaceAll('\\\\n', '\\n')\n            : '\\n';\n          const textToConcat = this.provider.signMsg ? [`*${senderName}:*`] : [];\n          textToConcat.push(messageReceived);\n\n          formatText = textToConcat.join(formattedDelimiter);\n        }\n\n        for (const message of body.conversation.messages) {\n          if (message.attachments && message.attachments.length > 0) {\n            for (const attachment of message.attachments) {\n              if (!messageReceived) {\n                formatText = null;\n              }\n\n              const options: Options = {\n                quoted: await this.getQuotedMessage(body, instance),\n              };\n\n              const messageSent = await this.sendAttachment(\n                waInstance,\n                chatId,\n                attachment.data_url,\n                formatText,\n                options,\n              );\n              if (!messageSent && body.conversation?.id) {\n                this.onSendMessageError(instance, body.conversation?.id);\n              }\n\n              await this.updateChatwootMessageId(\n                {\n                  ...messageSent,\n                },\n                {\n                  messageId: body.id,\n                  inboxId: body.inbox?.id,\n                  conversationId: body.conversation?.id,\n                  contactInboxSourceId: body.conversation?.contact_inbox?.source_id,\n                },\n                instance,\n              );\n            }\n          } else {\n            const data: SendTextDto = {\n              number: chatId,\n              text: formatText,\n              delay: Math.floor(Math.random() * (2000 - 500 + 1)) + 500,\n              quoted: await this.getQuotedMessage(body, instance),\n            };\n\n            sendTelemetry('/message/sendText');\n\n            let messageSent: any;\n            try {\n              messageSent = await waInstance?.textMessage(data, true);\n              if (!messageSent) {\n                throw new Error('Message not sent');\n              }\n\n              if (Long.isLong(messageSent?.messageTimestamp)) {\n                messageSent.messageTimestamp = messageSent.messageTimestamp?.toNumber();\n              }\n\n              await this.updateChatwootMessageId(\n                {\n                  ...messageSent,\n                },\n                {\n                  messageId: body.id,\n                  inboxId: body.inbox?.id,\n                  conversationId: body.conversation?.id,\n                  contactInboxSourceId: body.conversation?.contact_inbox?.source_id,\n                },\n                instance,\n              );\n            } catch (error) {\n              if (!messageSent && body.conversation?.id) {\n                this.onSendMessageError(instance, body.conversation?.id, error);\n              }\n              throw error;\n            }\n          }\n        }\n\n        const chatwootRead = this.configService.get<Chatwoot>('CHATWOOT').MESSAGE_READ;\n        if (chatwootRead) {\n          const lastMessage = await this.prismaRepository.message.findFirst({\n            where: {\n              key: {\n                path: ['fromMe'],\n                equals: false,\n              },\n              instanceId: instance.instanceId,\n            },\n          });\n          if (lastMessage && !lastMessage.chatwootIsRead) {\n            const key = lastMessage.key as WAMessageKey;\n\n            waInstance?.markMessageAsRead({\n              readMessages: [\n                {\n                  id: key.id,\n                  fromMe: key.fromMe,\n                  remoteJid: key.remoteJid,\n                },\n              ],\n            });\n            const updateMessage = {\n              chatwootMessageId: lastMessage.chatwootMessageId,\n              chatwootConversationId: lastMessage.chatwootConversationId,\n              chatwootInboxId: lastMessage.chatwootInboxId,\n              chatwootContactInboxSourceId: lastMessage.chatwootContactInboxSourceId,\n              chatwootIsRead: true,\n            };\n\n            await this.prismaRepository.message.updateMany({\n              where: {\n                instanceId: instance.instanceId,\n                key: {\n                  path: ['id'],\n                  equals: key.id,\n                },\n              },\n              data: updateMessage,\n            });\n          }\n        }\n      }\n\n      if (body.message_type === 'template' && body.event === 'message_created') {\n        const data: SendTextDto = {\n          number: chatId,\n          text: body.content.replace(/\\\\\\r\\n|\\\\\\n|\\n/g, '\\n'),\n          delay: Math.floor(Math.random() * (2000 - 500 + 1)) + 500,\n        };\n\n        sendTelemetry('/message/sendText');\n\n        await waInstance?.textMessage(data);\n      }\n\n      return { message: 'bot' };\n    } catch (error) {\n      this.logger.error(error);\n\n      return { message: 'bot' };\n    }\n  }\n\n  private async updateChatwootMessageId(\n    message: MessageModel,\n    chatwootMessageIds: ChatwootMessage,\n    instance: InstanceDto,\n  ) {\n    const key = message.key as WAMessageKey;\n\n    if (!chatwootMessageIds.messageId || !key?.id) {\n      return;\n    }\n\n    // Use raw SQL to avoid JSON path issues\n    const result = await this.prismaRepository.$executeRaw`\n      UPDATE \"Message\" \n      SET \n        \"chatwootMessageId\" = ${chatwootMessageIds.messageId},\n        \"chatwootConversationId\" = ${chatwootMessageIds.conversationId},\n        \"chatwootInboxId\" = ${chatwootMessageIds.inboxId},\n        \"chatwootContactInboxSourceId\" = ${chatwootMessageIds.contactInboxSourceId},\n        \"chatwootIsRead\" = ${chatwootMessageIds.isRead || false}\n      WHERE \"instanceId\" = ${instance.instanceId} \n      AND \"key\"->>'id' = ${key.id}\n    `;\n\n    this.logger.verbose(`Update result: ${result} rows affected`);\n\n    if (this.isImportHistoryAvailable()) {\n      try {\n        await chatwootImport.updateMessageSourceID(chatwootMessageIds.messageId, key.id);\n      } catch (error) {\n        this.logger.error(`Error updating Chatwoot message source ID: ${error}`);\n      }\n    }\n  }\n\n  private async getMessageByKeyId(instance: InstanceDto, keyId: string): Promise<MessageModel> {\n    // Use raw SQL query to avoid JSON path issues with Prisma\n    const messages = await this.prismaRepository.$queryRaw`\n      SELECT * FROM \"Message\" \n      WHERE \"instanceId\" = ${instance.instanceId} \n      AND \"key\"->>'id' = ${keyId}\n      LIMIT 1\n    `;\n\n    return (messages as MessageModel[])[0] || null;\n  }\n\n  private async getReplyToIds(\n    msg: any,\n    instance: InstanceDto,\n  ): Promise<{ in_reply_to: string; in_reply_to_external_id: string }> {\n    let inReplyTo = null;\n    let inReplyToExternalId = null;\n\n    if (msg) {\n      inReplyToExternalId = msg.message?.extendedTextMessage?.contextInfo?.stanzaId ?? msg.contextInfo?.stanzaId;\n      if (inReplyToExternalId) {\n        const message = await this.getMessageByKeyId(instance, inReplyToExternalId);\n        if (message?.chatwootMessageId) {\n          inReplyTo = message.chatwootMessageId;\n        }\n      }\n    }\n\n    return {\n      in_reply_to: inReplyTo,\n      in_reply_to_external_id: inReplyToExternalId,\n    };\n  }\n\n  private async getQuotedMessage(msg: any, instance: InstanceDto): Promise<Quoted> {\n    if (msg?.content_attributes?.in_reply_to) {\n      const message = await this.prismaRepository.message.findFirst({\n        where: {\n          chatwootMessageId: msg?.content_attributes?.in_reply_to,\n          instanceId: instance.instanceId,\n        },\n      });\n\n      const key = message?.key as WAMessageKey;\n      const messageContent = message?.message as WAMessageContent;\n\n      if (messageContent && key?.id) {\n        return {\n          key: key,\n          message: messageContent,\n        };\n      }\n    }\n\n    return null;\n  }\n\n  private isMediaMessage(message: any) {\n    const media = [\n      'imageMessage',\n      'documentMessage',\n      'documentWithCaptionMessage',\n      'audioMessage',\n      'videoMessage',\n      'stickerMessage',\n      'viewOnceMessageV2',\n    ];\n\n    const messageKeys = Object.keys(message);\n\n    const result = messageKeys.some((key) => media.includes(key));\n\n    return result;\n  }\n\n  private isInteractiveButtonMessage(messageType: string, message: any) {\n    return messageType === 'interactiveMessage' && message.interactiveMessage?.nativeFlowMessage?.buttons?.length > 0;\n  }\n\n  private getAdsMessage(msg: any) {\n    interface AdsMessage {\n      title: string;\n      body: string;\n      thumbnailUrl: string;\n      sourceUrl: string;\n    }\n\n    const adsMessage: AdsMessage | undefined = {\n      title: msg.extendedTextMessage?.contextInfo?.externalAdReply?.title || msg.contextInfo?.externalAdReply?.title,\n      body: msg.extendedTextMessage?.contextInfo?.externalAdReply?.body || msg.contextInfo?.externalAdReply?.body,\n      thumbnailUrl:\n        msg.extendedTextMessage?.contextInfo?.externalAdReply?.thumbnailUrl ||\n        msg.contextInfo?.externalAdReply?.thumbnailUrl,\n      sourceUrl:\n        msg.extendedTextMessage?.contextInfo?.externalAdReply?.sourceUrl || msg.contextInfo?.externalAdReply?.sourceUrl,\n    };\n\n    return adsMessage;\n  }\n\n  private getReactionMessage(msg: any) {\n    interface ReactionMessage {\n      key: {\n        id: string;\n        fromMe: boolean;\n        remoteJid: string;\n        participant?: string;\n      };\n      text: string;\n    }\n    const reactionMessage: ReactionMessage | undefined = msg?.reactionMessage;\n\n    return reactionMessage;\n  }\n\n  private getTypeMessage(msg: any) {\n    const types = {\n      conversation: msg.conversation,\n      imageMessage: msg.imageMessage?.caption,\n      videoMessage: msg.videoMessage?.caption,\n      extendedTextMessage: msg.extendedTextMessage?.text,\n      messageContextInfo: msg.messageContextInfo?.stanzaId,\n      stickerMessage: undefined,\n      documentMessage: msg.documentMessage?.caption,\n      documentWithCaptionMessage: msg.documentWithCaptionMessage?.message?.documentMessage?.caption,\n      audioMessage: msg.audioMessage ? (msg.audioMessage.caption ?? '') : undefined,\n      contactMessage: msg.contactMessage?.vcard,\n      contactsArrayMessage: msg.contactsArrayMessage,\n      locationMessage: msg.locationMessage,\n      liveLocationMessage: msg.liveLocationMessage,\n      listMessage: msg.listMessage,\n      listResponseMessage: msg.listResponseMessage,\n      viewOnceMessageV2:\n        msg?.message?.viewOnceMessageV2?.message?.imageMessage?.url ||\n        msg?.message?.viewOnceMessageV2?.message?.videoMessage?.url ||\n        msg?.message?.viewOnceMessageV2?.message?.audioMessage?.url,\n    };\n\n    return types;\n  }\n\n  private getMessageContent(types: any) {\n    const typeKey = Object.keys(types).find((key) => types[key] !== undefined);\n\n    let result = typeKey ? types[typeKey] : undefined;\n\n    // Remove externalAdReplyBody| in Chatwoot (Already Have)\n    if (result && typeof result === 'string' && result.includes('externalAdReplyBody|')) {\n      result = result.split('externalAdReplyBody|').filter(Boolean).join('');\n    }\n\n    if (typeKey === 'locationMessage' || typeKey === 'liveLocationMessage') {\n      const latitude = result.degreesLatitude;\n      const longitude = result.degreesLongitude;\n\n      const locationName = result?.name;\n      const locationAddress = result?.address;\n\n      const formattedLocation =\n        `*${i18next.t('cw.locationMessage.location')}:*\\n\\n` +\n        `_${i18next.t('cw.locationMessage.latitude')}:_ ${latitude} \\n` +\n        `_${i18next.t('cw.locationMessage.longitude')}:_ ${longitude} \\n` +\n        (locationName ? `_${i18next.t('cw.locationMessage.locationName')}:_ ${locationName}\\n` : '') +\n        (locationAddress ? `_${i18next.t('cw.locationMessage.locationAddress')}:_ ${locationAddress} \\n` : '') +\n        `_${i18next.t('cw.locationMessage.locationUrl')}:_ ` +\n        `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}`;\n\n      return formattedLocation;\n    }\n\n    if (typeKey === 'contactMessage') {\n      const vCardData = result.split('\\n');\n      const contactInfo = {};\n\n      vCardData.forEach((line) => {\n        const [key, value] = line.split(':');\n        if (key && value) {\n          contactInfo[key] = value;\n        }\n      });\n\n      let formattedContact =\n        `*${i18next.t('cw.contactMessage.contact')}:*\\n\\n` +\n        `_${i18next.t('cw.contactMessage.name')}:_ ${contactInfo['FN']}`;\n\n      let numberCount = 1;\n      Object.keys(contactInfo).forEach((key) => {\n        if (key.startsWith('item') && key.includes('TEL')) {\n          const phoneNumber = contactInfo[key];\n          formattedContact += `\\n_${i18next.t('cw.contactMessage.number')} (${numberCount}):_ ${phoneNumber}`;\n          numberCount++;\n        } else if (key.includes('TEL')) {\n          const phoneNumber = contactInfo[key];\n          formattedContact += `\\n_${i18next.t('cw.contactMessage.number')} (${numberCount}):_ ${phoneNumber}`;\n          numberCount++;\n        }\n      });\n\n      return formattedContact;\n    }\n\n    if (typeKey === 'contactsArrayMessage') {\n      const formattedContacts = result.contacts.map((contact) => {\n        const vCardData = contact.vcard.split('\\n');\n        const contactInfo = {};\n\n        vCardData.forEach((line) => {\n          const [key, value] = line.split(':');\n          if (key && value) {\n            contactInfo[key] = value;\n          }\n        });\n\n        let formattedContact = `*${i18next.t('cw.contactMessage.contact')}:*\\n\\n_${i18next.t(\n          'cw.contactMessage.name',\n        )}:_ ${contact.displayName}`;\n\n        let numberCount = 1;\n        Object.keys(contactInfo).forEach((key) => {\n          if (key.startsWith('item') && key.includes('TEL')) {\n            const phoneNumber = contactInfo[key];\n            formattedContact += `\\n_${i18next.t('cw.contactMessage.number')} (${numberCount}):_ ${phoneNumber}`;\n            numberCount++;\n          } else if (key.includes('TEL')) {\n            const phoneNumber = contactInfo[key];\n            formattedContact += `\\n_${i18next.t('cw.contactMessage.number')} (${numberCount}):_ ${phoneNumber}`;\n            numberCount++;\n          }\n        });\n\n        return formattedContact;\n      });\n\n      const formattedContactsArray = formattedContacts.join('\\n\\n');\n\n      return formattedContactsArray;\n    }\n\n    if (typeKey === 'listMessage') {\n      const listTitle = result?.title || 'Unknown';\n      const listDescription = result?.description || 'Unknown';\n      const listFooter = result?.footerText || 'Unknown';\n\n      let formattedList =\n        '*List Menu:*\\n\\n' +\n        '_Title_: ' +\n        listTitle +\n        '\\n' +\n        '_Description_: ' +\n        listDescription +\n        '\\n' +\n        '_Footer_: ' +\n        listFooter;\n\n      if (result.sections && result.sections.length > 0) {\n        result.sections.forEach((section, sectionIndex) => {\n          formattedList += '\\n\\n*Section ' + (sectionIndex + 1) + ':* ' + section.title || 'Unknown\\n';\n\n          if (section.rows && section.rows.length > 0) {\n            section.rows.forEach((row, rowIndex) => {\n              formattedList += '\\n*Line ' + (rowIndex + 1) + ':*\\n';\n              formattedList += '_ Title:_ ' + (row.title || 'Unknown') + '\\n';\n              formattedList += '_ Description:_ ' + (row.description || 'Unknown') + '\\n';\n              formattedList += '_ ID:_ ' + (row.rowId || 'Unknown') + '\\n';\n            });\n          } else {\n            formattedList += '\\nNo lines found in this section.\\n';\n          }\n        });\n      } else {\n        formattedList += '\\nNo sections found.\\n';\n      }\n\n      return formattedList;\n    }\n\n    if (typeKey === 'listResponseMessage') {\n      const responseTitle = result?.title || 'Unknown';\n      const responseDescription = result?.description || 'Unknown';\n      const responseRowId = result?.singleSelectReply?.selectedRowId || 'Unknown';\n\n      const formattedResponseList =\n        '*List Response:*\\n\\n' +\n        '_Title_: ' +\n        responseTitle +\n        '\\n' +\n        '_Description_: ' +\n        responseDescription +\n        '\\n' +\n        '_ID_: ' +\n        responseRowId;\n      return formattedResponseList;\n    }\n\n    return result;\n  }\n\n  public getConversationMessage(msg: any) {\n    const types = this.getTypeMessage(msg);\n\n    const messageContent = this.getMessageContent(types);\n\n    return messageContent;\n  }\n\n  public async eventWhatsapp(event: string, instance: InstanceDto, body: any) {\n    try {\n      const waInstance = this.waMonitor.waInstances[instance.instanceName];\n\n      if (!waInstance) {\n        this.logger.warn('wa instance not found');\n        return null;\n      }\n\n      const client = await this.clientCw(instance);\n\n      if (!client) {\n        this.logger.warn('client not found');\n        return null;\n      }\n\n      if (this.provider?.ignoreJids && this.provider?.ignoreJids.length > 0) {\n        const ignoreJids: any = this.provider?.ignoreJids;\n\n        let ignoreGroups = false;\n        let ignoreContacts = false;\n\n        if (ignoreJids.includes('@g.us')) {\n          ignoreGroups = true;\n        }\n\n        if (ignoreJids.includes('@s.whatsapp.net')) {\n          ignoreContacts = true;\n        }\n\n        if (ignoreGroups && body?.key?.remoteJid.endsWith('@g.us')) {\n          this.logger.warn('Ignoring message from group: ' + body?.key?.remoteJid);\n          return;\n        }\n\n        if (ignoreContacts && body?.key?.remoteJid.endsWith('@s.whatsapp.net')) {\n          this.logger.warn('Ignoring message from contact: ' + body?.key?.remoteJid);\n          return;\n        }\n\n        if (ignoreJids.includes(body?.key?.remoteJid)) {\n          this.logger.warn('Ignoring message from jid: ' + body?.key?.remoteJid);\n          return;\n        }\n      }\n\n      if (event === 'messages.upsert' || event === 'send.message') {\n        this.logger.info(`[${event}] New message received - Instance: ${JSON.stringify(body, null, 2)}`);\n        if (body.key.remoteJid === 'status@broadcast') {\n          return;\n        }\n\n        if (body.message?.ephemeralMessage?.message) {\n          body.message = {\n            ...body.message?.ephemeralMessage?.message,\n          };\n        }\n\n        const originalMessage = await this.getConversationMessage(body.message);\n        const bodyMessage = originalMessage\n          ? originalMessage\n              .replaceAll(/\\*((?!\\s)([^\\n*]+?)(?<!\\s))\\*/g, '**$1**')\n              .replaceAll(/_((?!\\s)([^\\n_]+?)(?<!\\s))_/g, '*$1*')\n              .replaceAll(/~((?!\\s)([^\\n~]+?)(?<!\\s))~/g, '~~$1~~')\n          : originalMessage;\n\n        if (bodyMessage && bodyMessage.includes('/survey/responses/') && bodyMessage.includes('http')) {\n          return;\n        }\n\n        const quotedId = body.contextInfo?.stanzaId || body.message?.contextInfo?.stanzaId;\n\n        let quotedMsg = null;\n\n        if (quotedId)\n          quotedMsg = await this.prismaRepository.message.findFirst({\n            where: {\n              key: {\n                path: ['id'],\n                equals: quotedId,\n              },\n              chatwootMessageId: {\n                not: null,\n              },\n            },\n          });\n\n        const isMedia = this.isMediaMessage(body.message);\n\n        const adsMessage = this.getAdsMessage(body);\n\n        const reactionMessage = this.getReactionMessage(body.message);\n        const isInteractiveButtonMessage = this.isInteractiveButtonMessage(body.messageType, body.message);\n\n        if (!bodyMessage && !isMedia && !reactionMessage && !isInteractiveButtonMessage) {\n          this.logger.warn('no body message found');\n          return;\n        }\n\n        const getConversation = await this.createConversation(instance, body);\n\n        if (!getConversation) {\n          this.logger.warn('conversation not found');\n          return;\n        }\n\n        const messageType = body.key.fromMe ? 'outgoing' : 'incoming';\n\n        if (isMedia) {\n          const downloadBase64 = await waInstance?.getBase64FromMediaMessage({\n            message: {\n              ...body,\n            },\n          });\n\n          let nameFile: string;\n          const messageBody = body?.message[body?.messageType];\n          const originalFilename =\n            messageBody?.fileName || messageBody?.filename || messageBody?.message?.documentMessage?.fileName;\n          if (originalFilename) {\n            const parsedFile = path.parse(originalFilename);\n            if (parsedFile.name && parsedFile.ext) {\n              nameFile = `${parsedFile.name}-${Math.floor(Math.random() * (99 - 10 + 1) + 10)}${parsedFile.ext}`;\n            }\n          }\n\n          if (!nameFile) {\n            nameFile = `${Math.random().toString(36).substring(7)}.${mimeTypes.extension(downloadBase64.mimetype) || ''}`;\n          }\n\n          const fileData = Buffer.from(downloadBase64.base64, 'base64');\n\n          const fileStream = new Readable();\n          fileStream._read = () => {};\n          fileStream.push(fileData);\n          fileStream.push(null);\n\n          if (body.key.remoteJid.includes('@g.us')) {\n            const participantName = body.pushName;\n            const rawPhoneNumber =\n              body.key.addressingMode === 'lid' && !body.key.fromMe && body.key.participantAlt\n                ? body.key.participantAlt.split('@')[0].split(':')[0]\n                : body.key.participant.split('@')[0].split(':')[0];\n            const formattedPhoneNumber = parsePhoneNumberFromString(`+${rawPhoneNumber}`).formatInternational();\n\n            let content: string;\n\n            if (!body.key.fromMe) {\n              content = bodyMessage\n                ? `**${formattedPhoneNumber} - ${participantName}:**\\n\\n${bodyMessage}`\n                : `**${formattedPhoneNumber} - ${participantName}:**`;\n            } else {\n              content = bodyMessage || '';\n            }\n\n            const send = await this.sendData(\n              getConversation,\n              fileStream,\n              nameFile,\n              messageType,\n              content,\n              instance,\n              body,\n              'WAID:' + body.key.id,\n              quotedMsg,\n            );\n\n            if (!send) {\n              this.logger.warn('message not sent');\n              return;\n            }\n\n            return send;\n          } else {\n            const send = await this.sendData(\n              getConversation,\n              fileStream,\n              nameFile,\n              messageType,\n              bodyMessage,\n              instance,\n              body,\n              'WAID:' + body.key.id,\n              quotedMsg,\n            );\n\n            if (!send) {\n              this.logger.warn('message not sent');\n              return;\n            }\n\n            return send;\n          }\n        }\n\n        if (reactionMessage) {\n          if (reactionMessage.text) {\n            const send = await this.createMessage(\n              instance,\n              getConversation,\n              reactionMessage.text,\n              messageType,\n              false,\n              [],\n              {\n                message: { extendedTextMessage: { contextInfo: { stanzaId: reactionMessage.key.id } } },\n              },\n              'WAID:' + body.key.id,\n              quotedMsg,\n            );\n            if (!send) {\n              this.logger.warn('message not sent');\n              return;\n            }\n          }\n\n          return;\n        }\n\n        if (isInteractiveButtonMessage) {\n          const buttons = body.message.interactiveMessage.nativeFlowMessage.buttons;\n          this.logger.info('is Interactive Button Message: ' + JSON.stringify(buttons));\n\n          for (const button of buttons) {\n            const buttonParams = JSON.parse(button.buttonParamsJson);\n            const paymentSettings = buttonParams.payment_settings;\n\n            if (button.name === 'payment_info' && paymentSettings[0].type === 'pix_static_code') {\n              const pixSettings = paymentSettings[0].pix_static_code;\n              const pixKeyType = (() => {\n                switch (pixSettings.key_type) {\n                  case 'EVP':\n                    return 'Chave Aleatria';\n                  case 'EMAIL':\n                    return 'E-mail';\n                  case 'PHONE':\n                    return 'Telefone';\n                  default:\n                    return pixSettings.key_type;\n                }\n              })();\n              const pixKey = pixSettings.key_type === 'PHONE' ? pixSettings.key.replace('+55', '') : pixSettings.key;\n              const content = `*${pixSettings.merchant_name}*\\nChave PIX: ${pixKey} (${pixKeyType})`;\n\n              const send = await this.createMessage(\n                instance,\n                getConversation,\n                content,\n                messageType,\n                false,\n                [],\n                body,\n                'WAID:' + body.key.id,\n                quotedMsg,\n              );\n              if (!send) this.logger.warn('message not sent');\n            } else {\n              this.logger.warn('Interactive Button Message not mapped');\n            }\n          }\n          return;\n        }\n\n        const isAdsMessage = (adsMessage && adsMessage.title) || adsMessage.body || adsMessage.thumbnailUrl;\n        if (isAdsMessage) {\n          const imgBuffer = await axios.get(adsMessage.thumbnailUrl, { responseType: 'arraybuffer' });\n\n          const extension = mimeTypes.extension(imgBuffer.headers['content-type']);\n          const mimeType = extension && mimeTypes.lookup(extension);\n\n          if (!mimeType) {\n            this.logger.warn('mimetype of Ads message not found');\n            return;\n          }\n\n          const random = Math.random().toString(36).substring(7);\n          const nameFile = `${random}.${mimeTypes.extension(mimeType)}`;\n          const fileData = Buffer.from(imgBuffer.data, 'binary');\n\n          const img = await Jimp.read(fileData);\n          await img.cover({\n            w: 320,\n            h: 180,\n          });\n          const processedBuffer = await img.getBuffer(JimpMime.png);\n\n          const fileStream = new Readable();\n          fileStream._read = () => {}; // _read is required but you can noop it\n          fileStream.push(processedBuffer);\n          fileStream.push(null);\n\n          const truncStr = (str: string, len: number) => {\n            if (!str) return '';\n\n            return str.length > len ? str.substring(0, len) + '...' : str;\n          };\n\n          const title = truncStr(adsMessage.title, 40);\n          const description = truncStr(adsMessage?.body, 75);\n\n          const send = await this.sendData(\n            getConversation,\n            fileStream,\n            nameFile,\n            messageType,\n            `${bodyMessage}\\n\\n\\n**${title}**\\n${description}\\n${adsMessage.sourceUrl}`,\n            instance,\n            body,\n            'WAID:' + body.key.id,\n          );\n\n          if (!send) {\n            this.logger.warn('message not sent');\n            return;\n          }\n\n          return send;\n        }\n\n        if (body.key.remoteJid.includes('@g.us')) {\n          const participantName = body.pushName;\n          const rawPhoneNumber =\n            body.key.addressingMode === 'lid' && !body.key.fromMe && body.key.participantAlt\n              ? body.key.participantAlt.split('@')[0].split(':')[0]\n              : body.key.participant.split('@')[0].split(':')[0];\n          const formattedPhoneNumber = parsePhoneNumberFromString(`+${rawPhoneNumber}`).formatInternational();\n\n          let content: string;\n\n          if (!body.key.fromMe) {\n            content = `**${formattedPhoneNumber} - ${participantName}:**\\n\\n${bodyMessage}`;\n          } else {\n            content = `${bodyMessage}`;\n          }\n\n          const send = await this.createMessage(\n            instance,\n            getConversation,\n            content,\n            messageType,\n            false,\n            [],\n            body,\n            'WAID:' + body.key.id,\n            quotedMsg,\n          );\n\n          if (!send) {\n            this.logger.warn('message not sent');\n            return;\n          }\n\n          return send;\n        } else {\n          const send = await this.createMessage(\n            instance,\n            getConversation,\n            bodyMessage,\n            messageType,\n            false,\n            [],\n            body,\n            'WAID:' + body.key.id,\n            quotedMsg,\n          );\n\n          if (!send) {\n            this.logger.warn('message not sent');\n            return;\n          }\n\n          return send;\n        }\n      }\n\n      if (event === Events.MESSAGES_DELETE) {\n        const chatwootDelete = this.configService.get<Chatwoot>('CHATWOOT').MESSAGE_DELETE;\n\n        if (chatwootDelete === true) {\n          if (!body?.key?.id) {\n            this.logger.warn('message id not found');\n            return;\n          }\n\n          const message = await this.getMessageByKeyId(instance, body.key.id);\n\n          if (message?.chatwootMessageId && message?.chatwootConversationId) {\n            await this.prismaRepository.message.deleteMany({\n              where: {\n                key: {\n                  path: ['id'],\n                  equals: body.key.id,\n                },\n                instanceId: instance.instanceId,\n              },\n            });\n\n            return await client.messages.delete({\n              accountId: this.provider.accountId,\n              conversationId: message.chatwootConversationId,\n              messageId: message.chatwootMessageId,\n            });\n          }\n        }\n      }\n\n      if (event === 'messages.edit' || event === 'send.message.update') {\n        const editedMessageContentRaw =\n          body?.editedMessage?.conversation ??\n          body?.editedMessage?.extendedTextMessage?.text ??\n          body?.editedMessage?.imageMessage?.caption ??\n          body?.editedMessage?.videoMessage?.caption ??\n          body?.editedMessage?.documentMessage?.caption ??\n          (typeof body?.text === 'string' ? body.text : undefined);\n\n        const editedMessageContent = (editedMessageContentRaw ?? '').trim();\n\n        if (!editedMessageContent) {\n          this.logger.info('[CW.EDIT] Contedo vazio  ignorando (DELETE tratar se for revoke).');\n          return;\n        }\n\n        const message = await this.getMessageByKeyId(instance, body?.key?.id);\n\n        if (!message) {\n          this.logger.warn('Message not found for edit event');\n          return;\n        }\n\n        const key = message.key as WAMessageKey;\n\n        const messageType = key?.fromMe ? 'outgoing' : 'incoming';\n\n        if (message && message.chatwootConversationId && message.chatwootMessageId) {\n          // Criar nova mensagem com formato: \"Mensagem editada:\\n\\nteste1\"\n          const editedText = `\\n\\n\\`${i18next.t('cw.message.edited')}:\\`\\n\\n${editedMessageContent}`;\n\n          const send = await this.createMessage(\n            instance,\n            message.chatwootConversationId,\n            editedText,\n            messageType,\n            false,\n            [],\n            {\n              message: { extendedTextMessage: { contextInfo: { stanzaId: key.id } } },\n            },\n            'WAID:' + body.key.id,\n            null,\n          );\n          if (!send) {\n            this.logger.warn('edited message not sent');\n            return;\n          }\n        }\n        return;\n      }\n\n      if (event === 'messages.read') {\n        if (!body?.key?.id || !body?.key?.remoteJid) {\n          this.logger.warn('message id not found');\n          return;\n        }\n\n        const message = await this.getMessageByKeyId(instance, body.key.id);\n        const conversationId = message?.chatwootConversationId;\n        const contactInboxSourceId = message?.chatwootContactInboxSourceId;\n\n        if (conversationId) {\n          let sourceId = contactInboxSourceId;\n          const inbox = (await this.getInbox(instance)) as inbox & {\n            inbox_identifier?: string;\n          };\n\n          if (!sourceId && inbox) {\n            const conversation = (await client.conversations.get({\n              accountId: this.provider.accountId,\n              conversationId: conversationId,\n            })) as conversation_show & {\n              last_non_activity_message: { conversation: { contact_inbox: contact_inboxes } };\n            };\n            sourceId = conversation.last_non_activity_message?.conversation?.contact_inbox?.source_id;\n          }\n\n          if (sourceId && inbox?.inbox_identifier) {\n            const url =\n              `/public/api/v1/inboxes/${inbox.inbox_identifier}/contacts/${sourceId}` +\n              `/conversations/${conversationId}/update_last_seen`;\n            await chatwootRequest(this.getClientCwConfig(), {\n              method: 'POST',\n              url: url,\n            });\n          }\n        }\n        return;\n      }\n\n      if (event === 'status.instance') {\n        const data = body;\n        const inbox = await this.getInbox(instance);\n\n        if (!inbox) {\n          this.logger.warn('inbox not found');\n          return;\n        }\n\n        const msgStatus = i18next.t('cw.inbox.status', {\n          inboxName: inbox.name,\n          state: data.status,\n        });\n\n        await this.createBotMessage(instance, msgStatus, 'incoming');\n      }\n\n      if (event === 'connection.update' && body.status === 'open') {\n        const waInstance = this.waMonitor.waInstances[instance.instanceName];\n        if (!waInstance) return;\n\n        const now = Date.now();\n        const timeSinceLastNotification = now - (waInstance.lastConnectionNotification || 0);\n\n        // Se a conexo foi estabelecida via QR code, notifica imediatamente.\n        if (waInstance.qrCode && waInstance.qrCode.count > 0) {\n          const msgConnection = i18next.t('cw.inbox.connected');\n          await this.createBotMessage(instance, msgConnection, 'incoming');\n          waInstance.qrCode.count = 0;\n          waInstance.lastConnectionNotification = now;\n          chatwootImport.clearAll(instance);\n        }\n        // Se no foi via QR code, verifica o throttling.\n        else if (timeSinceLastNotification >= 30000) {\n          const msgConnection = i18next.t('cw.inbox.connected');\n          await this.createBotMessage(instance, msgConnection, 'incoming');\n          waInstance.lastConnectionNotification = now;\n        } else {\n          this.logger.warn(\n            `Connection notification skipped for ${instance.instanceName} - too frequent (${timeSinceLastNotification}ms since last)`,\n          );\n        }\n      }\n\n      if (event === 'qrcode.updated') {\n        if (body.statusCode === 500) {\n          const erroQRcode = ` ${i18next.t('qrlimitreached')}`;\n          return await this.createBotMessage(instance, erroQRcode, 'incoming');\n        } else {\n          const fileData = Buffer.from(body?.qrcode.base64.replace('data:image/png;base64,', ''), 'base64');\n\n          const fileStream = new Readable();\n          fileStream._read = () => {};\n          fileStream.push(fileData);\n          fileStream.push(null);\n\n          await this.createBotQr(\n            instance,\n            i18next.t('qrgeneratedsuccesfully'),\n            'incoming',\n            fileStream,\n            `${instance.instanceName}.png`,\n          );\n\n          let msgQrCode = `${i18next.t('qrgeneratedsuccesfully')}\\n\\n${i18next.t('scanqr')}`;\n\n          if (body?.qrcode?.pairingCode) {\n            msgQrCode =\n              msgQrCode +\n              `\\n\\n*Pairing Code:* ${body.qrcode.pairingCode.substring(0, 4)}-${body.qrcode.pairingCode.substring(\n                4,\n                8,\n              )}`;\n          }\n\n          await this.createBotMessage(instance, msgQrCode, 'incoming');\n        }\n      }\n    } catch (error) {\n      this.logger.error(error);\n    }\n  }\n\n  public normalizeJidIdentifier(remoteJid: string) {\n    if (!remoteJid) {\n      return '';\n    }\n    if (remoteJid.includes('@lid')) {\n      return remoteJid;\n    }\n    return remoteJid.replace(/:\\d+/, '').split('@')[0];\n  }\n\n  public startImportHistoryMessages(instance: InstanceDto) {\n    if (!this.isImportHistoryAvailable()) {\n      return;\n    }\n\n    this.createBotMessage(instance, i18next.t('cw.import.startImport'), 'incoming');\n  }\n\n  public isImportHistoryAvailable() {\n    const uri = this.configService.get<Chatwoot>('CHATWOOT').IMPORT.DATABASE.CONNECTION.URI;\n\n    return uri && uri !== 'postgres://user:password@hostname:port/dbname';\n  }\n\n  public addHistoryMessages(instance: InstanceDto, messagesRaw: MessageModel[]) {\n    if (!this.isImportHistoryAvailable()) {\n      return;\n    }\n\n    chatwootImport.addHistoryMessages(instance, messagesRaw);\n  }\n\n  public addHistoryContacts(instance: InstanceDto, contactsRaw: ContactModel[]) {\n    if (!this.isImportHistoryAvailable()) {\n      return;\n    }\n\n    return chatwootImport.addHistoryContacts(instance, contactsRaw);\n  }\n\n  public async importHistoryMessages(instance: InstanceDto) {\n    if (!this.isImportHistoryAvailable()) {\n      return;\n    }\n\n    this.createBotMessage(instance, i18next.t('cw.import.importingMessages'), 'incoming');\n\n    const totalMessagesImported = await chatwootImport.importHistoryMessages(\n      instance,\n      this,\n      await this.getInbox(instance),\n      this.provider,\n    );\n    this.updateContactAvatarInRecentConversations(instance);\n\n    const msg = Number.isInteger(totalMessagesImported)\n      ? i18next.t('cw.import.messagesImported', { totalMessagesImported })\n      : i18next.t('cw.import.messagesException');\n\n    this.createBotMessage(instance, msg, 'incoming');\n\n    return totalMessagesImported;\n  }\n\n  public async updateContactAvatarInRecentConversations(instance: InstanceDto, limitContacts = 100) {\n    try {\n      if (!this.isImportHistoryAvailable()) {\n        return;\n      }\n\n      const client = await this.clientCw(instance);\n      if (!client) {\n        this.logger.warn('client not found');\n        return null;\n      }\n\n      const inbox = await this.getInbox(instance);\n      if (!inbox) {\n        this.logger.warn('inbox not found');\n        return null;\n      }\n\n      const recentContacts = await chatwootImport.getContactsOrderByRecentConversations(\n        inbox,\n        this.provider,\n        limitContacts,\n      );\n\n      const contactIdentifiers = recentContacts\n        .map((contact) => contact.identifier)\n        .filter((identifier) => identifier !== null);\n\n      const contactsWithProfilePicture = (\n        await this.prismaRepository.contact.findMany({\n          where: {\n            instanceId: instance.instanceId,\n            id: {\n              in: contactIdentifiers,\n            },\n            profilePicUrl: {\n              not: null,\n            },\n          },\n        })\n      ).reduce((acc: Map<string, ContactModel>, contact: ContactModel) => acc.set(contact.id, contact), new Map());\n\n      recentContacts.forEach(async (contact) => {\n        if (contactsWithProfilePicture.has(contact.identifier)) {\n          client.contacts.update({\n            accountId: this.provider.accountId,\n            id: contact.id,\n            data: {\n              avatar_url: contactsWithProfilePicture.get(contact.identifier).profilePictureUrl || null,\n            },\n          });\n        }\n      });\n    } catch (error) {\n      this.logger.error(`Error on update avatar in recent conversations: ${error.toString()}`);\n    }\n  }\n\n  public async syncLostMessages(\n    instance: InstanceDto,\n    chatwootConfig: ChatwootDto,\n    prepareMessage: (message: any) => any,\n  ) {\n    try {\n      if (!this.isImportHistoryAvailable()) {\n        return;\n      }\n      if (!this.configService.get<Database>('DATABASE').SAVE_DATA.MESSAGE_UPDATE) {\n        return;\n      }\n\n      const inbox = await this.getInbox(instance);\n\n      const sqlMessages = `select * from messages m\n      where account_id = ${chatwootConfig.accountId}\n      and inbox_id = ${inbox.id}\n      and created_at >= now() - interval '6h'\n      order by created_at desc`;\n\n      const messagesData = (await this.pgClient.query(sqlMessages))?.rows;\n      const ids: string[] = messagesData\n        .filter((message) => !!message.source_id)\n        .map((message) => message.source_id.replace('WAID:', ''));\n\n      const savedMessages = await this.prismaRepository.message.findMany({\n        where: {\n          Instance: { name: instance.instanceName },\n          messageTimestamp: { gte: Number(dayjs().subtract(6, 'hours').unix()) },\n          AND: ids.map((id) => ({ key: { path: ['id'], not: id } })),\n        },\n      });\n\n      const filteredMessages = savedMessages.filter(\n        (msg: any) => !chatwootImport.isIgnorePhoneNumber(msg.key?.remoteJid),\n      );\n      const messagesRaw: any[] = [];\n      for (const m of filteredMessages) {\n        if (!m.message || !m.key || !m.messageTimestamp) {\n          continue;\n        }\n\n        if (Long.isLong(m?.messageTimestamp)) {\n          m.messageTimestamp = m.messageTimestamp?.toNumber();\n        }\n\n        messagesRaw.push(prepareMessage(m as any));\n      }\n\n      this.addHistoryMessages(\n        instance,\n        messagesRaw.filter((msg) => !chatwootImport.isIgnorePhoneNumber(msg.key?.remoteJid)),\n      );\n\n      await chatwootImport.importHistoryMessages(instance, this, inbox, this.provider);\n      const waInstance = this.waMonitor.waInstances[instance.instanceName];\n      waInstance.clearCacheChatwoot();\n    } catch {\n      return;\n    }\n  }\n}\n","import { ConfigService, Language } from '@config/env.config';\nimport fs from 'fs';\nimport i18next from 'i18next';\nimport path from 'path';\n\nconst languages = ['en', 'pt-BR', 'es'];\nconst translationsPath = path.join(__dirname, 'translations');\nconst configService: ConfigService = new ConfigService();\n\nconst resources: any = {};\n\nlanguages.forEach((language) => {\n  const languagePath = path.join(translationsPath, `${language}.json`);\n  if (fs.existsSync(languagePath)) {\n    const translationContent = fs.readFileSync(languagePath, 'utf8');\n    resources[language] = {\n      translation: JSON.parse(translationContent),\n    };\n  }\n});\n\ni18next.init({\n  resources,\n  fallbackLng: 'en',\n  lng: configService.get<Language>('LANGUAGE'),\n  debug: false,\n\n  interpolation: {\n    escapeValue: false,\n  },\n});\nexport default i18next;\n","import { configService, Telemetry } from '@config/env.config';\nimport axios from 'axios';\nimport fs from 'fs';\n\nconst packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));\n\nexport interface TelemetryData {\n  route: string;\n  apiVersion: string;\n  timestamp: Date;\n}\n\nexport const sendTelemetry = async (route: string): Promise<void> => {\n  const telemetryConfig = configService.get<Telemetry>('TELEMETRY');\n\n  if (!telemetryConfig.ENABLED) {\n    return;\n  }\n\n  if (route === '/') {\n    return;\n  }\n\n  const telemetry: TelemetryData = {\n    route,\n    apiVersion: `${packageJson.version}`,\n    timestamp: new Date(),\n  };\n\n  const url =\n    telemetryConfig.URL && telemetryConfig.URL !== '' ? telemetryConfig.URL : 'https://log.evolution-api.com/telemetry';\n\n  axios\n    .post(url, telemetry)\n    .then(() => {})\n    .catch(() => {});\n};\n"],"mappings":"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","names":["isBooleanString","dotenv","dotenv","config","ConfigService","env","loadEnv","get","key","envProcess","PRODUCTION","process","NODE_ENV","DOCKER_ENV","SERVER","TYPE","SERVER_TYPE","PORT","Number","parseInt","SERVER_PORT","NAME","SERVER_NAME","URL","SERVER_URL","DISABLE_DOCS","SERVER_DISABLE_DOCS","DISABLE_MANAGER","SERVER_DISABLE_MANAGER","CORS","ORIGIN","CORS_ORIGIN","split","METHODS","CORS_METHODS","CREDENTIALS","CORS_CREDENTIALS","SSL_CONF","PRIVKEY","SSL_CONF_PRIVKEY","FULLCHAIN","SSL_CONF_FULLCHAIN","PROVIDER","ENABLED","PROVIDER_ENABLED","HOST","PROVIDER_HOST","PROVIDER_PORT","PREFIX","PROVIDER_PREFIX","DATABASE","CONNECTION","URI","DATABASE_CONNECTION_URI","CLIENT_NAME","DATABASE_CONNECTION_CLIENT_NAME","DATABASE_PROVIDER","SAVE_DATA","INSTANCE","DATABASE_SAVE_DATA_INSTANCE","NEW_MESSAGE","DATABASE_SAVE_DATA_NEW_MESSAGE","MESSAGE_UPDATE","DATABASE_SAVE_MESSAGE_UPDATE","CONTACTS","DATABASE_SAVE_DATA_CONTACTS","CHATS","DATABASE_SAVE_DATA_CHATS","HISTORIC","DATABASE_SAVE_DATA_HISTORIC","LABELS","DATABASE_SAVE_DATA_LABELS","IS_ON_WHATSAPP","DATABASE_SAVE_IS_ON_WHATSAPP","IS_ON_WHATSAPP_DAYS","DATABASE_SAVE_IS_ON_WHATSAPP_DAYS","DELETE_DATA","LOGICAL_MESSAGE_DELETE","DATABASE_DELETE_MESSAGE","RABBITMQ","RABBITMQ_ENABLED","GLOBAL_ENABLED","RABBITMQ_GLOBAL_ENABLED","PREFIX_KEY","RABBITMQ_PREFIX_KEY","EXCHANGE_NAME","RABBITMQ_EXCHANGE_NAME","RABBITMQ_URI","FRAME_MAX","RABBITMQ_FRAME_MAX","EVENTS","APPLICATION_STARTUP","RABBITMQ_EVENTS_APPLICATION_STARTUP","INSTANCE_CREATE","RABBITMQ_EVENTS_INSTANCE_CREATE","INSTANCE_DELETE","RABBITMQ_EVENTS_INSTANCE_DELETE","QRCODE_UPDATED","RABBITMQ_EVENTS_QRCODE_UPDATED","MESSAGES_SET","RABBITMQ_EVENTS_MESSAGES_SET","MESSAGES_UPSERT","RABBITMQ_EVENTS_MESSAGES_UPSERT","MESSAGES_EDITED","RABBITMQ_EVENTS_MESSAGES_EDITED","MESSAGES_UPDATE","RABBITMQ_EVENTS_MESSAGES_UPDATE","MESSAGES_DELETE","RABBITMQ_EVENTS_MESSAGES_DELETE","SEND_MESSAGE","RABBITMQ_EVENTS_SEND_MESSAGE","SEND_MESSAGE_UPDATE","RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE","CONTACTS_SET","RABBITMQ_EVENTS_CONTACTS_SET","CONTACTS_UPDATE","RABBITMQ_EVENTS_CONTACTS_UPDATE","CONTACTS_UPSERT","RABBITMQ_EVENTS_CONTACTS_UPSERT","PRESENCE_UPDATE","RABBITMQ_EVENTS_PRESENCE_UPDATE","CHATS_SET","RABBITMQ_EVENTS_CHATS_SET","CHATS_UPDATE","RABBITMQ_EVENTS_CHATS_UPDATE","CHATS_UPSERT","RABBITMQ_EVENTS_CHATS_UPSERT","CHATS_DELETE","RABBITMQ_EVENTS_CHATS_DELETE","CONNECTION_UPDATE","RABBITMQ_EVENTS_CONNECTION_UPDATE","LABELS_EDIT","RABBITMQ_EVENTS_LABELS_EDIT","LABELS_ASSOCIATION","RABBITMQ_EVENTS_LABELS_ASSOCIATION","GROUPS_UPSERT","RABBITMQ_EVENTS_GROUPS_UPSERT","GROUP_UPDATE","RABBITMQ_EVENTS_GROUPS_UPDATE","GROUP_PARTICIPANTS_UPDATE","RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE","CALL","RABBITMQ_EVENTS_CALL","TYPEBOT_START","RABBITMQ_EVENTS_TYPEBOT_START","TYPEBOT_CHANGE_STATUS","RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS","NATS","NATS_ENABLED","NATS_GLOBAL_ENABLED","NATS_PREFIX_KEY","NATS_EXCHANGE_NAME","NATS_URI","NATS_EVENTS_APPLICATION_STARTUP","NATS_EVENTS_INSTANCE_CREATE","NATS_EVENTS_INSTANCE_DELETE","NATS_EVENTS_QRCODE_UPDATED","NATS_EVENTS_MESSAGES_SET","NATS_EVENTS_MESSAGES_UPSERT","NATS_EVENTS_MESSAGES_EDITED","NATS_EVENTS_MESSAGES_UPDATE","NATS_EVENTS_MESSAGES_DELETE","NATS_EVENTS_SEND_MESSAGE","NATS_EVENTS_SEND_MESSAGE_UPDATE","NATS_EVENTS_CONTACTS_SET","NATS_EVENTS_CONTACTS_UPDATE","NATS_EVENTS_CONTACTS_UPSERT","NATS_EVENTS_PRESENCE_UPDATE","NATS_EVENTS_CHATS_SET","NATS_EVENTS_CHATS_UPDATE","NATS_EVENTS_CHATS_UPSERT","NATS_EVENTS_CHATS_DELETE","NATS_EVENTS_CONNECTION_UPDATE","NATS_EVENTS_LABELS_EDIT","NATS_EVENTS_LABELS_ASSOCIATION","NATS_EVENTS_GROUPS_UPSERT","NATS_EVENTS_GROUPS_UPDATE","NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE","NATS_EVENTS_CALL","NATS_EVENTS_TYPEBOT_START","NATS_EVENTS_TYPEBOT_CHANGE_STATUS","SQS","SQS_ENABLED","SQS_GLOBAL_ENABLED","GLOBAL_FORCE_SINGLE_QUEUE","SQS_GLOBAL_FORCE_SINGLE_QUEUE","GLOBAL_PREFIX_NAME","SQS_GLOBAL_PREFIX_NAME","ACCESS_KEY_ID","SQS_ACCESS_KEY_ID","SECRET_ACCESS_KEY","SQS_SECRET_ACCESS_KEY","ACCOUNT_ID","SQS_ACCOUNT_ID","REGION","SQS_REGION","MAX_PAYLOAD_SIZE","SQS_MAX_PAYLOAD_SIZE","SQS_GLOBAL_APPLICATION_STARTUP","SQS_GLOBAL_CALL","SQS_GLOBAL_CHATS_DELETE","SQS_GLOBAL_CHATS_SET","SQS_GLOBAL_CHATS_UPDATE","SQS_GLOBAL_CHATS_UPSERT","SQS_GLOBAL_CONNECTION_UPDATE","SQS_GLOBAL_CONTACTS_SET","SQS_GLOBAL_CONTACTS_UPDATE","SQS_GLOBAL_CONTACTS_UPSERT","SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE","GROUPS_UPDATE","SQS_GLOBAL_GROUPS_UPDATE","SQS_GLOBAL_GROUPS_UPSERT","SQS_GLOBAL_LABELS_ASSOCIATION","SQS_GLOBAL_LABELS_EDIT","LOGOUT_INSTANCE","SQS_GLOBAL_LOGOUT_INSTANCE","SQS_GLOBAL_MESSAGES_DELETE","SQS_GLOBAL_MESSAGES_EDITED","SQS_GLOBAL_MESSAGES_SET","SQS_GLOBAL_MESSAGES_UPDATE","SQS_GLOBAL_MESSAGES_UPSERT","SQS_GLOBAL_PRESENCE_UPDATE","SQS_GLOBAL_QRCODE_UPDATED","REMOVE_INSTANCE","SQS_GLOBAL_REMOVE_INSTANCE","SQS_GLOBAL_SEND_MESSAGE","SQS_GLOBAL_TYPEBOT_CHANGE_STATUS","SQS_GLOBAL_TYPEBOT_START","KAFKA","KAFKA_ENABLED","CLIENT_ID","KAFKA_CLIENT_ID","BROKERS","KAFKA_BROKERS","CONNECTION_TIMEOUT","KAFKA_CONNECTION_TIMEOUT","REQUEST_TIMEOUT","KAFKA_REQUEST_TIMEOUT","KAFKA_GLOBAL_ENABLED","CONSUMER_GROUP_ID","KAFKA_CONSUMER_GROUP_ID","TOPIC_PREFIX","KAFKA_TOPIC_PREFIX","NUM_PARTITIONS","KAFKA_NUM_PARTITIONS","REPLICATION_FACTOR","KAFKA_REPLICATION_FACTOR","AUTO_CREATE_TOPICS","KAFKA_AUTO_CREATE_TOPICS","KAFKA_EVENTS_APPLICATION_STARTUP","KAFKA_EVENTS_INSTANCE_CREATE","KAFKA_EVENTS_INSTANCE_DELETE","KAFKA_EVENTS_QRCODE_UPDATED","KAFKA_EVENTS_MESSAGES_SET","KAFKA_EVENTS_MESSAGES_UPSERT","KAFKA_EVENTS_MESSAGES_EDITED","KAFKA_EVENTS_MESSAGES_UPDATE","KAFKA_EVENTS_MESSAGES_DELETE","KAFKA_EVENTS_SEND_MESSAGE","KAFKA_EVENTS_SEND_MESSAGE_UPDATE","KAFKA_EVENTS_CONTACTS_SET","KAFKA_EVENTS_CONTACTS_UPSERT","KAFKA_EVENTS_CONTACTS_UPDATE","KAFKA_EVENTS_PRESENCE_UPDATE","KAFKA_EVENTS_CHATS_SET","KAFKA_EVENTS_CHATS_UPSERT","KAFKA_EVENTS_CHATS_UPDATE","KAFKA_EVENTS_CHATS_DELETE","KAFKA_EVENTS_CONNECTION_UPDATE","KAFKA_EVENTS_LABELS_EDIT","KAFKA_EVENTS_LABELS_ASSOCIATION","KAFKA_EVENTS_GROUPS_UPSERT","KAFKA_EVENTS_GROUPS_UPDATE","KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE","KAFKA_EVENTS_CALL","KAFKA_EVENTS_TYPEBOT_START","KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS","SASL","KAFKA_SASL_ENABLED","MECHANISM","KAFKA_SASL_MECHANISM","USERNAME","KAFKA_SASL_USERNAME","PASSWORD","KAFKA_SASL_PASSWORD","undefined","SSL","KAFKA_SSL_ENABLED","REJECT_UNAUTHORIZED","KAFKA_SSL_REJECT_UNAUTHORIZED","CA","KAFKA_SSL_CA","KEY","KAFKA_SSL_KEY","CERT","KAFKA_SSL_CERT","WEBSOCKET","WEBSOCKET_ENABLED","GLOBAL_EVENTS","WEBSOCKET_GLOBAL_EVENTS","ALLOWED_HOSTS","WEBSOCKET_ALLOWED_HOSTS","PUSHER","PUSHER_ENABLED","GLOBAL","PUSHER_GLOBAL_ENABLED","APP_ID","PUSHER_GLOBAL_APP_ID","PUSHER_GLOBAL_KEY","SECRET","PUSHER_GLOBAL_SECRET","CLUSTER","PUSHER_GLOBAL_CLUSTER","USE_TLS","PUSHER_GLOBAL_USE_TLS","PUSHER_EVENTS_APPLICATION_STARTUP","PUSHER_EVENTS_INSTANCE_CREATE","PUSHER_EVENTS_INSTANCE_DELETE","PUSHER_EVENTS_QRCODE_UPDATED","PUSHER_EVENTS_MESSAGES_SET","PUSHER_EVENTS_MESSAGES_UPSERT","PUSHER_EVENTS_MESSAGES_EDITED","PUSHER_EVENTS_MESSAGES_UPDATE","PUSHER_EVENTS_MESSAGES_DELETE","PUSHER_EVENTS_SEND_MESSAGE","PUSHER_EVENTS_SEND_MESSAGE_UPDATE","PUSHER_EVENTS_CONTACTS_SET","PUSHER_EVENTS_CONTACTS_UPDATE","PUSHER_EVENTS_CONTACTS_UPSERT","PUSHER_EVENTS_PRESENCE_UPDATE","PUSHER_EVENTS_CHATS_SET","PUSHER_EVENTS_CHATS_UPDATE","PUSHER_EVENTS_CHATS_UPSERT","PUSHER_EVENTS_CHATS_DELETE","PUSHER_EVENTS_CONNECTION_UPDATE","PUSHER_EVENTS_LABELS_EDIT","PUSHER_EVENTS_LABELS_ASSOCIATION","PUSHER_EVENTS_GROUPS_UPSERT","PUSHER_EVENTS_GROUPS_UPDATE","PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE","PUSHER_EVENTS_CALL","PUSHER_EVENTS_TYPEBOT_START","PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS","WA_BUSINESS","TOKEN_WEBHOOK","WA_BUSINESS_TOKEN_WEBHOOK","WA_BUSINESS_URL","VERSION","WA_BUSINESS_VERSION","LANGUAGE","WA_BUSINESS_LANGUAGE","LOG","LEVEL","LOG_LEVEL","COLOR","LOG_COLOR","BAILEYS","LOG_BAILEYS","DEL_INSTANCE","isBooleanString","DEL_TEMP_INSTANCES","WEBHOOK","WEBHOOK_GLOBAL_URL","WEBHOOK_GLOBAL_ENABLED","WEBHOOK_BY_EVENTS","WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS","WEBHOOK_EVENTS_APPLICATION_STARTUP","WEBHOOK_EVENTS_INSTANCE_CREATE","WEBHOOK_EVENTS_INSTANCE_DELETE","WEBHOOK_EVENTS_QRCODE_UPDATED","WEBHOOK_EVENTS_MESSAGES_SET","WEBHOOK_EVENTS_MESSAGES_UPSERT","WEBHOOK_EVENTS_MESSAGES_EDITED","WEBHOOK_EVENTS_MESSAGES_UPDATE","WEBHOOK_EVENTS_MESSAGES_DELETE","WEBHOOK_EVENTS_SEND_MESSAGE","WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE","WEBHOOK_EVENTS_CONTACTS_SET","WEBHOOK_EVENTS_CONTACTS_UPDATE","WEBHOOK_EVENTS_CONTACTS_UPSERT","WEBHOOK_EVENTS_PRESENCE_UPDATE","WEBHOOK_EVENTS_CHATS_SET","WEBHOOK_EVENTS_CHATS_UPDATE","WEBHOOK_EVENTS_CHATS_UPSERT","WEBHOOK_EVENTS_CHATS_DELETE","WEBHOOK_EVENTS_CONNECTION_UPDATE","WEBHOOK_EVENTS_LABELS_EDIT","WEBHOOK_EVENTS_LABELS_ASSOCIATION","WEBHOOK_EVENTS_GROUPS_UPSERT","WEBHOOK_EVENTS_GROUPS_UPDATE","WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE","WEBHOOK_EVENTS_CALL","WEBHOOK_EVENTS_TYPEBOT_START","WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS","ERRORS","WEBHOOK_EVENTS_ERRORS","ERRORS_WEBHOOK","WEBHOOK_EVENTS_ERRORS_WEBHOOK","REQUEST","TIMEOUT_MS","WEBHOOK_REQUEST_TIMEOUT_MS","RETRY","MAX_ATTEMPTS","WEBHOOK_RETRY_MAX_ATTEMPTS","INITIAL_DELAY_SECONDS","WEBHOOK_RETRY_INITIAL_DELAY_SECONDS","USE_EXPONENTIAL_BACKOFF","WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF","MAX_DELAY_SECONDS","WEBHOOK_RETRY_MAX_DELAY_SECONDS","JITTER_FACTOR","parseFloat","WEBHOOK_RETRY_JITTER_FACTOR","NON_RETRYABLE_STATUS_CODES","WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES","map","CONFIG_SESSION_PHONE","CLIENT","CONFIG_SESSION_PHONE_CLIENT","CONFIG_SESSION_PHONE_NAME","QRCODE","LIMIT","QRCODE_LIMIT","QRCODE_COLOR","TYPEBOT","TYPEBOT_ENABLED","API_VERSION","TYPEBOT_API_VERSION","SEND_MEDIA_BASE64","TYPEBOT_SEND_MEDIA_BASE64","CHATWOOT","CHATWOOT_ENABLED","MESSAGE_DELETE","CHATWOOT_MESSAGE_DELETE","MESSAGE_READ","CHATWOOT_MESSAGE_READ","BOT_CONTACT","CHATWOOT_BOT_CONTACT","IMPORT","CHATWOOT_IMPORT_DATABASE_CONNECTION_URI","PLACEHOLDER_MEDIA_MESSAGE","CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE","OPENAI","OPENAI_ENABLED","API_KEY_GLOBAL","OPENAI_API_KEY_GLOBAL","DIFY","DIFY_ENABLED","N8N","N8N_ENABLED","EVOAI","EVOAI_ENABLED","FLOWISE","FLOWISE_ENABLED","CACHE","REDIS","CACHE_REDIS_ENABLED","CACHE_REDIS_URI","CACHE_REDIS_PREFIX_KEY","TTL","CACHE_REDIS_TTL","SAVE_INSTANCES","CACHE_REDIS_SAVE_INSTANCES","LOCAL","CACHE_LOCAL_ENABLED","S3","ACCESS_KEY","S3_ACCESS_KEY","SECRET_KEY","S3_SECRET_KEY","ENDPOINT","S3_ENDPOINT","BUCKET_NAME","S3_BUCKET","ENABLE","S3_ENABLED","S3_PORT","USE_SSL","S3_USE_SSL","S3_REGION","SKIP_POLICY","S3_SKIP_POLICY","SAVE_VIDEO","S3_SAVE_VIDEO","AUTHENTICATION","API_KEY","AUTHENTICATION_API_KEY","EXPOSE_IN_FETCH_INSTANCES","AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES","METRICS","PROMETHEUS_METRICS","AUTH_REQUIRED","METRICS_AUTH_REQUIRED","USER","METRICS_USER","METRICS_PASSWORD","ALLOWED_IPS","METRICS_ALLOWED_IPS","TELEMETRY","TELEMETRY_ENABLED","TELEMETRY_URL","PROXY","PROXY_HOST","PROXY_PORT","PROTOCOL","PROXY_PROTOCOL","PROXY_USERNAME","PROXY_PASSWORD","AUDIO_CONVERTER","API_URL","API_AUDIO_CONVERTER","API_AUDIO_CONVERTER_KEY","FACEBOOK","FACEBOOK_APP_ID","CONFIG_ID","FACEBOOK_CONFIG_ID","USER_TOKEN","FACEBOOK_USER_TOKEN","SENTRY","DSN","SENTRY_DSN","EVENT_EMITTER","MAX_LISTENERS","EVENT_EMITTER_MAX_LISTENERS","_ConfigService","configService","dayjs","fs","packageJson","JSON","parse","fs","readFileSync","formatDateLog","__name","timestamp","dayjs","toDate","toString","replace","Color","Level","Type","Background","Logger","context","configService","instance","setContext","value","setInstance","console","type","types","get","LEVEL","forEach","level","push","typeValue","includes","COLOR","log","Command","Color","packageJson","version","process","pid","toString","formatDateLog","Date","now","info","warn","error","verbose","debug","dark","_Logger","postgresql","Pool","postgresql","_a","Postgres","logger","Logger","pool","connected","getConnection","connectionString","ssl","rejectUnauthorized","on","error","e","getChatwootConnection","uri","configService","get","IMPORT","DATABASE","CONNECTION","URI","postgresClient","_a","ChatwootImport","logger","Logger","repositoryMessagesCache","Map","historyMessages","historyContacts","getRepositoryMessagesCache","instance","has","instanceName","get","setRepositoryMessagesCache","set","deleteRepositoryMessagesCache","delete","addHistoryMessages","messagesRaw","actualValue","addHistoryContacts","contactsRaw","concat","deleteHistoryMessages","deleteHistoryContacts","clearAll","getHistoryMessagesLenght","length","importHistoryContacts","provider","pgClient","postgresClient","getChatwootConnection","totalContactsImported","contacts","contactsChunk","sliceIntoChunks","labelSql","nameInbox","accountId","labelId","query","rows","id","sqlLabel","sqlInsert","bindInsert","contact","isGroup","isIgnorePhoneNumber","remoteJid","contactName","pushName","push","bindName","bindPhoneNumber","split","bindIdentifier","slice","rowCount","sqlTags","tagId","sqlTag","sqlInsertLabel","forEach","bindTaggableId","error","toString","getExistingSourceIds","sourceIds","conversationId","existingSourceIdsSet","Set","formattedSourceIds","map","sourceId","replace","params","result","row","add","source_id","importHistoryMessages","chatwootService","inbox","chatwootUser","getChatwootUser","Error","totalMessagesImported","messagesOrdered","sort","a","b","aKey","key","bKey","aMessageTimestamp","messageTimestamp","bMessageTimestamp","parseInt","allMessagesMappedByPhoneNumber","createMessagesMapByPhoneNumber","phoneNumbersWithTimestamp","messages","phoneNumber","first","last","existingSourceIds","message","filter","batchSize","messagesChunk","messagesByPhoneNumber","size","fksByNumber","selectOrCreateFksFromChatwoot","sqlInsertMsg","bindInsertMsg","fksChatwoot","conversation_id","contact_id","contentMessage","getContentMessage","bindContent","bindConversationId","fromMe","bindMessageType","user_type","bindSenderType","user_id","bindSenderId","bindSourceId","bindmessageTimestamp","providerData","ignoreJids","Array","isArray","event","String","bindValues","sqlFromChatwoot","from","keys","phoneNumberTimestamp","bindStr","join","phoneNumberBind","fksFromChatwoot","item","phone_number","token","reduce","acc","phoneNumberPlus","getContactsOrderByRecentConversations","limit","msg","getConversationMessage","configService","IMPORT","PLACEHOLDER_MEDIA_MESSAGE","types","documentMessage","documentWithCaptionMessage","imageMessage","videoMessage","audioMessage","stickerMessage","templateMessage","hydratedTemplate","hydratedContentText","Object","find","undefined","typeKey","doc","fileName","caption","template","hydratedTitleText","arr","chunkSize","splice","includes","updateMessageSourceID","messageId","chatwootImport","Events","ChatwootClient","request","chatwootRequest","fs","i18next","path","languages","translationsPath","join","__dirname","configService","ConfigService","resources","forEach","language","languagePath","existsSync","translationContent","readFileSync","translation","JSON","parse","init","fallbackLng","lng","get","debug","interpolation","escapeValue","i18n_default","axios","fs","packageJson","JSON","parse","fs","readFileSync","sendTelemetry","__name","route","telemetryConfig","configService","get","ENABLED","telemetry","apiVersion","version","timestamp","Date","url","URL","axios","post","then","catch","axios","dayjs","FormData","Jimp","JimpMime","parsePhoneNumberFromString","Long","mimeTypes","path","Readable","ChatwootService","waMonitor","configService","prismaRepository","cache","logger","Logger","LOCK_POLLING_DELAY_MS","provider","pgClient","postgresClient","getChatwootConnection","getProvider","instance","cacheKey","instanceName","has","get","waInstances","findChatwoot","set","warn","clientCw","ChatwootClient","config","getClientCwConfig","error","basePath","url","with_credentials","credentials","token","nameInbox","mergeBrazilContacts","getCache","create","data","setChatwoot","autoCreate","log","urlServer","URL","initInstanceChatwoot","split","encodeURIComponent","number","organization","logo","find","enabled","getContact","id","client","contact","getContactable","accountId","inboxName","webhookUrl","qrcode","findInbox","inboxes","list","checkDuplicate","payload","map","inbox","name","includes","inboxId","type","webhook_url","channel","BOT_CONTACT","findContact","createContact","contactId","contact_id","toString","inbox_id","conversation","conversations","contentMsg","messages","conversationId","content","message_type","phoneNumber","isGroup","avatar_url","jid","identifier","contacts","addLabelToContact","status","response","existingContact","findContactByIdentifier","console","updateContact","update","IMPORT","DATABASE","CONNECTION","URI","tagData","query","rows","tagId","taggingsCount","taggings_count","rowCount","params","q","sort","length","contactByAttr","post","attribute_key","filter_operator","values","query_operator","search","chatwootRequest","method","body","getFilterPayload","findContactInContactList","mergeContacts","baseId","mergeId","base_contact_id","mergee_contact_id","mergeBrazilianContacts","phone_number","phoneNumbers","getNumbers","searchableFields","getSearchableFields","startsWith","phone","reduce","savedNumber","contact_with9","field","numbers","push","withoutNine","slice","withNine","filterPayload","fieldsToSearch","forEach","index1","index2","queryOperator","replace","createConversation","isLid","key","addressingMode","remoteJid","endsWith","remoteJidAlt","lockKey","maxWaitTime","verbose","baseContact","JSON","stringify","conversationExists","meta","sender","delete","start","Date","now","Promise","res","setTimeout","chatId","nameContact","fromMe","pushName","filterInbox","getInbox","group","groupMetadata","JID","subject","Name","participantJid","participantAlt","participant","picture_url","profilePicture","findParticipant","profilePictureUrl","waProfilePictureFile","pop","chatwootProfilePictureFile","thumbnail","pictureNeedsUpdate","nameNeedsUpdate","avatar","contactConversations","listConversations","inboxConversation","reopenConversation","conversationPending","toggleStatus","findByName","createMessage","messageType","privateMessage","attachments","messageBody","sourceId","quotedMsg","replyToIds","getReplyToIds","sourceReplyId","chatwootMessageId","message","private","source_id","content_attributes","source_reply_id","getOpenConversationByContact","undefined","createBotMessage","sendData","fileStream","fileName","isImportHistoryAvailable","messageAlreadySaved","chatwootImport","getExistingSourceIds","size","FormData","append","filename","in_reply_to","in_reply_to_external_id","maxBodyLength","Infinity","headers","api_access_token","getHeaders","axios","request","createBotQr","sendAttachment","waInstance","media","caption","options","parsedMedia","path","parse","decodeURIComponent","mimeType","mimeTypes","lookup","ext","parts","responseType","audio","delay","Math","floor","random","quoted","sendTelemetry","audioWhatsapp","mediatype","mediaMessage","onSendMessageError","exists","i18next","t","receiveWebhook","resolve","event","keyToDelete","deleted","messageReceived","replaceAll","senderName","available_name","instanceId","findFirst","where","sendMessage","deleteMany","cwBotContact","command","connectionStatus","state","connectToWhatsapp","clearCacheChatwoot","msgLogout","logout","ws","close","substring","formatText","formattedDelimiter","signDelimiter","textToConcat","signMsg","join","attachment","getQuotedMessage","messageSent","data_url","updateChatwootMessageId","messageId","contactInboxSourceId","contact_inbox","text","textMessage","Error","Long","isLong","messageTimestamp","toNumber","MESSAGE_READ","lastMessage","equals","chatwootIsRead","markMessageAsRead","readMessages","updateMessage","chatwootConversationId","chatwootInboxId","chatwootContactInboxSourceId","updateMany","chatwootMessageIds","result","$executeRaw","isRead","updateMessageSourceID","getMessageByKeyId","keyId","$queryRaw","msg","inReplyTo","inReplyToExternalId","extendedTextMessage","contextInfo","stanzaId","messageContent","isMediaMessage","Object","keys","some","isInteractiveButtonMessage","interactiveMessage","nativeFlowMessage","buttons","getAdsMessage","title","externalAdReply","thumbnailUrl","sourceUrl","getReactionMessage","reactionMessage","getTypeMessage","imageMessage","videoMessage","messageContextInfo","stickerMessage","documentMessage","documentWithCaptionMessage","audioMessage","contactMessage","vcard","contactsArrayMessage","locationMessage","liveLocationMessage","listMessage","listResponseMessage","viewOnceMessageV2","getMessageContent","types","typeKey","filter","Boolean","latitude","degreesLatitude","longitude","degreesLongitude","locationName","locationAddress","address","vCardData","contactInfo","line","value","formattedContact","numberCount","displayName","listTitle","listDescription","description","listFooter","footerText","formattedList","sections","section","sectionIndex","row","rowIndex","rowId","responseTitle","responseDescription","responseRowId","singleSelectReply","selectedRowId","getConversationMessage","eventWhatsapp","ignoreJids","ignoreGroups","ignoreContacts","info","ephemeralMessage","originalMessage","bodyMessage","quotedId","not","isMedia","adsMessage","getConversation","downloadBase64","getBase64FromMediaMessage","nameFile","originalFilename","parsedFile","extension","mimetype","fileData","Buffer","from","base64","Readable","_read","participantName","rawPhoneNumber","formattedPhoneNumber","parsePhoneNumberFromString","formatInternational","send","button","paymentSettings","buttonParamsJson","payment_settings","pixSettings","pix_static_code","pixKeyType","key_type","pixKey","merchant_name","imgBuffer","img","Jimp","read","cover","w","h","processedBuffer","getBuffer","JimpMime","png","truncStr","__name","str","len","Events","MESSAGES_DELETE","MESSAGE_DELETE","editedMessageContent","editedMessage","trim","editedText","last_non_activity_message","inbox_identifier","msgStatus","timeSinceLastNotification","lastConnectionNotification","qrCode","count","msgConnection","clearAll","statusCode","erroQRcode","msgQrCode","pairingCode","normalizeJidIdentifier","startImportHistoryMessages","uri","addHistoryMessages","messagesRaw","addHistoryContacts","contactsRaw","importHistoryMessages","totalMessagesImported","updateContactAvatarInRecentConversations","Number","isInteger","limitContacts","recentContacts","getContactsOrderByRecentConversations","contactIdentifiers","contactsWithProfilePicture","findMany","in","profilePicUrl","acc","Map","syncLostMessages","chatwootConfig","prepareMessage","SAVE_DATA","MESSAGE_UPDATE","sqlMessages","ids","filteredMessages","Instance","gte","dayjs","subtract","unix","AND","isIgnorePhoneNumber","m","_ChatwootService"]}
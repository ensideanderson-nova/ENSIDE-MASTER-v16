var j=Object.defineProperty;var ue=(_,e,t)=>e in _?j(_,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):_[e]=t;var v=(_,e)=>j(_,"name",{value:e,configurable:!0});var C=(_,e,t)=>ue(_,typeof e!="symbol"?e+"":e,t);import{isBooleanString as z}from"class-validator";import Ae from"dotenv";Ae.config();var Y=class Y{constructor(){C(this,"env");this.loadEnv()}get(e){return this.env[e]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{NAME:process.env?.SERVER_NAME||"evolution",TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY,EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",FRAME_MAX:Number.parseInt(process.env.RABBITMQ_FRAME_MAX)||8192,EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},NATS:{ENABLED:process.env?.NATS_ENABLED==="true",GLOBAL_ENABLED:process.env?.NATS_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.NATS_PREFIX_KEY,EXCHANGE_NAME:process.env?.NATS_EXCHANGE_NAME||"evolution_exchange",URI:process.env.NATS_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.NATS_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.NATS_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.NATS_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.NATS_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.NATS_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.NATS_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.NATS_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.NATS_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.NATS_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.NATS_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.NATS_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.NATS_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.NATS_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.NATS_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.NATS_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.NATS_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.NATS_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.NATS_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.NATS_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.NATS_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.NATS_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.NATS_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.NATS_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.NATS_EVENTS_CALL==="true",TYPEBOT_START:process.env?.NATS_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",GLOBAL_ENABLED:process.env?.SQS_GLOBAL_ENABLED==="true",GLOBAL_FORCE_SINGLE_QUEUE:process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE==="true",GLOBAL_PREFIX_NAME:process.env?.SQS_GLOBAL_PREFIX_NAME||"global",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||"",MAX_PAYLOAD_SIZE:Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE??"1048576"),EVENTS:{APPLICATION_STARTUP:process.env?.SQS_GLOBAL_APPLICATION_STARTUP==="true",CALL:process.env?.SQS_GLOBAL_CALL==="true",CHATS_DELETE:process.env?.SQS_GLOBAL_CHATS_DELETE==="true",CHATS_SET:process.env?.SQS_GLOBAL_CHATS_SET==="true",CHATS_UPDATE:process.env?.SQS_GLOBAL_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.SQS_GLOBAL_CHATS_UPSERT==="true",CONNECTION_UPDATE:process.env?.SQS_GLOBAL_CONNECTION_UPDATE==="true",CONTACTS_SET:process.env?.SQS_GLOBAL_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.SQS_GLOBAL_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.SQS_GLOBAL_CONTACTS_UPSERT==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE==="true",GROUPS_UPDATE:process.env?.SQS_GLOBAL_GROUPS_UPDATE==="true",GROUPS_UPSERT:process.env?.SQS_GLOBAL_GROUPS_UPSERT==="true",LABELS_ASSOCIATION:process.env?.SQS_GLOBAL_LABELS_ASSOCIATION==="true",LABELS_EDIT:process.env?.SQS_GLOBAL_LABELS_EDIT==="true",LOGOUT_INSTANCE:process.env?.SQS_GLOBAL_LOGOUT_INSTANCE==="true",MESSAGES_DELETE:process.env?.SQS_GLOBAL_MESSAGES_DELETE==="true",MESSAGES_EDITED:process.env?.SQS_GLOBAL_MESSAGES_EDITED==="true",MESSAGES_SET:process.env?.SQS_GLOBAL_MESSAGES_SET==="true",MESSAGES_UPDATE:process.env?.SQS_GLOBAL_MESSAGES_UPDATE==="true",MESSAGES_UPSERT:process.env?.SQS_GLOBAL_MESSAGES_UPSERT==="true",PRESENCE_UPDATE:process.env?.SQS_GLOBAL_PRESENCE_UPDATE==="true",QRCODE_UPDATED:process.env?.SQS_GLOBAL_QRCODE_UPDATED==="true",REMOVE_INSTANCE:process.env?.SQS_GLOBAL_REMOVE_INSTANCE==="true",SEND_MESSAGE:process.env?.SQS_GLOBAL_SEND_MESSAGE==="true",TYPEBOT_CHANGE_STATUS:process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS==="true",TYPEBOT_START:process.env?.SQS_GLOBAL_TYPEBOT_START==="true"}},KAFKA:{ENABLED:process.env?.KAFKA_ENABLED==="true",CLIENT_ID:process.env?.KAFKA_CLIENT_ID||"evolution-api",BROKERS:process.env?.KAFKA_BROKERS?.split(",")||["localhost:9092"],CONNECTION_TIMEOUT:Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT||"3000"),REQUEST_TIMEOUT:Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT||"30000"),GLOBAL_ENABLED:process.env?.KAFKA_GLOBAL_ENABLED==="true",CONSUMER_GROUP_ID:process.env?.KAFKA_CONSUMER_GROUP_ID||"evolution-api-consumers",TOPIC_PREFIX:process.env?.KAFKA_TOPIC_PREFIX||"evolution",NUM_PARTITIONS:Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS||"1"),REPLICATION_FACTOR:Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR||"1"),AUTO_CREATE_TOPICS:process.env?.KAFKA_AUTO_CREATE_TOPICS==="true",EVENTS:{APPLICATION_STARTUP:process.env?.KAFKA_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.KAFKA_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.KAFKA_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.KAFKA_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.KAFKA_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.KAFKA_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.KAFKA_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.KAFKA_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.KAFKA_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.KAFKA_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.KAFKA_EVENTS_CONTACTS_SET==="true",CONTACTS_UPSERT:process.env?.KAFKA_EVENTS_CONTACTS_UPSERT==="true",CONTACTS_UPDATE:process.env?.KAFKA_EVENTS_CONTACTS_UPDATE==="true",PRESENCE_UPDATE:process.env?.KAFKA_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.KAFKA_EVENTS_CHATS_SET==="true",CHATS_UPSERT:process.env?.KAFKA_EVENTS_CHATS_UPSERT==="true",CHATS_UPDATE:process.env?.KAFKA_EVENTS_CHATS_UPDATE==="true",CHATS_DELETE:process.env?.KAFKA_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.KAFKA_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.KAFKA_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.KAFKA_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.KAFKA_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.KAFKA_EVENTS_CALL==="true",TYPEBOT_START:process.env?.KAFKA_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS==="true"},SASL:process.env?.KAFKA_SASL_ENABLED==="true"?{ENABLED:!0,MECHANISM:process.env?.KAFKA_SASL_MECHANISM||"plain",USERNAME:process.env?.KAFKA_SASL_USERNAME||"",PASSWORD:process.env?.KAFKA_SASL_PASSWORD||""}:void 0,SSL:process.env?.KAFKA_SSL_ENABLED==="true"?{ENABLED:!0,REJECT_UNAUTHORIZED:process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED!=="false",CA:process.env?.KAFKA_SSL_CA,KEY:process.env?.KAFKA_SSL_KEY,CERT:process.env?.KAFKA_SSL_CERT}:void 0},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true",ALLOWED_HOSTS:process.env?.WEBSOCKET_ALLOWED_HOSTS},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:z(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:z(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""},REQUEST:{TIMEOUT_MS:Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS)||3e4},RETRY:{MAX_ATTEMPTS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS)||10,INITIAL_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS)||5,USE_EXPONENTIAL_BACKOFF:process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF!=="false",MAX_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS)||300,JITTER_FACTOR:Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR)||.2,NON_RETRYABLE_STATUS_CODES:process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(",").map(Number)||[400,401,403,404,422]}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome"},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},N8N:{ENABLED:process.env?.N8N_ENABLED==="true"},EVOAI:{ENABLED:process.env?.EVOAI_ENABLED==="true"},FLOWISE:{ENABLED:process.env?.FLOWISE_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION,SKIP_POLICY:process.env?.S3_SKIP_POLICY==="true",SAVE_VIDEO:process.env?.S3_SAVE_VIDEO==="true"},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"},METRICS:{ENABLED:process.env?.PROMETHEUS_METRICS==="true",AUTH_REQUIRED:process.env?.METRICS_AUTH_REQUIRED==="true",USER:process.env?.METRICS_USER,PASSWORD:process.env?.METRICS_PASSWORD,ALLOWED_IPS:process.env?.METRICS_ALLOWED_IPS},TELEMETRY:{ENABLED:process.env?.TELEMETRY_ENABLED===void 0||process.env?.TELEMETRY_ENABLED==="true",URL:process.env?.TELEMETRY_URL},PROXY:{HOST:process.env?.PROXY_HOST,PORT:process.env?.PROXY_PORT,PROTOCOL:process.env?.PROXY_PROTOCOL,USERNAME:process.env?.PROXY_USERNAME,PASSWORD:process.env?.PROXY_PASSWORD},AUDIO_CONVERTER:{API_URL:process.env?.API_AUDIO_CONVERTER,API_KEY:process.env?.API_AUDIO_CONVERTER_KEY},FACEBOOK:{APP_ID:process.env?.FACEBOOK_APP_ID,CONFIG_ID:process.env?.FACEBOOK_CONFIG_ID,USER_TOKEN:process.env?.FACEBOOK_USER_TOKEN},SENTRY:{DSN:process.env?.SENTRY_DSN},EVENT_EMITTER:{MAX_LISTENERS:Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS)||50}}}};v(Y,"ConfigService");var $=Y,w=new $;import ge from"dayjs";import le from"fs";var de=JSON.parse(le.readFileSync("./package.json","utf8")),Z=v(_=>ge(_).toDate().toString().replace(/\sGMT.+/,""),"formatDateLog"),U=(function(_){return _.LOG="\x1B[32m",_.INFO="\x1B[34m",_.WARN="\x1B[33m",_.ERROR="\x1B[31m",_.DEBUG="\x1B[36m",_.VERBOSE="\x1B[37m",_.DARK="\x1B[30m",_})(U||{});var ee=(function(_){return _.LOG="\x1B[32m%s\x1B[0m",_.DARK="\x1B[30m%s\x1B[0m",_.INFO="\x1B[34m%s\x1B[0m",_.WARN="\x1B[33m%s\x1B[0m",_.ERROR="\x1B[31m%s\x1B[0m",_.DEBUG="\x1B[36m%s\x1B[0m",_.VERBOSE="\x1B[37m%s\x1B[0m",_})(ee||{}),te=(function(_){return _.LOG="LOG",_.WARN="WARN",_.INFO="INFO",_.DARK="DARK",_.ERROR="ERROR",_.DEBUG="DEBUG",_.VERBOSE="VERBOSE",_})(te||{}),se=(function(_){return _.LOG="\x1B[42m",_.INFO="\x1B[44m",_.WARN="\x1B[43m",_.DARK="\x1B[40m",_.ERROR="\x1B[41m",_.DEBUG="\x1B[46m",_.VERBOSE="\x1B[47m",_})(se||{}),Q=class Q{constructor(e="Logger"){C(this,"configService",w);C(this,"context");C(this,"instance",null);this.context=e}setContext(e){this.context=e}setInstance(e){this.instance=e}console(e,t){let s=[];this.configService.get("LOG").LEVEL.forEach(i=>s.push(te[i]));let r=typeof e;s.includes(t)&&(w.get("LOG").COLOR?(console.log("\x1B[1m"+ee[t],"[Evolution API]","\x1B[1m"+U[t],this.instance?`[${this.instance}]`:"","\x1B[1m"+U[t],`v${de.version}`,"\x1B[1m"+U[t],process.pid.toString(),"\x1B[0m","\x1B[1m"+U[t],"-","\x1B[1m\x1B[37m",`${Z(Date.now())}  `,"\x1B[0m",U[t]+se[t]+"\x1B[1m",`${t} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,U[t]+"\x1B[1m",`[${r}]\x1B[0m`,U[t],r!=="object"?e:"","\x1B[0m"),r==="object"&&console.log(e,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${Z(Date.now())}  `,`${t} `,`[${this.context}]`,`[${r}]`,e))}log(e){this.console(e,"LOG")}info(e){this.console(e,"INFO")}warn(e){this.console(e,"WARN")}error(e){this.console(e,"ERROR")}verbose(e){this.console(e,"VERBOSE")}debug(e){this.console(e,"DEBUG")}dark(e){this.console(e,"DARK")}};v(Q,"Logger");var B=Q;import pe from"pg";var{Pool:Ne}=pe,x,he=(x=class{constructor(){C(this,"logger",new B("Postgres"));C(this,"pool");C(this,"connected",!1)}getConnection(e){if(this.connected)return this.pool;this.pool=new Ne({connectionString:e,ssl:{rejectUnauthorized:!1}}),this.pool.on("error",()=>{this.logger.error("postgres disconnected"),this.connected=!1});try{this.connected=!0}catch(t){return this.connected=!1,this.logger.error("postgres connect exception caught: "+t),null}return this.pool}getChatwootConnection(){let e=w.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI;return this.getConnection(e)}},v(x,"Postgres"),x),D=new he;var G,me=(G=class{constructor(){C(this,"logger",new B("ChatwootImport"));C(this,"repositoryMessagesCache",new Map);C(this,"historyMessages",new Map);C(this,"historyContacts",new Map)}getRepositoryMessagesCache(e){return this.repositoryMessagesCache.has(e.instanceName)?this.repositoryMessagesCache.get(e.instanceName):null}setRepositoryMessagesCache(e,t){this.repositoryMessagesCache.set(e.instanceName,t)}deleteRepositoryMessagesCache(e){this.repositoryMessagesCache.delete(e.instanceName)}addHistoryMessages(e,t){let s=this.historyMessages.has(e.instanceName)?this.historyMessages.get(e.instanceName):[];this.historyMessages.set(e.instanceName,[...s,...t])}addHistoryContacts(e,t){let s=this.historyContacts.has(e.instanceName)?this.historyContacts.get(e.instanceName):[];this.historyContacts.set(e.instanceName,s.concat(t))}deleteHistoryMessages(e){this.historyMessages.delete(e.instanceName)}deleteHistoryContacts(e){this.historyContacts.delete(e.instanceName)}clearAll(e){this.deleteRepositoryMessagesCache(e),this.deleteHistoryMessages(e),this.deleteHistoryContacts(e)}getHistoryMessagesLenght(e){return this.historyMessages.get(e.instanceName)?.length??0}async importHistoryContacts(e,t){try{if(this.getHistoryMessagesLenght(e)>0)return;let s=D.getChatwootConnection(),r=0,i=this.historyContacts.get(e.instanceName)||[];if(i.length===0)return 0;let o=this.sliceIntoChunks(i,3e3);for(;o.length>0;){let n=`SELECT id FROM labels WHERE title = '${t.nameInbox}' AND account_id = ${t.accountId} LIMIT 1`,a=(await s.query(n))?.rows[0]?.id;if(!a){let m=`INSERT INTO labels (title, color, show_on_sidebar, account_id, created_at, updated_at) VALUES ('${t.nameInbox}', '#34039B', true, ${t.accountId}, NOW(), NOW()) RETURNING id`;a=(await s.query(m))?.rows[0]?.id}let c=`INSERT INTO contacts
          (name, phone_number, account_id, identifier, created_at, updated_at) VALUES `,S=[t.accountId];for(let m of o){let N=this.isIgnorePhoneNumber(m.remoteJid),g=N?`${m.pushName} (GROUP)`:m.pushName;S.push(g);let R=`$${S.length}`,O;N?O="NULL":(S.push(`+${m.remoteJid.split("@")[0]}`),O=`$${S.length}`),S.push(m.remoteJid);let d=`$${S.length}`;c+=`(${R}, ${O}, $1, ${d}, NOW(), NOW()),`}c.slice(-1)===","&&(c=c.slice(0,-1)),c+=` ON CONFLICT (identifier, account_id)
                       DO UPDATE SET
                        name = EXCLUDED.name,
                        phone_number = EXCLUDED.phone_number,
                        updated_at = NOW()`,r+=(await s.query(c,S))?.rowCount??0;let E=`SELECT id FROM tags WHERE name = '${t.nameInbox}' LIMIT 1`,u=(await s.query(E))?.rows[0]?.id,l=`INSERT INTO tags (name, taggings_count) VALUES ('${t.nameInbox}', ${r}) ON CONFLICT (name) DO UPDATE SET taggings_count = tags.taggings_count + ${r} RETURNING id`;u=(await s.query(l))?.rows[0]?.id,await s.query(l);let A="INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) VALUES ";o.forEach(m=>{let N=`(SELECT id FROM contacts WHERE identifier = '${m.remoteJid}' AND account_id = ${t.accountId})`;A+=`($1, $2, ${N}, $3, NOW()),`}),A.slice(-1)===","&&(A=A.slice(0,-1)),await s.query(A,[u,"Contact","labels"]),o=this.sliceIntoChunks(i,3e3)}return this.deleteHistoryContacts(e),r}catch(s){this.logger.error(`Error on import history contacts: ${s.toString()}`)}}async getExistingSourceIds(e,t){try{let s=new Set;if(e.length===0)return s;let r=e.map(c=>`WAID:${c.replace("WAID:","")}`),i=D.getChatwootConnection(),o=t?[r,t]:[r],n=t?"SELECT source_id FROM messages WHERE source_id = ANY($1) AND conversation_id = $2":"SELECT source_id FROM messages WHERE source_id = ANY($1)",a=await i.query(n,o);for(let c of a.rows)s.add(c.source_id);return s}catch(s){return this.logger.error(`Error on getExistingSourceIds: ${s.toString()}`),new Set}}async importHistoryMessages(e,t,s,r){try{let i=D.getChatwootConnection(),o=await this.getChatwootUser(r);if(!o)throw new Error("User not found to import messages.");let n=0,a=this.historyMessages.get(e.instanceName)||[];if(a.length===0)return 0;a.sort((A,m)=>{let N=A.key,g=m.key,R=A.messageTimestamp,O=m.messageTimestamp;return parseInt(N.remoteJid)-parseInt(g.remoteJid)||R-O});let c=this.createMessagesMapByPhoneNumber(a),S=new Map;c.forEach((A,m)=>{S.set(m,{first:A[0]?.messageTimestamp,last:A[A.length-1]?.messageTimestamp})});let E=await this.getExistingSourceIds(a.map(A=>A.key.id));a=a.filter(A=>!E.has(A.key.id));let T=4e3,u=this.sliceIntoChunks(a,T);for(;u.length>0;){let A=this.createMessagesMapByPhoneNumber(u);if(A.size>0){let m=await this.selectOrCreateFksFromChatwoot(r,s,S,A),N=`INSERT INTO messages
            (content, processed_message_content, account_id, inbox_id, conversation_id, message_type, private, content_type,
            sender_type, sender_id, source_id, created_at, updated_at) VALUES `,g=[r.accountId,s.id];A.forEach((R,O)=>{let d=m.get(O);R.forEach(I=>{if(!I.message||!d?.conversation_id||!d?.contact_id)return;let h=this.getContentMessage(t,I);if(!h)return;g.push(h);let f=`$${g.length}`;g.push(d.conversation_id);let P=`$${g.length}`;g.push(I.key.fromMe?"1":"0");let L=`$${g.length}`;g.push(I.key.fromMe?o.user_type:"Contact");let b=`$${g.length}`;g.push(I.key.fromMe?o.user_id:d.contact_id);let k=`$${g.length}`;g.push("WAID:"+I.key.id);let K=`$${g.length}`;g.push(I.messageTimestamp);let y=`$${g.length}`;N+=`(${f}, ${f}, $1, $2, ${P}, ${L}, FALSE, 0,
                  ${b},${k},${K}, to_timestamp(${y}), to_timestamp(${y})),`})}),g.length>2&&(N.slice(-1)===","&&(N=N.slice(0,-1)),n+=(await i.query(N,g))?.rowCount??0)}u=this.sliceIntoChunks(a,T)}this.deleteHistoryMessages(e),this.deleteRepositoryMessagesCache(e);let l={...r,ignoreJids:Array.isArray(r.ignoreJids)?r.ignoreJids.map(A=>String(A)):[]};return this.importHistoryContacts(e,l),n}catch(i){this.logger.error(`Error on import history messages: ${i.toString()}`),this.deleteHistoryMessages(e),this.deleteRepositoryMessagesCache(e)}}async selectOrCreateFksFromChatwoot(e,t,s,r){let i=D.getChatwootConnection(),o=[e.accountId,t.id],a=`WITH
              phone_number AS (
                SELECT phone_number, created_at::INTEGER, last_activity_at::INTEGER FROM (
                  VALUES 
                   ${Array.from(r.keys()).map(S=>{let E=s.get(S);if(E){o.push(S);let T=`($${o.length},`;return o.push(E.first),T+=`$${o.length},`,o.push(E.last),`${T}$${o.length})`}}).join(",")}
                 ) as t (phone_number, created_at, last_activity_at)
              ),

              only_new_phone_number AS (
                SELECT * FROM phone_number
                WHERE phone_number NOT IN (
                  SELECT phone_number
                  FROM contacts
                    JOIN contact_inboxes ci ON ci.contact_id = contacts.id AND ci.inbox_id = $2
                    JOIN conversations con ON con.contact_inbox_id = ci.id 
                      AND con.account_id = $1
                      AND con.inbox_id = $2
                      AND con.contact_id = contacts.id
                  WHERE contacts.account_id = $1
                )
              ),

              new_contact AS (
                INSERT INTO contacts (name, phone_number, account_id, identifier, created_at, updated_at)
                SELECT REPLACE(p.phone_number, '+', ''), p.phone_number, $1, CONCAT(REPLACE(p.phone_number, '+', ''),
                  '@s.whatsapp.net'), to_timestamp(p.created_at), to_timestamp(p.last_activity_at)
                FROM only_new_phone_number AS p
                ON CONFLICT(identifier, account_id) DO UPDATE SET updated_at = EXCLUDED.updated_at
                RETURNING id, phone_number, created_at, updated_at
              ),

              new_contact_inbox AS (
                INSERT INTO contact_inboxes (contact_id, inbox_id, source_id, created_at, updated_at)
                SELECT new_contact.id, $2, gen_random_uuid(), new_contact.created_at, new_contact.updated_at
                FROM new_contact 
                RETURNING id, contact_id, created_at, updated_at
              ),

              new_conversation AS (
                INSERT INTO conversations (account_id, inbox_id, status, contact_id,
                  contact_inbox_id, uuid, last_activity_at, created_at, updated_at)
                SELECT $1, $2, 0, new_contact_inbox.contact_id, new_contact_inbox.id, gen_random_uuid(),
                  new_contact_inbox.updated_at, new_contact_inbox.created_at, new_contact_inbox.updated_at
                FROM new_contact_inbox
                RETURNING id, contact_id
              )

              SELECT new_contact.phone_number, new_conversation.contact_id, new_conversation.id AS conversation_id
              FROM new_conversation 
              JOIN new_contact ON new_conversation.contact_id = new_contact.id

              UNION

              SELECT p.phone_number, c.id contact_id, con.id conversation_id
                FROM phone_number p
              JOIN contacts c ON c.phone_number = p.phone_number
              JOIN contact_inboxes ci ON ci.contact_id = c.id AND ci.inbox_id = $2
              JOIN conversations con ON con.contact_inbox_id = ci.id AND con.account_id = $1
                AND con.inbox_id = $2 AND con.contact_id = c.id`,c=await i.query(a,o);return new Map(c.rows.map(S=>[S.phone_number,S]))}async getChatwootUser(e){try{return(await D.getChatwootConnection().query(`SELECT owner_type AS user_type, owner_id AS user_id
                         FROM access_tokens
                       WHERE token = $1`,[e.token]))?.rows[0]||!1}catch(t){this.logger.error(`Error on getChatwootUser: ${t.toString()}`)}}createMessagesMapByPhoneNumber(e){return e.reduce((t,s)=>{let r=s?.key;if(!this.isIgnorePhoneNumber(r?.remoteJid)){let i=r?.remoteJid?.split("@")[0];if(i){let o=`+${i}`,n=t.has(o)?t.get(o):[];n.push(s),t.set(o,n)}}return t},new Map)}async getContactsOrderByRecentConversations(e,t,s=50){try{return(await D.getChatwootConnection().query(`SELECT contacts.id, contacts.identifier, contacts.phone_number
                     FROM conversations
                   JOIN contacts ON contacts.id = conversations.contact_id
                   WHERE conversations.account_id = $1
                     AND inbox_id = $2
                   ORDER BY conversations.last_activity_at DESC
                   LIMIT $3`,[t.accountId,e.id,s]))?.rows}catch(r){this.logger.error(`Error on get recent conversations: ${r.toString()}`)}}getContentMessage(e,t){let s=e.getConversationMessage(t.message);if(s)return s;if(!w.get("CHATWOOT").IMPORT.PLACEHOLDER_MEDIA_MESSAGE)return"";let r={documentMessage:t.message.documentMessage,documentWithCaptionMessage:t.message.documentWithCaptionMessage?.message?.documentMessage,imageMessage:t.message.imageMessage,videoMessage:t.message.videoMessage,audioMessage:t.message.audioMessage,stickerMessage:t.message.stickerMessage,templateMessage:t.message.templateMessage?.hydratedTemplate?.hydratedContentText};switch(Object.keys(r).find(o=>r[o]!==void 0&&r[o]!==null)){case"documentMessage":{let o=t.message.documentMessage,n=o?.fileName||"document",a=o?.caption?` ${o.caption}`:"";return`_<File: ${n}${a}>_`}case"documentWithCaptionMessage":{let o=t.message.documentWithCaptionMessage?.message?.documentMessage,n=o?.fileName||"document",a=o?.caption?` ${o.caption}`:"";return`_<File: ${n}${a}>_`}case"templateMessage":{let o=t.message.templateMessage?.hydratedTemplate;return(o?.hydratedTitleText?`*${o.hydratedTitleText}*
`:"")+(o?.hydratedContentText||"")}case"imageMessage":return"_<Image Message>_";case"videoMessage":return"_<Video Message>_";case"audioMessage":return"_<Audio Message>_";case"stickerMessage":return"_<Sticker Message>_";default:return""}}sliceIntoChunks(e,t){return e.splice(0,t)}isGroup(e){return e.includes("@g.us")}isIgnorePhoneNumber(e){return this.isGroup(e)||e==="status@broadcast"||e==="0@s.whatsapp.net"}updateMessageSourceID(e,t){return D.getChatwootConnection().query("UPDATE messages SET source_id = $1, status = 0, created_at = NOW(), updated_at = NOW() WHERE id = $2;",[`WAID:${t}`,e])}},v(G,"ChatwootImport"),G),M=new me;var ne=(function(_){return _.APPLICATION_STARTUP="application.startup",_.INSTANCE_CREATE="instance.create",_.INSTANCE_DELETE="instance.delete",_.QRCODE_UPDATED="qrcode.updated",_.CONNECTION_UPDATE="connection.update",_.STATUS_INSTANCE="status.instance",_.MESSAGES_SET="messages.set",_.MESSAGES_UPSERT="messages.upsert",_.MESSAGES_EDITED="messages.edited",_.MESSAGES_UPDATE="messages.update",_.MESSAGES_DELETE="messages.delete",_.SEND_MESSAGE="send.message",_.SEND_MESSAGE_UPDATE="send.message.update",_.CONTACTS_SET="contacts.set",_.CONTACTS_UPSERT="contacts.upsert",_.CONTACTS_UPDATE="contacts.update",_.PRESENCE_UPDATE="presence.update",_.CHATS_SET="chats.set",_.CHATS_UPDATE="chats.update",_.CHATS_UPSERT="chats.upsert",_.CHATS_DELETE="chats.delete",_.GROUPS_UPSERT="groups.upsert",_.GROUPS_UPDATE="groups.update",_.GROUP_PARTICIPANTS_UPDATE="group-participants.update",_.CALL="call",_.TYPEBOT_START="typebot.start",_.TYPEBOT_CHANGE_STATUS="typebot.change-status",_.LABELS_EDIT="labels.edit",_.LABELS_ASSOCIATION="labels.association",_.CREDS_UPDATE="creds.update",_.MESSAGING_HISTORY_SET="messaging-history.set",_.REMOVE_INSTANCE="remove.instance",_.LOGOUT_INSTANCE="logout.instance",_})({});import Me from"@figuro/chatwoot-sdk";import{request as W}from"@figuro/chatwoot-sdk/dist/core/request";import oe from"fs";import re from"i18next";import ae from"path";var Ie=["en","pt-BR","es"],Ce=ae.join(__dirname,"translations"),Oe=new $,ie={};Ie.forEach(_=>{let e=ae.join(Ce,`${_}.json`);if(oe.existsSync(e)){let t=oe.readFileSync(e,"utf8");ie[_]={translation:JSON.parse(t)}}});re.init({resources:ie,fallbackLng:"en",lng:Oe.get("LANGUAGE"),debug:!1,interpolation:{escapeValue:!1}});var p=re;import fe from"axios";import Re from"fs";var ve=JSON.parse(Re.readFileSync("./package.json","utf8")),H=v(async _=>{let e=w.get("TELEMETRY");if(!e.ENABLED||_==="/")return;let t={route:_,apiVersion:`${ve.version}`,timestamp:new Date},s=e.URL&&e.URL!==""?e.URL:"https://log.evolution-api.com/telemetry";fe.post(s,t).then(()=>{}).catch(()=>{})},"sendTelemetry");import F from"axios";import Pe from"dayjs";import ce from"form-data";import{Jimp as De,JimpMime as we}from"jimp";import{parsePhoneNumberFromString as Ee}from"libphonenumber-js";import _e from"long";import V from"mime-types";import Se from"path";import{Readable as q}from"stream";var J=class J{constructor(e,t,s,r){C(this,"waMonitor");C(this,"configService");C(this,"prismaRepository");C(this,"cache");C(this,"logger",new B("ChatwootService"));C(this,"LOCK_POLLING_DELAY_MS",300);C(this,"provider");C(this,"pgClient",D.getChatwootConnection());this.waMonitor=e,this.configService=t,this.prismaRepository=s,this.cache=r}async getProvider(e){let t=`${e.instanceName}:getProvider`;if(await this.cache.has(t))return await this.cache.get(t);let s=await this.waMonitor.waInstances[e.instanceName]?.findChatwoot();return s?(this.cache.set(t,s),s):(this.logger.warn("provider not found"),null)}async clientCw(e){let t=await this.getProvider(e);return t?(this.provider=t,new Me({config:this.getClientCwConfig()})):(this.logger.error("provider not found"),null)}getClientCwConfig(){return{basePath:this.provider.url,with_credentials:!0,credentials:"include",token:this.provider.token,nameInbox:this.provider.nameInbox,mergeBrazilContacts:this.provider.mergeBrazilContacts}}getCache(){return this.cache}async create(e,t){if(await this.waMonitor.waInstances[e.instanceName].setChatwoot(t),t.autoCreate){this.logger.log("Auto create chatwoot instance");let s=this.configService.get("SERVER").URL;await this.initInstanceChatwoot(e,t.nameInbox??e.instanceName.split("-cwId-")[0],`${s}/chatwoot/webhook/${encodeURIComponent(e.instanceName)}`,!0,t.number,t.organization,t.logo)}return t}async find(e){try{return await this.waMonitor.waInstances[e.instanceName].findChatwoot()}catch{return this.logger.error("chatwoot not found"),{enabled:null,url:""}}}async getContact(e,t){let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;if(!t)return this.logger.warn("id is required"),null;let r=await s.contact.getContactable({accountId:this.provider.accountId,id:t});return r||(this.logger.warn("contact not found"),null)}async initInstanceChatwoot(e,t,s,r,i,o,n){let a=await this.clientCw(e);if(!a)return this.logger.warn("client not found"),null;let c=await a.inboxes.list({accountId:this.provider.accountId}),S=c.payload.map(l=>l.name).includes(t),E;if(this.logger.log("Creating chatwoot inbox"),S){let l=c.payload.find(A=>A.name===t);if(!l)return this.logger.warn("inbox not found"),null;E=l.id}else{let l={type:"api",webhook_url:s},A=await a.inboxes.create({accountId:this.provider.accountId,data:{name:t,channel:l}});if(!A)return this.logger.warn("inbox not found"),null;E=A.id}if(this.logger.log(`Inbox created - inboxId: ${E}`),!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;this.logger.log("Creating chatwoot bot contact");let T=await this.findContact(e,"123456")||await this.createContact(e,"123456",E,!1,o||"EvolutionAPI",n||"https://evolution-api.com/files/evolution-api-favicon.png");if(!T)return this.logger.warn("contact not found"),null;let u=T.id||T.payload.contact.id;if(this.logger.log(`Contact created - contactId: ${u}`),r){this.logger.log("QR code enabled");let l={contact_id:u.toString(),inbox_id:E.toString()},A=await a.conversations.create({accountId:this.provider.accountId,data:l});if(!A)return this.logger.warn("conversation not found"),null;let m="init";if(i&&(m=`init:${i}`),!await a.messages.create({accountId:this.provider.accountId,conversationId:A.id,data:{content:m,message_type:"outgoing"}}))return this.logger.warn("conversation not found"),null;this.logger.log("Init message sent")}return!0}async createContact(e,t,s,r,i,o,n){try{let a=await this.clientCw(e);if(!a)return this.logger.warn("client not found"),null;let c={};r?c={inbox_id:s,name:i||t,identifier:t,avatar_url:o}:(c={inbox_id:s,name:i||t,identifier:n,avatar_url:o},(n&&n.includes("@")||!n)&&(c.phone_number=`+${t}`));let S=await a.contacts.create({accountId:this.provider.accountId,data:c});if(!S)return this.logger.warn("contact not found"),null;let T=(await this.findContact(e,t))?.id;return await this.addLabelToContact(this.provider.nameInbox,T),S}catch(a){if((a.status===422||a.response?.status===422)&&n){this.logger.warn(`Contact with identifier ${n} creation failed (422). Checking if it already exists...`);let c=await this.findContactByIdentifier(e,n);if(c){let S=c.id;return await this.addLabelToContact(this.provider.nameInbox,S),c}}return this.logger.error("Error creating contact"),console.log(a),null}}async updateContact(e,t,s){let r=await this.clientCw(e);if(!r)return this.logger.warn("client not found"),null;if(!t)return this.logger.warn("id is required"),null;try{return await r.contacts.update({accountId:this.provider.accountId,id:t,data:s})}catch{return null}}async addLabelToContact(e,t){try{if(!this.configService.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI)return!1;let i=(await this.pgClient.query("SELECT id, taggings_count FROM tags WHERE name = $1 LIMIT 1",[e]))?.rows[0],o=i?.id,n=i?.taggings_count||0;return o=(await this.pgClient.query(`INSERT INTO tags (name, taggings_count) 
                      VALUES ($1, $2) 
                      ON CONFLICT (name) 
                      DO UPDATE SET taggings_count = tags.taggings_count + 1 
                      RETURNING id`,[e,n+1]))?.rows[0]?.id,(await this.pgClient.query(`SELECT 1 FROM taggings 
                               WHERE tag_id = $1 AND taggable_type = 'Contact' AND taggable_id = $2 AND context = 'labels' LIMIT 1`,[o,t]))?.rowCount>0||await this.pgClient.query(`INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) 
                                VALUES ($1, 'Contact', $2, 'labels', NOW())`,[o,t]),!0}catch{return!1}}async findContactByIdentifier(e,t){let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;let r=await s.get("contacts/search",{params:{q:t,sort:"name"}});if(r&&r.data&&r.data.payload&&r.data.payload.length>0)return r.data.payload[0];if(r&&r.payload&&r.payload.length>0)return r.payload[0];let i=await s.post("contacts/filter",{payload:[{attribute_key:"identifier",filter_operator:"equal_to",values:[t],query_operator:null}]});return i&&i.payload&&i.payload.length>0?i.payload[0]:i&&i.data&&i.data.payload&&i.data.payload.length>0?i.data.payload[0]:null}async findContact(e,t){let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;let r,i=t.includes("@g.us");i?r=t:r=`+${t}`;let o;return i?o=await s.contacts.search({accountId:this.provider.accountId,q:r}):o=await W(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/contacts/filter`,body:{payload:this.getFilterPayload(r)}}),!o&&o?.payload?.length===0?(this.logger.warn("contact not found"),null):i?o.payload.find(n=>n.identifier===r):o.payload.length>1?this.findContactInContactList(o.payload,r):o.payload[0]}async mergeContacts(e,t){try{return await W(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,body:{base_contact_id:e,mergee_contact_id:t}})}catch{return this.logger.error("Error merging contacts"),null}}async mergeBrazilianContacts(e){try{return await W(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,body:{base_contact_id:e.find(s=>s.phone_number.length===14)?.id,mergee_contact_id:e.find(s=>s.phone_number.length===13)?.id}})}catch{return this.logger.error("Error merging contacts"),null}}findContactInContactList(e,t){let s=this.getNumbers(t),r=this.getSearchableFields();if(e.length===2&&this.getClientCwConfig().mergeBrazilContacts&&t.startsWith("+55")){let n=this.mergeBrazilianContacts(e);if(n)return n}let i=s.reduce((n,a)=>a.length>n.length?a:n,""),o=e.find(n=>n.phone_number===i);if(o)return o;for(let n of e)for(let a of r)if(n[a]&&s.includes(n[a]))return n;return null}getNumbers(e){let t=[];if(t.push(e),e.startsWith("+55")&&e.length===14){let s=e.slice(0,5)+e.slice(6);t.push(s)}else if(e.startsWith("+55")&&e.length===13){let s=e.slice(0,5)+"9"+e.slice(5);t.push(s)}return t}getSearchableFields(){return["phone_number"]}getFilterPayload(e){let t=[],s=this.getNumbers(e),r=this.getSearchableFields();return r.forEach((i,o)=>{s.forEach((n,a)=>{let c=r.length-1===o&&s.length-1===a?null:"OR";t.push({attribute_key:i,filter_operator:"equal_to",values:[n.replace("+","")],query_operator:c})})}),t}async createConversation(e,t){let s=t.key.addressingMode==="lid",r=t.key.remoteJid.endsWith("@g.us"),i=s&&!r?t.key.remoteJidAlt:t.key.remoteJid,{remoteJid:o}=t.key,n=`${e.instanceName}:createConversation-${o}`,a=`${e.instanceName}:lock:createConversation-${o}`,c=5e3,S=await this.clientCw(e);if(!S)return null;try{if(i&&o&&!r){let E=await this.findContact(e,i.split("@")[0]);if(E&&E.identifier!==o&&(this.logger.verbose(`Identifier needs update: (contact.identifier: ${E.identifier}, phoneNumber: ${i}, body.key.remoteJidAlt: ${o}`),await this.updateContact(e,E.id,{identifier:i,phone_number:`+${i.split("@")[0]}`})===null)){let u=await this.findContact(e,i.split("@")[0]);u&&(await this.mergeContacts(u.id,E.id),this.logger.verbose(`Merge contacts: (${u.id}) ${u.phone_number} and (${E.id}) ${E.phone_number}`))}}if(this.logger.verbose("--- Start createConversation ---"),this.logger.verbose(`Instance: ${JSON.stringify(e)}`),await this.cache.has(n)){let E=await this.cache.get(n);this.logger.verbose(`Found conversation to: ${i}, conversation ID: ${E}`);let T;try{T=await S.conversations.get({accountId:this.provider.accountId,conversationId:E}),this.logger.verbose(`Conversation exists: ID: ${T.id} - Name: ${T.meta.sender.name} - Identifier: ${T.meta.sender.identifier}`)}catch(u){this.logger.error(`Error getting conversation: ${u}`),T=!1}return T?E:(this.logger.verbose("Conversation does not exist, re-calling createConversation"),this.cache.delete(n),await this.createConversation(e,t))}if(await this.cache.has(a)){this.logger.verbose(`Opera\xE7\xE3o de cria\xE7\xE3o j\xE1 em andamento para ${o}, aguardando resultado...`);let E=Date.now();for(;await this.cache.has(a);){if(Date.now()-E>c){this.logger.warn(`Timeout aguardando lock para ${o}`);break}if(await new Promise(T=>setTimeout(T,this.LOCK_POLLING_DELAY_MS)),await this.cache.has(n)){let T=await this.cache.get(n);return this.logger.verbose(`Resolves creation of: ${o}, conversation ID: ${T}`),T}}}await this.cache.set(a,!0,30),this.logger.verbose(`Bloqueio adquirido para: ${a}`);try{if(await this.cache.has(n))return await this.cache.get(n);let E=r?o:i.split("@")[0].split(":")[0],T=t.key.fromMe?E:t.pushName,u=await this.getInbox(e);if(!u)return null;if(r){this.logger.verbose("Processing group conversation");let d=await this.waMonitor.waInstances[e.instanceName].client.groupMetadata(E);this.logger.verbose(`Group metadata: JID:${d.JID} - Subject:${d?.subject||d?.Name}`);let I=s&&!t.key.fromMe?t.key.participantAlt:t.key.participant;T=`${d.subject} (GROUP)`;let h=await this.waMonitor.waInstances[e.instanceName].profilePicture(I.split("@")[0]);this.logger.verbose(`Participant profile picture URL: ${JSON.stringify(h)}`);let f=await this.findContact(e,I.split("@")[0]);f?(this.logger.verbose(`Found participant: ID:${f.id} - Name: ${f.name} - identifier: ${f.identifier}`),(!f.name||f.name===E)&&await this.updateContact(e,f.id,{name:t.pushName,avatar_url:h.profilePictureUrl||null})):await this.createContact(e,I.split("@")[0].split(":")[0],u.id,!1,t.pushName,h.profilePictureUrl||null,I)}let l=await this.waMonitor.waInstances[e.instanceName].profilePicture(E);this.logger.verbose(`Contact profile picture URL: ${JSON.stringify(l)}`),this.logger.verbose(`Searching contact for: ${E}`);let A=await this.findContact(e,E);if(A){if(this.logger.verbose(`Found contact: ID:${A.id} - Name:${A.name}`),!t.key.fromMe){let d=l?.profilePictureUrl?.split("#")[0].split("?")[0].split("/").pop()||"",I=A?.thumbnail?.split("#")[0].split("?")[0].split("/").pop()||"",h=d!==I,f=!A.name||A.name===E;this.logger.verbose(`Picture needs update: ${h}`),this.logger.verbose(`Name needs update: ${f}`),(h||f)&&(A=await this.updateContact(e,A.id,{...f&&{name:T},...d===""&&{avatar:null},...h&&{avatar_url:l?.profilePictureUrl}}))}}else A=await this.createContact(e,E,u.id,r,T,l.profilePictureUrl||null,i);if(!A)return this.logger.warn("Contact not created or found"),null;let m=A?.payload?.id||A?.payload?.contact?.id||A?.id;this.logger.verbose(`Contact ID: ${m}`);let N=await S.contacts.listConversations({accountId:this.provider.accountId,id:m});if(!N||!N.payload)return this.logger.error("No conversations found or payload is undefined"),null;let g=N.payload.find(d=>d.inbox_id==u.id);if(g&&(this.provider.reopenConversation?(this.logger.verbose(`Found conversation in reopenConversation mode: ID: ${g.id} - Name: ${g.meta.sender.name} - Identifier: ${g.meta.sender.identifier}`),g&&this.provider.conversationPending&&g.status!=="open"&&await S.conversations.toggleStatus({accountId:this.provider.accountId,conversationId:g.id,data:{status:"pending"}})):(g=N.payload.find(d=>d&&d.status!=="resolved"&&d.inbox_id==u.id),this.logger.verbose(`Found conversation: ${JSON.stringify(g)}`)),g))return this.logger.verbose(`Returning existing conversation ID: ${g.id}`),this.cache.set(n,g.id,1800),g.id;let R={contact_id:m.toString(),inbox_id:u.id.toString()};this.provider.conversationPending&&(R.status="pending");let O=await S.conversations.create({accountId:this.provider.accountId,data:R});return O?(this.logger.verbose(`New conversation created of ${o} with ID: ${O.id}`),this.cache.set(n,O.id,1800),O.id):(this.logger.warn("Conversation not created or found"),null)}finally{await this.cache.delete(a),this.logger.verbose(`Block released for: ${a}`)}}catch(E){return this.logger.error(`Error in createConversation: ${E}`),null}}async getInbox(e){let t=`${e.instanceName}:getInbox`;if(await this.cache.has(t))return await this.cache.get(t);let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;let r=await s.inboxes.list({accountId:this.provider.accountId});if(!r)return this.logger.warn("inbox not found"),null;let i=r.payload.find(o=>o.name===this.getClientCwConfig().nameInbox);return i?(this.cache.set(t,i),i):(this.logger.warn("inbox not found"),null)}async createMessage(e,t,s,r,i,o,n,a,c){let S=await this.clientCw(e);if(!S)return this.logger.warn("client not found"),null;let E=await this.getReplyToIds(n,e),T=c?.chatwootMessageId||null,u=await S.messages.create({accountId:this.provider.accountId,conversationId:t,data:{content:s,message_type:r,attachments:o,private:i||!1,source_id:a,content_attributes:{...E},source_reply_id:T?T.toString():null}});return u||(this.logger.warn("message not found"),null)}async getOpenConversationByContact(e,t,s){let r=await this.clientCw(e);return r?(await r.contacts.listConversations({accountId:this.provider.accountId,id:s.id})).payload.find(o=>o.inbox_id===t.id&&o.status==="open")||void 0:(this.logger.warn("client not found"),null)}async createBotMessage(e,t,s,r){let i=await this.clientCw(e);if(!i)return this.logger.warn("client not found"),null;let o=await this.findContact(e,"123456");if(!o)return this.logger.warn("contact not found"),null;let n=await this.getInbox(e);if(!n)return this.logger.warn("inbox not found"),null;let a=await this.getOpenConversationByContact(e,n,o);if(!a){this.logger.warn("conversation not found");return}let c=await i.messages.create({accountId:this.provider.accountId,conversationId:a.id,data:{content:t,message_type:s,attachments:r}});return c||(this.logger.warn("message not found"),null)}async sendData(e,t,s,r,i,o,n,a,c){if(a&&this.isImportHistoryAvailable()){let u=await M.getExistingSourceIds([a],e);if(u&&u.size>0)return this.logger.warn("Message already saved on chatwoot"),null}let S=new ce;i&&S.append("content",i),S.append("message_type",r),S.append("attachments[]",t,{filename:s});let E=c?.chatwootMessageId||null;if(n&&o){let u=await this.getReplyToIds(n,o);if(u.in_reply_to||u.in_reply_to_external_id){let l=JSON.stringify({...u});S.append("content_attributes",l)}}E&&S.append("source_reply_id",E.toString()),a&&S.append("source_id",a);let T={method:"post",maxBodyLength:1/0,url:`${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${e}/messages`,headers:{api_access_token:this.provider.token,...S.getHeaders()},data:S};try{let{data:u}=await F.request(T);return u}catch(u){this.logger.error(u)}}async createBotQr(e,t,s,r,i){if(!await this.clientCw(e))return this.logger.warn("client not found"),null;if(!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;let n=await this.findContact(e,"123456");if(!n)return this.logger.warn("contact not found"),null;let a=await this.getInbox(e);if(!a)return this.logger.warn("inbox not found"),null;let c=await this.getOpenConversationByContact(e,a,n);if(!c){this.logger.warn("conversation not found");return}let S=new ce;t&&S.append("content",t),S.append("message_type",s),r&&i&&S.append("attachments[]",r,{filename:i});let E={method:"post",maxBodyLength:1/0,url:`${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${c.id}/messages`,headers:{api_access_token:this.provider.token,...S.getHeaders()},data:S};try{let{data:T}=await F.request(E);return T}catch(T){this.logger.error(T)}}async sendAttachment(e,t,s,r,i){try{let o=Se.parse(decodeURIComponent(s)),n=V.lookup(o?.ext)||"",a=o?.name+o?.ext;if(!n){let u=s.split("/");a=decodeURIComponent(u[u.length-1]),n=(await F.get(s,{responseType:"arraybuffer"})).headers["content-type"]}let c="document";switch(n.split("/")[0]){case"image":c="image";break;case"video":c="video";break;case"audio":c="audio";break;default:c="document";break}if(c==="audio"){let u={number:t,audio:s,delay:Math.floor(Math.random()*1501)+500,quoted:i?.quoted};return H("/message/sendWhatsAppAudio"),await e?.audioWhatsapp(u,null,!0)}c==="image"&&o&&[".gif",".svg",".tiff",".tif",".dxf",".dwg"].includes(o?.ext)&&(c="document");let E={number:t,mediatype:c,fileName:a,media:s,delay:1200,quoted:i?.quoted};return H("/message/sendMedia"),r&&(E.caption=r),await e?.mediaMessage(E,null,!0)}catch(o){throw this.logger.error(o),o}}async onSendMessageError(e,t,s){this.logger.verbose(`onSendMessageError ${JSON.stringify(s)}`);let r=await this.clientCw(e);if(r){if(s&&s?.status===400&&s?.message[0]?.exists===!1){r.messages.create({accountId:this.provider.accountId,conversationId:t,data:{content:`${p.t("cw.message.numbernotinwhatsapp")}`,message_type:"outgoing",private:!0}});return}r.messages.create({accountId:this.provider.accountId,conversationId:t,data:{content:p.t("cw.message.notsent",{error:s?`_${s.toString()}_`:""}),message_type:"outgoing",private:!0}})}}async receiveWebhook(e,t){try{if(await new Promise(c=>setTimeout(c,500)),!await this.clientCw(e))return this.logger.warn("client not found"),null;if(this.provider.reopenConversation===!1&&t.event==="conversation_status_changed"&&t.status==="resolved"&&t.meta?.sender?.identifier){let c=`${e.instanceName}:createConversation-${t.meta.sender.identifier}`;this.cache.delete(c)}if(!t?.conversation||t.private||t.event==="message_updated"&&!t.content_attributes?.deleted)return{message:"bot"};let r=t.conversation.meta.sender?.identifier||t.conversation.meta.sender?.phone_number.replace("+",""),i=t.content?t.content.replaceAll(/(?<!\*)\*((?!\s)([^\n*]+?)(?<!\s))\*(?!\*)/g,"_$1_").replaceAll(/\*{2}((?!\s)([^\n*]+?)(?<!\s))\*{2}/g,"*$1*").replaceAll(/~{2}((?!\s)([^\n*]+?)(?<!\s))~{2}/g,"~$1~").replaceAll(/(?<!`)`((?!\s)([^`*]+?)(?<!\s))`(?!`)/g,"```$1```"):t.content,o=t?.conversation?.messages[0]?.sender?.available_name||t?.sender?.name,n=this.waMonitor.waInstances[e.instanceName];if(e.instanceId=n.instanceId,t.event==="message_updated"&&t.content_attributes?.deleted){let c=await this.prismaRepository.message.findFirst({where:{chatwootMessageId:t.id,instanceId:e.instanceId}});if(c){let S=c.key;await n?.client.sendMessage(S.remoteJid,{delete:S}),await this.prismaRepository.message.deleteMany({where:{instanceId:e.instanceId,chatwootMessageId:t.id}})}return{message:"bot"}}let a=this.configService.get("CHATWOOT").BOT_CONTACT;if(r==="123456"&&t.message_type==="outgoing"){let c=i.replace("/","");if(a&&(c.includes("init")||c.includes("iniciar")))if(n?.connectionStatus?.state!=="open"){let E=c.split(":")[1];await n.connectToWhatsapp(E)}else await this.createBotMessage(e,p.t("cw.inbox.alreadyConnected",{inboxName:t.inbox.name}),"incoming");if(c==="clearcache"&&(n.clearCacheChatwoot(),await this.createBotMessage(e,p.t("cw.inbox.clearCache",{inboxName:t.inbox.name}),"incoming")),c==="status"){let S=n?.connectionStatus?.state;S||await this.createBotMessage(e,p.t("cw.inbox.notFound",{inboxName:t.inbox.name}),"incoming"),S&&await this.createBotMessage(e,p.t("cw.inbox.status",{inboxName:t.inbox.name,state:S}),"incoming")}if(a&&(c==="disconnect"||c==="desconectar")){let S=p.t("cw.inbox.disconnect",{inboxName:t.inbox.name});await this.createBotMessage(e,S,"incoming"),await n?.client?.logout("Log out instance: "+e.instanceName),await n?.client?.ws?.close()}}if(t.message_type==="outgoing"&&t?.conversation?.messages?.length&&r!=="123456"){if(t?.conversation?.messages[0]?.source_id?.substring(0,5)==="WAID:")return{message:"bot"};if(!n&&t.conversation?.id)return this.onSendMessageError(e,t.conversation?.id,"Instance not found"),{message:"bot"};let c;if(o==null)c=i;else{let E=this.provider.signDelimiter?this.provider.signDelimiter.replaceAll("\\n",`
`):`
`,T=this.provider.signMsg?[`*${o}:*`]:[];T.push(i),c=T.join(E)}for(let E of t.conversation.messages)if(E.attachments&&E.attachments.length>0)for(let T of E.attachments){i||(c=null);let u={quoted:await this.getQuotedMessage(t,e)},l=await this.sendAttachment(n,r,T.data_url,c,u);!l&&t.conversation?.id&&this.onSendMessageError(e,t.conversation?.id),await this.updateChatwootMessageId({...l},{messageId:t.id,inboxId:t.inbox?.id,conversationId:t.conversation?.id,contactInboxSourceId:t.conversation?.contact_inbox?.source_id},e)}else{let T={number:r,text:c,delay:Math.floor(Math.random()*1501)+500,quoted:await this.getQuotedMessage(t,e)};H("/message/sendText");let u;try{if(u=await n?.textMessage(T,!0),!u)throw new Error("Message not sent");_e.isLong(u?.messageTimestamp)&&(u.messageTimestamp=u.messageTimestamp?.toNumber()),await this.updateChatwootMessageId({...u},{messageId:t.id,inboxId:t.inbox?.id,conversationId:t.conversation?.id,contactInboxSourceId:t.conversation?.contact_inbox?.source_id},e)}catch(l){throw!u&&t.conversation?.id&&this.onSendMessageError(e,t.conversation?.id,l),l}}if(this.configService.get("CHATWOOT").MESSAGE_READ){let E=await this.prismaRepository.message.findFirst({where:{key:{path:["fromMe"],equals:!1},instanceId:e.instanceId}});if(E&&!E.chatwootIsRead){let T=E.key;n?.markMessageAsRead({readMessages:[{id:T.id,fromMe:T.fromMe,remoteJid:T.remoteJid}]});let u={chatwootMessageId:E.chatwootMessageId,chatwootConversationId:E.chatwootConversationId,chatwootInboxId:E.chatwootInboxId,chatwootContactInboxSourceId:E.chatwootContactInboxSourceId,chatwootIsRead:!0};await this.prismaRepository.message.updateMany({where:{instanceId:e.instanceId,key:{path:["id"],equals:T.id}},data:u})}}}if(t.message_type==="template"&&t.event==="message_created"){let c={number:r,text:t.content.replace(/\\\r\n|\\\n|\n/g,`
`),delay:Math.floor(Math.random()*1501)+500};H("/message/sendText"),await n?.textMessage(c)}return{message:"bot"}}catch(s){return this.logger.error(s),{message:"bot"}}}async updateChatwootMessageId(e,t,s){let r=e.key;if(!t.messageId||!r?.id)return;let i=await this.prismaRepository.$executeRaw`
      UPDATE "Message" 
      SET 
        "chatwootMessageId" = ${t.messageId},
        "chatwootConversationId" = ${t.conversationId},
        "chatwootInboxId" = ${t.inboxId},
        "chatwootContactInboxSourceId" = ${t.contactInboxSourceId},
        "chatwootIsRead" = ${t.isRead||!1}
      WHERE "instanceId" = ${s.instanceId} 
      AND "key"->>'id' = ${r.id}
    `;if(this.logger.verbose(`Update result: ${i} rows affected`),this.isImportHistoryAvailable())try{await M.updateMessageSourceID(t.messageId,r.id)}catch(o){this.logger.error(`Error updating Chatwoot message source ID: ${o}`)}}async getMessageByKeyId(e,t){return(await this.prismaRepository.$queryRaw`
      SELECT * FROM "Message" 
      WHERE "instanceId" = ${e.instanceId} 
      AND "key"->>'id' = ${t}
      LIMIT 1
    `)[0]||null}async getReplyToIds(e,t){let s=null,r=null;if(e&&(r=e.message?.extendedTextMessage?.contextInfo?.stanzaId??e.contextInfo?.stanzaId,r)){let i=await this.getMessageByKeyId(t,r);i?.chatwootMessageId&&(s=i.chatwootMessageId)}return{in_reply_to:s,in_reply_to_external_id:r}}async getQuotedMessage(e,t){if(e?.content_attributes?.in_reply_to){let s=await this.prismaRepository.message.findFirst({where:{chatwootMessageId:e?.content_attributes?.in_reply_to,instanceId:t.instanceId}}),r=s?.key,i=s?.message;if(i&&r?.id)return{key:r,message:i}}return null}isMediaMessage(e){let t=["imageMessage","documentMessage","documentWithCaptionMessage","audioMessage","videoMessage","stickerMessage","viewOnceMessageV2"];return Object.keys(e).some(i=>t.includes(i))}isInteractiveButtonMessage(e,t){return e==="interactiveMessage"&&t.interactiveMessage?.nativeFlowMessage?.buttons?.length>0}getAdsMessage(e){return{title:e.extendedTextMessage?.contextInfo?.externalAdReply?.title||e.contextInfo?.externalAdReply?.title,body:e.extendedTextMessage?.contextInfo?.externalAdReply?.body||e.contextInfo?.externalAdReply?.body,thumbnailUrl:e.extendedTextMessage?.contextInfo?.externalAdReply?.thumbnailUrl||e.contextInfo?.externalAdReply?.thumbnailUrl,sourceUrl:e.extendedTextMessage?.contextInfo?.externalAdReply?.sourceUrl||e.contextInfo?.externalAdReply?.sourceUrl}}getReactionMessage(e){return e?.reactionMessage}getTypeMessage(e){return{conversation:e.conversation,imageMessage:e.imageMessage?.caption,videoMessage:e.videoMessage?.caption,extendedTextMessage:e.extendedTextMessage?.text,messageContextInfo:e.messageContextInfo?.stanzaId,stickerMessage:void 0,documentMessage:e.documentMessage?.caption,documentWithCaptionMessage:e.documentWithCaptionMessage?.message?.documentMessage?.caption,audioMessage:e.audioMessage?e.audioMessage.caption??"":void 0,contactMessage:e.contactMessage?.vcard,contactsArrayMessage:e.contactsArrayMessage,locationMessage:e.locationMessage,liveLocationMessage:e.liveLocationMessage,listMessage:e.listMessage,listResponseMessage:e.listResponseMessage,viewOnceMessageV2:e?.message?.viewOnceMessageV2?.message?.imageMessage?.url||e?.message?.viewOnceMessageV2?.message?.videoMessage?.url||e?.message?.viewOnceMessageV2?.message?.audioMessage?.url}}getMessageContent(e){let t=Object.keys(e).find(r=>e[r]!==void 0),s=t?e[t]:void 0;if(s&&typeof s=="string"&&s.includes("externalAdReplyBody|")&&(s=s.split("externalAdReplyBody|").filter(Boolean).join("")),t==="locationMessage"||t==="liveLocationMessage"){let r=s.degreesLatitude,i=s.degreesLongitude,o=s?.name,n=s?.address;return`*${p.t("cw.locationMessage.location")}:*

_${p.t("cw.locationMessage.latitude")}:_ ${r} 
_${p.t("cw.locationMessage.longitude")}:_ ${i} 
`+(o?`_${p.t("cw.locationMessage.locationName")}:_ ${o}
`:"")+(n?`_${p.t("cw.locationMessage.locationAddress")}:_ ${n} 
`:"")+`_${p.t("cw.locationMessage.locationUrl")}:_ https://www.google.com/maps/search/?api=1&query=${r},${i}`}if(t==="contactMessage"){let r=s.split(`
`),i={};r.forEach(a=>{let[c,S]=a.split(":");c&&S&&(i[c]=S)});let o=`*${p.t("cw.contactMessage.contact")}:*

_${p.t("cw.contactMessage.name")}:_ ${i.FN}`,n=1;return Object.keys(i).forEach(a=>{if(a.startsWith("item")&&a.includes("TEL")){let c=i[a];o+=`
_${p.t("cw.contactMessage.number")} (${n}):_ ${c}`,n++}else if(a.includes("TEL")){let c=i[a];o+=`
_${p.t("cw.contactMessage.number")} (${n}):_ ${c}`,n++}}),o}if(t==="contactsArrayMessage")return s.contacts.map(o=>{let n=o.vcard.split(`
`),a={};n.forEach(E=>{let[T,u]=E.split(":");T&&u&&(a[T]=u)});let c=`*${p.t("cw.contactMessage.contact")}:*

_${p.t("cw.contactMessage.name")}:_ ${o.displayName}`,S=1;return Object.keys(a).forEach(E=>{if(E.startsWith("item")&&E.includes("TEL")){let T=a[E];c+=`
_${p.t("cw.contactMessage.number")} (${S}):_ ${T}`,S++}else if(E.includes("TEL")){let T=a[E];c+=`
_${p.t("cw.contactMessage.number")} (${S}):_ ${T}`,S++}}),c}).join(`

`);if(t==="listMessage"){let r=s?.title||"Unknown",i=s?.description||"Unknown",o=s?.footerText||"Unknown",n=`*List Menu:*

_Title_: `+r+`
_Description_: `+i+`
_Footer_: `+o;return s.sections&&s.sections.length>0?s.sections.forEach((a,c)=>{n+=`

*Section `+(c+1)+":* "+a.title||`Unknown
`,a.rows&&a.rows.length>0?a.rows.forEach((S,E)=>{n+=`
*Line `+(E+1)+`:*
`,n+="_\u25AA\uFE0F Title:_ "+(S.title||"Unknown")+`
`,n+="_\u25AA\uFE0F Description:_ "+(S.description||"Unknown")+`
`,n+="_\u25AA\uFE0F ID:_ "+(S.rowId||"Unknown")+`
`}):n+=`
No lines found in this section.
`}):n+=`
No sections found.
`,n}if(t==="listResponseMessage"){let r=s?.title||"Unknown",i=s?.description||"Unknown",o=s?.singleSelectReply?.selectedRowId||"Unknown";return`*List Response:*

_Title_: `+r+`
_Description_: `+i+`
_ID_: `+o}return s}getConversationMessage(e){let t=this.getTypeMessage(e);return this.getMessageContent(t)}async eventWhatsapp(e,t,s){try{let r=this.waMonitor.waInstances[t.instanceName];if(!r)return this.logger.warn("wa instance not found"),null;let i=await this.clientCw(t);if(!i)return this.logger.warn("client not found"),null;if(this.provider?.ignoreJids&&this.provider?.ignoreJids.length>0){let o=this.provider?.ignoreJids,n=!1,a=!1;if(o.includes("@g.us")&&(n=!0),o.includes("@s.whatsapp.net")&&(a=!0),n&&s?.key?.remoteJid.endsWith("@g.us")){this.logger.warn("Ignoring message from group: "+s?.key?.remoteJid);return}if(a&&s?.key?.remoteJid.endsWith("@s.whatsapp.net")){this.logger.warn("Ignoring message from contact: "+s?.key?.remoteJid);return}if(o.includes(s?.key?.remoteJid)){this.logger.warn("Ignoring message from jid: "+s?.key?.remoteJid);return}}if(e==="messages.upsert"||e==="send.message"){if(this.logger.info(`[${e}] New message received - Instance: ${JSON.stringify(s,null,2)}`),s.key.remoteJid==="status@broadcast")return;s.message?.ephemeralMessage?.message&&(s.message={...s.message?.ephemeralMessage?.message});let o=await this.getConversationMessage(s.message),n=o&&o.replaceAll(/\*((?!\s)([^\n*]+?)(?<!\s))\*/g,"**$1**").replaceAll(/_((?!\s)([^\n_]+?)(?<!\s))_/g,"*$1*").replaceAll(/~((?!\s)([^\n~]+?)(?<!\s))~/g,"~~$1~~");if(n&&n.includes("/survey/responses/")&&n.includes("http"))return;let a=s.contextInfo?.stanzaId||s.message?.contextInfo?.stanzaId,c=null;a&&(c=await this.prismaRepository.message.findFirst({where:{key:{path:["id"],equals:a},chatwootMessageId:{not:null}}}));let S=this.isMediaMessage(s.message),E=this.getAdsMessage(s),T=this.getReactionMessage(s.message),u=this.isInteractiveButtonMessage(s.messageType,s.message);if(!n&&!S&&!T&&!u){this.logger.warn("no body message found");return}let l=await this.createConversation(t,s);if(!l){this.logger.warn("conversation not found");return}let A=s.key.fromMe?"outgoing":"incoming";if(S){let N=await r?.getBase64FromMediaMessage({message:{...s}}),g,R=s?.message[s?.messageType],O=R?.fileName||R?.filename||R?.message?.documentMessage?.fileName;if(O){let h=Se.parse(O);h.name&&h.ext&&(g=`${h.name}-${Math.floor(Math.random()*90+10)}${h.ext}`)}g||(g=`${Math.random().toString(36).substring(7)}.${V.extension(N.mimetype)||""}`);let d=Buffer.from(N.base64,"base64"),I=new q;if(I._read=()=>{},I.push(d),I.push(null),s.key.remoteJid.includes("@g.us")){let h=s.pushName,f=s.key.addressingMode==="lid"&&!s.key.fromMe&&s.key.participantAlt?s.key.participantAlt.split("@")[0].split(":")[0]:s.key.participant.split("@")[0].split(":")[0],P=Ee(`+${f}`).formatInternational(),L;s.key.fromMe?L=n||"":L=n?`**${P} - ${h}:**

${n}`:`**${P} - ${h}:**`;let b=await this.sendData(l,I,g,A,L,t,s,"WAID:"+s.key.id,c);if(!b){this.logger.warn("message not sent");return}return b}else{let h=await this.sendData(l,I,g,A,n,t,s,"WAID:"+s.key.id,c);if(!h){this.logger.warn("message not sent");return}return h}}if(T){if(T.text&&!await this.createMessage(t,l,T.text,A,!1,[],{message:{extendedTextMessage:{contextInfo:{stanzaId:T.key.id}}}},"WAID:"+s.key.id,c)){this.logger.warn("message not sent");return}return}if(u){let N=s.message.interactiveMessage.nativeFlowMessage.buttons;this.logger.info("is Interactive Button Message: "+JSON.stringify(N));for(let g of N){let O=JSON.parse(g.buttonParamsJson).payment_settings;if(g.name==="payment_info"&&O[0].type==="pix_static_code"){let d=O[0].pix_static_code,I=(()=>{switch(d.key_type){case"EVP":return"Chave Aleat\xF3ria";case"EMAIL":return"E-mail";case"PHONE":return"Telefone";default:return d.key_type}})(),h=d.key_type==="PHONE"?d.key.replace("+55",""):d.key,f=`*${d.merchant_name}*
Chave PIX: ${h} (${I})`;await this.createMessage(t,l,f,A,!1,[],s,"WAID:"+s.key.id,c)||this.logger.warn("message not sent")}else this.logger.warn("Interactive Button Message not mapped")}return}if(E&&E.title||E.body||E.thumbnailUrl){let N=await F.get(E.thumbnailUrl,{responseType:"arraybuffer"}),g=V.extension(N.headers["content-type"]),R=g&&V.lookup(g);if(!R){this.logger.warn("mimetype of Ads message not found");return}let d=`${Math.random().toString(36).substring(7)}.${V.extension(R)}`,I=Buffer.from(N.data,"binary"),h=await De.read(I);await h.cover({w:320,h:180});let f=await h.getBuffer(we.png),P=new q;P._read=()=>{},P.push(f),P.push(null);let L=v((y,X)=>y?y.length>X?y.substring(0,X)+"...":y:"","truncStr"),b=L(E.title,40),k=L(E?.body,75),K=await this.sendData(l,P,d,A,`${n}


**${b}**
${k}
${E.sourceUrl}`,t,s,"WAID:"+s.key.id);if(!K){this.logger.warn("message not sent");return}return K}if(s.key.remoteJid.includes("@g.us")){let N=s.pushName,g=s.key.addressingMode==="lid"&&!s.key.fromMe&&s.key.participantAlt?s.key.participantAlt.split("@")[0].split(":")[0]:s.key.participant.split("@")[0].split(":")[0],R=Ee(`+${g}`).formatInternational(),O;s.key.fromMe?O=`${n}`:O=`**${R} - ${N}:**

${n}`;let d=await this.createMessage(t,l,O,A,!1,[],s,"WAID:"+s.key.id,c);if(!d){this.logger.warn("message not sent");return}return d}else{let N=await this.createMessage(t,l,n,A,!1,[],s,"WAID:"+s.key.id,c);if(!N){this.logger.warn("message not sent");return}return N}}if(e===ne.MESSAGES_DELETE&&this.configService.get("CHATWOOT").MESSAGE_DELETE===!0){if(!s?.key?.id){this.logger.warn("message id not found");return}let n=await this.getMessageByKeyId(t,s.key.id);if(n?.chatwootMessageId&&n?.chatwootConversationId)return await this.prismaRepository.message.deleteMany({where:{key:{path:["id"],equals:s.key.id},instanceId:t.instanceId}}),await i.messages.delete({accountId:this.provider.accountId,conversationId:n.chatwootConversationId,messageId:n.chatwootMessageId})}if(e==="messages.edit"||e==="send.message.update"){let n=(s?.editedMessage?.conversation??s?.editedMessage?.extendedTextMessage?.text??s?.editedMessage?.imageMessage?.caption??s?.editedMessage?.videoMessage?.caption??s?.editedMessage?.documentMessage?.caption??(typeof s?.text=="string"?s.text:void 0)??"").trim();if(!n){this.logger.info("[CW.EDIT] Conte\xFAdo vazio \u2014 ignorando (DELETE tratar\xE1 se for revoke).");return}let a=await this.getMessageByKeyId(t,s?.key?.id);if(!a){this.logger.warn("Message not found for edit event");return}let c=a.key,S=c?.fromMe?"outgoing":"incoming";if(a&&a.chatwootConversationId&&a.chatwootMessageId){let E=`

\`${p.t("cw.message.edited")}:\`

${n}`;if(!await this.createMessage(t,a.chatwootConversationId,E,S,!1,[],{message:{extendedTextMessage:{contextInfo:{stanzaId:c.id}}}},"WAID:"+s.key.id,null)){this.logger.warn("edited message not sent");return}}return}if(e==="messages.read"){if(!s?.key?.id||!s?.key?.remoteJid){this.logger.warn("message id not found");return}let o=await this.getMessageByKeyId(t,s.key.id),n=o?.chatwootConversationId,a=o?.chatwootContactInboxSourceId;if(n){let c=a,S=await this.getInbox(t);if(!c&&S&&(c=(await i.conversations.get({accountId:this.provider.accountId,conversationId:n})).last_non_activity_message?.conversation?.contact_inbox?.source_id),c&&S?.inbox_identifier){let E=`/public/api/v1/inboxes/${S.inbox_identifier}/contacts/${c}/conversations/${n}/update_last_seen`;await W(this.getClientCwConfig(),{method:"POST",url:E})}}return}if(e==="status.instance"){let o=s,n=await this.getInbox(t);if(!n){this.logger.warn("inbox not found");return}let a=p.t("cw.inbox.status",{inboxName:n.name,state:o.status});await this.createBotMessage(t,a,"incoming")}if(e==="connection.update"&&s.status==="open"){let o=this.waMonitor.waInstances[t.instanceName];if(!o)return;let n=Date.now(),a=n-(o.lastConnectionNotification||0);if(o.qrCode&&o.qrCode.count>0){let c=p.t("cw.inbox.connected");await this.createBotMessage(t,c,"incoming"),o.qrCode.count=0,o.lastConnectionNotification=n,M.clearAll(t)}else if(a>=3e4){let c=p.t("cw.inbox.connected");await this.createBotMessage(t,c,"incoming"),o.lastConnectionNotification=n}else this.logger.warn(`Connection notification skipped for ${t.instanceName} - too frequent (${a}ms since last)`)}if(e==="qrcode.updated")if(s.statusCode===500){let o=`\u{1F6A8} ${p.t("qrlimitreached")}`;return await this.createBotMessage(t,o,"incoming")}else{let o=Buffer.from(s?.qrcode.base64.replace("data:image/png;base64,",""),"base64"),n=new q;n._read=()=>{},n.push(o),n.push(null),await this.createBotQr(t,p.t("qrgeneratedsuccesfully"),"incoming",n,`${t.instanceName}.png`);let a=`\u26A1\uFE0F${p.t("qrgeneratedsuccesfully")}

${p.t("scanqr")}`;s?.qrcode?.pairingCode&&(a=a+`

*Pairing Code:* ${s.qrcode.pairingCode.substring(0,4)}-${s.qrcode.pairingCode.substring(4,8)}`),await this.createBotMessage(t,a,"incoming")}}catch(r){this.logger.error(r)}}normalizeJidIdentifier(e){return e?e.includes("@lid")?e:e.replace(/:\d+/,"").split("@")[0]:""}startImportHistoryMessages(e){this.isImportHistoryAvailable()&&this.createBotMessage(e,p.t("cw.import.startImport"),"incoming")}isImportHistoryAvailable(){let e=this.configService.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI;return e&&e!=="postgres://user:password@hostname:port/dbname"}addHistoryMessages(e,t){this.isImportHistoryAvailable()&&M.addHistoryMessages(e,t)}addHistoryContacts(e,t){if(this.isImportHistoryAvailable())return M.addHistoryContacts(e,t)}async importHistoryMessages(e){if(!this.isImportHistoryAvailable())return;this.createBotMessage(e,p.t("cw.import.importingMessages"),"incoming");let t=await M.importHistoryMessages(e,this,await this.getInbox(e),this.provider);this.updateContactAvatarInRecentConversations(e);let s=Number.isInteger(t)?p.t("cw.import.messagesImported",{totalMessagesImported:t}):p.t("cw.import.messagesException");return this.createBotMessage(e,s,"incoming"),t}async updateContactAvatarInRecentConversations(e,t=100){try{if(!this.isImportHistoryAvailable())return;let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;let r=await this.getInbox(e);if(!r)return this.logger.warn("inbox not found"),null;let i=await M.getContactsOrderByRecentConversations(r,this.provider,t),o=i.map(a=>a.identifier).filter(a=>a!==null),n=(await this.prismaRepository.contact.findMany({where:{instanceId:e.instanceId,id:{in:o},profilePicUrl:{not:null}}})).reduce((a,c)=>a.set(c.id,c),new Map);i.forEach(async a=>{n.has(a.identifier)&&s.contacts.update({accountId:this.provider.accountId,id:a.id,data:{avatar_url:n.get(a.identifier).profilePictureUrl||null}})})}catch(s){this.logger.error(`Error on update avatar in recent conversations: ${s.toString()}`)}}async syncLostMessages(e,t,s){try{if(!this.isImportHistoryAvailable()||!this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE)return;let r=await this.getInbox(e),i=`select * from messages m
      where account_id = ${t.accountId}
      and inbox_id = ${r.id}
      and created_at >= now() - interval '6h'
      order by created_at desc`,n=((await this.pgClient.query(i))?.rows).filter(T=>!!T.source_id).map(T=>T.source_id.replace("WAID:","")),c=(await this.prismaRepository.message.findMany({where:{Instance:{name:e.instanceName},messageTimestamp:{gte:Number(Pe().subtract(6,"hours").unix())},AND:n.map(T=>({key:{path:["id"],not:T}}))}})).filter(T=>!M.isIgnorePhoneNumber(T.key?.remoteJid)),S=[];for(let T of c)!T.message||!T.key||!T.messageTimestamp||(_e.isLong(T?.messageTimestamp)&&(T.messageTimestamp=T.messageTimestamp?.toNumber()),S.push(s(T)));this.addHistoryMessages(e,S.filter(T=>!M.isIgnorePhoneNumber(T.key?.remoteJid))),await M.importHistoryMessages(e,this,r,this.provider),this.waMonitor.waInstances[e.instanceName].clearCacheChatwoot()}catch{return}}};v(J,"ChatwootService");var Te=J;export{Te as ChatwootService};
//# sourceMappingURL=chatwoot.service.mjs.map
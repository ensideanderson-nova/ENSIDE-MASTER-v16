var oe=Object.create;var m=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ie=Object.getPrototypeOf,ce=Object.prototype.hasOwnProperty;var Ne=(e,t,E)=>t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:E}):e[t]=E;var u=(e,t)=>m(e,"name",{value:t,configurable:!0});var pe=(e,t)=>{for(var E in t)m(e,E,{get:t[E],enumerable:!0})},k=(e,t,E,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let S of ae(t))!ce.call(e,S)&&S!==E&&m(e,S,{get:()=>t[S],enumerable:!(s=ne(t,S))||s.enumerable});return e};var M=(e,t,E)=>(E=e!=null?oe(ie(e)):{},k(t||!e||!e.__esModule?m(E,"default",{value:e,enumerable:!0}):E,e)),Oe=e=>k(m({},"__esModule",{value:!0}),e);var P=(e,t,E)=>Ne(e,typeof t!="symbol"?t+"":t,E);var Ie={};pe(Ie,{TypebotService:()=>J});module.exports=Oe(Ie);var g=(function(e){return e.APPLICATION_STARTUP="application.startup",e.INSTANCE_CREATE="instance.create",e.INSTANCE_DELETE="instance.delete",e.QRCODE_UPDATED="qrcode.updated",e.CONNECTION_UPDATE="connection.update",e.STATUS_INSTANCE="status.instance",e.MESSAGES_SET="messages.set",e.MESSAGES_UPSERT="messages.upsert",e.MESSAGES_EDITED="messages.edited",e.MESSAGES_UPDATE="messages.update",e.MESSAGES_DELETE="messages.delete",e.SEND_MESSAGE="send.message",e.SEND_MESSAGE_UPDATE="send.message.update",e.CONTACTS_SET="contacts.set",e.CONTACTS_UPSERT="contacts.upsert",e.CONTACTS_UPDATE="contacts.update",e.PRESENCE_UPDATE="presence.update",e.CHATS_SET="chats.set",e.CHATS_UPDATE="chats.update",e.CHATS_UPSERT="chats.upsert",e.CHATS_DELETE="chats.delete",e.GROUPS_UPSERT="groups.upsert",e.GROUPS_UPDATE="groups.update",e.GROUP_PARTICIPANTS_UPDATE="group-participants.update",e.CALL="call",e.TYPEBOT_START="typebot.start",e.TYPEBOT_CHANGE_STATUS="typebot.change-status",e.LABELS_EDIT="labels.edit",e.LABELS_ASSOCIATION="labels.association",e.CREDS_UPDATE="creds.update",e.MESSAGING_HISTORY_SET="messaging-history.set",e.REMOVE_INSTANCE="remove.instance",e.LOGOUT_INSTANCE="logout.instance",e})({});var W={WHATSAPP_BUSINESS:"WHATSAPP-BUSINESS",WHATSAPP_BAILEYS:"WHATSAPP-BAILEYS",EVOLUTION:"EVOLUTION"};var Y=require("class-validator"),Z=M(require("dotenv"));Z.default.config();var Q=class Q{constructor(){P(this,"env");this.loadEnv()}get(t){return this.env[t]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{NAME:process.env?.SERVER_NAME||"evolution",TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY,EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",FRAME_MAX:Number.parseInt(process.env.RABBITMQ_FRAME_MAX)||8192,EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},NATS:{ENABLED:process.env?.NATS_ENABLED==="true",GLOBAL_ENABLED:process.env?.NATS_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.NATS_PREFIX_KEY,EXCHANGE_NAME:process.env?.NATS_EXCHANGE_NAME||"evolution_exchange",URI:process.env.NATS_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.NATS_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.NATS_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.NATS_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.NATS_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.NATS_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.NATS_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.NATS_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.NATS_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.NATS_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.NATS_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.NATS_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.NATS_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.NATS_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.NATS_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.NATS_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.NATS_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.NATS_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.NATS_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.NATS_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.NATS_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.NATS_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.NATS_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.NATS_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.NATS_EVENTS_CALL==="true",TYPEBOT_START:process.env?.NATS_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",GLOBAL_ENABLED:process.env?.SQS_GLOBAL_ENABLED==="true",GLOBAL_FORCE_SINGLE_QUEUE:process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE==="true",GLOBAL_PREFIX_NAME:process.env?.SQS_GLOBAL_PREFIX_NAME||"global",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||"",MAX_PAYLOAD_SIZE:Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE??"1048576"),EVENTS:{APPLICATION_STARTUP:process.env?.SQS_GLOBAL_APPLICATION_STARTUP==="true",CALL:process.env?.SQS_GLOBAL_CALL==="true",CHATS_DELETE:process.env?.SQS_GLOBAL_CHATS_DELETE==="true",CHATS_SET:process.env?.SQS_GLOBAL_CHATS_SET==="true",CHATS_UPDATE:process.env?.SQS_GLOBAL_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.SQS_GLOBAL_CHATS_UPSERT==="true",CONNECTION_UPDATE:process.env?.SQS_GLOBAL_CONNECTION_UPDATE==="true",CONTACTS_SET:process.env?.SQS_GLOBAL_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.SQS_GLOBAL_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.SQS_GLOBAL_CONTACTS_UPSERT==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE==="true",GROUPS_UPDATE:process.env?.SQS_GLOBAL_GROUPS_UPDATE==="true",GROUPS_UPSERT:process.env?.SQS_GLOBAL_GROUPS_UPSERT==="true",LABELS_ASSOCIATION:process.env?.SQS_GLOBAL_LABELS_ASSOCIATION==="true",LABELS_EDIT:process.env?.SQS_GLOBAL_LABELS_EDIT==="true",LOGOUT_INSTANCE:process.env?.SQS_GLOBAL_LOGOUT_INSTANCE==="true",MESSAGES_DELETE:process.env?.SQS_GLOBAL_MESSAGES_DELETE==="true",MESSAGES_EDITED:process.env?.SQS_GLOBAL_MESSAGES_EDITED==="true",MESSAGES_SET:process.env?.SQS_GLOBAL_MESSAGES_SET==="true",MESSAGES_UPDATE:process.env?.SQS_GLOBAL_MESSAGES_UPDATE==="true",MESSAGES_UPSERT:process.env?.SQS_GLOBAL_MESSAGES_UPSERT==="true",PRESENCE_UPDATE:process.env?.SQS_GLOBAL_PRESENCE_UPDATE==="true",QRCODE_UPDATED:process.env?.SQS_GLOBAL_QRCODE_UPDATED==="true",REMOVE_INSTANCE:process.env?.SQS_GLOBAL_REMOVE_INSTANCE==="true",SEND_MESSAGE:process.env?.SQS_GLOBAL_SEND_MESSAGE==="true",TYPEBOT_CHANGE_STATUS:process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS==="true",TYPEBOT_START:process.env?.SQS_GLOBAL_TYPEBOT_START==="true"}},KAFKA:{ENABLED:process.env?.KAFKA_ENABLED==="true",CLIENT_ID:process.env?.KAFKA_CLIENT_ID||"evolution-api",BROKERS:process.env?.KAFKA_BROKERS?.split(",")||["localhost:9092"],CONNECTION_TIMEOUT:Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT||"3000"),REQUEST_TIMEOUT:Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT||"30000"),GLOBAL_ENABLED:process.env?.KAFKA_GLOBAL_ENABLED==="true",CONSUMER_GROUP_ID:process.env?.KAFKA_CONSUMER_GROUP_ID||"evolution-api-consumers",TOPIC_PREFIX:process.env?.KAFKA_TOPIC_PREFIX||"evolution",NUM_PARTITIONS:Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS||"1"),REPLICATION_FACTOR:Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR||"1"),AUTO_CREATE_TOPICS:process.env?.KAFKA_AUTO_CREATE_TOPICS==="true",EVENTS:{APPLICATION_STARTUP:process.env?.KAFKA_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.KAFKA_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.KAFKA_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.KAFKA_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.KAFKA_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.KAFKA_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.KAFKA_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.KAFKA_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.KAFKA_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.KAFKA_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.KAFKA_EVENTS_CONTACTS_SET==="true",CONTACTS_UPSERT:process.env?.KAFKA_EVENTS_CONTACTS_UPSERT==="true",CONTACTS_UPDATE:process.env?.KAFKA_EVENTS_CONTACTS_UPDATE==="true",PRESENCE_UPDATE:process.env?.KAFKA_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.KAFKA_EVENTS_CHATS_SET==="true",CHATS_UPSERT:process.env?.KAFKA_EVENTS_CHATS_UPSERT==="true",CHATS_UPDATE:process.env?.KAFKA_EVENTS_CHATS_UPDATE==="true",CHATS_DELETE:process.env?.KAFKA_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.KAFKA_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.KAFKA_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.KAFKA_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.KAFKA_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.KAFKA_EVENTS_CALL==="true",TYPEBOT_START:process.env?.KAFKA_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS==="true"},SASL:process.env?.KAFKA_SASL_ENABLED==="true"?{ENABLED:!0,MECHANISM:process.env?.KAFKA_SASL_MECHANISM||"plain",USERNAME:process.env?.KAFKA_SASL_USERNAME||"",PASSWORD:process.env?.KAFKA_SASL_PASSWORD||""}:void 0,SSL:process.env?.KAFKA_SSL_ENABLED==="true"?{ENABLED:!0,REJECT_UNAUTHORIZED:process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED!=="false",CA:process.env?.KAFKA_SSL_CA,KEY:process.env?.KAFKA_SSL_KEY,CERT:process.env?.KAFKA_SSL_CERT}:void 0},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true",ALLOWED_HOSTS:process.env?.WEBSOCKET_ALLOWED_HOSTS},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:(0,Y.isBooleanString)(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:(0,Y.isBooleanString)(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""},REQUEST:{TIMEOUT_MS:Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS)||3e4},RETRY:{MAX_ATTEMPTS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS)||10,INITIAL_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS)||5,USE_EXPONENTIAL_BACKOFF:process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF!=="false",MAX_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS)||300,JITTER_FACTOR:Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR)||.2,NON_RETRYABLE_STATUS_CODES:process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(",").map(Number)||[400,401,403,404,422]}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome"},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},N8N:{ENABLED:process.env?.N8N_ENABLED==="true"},EVOAI:{ENABLED:process.env?.EVOAI_ENABLED==="true"},FLOWISE:{ENABLED:process.env?.FLOWISE_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION,SKIP_POLICY:process.env?.S3_SKIP_POLICY==="true",SAVE_VIDEO:process.env?.S3_SAVE_VIDEO==="true"},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"},METRICS:{ENABLED:process.env?.PROMETHEUS_METRICS==="true",AUTH_REQUIRED:process.env?.METRICS_AUTH_REQUIRED==="true",USER:process.env?.METRICS_USER,PASSWORD:process.env?.METRICS_PASSWORD,ALLOWED_IPS:process.env?.METRICS_ALLOWED_IPS},TELEMETRY:{ENABLED:process.env?.TELEMETRY_ENABLED===void 0||process.env?.TELEMETRY_ENABLED==="true",URL:process.env?.TELEMETRY_URL},PROXY:{HOST:process.env?.PROXY_HOST,PORT:process.env?.PROXY_PORT,PROTOCOL:process.env?.PROXY_PROTOCOL,USERNAME:process.env?.PROXY_USERNAME,PASSWORD:process.env?.PROXY_PASSWORD},AUDIO_CONVERTER:{API_URL:process.env?.API_AUDIO_CONVERTER,API_KEY:process.env?.API_AUDIO_CONVERTER_KEY},FACEBOOK:{APP_ID:process.env?.FACEBOOK_APP_ID,CONFIG_ID:process.env?.FACEBOOK_CONFIG_ID,USER_TOKEN:process.env?.FACEBOOK_USER_TOKEN},SENTRY:{DSN:process.env?.SENTRY_DSN},EVENT_EMITTER:{MAX_LISTENERS:Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS)||50}}}};u(Q,"ConfigService");var F=Q,d=new F;var ue=u(e=>{let t;d.get("S3").ENABLE&&(d.get("S3").SAVE_VIDEO||e?.message?.videoMessage===void 0&&e?.message?.viewOnceMessageV2?.message?.videoMessage===void 0)?t=e.message?.mediaUrl:t=e.key?.id;let E={conversation:e?.message?.conversation,extendedTextMessage:e?.message?.extendedTextMessage?.text,contactMessage:e?.message?.contactMessage?.displayName,locationMessage:e?.message?.locationMessage?.degreesLatitude.toString(),viewOnceMessageV2:e?.message?.viewOnceMessageV2?.message?.imageMessage?.url||e?.message?.viewOnceMessageV2?.message?.videoMessage?.url||e?.message?.viewOnceMessageV2?.message?.audioMessage?.url,listResponseMessage:e?.message?.listResponseMessage?.title||e?.listResponseMessage?.title,responseRowId:e?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,templateButtonReplyMessage:e?.message?.templateButtonReplyMessage?.selectedId||e?.message?.buttonsResponseMessage?.selectedButtonId,audioMessage:e?.message?.speechToText?e?.message?.speechToText:e?.message?.audioMessage?`audioMessage|${t}`:void 0,imageMessage:e?.message?.imageMessage?`imageMessage|${t}${e?.message?.imageMessage?.caption?`|${e?.message?.imageMessage?.caption}`:""}`:void 0,videoMessage:e?.message?.videoMessage?`videoMessage|${t}${e?.message?.videoMessage?.caption?`|${e?.message?.videoMessage?.caption}`:""}`:void 0,documentMessage:e?.message?.documentMessage?`documentMessage|${t}${e?.message?.documentMessage?.caption?`|${e?.message?.documentMessage?.caption}`:""}`:void 0,documentWithCaptionMessage:e?.message?.documentWithCaptionMessage?.message?.documentMessage?`documentWithCaptionMessage|${t}${e?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption?`|${e?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption}`:""}`:void 0,externalAdReplyBody:e?.contextInfo?.externalAdReply?.body?`externalAdReplyBody|${e.contextInfo.externalAdReply.body}`:void 0},s=Object.keys(E).find(S=>E[S]!==void 0)||"unknown";return{...E,messageType:s}},"getTypeMessage"),Re=u(e=>{let t=Object.keys(e).find(s=>s!=="externalAdReplyBody"&&e[s]!==void 0),E=t?e[t]:void 0;return e.externalAdReplyBody&&(E=E?`${E}
${e.externalAdReplyBody}`:e.externalAdReplyBody),E},"getMessageContent"),z=u(e=>{let t=ue(e);return Re(t)},"getConversationMessage");var ee=M(require("axios")),Ee=M(require("fs"));var Ce=JSON.parse(Ee.default.readFileSync("./package.json","utf8")),D=u(async e=>{let t=d.get("TELEMETRY");if(!t.ENABLED||e==="/")return;let E={route:e,apiVersion:`${Ce.version}`,timestamp:new Date},s=t.URL&&t.URL!==""?t.URL:"https://log.evolution-api.com/telemetry";ee.default.post(s,E).then(()=>{}).catch(()=>{})},"sendTelemetry");var G=M(require("axios"));var te=M(require("dayjs")),Se=M(require("fs"));var Pe=JSON.parse(Se.default.readFileSync("./package.json","utf8")),se=u(e=>(0,te.default)(e).toDate().toString().replace(/\sGMT.+/,""),"formatDateLog"),U=(function(e){return e.LOG="\x1B[32m",e.INFO="\x1B[34m",e.WARN="\x1B[33m",e.ERROR="\x1B[31m",e.DEBUG="\x1B[36m",e.VERBOSE="\x1B[37m",e.DARK="\x1B[30m",e})(U||{});var re=(function(e){return e.LOG="\x1B[32m%s\x1B[0m",e.DARK="\x1B[30m%s\x1B[0m",e.INFO="\x1B[34m%s\x1B[0m",e.WARN="\x1B[33m%s\x1B[0m",e.ERROR="\x1B[31m%s\x1B[0m",e.DEBUG="\x1B[36m%s\x1B[0m",e.VERBOSE="\x1B[37m%s\x1B[0m",e})(re||{}),Te=(function(e){return e.LOG="LOG",e.WARN="WARN",e.INFO="INFO",e.DARK="DARK",e.ERROR="ERROR",e.DEBUG="DEBUG",e.VERBOSE="VERBOSE",e})(Te||{}),Ae=(function(e){return e.LOG="\x1B[42m",e.INFO="\x1B[44m",e.WARN="\x1B[43m",e.DARK="\x1B[40m",e.ERROR="\x1B[41m",e.DEBUG="\x1B[46m",e.VERBOSE="\x1B[47m",e})(Ae||{}),$=class ${constructor(t="Logger"){P(this,"configService",d);P(this,"context");P(this,"instance",null);this.context=t}setContext(t){this.context=t}setInstance(t){this.instance=t}console(t,E){let s=[];this.configService.get("LOG").LEVEL.forEach(r=>s.push(Te[r]));let S=typeof t;s.includes(E)&&(d.get("LOG").COLOR?(console.log("\x1B[1m"+re[E],"[Evolution API]","\x1B[1m"+U[E],this.instance?`[${this.instance}]`:"","\x1B[1m"+U[E],`v${Pe.version}`,"\x1B[1m"+U[E],process.pid.toString(),"\x1B[0m","\x1B[1m"+U[E],"-","\x1B[1m\x1B[37m",`${se(Date.now())}  `,"\x1B[0m",U[E]+Ae[E]+"\x1B[1m",`${E} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,U[E]+"\x1B[1m",`[${S}]\x1B[0m`,U[E],S!=="object"?t:"","\x1B[0m"),S==="object"&&console.log(t,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${se(Date.now())}  `,`${E} `,`[${this.context}]`,`[${S}]`,t))}log(t){this.console(t,"LOG")}info(t){this.console(t,"INFO")}warn(t){this.console(t,"WARN")}error(t){this.console(t,"ERROR")}verbose(t){this.console(t,"VERBOSE")}debug(t){this.console(t,"DEBUG")}dark(t){this.console(t,"DARK")}};u($,"Logger");var H=$;var X=class X{constructor(t,E,s,S){P(this,"logger");P(this,"waMonitor");P(this,"prismaRepository");P(this,"configService");this.waMonitor=t,this.prismaRepository=E,this.logger=new H(s),this.configService=S}isImageMessage(t){return t.includes("imageMessage")}isAudioMessage(t){return t.includes("audioMessage")}isJSON(t){try{return JSON.parse(t),!0}catch{return!1}}getMediaType(t){let E=t.split(".").pop()?.toLowerCase(),s=["jpg","jpeg","png","gif","bmp","webp"],S=["mp3","wav","aac","ogg"],r=["mp4","avi","mkv","mov"],T=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return s.includes(E||"")?"image":S.includes(E||"")?"audio":r.includes(E||"")?"video":T.includes(E||"")?"document":null}async createNewSession(t,E,s){try{let S=typeof E.pushName=="object"&&E.pushName?.pushName?E.pushName.pushName:typeof E.pushName=="string"?E.pushName:null,r=typeof E.remoteJid=="object"&&E.remoteJid?.remoteJid?E.remoteJid.remoteJid:E.remoteJid;return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:r,pushName:S,sessionId:r,status:"opened",awaitUser:!1,botId:E.botId,instanceId:t.instanceId,type:s}})}}catch(S){this.logger.error(S);return}}async process(t,E,s,S,r,T,A,_){try{if(!S){await this.initNewSession(t,E,s,r,S,T,A,_);return}if(S.status==="paused")return;let i=r?.keywordFinish||"",a=T.toLowerCase().trim();if(i.length>0&&a===i.toLowerCase()){await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"closed"}});return}await this.sendMessageToBot(t,S,r,s,E,A||"",T,_),await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"opened",awaitUser:!0}})}catch(i){this.logger.error(`Error in process: ${i}`);return}}async sendMessageWhatsApp(t,E,s,S,r=!0){if(!s)return;let T=/!?\[(.*?)\]\((.*?)\)/g,A="",_=0,i,a=S?.splitMessages??!1;for(;(i=T.exec(s))!==null;){let[o,c,n]=i,p=this.getMediaType(n),N=s.slice(_,i.index);if(N&&(A+=N),p){A.trim()&&(await this.sendFormattedText(t,E,A.trim(),S,a,r),A="");try{p==="audio"?await t.audioWhatsapp({number:E.includes("@lid")?E:E.split("@")[0],delay:S?.delayMessage||1e3,audio:n,caption:c}):await t.mediaMessage({number:E.includes("@lid")?E:E.split("@")[0],delay:S?.delayMessage||1e3,mediatype:p,media:n,caption:c,fileName:p==="document"?c||"document":void 0},null,!1)}catch(R){this.logger.error(`Error sending media: ${R}`),A+=`${c}: ${n}`}}else A+=o;_=T.lastIndex}if(_<s.length){let o=s.slice(_);o.trim()&&(A+=o)}A.trim()&&await this.sendFormattedText(t,E,A.trim(),S,a,r)}splitMessageByDoubleLineBreaks(t){return t.split(`

`).filter(E=>E.trim().length>0)}async sendSingleMessage(t,E,s,S,r=!0){let T=S?.timePerChar??0,i=Math.min(Math.max(s.length*T,1e3),2e4);this.logger.debug(`[BaseChatbot] Sending single message with linkPreview: ${r}`),t.integration===W.WHATSAPP_BAILEYS&&(await t.client.presenceSubscribe(E),await t.client.sendPresenceUpdate("composing",E)),await new Promise(a=>{setTimeout(async()=>{await t.textMessage({number:E.includes("@lid")?E:E.split("@")[0],delay:S?.delayMessage||1e3,text:s,linkPreview:r},!1),a()},i)}),t.integration===W.WHATSAPP_BAILEYS&&await t.client.sendPresenceUpdate("paused",E)}async sendFormattedText(t,E,s,S,r,T=!0){if(r){let A=this.splitMessageByDoubleLineBreaks(s);this.logger.debug(`[BaseChatbot] Splitting message into ${A.length} parts`);for(let _=0;_<A.length;_++){let i=A[_];this.logger.debug(`[BaseChatbot] Sending message part ${_+1}/${A.length}`),await this.sendSingleMessage(t,E,i,S,T)}this.logger.debug("[BaseChatbot] All message parts sent successfully")}else this.logger.debug("[BaseChatbot] Sending single message"),await this.sendSingleMessage(t,E,s,S,T)}async initNewSession(t,E,s,S,r,T,A,_){if(!r){let i=typeof A=="object"&&A?.pushName?A.pushName:typeof A=="string"?A:null,a=await this.createNewSession({instanceName:t.instanceName,instanceId:t.instanceId},{remoteJid:E,pushName:i,botId:s.id},this.getBotType());if(!a||!a.session){this.logger.error("Failed to create new session");return}r=a.session}await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"opened",awaitUser:!1}}),await this.sendMessageToBot(t,r,S,s,E,A||"",T,_)}};u(X,"BaseChatbotService");var K=X;var j=class j extends K{constructor(E,s,S,r){super(E,S,"TypebotService",s);P(this,"openaiService");this.openaiService=r}getBotType(){return"typebot"}async sendMessageToBot(E,s,S,r,T,A,_,i){await this.processTypebot(E,T,i,s,r,r.url,S.expire,r.typebot,S.keywordFinish,S.delayMessage,S.unknownMessage,S.listeningFromMe,S.stopBotFromMe,S.keepOpen,_)}async processTypebotSimple(E,s,S,r,T,A,_,i){return this.process(E,s,S,r,T,A,_,i)}async createNewSession(E,s){if(s.remoteJid==="status@broadcast")return;let S=Math.floor(Math.random()*1e10).toString();try{let r=this.configService.get("TYPEBOT").API_VERSION,T,A;r==="latest"?(T=`${s.url}/api/v1/typebots/${s.typebot}/startChat`,A={prefilledVariables:{...s.prefilledVariables,remoteJid:s.remoteJid,pushName:s.pushName||s.prefilledVariables?.pushName||"",instanceName:E.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:E.number}}):(T=`${s.url}/api/v1/sendMessage`,A={startParams:{publicId:s.typebot,prefilledVariables:{...s.prefilledVariables,remoteJid:s.remoteJid,pushName:s.pushName||s.prefilledVariables?.pushName||"",instanceName:E.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:E.number}}});let _=await G.default.post(T,A),i=null;_?.data?.sessionId&&(i=await this.prismaRepository.integrationSession.create({data:{remoteJid:s.remoteJid,pushName:s.pushName||"",sessionId:`${S}-${_.data.sessionId}`,status:"opened",parameters:{...s.prefilledVariables,remoteJid:s.remoteJid,pushName:s.pushName||"",instanceName:E.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:E.number},awaitUser:!1,botId:s.botId,type:"typebot",Instance:{connect:{id:E.id}}}}));let a={remoteJid:s.remoteJid,status:"opened",session:i};return this.waMonitor.waInstances[E.name].sendDataWebhook(g.TYPEBOT_CHANGE_STATUS,a),{..._.data,session:i}}catch(r){this.logger.error(r);return}}async sendWAMessage(E,s,S,r,T,A,_){let i=this.waMonitor.waInstances[E.name];await this.processMessages(i,s,S,T,A,_,this.applyFormatting.bind(this),this.prismaRepository).catch(a=>{console.error("Erro ao processar mensagens:",a)})}applyFormatting(E){let s="";if(E.text&&(s+=E.text),E.children&&E.type!=="a")for(let T of E.children)s+=this.applyFormatting(T);E.type==="p"&&E.type!=="inline-variable"&&(s=s.trim()+`
`),E.type==="inline-variable"&&(s=s.trim()),E.type==="ol"&&(s=`
`+s.split(`
`).map((T,A)=>T?`${A+1}. ${T}`:"").join(`
`)),E.type==="li"&&(s=s.split(`
`).map(T=>T?`  ${T}`:"").join(`
`));let S="";E.bold&&(S+="*"),E.italic&&(S+="_"),E.underline&&(S+="~");let r=`${S}${s}${S.split("").reverse().join("")}`;return E.url&&(r=E.children[0]?.text?`[${r}]
(${E.url})`:`${E.url}`),r}async processMessages(E,s,S,r,T,A,_,i){let a=u((o,c)=>{if(!o)return null;for(let n of o)if(n.lastBubbleBlockId===c)return n.wait?.secondsToWaitFor;return null},"findItemAndGetSecondsToWait");for(let o of r){if(o.type==="text"){let n="";for(let p of o.content.richText){for(let N of p.children)n+=_(N);n+=`
`}n=n.replace(/\*\*/g,"").replace(/__/,"").replace(/~~/,"").replace(/\n$/,""),n=n.replace(/\n$/,""),n.includes("[list]")?await this.processListMessage(E,n,s.remoteJid):n.includes("[buttons]")?await this.processButtonMessage(E,n,s.remoteJid):await this.sendMessageWhatsApp(E,s.remoteJid,n,S,!0),D("/message/sendText")}o.type==="image"&&(await E.mediaMessage({number:s.remoteJid,delay:S?.delayMessage||1e3,mediatype:"image",media:o.content.url},null,!1),D("/message/sendMedia")),o.type==="video"&&(await E.mediaMessage({number:s.remoteJid,delay:S?.delayMessage||1e3,mediatype:"video",media:o.content.url},null,!1),D("/message/sendMedia")),o.type==="audio"&&(await E.audioWhatsapp({number:s.remoteJid,delay:S?.delayMessage||1e3,encoding:!0,audio:o.content.url},!1),D("/message/sendWhatsAppAudio"));let c=a(A,o.id);c&&await new Promise(n=>setTimeout(n,c*1e3))}if(T){if(T.type==="choice input"){let o="",c=T.items;for(let n of c)o+=`\u25B6\uFE0F ${n.content}
`;o=o.replace(/\n$/,""),o.includes("[list]")?await this.processListMessage(E,o,s.remoteJid):o.includes("[buttons]")?await this.processButtonMessage(E,o,s.remoteJid):await this.sendMessageWhatsApp(E,s.remoteJid,o,S,!0),D("/message/sendText")}await i.integrationSession.update({where:{id:s.id},data:{awaitUser:!0}})}else{let o="closed";S?.keepOpen?await i.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):(await i.integrationSession.deleteMany({where:{id:s.id}}),o="delete");let c={remoteJid:s.remoteJid,status:o,session:s};E.sendDataWebhook(g.TYPEBOT_CHANGE_STATUS,c)}}async processListMessage(E,s,S){let r={number:S,title:"",description:"",buttonText:"",footerText:"",sections:[]},T=s.match(/\[title\]([\s\S]*?)(?=\[description\])/),A=s.match(/\[description\]([\s\S]*?)(?=\[buttonText\])/),_=s.match(/\[buttonText\]([\s\S]*?)(?=\[footerText\])/),i=s.match(/\[footerText\]([\s\S]*?)(?=\[menu\])/);T&&(r.title=T[1].trim()),A&&(r.description=A[1].trim()),_&&(r.buttonText=_[1].trim()),i&&(r.footerText=i[1].trim());let a=s.match(/\[menu\]([\s\S]*?)\[\/menu\]/)?.[1];if(a){let o=a.match(/\[section\]([\s\S]*?)(?=\[section\]|\[\/section\]|\[\/menu\])/g);o&&o.forEach(c=>{let n=c.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),p=c.match(/\[row\]([\s\S]*?)(?=\[row\]|\[\/row\]|\[\/section\]|\[\/menu\])/g),N={title:n,rows:p?.map(R=>({title:R.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),description:R.match(/description: (.*?)(?:\n|$)/)?.[1]?.trim(),rowId:R.match(/rowId: (.*?)(?:\n|$)/)?.[1]?.trim()}))||[]};r.sections.push(N)})}await E.listMessage(r)}async processButtonMessage(E,s,S){let r={number:S,thumbnailUrl:void 0,title:"",description:"",footer:"",buttons:[]},T=s.match(/\[thumbnailUrl\]([\s\S]*?)(?=\[title\])/),A=s.match(/\[title\]([\s\S]*?)(?=\[description\])/),_=s.match(/\[description\]([\s\S]*?)(?=\[footer\])/),i=s.match(/\[footer\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url))/);A&&(r.title=A[1].trim()),T&&(r.thumbnailUrl=T[1].trim()),_&&(r.description=_[1].trim()),i&&(r.footer=i[1].trim());let a={reply:/\[reply\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,pix:/\[pix\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,copy:/\[copy\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,call:/\[call\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,url:/\[url\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g};for(let[o,c]of Object.entries(a)){let n;for(;(n=c.exec(s))!==null;){let p=n[1].trim(),N={type:o};switch(o){case"pix":N.currency=p.match(/currency: (.*?)(?:\n|$)/)?.[1]?.trim(),N.name=p.match(/name: (.*?)(?:\n|$)/)?.[1]?.trim(),N.keyType=p.match(/keyType: (.*?)(?:\n|$)/)?.[1]?.trim(),N.key=p.match(/key: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"reply":N.displayText=p.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.id=p.match(/id: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"copy":N.displayText=p.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.copyCode=p.match(/copyCode: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"call":N.displayText=p.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.phoneNumber=p.match(/phone: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"url":N.displayText=p.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.url=p.match(/url: (.*?)(?:\n|$)/)?.[1]?.trim();break}Object.keys(N).length>1&&r.buttons.push(N)}}await E.buttonMessage(r)}async processTypebot(E,s,S,r,T,A,_,i,a,o,c,n,p,N,R,q){let I=await this.prismaRepository.instance.findFirst({where:{name:E.instanceName}});if(!I){this.logger.error("Instance not found in database");return}if(r&&_&&_>0){let O=Date.now(),L=new Date(r.updatedAt).getTime(),l=O-L;if(Math.floor(l/1e3/60)>_){N?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:T.id,remoteJid:s}});let C=await this.createNewSession(I,{enabled:T?.enabled,url:A,typebot:i,expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,remoteJid:s,pushName:S.pushName,botId:T.id,prefilledVariables:q});if(C?.session&&(r=C.session),!C?.messages||C.messages.length===0){let f=z(S.message);if(!f){c&&(await this.sendMessageWhatsApp(E,s,c,{delayMessage:o,expire:_,keywordFinish:a,listeningFromMe:n,stopBotFromMe:p,keepOpen:N,unknownMessage:c},!0),D("/message/sendText"));return}if(a&&f.toLowerCase()===a.toLowerCase()){let B="closed";N?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):(B="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:T.id,remoteJid:s}}));let h={remoteJid:s,status:B,session:r};E.sendDataWebhook(g.TYPEBOT_CHANGE_STATUS,h);return}try{let B=this.configService.get("TYPEBOT").API_VERSION,h,x;B==="latest"?(h=`${A}/api/v1/sessions/${C?.sessionId}/continueChat`,x={message:f}):(h=`${A}/api/v1/sendMessage`,x={message:f,sessionId:C?.sessionId});let w=await G.default.post(h,x);await this.sendWAMessage(I,r,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,w?.data?.messages,w?.data?.input,w?.data?.clientSideActions)}catch(B){this.logger.error(B);return}}C?.messages&&C.messages.length>0&&await this.sendWAMessage(I,r,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,C.messages,C.input,C.clientSideActions);return}}if(r&&r.status!=="opened")return;if(!r){let O=await this.createNewSession(I,{enabled:T?.enabled,url:A,typebot:i,expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,remoteJid:s,pushName:S?.pushName,botId:T.id,prefilledVariables:q});if(O?.session&&(r=O.session),O?.messages&&O.messages.length>0&&await this.sendWAMessage(I,r,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,O.messages,O.input,O.clientSideActions),!O?.messages||O.messages.length===0){if(!R){c&&(await this.sendMessageWhatsApp(E,s,c,{delayMessage:o,expire:_,keywordFinish:a,listeningFromMe:n,stopBotFromMe:p,keepOpen:N,unknownMessage:c},!0),D("/message/sendText"));return}if(a&&R.toLowerCase()===a.toLowerCase()){let l="closed";N?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):(l="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:T.id,remoteJid:s}}));let v={remoteJid:s,status:l,session:r};E.sendDataWebhook(g.TYPEBOT_CHANGE_STATUS,v);return}let L;try{let l=this.configService.get("TYPEBOT").API_VERSION,v,C;l==="latest"?(v=`${A}/api/v1/sessions/${O?.sessionId}/continueChat`,C={message:R}):(v=`${A}/api/v1/sendMessage`,C={message:R,sessionId:O?.sessionId}),L=await G.default.post(v,C),await this.sendWAMessage(I,r,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,L?.data?.messages,L?.data?.input,L?.data?.clientSideActions)}catch(l){this.logger.error(l);return}}return}if(await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"opened",awaitUser:!1}}),!R){c&&(await this.sendMessageWhatsApp(E,s,c,{delayMessage:o,expire:_,keywordFinish:a,listeningFromMe:n,stopBotFromMe:p,keepOpen:N,unknownMessage:c},!0),D("/message/sendText"));return}if(a&&R.toLowerCase()===a.toLowerCase()){let O="closed";N?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):(O="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:T.id,remoteJid:s}}));let L={remoteJid:s,status:O,session:r};E.sendDataWebhook(g.TYPEBOT_CHANGE_STATUS,L);return}let _e=this.configService.get("TYPEBOT").API_VERSION,b,V;if(_e==="latest"?(b=`${A}/api/v1/sessions/${r.sessionId.split("-")[1]}/continueChat`,V={message:R}):(b=`${A}/api/v1/sendMessage`,V={message:R,sessionId:r.sessionId.split("-")[1]}),this.isAudioMessage(R)&&S)try{this.logger.debug("[TypeBot] Downloading audio for Whisper transcription");let O=await this.openaiService.speechToText(S,I);O&&(V.message=`[audio] ${O}`)}catch(O){this.logger.error(`[TypeBot] Failed to transcribe audio: ${O}`)}let y=await G.default.post(b,V);await this.sendWAMessage(I,r,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,y?.data?.messages,y?.data?.input,y?.data?.clientSideActions)}};u(j,"TypebotService");var J=j;0&&(module.exports={TypebotService});
//# sourceMappingURL=typebot.service.js.map
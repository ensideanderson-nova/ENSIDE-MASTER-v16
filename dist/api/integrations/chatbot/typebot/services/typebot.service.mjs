var X=Object.defineProperty;var se=(E,t,e)=>t in E?X(E,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):E[t]=e;var u=(E,t)=>X(E,"name",{value:t,configurable:!0});var P=(E,t,e)=>se(E,typeof t!="symbol"?t+"":t,e);var m=(function(E){return E.APPLICATION_STARTUP="application.startup",E.INSTANCE_CREATE="instance.create",E.INSTANCE_DELETE="instance.delete",E.QRCODE_UPDATED="qrcode.updated",E.CONNECTION_UPDATE="connection.update",E.STATUS_INSTANCE="status.instance",E.MESSAGES_SET="messages.set",E.MESSAGES_UPSERT="messages.upsert",E.MESSAGES_EDITED="messages.edited",E.MESSAGES_UPDATE="messages.update",E.MESSAGES_DELETE="messages.delete",E.SEND_MESSAGE="send.message",E.SEND_MESSAGE_UPDATE="send.message.update",E.CONTACTS_SET="contacts.set",E.CONTACTS_UPSERT="contacts.upsert",E.CONTACTS_UPDATE="contacts.update",E.PRESENCE_UPDATE="presence.update",E.CHATS_SET="chats.set",E.CHATS_UPDATE="chats.update",E.CHATS_UPSERT="chats.upsert",E.CHATS_DELETE="chats.delete",E.GROUPS_UPSERT="groups.upsert",E.GROUPS_UPDATE="groups.update",E.GROUP_PARTICIPANTS_UPDATE="group-participants.update",E.CALL="call",E.TYPEBOT_START="typebot.start",E.TYPEBOT_CHANGE_STATUS="typebot.change-status",E.LABELS_EDIT="labels.edit",E.LABELS_ASSOCIATION="labels.association",E.CREDS_UPDATE="creds.update",E.MESSAGING_HISTORY_SET="messaging-history.set",E.REMOVE_INSTANCE="remove.instance",E.LOGOUT_INSTANCE="logout.instance",E})({});var x={WHATSAPP_BUSINESS:"WHATSAPP-BUSINESS",WHATSAPP_BAILEYS:"WHATSAPP-BAILEYS",EVOLUTION:"EVOLUTION"};import{isBooleanString as J}from"class-validator";import te from"dotenv";te.config();var W=class W{constructor(){P(this,"env");this.loadEnv()}get(t){return this.env[t]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{NAME:process.env?.SERVER_NAME||"evolution",TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY,EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",FRAME_MAX:Number.parseInt(process.env.RABBITMQ_FRAME_MAX)||8192,EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},NATS:{ENABLED:process.env?.NATS_ENABLED==="true",GLOBAL_ENABLED:process.env?.NATS_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.NATS_PREFIX_KEY,EXCHANGE_NAME:process.env?.NATS_EXCHANGE_NAME||"evolution_exchange",URI:process.env.NATS_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.NATS_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.NATS_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.NATS_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.NATS_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.NATS_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.NATS_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.NATS_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.NATS_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.NATS_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.NATS_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.NATS_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.NATS_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.NATS_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.NATS_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.NATS_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.NATS_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.NATS_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.NATS_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.NATS_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.NATS_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.NATS_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.NATS_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.NATS_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.NATS_EVENTS_CALL==="true",TYPEBOT_START:process.env?.NATS_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",GLOBAL_ENABLED:process.env?.SQS_GLOBAL_ENABLED==="true",GLOBAL_FORCE_SINGLE_QUEUE:process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE==="true",GLOBAL_PREFIX_NAME:process.env?.SQS_GLOBAL_PREFIX_NAME||"global",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||"",MAX_PAYLOAD_SIZE:Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE??"1048576"),EVENTS:{APPLICATION_STARTUP:process.env?.SQS_GLOBAL_APPLICATION_STARTUP==="true",CALL:process.env?.SQS_GLOBAL_CALL==="true",CHATS_DELETE:process.env?.SQS_GLOBAL_CHATS_DELETE==="true",CHATS_SET:process.env?.SQS_GLOBAL_CHATS_SET==="true",CHATS_UPDATE:process.env?.SQS_GLOBAL_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.SQS_GLOBAL_CHATS_UPSERT==="true",CONNECTION_UPDATE:process.env?.SQS_GLOBAL_CONNECTION_UPDATE==="true",CONTACTS_SET:process.env?.SQS_GLOBAL_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.SQS_GLOBAL_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.SQS_GLOBAL_CONTACTS_UPSERT==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE==="true",GROUPS_UPDATE:process.env?.SQS_GLOBAL_GROUPS_UPDATE==="true",GROUPS_UPSERT:process.env?.SQS_GLOBAL_GROUPS_UPSERT==="true",LABELS_ASSOCIATION:process.env?.SQS_GLOBAL_LABELS_ASSOCIATION==="true",LABELS_EDIT:process.env?.SQS_GLOBAL_LABELS_EDIT==="true",LOGOUT_INSTANCE:process.env?.SQS_GLOBAL_LOGOUT_INSTANCE==="true",MESSAGES_DELETE:process.env?.SQS_GLOBAL_MESSAGES_DELETE==="true",MESSAGES_EDITED:process.env?.SQS_GLOBAL_MESSAGES_EDITED==="true",MESSAGES_SET:process.env?.SQS_GLOBAL_MESSAGES_SET==="true",MESSAGES_UPDATE:process.env?.SQS_GLOBAL_MESSAGES_UPDATE==="true",MESSAGES_UPSERT:process.env?.SQS_GLOBAL_MESSAGES_UPSERT==="true",PRESENCE_UPDATE:process.env?.SQS_GLOBAL_PRESENCE_UPDATE==="true",QRCODE_UPDATED:process.env?.SQS_GLOBAL_QRCODE_UPDATED==="true",REMOVE_INSTANCE:process.env?.SQS_GLOBAL_REMOVE_INSTANCE==="true",SEND_MESSAGE:process.env?.SQS_GLOBAL_SEND_MESSAGE==="true",TYPEBOT_CHANGE_STATUS:process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS==="true",TYPEBOT_START:process.env?.SQS_GLOBAL_TYPEBOT_START==="true"}},KAFKA:{ENABLED:process.env?.KAFKA_ENABLED==="true",CLIENT_ID:process.env?.KAFKA_CLIENT_ID||"evolution-api",BROKERS:process.env?.KAFKA_BROKERS?.split(",")||["localhost:9092"],CONNECTION_TIMEOUT:Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT||"3000"),REQUEST_TIMEOUT:Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT||"30000"),GLOBAL_ENABLED:process.env?.KAFKA_GLOBAL_ENABLED==="true",CONSUMER_GROUP_ID:process.env?.KAFKA_CONSUMER_GROUP_ID||"evolution-api-consumers",TOPIC_PREFIX:process.env?.KAFKA_TOPIC_PREFIX||"evolution",NUM_PARTITIONS:Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS||"1"),REPLICATION_FACTOR:Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR||"1"),AUTO_CREATE_TOPICS:process.env?.KAFKA_AUTO_CREATE_TOPICS==="true",EVENTS:{APPLICATION_STARTUP:process.env?.KAFKA_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.KAFKA_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.KAFKA_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.KAFKA_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.KAFKA_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.KAFKA_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.KAFKA_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.KAFKA_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.KAFKA_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.KAFKA_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.KAFKA_EVENTS_CONTACTS_SET==="true",CONTACTS_UPSERT:process.env?.KAFKA_EVENTS_CONTACTS_UPSERT==="true",CONTACTS_UPDATE:process.env?.KAFKA_EVENTS_CONTACTS_UPDATE==="true",PRESENCE_UPDATE:process.env?.KAFKA_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.KAFKA_EVENTS_CHATS_SET==="true",CHATS_UPSERT:process.env?.KAFKA_EVENTS_CHATS_UPSERT==="true",CHATS_UPDATE:process.env?.KAFKA_EVENTS_CHATS_UPDATE==="true",CHATS_DELETE:process.env?.KAFKA_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.KAFKA_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.KAFKA_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.KAFKA_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.KAFKA_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.KAFKA_EVENTS_CALL==="true",TYPEBOT_START:process.env?.KAFKA_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS==="true"},SASL:process.env?.KAFKA_SASL_ENABLED==="true"?{ENABLED:!0,MECHANISM:process.env?.KAFKA_SASL_MECHANISM||"plain",USERNAME:process.env?.KAFKA_SASL_USERNAME||"",PASSWORD:process.env?.KAFKA_SASL_PASSWORD||""}:void 0,SSL:process.env?.KAFKA_SSL_ENABLED==="true"?{ENABLED:!0,REJECT_UNAUTHORIZED:process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED!=="false",CA:process.env?.KAFKA_SSL_CA,KEY:process.env?.KAFKA_SSL_KEY,CERT:process.env?.KAFKA_SSL_CERT}:void 0},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true",ALLOWED_HOSTS:process.env?.WEBSOCKET_ALLOWED_HOSTS},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:J(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:J(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""},REQUEST:{TIMEOUT_MS:Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS)||3e4},RETRY:{MAX_ATTEMPTS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS)||10,INITIAL_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS)||5,USE_EXPONENTIAL_BACKOFF:process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF!=="false",MAX_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS)||300,JITTER_FACTOR:Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR)||.2,NON_RETRYABLE_STATUS_CODES:process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(",").map(Number)||[400,401,403,404,422]}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome"},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},N8N:{ENABLED:process.env?.N8N_ENABLED==="true"},EVOAI:{ENABLED:process.env?.EVOAI_ENABLED==="true"},FLOWISE:{ENABLED:process.env?.FLOWISE_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION,SKIP_POLICY:process.env?.S3_SKIP_POLICY==="true",SAVE_VIDEO:process.env?.S3_SAVE_VIDEO==="true"},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"},METRICS:{ENABLED:process.env?.PROMETHEUS_METRICS==="true",AUTH_REQUIRED:process.env?.METRICS_AUTH_REQUIRED==="true",USER:process.env?.METRICS_USER,PASSWORD:process.env?.METRICS_PASSWORD,ALLOWED_IPS:process.env?.METRICS_ALLOWED_IPS},TELEMETRY:{ENABLED:process.env?.TELEMETRY_ENABLED===void 0||process.env?.TELEMETRY_ENABLED==="true",URL:process.env?.TELEMETRY_URL},PROXY:{HOST:process.env?.PROXY_HOST,PORT:process.env?.PROXY_PORT,PROTOCOL:process.env?.PROXY_PROTOCOL,USERNAME:process.env?.PROXY_USERNAME,PASSWORD:process.env?.PROXY_PASSWORD},AUDIO_CONVERTER:{API_URL:process.env?.API_AUDIO_CONVERTER,API_KEY:process.env?.API_AUDIO_CONVERTER_KEY},FACEBOOK:{APP_ID:process.env?.FACEBOOK_APP_ID,CONFIG_ID:process.env?.FACEBOOK_CONFIG_ID,USER_TOKEN:process.env?.FACEBOOK_USER_TOKEN},SENTRY:{DSN:process.env?.SENTRY_DSN},EVENT_EMITTER:{MAX_LISTENERS:Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS)||50}}}};u(W,"ConfigService");var w=W,d=new w;var Se=u(E=>{let t;d.get("S3").ENABLE&&(d.get("S3").SAVE_VIDEO||E?.message?.videoMessage===void 0&&E?.message?.viewOnceMessageV2?.message?.videoMessage===void 0)?t=E.message?.mediaUrl:t=E.key?.id;let e={conversation:E?.message?.conversation,extendedTextMessage:E?.message?.extendedTextMessage?.text,contactMessage:E?.message?.contactMessage?.displayName,locationMessage:E?.message?.locationMessage?.degreesLatitude.toString(),viewOnceMessageV2:E?.message?.viewOnceMessageV2?.message?.imageMessage?.url||E?.message?.viewOnceMessageV2?.message?.videoMessage?.url||E?.message?.viewOnceMessageV2?.message?.audioMessage?.url,listResponseMessage:E?.message?.listResponseMessage?.title||E?.listResponseMessage?.title,responseRowId:E?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,templateButtonReplyMessage:E?.message?.templateButtonReplyMessage?.selectedId||E?.message?.buttonsResponseMessage?.selectedButtonId,audioMessage:E?.message?.speechToText?E?.message?.speechToText:E?.message?.audioMessage?`audioMessage|${t}`:void 0,imageMessage:E?.message?.imageMessage?`imageMessage|${t}${E?.message?.imageMessage?.caption?`|${E?.message?.imageMessage?.caption}`:""}`:void 0,videoMessage:E?.message?.videoMessage?`videoMessage|${t}${E?.message?.videoMessage?.caption?`|${E?.message?.videoMessage?.caption}`:""}`:void 0,documentMessage:E?.message?.documentMessage?`documentMessage|${t}${E?.message?.documentMessage?.caption?`|${E?.message?.documentMessage?.caption}`:""}`:void 0,documentWithCaptionMessage:E?.message?.documentWithCaptionMessage?.message?.documentMessage?`documentWithCaptionMessage|${t}${E?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption?`|${E?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption}`:""}`:void 0,externalAdReplyBody:E?.contextInfo?.externalAdReply?.body?`externalAdReplyBody|${E.contextInfo.externalAdReply.body}`:void 0},s=Object.keys(e).find(r=>e[r]!==void 0)||"unknown";return{...e,messageType:s}},"getTypeMessage"),re=u(E=>{let t=Object.keys(E).find(s=>s!=="externalAdReplyBody"&&E[s]!==void 0),e=t?E[t]:void 0;return E.externalAdReplyBody&&(e=e?`${e}
${E.externalAdReplyBody}`:E.externalAdReplyBody),e},"getMessageContent"),j=u(E=>{let t=Se(E);return re(t)},"getConversationMessage");import Te from"axios";import Ae from"fs";var _e=JSON.parse(Ae.readFileSync("./package.json","utf8")),D=u(async E=>{let t=d.get("TELEMETRY");if(!t.ENABLED||E==="/")return;let e={route:E,apiVersion:`${_e.version}`,timestamp:new Date},s=t.URL&&t.URL!==""?t.URL:"https://log.evolution-api.com/telemetry";Te.post(s,e).then(()=>{}).catch(()=>{})},"sendTelemetry");import f from"axios";import oe from"dayjs";import ne from"fs";var ae=JSON.parse(ne.readFileSync("./package.json","utf8")),q=u(E=>oe(E).toDate().toString().replace(/\sGMT.+/,""),"formatDateLog"),U=(function(E){return E.LOG="\x1B[32m",E.INFO="\x1B[34m",E.WARN="\x1B[33m",E.ERROR="\x1B[31m",E.DEBUG="\x1B[36m",E.VERBOSE="\x1B[37m",E.DARK="\x1B[30m",E})(U||{});var k=(function(E){return E.LOG="\x1B[32m%s\x1B[0m",E.DARK="\x1B[30m%s\x1B[0m",E.INFO="\x1B[34m%s\x1B[0m",E.WARN="\x1B[33m%s\x1B[0m",E.ERROR="\x1B[31m%s\x1B[0m",E.DEBUG="\x1B[36m%s\x1B[0m",E.VERBOSE="\x1B[37m%s\x1B[0m",E})(k||{}),Z=(function(E){return E.LOG="LOG",E.WARN="WARN",E.INFO="INFO",E.DARK="DARK",E.ERROR="ERROR",E.DEBUG="DEBUG",E.VERBOSE="VERBOSE",E})(Z||{}),z=(function(E){return E.LOG="\x1B[42m",E.INFO="\x1B[44m",E.WARN="\x1B[43m",E.DARK="\x1B[40m",E.ERROR="\x1B[41m",E.DEBUG="\x1B[46m",E.VERBOSE="\x1B[47m",E})(z||{}),Y=class Y{constructor(t="Logger"){P(this,"configService",d);P(this,"context");P(this,"instance",null);this.context=t}setContext(t){this.context=t}setInstance(t){this.instance=t}console(t,e){let s=[];this.configService.get("LOG").LEVEL.forEach(S=>s.push(Z[S]));let r=typeof t;s.includes(e)&&(d.get("LOG").COLOR?(console.log("\x1B[1m"+k[e],"[Evolution API]","\x1B[1m"+U[e],this.instance?`[${this.instance}]`:"","\x1B[1m"+U[e],`v${ae.version}`,"\x1B[1m"+U[e],process.pid.toString(),"\x1B[0m","\x1B[1m"+U[e],"-","\x1B[1m\x1B[37m",`${q(Date.now())}  `,"\x1B[0m",U[e]+z[e]+"\x1B[1m",`${e} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,U[e]+"\x1B[1m",`[${r}]\x1B[0m`,U[e],r!=="object"?t:"","\x1B[0m"),r==="object"&&console.log(t,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${q(Date.now())}  `,`${e} `,`[${this.context}]`,`[${r}]`,t))}log(t){this.console(t,"LOG")}info(t){this.console(t,"INFO")}warn(t){this.console(t,"WARN")}error(t){this.console(t,"ERROR")}verbose(t){this.console(t,"VERBOSE")}debug(t){this.console(t,"DEBUG")}dark(t){this.console(t,"DARK")}};u(Y,"Logger");var G=Y;var F=class F{constructor(t,e,s,r){P(this,"logger");P(this,"waMonitor");P(this,"prismaRepository");P(this,"configService");this.waMonitor=t,this.prismaRepository=e,this.logger=new G(s),this.configService=r}isImageMessage(t){return t.includes("imageMessage")}isAudioMessage(t){return t.includes("audioMessage")}isJSON(t){try{return JSON.parse(t),!0}catch{return!1}}getMediaType(t){let e=t.split(".").pop()?.toLowerCase(),s=["jpg","jpeg","png","gif","bmp","webp"],r=["mp3","wav","aac","ogg"],S=["mp4","avi","mkv","mov"],T=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return s.includes(e||"")?"image":r.includes(e||"")?"audio":S.includes(e||"")?"video":T.includes(e||"")?"document":null}async createNewSession(t,e,s){try{let r=typeof e.pushName=="object"&&e.pushName?.pushName?e.pushName.pushName:typeof e.pushName=="string"?e.pushName:null,S=typeof e.remoteJid=="object"&&e.remoteJid?.remoteJid?e.remoteJid.remoteJid:e.remoteJid;return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:S,pushName:r,sessionId:S,status:"opened",awaitUser:!1,botId:e.botId,instanceId:t.instanceId,type:s}})}}catch(r){this.logger.error(r);return}}async process(t,e,s,r,S,T,A,_){try{if(!r){await this.initNewSession(t,e,s,S,r,T,A,_);return}if(r.status==="paused")return;let i=S?.keywordFinish||"",a=T.toLowerCase().trim();if(i.length>0&&a===i.toLowerCase()){await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}});return}await this.sendMessageToBot(t,r,S,s,e,A||"",T,_),await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"opened",awaitUser:!0}})}catch(i){this.logger.error(`Error in process: ${i}`);return}}async sendMessageWhatsApp(t,e,s,r,S=!0){if(!s)return;let T=/!?\[(.*?)\]\((.*?)\)/g,A="",_=0,i,a=r?.splitMessages??!1;for(;(i=T.exec(s))!==null;){let[o,c,n]=i,p=this.getMediaType(n),N=s.slice(_,i.index);if(N&&(A+=N),p){A.trim()&&(await this.sendFormattedText(t,e,A.trim(),r,a,S),A="");try{p==="audio"?await t.audioWhatsapp({number:e.includes("@lid")?e:e.split("@")[0],delay:r?.delayMessage||1e3,audio:n,caption:c}):await t.mediaMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:r?.delayMessage||1e3,mediatype:p,media:n,caption:c,fileName:p==="document"?c||"document":void 0},null,!1)}catch(R){this.logger.error(`Error sending media: ${R}`),A+=`${c}: ${n}`}}else A+=o;_=T.lastIndex}if(_<s.length){let o=s.slice(_);o.trim()&&(A+=o)}A.trim()&&await this.sendFormattedText(t,e,A.trim(),r,a,S)}splitMessageByDoubleLineBreaks(t){return t.split(`

`).filter(e=>e.trim().length>0)}async sendSingleMessage(t,e,s,r,S=!0){let T=r?.timePerChar??0,i=Math.min(Math.max(s.length*T,1e3),2e4);this.logger.debug(`[BaseChatbot] Sending single message with linkPreview: ${S}`),t.integration===x.WHATSAPP_BAILEYS&&(await t.client.presenceSubscribe(e),await t.client.sendPresenceUpdate("composing",e)),await new Promise(a=>{setTimeout(async()=>{await t.textMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:r?.delayMessage||1e3,text:s,linkPreview:S},!1),a()},i)}),t.integration===x.WHATSAPP_BAILEYS&&await t.client.sendPresenceUpdate("paused",e)}async sendFormattedText(t,e,s,r,S,T=!0){if(S){let A=this.splitMessageByDoubleLineBreaks(s);this.logger.debug(`[BaseChatbot] Splitting message into ${A.length} parts`);for(let _=0;_<A.length;_++){let i=A[_];this.logger.debug(`[BaseChatbot] Sending message part ${_+1}/${A.length}`),await this.sendSingleMessage(t,e,i,r,T)}this.logger.debug("[BaseChatbot] All message parts sent successfully")}else this.logger.debug("[BaseChatbot] Sending single message"),await this.sendSingleMessage(t,e,s,r,T)}async initNewSession(t,e,s,r,S,T,A,_){if(!S){let i=typeof A=="object"&&A?.pushName?A.pushName:typeof A=="string"?A:null,a=await this.createNewSession({instanceName:t.instanceName,instanceId:t.instanceId},{remoteJid:e,pushName:i,botId:s.id},this.getBotType());if(!a||!a.session){this.logger.error("Failed to create new session");return}S=a.session}await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"opened",awaitUser:!1}}),await this.sendMessageToBot(t,S,r,s,e,A||"",T,_)}};u(F,"BaseChatbotService");var V=F;var Q=class Q extends V{constructor(e,s,r,S){super(e,r,"TypebotService",s);P(this,"openaiService");this.openaiService=S}getBotType(){return"typebot"}async sendMessageToBot(e,s,r,S,T,A,_,i){await this.processTypebot(e,T,i,s,S,S.url,r.expire,S.typebot,r.keywordFinish,r.delayMessage,r.unknownMessage,r.listeningFromMe,r.stopBotFromMe,r.keepOpen,_)}async processTypebotSimple(e,s,r,S,T,A,_,i){return this.process(e,s,r,S,T,A,_,i)}async createNewSession(e,s){if(s.remoteJid==="status@broadcast")return;let r=Math.floor(Math.random()*1e10).toString();try{let S=this.configService.get("TYPEBOT").API_VERSION,T,A;S==="latest"?(T=`${s.url}/api/v1/typebots/${s.typebot}/startChat`,A={prefilledVariables:{...s.prefilledVariables,remoteJid:s.remoteJid,pushName:s.pushName||s.prefilledVariables?.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number}}):(T=`${s.url}/api/v1/sendMessage`,A={startParams:{publicId:s.typebot,prefilledVariables:{...s.prefilledVariables,remoteJid:s.remoteJid,pushName:s.pushName||s.prefilledVariables?.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number}}});let _=await f.post(T,A),i=null;_?.data?.sessionId&&(i=await this.prismaRepository.integrationSession.create({data:{remoteJid:s.remoteJid,pushName:s.pushName||"",sessionId:`${r}-${_.data.sessionId}`,status:"opened",parameters:{...s.prefilledVariables,remoteJid:s.remoteJid,pushName:s.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number},awaitUser:!1,botId:s.botId,type:"typebot",Instance:{connect:{id:e.id}}}}));let a={remoteJid:s.remoteJid,status:"opened",session:i};return this.waMonitor.waInstances[e.name].sendDataWebhook(m.TYPEBOT_CHANGE_STATUS,a),{..._.data,session:i}}catch(S){this.logger.error(S);return}}async sendWAMessage(e,s,r,S,T,A,_){let i=this.waMonitor.waInstances[e.name];await this.processMessages(i,s,r,T,A,_,this.applyFormatting.bind(this),this.prismaRepository).catch(a=>{console.error("Erro ao processar mensagens:",a)})}applyFormatting(e){let s="";if(e.text&&(s+=e.text),e.children&&e.type!=="a")for(let T of e.children)s+=this.applyFormatting(T);e.type==="p"&&e.type!=="inline-variable"&&(s=s.trim()+`
`),e.type==="inline-variable"&&(s=s.trim()),e.type==="ol"&&(s=`
`+s.split(`
`).map((T,A)=>T?`${A+1}. ${T}`:"").join(`
`)),e.type==="li"&&(s=s.split(`
`).map(T=>T?`  ${T}`:"").join(`
`));let r="";e.bold&&(r+="*"),e.italic&&(r+="_"),e.underline&&(r+="~");let S=`${r}${s}${r.split("").reverse().join("")}`;return e.url&&(S=e.children[0]?.text?`[${S}]
(${e.url})`:`${e.url}`),S}async processMessages(e,s,r,S,T,A,_,i){let a=u((o,c)=>{if(!o)return null;for(let n of o)if(n.lastBubbleBlockId===c)return n.wait?.secondsToWaitFor;return null},"findItemAndGetSecondsToWait");for(let o of S){if(o.type==="text"){let n="";for(let p of o.content.richText){for(let N of p.children)n+=_(N);n+=`
`}n=n.replace(/\*\*/g,"").replace(/__/,"").replace(/~~/,"").replace(/\n$/,""),n=n.replace(/\n$/,""),n.includes("[list]")?await this.processListMessage(e,n,s.remoteJid):n.includes("[buttons]")?await this.processButtonMessage(e,n,s.remoteJid):await this.sendMessageWhatsApp(e,s.remoteJid,n,r,!0),D("/message/sendText")}o.type==="image"&&(await e.mediaMessage({number:s.remoteJid,delay:r?.delayMessage||1e3,mediatype:"image",media:o.content.url},null,!1),D("/message/sendMedia")),o.type==="video"&&(await e.mediaMessage({number:s.remoteJid,delay:r?.delayMessage||1e3,mediatype:"video",media:o.content.url},null,!1),D("/message/sendMedia")),o.type==="audio"&&(await e.audioWhatsapp({number:s.remoteJid,delay:r?.delayMessage||1e3,encoding:!0,audio:o.content.url},!1),D("/message/sendWhatsAppAudio"));let c=a(A,o.id);c&&await new Promise(n=>setTimeout(n,c*1e3))}if(T){if(T.type==="choice input"){let o="",c=T.items;for(let n of c)o+=`\u25B6\uFE0F ${n.content}
`;o=o.replace(/\n$/,""),o.includes("[list]")?await this.processListMessage(e,o,s.remoteJid):o.includes("[buttons]")?await this.processButtonMessage(e,o,s.remoteJid):await this.sendMessageWhatsApp(e,s.remoteJid,o,r,!0),D("/message/sendText")}await i.integrationSession.update({where:{id:s.id},data:{awaitUser:!0}})}else{let o="closed";r?.keepOpen?await i.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):(await i.integrationSession.deleteMany({where:{id:s.id}}),o="delete");let c={remoteJid:s.remoteJid,status:o,session:s};e.sendDataWebhook(m.TYPEBOT_CHANGE_STATUS,c)}}async processListMessage(e,s,r){let S={number:r,title:"",description:"",buttonText:"",footerText:"",sections:[]},T=s.match(/\[title\]([\s\S]*?)(?=\[description\])/),A=s.match(/\[description\]([\s\S]*?)(?=\[buttonText\])/),_=s.match(/\[buttonText\]([\s\S]*?)(?=\[footerText\])/),i=s.match(/\[footerText\]([\s\S]*?)(?=\[menu\])/);T&&(S.title=T[1].trim()),A&&(S.description=A[1].trim()),_&&(S.buttonText=_[1].trim()),i&&(S.footerText=i[1].trim());let a=s.match(/\[menu\]([\s\S]*?)\[\/menu\]/)?.[1];if(a){let o=a.match(/\[section\]([\s\S]*?)(?=\[section\]|\[\/section\]|\[\/menu\])/g);o&&o.forEach(c=>{let n=c.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),p=c.match(/\[row\]([\s\S]*?)(?=\[row\]|\[\/row\]|\[\/section\]|\[\/menu\])/g),N={title:n,rows:p?.map(R=>({title:R.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),description:R.match(/description: (.*?)(?:\n|$)/)?.[1]?.trim(),rowId:R.match(/rowId: (.*?)(?:\n|$)/)?.[1]?.trim()}))||[]};S.sections.push(N)})}await e.listMessage(S)}async processButtonMessage(e,s,r){let S={number:r,thumbnailUrl:void 0,title:"",description:"",footer:"",buttons:[]},T=s.match(/\[thumbnailUrl\]([\s\S]*?)(?=\[title\])/),A=s.match(/\[title\]([\s\S]*?)(?=\[description\])/),_=s.match(/\[description\]([\s\S]*?)(?=\[footer\])/),i=s.match(/\[footer\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url))/);A&&(S.title=A[1].trim()),T&&(S.thumbnailUrl=T[1].trim()),_&&(S.description=_[1].trim()),i&&(S.footer=i[1].trim());let a={reply:/\[reply\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,pix:/\[pix\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,copy:/\[copy\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,call:/\[call\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,url:/\[url\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g};for(let[o,c]of Object.entries(a)){let n;for(;(n=c.exec(s))!==null;){let p=n[1].trim(),N={type:o};switch(o){case"pix":N.currency=p.match(/currency: (.*?)(?:\n|$)/)?.[1]?.trim(),N.name=p.match(/name: (.*?)(?:\n|$)/)?.[1]?.trim(),N.keyType=p.match(/keyType: (.*?)(?:\n|$)/)?.[1]?.trim(),N.key=p.match(/key: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"reply":N.displayText=p.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.id=p.match(/id: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"copy":N.displayText=p.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.copyCode=p.match(/copyCode: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"call":N.displayText=p.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.phoneNumber=p.match(/phone: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"url":N.displayText=p.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.url=p.match(/url: (.*?)(?:\n|$)/)?.[1]?.trim();break}Object.keys(N).length>1&&S.buttons.push(N)}}await e.buttonMessage(S)}async processTypebot(e,s,r,S,T,A,_,i,a,o,c,n,p,N,R,$){let I=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}});if(!I){this.logger.error("Instance not found in database");return}if(S&&_&&_>0){let O=Date.now(),L=new Date(S.updatedAt).getTime(),l=O-L;if(Math.floor(l/1e3/60)>_){N?await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:T.id,remoteJid:s}});let C=await this.createNewSession(I,{enabled:T?.enabled,url:A,typebot:i,expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,remoteJid:s,pushName:r.pushName,botId:T.id,prefilledVariables:$});if(C?.session&&(S=C.session),!C?.messages||C.messages.length===0){let h=j(r.message);if(!h){c&&(await this.sendMessageWhatsApp(e,s,c,{delayMessage:o,expire:_,keywordFinish:a,listeningFromMe:n,stopBotFromMe:p,keepOpen:N,unknownMessage:c},!0),D("/message/sendText"));return}if(a&&h.toLowerCase()===a.toLowerCase()){let B="closed";N?await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"closed"}}):(B="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:T.id,remoteJid:s}}));let M={remoteJid:s,status:B,session:S};e.sendDataWebhook(m.TYPEBOT_CHANGE_STATUS,M);return}try{let B=this.configService.get("TYPEBOT").API_VERSION,M,b;B==="latest"?(M=`${A}/api/v1/sessions/${C?.sessionId}/continueChat`,b={message:h}):(M=`${A}/api/v1/sendMessage`,b={message:h,sessionId:C?.sessionId});let y=await f.post(M,b);await this.sendWAMessage(I,S,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,y?.data?.messages,y?.data?.input,y?.data?.clientSideActions)}catch(B){this.logger.error(B);return}}C?.messages&&C.messages.length>0&&await this.sendWAMessage(I,S,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,C.messages,C.input,C.clientSideActions);return}}if(S&&S.status!=="opened")return;if(!S){let O=await this.createNewSession(I,{enabled:T?.enabled,url:A,typebot:i,expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,remoteJid:s,pushName:r?.pushName,botId:T.id,prefilledVariables:$});if(O?.session&&(S=O.session),O?.messages&&O.messages.length>0&&await this.sendWAMessage(I,S,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,O.messages,O.input,O.clientSideActions),!O?.messages||O.messages.length===0){if(!R){c&&(await this.sendMessageWhatsApp(e,s,c,{delayMessage:o,expire:_,keywordFinish:a,listeningFromMe:n,stopBotFromMe:p,keepOpen:N,unknownMessage:c},!0),D("/message/sendText"));return}if(a&&R.toLowerCase()===a.toLowerCase()){let l="closed";N?await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"closed"}}):(l="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:T.id,remoteJid:s}}));let v={remoteJid:s,status:l,session:S};e.sendDataWebhook(m.TYPEBOT_CHANGE_STATUS,v);return}let L;try{let l=this.configService.get("TYPEBOT").API_VERSION,v,C;l==="latest"?(v=`${A}/api/v1/sessions/${O?.sessionId}/continueChat`,C={message:R}):(v=`${A}/api/v1/sendMessage`,C={message:R,sessionId:O?.sessionId}),L=await f.post(v,C),await this.sendWAMessage(I,S,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,L?.data?.messages,L?.data?.input,L?.data?.clientSideActions)}catch(l){this.logger.error(l);return}}return}if(await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"opened",awaitUser:!1}}),!R){c&&(await this.sendMessageWhatsApp(e,s,c,{delayMessage:o,expire:_,keywordFinish:a,listeningFromMe:n,stopBotFromMe:p,keepOpen:N,unknownMessage:c},!0),D("/message/sendText"));return}if(a&&R.toLowerCase()===a.toLowerCase()){let O="closed";N?await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"closed"}}):(O="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:T.id,remoteJid:s}}));let L={remoteJid:s,status:O,session:S};e.sendDataWebhook(m.TYPEBOT_CHANGE_STATUS,L);return}let Ee=this.configService.get("TYPEBOT").API_VERSION,H,g;if(Ee==="latest"?(H=`${A}/api/v1/sessions/${S.sessionId.split("-")[1]}/continueChat`,g={message:R}):(H=`${A}/api/v1/sendMessage`,g={message:R,sessionId:S.sessionId.split("-")[1]}),this.isAudioMessage(R)&&r)try{this.logger.debug("[TypeBot] Downloading audio for Whisper transcription");let O=await this.openaiService.speechToText(r,I);O&&(g.message=`[audio] ${O}`)}catch(O){this.logger.error(`[TypeBot] Failed to transcribe audio: ${O}`)}let K=await f.post(H,g);await this.sendWAMessage(I,S,{expire:_,keywordFinish:a,delayMessage:o,unknownMessage:c,listeningFromMe:n,stopBotFromMe:p,keepOpen:N},s,K?.data?.messages,K?.data?.input,K?.data?.clientSideActions)}};u(Q,"TypebotService");var ee=Q;export{ee as TypebotService};
//# sourceMappingURL=typebot.service.mjs.map
{"version":3,"sources":["../../../../../../src/api/integrations/channel/whatsapp/voiceCalls/useVoiceCallsBaileys.ts"],"sourcesContent":["import { ConnectionState, WAConnectionState, WASocket } from 'baileys';\nimport { io, Socket } from 'socket.io-client';\n\nimport { ClientToServerEvents, ServerToClientEvents } from './transport.type';\n\nlet baileys_connection_state: WAConnectionState = 'close';\n\nexport const useVoiceCallsBaileys = async (\n  wavoip_token: string,\n  baileys_sock: WASocket,\n  status?: WAConnectionState,\n  logger?: boolean,\n) => {\n  baileys_connection_state = status ?? 'close';\n\n  const socket: Socket<ServerToClientEvents, ClientToServerEvents> = io('https://devices.wavoip.com/baileys', {\n    transports: ['websocket'],\n    path: `/${wavoip_token}/websocket`,\n  });\n\n  socket.on('connect', () => {\n    if (logger) console.log('[*] - Wavoip connected', socket.id);\n\n    socket.emit(\n      'init',\n      baileys_sock.authState.creds.me,\n      baileys_sock.authState.creds.account,\n      baileys_connection_state,\n    );\n  });\n\n  socket.on('disconnect', () => {\n    if (logger) console.log('[*] - Wavoip disconnect');\n  });\n\n  socket.on('connect_error', (error) => {\n    if (socket.active) {\n      if (logger)\n        console.log(\n          '[*] - Wavoip connection error temporary failure, the socket will automatically try to reconnect',\n          error,\n        );\n    } else {\n      if (logger) console.log('[*] - Wavoip connection error', error.message);\n    }\n  });\n\n  socket.on('onWhatsApp', async (jid, callback) => {\n    try {\n      const response: any = await baileys_sock.onWhatsApp(jid);\n\n      callback(response);\n\n      if (logger) console.log('[*] Success on call onWhatsApp function', response, jid);\n    } catch (error) {\n      if (logger) console.error('[*] Error on call onWhatsApp function', error);\n    }\n  });\n\n  socket.on('profilePictureUrl', async (jid, type, timeoutMs, callback) => {\n    try {\n      const response = await baileys_sock.profilePictureUrl(jid, type, timeoutMs);\n\n      callback(response);\n\n      if (logger) console.log('[*] Success on call profilePictureUrl function', response);\n    } catch (error) {\n      if (logger) console.error('[*] Error on call profilePictureUrl function', error);\n    }\n  });\n\n  socket.on('assertSessions', async (jids, force, callback) => {\n    try {\n      const response = await baileys_sock.assertSessions(jids);\n\n      callback(response);\n\n      if (logger) console.log('[*] Success on call assertSessions function', response);\n    } catch (error) {\n      if (logger) console.error('[*] Error on call assertSessions function', error);\n    }\n  });\n\n  socket.on('createParticipantNodes', async (jids, message, extraAttrs, callback) => {\n    try {\n      const response = await baileys_sock.createParticipantNodes(jids, message, extraAttrs);\n\n      callback(response, true);\n\n      if (logger) console.log('[*] Success on call createParticipantNodes function', response);\n    } catch (error) {\n      if (logger) console.error('[*] Error on call createParticipantNodes function', error);\n    }\n  });\n\n  socket.on('getUSyncDevices', async (jids, useCache, ignoreZeroDevices, callback) => {\n    try {\n      const response = await baileys_sock.getUSyncDevices(jids, useCache, ignoreZeroDevices);\n\n      callback(response);\n\n      if (logger) console.log('[*] Success on call getUSyncDevices function', response);\n    } catch (error) {\n      if (logger) console.error('[*] Error on call getUSyncDevices function', error);\n    }\n  });\n\n  socket.on('generateMessageTag', async (callback) => {\n    try {\n      const response = await baileys_sock.generateMessageTag();\n\n      callback(response);\n\n      if (logger) console.log('[*] Success on call generateMessageTag function', response);\n    } catch (error) {\n      if (logger) console.error('[*] Error on call generateMessageTag function', error);\n    }\n  });\n\n  socket.on('sendNode', async (stanza, callback) => {\n    try {\n      console.log('sendNode', JSON.stringify(stanza));\n      const response = await baileys_sock.sendNode(stanza);\n\n      callback(true);\n\n      if (logger) console.log('[*] Success on call sendNode function', response);\n    } catch (error) {\n      if (logger) console.error('[*] Error on call sendNode function', error);\n    }\n  });\n\n  socket.on('signalRepository:decryptMessage', async (jid, type, ciphertext, callback) => {\n    try {\n      const response = await baileys_sock.signalRepository.decryptMessage({\n        jid: jid,\n        type: type,\n        ciphertext: ciphertext,\n      });\n\n      callback(response);\n\n      if (logger) console.log('[*] Success on call signalRepository:decryptMessage function', response);\n    } catch (error) {\n      if (logger) console.error('[*] Error on call signalRepository:decryptMessage function', error);\n    }\n  });\n\n  // we only use this connection data to inform the webphone that the device is connected and creeds account to generate e2e whatsapp key for make call packets\n  baileys_sock.ev.on('connection.update', (update: Partial<ConnectionState>) => {\n    const { connection } = update;\n\n    if (connection) {\n      baileys_connection_state = connection;\n      socket\n        .timeout(1000)\n        .emit(\n          'connection.update:status',\n          baileys_sock.authState.creds.me,\n          baileys_sock.authState.creds.account,\n          connection,\n        );\n    }\n\n    if (update.qr) {\n      socket.timeout(1000).emit('connection.update:qr', update.qr);\n    }\n  });\n\n  baileys_sock.ws.on('CB:call', (packet) => {\n    if (logger) console.log('[*] Signling received');\n    socket.volatile.timeout(1000).emit('CB:call', packet);\n  });\n\n  baileys_sock.ws.on('CB:ack,class:call', (packet) => {\n    if (logger) console.log('[*] Signling ack received');\n    socket.volatile.timeout(1000).emit('CB:ack,class:call', packet);\n  });\n\n  return socket;\n};\n"],"mappings":"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","names":["io","baileys_connection_state","useVoiceCallsBaileys","__name","wavoip_token","baileys_sock","status","logger","socket","io","transports","path","on","console","log","id","emit","authState","creds","me","account","error","active","message","jid","callback","response","onWhatsApp","type","timeoutMs","profilePictureUrl","jids","force","assertSessions","extraAttrs","createParticipantNodes","useCache","ignoreZeroDevices","getUSyncDevices","generateMessageTag","stanza","JSON","stringify","sendNode","ciphertext","signalRepository","decryptMessage","ev","update","connection","timeout","qr","ws","packet","volatile"]}
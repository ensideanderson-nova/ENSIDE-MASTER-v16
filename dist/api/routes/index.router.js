var Oh=Object.create;var ft=Object.defineProperty;var Ph=Object.getOwnPropertyDescriptor;var xh=Object.getOwnPropertyNames;var kh=Object.getPrototypeOf,Dh=Object.prototype.hasOwnProperty;var Lh=(h,s,e)=>s in h?ft(h,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[s]=e;var l=(h,s)=>ft(h,"name",{value:s,configurable:!0});var Bh=(h,s)=>{for(var e in s)ft(h,e,{get:s[e],enumerable:!0})},Ul=(h,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of xh(s))!Dh.call(h,i)&&i!==e&&ft(h,i,{get:()=>s[i],enumerable:!(t=Ph(s,i))||t.enumerable});return h};var x=(h,s,e)=>(e=h!=null?Oh(kh(h)):{},Ul(s||!h||!h.__esModule?ft(e,"default",{value:h,enumerable:!0}):e,h)),Uh=h=>Ul(ft({},"__esModule",{value:!0}),h);var a=(h,s,e)=>Lh(h,typeof s!="symbol"?s+"":s,e);var $m={};Bh($m,{HttpStatus:()=>E,router:()=>fs});module.exports=Uh($m);var Wl=x(require("dayjs")),Jl=x(require("fs"));var bn=require("class-validator"),$l=x(require("dotenv"));$l.default.config();var In=class In{constructor(){a(this,"env");this.loadEnv()}get(s){return this.env[s]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{NAME:process.env?.SERVER_NAME||"evolution",TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY,EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",FRAME_MAX:Number.parseInt(process.env.RABBITMQ_FRAME_MAX)||8192,EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},NATS:{ENABLED:process.env?.NATS_ENABLED==="true",GLOBAL_ENABLED:process.env?.NATS_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.NATS_PREFIX_KEY,EXCHANGE_NAME:process.env?.NATS_EXCHANGE_NAME||"evolution_exchange",URI:process.env.NATS_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.NATS_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.NATS_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.NATS_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.NATS_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.NATS_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.NATS_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.NATS_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.NATS_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.NATS_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.NATS_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.NATS_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.NATS_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.NATS_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.NATS_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.NATS_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.NATS_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.NATS_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.NATS_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.NATS_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.NATS_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.NATS_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.NATS_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.NATS_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.NATS_EVENTS_CALL==="true",TYPEBOT_START:process.env?.NATS_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",GLOBAL_ENABLED:process.env?.SQS_GLOBAL_ENABLED==="true",GLOBAL_FORCE_SINGLE_QUEUE:process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE==="true",GLOBAL_PREFIX_NAME:process.env?.SQS_GLOBAL_PREFIX_NAME||"global",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||"",MAX_PAYLOAD_SIZE:Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE??"1048576"),EVENTS:{APPLICATION_STARTUP:process.env?.SQS_GLOBAL_APPLICATION_STARTUP==="true",CALL:process.env?.SQS_GLOBAL_CALL==="true",CHATS_DELETE:process.env?.SQS_GLOBAL_CHATS_DELETE==="true",CHATS_SET:process.env?.SQS_GLOBAL_CHATS_SET==="true",CHATS_UPDATE:process.env?.SQS_GLOBAL_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.SQS_GLOBAL_CHATS_UPSERT==="true",CONNECTION_UPDATE:process.env?.SQS_GLOBAL_CONNECTION_UPDATE==="true",CONTACTS_SET:process.env?.SQS_GLOBAL_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.SQS_GLOBAL_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.SQS_GLOBAL_CONTACTS_UPSERT==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE==="true",GROUPS_UPDATE:process.env?.SQS_GLOBAL_GROUPS_UPDATE==="true",GROUPS_UPSERT:process.env?.SQS_GLOBAL_GROUPS_UPSERT==="true",LABELS_ASSOCIATION:process.env?.SQS_GLOBAL_LABELS_ASSOCIATION==="true",LABELS_EDIT:process.env?.SQS_GLOBAL_LABELS_EDIT==="true",LOGOUT_INSTANCE:process.env?.SQS_GLOBAL_LOGOUT_INSTANCE==="true",MESSAGES_DELETE:process.env?.SQS_GLOBAL_MESSAGES_DELETE==="true",MESSAGES_EDITED:process.env?.SQS_GLOBAL_MESSAGES_EDITED==="true",MESSAGES_SET:process.env?.SQS_GLOBAL_MESSAGES_SET==="true",MESSAGES_UPDATE:process.env?.SQS_GLOBAL_MESSAGES_UPDATE==="true",MESSAGES_UPSERT:process.env?.SQS_GLOBAL_MESSAGES_UPSERT==="true",PRESENCE_UPDATE:process.env?.SQS_GLOBAL_PRESENCE_UPDATE==="true",QRCODE_UPDATED:process.env?.SQS_GLOBAL_QRCODE_UPDATED==="true",REMOVE_INSTANCE:process.env?.SQS_GLOBAL_REMOVE_INSTANCE==="true",SEND_MESSAGE:process.env?.SQS_GLOBAL_SEND_MESSAGE==="true",TYPEBOT_CHANGE_STATUS:process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS==="true",TYPEBOT_START:process.env?.SQS_GLOBAL_TYPEBOT_START==="true"}},KAFKA:{ENABLED:process.env?.KAFKA_ENABLED==="true",CLIENT_ID:process.env?.KAFKA_CLIENT_ID||"evolution-api",BROKERS:process.env?.KAFKA_BROKERS?.split(",")||["localhost:9092"],CONNECTION_TIMEOUT:Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT||"3000"),REQUEST_TIMEOUT:Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT||"30000"),GLOBAL_ENABLED:process.env?.KAFKA_GLOBAL_ENABLED==="true",CONSUMER_GROUP_ID:process.env?.KAFKA_CONSUMER_GROUP_ID||"evolution-api-consumers",TOPIC_PREFIX:process.env?.KAFKA_TOPIC_PREFIX||"evolution",NUM_PARTITIONS:Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS||"1"),REPLICATION_FACTOR:Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR||"1"),AUTO_CREATE_TOPICS:process.env?.KAFKA_AUTO_CREATE_TOPICS==="true",EVENTS:{APPLICATION_STARTUP:process.env?.KAFKA_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.KAFKA_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.KAFKA_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.KAFKA_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.KAFKA_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.KAFKA_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.KAFKA_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.KAFKA_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.KAFKA_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.KAFKA_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.KAFKA_EVENTS_CONTACTS_SET==="true",CONTACTS_UPSERT:process.env?.KAFKA_EVENTS_CONTACTS_UPSERT==="true",CONTACTS_UPDATE:process.env?.KAFKA_EVENTS_CONTACTS_UPDATE==="true",PRESENCE_UPDATE:process.env?.KAFKA_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.KAFKA_EVENTS_CHATS_SET==="true",CHATS_UPSERT:process.env?.KAFKA_EVENTS_CHATS_UPSERT==="true",CHATS_UPDATE:process.env?.KAFKA_EVENTS_CHATS_UPDATE==="true",CHATS_DELETE:process.env?.KAFKA_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.KAFKA_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.KAFKA_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.KAFKA_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.KAFKA_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.KAFKA_EVENTS_CALL==="true",TYPEBOT_START:process.env?.KAFKA_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS==="true"},SASL:process.env?.KAFKA_SASL_ENABLED==="true"?{ENABLED:!0,MECHANISM:process.env?.KAFKA_SASL_MECHANISM||"plain",USERNAME:process.env?.KAFKA_SASL_USERNAME||"",PASSWORD:process.env?.KAFKA_SASL_PASSWORD||""}:void 0,SSL:process.env?.KAFKA_SSL_ENABLED==="true"?{ENABLED:!0,REJECT_UNAUTHORIZED:process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED!=="false",CA:process.env?.KAFKA_SSL_CA,KEY:process.env?.KAFKA_SSL_KEY,CERT:process.env?.KAFKA_SSL_CERT}:void 0},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true",ALLOWED_HOSTS:process.env?.WEBSOCKET_ALLOWED_HOSTS},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:(0,bn.isBooleanString)(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:(0,bn.isBooleanString)(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""},REQUEST:{TIMEOUT_MS:Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS)||3e4},RETRY:{MAX_ATTEMPTS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS)||10,INITIAL_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS)||5,USE_EXPONENTIAL_BACKOFF:process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF!=="false",MAX_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS)||300,JITTER_FACTOR:Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR)||.2,NON_RETRYABLE_STATUS_CODES:process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(",").map(Number)||[400,401,403,404,422]}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome"},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},N8N:{ENABLED:process.env?.N8N_ENABLED==="true"},EVOAI:{ENABLED:process.env?.EVOAI_ENABLED==="true"},FLOWISE:{ENABLED:process.env?.FLOWISE_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION,SKIP_POLICY:process.env?.S3_SKIP_POLICY==="true",SAVE_VIDEO:process.env?.S3_SAVE_VIDEO==="true"},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"},METRICS:{ENABLED:process.env?.PROMETHEUS_METRICS==="true",AUTH_REQUIRED:process.env?.METRICS_AUTH_REQUIRED==="true",USER:process.env?.METRICS_USER,PASSWORD:process.env?.METRICS_PASSWORD,ALLOWED_IPS:process.env?.METRICS_ALLOWED_IPS},TELEMETRY:{ENABLED:process.env?.TELEMETRY_ENABLED===void 0||process.env?.TELEMETRY_ENABLED==="true",URL:process.env?.TELEMETRY_URL},PROXY:{HOST:process.env?.PROXY_HOST,PORT:process.env?.PROXY_PORT,PROTOCOL:process.env?.PROXY_PROTOCOL,USERNAME:process.env?.PROXY_USERNAME,PASSWORD:process.env?.PROXY_PASSWORD},AUDIO_CONVERTER:{API_URL:process.env?.API_AUDIO_CONVERTER,API_KEY:process.env?.API_AUDIO_CONVERTER_KEY},FACEBOOK:{APP_ID:process.env?.FACEBOOK_APP_ID,CONFIG_ID:process.env?.FACEBOOK_CONFIG_ID,USER_TOKEN:process.env?.FACEBOOK_USER_TOKEN},SENTRY:{DSN:process.env?.SENTRY_DSN},EVENT_EMITTER:{MAX_LISTENERS:Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS)||50}}}};l(In,"ConfigService");var at=In,b=new at;var $h=JSON.parse(Jl.default.readFileSync("./package.json","utf8")),Fl=l(h=>(0,Wl.default)(h).toDate().toString().replace(/\sGMT.+/,""),"formatDateLog"),Qe=(function(h){return h.LOG="\x1B[32m",h.INFO="\x1B[34m",h.WARN="\x1B[33m",h.ERROR="\x1B[31m",h.DEBUG="\x1B[36m",h.VERBOSE="\x1B[37m",h.DARK="\x1B[30m",h})(Qe||{});var ql=(function(h){return h.LOG="\x1B[32m%s\x1B[0m",h.DARK="\x1B[30m%s\x1B[0m",h.INFO="\x1B[34m%s\x1B[0m",h.WARN="\x1B[33m%s\x1B[0m",h.ERROR="\x1B[31m%s\x1B[0m",h.DEBUG="\x1B[36m%s\x1B[0m",h.VERBOSE="\x1B[37m%s\x1B[0m",h})(ql||{}),Vl=(function(h){return h.LOG="LOG",h.WARN="WARN",h.INFO="INFO",h.DARK="DARK",h.ERROR="ERROR",h.DEBUG="DEBUG",h.VERBOSE="VERBOSE",h})(Vl||{}),Gl=(function(h){return h.LOG="\x1B[42m",h.INFO="\x1B[44m",h.WARN="\x1B[43m",h.DARK="\x1B[40m",h.ERROR="\x1B[41m",h.DEBUG="\x1B[46m",h.VERBOSE="\x1B[47m",h})(Gl||{}),Cn=class Cn{constructor(s="Logger"){a(this,"configService",b);a(this,"context");a(this,"instance",null);this.context=s}setContext(s){this.context=s}setInstance(s){this.instance=s}console(s,e){let t=[];this.configService.get("LOG").LEVEL.forEach(o=>t.push(Vl[o]));let i=typeof s;t.includes(e)&&(b.get("LOG").COLOR?(console.log("\x1B[1m"+ql[e],"[Evolution API]","\x1B[1m"+Qe[e],this.instance?`[${this.instance}]`:"","\x1B[1m"+Qe[e],`v${$h.version}`,"\x1B[1m"+Qe[e],process.pid.toString(),"\x1B[0m","\x1B[1m"+Qe[e],"-","\x1B[1m\x1B[37m",`${Fl(Date.now())}  `,"\x1B[0m",Qe[e]+Gl[e]+"\x1B[1m",`${e} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,Qe[e]+"\x1B[1m",`[${i}]\x1B[0m`,Qe[e],i!=="object"?s:"","\x1B[0m"),i==="object"&&console.log(s,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${Fl(Date.now())}  `,`${e} `,`[${this.context}]`,`[${i}]`,s))}log(s){this.console(s,"LOG")}info(s){this.console(s,"INFO")}warn(s){this.console(s,"WARN")}error(s){this.console(s,"ERROR")}verbose(s){this.console(s,"VERBOSE")}debug(s){this.console(s,"DEBUG")}dark(s){this.console(s,"DARK")}};l(Cn,"Logger");var O=Cn;var Mn=require("baileys"),Kl=x(require("node-cache"));var he=class he{constructor(s,e){a(this,"configService");a(this,"module");a(this,"logger",new O("LocalCache"));a(this,"conf");this.configService=s,this.module=e,this.conf=this.configService.get("CACHE")?.LOCAL}async get(s){return he.localCache.get(this.buildKey(s))}async set(s,e,t){return he.localCache.set(this.buildKey(s),e,t||this.conf.TTL)}async has(s){return he.localCache.has(this.buildKey(s))}async delete(s){return he.localCache.del(this.buildKey(s))}async deleteAll(s){let e=await this.keys(s);return e?.length?he.localCache.del(e):0}async keys(s){let e=`${this.buildKey("")}${s?`${s}:`:""}`;return he.localCache.keys().filter(t=>t.substring(0,e.length)===e)}buildKey(s){return`${this.module}:${s}`}async hGet(s,e){try{let t=he.localCache.get(this.buildKey(s));return t&&e in t?JSON.parse(t[e],Mn.BufferJSON.reviver):null}catch(t){this.logger.error(t)}}async hSet(s,e,t){try{let i=JSON.stringify(t,Mn.BufferJSON.replacer),o=he.localCache.get(this.buildKey(s));o||(o={}),o[e]=i,he.localCache.set(this.buildKey(s),o)}catch(i){this.logger.error(i)}}async hDelete(s,e){try{let t=he.localCache.get(this.buildKey(s));return t&&e in t?(delete t[e],he.localCache.set(this.buildKey(s),t),1):0}catch(t){this.logger.error(t)}}};l(he,"LocalCache"),a(he,"localCache",new Kl.default);var ys=he;var vn=require("baileys");var jl=require("redis");var yt,Fh=(yt=class{constructor(){a(this,"logger",new O("Redis"));a(this,"client",null);a(this,"conf");a(this,"connected",!1);this.conf=b.get("CACHE")?.REDIS}getConnection(){if(this.connected)return this.client;this.client=(0,jl.createClient)({url:this.conf.URI}),this.client.on("connect",()=>{this.logger.verbose("redis connecting")}),this.client.on("ready",()=>{this.logger.verbose("redis ready"),this.connected=!0}),this.client.on("error",()=>{this.logger.error("redis disconnected"),this.connected=!1}),this.client.on("end",()=>{this.logger.verbose("redis connection ended"),this.connected=!1});try{this.client.connect(),this.connected=!0}catch(s){return this.connected=!1,this.logger.error("redis connect exception caught: "+s),null}return this.client}},l(yt,"Redis"),yt),Hl=new Fh;var Nn=class Nn{constructor(s,e){a(this,"configService");a(this,"module");a(this,"logger",new O("RedisCache"));a(this,"client");a(this,"conf");this.configService=s,this.module=e,this.conf=this.configService.get("CACHE")?.REDIS,this.client=Hl.getConnection()}async get(s){try{return JSON.parse(await this.client.get(this.buildKey(s)))}catch(e){this.logger.error(e)}}async hGet(s,e){try{let t=await this.client.hGet(this.buildKey(s),e);return t?JSON.parse(t,vn.BufferJSON.reviver):null}catch(t){this.logger.error(t)}}async set(s,e,t){try{await this.client.setEx(this.buildKey(s),t||this.conf?.TTL,JSON.stringify(e))}catch(i){this.logger.error(i)}}async hSet(s,e,t){try{let i=JSON.stringify(t,vn.BufferJSON.replacer);await this.client.hSet(this.buildKey(s),e,i)}catch(i){this.logger.error(i)}}async has(s){try{return await this.client.exists(this.buildKey(s))>0}catch(e){this.logger.error(e)}}async delete(s){try{return await this.client.del(this.buildKey(s))}catch(e){this.logger.error(e)}}async hDelete(s,e){try{return await this.client.hDel(this.buildKey(s),e)}catch(t){this.logger.error(t)}}async deleteAll(s){try{let e=await this.keys(s);return e?.length?await this.client.del(e):0}catch(e){this.logger.error(e)}}async keys(s){try{let e=`${this.buildKey("")}${s?`${s}:`:""}*`,t=[];for await(let i of this.client.scanIterator({MATCH:e,COUNT:100}))t.push(i);return[...new Set(t)]}catch(e){this.logger.error(e)}}buildKey(s){return`${this.conf?.PREFIX_KEY}:${this.module}:${s}`}};l(Nn,"RedisCache");var ws=Nn;var Yl=new O("CacheEngine"),_n=class _n{constructor(s,e){a(this,"configService");a(this,"engine");this.configService=s;let t=s.get("CACHE");t?.REDIS?.ENABLED&&t?.REDIS?.URI!==""?(Yl.verbose(`RedisCache initialized for ${e}`),this.engine=new ws(s,e)):t?.LOCAL?.ENABLED&&(Yl.verbose(`LocalCache initialized for ${e}`),this.engine=new ys(s,e))}getEngine(){return this.engine}};l(_n,"CacheEngine");var ze=_n;var Ql=x(require("eventemitter2")),Wh=b.get("EVENT_EMITTER"),Rn=new Ql.default({delimiter:".",newListener:!1,ignoreErrors:!1,maxListeners:Wh.MAX_LISTENERS});var On=class On{constructor(s){a(this,"waMonitor");this.waMonitor=s}async fetchCatalog({instanceName:s},e){return await this.waMonitor.waInstances[s].fetchCatalog(s,e)}async fetchCollections({instanceName:s},e){return await this.waMonitor.waInstances[s].fetchCollections(s,e)}};l(On,"BusinessController");var Es=On;var Pn=class Pn{constructor(s){a(this,"waMonitor");this.waMonitor=s}async offerCall({instanceName:s},e){return await this.waMonitor.waInstances[s].offerCall(e)}};l(Pn,"CallController");var Ss=Pn;var xn=class xn{constructor(s){a(this,"waMonitor");this.waMonitor=s}async whatsappNumber({instanceName:s},e){return await this.waMonitor.waInstances[s].whatsappNumber(e)}async readMessage({instanceName:s},e){return await this.waMonitor.waInstances[s].markMessageAsRead(e)}async archiveChat({instanceName:s},e){return await this.waMonitor.waInstances[s].archiveChat(e)}async markChatUnread({instanceName:s},e){return await this.waMonitor.waInstances[s].markChatUnread(e)}async deleteMessage({instanceName:s},e){return await this.waMonitor.waInstances[s].deleteMessage(e)}async fetchProfilePicture({instanceName:s},e){return await this.waMonitor.waInstances[s].profilePicture(e.number)}async fetchProfile({instanceName:s},e){return await this.waMonitor.waInstances[s].fetchProfile(s,e.number)}async fetchContacts({instanceName:s},e){return await this.waMonitor.waInstances[s].fetchContacts(e)}async getBase64FromMediaMessage({instanceName:s},e){return await this.waMonitor.waInstances[s].getBase64FromMediaMessage(e)}async fetchMessages({instanceName:s},e){return await this.waMonitor.waInstances[s].fetchMessages(e)}async fetchStatusMessage({instanceName:s},e){return await this.waMonitor.waInstances[s].fetchStatusMessage(e)}async fetchChats({instanceName:s},e){return await this.waMonitor.waInstances[s].fetchChats(e)}async findChatByRemoteJid({instanceName:s},e){return await this.waMonitor.waInstances[s].findChatByRemoteJid(e)}async sendPresence({instanceName:s},e){return await this.waMonitor.waInstances[s].sendPresence(e)}async fetchPrivacySettings({instanceName:s}){return await this.waMonitor.waInstances[s].fetchPrivacySettings()}async updatePrivacySettings({instanceName:s},e){return await this.waMonitor.waInstances[s].updatePrivacySettings(e)}async fetchBusinessProfile({instanceName:s},e){return await this.waMonitor.waInstances[s].fetchBusinessProfile(e.number)}async updateProfileName({instanceName:s},e){return await this.waMonitor.waInstances[s].updateProfileName(e.name)}async updateProfileStatus({instanceName:s},e){return await this.waMonitor.waInstances[s].updateProfileStatus(e.status)}async updateProfilePicture({instanceName:s},e){return await this.waMonitor.waInstances[s].updateProfilePicture(e.picture)}async removeProfilePicture({instanceName:s}){return await this.waMonitor.waInstances[s].removeProfilePicture()}async updateMessage({instanceName:s},e){return await this.waMonitor.waInstances[s].updateMessage(e)}async blockUser({instanceName:s},e){return await this.waMonitor.waInstances[s].blockUser(e)}};l(xn,"ChatController");var Ts=xn;var kn=class kn{constructor(s){a(this,"waMonitor");this.waMonitor=s}async createGroup(s,e){return await this.waMonitor.waInstances[s.instanceName].createGroup(e)}async updateGroupPicture(s,e){return await this.waMonitor.waInstances[s.instanceName].updateGroupPicture(e)}async updateGroupSubject(s,e){return await this.waMonitor.waInstances[s.instanceName].updateGroupSubject(e)}async updateGroupDescription(s,e){return await this.waMonitor.waInstances[s.instanceName].updateGroupDescription(e)}async findGroupInfo(s,e){return await this.waMonitor.waInstances[s.instanceName].findGroup(e)}async fetchAllGroups(s,e){return await this.waMonitor.waInstances[s.instanceName].fetchAllGroups(e)}async inviteCode(s,e){return await this.waMonitor.waInstances[s.instanceName].inviteCode(e)}async inviteInfo(s,e){return await this.waMonitor.waInstances[s.instanceName].inviteInfo(e)}async sendInvite(s,e){return await this.waMonitor.waInstances[s.instanceName].sendInvite(e)}async acceptInviteCode(s,e){return await this.waMonitor.waInstances[s.instanceName].acceptInviteCode(e)}async revokeInviteCode(s,e){return await this.waMonitor.waInstances[s.instanceName].revokeInviteCode(e)}async findParticipants(s,e){return await this.waMonitor.waInstances[s.instanceName].findParticipants(e)}async updateGParticipate(s,e){return await this.waMonitor.waInstances[s.instanceName].updateGParticipant(e)}async updateGSetting(s,e){return await this.waMonitor.waInstances[s.instanceName].updateGSetting(e)}async toggleEphemeral(s,e){return await this.waMonitor.waInstances[s.instanceName].toggleEphemeral(e)}async leaveGroup(s,e){return await this.waMonitor.waInstances[s.instanceName].leaveGroup(e)}};l(kn,"GroupController");var As=kn;var R=(function(h){return h.APPLICATION_STARTUP="application.startup",h.INSTANCE_CREATE="instance.create",h.INSTANCE_DELETE="instance.delete",h.QRCODE_UPDATED="qrcode.updated",h.CONNECTION_UPDATE="connection.update",h.STATUS_INSTANCE="status.instance",h.MESSAGES_SET="messages.set",h.MESSAGES_UPSERT="messages.upsert",h.MESSAGES_EDITED="messages.edited",h.MESSAGES_UPDATE="messages.update",h.MESSAGES_DELETE="messages.delete",h.SEND_MESSAGE="send.message",h.SEND_MESSAGE_UPDATE="send.message.update",h.CONTACTS_SET="contacts.set",h.CONTACTS_UPSERT="contacts.upsert",h.CONTACTS_UPDATE="contacts.update",h.PRESENCE_UPDATE="presence.update",h.CHATS_SET="chats.set",h.CHATS_UPDATE="chats.update",h.CHATS_UPSERT="chats.upsert",h.CHATS_DELETE="chats.delete",h.GROUPS_UPSERT="groups.upsert",h.GROUPS_UPDATE="groups.update",h.GROUP_PARTICIPANTS_UPDATE="group-participants.update",h.CALL="call",h.TYPEBOT_START="typebot.start",h.TYPEBOT_CHANGE_STATUS="typebot.change-status",h.LABELS_EDIT="labels.edit",h.LABELS_ASSOCIATION="labels.association",h.CREDS_UPDATE="creds.update",h.MESSAGING_HISTORY_SET="messaging-history.set",h.REMOVE_INSTANCE="remove.instance",h.LOGOUT_INSTANCE="logout.instance",h})({}),Dn=["imageMessage","documentMessage","audioMessage","videoMessage","stickerMessage","ptvMessage"],zl=["ephemeralMessage","documentWithCaptionMessage","viewOnceMessage","viewOnceMessageV2"],J={WHATSAPP_BUSINESS:"WHATSAPP-BUSINESS",WHATSAPP_BAILEYS:"WHATSAPP-BAILEYS",EVOLUTION:"EVOLUTION"};var Ln=class Ln{constructor(...s){throw{status:E.BAD_REQUEST,error:"Bad Request",message:s.length>0?s:void 0}}};l(Ln,"BadRequestException");var w=Ln;var Bn=class Bn{constructor(...s){throw{status:E.UNAUTHORIZED,error:"Unauthorized",message:s.length>0?s:"Unauthorized"}}};l(Bn,"UnauthorizedException");var ct=Bn;var Un=class Un{constructor(...s){throw{status:E.FORBIDDEN,error:"Forbidden",message:s.length>0?s:void 0}}};l(Un,"ForbiddenException");var wt=Un;var $n=class $n{constructor(...s){throw{status:E.NOT_FOUND,error:"Not Found",message:s.length>0?s:void 0}}};l($n,"NotFoundException");var G=$n;var Fn=class Fn{constructor(...s){throw{status:E.INTERNAL_SERVER_ERROR,error:"Internal Server Error",message:s.length>0?s:void 0}}};l(Fn,"InternalServerErrorException");var $=Fn;var Wn=require("baileys"),Ut=require("class-validator"),Jn=require("uuid");var qn=class qn{constructor(s,e,t,i,o,n,r,c,p,u,d){a(this,"waMonitor");a(this,"configService");a(this,"prismaRepository");a(this,"eventEmitter");a(this,"chatwootService");a(this,"settingsService");a(this,"proxyService");a(this,"cache");a(this,"chatwootCache");a(this,"baileysCache");a(this,"providerFiles");a(this,"logger",new O("InstanceController"));this.waMonitor=s,this.configService=e,this.prismaRepository=t,this.eventEmitter=i,this.chatwootService=o,this.settingsService=n,this.proxyService=r,this.cache=c,this.chatwootCache=p,this.baileysCache=u,this.providerFiles=d}async createInstance(s){try{let e=Is.init(s,{configService:this.configService,eventEmitter:this.eventEmitter,prismaRepository:this.prismaRepository,cache:this.cache,chatwootCache:this.chatwootCache,baileysCache:this.baileysCache,providerFiles:this.providerFiles});if(!e)throw new w("Invalid integration");let t=(0,Jn.v4)();s.instanceId=t;let i;s.token?i=s.token:i=(0,Jn.v4)().toUpperCase(),await this.waMonitor.saveInstance({instanceId:t,integration:s.integration,instanceName:s.instanceName,ownerJid:s.ownerJid,profileName:s.profileName,profilePicUrl:s.profilePicUrl,hash:i,number:s.number,businessId:s.businessId,status:s.status}),e.setInstance({instanceName:s.instanceName,instanceId:t,integration:s.integration,token:i,number:s.number,businessId:s.businessId}),this.waMonitor.waInstances[e.instanceName]=e,this.waMonitor.delInstanceTime(e.instanceName),await H.setInstance(e.instanceName,s),e.sendDataWebhook(R.INSTANCE_CREATE,{instanceName:s.instanceName,instanceId:t});let o={instanceName:e.instanceName,instanceId:e.instanceId,connectionStatus:typeof e.connectionStatus=="string"?e.connectionStatus:e.connectionStatus?.state||"unknown"};if(s.proxyHost&&s.proxyPort&&s.proxyProtocol){if(!await this.proxyService.testProxy({host:s.proxyHost,port:s.proxyPort,protocol:s.proxyProtocol,username:s.proxyUsername,password:s.proxyPassword}))throw new w("Invalid proxy");await this.proxyService.createProxy(o,{enabled:!0,host:s.proxyHost,port:s.proxyPort,protocol:s.proxyProtocol,username:s.proxyUsername,password:s.proxyPassword})}let n={rejectCall:s.rejectCall===!0,msgCall:s.msgCall||"",groupsIgnore:s.groupsIgnore===!0,alwaysOnline:s.alwaysOnline===!0,readMessages:s.readMessages===!0,readStatus:s.readStatus===!0,syncFullHistory:s.syncFullHistory===!0,wavoipToken:s.wavoipToken||""};await this.settingsService.create(o,n);let r=null,c="";if(s.integration===J.WHATSAPP_BUSINESS){if(!s.number)throw new w("number is required");r=`${this.configService.get("SERVER").URL}/webhook/meta`,c=this.configService.get("WA_BUSINESS").TOKEN_WEBHOOK}if(!s.chatwootAccountId||!s.chatwootToken||!s.chatwootUrl){let u;return s.qrcode&&s.integration===J.WHATSAPP_BAILEYS&&(await e.connectToWhatsapp(s.number),await(0,Wn.delay)(5e3),u=e.qrCode),{instance:{instanceName:e.instanceName,instanceId:t,integration:s.integration,webhookWaBusiness:r,accessTokenWaBusiness:c,status:typeof e.connectionStatus=="string"?e.connectionStatus:e.connectionStatus?.state||"unknown"},hash:i,webhook:{webhookUrl:s?.webhook?.url,webhookHeaders:s?.webhook?.headers,webhookByEvents:s?.webhook?.byEvents,webhookBase64:s?.webhook?.base64},websocket:{enabled:s?.websocket?.enabled},rabbitmq:{enabled:s?.rabbitmq?.enabled},nats:{enabled:s?.nats?.enabled},sqs:{enabled:s?.sqs?.enabled},settings:n,qrcode:u}}if(!this.configService.get("CHATWOOT").ENABLED)throw new w("Chatwoot is not enabled");if(!s.chatwootAccountId)throw new w("accountId is required");if(!s.chatwootToken)throw new w("token is required");if(!s.chatwootUrl)throw new w("url is required");if(!(0,Ut.isURL)(s.chatwootUrl,{require_tld:!1}))throw new w('Invalid "url" property in chatwoot');if(s.chatwootSignMsg!==!0&&s.chatwootSignMsg!==!1)throw new w("signMsg is required");if(s.chatwootReopenConversation!==!0&&s.chatwootReopenConversation!==!1)throw new w("reopenConversation is required");if(s.chatwootConversationPending!==!0&&s.chatwootConversationPending!==!1)throw new w("conversationPending is required");let p=this.configService.get("SERVER").URL;try{this.chatwootService.create(o,{enabled:!0,accountId:s.chatwootAccountId,token:s.chatwootToken,url:s.chatwootUrl,signMsg:s.chatwootSignMsg||!1,nameInbox:s.chatwootNameInbox??e.instanceName.split("-cwId-")[0],number:s.number,reopenConversation:s.chatwootReopenConversation||!1,conversationPending:s.chatwootConversationPending||!1,importContacts:s.chatwootImportContacts??!0,mergeBrazilContacts:s.chatwootMergeBrazilContacts??!1,importMessages:s.chatwootImportMessages??!0,daysLimitImportMessages:s.chatwootDaysLimitImportMessages??60,organization:s.chatwootOrganization,logo:s.chatwootLogo,autoCreate:s.chatwootAutoCreate!==!1})}catch(u){this.logger.log(u)}return{instance:{instanceName:e.instanceName,instanceId:t,integration:s.integration,webhookWaBusiness:r,accessTokenWaBusiness:c,status:typeof e.connectionStatus=="string"?e.connectionStatus:e.connectionStatus?.state||"unknown"},hash:i,webhook:{webhookUrl:s?.webhook?.url,webhookHeaders:s?.webhook?.headers,webhookByEvents:s?.webhook?.byEvents,webhookBase64:s?.webhook?.base64},websocket:{enabled:s?.websocket?.enabled},rabbitmq:{enabled:s?.rabbitmq?.enabled},nats:{enabled:s?.nats?.enabled},sqs:{enabled:s?.sqs?.enabled},settings:n,chatwoot:{enabled:!0,accountId:s.chatwootAccountId,token:s.chatwootToken,url:s.chatwootUrl,signMsg:s.chatwootSignMsg||!1,reopenConversation:s.chatwootReopenConversation||!1,conversationPending:s.chatwootConversationPending||!1,mergeBrazilContacts:s.chatwootMergeBrazilContacts??!1,importContacts:s.chatwootImportContacts??!0,importMessages:s.chatwootImportMessages??!0,daysLimitImportMessages:s.chatwootDaysLimitImportMessages||60,number:s.number,nameInbox:s.chatwootNameInbox??e.instanceName,webhookUrl:`${p}/chatwoot/webhook/${encodeURIComponent(e.instanceName)}`}}}catch(e){throw this.waMonitor.deleteInstance(s.instanceName),this.logger.error((0,Ut.isArray)(e.message)?e.message[0]:e.message),new w((0,Ut.isArray)(e.message)?e.message[0]:e.message)}}async connectToWhatsapp({instanceName:s,number:e=null}){try{let t=this.waMonitor.waInstances[s],i=t?.connectionStatus?.state;if(!i)throw new w('The "'+s+'" instance does not exist');return i=="open"?await this.connectionState({instanceName:s}):i=="connecting"?t.qrCode:i=="close"?(await t.connectToWhatsapp(e),await(0,Wn.delay)(2e3),t.qrCode):{instance:{instanceName:s,status:i},qrcode:t?.qrCode}}catch(t){return this.logger.error(t),{error:!0,message:t.toString()}}}async restartInstance({instanceName:s}){try{let e=this.waMonitor.waInstances[s],t=e?.connectionStatus?.state;if(!t)throw new w('The "'+s+'" instance does not exist');if(t==="close")throw new w('The "'+s+'" instance is not connected');return this.logger.info(`Restarting instance: ${s}`),typeof e.restart=="function"?(await e.restart(),await new Promise(i=>setTimeout(i,2e3)),{instance:{instanceName:s,status:e.connectionStatus?.state||"connecting"}}):t==="open"||t==="connecting"?(this.configService.get("CHATWOOT").ENABLED&&e.clearCacheChatwoot(),e.client?.ws?.close(),e.client?.end(new Error("restart")),await this.connectToWhatsapp({instanceName:s})):{instance:{instanceName:s,status:t}}}catch(e){return this.logger.error(e),{error:!0,message:e.toString()}}}async connectionState({instanceName:s}){return{instance:{instanceName:s,state:this.waMonitor.waInstances[s]?.connectionStatus?.state}}}async fetchInstances({instanceName:s,instanceId:e,number:t},i){if(this.configService.get("AUTHENTICATION").API_KEY.KEY!==i){let r=await this.prismaRepository.instance.findMany({where:{token:i,name:s||void 0,id:e||void 0}});if(r.length>0){let c=r.map(p=>p.name);return this.waMonitor.instanceInfo(c)}else throw new ct}if(e||t)return this.waMonitor.instanceInfoById(e,t);let n=s?[s]:null;return this.waMonitor.instanceInfo(n)}async setPresence({instanceName:s},e){return await this.waMonitor.waInstances[s].setPresence(e)}async logout({instanceName:s}){let{instance:e}=await this.connectionState({instanceName:s});if(e.state==="close")throw new w('The "'+s+'" instance is not connected');try{return await this.waMonitor.waInstances[s]?.logoutInstance(),{status:"SUCCESS",error:!1,response:{message:"Instance logged out"}}}catch(t){throw new $(t.toString())}}async deleteInstance({instanceName:s}){let{instance:e}=await this.connectionState({instanceName:s});try{let t=this.waMonitor.waInstances[s];this.configService.get("CHATWOOT").ENABLED&&t?.clearCacheChatwoot(),(e.state==="connecting"||e.state==="open")&&await this.logout({instanceName:s});try{t?.sendDataWebhook(R.INSTANCE_DELETE,{instanceName:s,instanceId:t.instanceId})}catch(i){this.logger.error(i)}return this.eventEmitter.emit("remove.instance",s,"inner"),{status:"SUCCESS",error:!1,response:{message:"Instance deleted"}}}catch(t){throw new w(t.toString())}}};l(qn,"InstanceController");var bs=qn;var Vn=class Vn{constructor(s){a(this,"waMonitor");this.waMonitor=s}async fetchLabels({instanceName:s}){return await this.waMonitor.waInstances[s].fetchLabels()}async handleLabel({instanceName:s},e){return await this.waMonitor.waInstances[s].handleLabel(e)}};l(Vn,"LabelController");var Cs=Vn;var Zl=require("fetch-socks"),ep=require("https-proxy-agent"),tp=require("socks-proxy-agent"),sp=require("undici");function Xl(h){let s=new URL(h),e="http:",t="socks:",i="socks5:";switch(s.protocol){case e:return new ep.HttpsProxyAgent(s);case t:case i:{let o="";return s.username&&s.password?o=`socks://${s.username}:${s.password}@${s.hostname}:${s.port}`:o=`socks://${s.hostname}:${s.port}`,new tp.SocksProxyAgent(o)}default:throw new Error(`Unsupported proxy protocol: ${s.protocol}`)}}l(Xl,"selectProxyAgent");function ke(h){if(typeof h=="string")return Xl(h);let{host:s,password:e,port:t,protocol:i,username:o}=h,n=`${i}://${s}:${t}`;return o&&e&&(n=`${i}://${o}:${e}@${s}:${t}`),Xl(n)}l(ke,"makeProxyAgent");function Gn(h){let s,e;if(typeof h=="string")e=new URL(h).protocol.replace(":",""),s=h;else{let{host:r,password:c,port:p,protocol:u,username:d}=h;e=(u||"http").replace(":",""),e==="socks"&&(e="socks5");let f=d&&c?`${d}:${c}@`:"";s=`${e}://${f}${r}:${p}`}e=e.toLowerCase();let t="http",i="https",o="socks4",n="socks5";switch(e){case t:case i:return new sp.ProxyAgent(s);case o:case n:{let r=5;o===e&&(r=4);let c=new URL(s);return(0,Zl.socksDispatcher)({type:r,host:c.hostname,port:Number(c.port),userId:c.username||void 0,password:c.password||void 0})}default:throw new Error(`Unsupported proxy protocol: ${e}`)}}l(Gn,"makeProxyAgentUndici");var vs=x(require("axios"));var Ms=new O("ProxyController"),Kn=class Kn{constructor(s,e){a(this,"proxyService");a(this,"waMonitor");this.proxyService=s,this.waMonitor=e}async createProxy(s,e){if(!this.waMonitor.waInstances[s.instanceName])throw new G(`The "${s.instanceName}" instance does not exist`);if(e?.enabled||(e.host="",e.port="",e.protocol="",e.username="",e.password=""),e.host&&!await this.testProxy(e))throw new w("Invalid proxy");return this.proxyService.create(s,e)}async findProxy(s){if(!this.waMonitor.waInstances[s.instanceName])throw new G(`The "${s.instanceName}" instance does not exist`);return this.proxyService.find(s)}async testProxy(s){try{let e=await vs.default.get("https://icanhazip.com/"),i=(await vs.default.get("https://icanhazip.com/",{httpsAgent:ke(s)}))?.data!==e?.data;return i?Ms.info("testProxy: proxy connection successful"):Ms.warn("testProxy: proxy connection doesn't change the origin IP"),i}catch(e){return vs.default.isAxiosError(e)?Ms.error("testProxy error: axios error: "+e.message):Ms.error("testProxy error: unexpected error: "+e),!1}}};l(Kn,"ProxyController");var Ns=Kn;var Re=require("class-validator"),ip=x(require("emoji-regex"));var Jh=(0,ip.default)();function qh(h){if(h==="")return!0;let s=h.match(Jh);return s?.length===1&&s[0]===h}l(qh,"isEmoji");var jn=class jn{constructor(s){a(this,"waMonitor");this.waMonitor=s}async sendTemplate({instanceName:s},e){return await this.waMonitor.waInstances[s].templateMessage(e)}async sendText({instanceName:s},e){return await this.waMonitor.waInstances[s].textMessage(e)}async sendMedia({instanceName:s},e,t){if((0,Re.isBase64)(e?.media)&&!e?.fileName&&e?.mediatype==="document")throw new w("For base64 the file name must be informed.");if(t||(0,Re.isURL)(e?.media)||(0,Re.isBase64)(e?.media))return await this.waMonitor.waInstances[s].mediaMessage(e,t);throw new w("Owned media must be a url or base64")}async sendPtv({instanceName:s},e,t){if(t||(0,Re.isURL)(e?.video)||(0,Re.isBase64)(e?.video))return await this.waMonitor.waInstances[s].ptvMessage(e,t);throw new w("Owned media must be a url or base64")}async sendSticker({instanceName:s},e,t){if(t||(0,Re.isURL)(e.sticker)||(0,Re.isBase64)(e.sticker))return await this.waMonitor.waInstances[s].mediaSticker(e,t);throw new w("Owned media must be a url or base64")}async sendWhatsAppAudio({instanceName:s},e,t){if(t?.buffer||(0,Re.isURL)(e.audio)||(0,Re.isBase64)(e.audio))return await this.waMonitor.waInstances[s].audioWhatsapp(e,t);throw console.error("El archivo no tiene buffer o el audio no es una URL o Base64 v\xE1lida"),new w("Owned media must be a url, base64, or valid file with buffer")}async sendButtons({instanceName:s},e){return await this.waMonitor.waInstances[s].buttonMessage(e)}async sendLocation({instanceName:s},e){return await this.waMonitor.waInstances[s].locationMessage(e)}async sendList({instanceName:s},e){return await this.waMonitor.waInstances[s].listMessage(e)}async sendContact({instanceName:s},e){return await this.waMonitor.waInstances[s].contactMessage(e)}async sendReaction({instanceName:s},e){if(!qh(e.reaction))throw new w("Reaction must be a single emoji or empty string");return await this.waMonitor.waInstances[s].reactionMessage(e)}async sendPoll({instanceName:s},e){return await this.waMonitor.waInstances[s].pollMessage(e)}async sendStatus({instanceName:s},e,t){return await this.waMonitor.waInstances[s].statusMessage(e,t)}};l(jn,"SendMessageController");var _s=jn;var Hn=class Hn{constructor(s){a(this,"settingsService");this.settingsService=s}async createSettings(s,e){return this.settingsService.create(s,e)}async findSettings(s){return this.settingsService.find(s)}};l(Hn,"SettingsController");var Rs=Hn;var Yn=class Yn{constructor(s){a(this,"templateService");this.templateService=s}async createTemplate(s,e){return this.templateService.create(s,e)}async findTemplate(s){return this.templateService.find(s)}async editTemplate(s,e){return this.templateService.edit(s,e)}async deleteTemplate(s,e){return this.templateService.delete(s,e)}};l(Yn,"TemplateController");var Os=Yn;var op=x(require("minio")),Qn=require("path");var Ps=new O("S3 Service"),Fe=new at().get("S3"),Oe=(()=>{if(Fe?.ENABLE)return new op.Client({endPoint:Fe.ENDPOINT,port:Fe.PORT,useSSL:Fe.USE_SSL,accessKey:Fe.ACCESS_KEY,secretKey:Fe.SECRET_KEY,region:Fe.REGION})})(),Xe=Fe.BUCKET_NAME,Vh=l(async()=>{if(Oe)try{return(await Oe.listBuckets()).find(s=>s.name===Xe)}catch{return!1}},"bucketExists"),Gh=l(async()=>{if(Oe){let h={Version:"2012-10-17",Statement:[{Effect:"Allow",Principal:"*",Action:["s3:GetObject"],Resource:[`arn:aws:s3:::${Xe}/*`]}]};await Oe.setBucketPolicy(Xe,JSON.stringify(h))}},"setBucketPolicy"),Kh=l(async()=>{if(Oe)try{return await Vh()||await Oe.makeBucket(Xe),Fe.SKIP_POLICY||await Gh(),Ps.info(`S3 Bucket ${Xe} - ON`),!0}catch(h){return Ps.error("S3 ERROR:"),Ps.error(h),!1}},"createBucket");Kh();var We=l(async(h,s,e,t)=>{if(Oe){let i=(0,Qn.join)("evolution-api",h);try{return t["custom-header-application"]="evolution-api",await Oe.putObject(Xe,i,s,e,t)}catch(o){return Ps.error(o),o}}},"uploadFile"),Pe=l(async(h,s)=>{if(Oe)try{let e=(0,Qn.join)("evolution-api",h);return s?await Oe.presignedGetObject(Xe,e,s):await Oe.presignedGetObject(Xe,e)}catch(e){throw new w(e?.message)}},"getObjectUrl");var np=x(require("pg"));var{Pool:jh}=np.default,Et,Hh=(Et=class{constructor(){a(this,"logger",new O("Postgres"));a(this,"pool");a(this,"connected",!1)}getConnection(s){if(this.connected)return this.pool;this.pool=new jh({connectionString:s,ssl:{rejectUnauthorized:!1}}),this.pool.on("error",()=>{this.logger.error("postgres disconnected"),this.connected=!1});try{this.connected=!0}catch(e){return this.connected=!1,this.logger.error("postgres connect exception caught: "+e),null}return this.pool}getChatwootConnection(){let s=b.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI;return this.getConnection(s)}},l(Et,"Postgres"),Et),De=new Hh;var St,Yh=(St=class{constructor(){a(this,"logger",new O("ChatwootImport"));a(this,"repositoryMessagesCache",new Map);a(this,"historyMessages",new Map);a(this,"historyContacts",new Map)}getRepositoryMessagesCache(s){return this.repositoryMessagesCache.has(s.instanceName)?this.repositoryMessagesCache.get(s.instanceName):null}setRepositoryMessagesCache(s,e){this.repositoryMessagesCache.set(s.instanceName,e)}deleteRepositoryMessagesCache(s){this.repositoryMessagesCache.delete(s.instanceName)}addHistoryMessages(s,e){let t=this.historyMessages.has(s.instanceName)?this.historyMessages.get(s.instanceName):[];this.historyMessages.set(s.instanceName,[...t,...e])}addHistoryContacts(s,e){let t=this.historyContacts.has(s.instanceName)?this.historyContacts.get(s.instanceName):[];this.historyContacts.set(s.instanceName,t.concat(e))}deleteHistoryMessages(s){this.historyMessages.delete(s.instanceName)}deleteHistoryContacts(s){this.historyContacts.delete(s.instanceName)}clearAll(s){this.deleteRepositoryMessagesCache(s),this.deleteHistoryMessages(s),this.deleteHistoryContacts(s)}getHistoryMessagesLenght(s){return this.historyMessages.get(s.instanceName)?.length??0}async importHistoryContacts(s,e){try{if(this.getHistoryMessagesLenght(s)>0)return;let t=De.getChatwootConnection(),i=0,o=this.historyContacts.get(s.instanceName)||[];if(o.length===0)return 0;let n=this.sliceIntoChunks(o,3e3);for(;n.length>0;){let r=`SELECT id FROM labels WHERE title = '${e.nameInbox}' AND account_id = ${e.accountId} LIMIT 1`,c=(await t.query(r))?.rows[0]?.id;if(!c){let S=`INSERT INTO labels (title, color, show_on_sidebar, account_id, created_at, updated_at) VALUES ('${e.nameInbox}', '#34039B', true, ${e.accountId}, NOW(), NOW()) RETURNING id`;c=(await t.query(S))?.rows[0]?.id}let p=`INSERT INTO contacts
          (name, phone_number, account_id, identifier, created_at, updated_at) VALUES `,u=[e.accountId];for(let S of n){let T=this.isIgnorePhoneNumber(S.remoteJid),A=T?`${S.pushName} (GROUP)`:S.pushName;u.push(A);let N=`$${u.length}`,I;T?I="NULL":(u.push(`+${S.remoteJid.split("@")[0]}`),I=`$${u.length}`),u.push(S.remoteJid);let C=`$${u.length}`;p+=`(${N}, ${I}, $1, ${C}, NOW(), NOW()),`}p.slice(-1)===","&&(p=p.slice(0,-1)),p+=` ON CONFLICT (identifier, account_id)
                       DO UPDATE SET
                        name = EXCLUDED.name,
                        phone_number = EXCLUDED.phone_number,
                        updated_at = NOW()`,i+=(await t.query(p,u))?.rowCount??0;let d=`SELECT id FROM tags WHERE name = '${e.nameInbox}' LIMIT 1`,g=(await t.query(d))?.rows[0]?.id,y=`INSERT INTO tags (name, taggings_count) VALUES ('${e.nameInbox}', ${i}) ON CONFLICT (name) DO UPDATE SET taggings_count = tags.taggings_count + ${i} RETURNING id`;g=(await t.query(y))?.rows[0]?.id,await t.query(y);let m="INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) VALUES ";n.forEach(S=>{let T=`(SELECT id FROM contacts WHERE identifier = '${S.remoteJid}' AND account_id = ${e.accountId})`;m+=`($1, $2, ${T}, $3, NOW()),`}),m.slice(-1)===","&&(m=m.slice(0,-1)),await t.query(m,[g,"Contact","labels"]),n=this.sliceIntoChunks(o,3e3)}return this.deleteHistoryContacts(s),i}catch(t){this.logger.error(`Error on import history contacts: ${t.toString()}`)}}async getExistingSourceIds(s,e){try{let t=new Set;if(s.length===0)return t;let i=s.map(p=>`WAID:${p.replace("WAID:","")}`),o=De.getChatwootConnection(),n=e?[i,e]:[i],r=e?"SELECT source_id FROM messages WHERE source_id = ANY($1) AND conversation_id = $2":"SELECT source_id FROM messages WHERE source_id = ANY($1)",c=await o.query(r,n);for(let p of c.rows)t.add(p.source_id);return t}catch(t){return this.logger.error(`Error on getExistingSourceIds: ${t.toString()}`),new Set}}async importHistoryMessages(s,e,t,i){try{let o=De.getChatwootConnection(),n=await this.getChatwootUser(i);if(!n)throw new Error("User not found to import messages.");let r=0,c=this.historyMessages.get(s.instanceName)||[];if(c.length===0)return 0;c.sort((m,S)=>{let T=m.key,A=S.key,N=m.messageTimestamp,I=S.messageTimestamp;return parseInt(T.remoteJid)-parseInt(A.remoteJid)||N-I});let p=this.createMessagesMapByPhoneNumber(c),u=new Map;p.forEach((m,S)=>{u.set(S,{first:m[0]?.messageTimestamp,last:m[m.length-1]?.messageTimestamp})});let d=await this.getExistingSourceIds(c.map(m=>m.key.id));c=c.filter(m=>!d.has(m.key.id));let f=4e3,g=this.sliceIntoChunks(c,f);for(;g.length>0;){let m=this.createMessagesMapByPhoneNumber(g);if(m.size>0){let S=await this.selectOrCreateFksFromChatwoot(i,t,u,m),T=`INSERT INTO messages
            (content, processed_message_content, account_id, inbox_id, conversation_id, message_type, private, content_type,
            sender_type, sender_id, source_id, created_at, updated_at) VALUES `,A=[i.accountId,t.id];m.forEach((N,I)=>{let C=S.get(I);N.forEach(M=>{if(!M.message||!C?.conversation_id||!C?.contact_id)return;let v=this.getContentMessage(e,M);if(!v)return;A.push(v);let L=`$${A.length}`;A.push(C.conversation_id);let B=`$${A.length}`;A.push(M.key.fromMe?"1":"0");let W=`$${A.length}`;A.push(M.key.fromMe?n.user_type:"Contact");let q=`$${A.length}`;A.push(M.key.fromMe?n.user_id:C.contact_id);let X=`$${A.length}`;A.push("WAID:"+M.key.id);let te=`$${A.length}`;A.push(M.messageTimestamp);let z=`$${A.length}`;T+=`(${L}, ${L}, $1, $2, ${B}, ${W}, FALSE, 0,
                  ${q},${X},${te}, to_timestamp(${z}), to_timestamp(${z})),`})}),A.length>2&&(T.slice(-1)===","&&(T=T.slice(0,-1)),r+=(await o.query(T,A))?.rowCount??0)}g=this.sliceIntoChunks(c,f)}this.deleteHistoryMessages(s),this.deleteRepositoryMessagesCache(s);let y={...i,ignoreJids:Array.isArray(i.ignoreJids)?i.ignoreJids.map(m=>String(m)):[]};return this.importHistoryContacts(s,y),r}catch(o){this.logger.error(`Error on import history messages: ${o.toString()}`),this.deleteHistoryMessages(s),this.deleteRepositoryMessagesCache(s)}}async selectOrCreateFksFromChatwoot(s,e,t,i){let o=De.getChatwootConnection(),n=[s.accountId,e.id],c=`WITH
              phone_number AS (
                SELECT phone_number, created_at::INTEGER, last_activity_at::INTEGER FROM (
                  VALUES 
                   ${Array.from(i.keys()).map(u=>{let d=t.get(u);if(d){n.push(u);let f=`($${n.length},`;return n.push(d.first),f+=`$${n.length},`,n.push(d.last),`${f}$${n.length})`}}).join(",")}
                 ) as t (phone_number, created_at, last_activity_at)
              ),

              only_new_phone_number AS (
                SELECT * FROM phone_number
                WHERE phone_number NOT IN (
                  SELECT phone_number
                  FROM contacts
                    JOIN contact_inboxes ci ON ci.contact_id = contacts.id AND ci.inbox_id = $2
                    JOIN conversations con ON con.contact_inbox_id = ci.id 
                      AND con.account_id = $1
                      AND con.inbox_id = $2
                      AND con.contact_id = contacts.id
                  WHERE contacts.account_id = $1
                )
              ),

              new_contact AS (
                INSERT INTO contacts (name, phone_number, account_id, identifier, created_at, updated_at)
                SELECT REPLACE(p.phone_number, '+', ''), p.phone_number, $1, CONCAT(REPLACE(p.phone_number, '+', ''),
                  '@s.whatsapp.net'), to_timestamp(p.created_at), to_timestamp(p.last_activity_at)
                FROM only_new_phone_number AS p
                ON CONFLICT(identifier, account_id) DO UPDATE SET updated_at = EXCLUDED.updated_at
                RETURNING id, phone_number, created_at, updated_at
              ),

              new_contact_inbox AS (
                INSERT INTO contact_inboxes (contact_id, inbox_id, source_id, created_at, updated_at)
                SELECT new_contact.id, $2, gen_random_uuid(), new_contact.created_at, new_contact.updated_at
                FROM new_contact 
                RETURNING id, contact_id, created_at, updated_at
              ),

              new_conversation AS (
                INSERT INTO conversations (account_id, inbox_id, status, contact_id,
                  contact_inbox_id, uuid, last_activity_at, created_at, updated_at)
                SELECT $1, $2, 0, new_contact_inbox.contact_id, new_contact_inbox.id, gen_random_uuid(),
                  new_contact_inbox.updated_at, new_contact_inbox.created_at, new_contact_inbox.updated_at
                FROM new_contact_inbox
                RETURNING id, contact_id
              )

              SELECT new_contact.phone_number, new_conversation.contact_id, new_conversation.id AS conversation_id
              FROM new_conversation 
              JOIN new_contact ON new_conversation.contact_id = new_contact.id

              UNION

              SELECT p.phone_number, c.id contact_id, con.id conversation_id
                FROM phone_number p
              JOIN contacts c ON c.phone_number = p.phone_number
              JOIN contact_inboxes ci ON ci.contact_id = c.id AND ci.inbox_id = $2
              JOIN conversations con ON con.contact_inbox_id = ci.id AND con.account_id = $1
                AND con.inbox_id = $2 AND con.contact_id = c.id`,p=await o.query(c,n);return new Map(p.rows.map(u=>[u.phone_number,u]))}async getChatwootUser(s){try{return(await De.getChatwootConnection().query(`SELECT owner_type AS user_type, owner_id AS user_id
                         FROM access_tokens
                       WHERE token = $1`,[s.token]))?.rows[0]||!1}catch(e){this.logger.error(`Error on getChatwootUser: ${e.toString()}`)}}createMessagesMapByPhoneNumber(s){return s.reduce((e,t)=>{let i=t?.key;if(!this.isIgnorePhoneNumber(i?.remoteJid)){let o=i?.remoteJid?.split("@")[0];if(o){let n=`+${o}`,r=e.has(n)?e.get(n):[];r.push(t),e.set(n,r)}}return e},new Map)}async getContactsOrderByRecentConversations(s,e,t=50){try{return(await De.getChatwootConnection().query(`SELECT contacts.id, contacts.identifier, contacts.phone_number
                     FROM conversations
                   JOIN contacts ON contacts.id = conversations.contact_id
                   WHERE conversations.account_id = $1
                     AND inbox_id = $2
                   ORDER BY conversations.last_activity_at DESC
                   LIMIT $3`,[e.accountId,s.id,t]))?.rows}catch(i){this.logger.error(`Error on get recent conversations: ${i.toString()}`)}}getContentMessage(s,e){let t=s.getConversationMessage(e.message);if(t)return t;if(!b.get("CHATWOOT").IMPORT.PLACEHOLDER_MEDIA_MESSAGE)return"";let i={documentMessage:e.message.documentMessage,documentWithCaptionMessage:e.message.documentWithCaptionMessage?.message?.documentMessage,imageMessage:e.message.imageMessage,videoMessage:e.message.videoMessage,audioMessage:e.message.audioMessage,stickerMessage:e.message.stickerMessage,templateMessage:e.message.templateMessage?.hydratedTemplate?.hydratedContentText};switch(Object.keys(i).find(n=>i[n]!==void 0&&i[n]!==null)){case"documentMessage":{let n=e.message.documentMessage,r=n?.fileName||"document",c=n?.caption?` ${n.caption}`:"";return`_<File: ${r}${c}>_`}case"documentWithCaptionMessage":{let n=e.message.documentWithCaptionMessage?.message?.documentMessage,r=n?.fileName||"document",c=n?.caption?` ${n.caption}`:"";return`_<File: ${r}${c}>_`}case"templateMessage":{let n=e.message.templateMessage?.hydratedTemplate;return(n?.hydratedTitleText?`*${n.hydratedTitleText}*
`:"")+(n?.hydratedContentText||"")}case"imageMessage":return"_<Image Message>_";case"videoMessage":return"_<Video Message>_";case"audioMessage":return"_<Audio Message>_";case"stickerMessage":return"_<Sticker Message>_";default:return""}}sliceIntoChunks(s,e){return s.splice(0,e)}isGroup(s){return s.includes("@g.us")}isIgnorePhoneNumber(s){return this.isGroup(s)||s==="status@broadcast"||s==="0@s.whatsapp.net"}updateMessageSourceID(s,e){return De.getChatwootConnection().query("UPDATE messages SET source_id = $1, status = 0, created_at = NOW(), updated_at = NOW() WHERE id = $2;",[`WAID:${e}`,s])}},l(St,"ChatwootImport"),St),se=new Yh;var lp=x(require("@figuro/chatwoot-sdk")),$t=require("@figuro/chatwoot-sdk/dist/core/request");var zn=x(require("fs")),Xn=x(require("i18next")),Zn=x(require("path")),Qh=["en","pt-BR","es"],zh=Zn.default.join(__dirname,"translations"),Xh=new at,rp={};Qh.forEach(h=>{let s=Zn.default.join(zh,`${h}.json`);if(zn.default.existsSync(s)){let e=zn.default.readFileSync(s,"utf8");rp[h]={translation:JSON.parse(e)}}});Xn.default.init({resources:rp,fallbackLng:"en",lng:Xh.get("LANGUAGE"),debug:!1,interpolation:{escapeValue:!1}});var V=Xn.default;var ap=x(require("axios")),cp=x(require("fs"));var Zh=JSON.parse(cp.default.readFileSync("./package.json","utf8")),j=l(async h=>{let s=b.get("TELEMETRY");if(!s.ENABLED||h==="/")return;let e={route:h,apiVersion:`${Zh.version}`,timestamp:new Date},t=s.URL&&s.URL!==""?s.URL:"https://log.evolution-api.com/telemetry";ap.default.post(t,e).then(()=>{}).catch(()=>{})},"sendTelemetry");var Ft=x(require("axios")),pp=x(require("dayjs")),er=x(require("form-data")),Ds=require("jimp"),tr=require("libphonenumber-js"),sr=x(require("long")),Tt=x(require("mime-types")),ir=x(require("path")),ks=require("stream");var or=class or{constructor(s,e,t,i){a(this,"waMonitor");a(this,"configService");a(this,"prismaRepository");a(this,"cache");a(this,"logger",new O("ChatwootService"));a(this,"LOCK_POLLING_DELAY_MS",300);a(this,"provider");a(this,"pgClient",De.getChatwootConnection());this.waMonitor=s,this.configService=e,this.prismaRepository=t,this.cache=i}async getProvider(s){let e=`${s.instanceName}:getProvider`;if(await this.cache.has(e))return await this.cache.get(e);let t=await this.waMonitor.waInstances[s.instanceName]?.findChatwoot();return t?(this.cache.set(e,t),t):(this.logger.warn("provider not found"),null)}async clientCw(s){let e=await this.getProvider(s);return e?(this.provider=e,new lp.default({config:this.getClientCwConfig()})):(this.logger.error("provider not found"),null)}getClientCwConfig(){return{basePath:this.provider.url,with_credentials:!0,credentials:"include",token:this.provider.token,nameInbox:this.provider.nameInbox,mergeBrazilContacts:this.provider.mergeBrazilContacts}}getCache(){return this.cache}async create(s,e){if(await this.waMonitor.waInstances[s.instanceName].setChatwoot(e),e.autoCreate){this.logger.log("Auto create chatwoot instance");let t=this.configService.get("SERVER").URL;await this.initInstanceChatwoot(s,e.nameInbox??s.instanceName.split("-cwId-")[0],`${t}/chatwoot/webhook/${encodeURIComponent(s.instanceName)}`,!0,e.number,e.organization,e.logo)}return e}async find(s){try{return await this.waMonitor.waInstances[s.instanceName].findChatwoot()}catch{return this.logger.error("chatwoot not found"),{enabled:null,url:""}}}async getContact(s,e){let t=await this.clientCw(s);if(!t)return this.logger.warn("client not found"),null;if(!e)return this.logger.warn("id is required"),null;let i=await t.contact.getContactable({accountId:this.provider.accountId,id:e});return i||(this.logger.warn("contact not found"),null)}async initInstanceChatwoot(s,e,t,i,o,n,r){let c=await this.clientCw(s);if(!c)return this.logger.warn("client not found"),null;let p=await c.inboxes.list({accountId:this.provider.accountId}),u=p.payload.map(y=>y.name).includes(e),d;if(this.logger.log("Creating chatwoot inbox"),u){let y=p.payload.find(m=>m.name===e);if(!y)return this.logger.warn("inbox not found"),null;d=y.id}else{let y={type:"api",webhook_url:t},m=await c.inboxes.create({accountId:this.provider.accountId,data:{name:e,channel:y}});if(!m)return this.logger.warn("inbox not found"),null;d=m.id}if(this.logger.log(`Inbox created - inboxId: ${d}`),!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;this.logger.log("Creating chatwoot bot contact");let f=await this.findContact(s,"123456")||await this.createContact(s,"123456",d,!1,n||"EvolutionAPI",r||"https://evolution-api.com/files/evolution-api-favicon.png");if(!f)return this.logger.warn("contact not found"),null;let g=f.id||f.payload.contact.id;if(this.logger.log(`Contact created - contactId: ${g}`),i){this.logger.log("QR code enabled");let y={contact_id:g.toString(),inbox_id:d.toString()},m=await c.conversations.create({accountId:this.provider.accountId,data:y});if(!m)return this.logger.warn("conversation not found"),null;let S="init";if(o&&(S=`init:${o}`),!await c.messages.create({accountId:this.provider.accountId,conversationId:m.id,data:{content:S,message_type:"outgoing"}}))return this.logger.warn("conversation not found"),null;this.logger.log("Init message sent")}return!0}async createContact(s,e,t,i,o,n,r){try{let c=await this.clientCw(s);if(!c)return this.logger.warn("client not found"),null;let p={};i?p={inbox_id:t,name:o||e,identifier:e,avatar_url:n}:(p={inbox_id:t,name:o||e,identifier:r,avatar_url:n},(r&&r.includes("@")||!r)&&(p.phone_number=`+${e}`));let u=await c.contacts.create({accountId:this.provider.accountId,data:p});if(!u)return this.logger.warn("contact not found"),null;let f=(await this.findContact(s,e))?.id;return await this.addLabelToContact(this.provider.nameInbox,f),u}catch(c){if((c.status===422||c.response?.status===422)&&r){this.logger.warn(`Contact with identifier ${r} creation failed (422). Checking if it already exists...`);let p=await this.findContactByIdentifier(s,r);if(p){let u=p.id;return await this.addLabelToContact(this.provider.nameInbox,u),p}}return this.logger.error("Error creating contact"),console.log(c),null}}async updateContact(s,e,t){let i=await this.clientCw(s);if(!i)return this.logger.warn("client not found"),null;if(!e)return this.logger.warn("id is required"),null;try{return await i.contacts.update({accountId:this.provider.accountId,id:e,data:t})}catch{return null}}async addLabelToContact(s,e){try{if(!this.configService.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI)return!1;let o=(await this.pgClient.query("SELECT id, taggings_count FROM tags WHERE name = $1 LIMIT 1",[s]))?.rows[0],n=o?.id,r=o?.taggings_count||0;return n=(await this.pgClient.query(`INSERT INTO tags (name, taggings_count) 
                      VALUES ($1, $2) 
                      ON CONFLICT (name) 
                      DO UPDATE SET taggings_count = tags.taggings_count + 1 
                      RETURNING id`,[s,r+1]))?.rows[0]?.id,(await this.pgClient.query(`SELECT 1 FROM taggings 
                               WHERE tag_id = $1 AND taggable_type = 'Contact' AND taggable_id = $2 AND context = 'labels' LIMIT 1`,[n,e]))?.rowCount>0||await this.pgClient.query(`INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) 
                                VALUES ($1, 'Contact', $2, 'labels', NOW())`,[n,e]),!0}catch{return!1}}async findContactByIdentifier(s,e){let t=await this.clientCw(s);if(!t)return this.logger.warn("client not found"),null;let i=await t.get("contacts/search",{params:{q:e,sort:"name"}});if(i&&i.data&&i.data.payload&&i.data.payload.length>0)return i.data.payload[0];if(i&&i.payload&&i.payload.length>0)return i.payload[0];let o=await t.post("contacts/filter",{payload:[{attribute_key:"identifier",filter_operator:"equal_to",values:[e],query_operator:null}]});return o&&o.payload&&o.payload.length>0?o.payload[0]:o&&o.data&&o.data.payload&&o.data.payload.length>0?o.data.payload[0]:null}async findContact(s,e){let t=await this.clientCw(s);if(!t)return this.logger.warn("client not found"),null;let i,o=e.includes("@g.us");o?i=e:i=`+${e}`;let n;return o?n=await t.contacts.search({accountId:this.provider.accountId,q:i}):n=await(0,$t.request)(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/contacts/filter`,body:{payload:this.getFilterPayload(i)}}),!n&&n?.payload?.length===0?(this.logger.warn("contact not found"),null):o?n.payload.find(r=>r.identifier===i):n.payload.length>1?this.findContactInContactList(n.payload,i):n.payload[0]}async mergeContacts(s,e){try{return await(0,$t.request)(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,body:{base_contact_id:s,mergee_contact_id:e}})}catch{return this.logger.error("Error merging contacts"),null}}async mergeBrazilianContacts(s){try{return await(0,$t.request)(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,body:{base_contact_id:s.find(t=>t.phone_number.length===14)?.id,mergee_contact_id:s.find(t=>t.phone_number.length===13)?.id}})}catch{return this.logger.error("Error merging contacts"),null}}findContactInContactList(s,e){let t=this.getNumbers(e),i=this.getSearchableFields();if(s.length===2&&this.getClientCwConfig().mergeBrazilContacts&&e.startsWith("+55")){let r=this.mergeBrazilianContacts(s);if(r)return r}let o=t.reduce((r,c)=>c.length>r.length?c:r,""),n=s.find(r=>r.phone_number===o);if(n)return n;for(let r of s)for(let c of i)if(r[c]&&t.includes(r[c]))return r;return null}getNumbers(s){let e=[];if(e.push(s),s.startsWith("+55")&&s.length===14){let t=s.slice(0,5)+s.slice(6);e.push(t)}else if(s.startsWith("+55")&&s.length===13){let t=s.slice(0,5)+"9"+s.slice(5);e.push(t)}return e}getSearchableFields(){return["phone_number"]}getFilterPayload(s){let e=[],t=this.getNumbers(s),i=this.getSearchableFields();return i.forEach((o,n)=>{t.forEach((r,c)=>{let p=i.length-1===n&&t.length-1===c?null:"OR";e.push({attribute_key:o,filter_operator:"equal_to",values:[r.replace("+","")],query_operator:p})})}),e}async createConversation(s,e){let t=e.key.addressingMode==="lid",i=e.key.remoteJid.endsWith("@g.us"),o=t&&!i?e.key.remoteJidAlt:e.key.remoteJid,{remoteJid:n}=e.key,r=`${s.instanceName}:createConversation-${n}`,c=`${s.instanceName}:lock:createConversation-${n}`,p=5e3,u=await this.clientCw(s);if(!u)return null;try{if(o&&n&&!i){let d=await this.findContact(s,o.split("@")[0]);if(d&&d.identifier!==n&&(this.logger.verbose(`Identifier needs update: (contact.identifier: ${d.identifier}, phoneNumber: ${o}, body.key.remoteJidAlt: ${n}`),await this.updateContact(s,d.id,{identifier:o,phone_number:`+${o.split("@")[0]}`})===null)){let g=await this.findContact(s,o.split("@")[0]);g&&(await this.mergeContacts(g.id,d.id),this.logger.verbose(`Merge contacts: (${g.id}) ${g.phone_number} and (${d.id}) ${d.phone_number}`))}}if(this.logger.verbose("--- Start createConversation ---"),this.logger.verbose(`Instance: ${JSON.stringify(s)}`),await this.cache.has(r)){let d=await this.cache.get(r);this.logger.verbose(`Found conversation to: ${o}, conversation ID: ${d}`);let f;try{f=await u.conversations.get({accountId:this.provider.accountId,conversationId:d}),this.logger.verbose(`Conversation exists: ID: ${f.id} - Name: ${f.meta.sender.name} - Identifier: ${f.meta.sender.identifier}`)}catch(g){this.logger.error(`Error getting conversation: ${g}`),f=!1}return f?d:(this.logger.verbose("Conversation does not exist, re-calling createConversation"),this.cache.delete(r),await this.createConversation(s,e))}if(await this.cache.has(c)){this.logger.verbose(`Opera\xE7\xE3o de cria\xE7\xE3o j\xE1 em andamento para ${n}, aguardando resultado...`);let d=Date.now();for(;await this.cache.has(c);){if(Date.now()-d>p){this.logger.warn(`Timeout aguardando lock para ${n}`);break}if(await new Promise(f=>setTimeout(f,this.LOCK_POLLING_DELAY_MS)),await this.cache.has(r)){let f=await this.cache.get(r);return this.logger.verbose(`Resolves creation of: ${n}, conversation ID: ${f}`),f}}}await this.cache.set(c,!0,30),this.logger.verbose(`Bloqueio adquirido para: ${c}`);try{if(await this.cache.has(r))return await this.cache.get(r);let d=i?n:o.split("@")[0].split(":")[0],f=e.key.fromMe?d:e.pushName,g=await this.getInbox(s);if(!g)return null;if(i){this.logger.verbose("Processing group conversation");let C=await this.waMonitor.waInstances[s.instanceName].client.groupMetadata(d);this.logger.verbose(`Group metadata: JID:${C.JID} - Subject:${C?.subject||C?.Name}`);let M=t&&!e.key.fromMe?e.key.participantAlt:e.key.participant;f=`${C.subject} (GROUP)`;let v=await this.waMonitor.waInstances[s.instanceName].profilePicture(M.split("@")[0]);this.logger.verbose(`Participant profile picture URL: ${JSON.stringify(v)}`);let L=await this.findContact(s,M.split("@")[0]);L?(this.logger.verbose(`Found participant: ID:${L.id} - Name: ${L.name} - identifier: ${L.identifier}`),(!L.name||L.name===d)&&await this.updateContact(s,L.id,{name:e.pushName,avatar_url:v.profilePictureUrl||null})):await this.createContact(s,M.split("@")[0].split(":")[0],g.id,!1,e.pushName,v.profilePictureUrl||null,M)}let y=await this.waMonitor.waInstances[s.instanceName].profilePicture(d);this.logger.verbose(`Contact profile picture URL: ${JSON.stringify(y)}`),this.logger.verbose(`Searching contact for: ${d}`);let m=await this.findContact(s,d);if(m){if(this.logger.verbose(`Found contact: ID:${m.id} - Name:${m.name}`),!e.key.fromMe){let C=y?.profilePictureUrl?.split("#")[0].split("?")[0].split("/").pop()||"",M=m?.thumbnail?.split("#")[0].split("?")[0].split("/").pop()||"",v=C!==M,L=!m.name||m.name===d;this.logger.verbose(`Picture needs update: ${v}`),this.logger.verbose(`Name needs update: ${L}`),(v||L)&&(m=await this.updateContact(s,m.id,{...L&&{name:f},...C===""&&{avatar:null},...v&&{avatar_url:y?.profilePictureUrl}}))}}else m=await this.createContact(s,d,g.id,i,f,y.profilePictureUrl||null,o);if(!m)return this.logger.warn("Contact not created or found"),null;let S=m?.payload?.id||m?.payload?.contact?.id||m?.id;this.logger.verbose(`Contact ID: ${S}`);let T=await u.contacts.listConversations({accountId:this.provider.accountId,id:S});if(!T||!T.payload)return this.logger.error("No conversations found or payload is undefined"),null;let A=T.payload.find(C=>C.inbox_id==g.id);if(A&&(this.provider.reopenConversation?(this.logger.verbose(`Found conversation in reopenConversation mode: ID: ${A.id} - Name: ${A.meta.sender.name} - Identifier: ${A.meta.sender.identifier}`),A&&this.provider.conversationPending&&A.status!=="open"&&await u.conversations.toggleStatus({accountId:this.provider.accountId,conversationId:A.id,data:{status:"pending"}})):(A=T.payload.find(C=>C&&C.status!=="resolved"&&C.inbox_id==g.id),this.logger.verbose(`Found conversation: ${JSON.stringify(A)}`)),A))return this.logger.verbose(`Returning existing conversation ID: ${A.id}`),this.cache.set(r,A.id,1800),A.id;let N={contact_id:S.toString(),inbox_id:g.id.toString()};this.provider.conversationPending&&(N.status="pending");let I=await u.conversations.create({accountId:this.provider.accountId,data:N});return I?(this.logger.verbose(`New conversation created of ${n} with ID: ${I.id}`),this.cache.set(r,I.id,1800),I.id):(this.logger.warn("Conversation not created or found"),null)}finally{await this.cache.delete(c),this.logger.verbose(`Block released for: ${c}`)}}catch(d){return this.logger.error(`Error in createConversation: ${d}`),null}}async getInbox(s){let e=`${s.instanceName}:getInbox`;if(await this.cache.has(e))return await this.cache.get(e);let t=await this.clientCw(s);if(!t)return this.logger.warn("client not found"),null;let i=await t.inboxes.list({accountId:this.provider.accountId});if(!i)return this.logger.warn("inbox not found"),null;let o=i.payload.find(n=>n.name===this.getClientCwConfig().nameInbox);return o?(this.cache.set(e,o),o):(this.logger.warn("inbox not found"),null)}async createMessage(s,e,t,i,o,n,r,c,p){let u=await this.clientCw(s);if(!u)return this.logger.warn("client not found"),null;let d=await this.getReplyToIds(r,s),f=p?.chatwootMessageId||null,g=await u.messages.create({accountId:this.provider.accountId,conversationId:e,data:{content:t,message_type:i,attachments:n,private:o||!1,source_id:c,content_attributes:{...d},source_reply_id:f?f.toString():null}});return g||(this.logger.warn("message not found"),null)}async getOpenConversationByContact(s,e,t){let i=await this.clientCw(s);return i?(await i.contacts.listConversations({accountId:this.provider.accountId,id:t.id})).payload.find(n=>n.inbox_id===e.id&&n.status==="open")||void 0:(this.logger.warn("client not found"),null)}async createBotMessage(s,e,t,i){let o=await this.clientCw(s);if(!o)return this.logger.warn("client not found"),null;let n=await this.findContact(s,"123456");if(!n)return this.logger.warn("contact not found"),null;let r=await this.getInbox(s);if(!r)return this.logger.warn("inbox not found"),null;let c=await this.getOpenConversationByContact(s,r,n);if(!c){this.logger.warn("conversation not found");return}let p=await o.messages.create({accountId:this.provider.accountId,conversationId:c.id,data:{content:e,message_type:t,attachments:i}});return p||(this.logger.warn("message not found"),null)}async sendData(s,e,t,i,o,n,r,c,p){if(c&&this.isImportHistoryAvailable()){let g=await se.getExistingSourceIds([c],s);if(g&&g.size>0)return this.logger.warn("Message already saved on chatwoot"),null}let u=new er.default;o&&u.append("content",o),u.append("message_type",i),u.append("attachments[]",e,{filename:t});let d=p?.chatwootMessageId||null;if(r&&n){let g=await this.getReplyToIds(r,n);if(g.in_reply_to||g.in_reply_to_external_id){let y=JSON.stringify({...g});u.append("content_attributes",y)}}d&&u.append("source_reply_id",d.toString()),c&&u.append("source_id",c);let f={method:"post",maxBodyLength:1/0,url:`${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${s}/messages`,headers:{api_access_token:this.provider.token,...u.getHeaders()},data:u};try{let{data:g}=await Ft.default.request(f);return g}catch(g){this.logger.error(g)}}async createBotQr(s,e,t,i,o){if(!await this.clientCw(s))return this.logger.warn("client not found"),null;if(!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;let r=await this.findContact(s,"123456");if(!r)return this.logger.warn("contact not found"),null;let c=await this.getInbox(s);if(!c)return this.logger.warn("inbox not found"),null;let p=await this.getOpenConversationByContact(s,c,r);if(!p){this.logger.warn("conversation not found");return}let u=new er.default;e&&u.append("content",e),u.append("message_type",t),i&&o&&u.append("attachments[]",i,{filename:o});let d={method:"post",maxBodyLength:1/0,url:`${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${p.id}/messages`,headers:{api_access_token:this.provider.token,...u.getHeaders()},data:u};try{let{data:f}=await Ft.default.request(d);return f}catch(f){this.logger.error(f)}}async sendAttachment(s,e,t,i,o){try{let n=ir.default.parse(decodeURIComponent(t)),r=Tt.default.lookup(n?.ext)||"",c=n?.name+n?.ext;if(!r){let g=t.split("/");c=decodeURIComponent(g[g.length-1]),r=(await Ft.default.get(t,{responseType:"arraybuffer"})).headers["content-type"]}let p="document";switch(r.split("/")[0]){case"image":p="image";break;case"video":p="video";break;case"audio":p="audio";break;default:p="document";break}if(p==="audio"){let g={number:e,audio:t,delay:Math.floor(Math.random()*1501)+500,quoted:o?.quoted};return j("/message/sendWhatsAppAudio"),await s?.audioWhatsapp(g,null,!0)}p==="image"&&n&&[".gif",".svg",".tiff",".tif",".dxf",".dwg"].includes(n?.ext)&&(p="document");let d={number:e,mediatype:p,fileName:c,media:t,delay:1200,quoted:o?.quoted};return j("/message/sendMedia"),i&&(d.caption=i),await s?.mediaMessage(d,null,!0)}catch(n){throw this.logger.error(n),n}}async onSendMessageError(s,e,t){this.logger.verbose(`onSendMessageError ${JSON.stringify(t)}`);let i=await this.clientCw(s);if(i){if(t&&t?.status===400&&t?.message[0]?.exists===!1){i.messages.create({accountId:this.provider.accountId,conversationId:e,data:{content:`${V.t("cw.message.numbernotinwhatsapp")}`,message_type:"outgoing",private:!0}});return}i.messages.create({accountId:this.provider.accountId,conversationId:e,data:{content:V.t("cw.message.notsent",{error:t?`_${t.toString()}_`:""}),message_type:"outgoing",private:!0}})}}async receiveWebhook(s,e){try{if(await new Promise(p=>setTimeout(p,500)),!await this.clientCw(s))return this.logger.warn("client not found"),null;if(this.provider.reopenConversation===!1&&e.event==="conversation_status_changed"&&e.status==="resolved"&&e.meta?.sender?.identifier){let p=`${s.instanceName}:createConversation-${e.meta.sender.identifier}`;this.cache.delete(p)}if(!e?.conversation||e.private||e.event==="message_updated"&&!e.content_attributes?.deleted)return{message:"bot"};let i=e.conversation.meta.sender?.identifier||e.conversation.meta.sender?.phone_number.replace("+",""),o=e.content?e.content.replaceAll(/(?<!\*)\*((?!\s)([^\n*]+?)(?<!\s))\*(?!\*)/g,"_$1_").replaceAll(/\*{2}((?!\s)([^\n*]+?)(?<!\s))\*{2}/g,"*$1*").replaceAll(/~{2}((?!\s)([^\n*]+?)(?<!\s))~{2}/g,"~$1~").replaceAll(/(?<!`)`((?!\s)([^`*]+?)(?<!\s))`(?!`)/g,"```$1```"):e.content,n=e?.conversation?.messages[0]?.sender?.available_name||e?.sender?.name,r=this.waMonitor.waInstances[s.instanceName];if(s.instanceId=r.instanceId,e.event==="message_updated"&&e.content_attributes?.deleted){let p=await this.prismaRepository.message.findFirst({where:{chatwootMessageId:e.id,instanceId:s.instanceId}});if(p){let u=p.key;await r?.client.sendMessage(u.remoteJid,{delete:u}),await this.prismaRepository.message.deleteMany({where:{instanceId:s.instanceId,chatwootMessageId:e.id}})}return{message:"bot"}}let c=this.configService.get("CHATWOOT").BOT_CONTACT;if(i==="123456"&&e.message_type==="outgoing"){let p=o.replace("/","");if(c&&(p.includes("init")||p.includes("iniciar")))if(r?.connectionStatus?.state!=="open"){let d=p.split(":")[1];await r.connectToWhatsapp(d)}else await this.createBotMessage(s,V.t("cw.inbox.alreadyConnected",{inboxName:e.inbox.name}),"incoming");if(p==="clearcache"&&(r.clearCacheChatwoot(),await this.createBotMessage(s,V.t("cw.inbox.clearCache",{inboxName:e.inbox.name}),"incoming")),p==="status"){let u=r?.connectionStatus?.state;u||await this.createBotMessage(s,V.t("cw.inbox.notFound",{inboxName:e.inbox.name}),"incoming"),u&&await this.createBotMessage(s,V.t("cw.inbox.status",{inboxName:e.inbox.name,state:u}),"incoming")}if(c&&(p==="disconnect"||p==="desconectar")){let u=V.t("cw.inbox.disconnect",{inboxName:e.inbox.name});await this.createBotMessage(s,u,"incoming"),await r?.client?.logout("Log out instance: "+s.instanceName),await r?.client?.ws?.close()}}if(e.message_type==="outgoing"&&e?.conversation?.messages?.length&&i!=="123456"){if(e?.conversation?.messages[0]?.source_id?.substring(0,5)==="WAID:")return{message:"bot"};if(!r&&e.conversation?.id)return this.onSendMessageError(s,e.conversation?.id,"Instance not found"),{message:"bot"};let p;if(n==null)p=o;else{let d=this.provider.signDelimiter?this.provider.signDelimiter.replaceAll("\\n",`
`):`
`,f=this.provider.signMsg?[`*${n}:*`]:[];f.push(o),p=f.join(d)}for(let d of e.conversation.messages)if(d.attachments&&d.attachments.length>0)for(let f of d.attachments){o||(p=null);let g={quoted:await this.getQuotedMessage(e,s)},y=await this.sendAttachment(r,i,f.data_url,p,g);!y&&e.conversation?.id&&this.onSendMessageError(s,e.conversation?.id),await this.updateChatwootMessageId({...y},{messageId:e.id,inboxId:e.inbox?.id,conversationId:e.conversation?.id,contactInboxSourceId:e.conversation?.contact_inbox?.source_id},s)}else{let f={number:i,text:p,delay:Math.floor(Math.random()*1501)+500,quoted:await this.getQuotedMessage(e,s)};j("/message/sendText");let g;try{if(g=await r?.textMessage(f,!0),!g)throw new Error("Message not sent");sr.default.isLong(g?.messageTimestamp)&&(g.messageTimestamp=g.messageTimestamp?.toNumber()),await this.updateChatwootMessageId({...g},{messageId:e.id,inboxId:e.inbox?.id,conversationId:e.conversation?.id,contactInboxSourceId:e.conversation?.contact_inbox?.source_id},s)}catch(y){throw!g&&e.conversation?.id&&this.onSendMessageError(s,e.conversation?.id,y),y}}if(this.configService.get("CHATWOOT").MESSAGE_READ){let d=await this.prismaRepository.message.findFirst({where:{key:{path:["fromMe"],equals:!1},instanceId:s.instanceId}});if(d&&!d.chatwootIsRead){let f=d.key;r?.markMessageAsRead({readMessages:[{id:f.id,fromMe:f.fromMe,remoteJid:f.remoteJid}]});let g={chatwootMessageId:d.chatwootMessageId,chatwootConversationId:d.chatwootConversationId,chatwootInboxId:d.chatwootInboxId,chatwootContactInboxSourceId:d.chatwootContactInboxSourceId,chatwootIsRead:!0};await this.prismaRepository.message.updateMany({where:{instanceId:s.instanceId,key:{path:["id"],equals:f.id}},data:g})}}}if(e.message_type==="template"&&e.event==="message_created"){let p={number:i,text:e.content.replace(/\\\r\n|\\\n|\n/g,`
`),delay:Math.floor(Math.random()*1501)+500};j("/message/sendText"),await r?.textMessage(p)}return{message:"bot"}}catch(t){return this.logger.error(t),{message:"bot"}}}async updateChatwootMessageId(s,e,t){let i=s.key;if(!e.messageId||!i?.id)return;let o=await this.prismaRepository.$executeRaw`
      UPDATE "Message" 
      SET 
        "chatwootMessageId" = ${e.messageId},
        "chatwootConversationId" = ${e.conversationId},
        "chatwootInboxId" = ${e.inboxId},
        "chatwootContactInboxSourceId" = ${e.contactInboxSourceId},
        "chatwootIsRead" = ${e.isRead||!1}
      WHERE "instanceId" = ${t.instanceId} 
      AND "key"->>'id' = ${i.id}
    `;if(this.logger.verbose(`Update result: ${o} rows affected`),this.isImportHistoryAvailable())try{await se.updateMessageSourceID(e.messageId,i.id)}catch(n){this.logger.error(`Error updating Chatwoot message source ID: ${n}`)}}async getMessageByKeyId(s,e){return(await this.prismaRepository.$queryRaw`
      SELECT * FROM "Message" 
      WHERE "instanceId" = ${s.instanceId} 
      AND "key"->>'id' = ${e}
      LIMIT 1
    `)[0]||null}async getReplyToIds(s,e){let t=null,i=null;if(s&&(i=s.message?.extendedTextMessage?.contextInfo?.stanzaId??s.contextInfo?.stanzaId,i)){let o=await this.getMessageByKeyId(e,i);o?.chatwootMessageId&&(t=o.chatwootMessageId)}return{in_reply_to:t,in_reply_to_external_id:i}}async getQuotedMessage(s,e){if(s?.content_attributes?.in_reply_to){let t=await this.prismaRepository.message.findFirst({where:{chatwootMessageId:s?.content_attributes?.in_reply_to,instanceId:e.instanceId}}),i=t?.key,o=t?.message;if(o&&i?.id)return{key:i,message:o}}return null}isMediaMessage(s){let e=["imageMessage","documentMessage","documentWithCaptionMessage","audioMessage","videoMessage","stickerMessage","viewOnceMessageV2"];return Object.keys(s).some(o=>e.includes(o))}isInteractiveButtonMessage(s,e){return s==="interactiveMessage"&&e.interactiveMessage?.nativeFlowMessage?.buttons?.length>0}getAdsMessage(s){return{title:s.extendedTextMessage?.contextInfo?.externalAdReply?.title||s.contextInfo?.externalAdReply?.title,body:s.extendedTextMessage?.contextInfo?.externalAdReply?.body||s.contextInfo?.externalAdReply?.body,thumbnailUrl:s.extendedTextMessage?.contextInfo?.externalAdReply?.thumbnailUrl||s.contextInfo?.externalAdReply?.thumbnailUrl,sourceUrl:s.extendedTextMessage?.contextInfo?.externalAdReply?.sourceUrl||s.contextInfo?.externalAdReply?.sourceUrl}}getReactionMessage(s){return s?.reactionMessage}getTypeMessage(s){return{conversation:s.conversation,imageMessage:s.imageMessage?.caption,videoMessage:s.videoMessage?.caption,extendedTextMessage:s.extendedTextMessage?.text,messageContextInfo:s.messageContextInfo?.stanzaId,stickerMessage:void 0,documentMessage:s.documentMessage?.caption,documentWithCaptionMessage:s.documentWithCaptionMessage?.message?.documentMessage?.caption,audioMessage:s.audioMessage?s.audioMessage.caption??"":void 0,contactMessage:s.contactMessage?.vcard,contactsArrayMessage:s.contactsArrayMessage,locationMessage:s.locationMessage,liveLocationMessage:s.liveLocationMessage,listMessage:s.listMessage,listResponseMessage:s.listResponseMessage,viewOnceMessageV2:s?.message?.viewOnceMessageV2?.message?.imageMessage?.url||s?.message?.viewOnceMessageV2?.message?.videoMessage?.url||s?.message?.viewOnceMessageV2?.message?.audioMessage?.url}}getMessageContent(s){let e=Object.keys(s).find(i=>s[i]!==void 0),t=e?s[e]:void 0;if(t&&typeof t=="string"&&t.includes("externalAdReplyBody|")&&(t=t.split("externalAdReplyBody|").filter(Boolean).join("")),e==="locationMessage"||e==="liveLocationMessage"){let i=t.degreesLatitude,o=t.degreesLongitude,n=t?.name,r=t?.address;return`*${V.t("cw.locationMessage.location")}:*

_${V.t("cw.locationMessage.latitude")}:_ ${i} 
_${V.t("cw.locationMessage.longitude")}:_ ${o} 
`+(n?`_${V.t("cw.locationMessage.locationName")}:_ ${n}
`:"")+(r?`_${V.t("cw.locationMessage.locationAddress")}:_ ${r} 
`:"")+`_${V.t("cw.locationMessage.locationUrl")}:_ https://www.google.com/maps/search/?api=1&query=${i},${o}`}if(e==="contactMessage"){let i=t.split(`
`),o={};i.forEach(c=>{let[p,u]=c.split(":");p&&u&&(o[p]=u)});let n=`*${V.t("cw.contactMessage.contact")}:*

_${V.t("cw.contactMessage.name")}:_ ${o.FN}`,r=1;return Object.keys(o).forEach(c=>{if(c.startsWith("item")&&c.includes("TEL")){let p=o[c];n+=`
_${V.t("cw.contactMessage.number")} (${r}):_ ${p}`,r++}else if(c.includes("TEL")){let p=o[c];n+=`
_${V.t("cw.contactMessage.number")} (${r}):_ ${p}`,r++}}),n}if(e==="contactsArrayMessage")return t.contacts.map(n=>{let r=n.vcard.split(`
`),c={};r.forEach(d=>{let[f,g]=d.split(":");f&&g&&(c[f]=g)});let p=`*${V.t("cw.contactMessage.contact")}:*

_${V.t("cw.contactMessage.name")}:_ ${n.displayName}`,u=1;return Object.keys(c).forEach(d=>{if(d.startsWith("item")&&d.includes("TEL")){let f=c[d];p+=`
_${V.t("cw.contactMessage.number")} (${u}):_ ${f}`,u++}else if(d.includes("TEL")){let f=c[d];p+=`
_${V.t("cw.contactMessage.number")} (${u}):_ ${f}`,u++}}),p}).join(`

`);if(e==="listMessage"){let i=t?.title||"Unknown",o=t?.description||"Unknown",n=t?.footerText||"Unknown",r=`*List Menu:*

_Title_: `+i+`
_Description_: `+o+`
_Footer_: `+n;return t.sections&&t.sections.length>0?t.sections.forEach((c,p)=>{r+=`

*Section `+(p+1)+":* "+c.title||`Unknown
`,c.rows&&c.rows.length>0?c.rows.forEach((u,d)=>{r+=`
*Line `+(d+1)+`:*
`,r+="_\u25AA\uFE0F Title:_ "+(u.title||"Unknown")+`
`,r+="_\u25AA\uFE0F Description:_ "+(u.description||"Unknown")+`
`,r+="_\u25AA\uFE0F ID:_ "+(u.rowId||"Unknown")+`
`}):r+=`
No lines found in this section.
`}):r+=`
No sections found.
`,r}if(e==="listResponseMessage"){let i=t?.title||"Unknown",o=t?.description||"Unknown",n=t?.singleSelectReply?.selectedRowId||"Unknown";return`*List Response:*

_Title_: `+i+`
_Description_: `+o+`
_ID_: `+n}return t}getConversationMessage(s){let e=this.getTypeMessage(s);return this.getMessageContent(e)}async eventWhatsapp(s,e,t){try{let i=this.waMonitor.waInstances[e.instanceName];if(!i)return this.logger.warn("wa instance not found"),null;let o=await this.clientCw(e);if(!o)return this.logger.warn("client not found"),null;if(this.provider?.ignoreJids&&this.provider?.ignoreJids.length>0){let n=this.provider?.ignoreJids,r=!1,c=!1;if(n.includes("@g.us")&&(r=!0),n.includes("@s.whatsapp.net")&&(c=!0),r&&t?.key?.remoteJid.endsWith("@g.us")){this.logger.warn("Ignoring message from group: "+t?.key?.remoteJid);return}if(c&&t?.key?.remoteJid.endsWith("@s.whatsapp.net")){this.logger.warn("Ignoring message from contact: "+t?.key?.remoteJid);return}if(n.includes(t?.key?.remoteJid)){this.logger.warn("Ignoring message from jid: "+t?.key?.remoteJid);return}}if(s==="messages.upsert"||s==="send.message"){if(this.logger.info(`[${s}] New message received - Instance: ${JSON.stringify(t,null,2)}`),t.key.remoteJid==="status@broadcast")return;t.message?.ephemeralMessage?.message&&(t.message={...t.message?.ephemeralMessage?.message});let n=await this.getConversationMessage(t.message),r=n&&n.replaceAll(/\*((?!\s)([^\n*]+?)(?<!\s))\*/g,"**$1**").replaceAll(/_((?!\s)([^\n_]+?)(?<!\s))_/g,"*$1*").replaceAll(/~((?!\s)([^\n~]+?)(?<!\s))~/g,"~~$1~~");if(r&&r.includes("/survey/responses/")&&r.includes("http"))return;let c=t.contextInfo?.stanzaId||t.message?.contextInfo?.stanzaId,p=null;c&&(p=await this.prismaRepository.message.findFirst({where:{key:{path:["id"],equals:c},chatwootMessageId:{not:null}}}));let u=this.isMediaMessage(t.message),d=this.getAdsMessage(t),f=this.getReactionMessage(t.message),g=this.isInteractiveButtonMessage(t.messageType,t.message);if(!r&&!u&&!f&&!g){this.logger.warn("no body message found");return}let y=await this.createConversation(e,t);if(!y){this.logger.warn("conversation not found");return}let m=t.key.fromMe?"outgoing":"incoming";if(u){let T=await i?.getBase64FromMediaMessage({message:{...t}}),A,N=t?.message[t?.messageType],I=N?.fileName||N?.filename||N?.message?.documentMessage?.fileName;if(I){let v=ir.default.parse(I);v.name&&v.ext&&(A=`${v.name}-${Math.floor(Math.random()*90+10)}${v.ext}`)}A||(A=`${Math.random().toString(36).substring(7)}.${Tt.default.extension(T.mimetype)||""}`);let C=Buffer.from(T.base64,"base64"),M=new ks.Readable;if(M._read=()=>{},M.push(C),M.push(null),t.key.remoteJid.includes("@g.us")){let v=t.pushName,L=t.key.addressingMode==="lid"&&!t.key.fromMe&&t.key.participantAlt?t.key.participantAlt.split("@")[0].split(":")[0]:t.key.participant.split("@")[0].split(":")[0],B=(0,tr.parsePhoneNumberFromString)(`+${L}`).formatInternational(),W;t.key.fromMe?W=r||"":W=r?`**${B} - ${v}:**

${r}`:`**${B} - ${v}:**`;let q=await this.sendData(y,M,A,m,W,e,t,"WAID:"+t.key.id,p);if(!q){this.logger.warn("message not sent");return}return q}else{let v=await this.sendData(y,M,A,m,r,e,t,"WAID:"+t.key.id,p);if(!v){this.logger.warn("message not sent");return}return v}}if(f){if(f.text&&!await this.createMessage(e,y,f.text,m,!1,[],{message:{extendedTextMessage:{contextInfo:{stanzaId:f.key.id}}}},"WAID:"+t.key.id,p)){this.logger.warn("message not sent");return}return}if(g){let T=t.message.interactiveMessage.nativeFlowMessage.buttons;this.logger.info("is Interactive Button Message: "+JSON.stringify(T));for(let A of T){let I=JSON.parse(A.buttonParamsJson).payment_settings;if(A.name==="payment_info"&&I[0].type==="pix_static_code"){let C=I[0].pix_static_code,M=(()=>{switch(C.key_type){case"EVP":return"Chave Aleat\xF3ria";case"EMAIL":return"E-mail";case"PHONE":return"Telefone";default:return C.key_type}})(),v=C.key_type==="PHONE"?C.key.replace("+55",""):C.key,L=`*${C.merchant_name}*
Chave PIX: ${v} (${M})`;await this.createMessage(e,y,L,m,!1,[],t,"WAID:"+t.key.id,p)||this.logger.warn("message not sent")}else this.logger.warn("Interactive Button Message not mapped")}return}if(d&&d.title||d.body||d.thumbnailUrl){let T=await Ft.default.get(d.thumbnailUrl,{responseType:"arraybuffer"}),A=Tt.default.extension(T.headers["content-type"]),N=A&&Tt.default.lookup(A);if(!N){this.logger.warn("mimetype of Ads message not found");return}let C=`${Math.random().toString(36).substring(7)}.${Tt.default.extension(N)}`,M=Buffer.from(T.data,"binary"),v=await Ds.Jimp.read(M);await v.cover({w:320,h:180});let L=await v.getBuffer(Ds.JimpMime.png),B=new ks.Readable;B._read=()=>{},B.push(L),B.push(null);let W=l((z,fe)=>z?z.length>fe?z.substring(0,fe)+"...":z:"","truncStr"),q=W(d.title,40),X=W(d?.body,75),te=await this.sendData(y,B,C,m,`${r}


**${q}**
${X}
${d.sourceUrl}`,e,t,"WAID:"+t.key.id);if(!te){this.logger.warn("message not sent");return}return te}if(t.key.remoteJid.includes("@g.us")){let T=t.pushName,A=t.key.addressingMode==="lid"&&!t.key.fromMe&&t.key.participantAlt?t.key.participantAlt.split("@")[0].split(":")[0]:t.key.participant.split("@")[0].split(":")[0],N=(0,tr.parsePhoneNumberFromString)(`+${A}`).formatInternational(),I;t.key.fromMe?I=`${r}`:I=`**${N} - ${T}:**

${r}`;let C=await this.createMessage(e,y,I,m,!1,[],t,"WAID:"+t.key.id,p);if(!C){this.logger.warn("message not sent");return}return C}else{let T=await this.createMessage(e,y,r,m,!1,[],t,"WAID:"+t.key.id,p);if(!T){this.logger.warn("message not sent");return}return T}}if(s===R.MESSAGES_DELETE&&this.configService.get("CHATWOOT").MESSAGE_DELETE===!0){if(!t?.key?.id){this.logger.warn("message id not found");return}let r=await this.getMessageByKeyId(e,t.key.id);if(r?.chatwootMessageId&&r?.chatwootConversationId)return await this.prismaRepository.message.deleteMany({where:{key:{path:["id"],equals:t.key.id},instanceId:e.instanceId}}),await o.messages.delete({accountId:this.provider.accountId,conversationId:r.chatwootConversationId,messageId:r.chatwootMessageId})}if(s==="messages.edit"||s==="send.message.update"){let r=(t?.editedMessage?.conversation??t?.editedMessage?.extendedTextMessage?.text??t?.editedMessage?.imageMessage?.caption??t?.editedMessage?.videoMessage?.caption??t?.editedMessage?.documentMessage?.caption??(typeof t?.text=="string"?t.text:void 0)??"").trim();if(!r){this.logger.info("[CW.EDIT] Conte\xFAdo vazio \u2014 ignorando (DELETE tratar\xE1 se for revoke).");return}let c=await this.getMessageByKeyId(e,t?.key?.id);if(!c){this.logger.warn("Message not found for edit event");return}let p=c.key,u=p?.fromMe?"outgoing":"incoming";if(c&&c.chatwootConversationId&&c.chatwootMessageId){let d=`

\`${V.t("cw.message.edited")}:\`

${r}`;if(!await this.createMessage(e,c.chatwootConversationId,d,u,!1,[],{message:{extendedTextMessage:{contextInfo:{stanzaId:p.id}}}},"WAID:"+t.key.id,null)){this.logger.warn("edited message not sent");return}}return}if(s==="messages.read"){if(!t?.key?.id||!t?.key?.remoteJid){this.logger.warn("message id not found");return}let n=await this.getMessageByKeyId(e,t.key.id),r=n?.chatwootConversationId,c=n?.chatwootContactInboxSourceId;if(r){let p=c,u=await this.getInbox(e);if(!p&&u&&(p=(await o.conversations.get({accountId:this.provider.accountId,conversationId:r})).last_non_activity_message?.conversation?.contact_inbox?.source_id),p&&u?.inbox_identifier){let d=`/public/api/v1/inboxes/${u.inbox_identifier}/contacts/${p}/conversations/${r}/update_last_seen`;await(0,$t.request)(this.getClientCwConfig(),{method:"POST",url:d})}}return}if(s==="status.instance"){let n=t,r=await this.getInbox(e);if(!r){this.logger.warn("inbox not found");return}let c=V.t("cw.inbox.status",{inboxName:r.name,state:n.status});await this.createBotMessage(e,c,"incoming")}if(s==="connection.update"&&t.status==="open"){let n=this.waMonitor.waInstances[e.instanceName];if(!n)return;let r=Date.now(),c=r-(n.lastConnectionNotification||0);if(n.qrCode&&n.qrCode.count>0){let p=V.t("cw.inbox.connected");await this.createBotMessage(e,p,"incoming"),n.qrCode.count=0,n.lastConnectionNotification=r,se.clearAll(e)}else if(c>=3e4){let p=V.t("cw.inbox.connected");await this.createBotMessage(e,p,"incoming"),n.lastConnectionNotification=r}else this.logger.warn(`Connection notification skipped for ${e.instanceName} - too frequent (${c}ms since last)`)}if(s==="qrcode.updated")if(t.statusCode===500){let n=`\u{1F6A8} ${V.t("qrlimitreached")}`;return await this.createBotMessage(e,n,"incoming")}else{let n=Buffer.from(t?.qrcode.base64.replace("data:image/png;base64,",""),"base64"),r=new ks.Readable;r._read=()=>{},r.push(n),r.push(null),await this.createBotQr(e,V.t("qrgeneratedsuccesfully"),"incoming",r,`${e.instanceName}.png`);let c=`\u26A1\uFE0F${V.t("qrgeneratedsuccesfully")}

${V.t("scanqr")}`;t?.qrcode?.pairingCode&&(c=c+`

*Pairing Code:* ${t.qrcode.pairingCode.substring(0,4)}-${t.qrcode.pairingCode.substring(4,8)}`),await this.createBotMessage(e,c,"incoming")}}catch(i){this.logger.error(i)}}normalizeJidIdentifier(s){return s?s.includes("@lid")?s:s.replace(/:\d+/,"").split("@")[0]:""}startImportHistoryMessages(s){this.isImportHistoryAvailable()&&this.createBotMessage(s,V.t("cw.import.startImport"),"incoming")}isImportHistoryAvailable(){let s=this.configService.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI;return s&&s!=="postgres://user:password@hostname:port/dbname"}addHistoryMessages(s,e){this.isImportHistoryAvailable()&&se.addHistoryMessages(s,e)}addHistoryContacts(s,e){if(this.isImportHistoryAvailable())return se.addHistoryContacts(s,e)}async importHistoryMessages(s){if(!this.isImportHistoryAvailable())return;this.createBotMessage(s,V.t("cw.import.importingMessages"),"incoming");let e=await se.importHistoryMessages(s,this,await this.getInbox(s),this.provider);this.updateContactAvatarInRecentConversations(s);let t=Number.isInteger(e)?V.t("cw.import.messagesImported",{totalMessagesImported:e}):V.t("cw.import.messagesException");return this.createBotMessage(s,t,"incoming"),e}async updateContactAvatarInRecentConversations(s,e=100){try{if(!this.isImportHistoryAvailable())return;let t=await this.clientCw(s);if(!t)return this.logger.warn("client not found"),null;let i=await this.getInbox(s);if(!i)return this.logger.warn("inbox not found"),null;let o=await se.getContactsOrderByRecentConversations(i,this.provider,e),n=o.map(c=>c.identifier).filter(c=>c!==null),r=(await this.prismaRepository.contact.findMany({where:{instanceId:s.instanceId,id:{in:n},profilePicUrl:{not:null}}})).reduce((c,p)=>c.set(p.id,p),new Map);o.forEach(async c=>{r.has(c.identifier)&&t.contacts.update({accountId:this.provider.accountId,id:c.id,data:{avatar_url:r.get(c.identifier).profilePictureUrl||null}})})}catch(t){this.logger.error(`Error on update avatar in recent conversations: ${t.toString()}`)}}async syncLostMessages(s,e,t){try{if(!this.isImportHistoryAvailable()||!this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE)return;let i=await this.getInbox(s),o=`select * from messages m
      where account_id = ${e.accountId}
      and inbox_id = ${i.id}
      and created_at >= now() - interval '6h'
      order by created_at desc`,r=((await this.pgClient.query(o))?.rows).filter(f=>!!f.source_id).map(f=>f.source_id.replace("WAID:","")),p=(await this.prismaRepository.message.findMany({where:{Instance:{name:s.instanceName},messageTimestamp:{gte:Number((0,pp.default)().subtract(6,"hours").unix())},AND:r.map(f=>({key:{path:["id"],not:f}}))}})).filter(f=>!se.isIgnorePhoneNumber(f.key?.remoteJid)),u=[];for(let f of p)!f.message||!f.key||!f.messageTimestamp||(sr.default.isLong(f?.messageTimestamp)&&(f.messageTimestamp=f.messageTimestamp?.toNumber()),u.push(t(f)));this.addHistoryMessages(s,u.filter(f=>!se.isIgnorePhoneNumber(f.key?.remoteJid))),await se.importHistoryMessages(s,this,i,this.provider),this.waMonitor.waInstances[s.instanceName].clearCacheChatwoot()}catch{return}}};l(or,"ChatwootService");var lt=or;var At=x(require("axios")),rr=require("class-validator");var nr=class nr{constructor(s,e,t,i){a(this,"logger");a(this,"waMonitor");a(this,"prismaRepository");a(this,"configService");this.waMonitor=s,this.prismaRepository=e,this.logger=new O(t),this.configService=i}isImageMessage(s){return s.includes("imageMessage")}isAudioMessage(s){return s.includes("audioMessage")}isJSON(s){try{return JSON.parse(s),!0}catch{return!1}}getMediaType(s){let e=s.split(".").pop()?.toLowerCase(),t=["jpg","jpeg","png","gif","bmp","webp"],i=["mp3","wav","aac","ogg"],o=["mp4","avi","mkv","mov"],n=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return t.includes(e||"")?"image":i.includes(e||"")?"audio":o.includes(e||"")?"video":n.includes(e||"")?"document":null}async createNewSession(s,e,t){try{let i=typeof e.pushName=="object"&&e.pushName?.pushName?e.pushName.pushName:typeof e.pushName=="string"?e.pushName:null,o=typeof e.remoteJid=="object"&&e.remoteJid?.remoteJid?e.remoteJid.remoteJid:e.remoteJid;return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:o,pushName:i,sessionId:o,status:"opened",awaitUser:!1,botId:e.botId,instanceId:s.instanceId,type:t}})}}catch(i){this.logger.error(i);return}}async process(s,e,t,i,o,n,r,c){try{if(!i){await this.initNewSession(s,e,t,o,i,n,r,c);return}if(i.status==="paused")return;let p=o?.keywordFinish||"",u=n.toLowerCase().trim();if(p.length>0&&u===p.toLowerCase()){await this.prismaRepository.integrationSession.update({where:{id:i.id},data:{status:"closed"}});return}await this.sendMessageToBot(s,i,o,t,e,r||"",n,c),await this.prismaRepository.integrationSession.update({where:{id:i.id},data:{status:"opened",awaitUser:!0}})}catch(p){this.logger.error(`Error in process: ${p}`);return}}async sendMessageWhatsApp(s,e,t,i,o=!0){if(!t)return;let n=/!?\[(.*?)\]\((.*?)\)/g,r="",c=0,p,u=i?.splitMessages??!1;for(;(p=n.exec(t))!==null;){let[d,f,g]=p,y=this.getMediaType(g),m=t.slice(c,p.index);if(m&&(r+=m),y){r.trim()&&(await this.sendFormattedText(s,e,r.trim(),i,u,o),r="");try{y==="audio"?await s.audioWhatsapp({number:e.includes("@lid")?e:e.split("@")[0],delay:i?.delayMessage||1e3,audio:g,caption:f}):await s.mediaMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:i?.delayMessage||1e3,mediatype:y,media:g,caption:f,fileName:y==="document"?f||"document":void 0},null,!1)}catch(S){this.logger.error(`Error sending media: ${S}`),r+=`${f}: ${g}`}}else r+=d;c=n.lastIndex}if(c<t.length){let d=t.slice(c);d.trim()&&(r+=d)}r.trim()&&await this.sendFormattedText(s,e,r.trim(),i,u,o)}splitMessageByDoubleLineBreaks(s){return s.split(`

`).filter(e=>e.trim().length>0)}async sendSingleMessage(s,e,t,i,o=!0){let n=i?.timePerChar??0,p=Math.min(Math.max(t.length*n,1e3),2e4);this.logger.debug(`[BaseChatbot] Sending single message with linkPreview: ${o}`),s.integration===J.WHATSAPP_BAILEYS&&(await s.client.presenceSubscribe(e),await s.client.sendPresenceUpdate("composing",e)),await new Promise(u=>{setTimeout(async()=>{await s.textMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:i?.delayMessage||1e3,text:t,linkPreview:o},!1),u()},p)}),s.integration===J.WHATSAPP_BAILEYS&&await s.client.sendPresenceUpdate("paused",e)}async sendFormattedText(s,e,t,i,o,n=!0){if(o){let r=this.splitMessageByDoubleLineBreaks(t);this.logger.debug(`[BaseChatbot] Splitting message into ${r.length} parts`);for(let c=0;c<r.length;c++){let p=r[c];this.logger.debug(`[BaseChatbot] Sending message part ${c+1}/${r.length}`),await this.sendSingleMessage(s,e,p,i,n)}this.logger.debug("[BaseChatbot] All message parts sent successfully")}else this.logger.debug("[BaseChatbot] Sending single message"),await this.sendSingleMessage(s,e,t,i,n)}async initNewSession(s,e,t,i,o,n,r,c){if(!o){let p=typeof r=="object"&&r?.pushName?r.pushName:typeof r=="string"?r:null,u=await this.createNewSession({instanceName:s.instanceName,instanceId:s.instanceId},{remoteJid:e,pushName:p,botId:t.id},this.getBotType());if(!u||!u.session){this.logger.error("Failed to create new session");return}o=u.session}await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"opened",awaitUser:!1}}),await this.sendMessageToBot(s,o,i,t,e,r||"",n,c)}};l(nr,"BaseChatbotService");var ne=nr;var ar=class ar extends ne{constructor(e,t,i,o){super(e,t,"DifyService",i);a(this,"openaiService");this.openaiService=o}getBotType(){return"dify"}async sendMessageToBot(e,t,i,o,n,r,c,p){try{let u=o.apiUrl;if(!u){this.logger.error("No Dify endpoint defined");return}let d=c;if(this.isAudioMessage(c)&&p)try{this.logger.debug("[Dify] Downloading audio for Whisper transcription");let f=await this.openaiService.speechToText(p,e);f&&(d=`[audio] ${f}`)}catch(f){this.logger.error(`[Dify] Failed to transcribe audio: ${f}`)}if(o.botType==="chatBot"){u+="/chat-messages";let f={inputs:{remoteJid:n,pushName:r,instanceName:e.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:e.token},query:d,response_mode:"blocking",conversation_id:t.sessionId===n?void 0:t.sessionId,user:n};if(this.isImageMessage(c)){let S=c.split("|");if(p.message.mediaUrl||p.message.base64){let T=p.message.base64||null;if(p.message.mediaUrl&&(0,rr.isURL)(p.message.mediaUrl)){let A=await At.default.get(p.message.mediaUrl,{responseType:"arraybuffer"});T=Buffer.from(A.data).toString("base64")}T&&(f.files=[{type:"image",transfer_method:"remote_url",url:T}])}else f.files=[{type:"image",transfer_method:"remote_url",url:S[1].split("?")[0]}];f.query=S[2]||c}e.integration===J.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(n),await e.client.sendPresenceUpdate("composing",n));let g=await At.default.post(u,f,{headers:{Authorization:`Bearer ${o.apiKey}`}});e.integration===J.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",n);let y=g?.data?.answer,m=g?.data?.conversation_id;y&&await this.sendMessageWhatsApp(e,n,y,i,!0),await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{status:"opened",awaitUser:!0,sessionId:t.sessionId===n?m:t.sessionId}})}if(o.botType==="textGenerator"){u+="/completion-messages";let f={inputs:{query:d,pushName:r,remoteJid:n,instanceName:e.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:e.token},response_mode:"blocking",conversation_id:t.sessionId===n?void 0:t.sessionId,user:n};if(this.isImageMessage(c)){let S=c.split("|");if(p.message.mediaUrl||p.message.base64){let T=p.message.base64||null;if(p.message.mediaUrl&&(0,rr.isURL)(p.message.mediaUrl)){let A=await At.default.get(p.message.mediaUrl,{responseType:"arraybuffer"});T=Buffer.from(A.data).toString("base64")}T&&(f.files=[{type:"image",transfer_method:"remote_url",url:T}])}else f.files=[{type:"image",transfer_method:"remote_url",url:S[1].split("?")[0]}],f.inputs.query=S[2]||c}e.integration===J.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(n),await e.client.sendPresenceUpdate("composing",n));let g=await At.default.post(u,f,{headers:{Authorization:`Bearer ${o.apiKey}`}});e.integration===J.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",n);let y=g?.data?.answer,m=g?.data?.conversation_id;y&&await this.sendMessageWhatsApp(e,n,y,i,!0),await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{status:"opened",awaitUser:!0,sessionId:t.sessionId===n?m:t.sessionId}})}if(o.botType==="agent"){u+="/chat-messages";let f={inputs:{remoteJid:n,pushName:r,instanceName:e.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:e.token},query:d,response_mode:"streaming",conversation_id:t.sessionId===n?void 0:t.sessionId,user:n};if(this.isImageMessage(c)){let A=c.split("|");p.message.mediaUrl||p.message.base64?f.files=[{type:"image",transfer_method:"remote_url",url:p.message.mediaUrl||p.message.base64}]:(f.files=[{type:"image",transfer_method:"remote_url",url:A[1].split("?")[0]}],f.query=A[2]||c)}e.integration===J.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(n),await e.client.sendPresenceUpdate("composing",n));let g=await At.default.post(u,f,{headers:{Authorization:`Bearer ${o.apiKey}`}}),y,m="",T=g.data.replaceAll("data: ","").split(`
`).filter(A=>A.trim()!=="");for(let A of T)if(A.trim().startsWith("{")){let N=JSON.parse(A);N?.event==="agent_message"&&(console.log("event:",N),y=y??N?.conversation_id,m+=N?.answer)}e.integration===J.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",n),m&&await this.sendMessageWhatsApp(e,n,m,i,!0),await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{status:"opened",awaitUser:!0,sessionId:t.sessionId===n?y:t.sessionId}})}}catch(u){this.logger.error(u.response?.data||u);return}}};l(ar,"DifyService");var bt=ar;var Wt=x(require("axios")),up=require("baileys"),dp=require("class-validator"),hp=x(require("form-data")),mp=x(require("openai")),gp=x(require("pino"));var cr=class cr extends ne{constructor(e,t,i){super(e,t,"OpenaiService",i);a(this,"client")}getBotType(){return"openai"}initClient(e){return this.client=new mp.default({apiKey:e}),this.client}async process(e,t,i,o,n,r,c,p){try{if(this.logger.log(`Starting process for remoteJid: ${t}, bot type: ${i.botType}`),r.startsWith("audioMessage|")&&p){this.logger.log("Detected audio message, attempting to transcribe");let f=await this.prismaRepository.openaiCreds.findUnique({where:{id:i.openaiCredsId}});if(!f){this.logger.error(`OpenAI credentials not found. CredsId: ${i.openaiCredsId}`);return}this.initClient(f.apiKey);let g=await this.speechToText(p,e);if(g)this.logger.log(`Audio transcribed: ${g}`),r=g;else{this.logger.error("Failed to transcribe audio"),await this.sendMessageWhatsApp(e,t,"Sorry, I couldn't transcribe your audio message. Could you please type your message instead?",n,!0);return}}else{let f=await this.prismaRepository.openaiCreds.findUnique({where:{id:i.openaiCredsId}});if(!f){this.logger.error(`OpenAI credentials not found. CredsId: ${i.openaiCredsId}`);return}this.initClient(f.apiKey)}let u=n?.keywordFinish||"",d=r.toLowerCase().trim();if(u.length>0&&d===u.toLowerCase()){n?.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.delete({where:{id:o.id}}),await j("/openai/session/finish");return}if(!o){let f={remoteJid:t,pushName:c,botId:i.id},g=await this.createNewSession({instanceName:e.instanceName,instanceId:e.instanceId},f,this.getBotType());await this.initNewSession(e,t,i,n,g.session,r,c,p),await j("/openai/session/start");return}if(o.status==="paused"){await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"opened",awaitUser:!0}});return}await this.sendMessageToBot(e,o,n,i,t,c||"",r,p)}catch(u){this.logger.error(`Error in process: ${u.message||JSON.stringify(u)}`);return}}async sendMessageToBot(e,t,i,o,n,r,c,p){if(this.logger.log(`Sending message to bot for remoteJid: ${n}, bot type: ${o.botType}`),!this.client){this.logger.log("Client not initialized, initializing now");let u=await this.prismaRepository.openaiCreds.findUnique({where:{id:o.openaiCredsId}});if(!u){this.logger.error(`OpenAI credentials not found in sendMessageToBot. CredsId: ${o.openaiCredsId}`);return}this.initClient(u.apiKey)}try{let u;o.botType==="assistant"?(this.logger.log("Processing with Assistant API"),u=await this.processAssistantMessage(e,t,o,n,r,!1,c,p)):(this.logger.log("Processing with ChatCompletion API"),u=await this.processChatCompletionMessage(e,o,n,c,p)),this.logger.log(`Got response from OpenAI: ${u?.substring(0,50)}${u?.length>50?"...":""}`),u?(this.logger.log("Sending message to WhatsApp"),await this.sendMessageWhatsApp(e,n,u,i,!0)):this.logger.error("No message to send to WhatsApp"),await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{status:"opened",awaitUser:!0}})}catch(u){this.logger.error(`Error in sendMessageToBot: ${u.message||JSON.stringify(u)}`),u.response&&this.logger.error(`API Response data: ${JSON.stringify(u.response.data||{})}`);return}}async processAssistantMessage(e,t,i,o,n,r,c,p){let u={role:r?"assistant":"user",content:[{type:"text",text:c}]};if(this.isImageMessage(c)){let m=c.split("|");if(p.message.mediaUrl||p.message.base64){let S=p.message.base64||null;if(p.message.mediaUrl&&(0,dp.isURL)(p.message.mediaUrl)){let T=await Wt.default.get(p.message.mediaUrl,{responseType:"arraybuffer"});S=Buffer.from(T.data).toString("base64")}S&&(u.content=[{type:"text",text:m[2]||c},{type:"image_url",image_url:{url:S}}])}else{let S=m[1].split("?")[0];u.content=[{type:"text",text:m[2]||c},{type:"image_url",image_url:{url:S}}]}}let d=t.sessionId;if((!d||d===o)&&(d=(await this.client.beta.threads.create()).id,await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{sessionId:d}}),this.logger.log(`Created new thread ID: ${d} for session: ${t.id}`)),await this.client.beta.threads.messages.create(d,u),r)return j("/message/sendText"),"";let f=await this.client.beta.threads.runs.create(d,{assistant_id:i.assistantId});e.integration===J.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(o),await e.client.sendPresenceUpdate("composing",o));let g=await this.getAIResponse(d,f.id,i.functionUrl,o,n);e.integration===J.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",o);let y="I couldn't generate a proper response. Please try again.";try{let m=g?.data||[];if(m.length>0){let S=m[0]?.content||[];if(S.length>0){let T=S[0];T&&"text"in T&&T.text&&"value"in T.text&&(y=T.text.value)}}}catch(m){this.logger.error(`Error extracting response text: ${m}`)}return await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{status:"opened",awaitUser:!0,sessionId:d}}),y}async processChatCompletionMessage(e,t,i,o,n){if(this.logger.log("Starting processChatCompletionMessage"),!this.client){this.logger.log("Client not initialized in processChatCompletionMessage, initializing now");let T=await this.prismaRepository.openaiCreds.findUnique({where:{id:t.openaiCredsId}});if(!T)return this.logger.error(`OpenAI credentials not found. CredsId: ${t.openaiCredsId}`),"Error: OpenAI credentials not found";this.initClient(T.apiKey)}if(!t.model)return this.logger.error("OpenAI model not defined"),"Error: OpenAI model not configured";this.logger.log(`Using model: ${t.model}, max tokens: ${t.maxTokens||500}`);let r=await this.prismaRepository.integrationSession.findFirst({where:{remoteJid:i,botId:t.id,status:"opened"}}),c=[];if(r&&r.context)try{c=(typeof r.context=="string"?JSON.parse(r.context):r.context).history||[],this.logger.log(`Retrieved conversation history from session, ${c.length} messages`)}catch(T){this.logger.error(`Error parsing session context: ${T.message}`),c=[]}this.logger.log(`Bot data - systemMessages: ${JSON.stringify(t.systemMessages||[])}`),this.logger.log(`Bot data - assistantMessages: ${JSON.stringify(t.assistantMessages||[])}`),this.logger.log(`Bot data - userMessages: ${JSON.stringify(t.userMessages||[])}`);let u=(t.systemMessages||[]).map(T=>({role:"system",content:T})),f=(t.assistantMessages||[]).map(T=>({role:"assistant",content:T})),y=(t.userMessages||[]).map(T=>({role:"user",content:T})),m={role:"user",content:[{type:"text",text:o}]};if(this.isImageMessage(o)){this.logger.log("Found image message");let T=o.split("|");if(n.message.mediaUrl||n.message.base64)m.content=[{type:"text",text:T[2]||o},{type:"image_url",image_url:{url:n.message.base64||n.message.mediaUrl}}];else{let A=T[1].split("?")[0];m.content=[{type:"text",text:T[2]||o},{type:"image_url",image_url:{url:A}}]}}let S=[...u,...f,...y,...c,m];this.logger.log(`Final messages payload: ${JSON.stringify(S)}`),e.integration===J.WHATSAPP_BAILEYS&&(this.logger.log("Setting typing indicator"),await e.client.presenceSubscribe(i),await e.client.sendPresenceUpdate("composing",i));try{this.logger.log("Sending request to OpenAI API");let T=await this.client.chat.completions.create({model:t.model,messages:S,max_tokens:t.maxTokens||500});e.integration===J.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",i);let A=T.choices[0].message.content;return this.logger.log(`Received response from OpenAI: ${JSON.stringify(T.choices[0])}`),c.push(m),c.push({role:"assistant",content:A}),c.length>10&&(c=c.slice(c.length-10)),r&&(await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{context:JSON.stringify({history:c})}}),this.logger.log(`Updated session with conversation history, now ${c.length} messages`)),A}catch(T){return this.logger.error(`Error calling OpenAI: ${T.message||JSON.stringify(T)}`),T.response&&(this.logger.error(`API Response status: ${T.response.status}`),this.logger.error(`API Response data: ${JSON.stringify(T.response.data||{})}`)),`Sorry, there was an error: ${T.message||"Unknown error"}`}}async getAIResponse(e,t,i,o,n){let r=await this.client.beta.threads.runs.retrieve(e,t),c=60,p=1e3;for(;r.status!=="completed"&&r.status!=="failed"&&r.status!=="cancelled"&&r.status!=="expired"&&c>0;){if(await new Promise(u=>setTimeout(u,p)),r=await this.client.beta.threads.runs.retrieve(e,t),r.status==="requires_action"&&r.required_action?.type==="submit_tool_outputs"){let u=r.required_action.submit_tool_outputs.tool_calls,d=[];for(let f of u)if(i)try{let g=JSON.parse(f.function.arguments);g.remoteJid=o,g.pushName=n;let y=await Wt.default.post(i,{functionName:f.function.name,functionArguments:g});d.push({tool_call_id:f.id,output:JSON.stringify(y.data)})}catch(g){this.logger.error(`Error calling function: ${g}`),d.push({tool_call_id:f.id,output:JSON.stringify({error:"Function call failed"})})}else d.push({tool_call_id:f.id,output:JSON.stringify({error:"No function URL configured"})});await this.client.beta.threads.runs.submitToolOutputs(e,t,{tool_outputs:d})}c--}return r.status==="completed"?await this.client.beta.threads.messages.list(e):(this.logger.error(`Assistant run failed with status: ${r.status}`),{data:[{content:[{text:{value:"Failed to get a response from the assistant."}}]}]})}isImageMessage(e){return e.includes("imageMessage")}async speechToText(e,t){let i=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:t.instanceId}});if(!i)return this.logger.error(`OpenAI settings not found. InstanceId: ${t.instanceId}`),null;let o=await this.prismaRepository.openaiCreds.findUnique({where:{id:i.openaiCredsId}});if(!o)return this.logger.error(`OpenAI credentials not found. CredsId: ${i.openaiCredsId}`),null;let n;e.message.mediaUrl?n=await Wt.default.get(e.message.mediaUrl,{responseType:"arraybuffer"}).then(d=>Buffer.from(d.data,"binary")):e.message.base64?n=Buffer.from(e.message.base64,"base64"):n=await(0,up.downloadMediaMessage)({key:e.key,message:e?.message},"buffer",{},{logger:(0,gp.default)({level:"error"}),reuploadRequest:t});let r=this.configService.get("LANGUAGE").includes("pt")?"pt":this.configService.get("LANGUAGE"),c=new hp.default;c.append("file",n,"audio.ogg"),c.append("model","whisper-1"),c.append("language",r);let p=o?.apiKey||this.configService.get("OPENAI").API_KEY_GLOBAL;return(await Wt.default.post("https://api.openai.com/v1/audio/transcriptions",c,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${p}`}}))?.data?.text}};l(cr,"OpenaiService");var It=cr;var em=l(h=>{let s;b.get("S3").ENABLE&&(b.get("S3").SAVE_VIDEO||h?.message?.videoMessage===void 0&&h?.message?.viewOnceMessageV2?.message?.videoMessage===void 0)?s=h.message?.mediaUrl:s=h.key?.id;let e={conversation:h?.message?.conversation,extendedTextMessage:h?.message?.extendedTextMessage?.text,contactMessage:h?.message?.contactMessage?.displayName,locationMessage:h?.message?.locationMessage?.degreesLatitude.toString(),viewOnceMessageV2:h?.message?.viewOnceMessageV2?.message?.imageMessage?.url||h?.message?.viewOnceMessageV2?.message?.videoMessage?.url||h?.message?.viewOnceMessageV2?.message?.audioMessage?.url,listResponseMessage:h?.message?.listResponseMessage?.title||h?.listResponseMessage?.title,responseRowId:h?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,templateButtonReplyMessage:h?.message?.templateButtonReplyMessage?.selectedId||h?.message?.buttonsResponseMessage?.selectedButtonId,audioMessage:h?.message?.speechToText?h?.message?.speechToText:h?.message?.audioMessage?`audioMessage|${s}`:void 0,imageMessage:h?.message?.imageMessage?`imageMessage|${s}${h?.message?.imageMessage?.caption?`|${h?.message?.imageMessage?.caption}`:""}`:void 0,videoMessage:h?.message?.videoMessage?`videoMessage|${s}${h?.message?.videoMessage?.caption?`|${h?.message?.videoMessage?.caption}`:""}`:void 0,documentMessage:h?.message?.documentMessage?`documentMessage|${s}${h?.message?.documentMessage?.caption?`|${h?.message?.documentMessage?.caption}`:""}`:void 0,documentWithCaptionMessage:h?.message?.documentWithCaptionMessage?.message?.documentMessage?`documentWithCaptionMessage|${s}${h?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption?`|${h?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption}`:""}`:void 0,externalAdReplyBody:h?.contextInfo?.externalAdReply?.body?`externalAdReplyBody|${h.contextInfo.externalAdReply.body}`:void 0},t=Object.keys(e).find(i=>e[i]!==void 0)||"unknown";return{...e,messageType:t}},"getTypeMessage"),tm=l(h=>{let s=Object.keys(h).find(t=>t!=="externalAdReplyBody"&&h[t]!==void 0),e=s?h[s]:void 0;return h.externalAdReplyBody&&(e=e?`${e}
${h.externalAdReplyBody}`:h.externalAdReplyBody),e},"getMessageContent"),Ls=l(h=>{let s=em(h);return tm(s)},"getConversationMessage");var Jt=x(require("axios"));var lr=class lr extends ne{constructor(e,t,i,o){super(e,i,"TypebotService",t);a(this,"openaiService");this.openaiService=o}getBotType(){return"typebot"}async sendMessageToBot(e,t,i,o,n,r,c,p){await this.processTypebot(e,n,p,t,o,o.url,i.expire,o.typebot,i.keywordFinish,i.delayMessage,i.unknownMessage,i.listeningFromMe,i.stopBotFromMe,i.keepOpen,c)}async processTypebotSimple(e,t,i,o,n,r,c,p){return this.process(e,t,i,o,n,r,c,p)}async createNewSession(e,t){if(t.remoteJid==="status@broadcast")return;let i=Math.floor(Math.random()*1e10).toString();try{let o=this.configService.get("TYPEBOT").API_VERSION,n,r;o==="latest"?(n=`${t.url}/api/v1/typebots/${t.typebot}/startChat`,r={prefilledVariables:{...t.prefilledVariables,remoteJid:t.remoteJid,pushName:t.pushName||t.prefilledVariables?.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number}}):(n=`${t.url}/api/v1/sendMessage`,r={startParams:{publicId:t.typebot,prefilledVariables:{...t.prefilledVariables,remoteJid:t.remoteJid,pushName:t.pushName||t.prefilledVariables?.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number}}});let c=await Jt.default.post(n,r),p=null;c?.data?.sessionId&&(p=await this.prismaRepository.integrationSession.create({data:{remoteJid:t.remoteJid,pushName:t.pushName||"",sessionId:`${i}-${c.data.sessionId}`,status:"opened",parameters:{...t.prefilledVariables,remoteJid:t.remoteJid,pushName:t.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number},awaitUser:!1,botId:t.botId,type:"typebot",Instance:{connect:{id:e.id}}}}));let u={remoteJid:t.remoteJid,status:"opened",session:p};return this.waMonitor.waInstances[e.name].sendDataWebhook(R.TYPEBOT_CHANGE_STATUS,u),{...c.data,session:p}}catch(o){this.logger.error(o);return}}async sendWAMessage(e,t,i,o,n,r,c){let p=this.waMonitor.waInstances[e.name];await this.processMessages(p,t,i,n,r,c,this.applyFormatting.bind(this),this.prismaRepository).catch(u=>{console.error("Erro ao processar mensagens:",u)})}applyFormatting(e){let t="";if(e.text&&(t+=e.text),e.children&&e.type!=="a")for(let n of e.children)t+=this.applyFormatting(n);e.type==="p"&&e.type!=="inline-variable"&&(t=t.trim()+`
`),e.type==="inline-variable"&&(t=t.trim()),e.type==="ol"&&(t=`
`+t.split(`
`).map((n,r)=>n?`${r+1}. ${n}`:"").join(`
`)),e.type==="li"&&(t=t.split(`
`).map(n=>n?`  ${n}`:"").join(`
`));let i="";e.bold&&(i+="*"),e.italic&&(i+="_"),e.underline&&(i+="~");let o=`${i}${t}${i.split("").reverse().join("")}`;return e.url&&(o=e.children[0]?.text?`[${o}]
(${e.url})`:`${e.url}`),o}async processMessages(e,t,i,o,n,r,c,p){let u=l((d,f)=>{if(!d)return null;for(let g of d)if(g.lastBubbleBlockId===f)return g.wait?.secondsToWaitFor;return null},"findItemAndGetSecondsToWait");for(let d of o){if(d.type==="text"){let g="";for(let y of d.content.richText){for(let m of y.children)g+=c(m);g+=`
`}g=g.replace(/\*\*/g,"").replace(/__/,"").replace(/~~/,"").replace(/\n$/,""),g=g.replace(/\n$/,""),g.includes("[list]")?await this.processListMessage(e,g,t.remoteJid):g.includes("[buttons]")?await this.processButtonMessage(e,g,t.remoteJid):await this.sendMessageWhatsApp(e,t.remoteJid,g,i,!0),j("/message/sendText")}d.type==="image"&&(await e.mediaMessage({number:t.remoteJid,delay:i?.delayMessage||1e3,mediatype:"image",media:d.content.url},null,!1),j("/message/sendMedia")),d.type==="video"&&(await e.mediaMessage({number:t.remoteJid,delay:i?.delayMessage||1e3,mediatype:"video",media:d.content.url},null,!1),j("/message/sendMedia")),d.type==="audio"&&(await e.audioWhatsapp({number:t.remoteJid,delay:i?.delayMessage||1e3,encoding:!0,audio:d.content.url},!1),j("/message/sendWhatsAppAudio"));let f=u(r,d.id);f&&await new Promise(g=>setTimeout(g,f*1e3))}if(n){if(n.type==="choice input"){let d="",f=n.items;for(let g of f)d+=`\u25B6\uFE0F ${g.content}
`;d=d.replace(/\n$/,""),d.includes("[list]")?await this.processListMessage(e,d,t.remoteJid):d.includes("[buttons]")?await this.processButtonMessage(e,d,t.remoteJid):await this.sendMessageWhatsApp(e,t.remoteJid,d,i,!0),j("/message/sendText")}await p.integrationSession.update({where:{id:t.id},data:{awaitUser:!0}})}else{let d="closed";i?.keepOpen?await p.integrationSession.update({where:{id:t.id},data:{status:"closed"}}):(await p.integrationSession.deleteMany({where:{id:t.id}}),d="delete");let f={remoteJid:t.remoteJid,status:d,session:t};e.sendDataWebhook(R.TYPEBOT_CHANGE_STATUS,f)}}async processListMessage(e,t,i){let o={number:i,title:"",description:"",buttonText:"",footerText:"",sections:[]},n=t.match(/\[title\]([\s\S]*?)(?=\[description\])/),r=t.match(/\[description\]([\s\S]*?)(?=\[buttonText\])/),c=t.match(/\[buttonText\]([\s\S]*?)(?=\[footerText\])/),p=t.match(/\[footerText\]([\s\S]*?)(?=\[menu\])/);n&&(o.title=n[1].trim()),r&&(o.description=r[1].trim()),c&&(o.buttonText=c[1].trim()),p&&(o.footerText=p[1].trim());let u=t.match(/\[menu\]([\s\S]*?)\[\/menu\]/)?.[1];if(u){let d=u.match(/\[section\]([\s\S]*?)(?=\[section\]|\[\/section\]|\[\/menu\])/g);d&&d.forEach(f=>{let g=f.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),y=f.match(/\[row\]([\s\S]*?)(?=\[row\]|\[\/row\]|\[\/section\]|\[\/menu\])/g),m={title:g,rows:y?.map(S=>({title:S.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),description:S.match(/description: (.*?)(?:\n|$)/)?.[1]?.trim(),rowId:S.match(/rowId: (.*?)(?:\n|$)/)?.[1]?.trim()}))||[]};o.sections.push(m)})}await e.listMessage(o)}async processButtonMessage(e,t,i){let o={number:i,thumbnailUrl:void 0,title:"",description:"",footer:"",buttons:[]},n=t.match(/\[thumbnailUrl\]([\s\S]*?)(?=\[title\])/),r=t.match(/\[title\]([\s\S]*?)(?=\[description\])/),c=t.match(/\[description\]([\s\S]*?)(?=\[footer\])/),p=t.match(/\[footer\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url))/);r&&(o.title=r[1].trim()),n&&(o.thumbnailUrl=n[1].trim()),c&&(o.description=c[1].trim()),p&&(o.footer=p[1].trim());let u={reply:/\[reply\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,pix:/\[pix\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,copy:/\[copy\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,call:/\[call\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,url:/\[url\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g};for(let[d,f]of Object.entries(u)){let g;for(;(g=f.exec(t))!==null;){let y=g[1].trim(),m={type:d};switch(d){case"pix":m.currency=y.match(/currency: (.*?)(?:\n|$)/)?.[1]?.trim(),m.name=y.match(/name: (.*?)(?:\n|$)/)?.[1]?.trim(),m.keyType=y.match(/keyType: (.*?)(?:\n|$)/)?.[1]?.trim(),m.key=y.match(/key: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"reply":m.displayText=y.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),m.id=y.match(/id: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"copy":m.displayText=y.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),m.copyCode=y.match(/copyCode: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"call":m.displayText=y.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),m.phoneNumber=y.match(/phone: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"url":m.displayText=y.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),m.url=y.match(/url: (.*?)(?:\n|$)/)?.[1]?.trim();break}Object.keys(m).length>1&&o.buttons.push(m)}}await e.buttonMessage(o)}async processTypebot(e,t,i,o,n,r,c,p,u,d,f,g,y,m,S,T){let A=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}});if(!A){this.logger.error("Instance not found in database");return}if(o&&c&&c>0){let v=Date.now(),L=new Date(o.updatedAt).getTime(),B=v-L;if(Math.floor(B/1e3/60)>c){m?await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:n.id,remoteJid:t}});let q=await this.createNewSession(A,{enabled:n?.enabled,url:r,typebot:p,expire:c,keywordFinish:u,delayMessage:d,unknownMessage:f,listeningFromMe:g,remoteJid:t,pushName:i.pushName,botId:n.id,prefilledVariables:T});if(q?.session&&(o=q.session),!q?.messages||q.messages.length===0){let X=Ls(i.message);if(!X){f&&(await this.sendMessageWhatsApp(e,t,f,{delayMessage:d,expire:c,keywordFinish:u,listeningFromMe:g,stopBotFromMe:y,keepOpen:m,unknownMessage:f},!0),j("/message/sendText"));return}if(u&&X.toLowerCase()===u.toLowerCase()){let te="closed";m?await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"closed"}}):(te="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:n.id,remoteJid:t}}));let z={remoteJid:t,status:te,session:o};e.sendDataWebhook(R.TYPEBOT_CHANGE_STATUS,z);return}try{let te=this.configService.get("TYPEBOT").API_VERSION,z,fe;te==="latest"?(z=`${r}/api/v1/sessions/${q?.sessionId}/continueChat`,fe={message:X}):(z=`${r}/api/v1/sendMessage`,fe={message:X,sessionId:q?.sessionId});let gt=await Jt.default.post(z,fe);await this.sendWAMessage(A,o,{expire:c,keywordFinish:u,delayMessage:d,unknownMessage:f,listeningFromMe:g,stopBotFromMe:y,keepOpen:m},t,gt?.data?.messages,gt?.data?.input,gt?.data?.clientSideActions)}catch(te){this.logger.error(te);return}}q?.messages&&q.messages.length>0&&await this.sendWAMessage(A,o,{expire:c,keywordFinish:u,delayMessage:d,unknownMessage:f,listeningFromMe:g,stopBotFromMe:y,keepOpen:m},t,q.messages,q.input,q.clientSideActions);return}}if(o&&o.status!=="opened")return;if(!o){let v=await this.createNewSession(A,{enabled:n?.enabled,url:r,typebot:p,expire:c,keywordFinish:u,delayMessage:d,unknownMessage:f,listeningFromMe:g,remoteJid:t,pushName:i?.pushName,botId:n.id,prefilledVariables:T});if(v?.session&&(o=v.session),v?.messages&&v.messages.length>0&&await this.sendWAMessage(A,o,{expire:c,keywordFinish:u,delayMessage:d,unknownMessage:f,listeningFromMe:g,stopBotFromMe:y,keepOpen:m},t,v.messages,v.input,v.clientSideActions),!v?.messages||v.messages.length===0){if(!S){f&&(await this.sendMessageWhatsApp(e,t,f,{delayMessage:d,expire:c,keywordFinish:u,listeningFromMe:g,stopBotFromMe:y,keepOpen:m,unknownMessage:f},!0),j("/message/sendText"));return}if(u&&S.toLowerCase()===u.toLowerCase()){let B="closed";m?await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"closed"}}):(B="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:n.id,remoteJid:t}}));let W={remoteJid:t,status:B,session:o};e.sendDataWebhook(R.TYPEBOT_CHANGE_STATUS,W);return}let L;try{let B=this.configService.get("TYPEBOT").API_VERSION,W,q;B==="latest"?(W=`${r}/api/v1/sessions/${v?.sessionId}/continueChat`,q={message:S}):(W=`${r}/api/v1/sendMessage`,q={message:S,sessionId:v?.sessionId}),L=await Jt.default.post(W,q),await this.sendWAMessage(A,o,{expire:c,keywordFinish:u,delayMessage:d,unknownMessage:f,listeningFromMe:g,stopBotFromMe:y,keepOpen:m},t,L?.data?.messages,L?.data?.input,L?.data?.clientSideActions)}catch(B){this.logger.error(B);return}}return}if(await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"opened",awaitUser:!1}}),!S){f&&(await this.sendMessageWhatsApp(e,t,f,{delayMessage:d,expire:c,keywordFinish:u,listeningFromMe:g,stopBotFromMe:y,keepOpen:m,unknownMessage:f},!0),j("/message/sendText"));return}if(u&&S.toLowerCase()===u.toLowerCase()){let v="closed";m?await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"closed"}}):(v="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:n.id,remoteJid:t}}));let L={remoteJid:t,status:v,session:o};e.sendDataWebhook(R.TYPEBOT_CHANGE_STATUS,L);return}let N=this.configService.get("TYPEBOT").API_VERSION,I,C;if(N==="latest"?(I=`${r}/api/v1/sessions/${o.sessionId.split("-")[1]}/continueChat`,C={message:S}):(I=`${r}/api/v1/sendMessage`,C={message:S,sessionId:o.sessionId.split("-")[1]}),this.isAudioMessage(S)&&i)try{this.logger.debug("[TypeBot] Downloading audio for Whisper transcription");let v=await this.openaiService.speechToText(i,A);v&&(C.message=`[audio] ${v}`)}catch(v){this.logger.error(`[TypeBot] Failed to transcribe audio: ${v}`)}let M=await Jt.default.post(I,C);await this.sendWAMessage(A,o,{expire:c,keywordFinish:u,delayMessage:d,unknownMessage:f,listeningFromMe:g,stopBotFromMe:y,keepOpen:m},t,M?.data?.messages,M?.data?.input,M?.data?.clientSideActions)}};l(lr,"TypebotService");var Ct=lr;var Je=require("@prisma/client");function sm(h){let s=h.substring(0,2);return(Number(s)===52||Number(s)===54)&&h.length===13?s+h.substring(3):h}l(sm,"formatMXOrARNumber");function im(h){let s=new RegExp(/^(\d{2})(\d{2})\d{1}(\d{8})$/);if(s.test(h)){let e=s.exec(h);if(e&&e[1]==="55"){let t=Number.parseInt(e[3][0]),i=Number.parseInt(e[2]);return t<7||i<31?e[0]:e[1]+e[2]+e[3]}return h}else return h}l(im,"formatBRNumber");function K(h){return h=h.replace(/:\d+/,""),h.includes("@g.us")||h.includes("@s.whatsapp.net")||h.includes("@lid")||h.includes("@broadcast")?h:(h=h?.replace(/\s/g,"").replace(/\+/g,"").replace(/\(/g,"").replace(/\)/g,"").split(":")[0].split("@")[0],h.includes("-")&&h.length>=24?(h=h.replace(/[^\d-]/g,""),`${h}@g.us`):(h=h.replace(/\D/g,""),h.length>=18?(h=h.replace(/[^\d-]/g,""),`${h}@g.us`):(h=sm(h),h=im(h),`${h}@s.whatsapp.net`)))}l(K,"createJid");var fp=require("class-validator"),pr=require("uuid");var Bs=class Bs{constructor(s,e,t,i){a(this,"configService");a(this,"eventEmitter");a(this,"prismaRepository");a(this,"chatwootCache");a(this,"logger",new O("ChannelStartupService"));a(this,"client");a(this,"instance",{});a(this,"localChatwoot",{});a(this,"localProxy",{});a(this,"localSettings",{});a(this,"localWebhook",{});a(this,"chatwootService",new lt(U,this.configService,this.prismaRepository,this.chatwootCache));a(this,"openaiService",new It(U,this.prismaRepository,this.configService));a(this,"typebotService",new Ct(U,this.configService,this.prismaRepository,this.openaiService));a(this,"difyService",new bt(U,this.prismaRepository,this.configService,this.openaiService));this.configService=s,this.eventEmitter=e,this.prismaRepository=t,this.chatwootCache=i}setInstance(s){this.logger.setInstance(s.instanceName),this.instance.name=s.instanceName,this.instance.id=s.instanceId,this.instance.integration=s.integration,this.instance.number=s.number,this.instance.token=s.token,this.instance.businessId=s.businessId,this.instance.ownerJid=s.ownerJid,this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp(R.STATUS_INSTANCE,{instanceName:this.instance.name},{instance:this.instance.name,status:"created"})}set instanceName(s){if(this.logger.setInstance(s),!s){this.instance.name=(0,pr.v4)();return}this.instance.name=s}get instanceName(){return this.instance.name}set instanceId(s){if(!s){this.instance.id=(0,pr.v4)();return}this.instance.id=s}get instanceId(){return this.instance.id}set integration(s){this.instance.integration=s}get integration(){return this.instance.integration}set number(s){this.instance.number=s}get number(){return this.instance.number}set token(s){this.instance.token=s}get token(){return this.instance.token}get wuid(){return this.instance.wuid}async loadWebhook(){let s=await this.prismaRepository.webhook.findUnique({where:{instanceId:this.instanceId}});this.localWebhook.enabled=s?.enabled,this.localWebhook.webhookBase64=s?.webhookBase64}async loadSettings(){let s=await this.prismaRepository.setting.findUnique({where:{instanceId:this.instanceId}});this.localSettings.rejectCall=s?.rejectCall,this.localSettings.msgCall=s?.msgCall,this.localSettings.groupsIgnore=s?.groupsIgnore,this.localSettings.alwaysOnline=s?.alwaysOnline,this.localSettings.readMessages=s?.readMessages,this.localSettings.readStatus=s?.readStatus,this.localSettings.syncFullHistory=s?.syncFullHistory,this.localSettings.wavoipToken=s?.wavoipToken}async setSettings(s){await this.prismaRepository.setting.upsert({where:{instanceId:this.instanceId},update:{rejectCall:s.rejectCall,msgCall:s.msgCall,groupsIgnore:s.groupsIgnore,alwaysOnline:s.alwaysOnline,readMessages:s.readMessages,readStatus:s.readStatus,syncFullHistory:s.syncFullHistory,wavoipToken:s.wavoipToken},create:{rejectCall:s.rejectCall,msgCall:s.msgCall,groupsIgnore:s.groupsIgnore,alwaysOnline:s.alwaysOnline,readMessages:s.readMessages,readStatus:s.readStatus,syncFullHistory:s.syncFullHistory,wavoipToken:s.wavoipToken,instanceId:this.instanceId}}),this.localSettings.rejectCall=s?.rejectCall,this.localSettings.msgCall=s?.msgCall,this.localSettings.groupsIgnore=s?.groupsIgnore,this.localSettings.alwaysOnline=s?.alwaysOnline,this.localSettings.readMessages=s?.readMessages,this.localSettings.readStatus=s?.readStatus,this.localSettings.syncFullHistory=s?.syncFullHistory,this.localSettings.wavoipToken=s?.wavoipToken,this.localSettings.wavoipToken&&this.localSettings.wavoipToken.length>0&&(this.client.ws.close(),this.client.ws.connect())}async findSettings(){let s=await this.prismaRepository.setting.findUnique({where:{instanceId:this.instanceId}});return s?{rejectCall:s.rejectCall,msgCall:s.msgCall,groupsIgnore:s.groupsIgnore,alwaysOnline:s.alwaysOnline,readMessages:s.readMessages,readStatus:s.readStatus,syncFullHistory:s.syncFullHistory,wavoipToken:s.wavoipToken}:null}async loadChatwoot(){if(!this.configService.get("CHATWOOT").ENABLED)return;let s=await this.prismaRepository.chatwoot.findUnique({where:{instanceId:this.instanceId}});this.localChatwoot.enabled=s?.enabled,this.localChatwoot.accountId=s?.accountId,this.localChatwoot.token=s?.token,this.localChatwoot.url=s?.url,this.localChatwoot.nameInbox=s?.nameInbox,this.localChatwoot.signMsg=s?.signMsg,this.localChatwoot.signDelimiter=s?.signDelimiter,this.localChatwoot.number=s?.number,this.localChatwoot.reopenConversation=s?.reopenConversation,this.localChatwoot.conversationPending=s?.conversationPending,this.localChatwoot.mergeBrazilContacts=s?.mergeBrazilContacts,this.localChatwoot.importContacts=s?.importContacts,this.localChatwoot.importMessages=s?.importMessages,this.localChatwoot.daysLimitImportMessages=s?.daysLimitImportMessages}async setChatwoot(s){if(!this.configService.get("CHATWOOT").ENABLED)return;if(await this.prismaRepository.chatwoot.findUnique({where:{instanceId:this.instanceId}})){await this.prismaRepository.chatwoot.update({where:{instanceId:this.instanceId},data:{enabled:s?.enabled,accountId:s.accountId,token:s.token,url:s.url,nameInbox:s.nameInbox,signMsg:s.signMsg,signDelimiter:s.signMsg?s.signDelimiter:null,number:s.number,reopenConversation:s.reopenConversation,conversationPending:s.conversationPending,mergeBrazilContacts:s.mergeBrazilContacts,importContacts:s.importContacts,importMessages:s.importMessages,daysLimitImportMessages:s.daysLimitImportMessages,organization:s.organization,logo:s.logo,ignoreJids:s.ignoreJids}}),Object.assign(this.localChatwoot,{...s,signDelimiter:s.signMsg?s.signDelimiter:null}),this.clearCacheChatwoot();return}await this.prismaRepository.chatwoot.create({data:{enabled:s?.enabled,accountId:s.accountId,token:s.token,url:s.url,nameInbox:s.nameInbox,signMsg:s.signMsg,number:s.number,reopenConversation:s.reopenConversation,conversationPending:s.conversationPending,mergeBrazilContacts:s.mergeBrazilContacts,importContacts:s.importContacts,importMessages:s.importMessages,daysLimitImportMessages:s.daysLimitImportMessages,organization:s.organization,logo:s.logo,ignoreJids:s.ignoreJids,instanceId:this.instanceId}}),Object.assign(this.localChatwoot,{...s,signDelimiter:s.signMsg?s.signDelimiter:null}),this.clearCacheChatwoot()}async findChatwoot(){if(!this.configService.get("CHATWOOT").ENABLED)return null;let s=await this.prismaRepository.chatwoot.findUnique({where:{instanceId:this.instanceId}});if(!s)return null;let e=Array.isArray(s.ignoreJids)?s.ignoreJids.map(t=>String(t)):[];return{enabled:s?.enabled,accountId:s.accountId,token:s.token,url:s.url,nameInbox:s.nameInbox,signMsg:s.signMsg,signDelimiter:s.signDelimiter||null,reopenConversation:s.reopenConversation,conversationPending:s.conversationPending,mergeBrazilContacts:s.mergeBrazilContacts,importContacts:s.importContacts,importMessages:s.importMessages,daysLimitImportMessages:s.daysLimitImportMessages,organization:s.organization,logo:s.logo,ignoreJids:e}}clearCacheChatwoot(){this.localChatwoot?.enabled&&this.chatwootService.getCache()?.deleteAll(this.instanceName)}async loadProxy(){this.localProxy.enabled=!1;let s=this.configService.get("PROXY");s.HOST&&(this.localProxy.enabled=!0,this.localProxy.host=s.HOST,this.localProxy.port=s.PORT||"80",this.localProxy.protocol=s.PROTOCOL||"http",this.localProxy.username=s.USERNAME,this.localProxy.password=s.PASSWORD);let e=await this.prismaRepository.proxy.findUnique({where:{instanceId:this.instanceId}});e?.enabled&&(this.localProxy.enabled=!0,this.localProxy.host=e?.host,this.localProxy.port=e?.port,this.localProxy.protocol=e?.protocol,this.localProxy.username=e?.username,this.localProxy.password=e?.password)}async setProxy(s){await this.prismaRepository.proxy.upsert({where:{instanceId:this.instanceId},update:{enabled:s?.enabled,host:s.host,port:s.port,protocol:s.protocol,username:s.username,password:s.password},create:{enabled:s?.enabled,host:s.host,port:s.port,protocol:s.protocol,username:s.username,password:s.password,instanceId:this.instanceId}}),Object.assign(this.localProxy,s)}async findProxy(){let s=await this.prismaRepository.proxy.findUnique({where:{instanceId:this.instanceId}});if(!s)throw new G("Proxy not found");return s}async sendDataWebhook(s,e,t=!0,i,o){let n=this.configService.get("SERVER").URL,r=new Date().getTimezoneOffset()*6e4,p=new Date(Date.now()-r).toISOString(),u=this.configService.get("AUTHENTICATION").EXPOSE_IN_FETCH_INSTANCES,d=this.token||"Apikey not found";await H.emit({instanceName:this.instance.name,origin:Bs.name,event:s,data:e,serverUrl:n,dateTime:p,sender:this.wuid,apiKey:u&&d?d:null,local:t,integration:i,extra:o})}formatMXOrARNumber(s){let e=s.substring(0,2);return(Number(e)===52||Number(e)===54)&&s.length===13?e+s.substring(3):s}formatBRNumber(s){let e=new RegExp(/^(\d{2})(\d{2})\d{1}(\d{8})$/);if(e.test(s)){let t=e.exec(s);if(t&&t[1]==="55"){let i=Number.parseInt(t[3][0]),o=Number.parseInt(t[2]);return i<7||o<31?t[0]:t[1]+t[2]+t[3]}return s}else return s}async fetchContacts(s){let e={instanceId:this.instanceId};if(s?.where?.remoteJid){let o=s.where.remoteJid.includes("@")?s.where.remoteJid:K(s.where.remoteJid);e.remoteJid=o}s?.where?.id&&(e.id=s.where.id),s?.where?.pushName&&(e.pushName=s.where.pushName);let t={where:e};if(s.offset&&(t.take=s.offset),s.page){let o=Math.max(s.page,1);t.skip=s.offset*(o-1)}return(await this.prismaRepository.contact.findMany(t)).map(o=>{let r=o.remoteJid.endsWith("@g.us"),c=!!o.pushName||!!o.profilePicUrl;return{...o,isGroup:r,isSaved:c,type:r?"group":c?"contact":"group_member"}})}cleanMessageData(s){if(!s)return s;let e={...s};if(e.message){let{mediaUrl:t}=e.message;delete e.message.base64,e.message.imageMessage&&(e.message.imageMessage={caption:e.message.imageMessage.caption}),e.message.videoMessage&&(e.message.videoMessage={caption:e.message.videoMessage.caption}),e.message.audioMessage&&(e.message.audioMessage={seconds:e.message.audioMessage.seconds}),e.message.stickerMessage&&(e.message.stickerMessage={}),e.message.documentMessage&&(e.message.documentMessage={caption:e.message.documentMessage.caption,name:e.message.documentMessage.name}),e.message.documentWithCaptionMessage&&(e.message.documentWithCaptionMessage={caption:e.message.documentWithCaptionMessage.caption,name:e.message.documentWithCaptionMessage.name}),t&&(e.message.mediaUrl=t)}return e}async fetchMessages(s){let e=s?.where?.key,t={};s?.where?.messageTimestamp&&s.where.messageTimestamp.gte&&s.where.messageTimestamp.lte&&(t.messageTimestamp={gte:Math.floor(new Date(s.where.messageTimestamp.gte).getTime()/1e3),lte:Math.floor(new Date(s.where.messageTimestamp.lte).getTime()/1e3)});let i=await this.prismaRepository.message.count({where:{instanceId:this.instanceId,id:s?.where?.id,source:s?.where?.source,messageType:s?.where?.messageType,...t,AND:[e?.id?{key:{path:["id"],equals:e?.id}}:{},e?.fromMe?{key:{path:["fromMe"],equals:e?.fromMe}}:{},e?.remoteJid?{key:{path:["remoteJid"],equals:e?.remoteJid}}:{},e?.participants?{key:{path:["participants"],equals:e?.participants}}:{}]}});s?.offset||(s.offset=50),s?.page||(s.page=1);let o=await this.prismaRepository.message.findMany({where:{instanceId:this.instanceId,id:s?.where?.id,source:s?.where?.source,messageType:s?.where?.messageType,...t,AND:[e?.id?{key:{path:["id"],equals:e?.id}}:{},e?.fromMe?{key:{path:["fromMe"],equals:e?.fromMe}}:{},e?.remoteJid?{key:{path:["remoteJid"],equals:e?.remoteJid}}:{},e?.participants?{key:{path:["participants"],equals:e?.participants}}:{}]},orderBy:{messageTimestamp:"desc"},skip:s.offset*(s?.page===1?0:s?.page-1),take:s.offset,select:{id:!0,key:!0,pushName:!0,messageType:!0,message:!0,messageTimestamp:!0,instanceId:!0,source:!0,contextInfo:!0,MessageUpdate:{select:{status:!0}}}});return{messages:{total:i,pages:Math.ceil(i/s.offset),currentPage:s.page,records:o}}}async fetchStatusMessage(s){return s?.offset||(s.offset=50),s?.page||(s.page=1),await this.prismaRepository.messageUpdate.findMany({where:{instanceId:this.instanceId,remoteJid:s.where?.remoteJid,keyId:s.where?.id},skip:s.offset*(s?.page===1?0:s?.page-1),take:s.offset})}async findChatByRemoteJid(s){return s?await this.prismaRepository.chat.findFirst({where:{instanceId:this.instanceId,remoteJid:s}}):null}async fetchChats(s){let e=s?.where?.remoteJid?s?.where?.remoteJid.includes("@")?s.where?.remoteJid:K(s.where?.remoteJid):null,t={instanceId:this.instanceId};e&&(t.remoteJid=e);let i=s?.where?.messageTimestamp?.gte&&s?.where?.messageTimestamp?.lte?Je.Prisma.sql`
        AND "Message"."messageTimestamp" >= ${Math.floor(new Date(s.where.messageTimestamp.gte).getTime()/1e3)}
        AND "Message"."messageTimestamp" <= ${Math.floor(new Date(s.where.messageTimestamp.lte).getTime()/1e3)}`:Je.Prisma.sql``,o=s?.take?Je.Prisma.sql`LIMIT ${s.take}`:Je.Prisma.sql``,n=s?.skip?Je.Prisma.sql`OFFSET ${s.skip}`:Je.Prisma.sql``,r=await this.prismaRepository.$queryRaw`
      WITH rankedMessages AS (
        SELECT DISTINCT ON ("Message"."key"->>'remoteJid') 
          "Contact"."id" as "contactId",
          "Message"."key"->>'remoteJid' as "remoteJid",
          CASE 
            WHEN "Message"."key"->>'remoteJid' LIKE '%@g.us' THEN COALESCE("Chat"."name", "Contact"."pushName")
            ELSE COALESCE("Contact"."pushName", "Message"."pushName")
          END as "pushName",
          "Contact"."profilePicUrl",
          COALESCE(
            to_timestamp("Message"."messageTimestamp"::double precision), 
            "Contact"."updatedAt"
          ) as "updatedAt",
          "Chat"."name" as "pushName",
          "Chat"."createdAt" as "windowStart",
          "Chat"."createdAt" + INTERVAL '24 hours' as "windowExpires",
          "Chat"."unreadMessages" as "unreadMessages",
          CASE WHEN "Chat"."createdAt" + INTERVAL '24 hours' > NOW() THEN true ELSE false END as "windowActive",
          "Message"."id" AS "lastMessageId",
          "Message"."key" AS "lastMessage_key",
          CASE
            WHEN "Message"."key"->>'fromMe' = 'true' THEN 'Voc'
            ELSE "Message"."pushName"
          END AS "lastMessagePushName",
          "Message"."participant" AS "lastMessageParticipant",
          "Message"."messageType" AS "lastMessageMessageType",
          "Message"."message" AS "lastMessageMessage",
          "Message"."contextInfo" AS "lastMessageContextInfo",
          "Message"."source" AS "lastMessageSource",
          "Message"."messageTimestamp" AS "lastMessageMessageTimestamp",
          "Message"."instanceId" AS "lastMessageInstanceId",
          "Message"."sessionId" AS "lastMessageSessionId",
          "Message"."status" AS "lastMessageStatus"
        FROM "Message"
        LEFT JOIN "Contact" ON "Contact"."remoteJid" = "Message"."key"->>'remoteJid' AND "Contact"."instanceId" = "Message"."instanceId"
        LEFT JOIN "Chat" ON "Chat"."remoteJid" = "Message"."key"->>'remoteJid' AND "Chat"."instanceId" = "Message"."instanceId"
        WHERE "Message"."instanceId" = ${this.instanceId}
        ${e?Je.Prisma.sql`AND "Message"."key"->>'remoteJid' = ${e}`:Je.Prisma.sql``}
        ${i}
        ORDER BY "Message"."key"->>'remoteJid', "Message"."messageTimestamp" DESC
      )
      SELECT * FROM rankedMessages 
      ORDER BY "updatedAt" DESC NULLS LAST
      ${o}
      ${n};
    `;return r&&(0,fp.isArray)(r)&&r.length>0?r.map(p=>{let u=p.lastMessageId?{id:p.lastMessageId,key:p.lastMessage_key,pushName:p.lastMessagePushName,participant:p.lastMessageParticipant,messageType:p.lastMessageMessageType,message:p.lastMessageMessage,contextInfo:p.lastMessageContextInfo,source:p.lastMessageSource,messageTimestamp:p.lastMessageMessageTimestamp,instanceId:p.lastMessageInstanceId,sessionId:p.lastMessageSessionId,status:p.lastMessageStatus}:void 0;return{id:p.contactId||null,remoteJid:p.remoteJid,pushName:p.pushName,profilePicUrl:p.profilePicUrl,updatedAt:p.updatedAt,windowStart:p.windowStart,windowExpires:p.windowExpires,windowActive:p.windowActive,lastMessage:u?this.cleanMessageData(u):void 0,unreadCount:p.unreadMessages,isSaved:!!p.contactId}}):[]}hasValidMediaContent(s){if(!s?.message)return!1;let e=s.message;return Object.keys(e).length===1&&Object.prototype.hasOwnProperty.call(e,"messageContextInfo")?!1:["imageMessage","videoMessage","stickerMessage","documentMessage","documentWithCaptionMessage","ptvMessage","audioMessage"].some(i=>e[i]&&Object.keys(e[i]).length>0)}};l(Bs,"ChannelStartupService");var Ze=Bs;var yp=x(require("axios")),Se=require("class-validator"),wp=x(require("form-data")),qt=x(require("mime-types")),Ep=require("path"),ur=require("uuid");var dr=class dr extends Ze{constructor(e,t,i,o,n){super(e,t,i,n);a(this,"configService");a(this,"eventEmitter");a(this,"prismaRepository");a(this,"cache");a(this,"chatwootCache");a(this,"client");a(this,"stateConnection",{state:"open"});a(this,"phoneNumber");a(this,"mobile");this.configService=e,this.eventEmitter=t,this.prismaRepository=i,this.cache=o,this.chatwootCache=n,this.client=null}get connectionStatus(){return this.stateConnection}async closeClient(){this.stateConnection={state:"close"}}get qrCode(){return{pairingCode:this.instance.qrcode?.pairingCode,code:this.instance.qrcode?.code,base64:this.instance.qrcode?.base64,count:this.instance.qrcode?.count}}async logoutInstance(){await this.closeClient()}setInstance(e){this.logger.setInstance(e.instanceId),this.instance.name=e.instanceName,this.instance.id=e.instanceId,this.instance.integration=e.integration,this.instance.number=e.number,this.instance.token=e.token,this.instance.businessId=e.businessId,this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp(R.STATUS_INSTANCE,{instanceName:this.instance.name,instanceId:this.instance.id,integration:e.integration},{instance:this.instance.name,status:"created"})}async profilePicture(e){return{wuid:K(e),profilePictureUrl:null}}async getProfileName(){return null}async profilePictureUrl(){return null}async getProfileStatus(){return null}async connectToWhatsapp(e){if(!e){this.loadChatwoot();return}try{this.eventHandler(e)}catch(t){throw this.logger.error(t),new $(t?.toString())}}async eventHandler(e){try{let t;if(e.message){t={key:{id:e.key.id||(0,ur.v4)(),remoteJid:e.key.remoteJid,fromMe:e.key.fromMe,profilePicUrl:e.profilePicUrl},pushName:e.pushName,message:e.message,messageType:e.messageType,messageTimestamp:Math.round(new Date().getTime()/1e3),source:"unknown",instanceId:this.instanceId};let o=e?.message?.audioMessage;if(this.configService.get("OPENAI").ENABLED&&o){let n=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});n&&n.openaiCredsId&&n.speechToText&&e?.message?.audioMessage&&(t.message.speechToText=`[audio] ${await this.openaiService.speechToText(e,this)}`)}if(this.logger.log(t),j(`received.message.${t.messageType??"unknown"}`),this.sendDataWebhook(R.MESSAGES_UPSERT,t),await qe.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:t.key.remoteJid,msg:t,pushName:t.pushName}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled){let n=await this.chatwootService.eventWhatsapp(R.MESSAGES_UPSERT,{instanceName:this.instance.name,instanceId:this.instanceId},t);n?.id&&(t.chatwootMessageId=n.id,t.chatwootInboxId=n.id,t.chatwootConversationId=n.id)}await this.prismaRepository.message.create({data:t}),await this.updateContact({remoteJid:t.key.remoteJid,pushName:t.pushName,profilePicUrl:e.profilePicUrl})}}catch(t){this.logger.error(t)}}async updateContact(e){let t={remoteJid:e.remoteJid,pushName:e?.pushName,instanceId:this.instanceId,profilePicUrl:e?.profilePicUrl};await this.prismaRepository.contact.findFirst({where:{remoteJid:e.remoteJid,instanceId:this.instanceId}})?await this.prismaRepository.contact.updateMany({where:{remoteJid:e.remoteJid,instanceId:this.instanceId},data:t}):await this.prismaRepository.contact.create({data:t}),this.sendDataWebhook(R.CONTACTS_UPSERT,t),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&await this.chatwootService.eventWhatsapp(R.CONTACTS_UPDATE,{instanceName:this.instance.name,instanceId:this.instanceId,integration:this.instance.integration},t);let o=await this.prismaRepository.chat.findFirst({where:{instanceId:this.instanceId,remoteJid:e.remoteJid}});if(o){let r={remoteJid:e.remoteJid,instanceId:this.instanceId};this.sendDataWebhook(R.CHATS_UPDATE,r),await this.prismaRepository.chat.updateMany({where:{remoteJid:o.remoteJid},data:r})}let n={remoteJid:e.remoteJid,instanceId:this.instanceId};this.sendDataWebhook(R.CHATS_UPSERT,n),await this.prismaRepository.chat.create({data:n})}async sendMessageWithTyping(e,t,i,o,n=!1){try{let r,c;if(i?.quoted){let y=i?.quoted?.key;if(!y)throw"Message not found";r=y}i.delay&&await new Promise(g=>setTimeout(g,i.delay)),i?.webhookUrl&&(c=i.webhookUrl);let p,u=(0,ur.v4)(),d;if(t?.mediaType==="image"?d={key:{fromMe:!0,id:u,remoteJid:e},message:{base64:(0,Se.isBase64)(t.media)?t.media:null,mediaUrl:(0,Se.isURL)(t.media)?t.media:null,quoted:r},messageType:"imageMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:c,source:"unknown",instanceId:this.instanceId}:t?.mediaType==="video"?d={key:{fromMe:!0,id:u,remoteJid:e},message:{base64:(0,Se.isBase64)(t.media)?t.media:null,mediaUrl:(0,Se.isURL)(t.media)?t.media:null,quoted:r},messageType:"videoMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:c,source:"unknown",instanceId:this.instanceId}:t?.mediaType==="audio"?(d={key:{fromMe:!0,id:u,remoteJid:e},message:{base64:(0,Se.isBase64)(t.media)?t.media:null,mediaUrl:(0,Se.isURL)(t.media)?t.media:null,quoted:r},messageType:"audioMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:c,source:"unknown",instanceId:this.instanceId},p={buffer:Buffer.from(t.media,"base64"),mimetype:"audio/mp4",originalname:`${u}.mp4`}):t?.mediaType==="document"?d={key:{fromMe:!0,id:u,remoteJid:e},message:{base64:(0,Se.isBase64)(t.media)?t.media:null,mediaUrl:(0,Se.isURL)(t.media)?t.media:null,quoted:r},messageType:"documentMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:c,source:"unknown",instanceId:this.instanceId}:t.buttonMessage?d={key:{fromMe:!0,id:u,remoteJid:e},message:{...t.buttonMessage,buttons:t.buttonMessage.buttons,footer:t.buttonMessage.footer,body:t.buttonMessage.body,quoted:r},messageType:"buttonMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:c,source:"unknown",instanceId:this.instanceId}:t.listMessage?d={key:{fromMe:!0,id:u,remoteJid:e},message:{...t.listMessage,quoted:r},messageType:"listMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:c,source:"unknown",instanceId:this.instanceId}:d={key:{fromMe:!0,id:u,remoteJid:e},message:{...t,quoted:r},messageType:"conversation",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:c,source:"unknown",instanceId:this.instanceId},d.message.contextInfo&&(d.contextInfo={...d.message.contextInfo}),d.contextInfo?.stanzaId){let g={id:d.contextInfo.stanzaId},y=await this.prismaRepository.message.findFirst({where:{instanceId:this.instanceId,key:g}});y&&(d.contextInfo.quotedMessage=y.message)}let{base64:f}=d.message;if(delete d.message.base64,(f||o||p)&&this.configService.get("S3").ENABLE)try{if(!this.hasValidMediaContent(d))this.logger.warn("Message detected as media but contains no valid media content");else{let y=p?.buffer||o?.buffer,m=f?Buffer.from(f,"base64"):y,S,T=p?.mimetype||o.mimetype;d.messageType==="documentMessage"?(S="document",T=T||"application/pdf"):d.messageType==="imageMessage"?(S="image",T=T||"image/png"):d.messageType==="audioMessage"?(S="audio",T=T||"audio/mp4"):d.messageType==="videoMessage"&&(S="video",T=T||"video/mp4");let A=`${d.key.id}.${T.split("/")[1]}`,N=m.byteLength,I=(0,Ep.join)(`${this.instance.id}`,d.key.remoteJid,S,A);await We(I,m,N,{"Content-Type":T});let C=await Pe(I);d.message.mediaUrl=C}}catch(g){this.logger.error(["Error on upload file to minio",g?.message,g?.stack])}return this.logger.log(d),this.sendDataWebhook(R.SEND_MESSAGE,d),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&!n&&this.chatwootService.eventWhatsapp(R.SEND_MESSAGE,{instanceName:this.instance.name,instanceId:this.instanceId},d),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&n&&await qe.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:d.key.remoteJid,msg:d,pushName:d.pushName}),await this.prismaRepository.message.create({data:d}),d}catch(r){throw this.logger.error(r),new w(r.toString())}}async textMessage(e,t=!1){return await this.sendMessageWithTyping(e.number,{conversation:e.text},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},null,t)}async prepareMediaMessage(e){try{if(e.mediatype==="document"&&!e.fileName){let n=new RegExp(/.*\/(.+?)\./).exec(e.media);e.fileName=n[1]}e.mediatype==="image"&&!e.fileName&&(e.fileName="image.png"),e.mediatype==="video"&&!e.fileName&&(e.fileName="video.mp4");let t,i={caption:e?.caption,fileName:e.fileName,mediaType:e.mediatype,media:e.media,gifPlayback:!1};return(0,Se.isURL)(e.media)?t=qt.default.lookup(e.media):t=qt.default.lookup(e.fileName),i.mimetype=t,i}catch(t){throw this.logger.error(t),new $(t?.toString()||t)}}async mediaMessage(e,t,i=!1){let o={...e};t&&(o.media=t.buffer.toString("base64"));let n=await this.prepareMediaMessage(o);return await this.sendMessageWithTyping(e.number,{...n},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t,i)}async processAudio(e,t,i){t=t.replace(/\D/g,"");let o=`${t}-${new Date().getTime()}`,n=this.configService.get("AUDIO_CONVERTER");if(n.API_URL)try{this.logger.verbose("Using audio converter API");let r=new wp.default;i?r.append("file",i.buffer,{filename:i.originalname,contentType:i.mimetype}):(0,Se.isURL)(e)?r.append("url",e):r.append("base64",e),r.append("format","mp4");let c=await yp.default.post(n.API_URL,r,{headers:{...r.getHeaders(),apikey:n.API_KEY}});if(!c?.data?.audio)throw new $("Failed to convert audio");return{fileName:`${o}.mp4`,mediaType:"audio",media:c?.data?.audio,mimetype:"audio/mpeg"}}catch(r){throw this.logger.error(r?.response?.data||r),new $(r?.response?.data?.message||r?.toString()||r)}else{let r,c={fileName:`${o}.mp3`,mediaType:"audio",media:e,mimetype:"audio/mpeg"};return(0,Se.isURL)(e)?r=qt.default.lookup(e).toString():r=qt.default.lookup(c.fileName).toString(),c.mimetype=r,c}}async audioWhatsapp(e,t,i=!1){let o={...e};if(t?.buffer)o.audio=t.buffer.toString("base64");else throw console.error("El archivo o buffer no est\uFFFD definido correctamente."),new Error("File or buffer is undefined.");let n=await this.processAudio(o.audio,e.number,t);return await this.sendMessageWithTyping(e.number,{...n},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t,i)}async buttonMessage(e,t=!1){return await this.sendMessageWithTyping(e.number,{buttonMessage:{title:e.title,description:e.description,footer:e.footer,buttons:e.buttons}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},null,t)}async locationMessage(){throw new w("Method not available on Evolution Channel")}async listMessage(){throw new w("Method not available on Evolution Channel")}async templateMessage(){throw new w("Method not available on Evolution Channel")}async contactMessage(){throw new w("Method not available on Evolution Channel")}async reactionMessage(){throw new w("Method not available on Evolution Channel")}async getBase64FromMediaMessage(){throw new w("Method not available on Evolution Channel")}async deleteMessage(){throw new w("Method not available on Evolution Channel")}async mediaSticker(){throw new w("Method not available on Evolution Channel")}async pollMessage(){throw new w("Method not available on Evolution Channel")}async statusMessage(){throw new w("Method not available on Evolution Channel")}async reloadConnection(){throw new w("Method not available on Evolution Channel")}async whatsappNumber(){throw new w("Method not available on Evolution Channel")}async markMessageAsRead(){throw new w("Method not available on Evolution Channel")}async archiveChat(){throw new w("Method not available on Evolution Channel")}async markChatUnread(){throw new w("Method not available on Evolution Channel")}async fetchProfile(){throw new w("Method not available on Evolution Channel")}async offerCall(){throw new w("Method not available on WhatsApp Business API")}async sendPresence(){throw new w("Method not available on Evolution Channel")}async setPresence(){throw new w("Method not available on Evolution Channel")}async fetchPrivacySettings(){throw new w("Method not available on Evolution Channel")}async updatePrivacySettings(){throw new w("Method not available on Evolution Channel")}async fetchBusinessProfile(){throw new w("Method not available on Evolution Channel")}async updateProfileName(){throw new w("Method not available on Evolution Channel")}async updateProfileStatus(){throw new w("Method not available on Evolution Channel")}async updateProfilePicture(){throw new w("Method not available on Evolution Channel")}async removeProfilePicture(){throw new w("Method not available on Evolution Channel")}async blockUser(){throw new w("Method not available on Evolution Channel")}async updateMessage(){throw new w("Method not available on Evolution Channel")}async createGroup(){throw new w("Method not available on Evolution Channel")}async updateGroupPicture(){throw new w("Method not available on Evolution Channel")}async updateGroupSubject(){throw new w("Method not available on Evolution Channel")}async updateGroupDescription(){throw new w("Method not available on Evolution Channel")}async findGroup(){throw new w("Method not available on Evolution Channel")}async fetchAllGroups(){throw new w("Method not available on Evolution Channel")}async inviteCode(){throw new w("Method not available on Evolution Channel")}async inviteInfo(){throw new w("Method not available on Evolution Channel")}async sendInvite(){throw new w("Method not available on Evolution Channel")}async acceptInviteCode(){throw new w("Method not available on Evolution Channel")}async revokeInviteCode(){throw new w("Method not available on Evolution Channel")}async findParticipants(){throw new w("Method not available on Evolution Channel")}async updateGParticipant(){throw new w("Method not available on Evolution Channel")}async updateGSetting(){throw new w("Method not available on Evolution Channel")}async toggleEphemeral(){throw new w("Method not available on Evolution Channel")}async leaveGroup(){throw new w("Method not available on Evolution Channel")}async fetchLabels(){throw new w("Method not available on Evolution Channel")}async handleLabel(){throw new w("Method not available on Evolution Channel")}async receiveMobileCode(){throw new w("Method not available on Evolution Channel")}async fakeCall(){throw new w("Method not available on Evolution Channel")}};l(dr,"EvolutionStartupService");var Us=dr;var re={0:"ERROR",1:"PENDING",2:"SERVER_ACK",3:"DELIVERY_ACK",4:"READ",5:"PLAYED"};var Le=x(require("axios")),Ve=require("class-validator"),hr=x(require("form-data")),Vt=x(require("mime-types")),Sp=require("path");var mr=class mr extends Ze{constructor(e,t,i,o,n,r,c){super(e,t,i,n);a(this,"configService");a(this,"eventEmitter");a(this,"prismaRepository");a(this,"cache");a(this,"chatwootCache");a(this,"baileysCache");a(this,"providerFiles");a(this,"stateConnection",{state:"open"});a(this,"phoneNumber");a(this,"mobile");this.configService=e,this.eventEmitter=t,this.prismaRepository=i,this.cache=o,this.chatwootCache=n,this.baileysCache=r,this.providerFiles=c}get connectionStatus(){return this.stateConnection}async closeClient(){this.stateConnection={state:"close"}}get qrCode(){return{pairingCode:this.instance.qrcode?.pairingCode,code:this.instance.qrcode?.code,base64:this.instance.qrcode?.base64,count:this.instance.qrcode?.count}}async logoutInstance(){await this.closeClient()}isMediaMessage(e){return e.document||e.image||e.audio||e.video}async post(e,t){try{let i=this.configService.get("WA_BUSINESS").URL,o=this.configService.get("WA_BUSINESS").VERSION;i=`${i}/${o}/${this.number}/${t}`;let n={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`};return(await Le.default.post(i,e,{headers:n})).data}catch(i){return i.response?.data?.error}}async profilePicture(e){return{wuid:K(e),profilePictureUrl:null}}async getProfileName(){return null}async profilePictureUrl(){return null}async getProfileStatus(){return null}async setWhatsappBusinessProfile(e){let t={messaging_product:"whatsapp",about:e.about,address:e.address,description:e.description,vertical:e.vertical,email:e.email,websites:e.websites,profile_picture_handle:e.profilehandle};return await this.post(t,"whatsapp_business_profile")}async connectToWhatsapp(e){if(!e)return;let t=e.entry[0].changes[0].value;try{this.loadChatwoot(),this.eventHandler(t),this.phoneNumber=K(t.messages?t.messages[0].from:t.statuses[0]?.recipient_id)}catch(i){throw this.logger.error(i),new $(i?.toString())}}async downloadMediaMessage(e){try{let t=e[e.type].id,i=this.configService.get("WA_BUSINESS").URL,o=this.configService.get("WA_BUSINESS").VERSION;i=`${i}/${o}/${t}`;let n={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},r=await Le.default.get(i,{headers:n});return r=await Le.default.get(r.data.url,{headers:{Authorization:`Bearer ${this.token}`},responseType:"arraybuffer"}),r.data}catch(t){throw this.logger.error(`Error downloading media: ${t}`),t}}messageMediaJson(e){let t=e.messages[0],i=t.type+"Message";return i={[i]:t[t.type]},t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}}),i}messageAudioJson(e){let t=e.messages[0],i={audioMessage:{...t.audio,ptt:t.audio.voice||!1}};return t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}}),i}messageInteractiveJson(e){let t=e.messages[0],i={conversation:t.interactive[t.interactive.type].title};return t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}}),i}messageButtonJson(e){let t=e.messages[0],i={conversation:e.messages[0].button?.text};return t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}}),i}messageReactionJson(e){let t=e.messages[0],i={reactionMessage:{key:{id:t.reaction.message_id},text:t.reaction.emoji}};return t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}}),i}messageTextJson(e){if(!e||!e.messages||e.messages.length===0)return this.logger.error("Error: received object or messages array is undefined or empty"),null;let t=e.messages[0],i;return t.text?!e.metadata||!e.metadata.phone_number_id?(this.logger.error("Error: metadata or phone_number_id is undefined"),null):(t.from===e.metadata.phone_number_id?(i={extendedTextMessage:{text:t.text.body}},t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}})):(i={conversation:t.text.body},t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}})),i):(t.type==="sticker"?i={stickerMessage:{}}:t.type==="location"?i={locationMessage:{degreesLatitude:t.location?.latitude,degreesLongitude:t.location?.longitude,name:t.location?.name,address:t.location?.address}}:(this.logger.log(`Mensaje de tipo ${t.type} sin campo text`),i={[t.type+"Message"]:t[t.type]||{}}),t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}}),i)}messageLocationJson(e){let t=e.messages[0],i={locationMessage:{degreesLatitude:t.location.latitude,degreesLongitude:t.location.longitude,name:t.location?.name,address:t.location?.address}};return t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}}),i}messageContactsJson(e){let t=e.messages[0],i={},o=l(n=>{let r=`BEGIN:VCARD
VERSION:3.0
N:${n.name.formatted_name}
FN:${n.name.formatted_name}
`;return n.org&&(r+=`ORG:${n.org.company};
`),n.emails&&(r+=`EMAIL:${n.emails[0].email}
`),n.urls&&(r+=`URL:${n.urls[0].url}
`),n.phones[0]?.wa_id||(n.phones[0].wa_id=K(n.phones[0].phone)),r+=`item1.TEL;waid=${n.phones[0]?.wa_id}:${n.phones[0].phone}
item1.X-ABLabel:Celular
END:VCARD`,r},"vcard");return t.contacts.length===1?i.contactMessage={displayName:t.contacts[0].name.formatted_name,vcard:o(t.contacts[0])}:i.contactsArrayMessage={displayName:`${t.length} contacts`,contacts:t.map(n=>({displayName:n.name.formatted_name,vcard:o(n)}))},t.context&&(i={...i,contextInfo:{stanzaId:t.context.id}}),i}renderMessageType(e){let t;switch(e){case"text":t="conversation";break;case"image":t="imageMessage";break;case"video":t="videoMessage";break;case"audio":t="audioMessage";break;case"document":t="documentMessage";break;case"template":t="conversation";break;case"location":t="locationMessage";break;case"sticker":t="stickerMessage";break;default:t="conversation";break}return t}async messageHandle(e,t,i){try{let o,n;if(e.contacts&&(n=e.contacts[0].profile.name),e.messages){let r=e.messages[0],c={id:r.id,remoteJid:this.phoneNumber,fromMe:r.from===e.metadata.phone_number_id};if(r.type==="sticker")this.logger.log("Procesando mensaje de tipo sticker"),o={key:c,pushName:n,message:{stickerMessage:r.sticker||{}},messageType:"stickerMessage",messageTimestamp:parseInt(r.timestamp),source:"unknown",instanceId:this.instanceId};else if(this.isMediaMessage(r)){let d=r.type==="audio"?this.messageAudioJson(e):this.messageMediaJson(e);if(o={key:c,pushName:n,message:d,contextInfo:d?.contextInfo,messageType:this.renderMessageType(e.messages[0].type),messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId},this.configService.get("S3").ENABLE)try{let f=e;if(!this.hasValidMediaContent(o))this.logger.warn("Message detected as media but contains no valid media content");else{let y=f.messages[0][f.messages[0].type].id,m=this.configService.get("WA_BUSINESS").URL,S=this.configService.get("WA_BUSINESS").VERSION;m=`${m}/${S}/${y}`;let T={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},A=await Le.default.get(m,{headers:T}),N=await Le.default.get(A.data.url,{headers:{Authorization:`Bearer ${this.token}`},responseType:"arraybuffer"}),I;if(f.messages[0].document?I="document":f.messages[0].image?I="image":f.messages[0].audio?I="audio":I="video",I=="video"&&!this.configService.get("S3").SAVE_VIDEO)return this.logger?.info?.("Video upload attempted but is disabled by configuration."),{success:!1,message:"Video upload is currently disabled. Please contact support if you need this feature enabled."};let C=A.data?.mime_type||A.headers["content-type"],M=A.headers["content-disposition"],v=`${f.messages[0].id}.${C.split("/")[1]}`;if(M){let X=M.match(/filename="(.+?)"/);X&&(v=X[1])}I==="audio"&&(C.includes("ogg")?v=`${f.messages[0].id}.ogg`:C.includes("mp3")?v=`${f.messages[0].id}.mp3`:C.includes("m4a")&&(v=`${f.messages[0].id}.m4a`));let L=A.headers["content-length"]||N.data.byteLength,B=(0,Sp.join)(`${this.instance.id}`,c.remoteJid,I,v);await We(B,N.data,L,{"Content-Type":C});let W=await this.prismaRepository.message.create({data:o});await this.prismaRepository.media.create({data:{messageId:W.id,instanceId:this.instanceId,type:I,fileName:B,mimetype:C}});let q=await Pe(B);if(o.message.mediaUrl=q,this.localWebhook.enabled&&this.localWebhook.webhookBase64&&(o.message.base64=N.data.toString("base64")),this.configService.get("OPENAI").ENABLED&&I==="audio"){let X=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});if(X&&X.openaiCredsId&&X.speechToText)try{o.message.speechToText=`[audio] ${await this.openaiService.speechToText(X.OpenaiCreds,{message:{mediaUrl:o.message.mediaUrl,...o}})}`}catch(te){this.logger.error(`Error processing speech-to-text: ${te}`)}}}}catch(f){this.logger.error(["Error on upload file to minio",f?.message,f?.stack])}else{if(this.localWebhook.enabled&&this.localWebhook.webhookBase64){let f=await this.downloadMediaMessage(e?.messages[0]);o.message.base64=f.toString("base64")}if(this.configService.get("OPENAI").ENABLED&&r.type==="audio"){let f=o.message.base64;f||(f=(await this.downloadMediaMessage(e?.messages[0])).toString("base64"));let g=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});if(g&&g.openaiCredsId&&g.speechToText)try{o.message.speechToText=`[audio] ${await this.openaiService.speechToText(g.OpenaiCreds,{message:{base64:f,...o}})}`}catch(y){this.logger.error(`Error processing speech-to-text: ${y}`)}}}}else e?.messages[0].interactive?o={key:c,pushName:n,message:{...this.messageInteractiveJson(e)},contextInfo:this.messageInteractiveJson(e)?.contextInfo,messageType:"interactiveMessage",messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId}:e?.messages[0].button?o={key:c,pushName:n,message:{...this.messageButtonJson(e)},contextInfo:this.messageButtonJson(e)?.contextInfo,messageType:"buttonMessage",messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId}:e?.messages[0].reaction?o={key:c,pushName:n,message:{...this.messageReactionJson(e)},contextInfo:this.messageReactionJson(e)?.contextInfo,messageType:"reactionMessage",messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId}:e?.messages[0].contacts?o={key:c,pushName:n,message:{...this.messageContactsJson(e)},contextInfo:this.messageContactsJson(e)?.contextInfo,messageType:"contactMessage",messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId}:o={key:c,pushName:n,message:this.messageTextJson(e),contextInfo:this.messageTextJson(e)?.contextInfo,messageType:this.renderMessageType(e.messages[0].type),messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId};if(this.localSettings.readMessages,this.logger.log(o),j(`received.message.${o.messageType??"unknown"}`),this.sendDataWebhook(R.MESSAGES_UPSERT,o),await qe.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:o.key.remoteJid,msg:o,pushName:o.pushName}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled){let d=await this.chatwootService.eventWhatsapp(R.MESSAGES_UPSERT,{instanceName:this.instance.name,instanceId:this.instanceId},o);d?.id&&(o.chatwootMessageId=d.id,o.chatwootInboxId=d.id,o.chatwootConversationId=d.id)}!this.isMediaMessage(r)&&r.type!=="sticker"&&await this.prismaRepository.message.create({data:o});let p=await this.prismaRepository.contact.findFirst({where:{instanceId:this.instanceId,remoteJid:c.remoteJid}}),u={remoteJid:e.contacts[0].profile.phone,pushName:n,instanceId:this.instanceId};if(u.remoteJid==="status@broadcast")return;if(p){let d={remoteJid:e.contacts[0].profile.phone,pushName:n,instanceId:this.instanceId};this.sendDataWebhook(R.CONTACTS_UPDATE,d),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&await this.chatwootService.eventWhatsapp(R.CONTACTS_UPDATE,{instanceName:this.instance.name,instanceId:this.instanceId},d),await this.prismaRepository.contact.updateMany({where:{remoteJid:p.remoteJid},data:d});return}this.sendDataWebhook(R.CONTACTS_UPSERT,u),this.prismaRepository.contact.create({data:u})}if(e.statuses)for await(let r of e.statuses){let c={id:r.id,remoteJid:this.phoneNumber,fromMe:this.phoneNumber===e.metadata.phone_number_id};if(i?.groups_ignore&&c.remoteJid.includes("@g.us"))return;if(c.remoteJid!=="status@broadcast"&&!c?.remoteJid?.match(/(:\d+)/)){let p=await this.prismaRepository.message.findFirst({where:{instanceId:this.instanceId,key:{path:["id"],equals:c.id}}});if(!p)return;if(r.message===null&&r.status===void 0){this.sendDataWebhook(R.MESSAGES_DELETE,c);let d={messageId:p.id,keyId:c.id,remoteJid:c.remoteJid,fromMe:c.fromMe,participant:c?.remoteJid,status:"DELETED",instanceId:this.instanceId};await this.prismaRepository.messageUpdate.create({data:d}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp(R.MESSAGES_DELETE,{instanceName:this.instance.name,instanceId:this.instanceId},{key:c});return}let u={messageId:p.id,keyId:c.id,remoteJid:c.remoteJid,fromMe:c.fromMe,participant:c?.remoteJid,status:r.status.toUpperCase(),instanceId:this.instanceId};this.sendDataWebhook(R.MESSAGES_UPDATE,u),await this.prismaRepository.messageUpdate.create({data:u}),p.webhookUrl&&await Le.default.post(p.webhookUrl,u)}}}catch(o){this.logger.error(o)}}convertMessageToRaw(e,t){let i;return e?.conversation?t?.context?.message_id?(i={...e,contextInfo:{stanzaId:t.context.message_id}},i):(i=e,i):e?.mediaType==="image"?t?.context?.message_id?(i={imageMessage:e,contextInfo:{stanzaId:t.context.message_id}},i):{imageMessage:e}:e?.mediaType==="video"?t?.context?.message_id?(i={videoMessage:e,contextInfo:{stanzaId:t.context.message_id}},i):{videoMessage:e}:e?.mediaType==="audio"?t?.context?.message_id?(i={audioMessage:e,contextInfo:{stanzaId:t.context.message_id}},i):{audioMessage:e}:e?.mediaType==="document"?t?.context?.message_id?(i={documentMessage:e,contextInfo:{stanzaId:t.context.message_id}},i):{documentMessage:e}:e}async eventHandler(e){try{this.logger.log("Contenido recibido en eventHandler:"),this.logger.log(JSON.stringify(e,null,2));let t=this.configService.get("DATABASE"),i=await this.findSettings();if(e.messages&&e.messages.length>0){let o=e.messages[0];this.logger.log(`Tipo de mensaje recibido: ${o.type}`),o.type==="text"||o.type==="image"||o.type==="video"||o.type==="audio"||o.type==="document"||o.type==="sticker"||o.type==="location"||o.type==="contacts"||o.type==="interactive"||o.type==="button"||o.type==="reaction"?this.messageHandle(e,t,i):this.logger.warn(`Tipo de mensaje no reconocido: ${o.type}`)}else e.statuses?this.messageHandle(e,t,i):this.logger.warn("No se encontraron mensajes ni estados en el contenido recibido")}catch(t){this.logger.error("Error en eventHandler:"),this.logger.error(t)}}async sendMessageWithTyping(e,t,i,o=!1){try{let n,r;if(i?.quoted){let f=i?.quoted?.key;if(!f)throw"Message not found";n=f}i?.webhookUrl&&(r=i.webhookUrl);let c,p=await(async()=>{if(t.reactionMessage)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"reaction",to:e.replace(/\D/g,""),reaction:{message_id:t.reactionMessage.key.id,emoji:t.reactionMessage.text}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.locationMessage)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"location",to:e.replace(/\D/g,""),location:{longitude:t.locationMessage.degreesLongitude,latitude:t.locationMessage.degreesLatitude,name:t.locationMessage.name,address:t.locationMessage.address}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.contacts)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"contacts",to:e.replace(/\D/g,""),contacts:t.contacts},n&&(c.context={message_id:n.id}),t=t.message,await this.post(c,"messages");if(t.conversation)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"text",to:e.replace(/\D/g,""),text:{body:t.conversation,preview_url:!!i?.linkPreview}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.media){let d=t.mimetype?.startsWith("image/");return c={messaging_product:"whatsapp",recipient_type:"individual",type:t.mediaType,to:e.replace(/\D/g,""),[t.mediaType]:{[t.type]:t.id,...t.mediaType!=="audio"&&t.mediaType!=="video"&&t.fileName&&!d&&{filename:t.fileName},...t.mediaType!=="audio"&&t.caption&&{caption:t.caption}}},n&&(c.context={message_id:n.id}),await this.post(c,"messages")}if(t.audio)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"audio",to:e.replace(/\D/g,""),audio:{[t.type]:t.id}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.buttons){c={messaging_product:"whatsapp",recipient_type:"individual",to:e.replace(/\D/g,""),type:"interactive",interactive:{type:"button",body:{text:t.text||"Select"},action:{buttons:t.buttons}}},n&&(c.context={message_id:n.id});let d="";for(let f of t.buttons)d+=`\u25B6\uFE0F ${f.reply?.title}
`;return t={conversation:`${t.text||"Select"}
`+d},await this.post(c,"messages")}if(t.listMessage){c={messaging_product:"whatsapp",recipient_type:"individual",to:e.replace(/\D/g,""),type:"interactive",interactive:{type:"list",header:{type:"text",text:t.listMessage.title},body:{text:t.listMessage.description},footer:{text:t.listMessage.footerText},action:{button:t.listMessage.buttonText,sections:t.listMessage.sections}}},n&&(c.context={message_id:n.id});let d="";for(let f of t.listMessage.sections){d+=`${f?.title}
`;for(let g of f.rows)d+=`${g?.title}
`}return t={conversation:`${t.listMessage.title}
`+d},await this.post(c,"messages")}if(t.template)return c={messaging_product:"whatsapp",recipient_type:"individual",to:e.replace(/\D/g,""),type:"template",template:{name:t.template.name,language:{code:t.template.language||"en_US"},components:t.template.components}},n&&(c.context={message_id:n.id}),t={conversation:`\u25B6\uFE0F${t.template.name}\u25C0\uFE0F`},await this.post(c,"messages")})();if(p?.error_data||p.message)return this.logger.error(p),p;let u={key:{fromMe:!0,id:p?.messages[0]?.id,remoteJid:K(e)},message:this.convertMessageToRaw(t,c),messageType:this.renderMessageType(c.type),messageTimestamp:p?.messages[0]?.timestamp||Math.round(new Date().getTime()/1e3),instanceId:this.instanceId,webhookUrl:r,status:re[1],source:"unknown"};return this.logger.log(u),this.sendDataWebhook(R.SEND_MESSAGE,u),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&!o&&this.chatwootService.eventWhatsapp(R.SEND_MESSAGE,{instanceName:this.instance.name,instanceId:this.instanceId},u),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&o&&await qe.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:u.key.remoteJid,msg:u,pushName:u.pushName}),await this.prismaRepository.message.create({data:u}),u}catch(n){throw this.logger.error(n),new w(n.toString())}}async textMessage(e,t=!1){return await this.sendMessageWithTyping(e.number,{conversation:e.text},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async getIdMedia(e,t=!1){try{let i=new hr.default;if(t===!1)if((0,Ve.isURL)(e.media)){let u=await Le.default.get(e.media,{responseType:"arraybuffer"}),d=Buffer.from(u.data,"base64");i.append("file",d,{filename:e.fileName||"media",contentType:e.mimetype})}else{let u=Buffer.from(e.media,"base64");i.append("file",u,{filename:e.fileName||"media",contentType:e.mimetype})}else i.append("file",e.media.buffer,{filename:e.media.originalname,contentType:e.media.mimetype});let o=e.mimetype||e.media.mimetype;i.append("typeFile",o),i.append("messaging_product","whatsapp");let r={Authorization:`Bearer ${this.token}`},c=`${this.configService.get("WA_BUSINESS").URL}/${this.configService.get("WA_BUSINESS").VERSION}/${this.number}/media`;return(await Le.default.post(c,i,{headers:r})).data.id}catch(i){throw this.logger.error(i.response.data),new $(i?.toString()||i)}}async prepareMediaMessage(e){try{if(e.mediatype==="document"&&!e.fileName){let n=new RegExp(/.*\/(.+?)\./).exec(e.media);e.fileName=n[1]}e.mediatype==="image"&&!e.fileName&&(e.fileName="image.png"),e.mediatype==="video"&&!e.fileName&&(e.fileName="video.mp4");let t,i={caption:e?.caption,fileName:e.fileName,mediaType:e.mediatype,media:e.media,gifPlayback:!1};if((0,Ve.isURL)(e.media))t=Vt.default.lookup(e.media),i.id=e.media,i.type="link";else{t=Vt.default.lookup(e.fileName);let o=await this.getIdMedia(i);i.id=o,i.type="id"}return i.mimetype=t,i}catch(t){throw this.logger.error(t),new $(t?.toString()||t)}}async mediaMessage(e,t,i=!1){let o={...e};t&&(o.media=t.buffer.toString("base64"));let n=await this.prepareMediaMessage(o);return await this.sendMessageWithTyping(e.number,{...n},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},i)}async processAudio(e,t,i){t=t.replace(/\D/g,"");let o=`${t}-${new Date().getTime()}`,n=this.configService.get("AUDIO_CONVERTER");if(n.API_URL){this.logger.verbose("Using audio converter API");let r=new hr.default;i?r.append("file",i.buffer,{filename:i.originalname,contentType:i.mimetype}):(0,Ve.isURL)(e)?r.append("url",e):r.append("base64",e),r.append("format","mp3");let c=await Le.default.post(n.API_URL,r,{headers:{...r.getHeaders(),apikey:n.API_KEY}}),p=c?.data?.audio||c?.data?.url;if(!p)throw new $("Failed to convert audio");let u={fileName:`${o}.mp3`,mediaType:"audio",media:p,mimetype:"audio/mpeg"},d=await this.getIdMedia(u);return u.id=d,u.type="id",this.logger.verbose("Audio converted"),u}else{let r,c={fileName:`${o}.mp3`,mediaType:"audio",media:e};if((0,Ve.isURL)(e))r=Vt.default.lookup(e),c.id=e,c.type="link";else if(e&&!i){r=Vt.default.lookup(c.fileName);let p=await this.getIdMedia(c);c.id=p,c.type="id"}else if(i){c.media=i;let p=await this.getIdMedia(c,!0);c.id=p,c.type="id",r=i.mimetype}return c.mimetype=r,c}}async audioWhatsapp(e,t,i=!1){let o=await this.processAudio(e.audio,e.number,t);return await this.sendMessageWithTyping(e.number,{...o},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},i)}async buttonMessage(e){let t={},i={text:e.buttons.map(o=>o.displayText),ids:e.buttons.map(o=>o.id)};if(!(0,Ve.arrayUnique)(i.text)||!(0,Ve.arrayUnique)(i.ids))throw new w("Button texts cannot be repeated","Button IDs cannot be repeated.");return await this.sendMessageWithTyping(e.number,{text:t?.mediaKey?void 0:e.title,buttons:e.buttons.map(o=>({type:"reply",reply:{title:o.displayText,id:o.id}})),[t?.mediaKey]:t?.message},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async locationMessage(e){return await this.sendMessageWithTyping(e.number,{locationMessage:{degreesLatitude:e.latitude,degreesLongitude:e.longitude,name:e?.name,address:e?.address}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async listMessage(e){let t={title:e.sections.map(o=>o.title)};if(!(0,Ve.arrayUnique)(t.title))throw new w("Section tiles cannot be repeated");let i={listMessage:{title:e.title,description:e.description,footerText:e?.footerText,buttonText:e?.buttonText,sections:e.sections.map(o=>({title:o.title,rows:o.rows.map(n=>({title:n.title,description:n.description.substring(0,72),id:n.rowId}))}))}};return await this.sendMessageWithTyping(e.number,i,{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async templateMessage(e,t=!1){return await this.sendMessageWithTyping(e.number,{template:{name:e.name,language:e.language,components:e.components}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned,webhookUrl:e?.webhookUrl},t)}async contactMessage(e){let t={},i=l(o=>{let n=`BEGIN:VCARD
VERSION:3.0
N:${o.fullName}
FN:${o.fullName}
`;return o.organization&&(n+=`ORG:${o.organization};
`),o.email&&(n+=`EMAIL:${o.email}
`),o.url&&(n+=`URL:${o.url}
`),o.wuid||(o.wuid=K(o.phoneNumber)),n+=`item1.TEL;waid=${o.wuid}:${o.phoneNumber}
item1.X-ABLabel:Celular
END:VCARD`,n},"vcard");return e.contact.length===1?t.contact={displayName:e.contact[0].fullName,vcard:i(e.contact[0])}:t.contactsArrayMessage={displayName:`${e.contact.length} contacts`,contacts:e.contact.map(o=>({displayName:o.fullName,vcard:i(o)}))},await this.sendMessageWithTyping(e.number,{contacts:e.contact.map(o=>({name:{formatted_name:o.fullName,first_name:o.fullName},phones:[{phone:o.phoneNumber}],urls:[{url:o.url}],emails:[{email:o.email}],org:{company:o.organization}})),message:t},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async reactionMessage(e){return await this.sendMessageWithTyping(e.key.remoteJid,{reactionMessage:{key:e.key,text:e.reaction}})}async getBase64FromMediaMessage(e){try{let t=e.message,i=t.messageType.includes("Message")?t.messageType:t.messageType+"Message",o=t.message[i];if(!t.message?.base64){let n=await this.downloadMediaMessage({type:i,...t.message});t.message.base64=n.toString("base64")}return{mediaType:t.messageType,fileName:o?.fileName||o?.filename,caption:o?.caption,size:{fileLength:o?.fileLength,height:o?.fileLength,width:o?.width},mimetype:o?.mime_type,base64:t.message.base64}}catch(t){throw this.logger.error(t),new w(t.toString())}}async deleteMessage(){throw new w("Method not available on WhatsApp Business API")}async mediaSticker(){throw new w("Method not available on WhatsApp Business API")}async pollMessage(){throw new w("Method not available on WhatsApp Business API")}async statusMessage(){throw new w("Method not available on WhatsApp Business API")}async reloadConnection(){throw new w("Method not available on WhatsApp Business API")}async whatsappNumber(){throw new w("Method not available on WhatsApp Business API")}async markMessageAsRead(){throw new w("Method not available on WhatsApp Business API")}async archiveChat(){throw new w("Method not available on WhatsApp Business API")}async markChatUnread(){throw new w("Method not available on WhatsApp Business API")}async fetchProfile(){throw new w("Method not available on WhatsApp Business API")}async offerCall(){throw new w("Method not available on WhatsApp Business API")}async sendPresence(){throw new w("Method not available on WhatsApp Business API")}async setPresence(){throw new w("Method not available on WhatsApp Business API")}async fetchPrivacySettings(){throw new w("Method not available on WhatsApp Business API")}async updatePrivacySettings(){throw new w("Method not available on WhatsApp Business API")}async fetchBusinessProfile(){throw new w("Method not available on WhatsApp Business API")}async updateProfileName(){throw new w("Method not available on WhatsApp Business API")}async updateProfileStatus(){throw new w("Method not available on WhatsApp Business API")}async updateProfilePicture(){throw new w("Method not available on WhatsApp Business API")}async removeProfilePicture(){throw new w("Method not available on WhatsApp Business API")}async blockUser(){throw new w("Method not available on WhatsApp Business API")}async updateMessage(){throw new w("Method not available on WhatsApp Business API")}async createGroup(){throw new w("Method not available on WhatsApp Business API")}async updateGroupPicture(){throw new w("Method not available on WhatsApp Business API")}async updateGroupSubject(){throw new w("Method not available on WhatsApp Business API")}async updateGroupDescription(){throw new w("Method not available on WhatsApp Business API")}async findGroup(){throw new w("Method not available on WhatsApp Business API")}async fetchAllGroups(){throw new w("Method not available on WhatsApp Business API")}async inviteCode(){throw new w("Method not available on WhatsApp Business API")}async inviteInfo(){throw new w("Method not available on WhatsApp Business API")}async sendInvite(){throw new w("Method not available on WhatsApp Business API")}async acceptInviteCode(){throw new w("Method not available on WhatsApp Business API")}async revokeInviteCode(){throw new w("Method not available on WhatsApp Business API")}async findParticipants(){throw new w("Method not available on WhatsApp Business API")}async updateGParticipant(){throw new w("Method not available on WhatsApp Business API")}async updateGSetting(){throw new w("Method not available on WhatsApp Business API")}async toggleEphemeral(){throw new w("Method not available on WhatsApp Business API")}async leaveGroup(){throw new w("Method not available on WhatsApp Business API")}async fetchLabels(){throw new w("Method not available on WhatsApp Business API")}async handleLabel(){throw new w("Method not available on WhatsApp Business API")}async receiveMobileCode(){throw new w("Method not available on WhatsApp Business API")}async fakeCall(){throw new w("Method not available on WhatsApp Business API")}};l(mr,"BusinessStartupService");var $s=mr;var gr=class gr{constructor(s,e,t,i,o){a(this,"jid");a(this,"exists");a(this,"number");a(this,"name");a(this,"lid");this.jid=s,this.exists=e,this.number=t,this.name=i,this.lid=o}};l(gr,"OnWhatsAppDto");var Ge=gr,fr=class fr{constructor(){a(this,"message");a(this,"convertToMp4")}};l(fr,"getBase64FromMediaMessageDto");var Fs=fr,yr=class yr{constructor(){a(this,"numbers")}};l(yr,"WhatsAppNumberDto");var Ws=yr,wr=class wr{constructor(){a(this,"number")}};l(wr,"NumberDto");var et=wr;var Er=class Er{constructor(){a(this,"name")}};l(Er,"ProfileNameDto");var Js=Er,Sr=class Sr{constructor(){a(this,"status")}};l(Sr,"ProfileStatusDto");var qs=Sr,Tr=class Tr{constructor(){a(this,"number");a(this,"picture")}};l(Tr,"ProfilePictureDto");var vt=Tr;var Ar=class Ar{constructor(){a(this,"readMessages")}};l(Ar,"ReadMessageDto");var Vs=Ar;var br=class br{constructor(){a(this,"lastMessage");a(this,"chat");a(this,"archive")}};l(br,"ArchiveChatDto");var Gs=br,Ir=class Ir{constructor(){a(this,"lastMessage");a(this,"chat")}};l(Ir,"MarkChatUnreadDto");var Ks=Ir,Cr=class Cr{constructor(){a(this,"readreceipts");a(this,"profile");a(this,"status");a(this,"online");a(this,"last");a(this,"groupadd")}};l(Cr,"PrivacySettingDto");var js=Cr,Mr=class Mr{constructor(){a(this,"id");a(this,"fromMe");a(this,"remoteJid");a(this,"participant")}};l(Mr,"DeleteMessage");var Hs=Mr;var Mt,om=(Mt=class{constructor(){a(this,"options")}},l(Mt,"OptionsMessage"),Mt),vr=class vr extends om{constructor(){super(...arguments);a(this,"number")}};l(vr,"Metadata");var Ys=vr,Nr=class Nr extends Ys{constructor(){super(...arguments);a(this,"presence");a(this,"delay")}};l(Nr,"SendPresenceDto");var Qs=Nr,_r=class _r extends Ys{constructor(){super(...arguments);a(this,"number");a(this,"key");a(this,"text")}};l(_r,"UpdateMessageDto");var zs=_r,Rr=class Rr{constructor(){a(this,"number");a(this,"status")}};l(Rr,"BlockUserDto");var Xs=Rr;var Or=require("baileys");var Pr=class Pr{constructor(s){a(this,"cache");a(this,"logger",new O("CacheService"));this.cache=s,s?this.logger.verbose(`cacheservice created using cache engine: ${s.constructor?.name}`):this.logger.verbose("cacheservice disabled")}async get(s){if(this.cache)return this.cache.get(s)}async hGet(s,e){if(!this.cache)return null;try{let t=await this.cache.hGet(s,e);return t?JSON.parse(t,Or.BufferJSON.reviver):null}catch(t){return this.logger.error(t),null}}async set(s,e,t){this.cache&&this.cache.set(s,e,t)}async hSet(s,e,t){if(this.cache)try{let i=JSON.stringify(t,Or.BufferJSON.replacer);await this.cache.hSet(s,e,i)}catch(i){this.logger.error(i)}}async has(s){if(this.cache)return this.cache.has(s)}async delete(s){if(this.cache)return this.cache.delete(s)}async hDelete(s,e){if(!this.cache)return!1;try{return await this.cache.hDelete(s,e),!0}catch(t){return this.logger.error(t),!1}}async deleteAll(s){if(this.cache)return this.cache.deleteAll(s)}async keys(s){if(this.cache)return this.cache.keys(s)}};l(Pr,"CacheService");var tt=Pr;var Jr=x(require("@ffmpeg-installer/ffmpeg")),ni=require("@paralleldrive/cuid2");var Tp=x(require("axios")),xr=require("baileys");var Zs=l(async h=>{try{let{data:s}=await Tp.default.get("https://web.whatsapp.com/sw.js",{...h,responseType:"json"}),e=/\\?"client_revision\\?":\s*(\d+)/,t=s.match(e);return t?.[1]?{version:[2,3e3,+t[1]],isLatest:!0}:{version:(await(0,xr.fetchLatestBaileysVersion)()).version,isLatest:!1,error:{message:"Could not find client revision in the fetched content"}}}catch(s){return{version:(await(0,xr.fetchLatestBaileysVersion)()).version,isLatest:!1,error:s}}},"fetchLatestWaWebVersion");var bp=x(require("dayjs"));var pt=new O("OnWhatsappCache");function Ip(h){let s=[];h.startsWith("+")&&(h=h.slice(1));let[e,t]=h.split("@");if(t==="lid"||t==="g.us")return[h];if(h.startsWith("55")){let i=e.slice(4,5)==="9"&&e.length===13?e:`${e.slice(0,4)}9${e.slice(4)}`,o=e.length===12?e:e.slice(0,4)+e.slice(5);s.push(i),s.push(o)}else if(e.startsWith("52")||e.startsWith("54")){let i="";e.startsWith("52")&&(i="1"),e.startsWith("54")&&(i="9");let o=e.slice(2,3)===i&&e.length===13?e:`${e.slice(0,2)}${i}${e.slice(2)}`,n=e.length===12?e:e.slice(0,2)+e.slice(3);s.push(o),s.push(n)}else s.push(h);return s.map(i=>`${i}@${t}`)}l(Ip,"getAvailableNumbers");function Ap(h){return h?h.startsWith("+")?h.slice(1):h:null}l(Ap,"normalizeJid");async function Nt(h){if(!b.get("DATABASE").SAVE_DATA.IS_ON_WHATSAPP)return;let s=h.map(async e=>{try{let t=Ap(e.remoteJid);if(!t){pt.warn("[saveOnWhatsappCache] Item skipped, missing remoteJid.");return}let i=Ap(e.remoteJidAlt),o=i&&i.includes("@lid")?i:null,n=[t];o&&n.push(o);let r=n.flatMap(y=>Ip(y)),c=await F.isOnWhatsapp.findFirst({where:{OR:[...r.map(y=>({jidOptions:{contains:y}})),{remoteJid:t}]}});pt.verbose(`[saveOnWhatsappCache] Register exists for [${r.join(",")}]? => ${c?c.remoteJid:"Not found"}`);let p=new Set(r);o&&p.add(o),c?.jidOptions&&c.jidOptions.split(",").forEach(y=>p.add(y));let d=[...p].sort().join(","),f=e.lid==="lid"||e.remoteJid?.includes("@lid")?"lid":null,g={remoteJid:t,jidOptions:d,lid:f};if(c){let y=c.jidOptions?c.jidOptions.split(",").sort().join(","):"";if(c.remoteJid===g.remoteJid&&y===g.jidOptions&&c.lid===g.lid){pt.verbose(`[saveOnWhatsappCache] Data for ${t} is already up-to-date. Skipping update.`);return}pt.verbose(`[saveOnWhatsappCache] Register exists, updating: remoteJid=${t}, jidOptions=${g.jidOptions}, lid=${g.lid}`),await F.isOnWhatsapp.update({where:{id:c.id},data:g})}else pt.verbose(`[saveOnWhatsappCache] Register does not exist, creating: remoteJid=${t}, jidOptions=${g.jidOptions}, lid=${g.lid}`),await F.isOnWhatsapp.create({data:g})}catch(t){pt.error(`[saveOnWhatsappCache] Error processing item for ${e.remoteJid}: `),pt.error(t)}});await Promise.allSettled(s)}l(Nt,"saveOnWhatsappCache");async function Cp(h){let s=[];if(b.get("DATABASE").SAVE_DATA.IS_ON_WHATSAPP){let e=h.map(i=>Ip(i)).flat();s=(await F.isOnWhatsapp.findMany({where:{OR:e.map(i=>({jidOptions:{contains:i}})),updatedAt:{gte:(0,bp.default)().subtract(b.get("DATABASE").SAVE_DATA.IS_ON_WHATSAPP_DAYS,"days").toDate()}}})).map(i=>({remoteJid:i.remoteJid,number:i.remoteJid.split("@")[0],jidOptions:i.jidOptions.split(","),lid:i.lid}))}return s}l(Cp,"getOnWhatsappCache");var Gt=require("path"),ei=process.cwd(),Kt=(0,Gt.join)(ei,"instances"),Ky=(0,Gt.join)(ei,"src"),jy=(0,Gt.join)(ei,"store","auth"),Mp=(0,Gt.join)(ei,"store");var st=require("baileys"),_t=x(require("fs/promises")),Dr=x(require("path"));var nm=l(h=>h?h.replace(/\//g,"__").replace(/:/g,"-"):void 0,"fixFileName");async function Lr(h){try{return!!await F.session.findUnique({where:{sessionId:h}})}catch{return!1}}l(Lr,"keyExists");async function rm(h,s){let e=await Lr(h);try{if(!e)return await F.session.create({data:{sessionId:h,creds:JSON.stringify(s)}});await F.session.update({where:{sessionId:h},data:{creds:JSON.stringify(s)}})}catch{return null}}l(rm,"saveKey");async function am(h){try{if(!await Lr(h))return null;let e=await F.session.findUnique({where:{sessionId:h}});return JSON.parse(e?.creds)}catch{return null}}l(am,"getAuthKey");async function vp(h){try{if(!await Lr(h))return;await F.session.delete({where:{sessionId:h}})}catch{return}}l(vp,"deleteAuthKey");async function cm(h){try{if((await _t.default.stat(h)).isFile())return!0}catch{return}}l(cm,"fileExists");var kr=new O("useMultiFileAuthStatePrisma");async function ti(h,s){let e=Dr.default.join(Kt,h),t=l(p=>Dr.default.join(e,nm(p)+".json"),"localFile");await _t.default.mkdir(e,{recursive:!0});async function i(p,u){let d=JSON.stringify(p,st.BufferJSON.replacer),f=b.get("CACHE");if(u!="creds"){if(f.REDIS.ENABLED)return await s.hSet(h,u,p);await _t.default.writeFile(t(u),d);return}await rm(h,d)}l(i,"writeData");async function o(p){try{let u,d=b.get("CACHE");return p!="creds"?d.REDIS.ENABLED?await s.hGet(h,p):await cm(t(p))?(u=await _t.default.readFile(t(p),{encoding:"utf-8"}),JSON.parse(u,st.BufferJSON.reviver)):null:(u=await am(h),JSON.parse(u,st.BufferJSON.reviver))}catch{return null}}l(o,"readData");async function n(p){try{let u=b.get("CACHE");if(p!="creds"){if(u.REDIS.ENABLED)return await s.hDelete(h,p);await _t.default.unlink(t(p))}else await vp(h)}catch{return}}l(n,"removeData");async function r(){let p=b.get("CACHE");try{if(p.REDIS.ENABLED){await s.delete(h),kr.info({action:"redis.delete",sessionId:h});return}}catch(u){kr.warn({action:"redis.delete",sessionId:h,err:u})}kr.info({action:"auth.key.delete",sessionId:h}),await vp(h)}l(r,"removeCreds");let c=await o("creds");return c||(c=(0,st.initAuthCreds)(),await i(c,"creds")),{state:{creds:c,keys:{get:l(async(p,u)=>{let d={};return await Promise.all(u.map(async f=>{let g=await o(`${p}-${f}`);p==="app-state-sync-key"&&g&&(g=st.WAProto.Message.AppStateSyncKeyData.create(g)),d[f]=g})),d},"get"),set:l(async p=>{let u=[];for(let d in p)for(let f in p[d]){let g=p[d][f],y=`${d}-${f}`;u.push(g?i(g,y):n(y))}await Promise.all(u)},"set")}},saveCreds:l(()=>i(c,"creds"),"saveCreds"),removeCreds:r}}l(ti,"useMultiFileAuthStatePrisma");var ut=require("baileys"),Np=require("class-validator");var Br=class Br{constructor(s){a(this,"providerFiles");a(this,"logger",new O("AuthStateProvider"));this.providerFiles=s}async authStateProvider(s){let[,e]=await this.providerFiles.create(s);if(e){this.logger.error(["Failed to create folder on file server",e?.message,e?.stack]);return}let t=l(async(c,p)=>{let u=JSON.stringify(c,ut.BufferJSON.replacer),[d,f]=await this.providerFiles.write(s,p,{data:u});if(!f)return d},"writeData"),i=l(async c=>{let[p,u]=await this.providerFiles.read(s,c);if(!u&&(0,Np.isNotEmpty)(p?.data))return JSON.parse(JSON.stringify(p.data),ut.BufferJSON.reviver)},"readData"),o=l(async c=>{let[p,u]=await this.providerFiles.delete(s,c);if(!u)return p},"removeData"),n=l(async()=>{let[c,p]=await this.providerFiles.removeSession(s);p||lm.info({action:"remove.session",instance:s,response:c})},"removeCreds"),r=await i("creds")||(0,ut.initAuthCreds)();return{state:{creds:r,keys:{get:l(async(c,p)=>{let u={};return await Promise.all(p.map(async d=>{let f=await i(`${c}-${d}`);c==="app-state-sync-key"&&f&&(f=ut.proto.Message.AppStateSyncKeyData.create(f)),u[d]=f})),u},"get"),set:l(async c=>{let p=[];for(let u in c)for(let d in c[u]){let f=c[u][d],g=`${u}-${d}`;p.push(f?await t(f,g):await o(g))}await Promise.all(p)},"set")}},saveCreds:l(async()=>await t(r,"creds"),"saveCreds"),removeCreds:n}}};l(Br,"AuthStateProvider");var si=Br,lm=new O("useMultiFileAuthStatePrisma");var ii=require("baileys");async function Ur(h,s){let e=new O("useMultiFileAuthStateRedisDb"),t=l(async(c,p)=>{try{return await s.hSet(h,p,c)}catch(u){return e.error({localError:"writeData",error:u})}},"writeData"),i=l(async c=>{try{return await s.hGet(h,c)}catch(p){e.error({localError:"readData",error:p});return}},"readData"),o=l(async c=>{try{return await s.hDelete(h,c)}catch(p){e.error({readData:"removeData",error:p})}},"removeData");async function n(){try{return e.warn({action:"redis.delete",instanceName:h}),await s.delete(h)}catch{return}}l(n,"removeCreds");let r=await i("creds")||(0,ii.initAuthCreds)();return{state:{creds:r,keys:{get:l(async(c,p)=>{let u={};return await Promise.all(p.map(async d=>{let f=await i(`${c}-${d}`);c==="app-state-sync-key"&&f&&(f=ii.proto.Message.AppStateSyncKeyData.create(f)),u[d]=f})),u},"get"),set:l(async c=>{let p=[];for(let u in c)for(let d in c[u]){let f=c[u][d],g=`${u}-${d}`;p.push(f?await t(f,g):await o(g))}await Promise.all(p)},"set")}},saveCreds:l(async()=>await t(r,"creds"),"saveCreds"),removeCreds:n}}l(Ur,"useMultiFileAuthStateRedisDb");var Be=x(require("axios")),k=x(require("baileys")),Op=require("child_process"),ee=require("class-validator"),Pp=require("crypto"),qr=x(require("fluent-ffmpeg")),xp=x(require("form-data")),Rt=x(require("long")),Ot=x(require("mime-types")),Vr=x(require("node-cache")),kp=x(require("node-cron")),Dp=require("os"),Gr=require("path"),it=x(require("pino")),Lp=x(require("qrcode")),Bp=x(require("qrcode-terminal")),ri=x(require("sharp")),dt=require("stream"),ai=require("uuid");var Z=require("rxjs");var $r=class $r{constructor(){a(this,"processorLogs",new O("BaileysMessageProcessor"));a(this,"subscription");a(this,"messageSubject",new Z.Subject)}mount({onMessageReceive:s}){this.subscription&&!this.subscription.closed&&this.subscription.unsubscribe(),this.messageSubject.closed&&(this.processorLogs.warn("MessageSubject was closed, recreating..."),this.messageSubject=new Z.Subject),this.subscription=this.messageSubject.pipe((0,Z.tap)(({messages:e})=>{this.processorLogs.log(`Processing batch of ${e.length} messages`)}),(0,Z.concatMap)(({messages:e,type:t,requestId:i,settings:o})=>(0,Z.from)(s({messages:e,type:t,requestId:i},o)).pipe((0,Z.retryWhen)(n=>n.pipe((0,Z.tap)(r=>this.processorLogs.warn(`Retrying message batch due to error: ${r.message}`)),(0,Z.delay)(1e3),(0,Z.take)(3))))),(0,Z.catchError)(e=>(this.processorLogs.error(`Error processing message batch: ${e}`),Z.EMPTY))).subscribe({error:l(e=>{this.processorLogs.error(`Message stream error: ${e}`)},"error")})}processMessage(s,e){let{messages:t,type:i,requestId:o}=s;this.messageSubject.next({messages:t,type:i,requestId:o,settings:e})}onDestroy(){this.subscription?.unsubscribe(),this.messageSubject.complete()}};l($r,"BaileysMessageProcessor");var oi=$r;var _p=require("socket.io-client");var Fr="close",Rp=l(async(h,s,e,t)=>{Fr=e??"close";let i=(0,_p.io)("https://devices.wavoip.com/baileys",{transports:["websocket"],path:`/${h}/websocket`});return i.on("connect",()=>{t&&console.log("[*] - Wavoip connected",i.id),i.emit("init",s.authState.creds.me,s.authState.creds.account,Fr)}),i.on("disconnect",()=>{t&&console.log("[*] - Wavoip disconnect")}),i.on("connect_error",o=>{i.active?t&&console.log("[*] - Wavoip connection error temporary failure, the socket will automatically try to reconnect",o):t&&console.log("[*] - Wavoip connection error",o.message)}),i.on("onWhatsApp",async(o,n)=>{try{let r=await s.onWhatsApp(o);n(r),t&&console.log("[*] Success on call onWhatsApp function",r,o)}catch(r){t&&console.error("[*] Error on call onWhatsApp function",r)}}),i.on("profilePictureUrl",async(o,n,r,c)=>{try{let p=await s.profilePictureUrl(o,n,r);c(p),t&&console.log("[*] Success on call profilePictureUrl function",p)}catch(p){t&&console.error("[*] Error on call profilePictureUrl function",p)}}),i.on("assertSessions",async(o,n,r)=>{try{let c=await s.assertSessions(o);r(c),t&&console.log("[*] Success on call assertSessions function",c)}catch(c){t&&console.error("[*] Error on call assertSessions function",c)}}),i.on("createParticipantNodes",async(o,n,r,c)=>{try{let p=await s.createParticipantNodes(o,n,r);c(p,!0),t&&console.log("[*] Success on call createParticipantNodes function",p)}catch(p){t&&console.error("[*] Error on call createParticipantNodes function",p)}}),i.on("getUSyncDevices",async(o,n,r,c)=>{try{let p=await s.getUSyncDevices(o,n,r);c(p),t&&console.log("[*] Success on call getUSyncDevices function",p)}catch(p){t&&console.error("[*] Error on call getUSyncDevices function",p)}}),i.on("generateMessageTag",async o=>{try{let n=await s.generateMessageTag();o(n),t&&console.log("[*] Success on call generateMessageTag function",n)}catch(n){t&&console.error("[*] Error on call generateMessageTag function",n)}}),i.on("sendNode",async(o,n)=>{try{console.log("sendNode",JSON.stringify(o));let r=await s.sendNode(o);n(!0),t&&console.log("[*] Success on call sendNode function",r)}catch(r){t&&console.error("[*] Error on call sendNode function",r)}}),i.on("signalRepository:decryptMessage",async(o,n,r,c)=>{try{let p=await s.signalRepository.decryptMessage({jid:o,type:n,ciphertext:r});c(p),t&&console.log("[*] Success on call signalRepository:decryptMessage function",p)}catch(p){t&&console.error("[*] Error on call signalRepository:decryptMessage function",p)}}),s.ev.on("connection.update",o=>{let{connection:n}=o;n&&(Fr=n,i.timeout(1e3).emit("connection.update:status",s.authState.creds.me,s.authState.creds.account,n)),o.qr&&i.timeout(1e3).emit("connection.update:qr",o.qr)}),s.ws.on("CB:call",o=>{t&&console.log("[*] Signling received"),i.volatile.timeout(1e3).emit("CB:call",o)}),s.ws.on("CB:ack,class:call",o=>{t&&console.log("[*] Signling ack received"),i.volatile.timeout(1e3).emit("CB:ack,class:call",o)}),i},"useVoiceCallsBaileys");var Wr=new tt(new ze(b,"groups").getEngine());async function pm(h){let s=(await import("mediainfo.js")).default,e=await s({format:"JSON"}),t,i;if(Buffer.isBuffer(h))t=h.length,i=l(async(p,u)=>h.slice(u,u+p),"readChunk");else if(typeof h=="string"){let p=await import("fs");t=(await p.promises.stat(h)).size;let d=await p.promises.open(h,"r");i=l(async(f,g)=>{let y=Buffer.alloc(f);return await d.read(y,0,f,g),y},"readChunk");try{let f=await e.analyzeData(()=>t,i),m=JSON.parse(f).media.track.find(S=>S["@type"]==="General").Duration;return Math.round(parseFloat(m))}finally{await d.close()}}else if(h instanceof dt.Readable){let p=[];for await(let d of h)p.push(d);let u=Buffer.concat(p);t=u.length,i=l(async(d,f)=>u.slice(f,f+d),"readChunk")}else throw new Error("Tipo de entrada n\xE3o suportado");let o=await e.analyzeData(()=>t,i),c=JSON.parse(o).media.track.find(p=>p["@type"]==="General").Duration;return Math.round(parseFloat(c))}l(pm,"getVideoDuration");var Kr=class Kr extends Ze{constructor(e,t,i,o,n,r,c){super(e,t,i,n);a(this,"configService");a(this,"eventEmitter");a(this,"prismaRepository");a(this,"cache");a(this,"chatwootCache");a(this,"baileysCache");a(this,"providerFiles");a(this,"messageProcessor",new oi);a(this,"authStateProvider");a(this,"msgRetryCounterCache",new Vr.default);a(this,"userDevicesCache",new Vr.default({stdTTL:3e5,useClones:!1}));a(this,"endSession",!1);a(this,"logBaileys");a(this,"eventProcessingQueue",Promise.resolve());a(this,"MESSAGE_CACHE_TTL_SECONDS",300);a(this,"UPDATE_CACHE_TTL_SECONDS",1800);a(this,"stateConnection",{state:"close"});a(this,"phoneNumber");a(this,"chatHandle",{"chats.upsert":l(async e=>{let t=await this.prismaRepository.chat.findMany({where:{instanceId:this.instanceId},select:{remoteJid:!0}}),i=new Set(t.map(n=>n.remoteJid)),o=e.filter(n=>!i?.has(n.id)).map(n=>({remoteJid:n.id,instanceId:this.instanceId,name:n.name,unreadMessages:n.unreadCount!==void 0?n.unreadCount:0}));this.sendDataWebhook(R.CHATS_UPSERT,o),o.length>0&&this.configService.get("DATABASE").SAVE_DATA.CHATS&&await this.prismaRepository.chat.createMany({data:o,skipDuplicates:!0})},"chats.upsert"),"chats.update":l(async e=>{let t=e.map(i=>({remoteJid:i.id,instanceId:this.instanceId}));this.sendDataWebhook(R.CHATS_UPDATE,t);for(let i of e)await this.prismaRepository.chat.updateMany({where:{instanceId:this.instanceId,remoteJid:i.id,name:i.name},data:{remoteJid:i.id}})},"chats.update"),"chats.delete":l(async e=>{e.forEach(async t=>await this.prismaRepository.chat.deleteMany({where:{instanceId:this.instanceId,remoteJid:t}})),this.sendDataWebhook(R.CHATS_DELETE,[...e])},"chats.delete")});a(this,"contactHandle",{"contacts.upsert":l(async e=>{try{let t=e.map(o=>({remoteJid:o.id,pushName:o?.name||o?.verifiedName||o.id.split("@")[0],profilePicUrl:null,instanceId:this.instanceId}));if(t.length>0){this.sendDataWebhook(R.CONTACTS_UPSERT,t),this.configService.get("DATABASE").SAVE_DATA.CONTACTS&&await this.prismaRepository.contact.createMany({data:t,skipDuplicates:!0});let o=t.filter(n=>n.remoteJid.includes("@s.whatsapp"));o&&await Nt(o.map(n=>({remoteJid:n.remoteJid})))}this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.localChatwoot.importContacts&&t.length&&(this.chatwootService.addHistoryContacts({instanceName:this.instance.name,instanceId:this.instance.id},t),se.importHistoryContacts({instanceName:this.instance.name,instanceId:this.instance.id},this.localChatwoot));let i=await Promise.all(e.map(async o=>({remoteJid:o.id,pushName:o?.name||o?.verifiedName||o.id.split("@")[0],profilePicUrl:(await this.profilePicture(o.id)).profilePictureUrl,instanceId:this.instanceId})));if(i.length>0){let o=i.filter(n=>n.remoteJid.includes("@s.whatsapp"));o&&await Nt(o.map(n=>({remoteJid:n.remoteJid}))),this.sendDataWebhook(R.CONTACTS_UPDATE,i),await Promise.all(i.map(async n=>{if(this.configService.get("DATABASE").SAVE_DATA.CONTACTS&&await this.prismaRepository.contact.updateMany({where:{remoteJid:n.remoteJid,instanceId:this.instanceId},data:{profilePicUrl:n.profilePicUrl}}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled){let r={instanceName:this.instance.name,instanceId:this.instance.id},c=await this.chatwootService.findContact(r,n.remoteJid.split("@")[0]);if(!c)return;this.chatwootService.updateContact(r,c.id,{name:n.pushName,avatar_url:n.profilePicUrl})}}))}}catch(t){console.error(t),this.logger.error(`Error: ${t.message}`)}},"contacts.upsert"),"contacts.update":l(async e=>{let t=[];for await(let i of e)this.logger.debug(`Updating contact: ${JSON.stringify(i,null,2)}`),t.push({remoteJid:i.id,pushName:i?.name??i?.verifiedName,profilePicUrl:(await this.profilePicture(i.id)).profilePictureUrl,instanceId:this.instanceId});if(this.sendDataWebhook(R.CONTACTS_UPDATE,t),this.configService.get("DATABASE").SAVE_DATA.CONTACTS){let i=t.map(o=>this.prismaRepository.contact.upsert({where:{remoteJid_instanceId:{remoteJid:o.remoteJid,instanceId:o.instanceId}},create:o,update:o}));await this.prismaRepository.$transaction(i)}},"contacts.update")});a(this,"messageHandle",{"messaging-history.set":l(async({messages:e,chats:t,contacts:i,isLatest:o,progress:n,syncType:r})=>{try{r===k.proto.HistorySync.HistorySyncType.ON_DEMAND&&console.log("received on-demand history sync, messages=",e),console.log(`recv ${t.length} chats, ${i.length} contacts, ${e.length} msgs (is latest: ${o}, progress: ${n}%), type: ${r}`);let c={instanceName:this.instance.name},p=null;if(this.configService.get("CHATWOOT").ENABLED){let m=this.localChatwoot?.enabled?this.localChatwoot.daysLimitImportMessages:1e3,S=new Date;if(p=new Date(S.setDate(S.getDate()-m)).getTime()/1e3,!(Math.max(...e.map(N=>N.messageTimestamp))>=p))return}let u=new Map;for(let m of i)m.id&&(m.notify||m.name)&&u.set(m.id,{name:m.name??m.notify,jid:m.id});let d=[],f=new Set((await this.prismaRepository.chat.findMany({where:{instanceId:this.instanceId}})).map(m=>m.remoteJid));for(let m of t)f?.has(m.id)||d.push({remoteJid:m.id,instanceId:this.instanceId,name:m.name});this.sendDataWebhook(R.CHATS_SET,d),this.configService.get("DATABASE").SAVE_DATA.HISTORIC&&await this.prismaRepository.chat.createMany({data:d,skipDuplicates:!0});let g=[],y=new Set(se.getRepositoryMessagesCache(c)??(await this.prismaRepository.message.findMany({select:{key:!0},where:{instanceId:this.instanceId}})).map(m=>m.key.id));se.getRepositoryMessagesCache(c)===null&&se.setRepositoryMessagesCache(c,y);for(let m of e)if(!(!m.message||!m.key||!m.messageTimestamp)&&(Rt.default.isLong(m?.messageTimestamp)&&(m.messageTimestamp=m.messageTimestamp?.toNumber()),!(this.configService.get("CHATWOOT").ENABLED&&m.messageTimestamp<=p)&&!y?.has(m.key.id))){if(!m.pushName&&!m.key.fromMe){let S=m.participant||m.key.participant||m.key.remoteJid;S&&u.has(S)?m.pushName=u.get(S).name:S&&(m.pushName=S.split("@")[0])}g.push(this.prepareMessage(m))}this.sendDataWebhook(R.MESSAGES_SET,[...g],!0,void 0,{isLatest:o,progress:n}),this.configService.get("DATABASE").SAVE_DATA.HISTORIC&&await this.prismaRepository.message.createMany({data:g,skipDuplicates:!0}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.localChatwoot.importMessages&&g.length>0&&this.chatwootService.addHistoryMessages(c,g.filter(m=>!se.isIgnorePhoneNumber(m.key?.remoteJid))),await this.contactHandle["contacts.upsert"](i.filter(m=>!!m.notify||!!m.name).map(m=>({id:m.id,name:m.name??m.notify}))),i=void 0,e=void 0,t=void 0}catch(c){this.logger.error(c)}},"messaging-history.set"),"messages.upsert":l(async({messages:e,type:t,requestId:i},o)=>{try{for(let n of e){if(n?.messageStubParameters?.some?.(y=>["No matching sessions found for message","Bad MAC","failed to decrypt message","SessionError","Invalid PreKey ID","No session record","No session found to decrypt message","Message absent from node"].some(m=>y?.includes?.(m)))){this.logger.warn(`Message ignored with messageStubParameters: ${JSON.stringify(n,null,2)}`);continue}if(n.message?.conversation||n.message?.extendedTextMessage?.text){let y=n.message?.conversation||n.message?.extendedTextMessage?.text;if(y=="requestPlaceholder"&&!i){let m=await this.client.requestPlaceholderResend(n.key);console.log("requested placeholder resync, id=",m)}else i&&console.log("Message received from phone, id=",i,n);if(y=="onDemandHistSync"){let m=await this.client.fetchMessageHistory(50,n.key,n.messageTimestamp);console.log("requested on-demand sync, id=",m)}}let r=n?.message?.protocolMessage||n?.message?.editedMessage?.message?.protocolMessage;if(r){this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("messages.edit",{instanceName:this.instance.name,instanceId:this.instance.id},r),await this.sendDataWebhook(R.MESSAGES_EDITED,r),n.key?.id&&r.key?.id&&await this.baileysCache.set(`protocol_${n.key.id}`,r.key.id,3600*24);let y=await this.getMessage(r.key,!0);if(y?.id){let m=Rt.default.isLong(n?.messageTimestamp)?Math.floor(n?.messageTimestamp.toNumber()):Math.floor(n?.messageTimestamp);await this.prismaRepository.message.update({where:{id:y.id},data:{message:r.editedMessage,messageTimestamp:m,status:"EDITED"}}),await this.prismaRepository.messageUpdate.create({data:{fromMe:r.key.fromMe,keyId:r.key.id,remoteJid:r.key.remoteJid,status:"EDITED",instanceId:this.instanceId,messageId:y.id}})}}if(t!=="notify"&&t!=="append"||r||!n?.message||(Rt.default.isLong(n.messageTimestamp)&&(n.messageTimestamp=n.messageTimestamp?.toNumber()),o?.groupsIgnore&&n.key.remoteJid.includes("@g.us")))continue;let c=await this.prismaRepository.chat.findFirst({where:{instanceId:this.instanceId,remoteJid:n.key.remoteJid},select:{id:!0,name:!0}});if(c&&n.pushName&&c.name!==n.pushName&&n.pushName.trim().length>0&&!n.key.fromMe&&!n.key.remoteJid.includes("@g.us")&&(this.sendDataWebhook(R.CHATS_UPSERT,[{...c,name:n.pushName}]),this.configService.get("DATABASE").SAVE_DATA.CHATS))try{await this.prismaRepository.chat.update({where:{id:c.id},data:{name:n.pushName}})}catch{console.log(`Chat insert record ignored: ${n.key.remoteJid} - ${this.instanceId}`)}let p=this.prepareMessage(n);if(p.messageType==="pollUpdateMessage"){let y=p.message.pollUpdateMessage.pollCreationMessageKey,m=await this.getMessage(y,!0),S=await this.getMessage(y);if(m){let T=m.message.pollCreationMessage?.options||m.message.pollCreationMessageV3?.options||[],A=p.message.pollUpdateMessage.vote,N=n.key.fromMe?this.instance.wuid:n.key.participant||n.key.remoteJid,I=S?.messageContextInfo?.messageSecret,C=N;if(typeof I=="string"?I=Buffer.from(I,"base64"):I?.type==="Buffer"&&Array.isArray(I.data)&&(I=Buffer.from(I.data)),Buffer.isBuffer(I)&&I.length===44&&(I=Buffer.from(I.toString("utf8"),"base64")),A.encPayload&&I){let B=[this.instance.wuid,this.client.user?.lid,m.key.participant,m.key.participantAlt,m.key.remoteJid],W=n.key,q=[this.instance.wuid,this.client.user?.lid,W.participant,W.participantAlt,W.remoteJidAlt,W.remoteJid],X=[...new Set(B.filter(Boolean).map(fe=>(0,k.jidNormalizedUser)(fe)))],te=[...new Set(q.filter(Boolean).map(fe=>(0,k.jidNormalizedUser)(fe)))],z;for(let fe of X){for(let gt of te)try{if(z=(0,k.decryptPollVote)(A,{pollCreatorJid:fe,pollMsgId:m.key.id,pollEncKey:I,voterJid:gt}),z){C=gt;break}}catch{}if(z)break}z&&Object.assign(A,z)}let M=A?.selectedOptions||[],v=T.filter(B=>{let W=(0,Pp.createHash)("sha256").update(B.optionName).digest();return M.some(q=>Buffer.compare(q,W)===0)}).map(B=>B.optionName);p.message.pollUpdateMessage.vote.selectedOptions=v;let L=T.map(B=>({name:B.optionName,voters:v.includes(B.optionName)?[C]:[]}));p.pollUpdates=L}}let u=n?.message?.imageMessage||n?.message?.videoMessage||n?.message?.stickerMessage||n?.message?.documentMessage||n?.message?.documentWithCaptionMessage||n?.message?.ptvMessage||n?.message?.audioMessage,d=n?.message?.videoMessage;if(this.localSettings.readMessages&&n.key.id!=="status@broadcast"&&await this.client.readMessages([n.key]),this.localSettings.readStatus&&n.key.id==="status@broadcast"&&await this.client.readMessages([n.key]),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&!n.key.id.includes("@broadcast")){let y=await this.chatwootService.eventWhatsapp(R.MESSAGES_UPSERT,{instanceName:this.instance.name,instanceId:this.instanceId},p);y?.id&&(p.chatwootMessageId=y.id,p.chatwootInboxId=y.inbox_id,p.chatwootConversationId=y.conversation_id)}if(this.configService.get("OPENAI").ENABLED&&n?.message?.audioMessage){let y=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});y&&y.openaiCredsId&&y.speechToText&&(p.message.speechToText=`[audio] ${await this.openaiService.speechToText(n,this)}`)}if(this.configService.get("DATABASE").SAVE_DATA.NEW_MESSAGE){let{pollUpdates:y,...m}=p,S=await this.prismaRepository.message.create({data:m}),{remoteJid:T}=n.key,A=S.messageTimestamp,N=n.key.fromMe.toString(),I=`${T}_${A}_${N}`;if(await this.baileysCache.get(I)?this.logger.info(`Update readed messages duplicated ignored [avoid deadlock]: ${I}`):(n.key.fromMe?(this.logger.log(`Update readed messages ${T} - ${A}`),await this.updateMessagesReadedByTimestamp(T,A)):S.status===re[3]?(this.logger.log(`Update not read messages ${T}`),await this.updateChatUnreadMessages(T)):S.status===re[4]&&(this.logger.log(`Update readed messages ${T} - ${A}`),await this.updateMessagesReadedByTimestamp(T,A)),await this.baileysCache.set(I,!0,this.MESSAGE_CACHE_TTL_SECONDS)),u&&this.configService.get("S3").ENABLE)try{if(d&&!this.configService.get("S3").SAVE_VIDEO){this.logger.warn("Video upload is disabled. Skipping video upload.");return}let M=n;if(!this.hasValidMediaContent(M))this.logger.warn("Message detected as media but contains no valid media content");else{let L=await this.getBase64FromMediaMessage({message:M},!0);if(!L){this.logger.verbose("No valid media to upload (messageContextInfo only), skipping MinIO");return}let{buffer:B,mediaType:W,fileName:q,size:X}=L,te=Ot.default.lookup(q).toString(),z=(0,Gr.join)(`${this.instance.id}`,n.key.remoteJid,W,`${Date.now()}_${q}`);await We(z,B,X.fileLength?.low,{"Content-Type":te}),await this.prismaRepository.media.create({data:{messageId:S.id,instanceId:this.instanceId,type:W,fileName:z,mimetype:te}});let fe=await Pe(z);p.message.mediaUrl=fe,await this.prismaRepository.message.update({where:{id:S.id},data:p})}}catch(M){this.logger.error(["Error on upload file to minio",M?.message,M?.stack])}}if(this.localWebhook.enabled&&u&&this.localWebhook.webhookBase64)try{let y=await(0,k.downloadMediaMessage)({key:n.key,message:n?.message},"buffer",{},{logger:(0,it.default)({level:"error"}),reuploadRequest:this.client.updateMediaMessage});if(y)p.message.base64=y.toString("base64");else{let m=await(0,k.downloadMediaMessage)({key:n.key,message:n?.message},"buffer",{},{logger:(0,it.default)({level:"error"}),reuploadRequest:this.client.updateMediaMessage});m&&(p.message.base64=m.toString("base64"))}}catch(y){this.logger.error(["Error converting media to base64",y?.message])}this.logger.verbose(p),j(`received.message.${p.messageType??"unknown"}`),p.key.remoteJid?.includes("@lid")&&p.key.remoteJidAlt&&(p.key.remoteJid=p.key.remoteJidAlt),console.log(p),this.sendDataWebhook(R.MESSAGES_UPSERT,p),await qe.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:p.key.remoteJid,msg:p,pushName:p.pushName});let f=await this.prismaRepository.contact.findFirst({where:{remoteJid:n.key.remoteJid,instanceId:this.instanceId}}),g={remoteJid:n.key.remoteJid,pushName:n.key.fromMe||n.key.fromMe==null?"":n.pushName,profilePicUrl:(await this.profilePicture(n.key.remoteJid)).profilePictureUrl,instanceId:this.instanceId};if(g.remoteJid!=="status@broadcast"){if((g.remoteJid.includes("@s.whatsapp")||g.remoteJid.includes("@lid"))&&await Nt([{remoteJid:p.key.addressingMode==="lid"?p.key.remoteJidAlt:p.key.remoteJid,remoteJidAlt:p.key.remoteJidAlt,lid:p.key.addressingMode==="lid"?"lid":null}]),f){this.sendDataWebhook(R.CONTACTS_UPDATE,g),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&await this.chatwootService.eventWhatsapp(R.CONTACTS_UPDATE,{instanceName:this.instance.name,instanceId:this.instanceId},g),this.configService.get("DATABASE").SAVE_DATA.CONTACTS&&await this.prismaRepository.contact.upsert({where:{remoteJid_instanceId:{remoteJid:g.remoteJid,instanceId:g.instanceId}},create:g,update:g});continue}this.sendDataWebhook(R.CONTACTS_UPSERT,g),this.configService.get("DATABASE").SAVE_DATA.CONTACTS&&await this.prismaRepository.contact.upsert({where:{remoteJid_instanceId:{remoteJid:g.remoteJid,instanceId:g.instanceId}},update:g,create:g})}}}catch(n){this.logger.error(n)}},"messages.upsert"),"messages.update":l(async(e,t)=>{this.logger.verbose(`Update messages ${JSON.stringify(e,void 0,2)}`);let i={};for await(let{key:o,update:n}of e){if(t?.groupsIgnore&&o.remoteJid?.includes("@g.us"))continue;let r=`${this.instance.id}_${o.id}_${n.status}`,c=await this.baileysCache.get(r),p=Math.floor(Date.now()/1e3);if(console.log("CACHE:",{cached:c,updateKey:r,messageTimestamp:n.messageTimestamp,secondsSinceEpoch:p}),n.messageTimestamp&&n.messageTimestamp===c||!n.messageTimestamp&&p===c){this.logger.info(`Update Message duplicated ignored [avoid deadlock]: ${r}`);continue}if(n.messageTimestamp?await this.baileysCache.set(r,n.messageTimestamp,1800):await this.baileysCache.set(r,p,1800),re[n.status]==="READ"&&o.fromMe&&this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("messages.read",{instanceName:this.instance.name,instanceId:this.instanceId},{key:o}),o.remoteJid!=="status@broadcast"&&o.id!==void 0){let u;if(n.pollUpdates){let m=await this.getMessage(o);m&&(u=(0,k.getAggregateVotesInPollMessage)({message:m,pollUpdates:n.pollUpdates}))}let d={keyId:o.id,remoteJid:o?.remoteJid,fromMe:o.fromMe,participant:o?.participant,status:re[n.status]??"SERVER_ACK",pollUpdates:u,instanceId:this.instanceId};n.message&&(d.message=n.message);let f,g=this.configService.get("DATABASE").SAVE_DATA;if(g.HISTORIC||g.NEW_MESSAGE){let m=`protocol_${o.id}`,S=await this.baileysCache.get(m);S&&(d.keyId=S);let T=S||o.id;if(f=(await this.prismaRepository.$queryRaw`
              SELECT * FROM "Message"
              WHERE "instanceId" = ${this.instanceId}
              AND "key"->>'id' = ${T}
              LIMIT 1
            `)[0]||null,!f?.id){this.logger.warn(`Original message not found for update. Skipping. Key: ${JSON.stringify(o)}`);continue}d.messageId=f.id}if(n.message===null&&n.status===void 0){this.sendDataWebhook(R.MESSAGES_DELETE,{...o,status:"DELETED"}),this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE&&await this.prismaRepository.messageUpdate.create({data:d}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp(R.MESSAGES_DELETE,{instanceName:this.instance.name,instanceId:this.instanceId},{key:o});continue}if(f&&n.status!==void 0&&re[n.status]!==f.status&&!o.fromMe&&o.remoteJid){i[o.remoteJid]=!0;let{remoteJid:m}=o,S=f.messageTimestamp,T=o.fromMe.toString(),A=`${m}_${S}_${T}`;await this.baileysCache.get(A)?this.logger.info(`Update readed messages duplicated ignored in message.update [avoid deadlock]: ${A}`):(re[n.status]===re[4]&&(this.logger.log(`Update as read in message.update ${m} - ${S}`),await this.updateMessagesReadedByTimestamp(m,S),await this.baileysCache.set(A,!0,this.MESSAGE_CACHE_TTL_SECONDS)),await this.prismaRepository.message.update({where:{id:f.id},data:{status:re[n.status]}}))}if(this.sendDataWebhook(R.MESSAGES_UPDATE,d),this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE){let{message:m,...S}=d;await this.prismaRepository.messageUpdate.create({data:S})}let y=await this.prismaRepository.chat.findFirst({where:{instanceId:this.instanceId,remoteJid:d.remoteJid}});if(y){let m={remoteJid:d.remoteJid,instanceId:this.instanceId,unreadMessages:0};if(this.sendDataWebhook(R.CHATS_UPSERT,[m]),this.configService.get("DATABASE").SAVE_DATA.CHATS)try{await this.prismaRepository.chat.update({where:{id:y.id},data:m})}catch{console.log(`Chat insert record ignored: ${m.remoteJid} - ${m.instanceId}`)}}}}await Promise.all(Object.keys(i).map(o=>this.updateChatUnreadMessages(o)))},"messages.update")});a(this,"groupHandler",{"groups.upsert":l(e=>{this.sendDataWebhook(R.GROUPS_UPSERT,e)},"groups.upsert"),"groups.update":l(e=>{this.sendDataWebhook(R.GROUPS_UPDATE,e),e.forEach(t=>{(0,k.isJidGroup)(t.id)&&this.updateGroupMetadataCache(t.id)})},"groups.update"),"group-participants.update":l(async e=>{let t=l(i=>String(i||"").split("@")[0],"normalizePhoneNumber");try{let i=await this.findParticipants({groupJid:e.id});if(!i?.participants||!Array.isArray(i.participants))throw new Error("Invalid participant data received from findParticipants");let o=e.participants.map(r=>{let c=i.participants.find(u=>u.id===r),p;return c?.phoneNumber?p=c.phoneNumber:p=t(r),{jid:r,phoneNumber:p,name:c?.name,imgUrl:c?.imgUrl}}),n={...e,participants:e.participants,participantsData:o};this.sendDataWebhook(R.GROUP_PARTICIPANTS_UPDATE,n)}catch(i){this.logger.error(`Failed to resolve participant data for GROUP_PARTICIPANTS_UPDATE webhook: ${i.message} | Group: ${e.id} | Participants: ${e.participants.length}`),this.sendDataWebhook(R.GROUP_PARTICIPANTS_UPDATE,e)}this.updateGroupMetadataCache(e.id)},"group-participants.update")});a(this,"labelHandle",{[R.LABELS_EDIT]:async e=>{this.sendDataWebhook(R.LABELS_EDIT,{...e,instance:this.instance.name});let i=(await this.prismaRepository.label.findMany({where:{instanceId:this.instanceId}})).find(n=>n.labelId===e.id);if(e.deleted&&i){await this.prismaRepository.label.delete({where:{labelId_instanceId:{instanceId:this.instanceId,labelId:e.id}}}),this.sendDataWebhook(R.LABELS_EDIT,{...e,instance:this.instance.name});return}let o=e.name.replace(/[^\x20-\x7E]/g,"");if((!i||i.color!==`${e.color}`||i.name!==o)&&this.configService.get("DATABASE").SAVE_DATA.LABELS){let n={color:`${e.color}`,name:o,labelId:e.id,predefinedId:e.predefinedId,instanceId:this.instanceId};await this.prismaRepository.label.upsert({where:{labelId_instanceId:{instanceId:n.instanceId,labelId:n.labelId}},update:n,create:n})}},[R.LABELS_ASSOCIATION]:async(e,t)=>{if(this.logger.info(`labels association - ${e?.association?.chatId} (${e.type}-${e?.association?.type}): ${e?.association?.labelId}`),t.SAVE_DATA.CHATS){let i=this.instanceId,o=e.association.chatId,n=e.association.labelId;e.type==="add"?await this.addLabel(n,i,o):e.type==="remove"&&await this.removeLabel(n,i,o)}this.sendDataWebhook(R.LABELS_ASSOCIATION,{instance:this.instance.name,type:e.type,chatId:e.association.chatId,labelId:e.association.labelId})}});a(this,"mapType",new Map([["reply","quick_reply"],["copy","cta_copy"],["url","cta_url"],["call","cta_call"],["pix","payment_info"]]));a(this,"mapKeyType",new Map([["phone","PHONE"],["email","EMAIL"],["cpf","CPF"],["cnpj","CNPJ"],["random","EVP"]]));a(this,"getGroupMetadataCache",l(async e=>{if(!(0,k.isJidGroup)(e))return null;let t=this.configService.get("CACHE");if(t?.REDIS?.ENABLED&&t?.REDIS?.URI!==""||t?.LOCAL?.ENABLED){if(await Wr?.has(e)){console.log(`Cache request for group: ${e}`);let i=await Wr.get(e);return Date.now()-i.timestamp>36e5&&await this.updateGroupMetadataCache(e),i.data}return console.log(`Cache request for group: ${e} - not found`),await this.updateGroupMetadataCache(e)}return await this.findGroup({groupJid:e},"inner")},"getGroupMetadataCache"));this.configService=e,this.eventEmitter=t,this.prismaRepository=i,this.cache=o,this.chatwootCache=n,this.baileysCache=r,this.providerFiles=c,this.instance.qrcode={count:0},this.messageProcessor.mount({onMessageReceive:this.messageHandle["messages.upsert"].bind(this)}),this.authStateProvider=new si(this.providerFiles),this.logBaileys=this.configService.get("LOG").BAILEYS}get connectionStatus(){return this.stateConnection}async logoutInstance(){this.messageProcessor.onDestroy(),await this.client?.logout("Log out instance: "+this.instanceName),this.client?.ws?.close();let e=this.configService.get("DATABASE"),t=this.configService.get("CACHE");this.configService.get("PROVIDER")?.ENABLED&&await(await this.authStateProvider.authStateProvider(this.instance.id)).removeCreds(),t?.REDIS.ENABLED&&t?.REDIS.SAVE_INSTANCES&&await(await Ur(this.instance.id,this.cache)).removeCreds(),e.SAVE_DATA.INSTANCE&&await(await ti(this.instance.id,this.cache)).removeCreds(),await this.prismaRepository.session.findFirst({where:{sessionId:this.instanceId}})&&await this.prismaRepository.session.delete({where:{sessionId:this.instanceId}})}async getProfileName(){let e=this.client.user?.name??this.client.user?.verifiedName;if(!e){let t=await this.prismaRepository.session.findUnique({where:{sessionId:this.instanceId}});if(t){let i=JSON.parse(JSON.stringify(t.creds),k.BufferJSON.reviver);e=i.me?.name||i.me?.verifiedName}}return e}async getProfileStatus(){return(await this.client.fetchStatus(this.instance.wuid))[0]?.status}get profilePictureUrl(){return this.instance.profilePictureUrl}get qrCode(){return{pairingCode:this.instance.qrcode?.pairingCode,code:this.instance.qrcode?.code,base64:this.instance.qrcode?.base64,count:this.instance.qrcode?.count}}async connectionUpdate({qr:e,connection:t,lastDisconnect:i}){if(e){if(this.instance.qrcode.count===this.configService.get("QRCODE").LIMIT)return this.sendDataWebhook(R.QRCODE_UPDATED,{message:"QR code limit reached, please login again",statusCode:k.DisconnectReason.badSession}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp(R.QRCODE_UPDATED,{instanceName:this.instance.name,instanceId:this.instanceId},{message:"QR code limit reached, please login again",statusCode:k.DisconnectReason.badSession}),this.sendDataWebhook(R.CONNECTION_UPDATE,{instance:this.instance.name,state:"refused",statusReason:k.DisconnectReason.connectionClosed,wuid:this.instance.wuid,profileName:await this.getProfileName(),profilePictureUrl:this.instance.profilePictureUrl}),this.endSession=!0,this.eventEmitter.emit("no.connection",this.instance.name);this.instance.qrcode.count++;let n={margin:3,scale:4,errorCorrectionLevel:"H",color:{light:"#ffffff",dark:this.configService.get("QRCODE").COLOR}};this.phoneNumber?(await(0,k.delay)(1e3),this.instance.qrcode.pairingCode=await this.client.requestPairingCode(this.phoneNumber)):this.instance.qrcode.pairingCode=null,Lp.default.toDataURL(e,n,(r,c)=>{if(r){this.logger.error("Qrcode generate failed:"+r.toString());return}this.instance.qrcode.base64=c,this.instance.qrcode.code=e,this.sendDataWebhook(R.QRCODE_UPDATED,{qrcode:{instance:this.instance.name,pairingCode:this.instance.qrcode.pairingCode,code:e,base64:c}}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp(R.QRCODE_UPDATED,{instanceName:this.instance.name,instanceId:this.instanceId},{qrcode:{instance:this.instance.name,pairingCode:this.instance.qrcode.pairingCode,code:e,base64:c}})}),Bp.default.generate(e,{small:!0},r=>this.logger.log(`
{ instance: ${this.instance.name} pairingCode: ${this.instance.qrcode.pairingCode}, qrcodeCount: ${this.instance.qrcode.count} }
`+r)),await this.prismaRepository.instance.update({where:{id:this.instanceId},data:{connectionStatus:"connecting"}})}if(t&&(this.stateConnection={state:t,statusReason:i?.error?.output?.statusCode??200}),t==="close"){let o=i?.error?.output?.statusCode;![k.DisconnectReason.loggedOut,k.DisconnectReason.forbidden,402,406].includes(o)?await this.connectToWhatsapp(this.phoneNumber):(this.sendDataWebhook(R.STATUS_INSTANCE,{instance:this.instance.name,status:"closed",disconnectionAt:new Date,disconnectionReasonCode:o,disconnectionObject:JSON.stringify(i)}),await this.prismaRepository.instance.update({where:{id:this.instanceId},data:{connectionStatus:"close",disconnectionAt:new Date,disconnectionReasonCode:o,disconnectionObject:JSON.stringify(i)}}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp(R.STATUS_INSTANCE,{instanceName:this.instance.name,instanceId:this.instanceId},{instance:this.instance.name,status:"closed"}),this.eventEmitter.emit("logout.instance",this.instance.name,"inner"),this.client?.ws?.close(),this.client.end(new Error("Close connection")),this.sendDataWebhook(R.CONNECTION_UPDATE,{instance:this.instance.name,...this.stateConnection}))}if(t==="open"){this.instance.wuid=this.client.user.id.replace(/:\d+/,"");try{let r=await this.profilePicture(this.instance.wuid);this.instance.profilePictureUrl=r.profilePictureUrl}catch{this.instance.profilePictureUrl=null}let o=this.instance.wuid.split("@")[0].padEnd(30," "),n=this.instance.name;this.logger.info(`
        \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510
        \u2502    CONNECTED TO WHATSAPP     \u2502
        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518`.replace(/^ +/gm,"  ")),this.logger.info(`
        wuid: ${o}
        name: ${n}
      `),await this.prismaRepository.instance.update({where:{id:this.instanceId},data:{ownerJid:this.instance.wuid,profileName:await this.getProfileName(),profilePicUrl:this.instance.profilePictureUrl,connectionStatus:"open"}}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&(this.chatwootService.eventWhatsapp(R.CONNECTION_UPDATE,{instanceName:this.instance.name,instanceId:this.instanceId},{instance:this.instance.name,status:"open"}),this.syncChatwootLostMessages()),this.sendDataWebhook(R.CONNECTION_UPDATE,{instance:this.instance.name,wuid:this.instance.wuid,profileName:await this.getProfileName(),profilePictureUrl:this.instance.profilePictureUrl,...this.stateConnection})}t==="connecting"&&this.sendDataWebhook(R.CONNECTION_UPDATE,{instance:this.instance.name,...this.stateConnection})}async getMessage(e,t=!1){try{let i=await this.prismaRepository.$queryRaw`
        SELECT * FROM "Message"
        WHERE "instanceId" = ${this.instanceId}
        AND "key"->>'id' = ${e.id}
      `;if(t)return i[0];if(i[0].message?.pollCreationMessage){let o=i[0].message?.messageContextInfo?.messageSecret;if(typeof o=="string")return{messageContextInfo:{messageSecret:Buffer.from(o,"base64")},pollCreationMessage:i[0].message?.pollCreationMessage}}return i[0].message}catch{return{conversation:""}}}async defineAuthState(){let e=this.configService.get("DATABASE"),t=this.configService.get("CACHE");if(this.configService.get("PROVIDER")?.ENABLED)return await this.authStateProvider.authStateProvider(this.instance.id);if(t?.REDIS.ENABLED&&t?.REDIS.SAVE_INSTANCES)return this.logger.info("Redis enabled"),await Ur(this.instance.id,this.cache);if(e.SAVE_DATA.INSTANCE)return await ti(this.instance.id,this.cache)}async createClient(e){this.instance.authState=await this.defineAuthState();let t=this.configService.get("CONFIG_SESSION_PHONE"),i={};if(e||this.phoneNumber)this.phoneNumber=e,this.logger.info(`Phone number: ${e}`);else{let u=[t.CLIENT,t.NAME,(0,Dp.release)()];i={browser:u},this.logger.info(`Browser: ${u}`)}let n=(await Zs({})).version,r=`Baileys version: ${n.join(".")}`;this.logger.info(r),this.logger.info(`Group Ignore: ${this.localSettings.groupsIgnore}`);let c;if(this.localProxy?.enabled)if(this.logger.info("Proxy enabled: "+this.localProxy?.host),this.localProxy?.host?.includes("proxyscrape"))try{let f=(await Be.default.get(this.localProxy?.host)).data.split(`\r
`),g=Math.floor(Math.random()*Math.floor(f.length)),y="http://"+f[g];c={agent:ke(y),fetchAgent:Gn(y)}}catch{this.localProxy.enabled=!1}else c={agent:ke({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password}),fetchAgent:Gn({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})};let p={...c,version:n,logger:(0,it.default)({level:this.logBaileys}),printQRInTerminal:!1,auth:{creds:this.instance.authState.state.creds,keys:(0,k.makeCacheableSignalKeyStore)(this.instance.authState.state.keys,(0,it.default)({level:"error"}))},msgRetryCounterCache:this.msgRetryCounterCache,generateHighQualityLinkPreview:!0,getMessage:l(async u=>await this.getMessage(u),"getMessage"),...i,markOnlineOnConnect:this.localSettings.alwaysOnline,retryRequestDelayMs:350,maxMsgRetryCount:4,fireInitQueries:!0,connectTimeoutMs:3e4,keepAliveIntervalMs:3e4,qrTimeout:45e3,emitOwnEvents:!1,shouldIgnoreJid:l(u=>{if(this.localSettings.syncFullHistory&&(0,k.isJidGroup)(u))return!1;let d=this.localSettings.groupsIgnore&&(0,k.isJidGroup)(u),f=!this.localSettings.readStatus&&(0,k.isJidBroadcast)(u),g=(0,k.isJidNewsletter)(u);return d||f||g},"shouldIgnoreJid"),syncFullHistory:this.localSettings.syncFullHistory,shouldSyncHistoryMessage:l(u=>this.historySyncNotification(u),"shouldSyncHistoryMessage"),cachedGroupMetadata:this.getGroupMetadataCache,userDevicesCache:this.userDevicesCache,transactionOpts:{maxCommitRetries:10,delayBetweenTriesMs:3e3},patchMessageBeforeSending(u){return u.deviceSentMessage?.message?.listMessage?.listType===k.proto.Message.ListMessage.ListType.PRODUCT_LIST&&(u=JSON.parse(JSON.stringify(u)),u.deviceSentMessage.message.listMessage.listType=k.proto.Message.ListMessage.ListType.SINGLE_SELECT),u.listMessage?.listType==k.proto.Message.ListMessage.ListType.PRODUCT_LIST&&(u=JSON.parse(JSON.stringify(u)),u.listMessage.listType=k.proto.Message.ListMessage.ListType.SINGLE_SELECT),u}};return this.endSession=!1,this.client=(0,k.default)(p),this.localSettings.wavoipToken&&this.localSettings.wavoipToken.length>0&&Rp(this.localSettings.wavoipToken,this.client,this.connectionStatus.state,!0),this.eventHandler(),this.client.ws.on("CB:call",u=>{console.log("CB:call",u);let d={event:"CB:call",packet:u};this.sendDataWebhook(R.CALL,d,!0,["websocket"])}),this.client.ws.on("CB:ack,class:call",u=>{console.log("CB:ack,class:call",u);let d={event:"CB:ack,class:call",packet:u};this.sendDataWebhook(R.CALL,d,!0,["websocket"])}),this.phoneNumber=e,this.client}async connectToWhatsapp(e){try{return this.loadChatwoot(),this.loadSettings(),this.loadWebhook(),this.loadProxy(),this.messageProcessor.mount({onMessageReceive:this.messageHandle["messages.upsert"].bind(this)}),await this.createClient(e)}catch(t){throw this.logger.error(t),new $(t?.toString())}}async reloadConnection(){try{return await this.createClient(this.phoneNumber)}catch(e){throw this.logger.error(e),new $(e?.toString())}}eventHandler(){this.client.ev.process(async e=>{this.eventProcessingQueue=this.eventProcessingQueue.then(async()=>{try{if(!this.endSession){let t=this.configService.get("DATABASE"),i=await this.findSettings();if(e.call){let o=e.call[0];if(i?.rejectCall&&o.status=="offer"&&this.client.rejectCall(o.id,o.from),i?.msgCall?.trim().length>0&&o.status=="offer"){o.from.endsWith("@lid")&&(o.from=await this.client.signalRepository.lidMapping.getPNForLID(o.from));let n=await this.client.sendMessage(o.from,{text:i.msgCall});this.client.ev.emit("messages.upsert",{messages:[n],type:"notify"})}this.sendDataWebhook(R.CALL,o)}if(e["connection.update"]&&this.connectionUpdate(e["connection.update"]),e["creds.update"]&&this.instance.authState.saveCreds(),e["messaging-history.set"]){let o=e["messaging-history.set"];await this.messageHandle["messaging-history.set"](o)}if(e["messages.upsert"]){let o=e["messages.upsert"];await this.messageHandle["messages.upsert"](o,i)}if(e["messages.update"]){let o=e["messages.update"];await this.messageHandle["messages.update"](o,i)}if(e["message-receipt.update"]){let o=e["message-receipt.update"],n={};for(let r of o)typeof r.key.remoteJid=="string"&&typeof r.receipt.readTimestamp=="number"&&(n[r.key.remoteJid]=r.receipt.readTimestamp);await Promise.all(Object.keys(n).map(async r=>this.updateMessagesReadedByTimestamp(r,n[r])))}if(e["presence.update"]){let o=e["presence.update"];if(i?.groupsIgnore&&o.id.includes("@g.us"))return;this.sendDataWebhook(R.PRESENCE_UPDATE,o)}if(!i?.groupsIgnore){if(e["groups.upsert"]){let o=e["groups.upsert"];this.groupHandler["groups.upsert"](o)}if(e["groups.update"]){let o=e["groups.update"];this.groupHandler["groups.update"](o)}if(e["group-participants.update"]){let o=e["group-participants.update"];this.groupHandler["group-participants.update"](o)}}if(e["chats.upsert"]){let o=e["chats.upsert"];this.chatHandle["chats.upsert"](o)}if(e["chats.update"]){let o=e["chats.update"];this.chatHandle["chats.update"](o)}if(e["chats.delete"]){let o=e["chats.delete"];this.chatHandle["chats.delete"](o)}if(e["contacts.upsert"]){let o=e["contacts.upsert"];this.contactHandle["contacts.upsert"](o)}if(e["contacts.update"]){let o=e["contacts.update"];this.contactHandle["contacts.update"](o)}if(e[R.LABELS_ASSOCIATION]){let o=e[R.LABELS_ASSOCIATION];this.labelHandle[R.LABELS_ASSOCIATION](o,t);return}if(e[R.LABELS_EDIT]){let o=e[R.LABELS_EDIT];this.labelHandle[R.LABELS_EDIT](o);return}}}catch(t){this.logger.error(t)}})})}historySyncNotification(e){let t={instanceName:this.instance.name};return this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.localChatwoot.importMessages&&this.isSyncNotificationFromUsedSyncType(e)&&(e.chunkOrder===1&&this.chatwootService.startImportHistoryMessages(t),e.progress===100&&setTimeout(()=>{this.chatwootService.importHistoryMessages(t)},1e4)),!0}isSyncNotificationFromUsedSyncType(e){return this.localSettings.syncFullHistory&&e?.syncType===2||!this.localSettings.syncFullHistory&&e?.syncType===3}async profilePicture(e){let t=K(e);try{let i=await this.client.profilePictureUrl(t,"image");return{wuid:t,profilePictureUrl:i}}catch{return{wuid:t,profilePictureUrl:null}}}async getStatus(e){let t=K(e);try{return{wuid:t,status:(await this.client.fetchStatus(t))[0]?.status}}catch{return{wuid:t,status:null}}}async fetchProfile(e,t){let i=t?K(t):this.client?.user?.id,o=(await this.whatsappNumber({numbers:[i]}))?.shift();if(!o.exists)throw new w(o);try{if(t){let n=(await this.whatsappNumber({numbers:[i]}))?.shift(),r=await this.profilePicture(n?.jid),c=await this.getStatus(n?.jid),p=await this.fetchBusinessProfile(n?.jid);return{wuid:n?.jid||i,name:n?.name,numberExists:n?.exists,picture:r?.profilePictureUrl,status:c?.status,isBusiness:p.isBusiness,email:p?.email,description:p?.description,website:p?.website?.shift()}}else{let n=e?[e]:null,r=await U.instanceInfo(n),c=await this.fetchBusinessProfile(i);return{wuid:i,name:r?.profileName,numberExists:!0,picture:r?.profilePicUrl,status:r?.connectionStatus,isBusiness:c.isBusiness,email:c?.email,description:c?.description,website:c?.website?.shift()}}}catch{return{wuid:i,name:null,picture:null,status:null,os:null,isBusiness:!1}}}async offerCall({number:e,isVideo:t,callDuration:i}){let o=K(e);try{return{id:"123",jid:o,isVideo:t,callDuration:i}}catch(n){return n}}async sendMessage(e,t,i,o,n,r,c,p){e=e.toLowerCase();let u={quoted:n};if((0,k.isJidGroup)(e)&&(u.useCachedGroupMetadata=!0),c&&(u.ephemeralExpiration=c),r&&(u.messageId=r),t.viewOnceMessage){let d=(0,k.generateWAMessageFromContent)(e,t,{timestamp:new Date,userJid:this.instance.wuid,messageId:r,quoted:n}),f=await this.client.relayMessage(e,t,{messageId:r});d.key={id:f,remoteJid:e,participant:(0,k.isPnUser)(e)?e:void 0,fromMe:!0};for(let[g,y]of Object.entries(d))(!y||((0,ee.isArray)(y)&&y.length)===0)&&delete d[g];return d}if(!t.audio&&!t.poll&&!t.sticker&&!t.conversation&&e!=="status@broadcast"&&t.reactionMessage)return await this.client.sendMessage(e,{react:{text:t.reactionMessage.text,key:t.reactionMessage.key}},u);if(p&&(t.contextInfo=p),t.conversation)return await this.client.sendMessage(e,{text:t.conversation,mentions:i,linkPreview:o,contextInfo:t.contextInfo},u);if(!t.audio&&!t.poll&&!t.sticker&&e!="status@broadcast")return await this.client.sendMessage(e,{forward:{key:{remoteJid:this.instance.wuid,fromMe:!0},message:t},mentions:i,contextInfo:t.contextInfo},u);if(e==="status@broadcast"){let d;t.status.option.allContacts?d=(await this.prismaRepository.contact.findMany({where:{instanceId:this.instanceId,remoteJid:{not:{endsWith:"@g.us"}}}})).map(A=>A.remoteJid):d=t.status.option.statusJidList;let f=10,g=Array.from({length:Math.ceil(d.length/f)},(T,A)=>d.slice(A*f,A*f+f)),y=null,m,S=g.shift();return S&&(m=await this.client.sendMessage(e,t.status.content,{backgroundColor:t.status.option.backgroundColor,font:t.status.option.font,statusJidList:S}),y=m.key.id),g.length===0||await Promise.allSettled(g.map(async T=>await this.client.sendMessage(e,t.status.content,{backgroundColor:t.status.option.backgroundColor,font:t.status.option.font,statusJidList:T,messageId:y}))),m}return await this.client.sendMessage(e,t,u)}async sendMessageWithTyping(e,t,i,o=!1){let n=(await this.whatsappNumber({numbers:[e]}))?.shift();if(!n.exists&&!(0,k.isJidGroup)(n.jid)&&!n.jid.includes("@broadcast"))throw new w(n);let r=n.jid.toLowerCase();this.logger.verbose(`Sending message to ${r}`);try{if(i?.delay)if(this.logger.verbose(`Typing for ${i.delay}ms to ${r}`),i.delay>2e4){let S=i.delay;for(;S>2e4;)await this.client.presenceSubscribe(r),await this.client.sendPresenceUpdate(i.presence??"composing",r),await(0,k.delay)(2e4),await this.client.sendPresenceUpdate("paused",r),S-=2e4;S>0&&(await this.client.presenceSubscribe(r),await this.client.sendPresenceUpdate(i.presence??"composing",r),await(0,k.delay)(S),await this.client.sendPresenceUpdate("paused",r))}else await this.client.presenceSubscribe(r),await this.client.sendPresenceUpdate(i.presence??"composing",r),await(0,k.delay)(i.delay),await this.client.sendPresenceUpdate("paused",r);let c=i?.linkPreview!=!1?void 0:!1,p;if(i?.quoted){let S=i?.quoted,T=S?.message?S:await this.getMessage(S.key,!0);T&&(p=T)}let u,d,f;if((0,k.isJidGroup)(r)){let S;try{let T=this.configService.get("CACHE");!T.REDIS.ENABLED&&!T.LOCAL.ENABLED?S=await this.findGroup({groupJid:r},"inner"):S=await this.getGroupMetadataCache(r)}catch{throw new G("Group not found")}if(!S)throw new G("Group not found");i?.mentionsEveryOne?d=S.participants.map(T=>T.id):i?.mentioned?.length&&(d=i.mentioned.map(T=>{let A=K(T);return(0,k.isJidGroup)(A)?null:A})),u=await this.sendMessage(r,t,d,c,p,null,S?.ephemeralDuration)}else f={mentionedJid:[],groupMentions:[],ephemeralSettingTimestamp:{low:Math.floor(Date.now()/1e3)-172800,high:0,unsigned:!1},disappearingMode:{initiator:0}},u=await this.sendMessage(r,t,d,c,p,null,void 0,f);Rt.default.isLong(u?.messageTimestamp)&&(u.messageTimestamp=u.messageTimestamp?.toNumber());let g=this.prepareMessage(u),y=u?.message?.imageMessage||u?.message?.videoMessage||u?.message?.stickerMessage||u?.message?.ptvMessage||u?.message?.documentMessage||u?.message?.documentWithCaptionMessage||u?.message?.ptvMessage||u?.message?.audioMessage,m=u?.message?.videoMessage;if(this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&!o&&this.chatwootService.eventWhatsapp(R.SEND_MESSAGE,{instanceName:this.instance.name,instanceId:this.instanceId},g),this.configService.get("OPENAI").ENABLED&&g?.message?.audioMessage){let S=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});S&&S.openaiCredsId&&S.speechToText&&(g.message.speechToText=`[audio] ${await this.openaiService.speechToText(g,this)}`)}if(this.configService.get("DATABASE").SAVE_DATA.NEW_MESSAGE){let S=await this.prismaRepository.message.create({data:g});if(y&&this.configService.get("S3").ENABLE)try{if(m&&!this.configService.get("S3").SAVE_VIDEO)throw new Error("Video upload is disabled.");let T=g;if(!this.hasValidMediaContent(T))this.logger.warn("Message detected as media but contains no valid media content");else{let N=await this.getBase64FromMediaMessage({message:T},!0);if(!N){this.logger.verbose("No valid media to upload (messageContextInfo only), skipping MinIO");return}let{buffer:I,mediaType:C,fileName:M,size:v}=N,L=Ot.default.lookup(M).toString(),B=(0,Gr.join)(`${this.instance.id}`,g.key.remoteJid,`${g.key.id}`,C,M);await We(B,I,v.fileLength?.low,{"Content-Type":L}),await this.prismaRepository.media.create({data:{messageId:S.id,instanceId:this.instanceId,type:C,fileName:B,mimetype:L}});let W=await Pe(B);g.message.mediaUrl=W,await this.prismaRepository.message.update({where:{id:S.id},data:g})}}catch(T){this.logger.error(["Error on upload file to minio",T?.message,T?.stack])}}if(this.localWebhook.enabled&&y&&this.localWebhook.webhookBase64)try{let S=await(0,k.downloadMediaMessage)({key:g.key,message:g?.message},"buffer",{},{logger:(0,it.default)({level:"error"}),reuploadRequest:this.client.updateMediaMessage});if(S)g.message.base64=S.toString("base64");else{let T=await(0,k.downloadMediaMessage)({key:g.key,message:g?.message},"buffer",{},{logger:(0,it.default)({level:"error"}),reuploadRequest:this.client.updateMediaMessage});T&&(g.message.base64=T.toString("base64"))}}catch(S){this.logger.error(["Error converting media to base64",S?.message])}return this.logger.verbose(u),this.sendDataWebhook(R.SEND_MESSAGE,g),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&o&&await qe.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:g.key.remoteJid,msg:g,pushName:g.pushName,isIntegration:o}),g}catch(c){throw this.logger.error(c),new w(c.toString())}}async sendPresence(e){try{let{number:t}=e,i=(await this.whatsappNumber({numbers:[t]}))?.shift();if(!i.exists&&!(0,k.isJidGroup)(i.jid)&&!i.jid.includes("@broadcast"))throw new w(i);let o=i.jid;if(e?.delay&&e?.delay>2e4){let n=e?.delay;for(;n>2e4;)await this.client.presenceSubscribe(o),await this.client.sendPresenceUpdate(e?.presence??"composing",o),await(0,k.delay)(2e4),await this.client.sendPresenceUpdate("paused",o),n-=2e4;n>0&&(await this.client.presenceSubscribe(o),await this.client.sendPresenceUpdate(e?.presence??"composing",o),await(0,k.delay)(n),await this.client.sendPresenceUpdate("paused",o))}else await this.client.presenceSubscribe(o),await this.client.sendPresenceUpdate(e?.presence??"composing",o),await(0,k.delay)(e?.delay),await this.client.sendPresenceUpdate("paused",o);return{presence:e.presence}}catch(t){throw this.logger.error(t),new w(t.toString())}}async setPresence(e){try{return await this.client.sendPresenceUpdate(e.presence),{presence:e.presence}}catch(t){throw this.logger.error(t),new w(t.toString())}}async textMessage(e,t=!1){let i=e.text;if(!i||i.trim().length===0)throw new w("Text is required");return await this.sendMessageWithTyping(e.number,{conversation:e.text},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async pollMessage(e){return await this.sendMessageWithTyping(e.number,{poll:{name:e.name,selectableCount:e.selectableCount,values:e.values}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async formatStatusMessage(e){if(!e.type)throw new w("Type is required");if(!e.content)throw new w("Content is required");if(e.allContacts){let t=await this.prismaRepository.contact.findMany({where:{instanceId:this.instanceId}});if(!t.length)throw new w("Contacts not found");e.statusJidList=t.filter(i=>i.pushName).map(i=>i.remoteJid)}if(!e.statusJidList?.length&&!e.allContacts)throw new w("StatusJidList is required");if(e.type==="text"){if(!e.backgroundColor)throw new w("Background color is required");if(!e.font)throw new w("Font is required");return{content:{text:e.content},option:{backgroundColor:e.backgroundColor,font:e.font,statusJidList:e.statusJidList}}}if(e.type==="image")return{content:{image:{url:e.content},caption:e.caption},option:{statusJidList:e.statusJidList}};if(e.type==="video")return{content:{video:{url:e.content},caption:e.caption},option:{statusJidList:e.statusJidList}};if(e.type==="audio"){let t=await this.processAudioMp4(e.content);if(Buffer.isBuffer(t))return{content:{audio:t,ptt:!0,mimetype:"audio/ogg; codecs=opus"},option:{statusJidList:e.statusJidList}};throw new $(t)}throw new w("Type not found")}async statusMessage(e,t){let i={...e};t&&(i.content=t.buffer.toString("base64"));let o=await this.formatStatusMessage(i);return await this.sendMessageWithTyping("status@broadcast",{status:o})}async prepareMediaMessage(e){try{let t=e.mediatype==="ptv"?"video":e.mediatype,i;if(e.mediatype==="image"){let c;if((0,ee.isURL)(e.media)){let p={responseType:"arraybuffer"};this.localProxy?.enabled&&(p={...p,httpsAgent:ke({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})});let u=await Be.default.get(e.media,p);c=Buffer.from(u.data,"binary")}else c=Buffer.from(e.media,"base64");i=await(0,ri.default)(c).jpeg().toBuffer(),e.fileName??(e.fileName="image.jpg"),e.mimetype="image/jpeg"}else i=(0,ee.isURL)(e.media)?{url:e.media}:Buffer.from(e.media,"base64");let o=await(0,k.prepareWAMessageMedia)({[t]:i},{upload:this.client.waUploadToServer}),n=e.mediatype+"Message";if(e.mediatype==="document"&&!e.fileName){let p=new RegExp(/.*\/(.+?)\./).exec(e.media);e.fileName=p[1]}e.mediatype==="image"&&!e.fileName&&(e.fileName="image.jpg"),e.mediatype==="video"&&!e.fileName&&(e.fileName="video.mp4");let r;if(e.mimetype)r=e.mimetype;else if(r=Ot.default.lookup(e.fileName),!r&&(0,ee.isURL)(e.media)){let c={responseType:"arraybuffer"};this.localProxy?.enabled&&(c={...c,httpsAgent:ke({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})}),r=(await Be.default.get(e.media,c)).headers["content-type"]}if(e.mediatype==="ptv"){if(o[n]=o[t+"Message"],r="video/mp4",!o[n])throw new Error("Failed to prepare video message");try{let c;if((0,ee.isURL)(e.media))c=e.media;else{let u=Buffer.from(e.media,"base64");if(!u||u.length===0)throw new Error("Invalid media buffer");c=u}let p=await pm(c);if(!p||p<=0)throw new Error("Invalid media duration");this.logger.verbose(`Video duration: ${p} seconds`),o[n].seconds=p}catch(c){throw this.logger.error("Error getting video duration:"),this.logger.error(c),new Error(`Failed to get video duration: ${c.message}`)}}return e?.fileName&&(r=Ot.default.lookup(e.fileName).toString(),r==="application/mp4"&&(r="video/mp4")),o[n].caption=e?.caption,o[n].mimetype=r,o[n].fileName=e.fileName,e.mediatype==="video"&&(o[n].gifPlayback=!1),(0,k.generateWAMessageFromContent)("",{[n]:{...o[n]}},{userJid:this.instance.wuid})}catch(t){throw this.logger.error(t),new $(t?.toString()||t)}}async convertToWebP(e){try{let t;if((0,ee.isBase64)(e)){let o=e.replace(/^data:image\/(jpeg|png|gif);base64,/,"");t=Buffer.from(o,"base64")}else{let o=new Date().getTime(),n=new URL(e);n.searchParams.set("timestamp",o.toString());let r=n.toString(),c={responseType:"arraybuffer"};this.localProxy?.enabled&&(c={...c,httpsAgent:ke({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})});let p=await Be.default.get(r,c);t=Buffer.from(p.data,"binary")}return this.isAnimated(e,t)?await(0,ri.default)(t,{animated:!0}).webp({quality:80}).toBuffer():await(0,ri.default)(t).webp().toBuffer()}catch(t){throw console.error("Erro ao converter a imagem para WebP:",t),t}}isAnimatedWebp(e){return e.length<12?!1:e.indexOf(Buffer.from("ANIM"))!==-1}isAnimated(e,t){let i=e.toLowerCase();return i.includes(".gif")?!0:i.includes(".webp")?this.isAnimatedWebp(t):!1}async mediaSticker(e,t){let i={...e};t&&(i.sticker=t.buffer.toString("base64"));let o=e?.notConvertSticker?Buffer.from(e.sticker,"base64"):await this.convertToWebP(e.sticker),n=e.sticker.includes(".gif");return await this.sendMessageWithTyping(e.number,{sticker:o,gifPlayback:n},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async mediaMessage(e,t,i=!1){let o={...e};t&&(o.media=t.buffer.toString("base64"));let n=await this.prepareMediaMessage(o);return await this.sendMessageWithTyping(e.number,{...n.message},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},i)}async ptvMessage(e,t,i=!1){let o={number:e.number,media:e.video,mediatype:"ptv",delay:e?.delay,quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned};t&&(o.media=t.buffer.toString("base64"));let n=await this.prepareMediaMessage(o);return await this.sendMessageWithTyping(e.number,{...n.message},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},i)}async processAudioMp4(e){let t;if((0,ee.isURL)(e))t=(await Be.default.get(e,{responseType:"stream"})).data;else{let i=Buffer.from(e,"base64");t=new dt.PassThrough,t.end(i)}return new Promise((i,o)=>{let n=(0,Op.spawn)(Jr.default.path,["-i","pipe:0","-vn","-ab","128k","-ar","44100","-f","mp4","-movflags","frag_keyframe+empty_moov","pipe:1"]),r=[],c="";n.stdout.on("data",p=>{r.push(p)}),n.stderr.on("data",p=>{c+=p.toString(),this.logger.verbose(`ffmpeg stderr: ${p}`)}),n.on("error",p=>{console.error("Error in ffmpeg process",p),o(p)}),n.on("close",p=>{if(p===0){this.logger.verbose("Audio converted to mp4");let u=Buffer.concat(r);i(u)}else this.logger.error(`ffmpeg exited with code ${p}`),this.logger.error(`ffmpeg stderr: ${c}`),o(new Error(`ffmpeg exited with code ${p}: ${c}`))}),t.pipe(n.stdin),t.on("error",p=>{console.error("Error in inputStream",p),n.stdin.end(),o(p)})})}async processAudio(e){let t=this.configService.get("AUDIO_CONVERTER");if(t.API_URL){this.logger.verbose("Using audio converter API");let i=new xp.default;(0,ee.isURL)(e)?i.append("url",e):i.append("base64",e);let{data:o}=await Be.default.post(t.API_URL,i,{headers:{...i.getHeaders(),apikey:t.API_KEY}});if(!o.audio)throw new $("Failed to convert audio");return this.logger.verbose("Audio converted"),Buffer.from(o.audio,"base64")}else{let i;if((0,ee.isURL)(e)){let n=new Date().getTime(),r=new URL(e);r.searchParams.set("timestamp",n.toString());let c=r.toString(),p={responseType:"stream"};i=(await Be.default.get(c,p)).data.pipe(new dt.PassThrough)}else{let n=Buffer.from(e,"base64");i=new dt.PassThrough,i.end(n)}let o=(0,ee.isURL)(e)&&/\.lpcm($|\?)/i.test(e);return new Promise((n,r)=>{let c=new dt.PassThrough,p=[];c.on("data",d=>p.push(d)),c.on("end",()=>{let d=Buffer.concat(p);n(d)}),c.on("error",d=>{console.log("error",d),r(d)}),qr.default.setFfmpegPath(Jr.default.path);let u=(0,qr.default)(i);o&&(this.logger.verbose("Detected LPCM input \u2013 applying raw PCM settings"),u=u.inputFormat("s16le").inputOptions(["-ar","24000","-ac","1"])),u.outputFormat("ogg").noVideo().audioCodec("libopus").addOutputOptions("-avoid_negative_ts make_zero").audioBitrate("128k").audioFrequency(48e3).audioChannels(1).outputOptions(["-write_xing","0","-compression_level","10","-application","voip","-fflags","+bitexact","-flags","+bitexact","-id3v2_version","0","-map_metadata","-1","-map_chapters","-1","-write_bext","0"]).pipe(c,{end:!0}).on("error",function(d){console.log("error",d),r(d)})})}}async audioWhatsapp(e,t,i=!1){let o={...e};if(t?.buffer)o.audio=t.buffer.toString("base64");else if(!(0,ee.isURL)(e.audio)&&!(0,ee.isBase64)(e.audio))throw console.error("Invalid file or audio source"),new w("File buffer, URL, or base64 audio is required");if(!e?.encoding&&e?.encoding!==!1&&(e.encoding=!0),e?.encoding){let n=await this.processAudio(o.audio);if(Buffer.isBuffer(n))return this.sendMessageWithTyping(e.number,{audio:n,ptt:!0,mimetype:"audio/ogg; codecs=opus"},{presence:"recording",delay:e?.delay},i);throw new $("Failed to convert audio")}return await this.sendMessageWithTyping(e.number,{audio:(0,ee.isURL)(e.audio)?{url:e.audio}:Buffer.from(e.audio,"base64"),ptt:!0,mimetype:"audio/ogg; codecs=opus"},{presence:"recording",delay:e?.delay},i)}generateRandomId(e=11){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",i="";for(let o=0;o<e;o++)i+=t.charAt(Math.floor(Math.random()*t.length));return i}toJSONString(e){let t=l(o=>JSON.stringify(o),"toString");return{call:l(()=>t({display_text:e.displayText,phone_number:e.phoneNumber}),"call"),reply:l(()=>t({display_text:e.displayText,id:e.id}),"reply"),copy:l(()=>t({display_text:e.displayText,copy_code:e.copyCode}),"copy"),url:l(()=>t({display_text:e.displayText,url:e.url,merchant_url:e.url}),"url"),pix:l(()=>t({currency:e.currency,total_amount:{value:0,offset:100},reference_id:this.generateRandomId(),type:"physical-goods",order:{status:"pending",subtotal:{value:0,offset:100},order_type:"ORDER",items:[{name:"",amount:{value:0,offset:100},quantity:0,sale_amount:{value:0,offset:100}}]},payment_settings:[{type:"pix_static_code",pix_static_code:{merchant_name:e.name,key:e.key,key_type:this.mapKeyType.get(e.keyType)}}],share_payment_status:!1}),"pix")}[e.type]?.()||""}async buttonMessage(e){if(e.buttons.length===0)throw new w("At least one button is required");let t=e.buttons.some(p=>p.type==="reply"),i=e.buttons.some(p=>p.type==="pix"),o=e.buttons.some(p=>p.type!=="reply"&&p.type!=="pix");if(t){if(e.buttons.length>3)throw new w("Maximum of 3 reply buttons allowed");if(o)throw new w("Reply buttons cannot be mixed with other button types")}if(i){if(e.buttons.length>1)throw new w("Only one PIX button is allowed");if(o)throw new w("PIX button cannot be mixed with other button types");let p={viewOnceMessage:{message:{interactiveMessage:{nativeFlowMessage:{buttons:[{name:this.mapType.get("pix"),buttonParamsJson:this.toJSONString(e.buttons[0])}],messageParamsJson:JSON.stringify({from:"api",templateId:(0,ai.v4)()})}}}}};return await this.sendMessageWithTyping(e.number,p,{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}let n=await(async()=>{if(e?.thumbnailUrl)return await this.prepareMediaMessage({mediatype:"image",media:e.thumbnailUrl})})(),r=e.buttons.map(p=>({name:this.mapType.get(p.type),buttonParamsJson:this.toJSONString(p)})),c={viewOnceMessage:{message:{interactiveMessage:{body:{text:(()=>{let p="*"+e.title+"*";return e?.description&&(p+=`

`,p+=e.description,p+=`
`),p})()},footer:{text:e?.footer},header:(()=>{if(n?.message?.imageMessage)return{hasMediaAttachment:!!n.message.imageMessage,imageMessage:n.message.imageMessage}})(),nativeFlowMessage:{buttons:r,messageParamsJson:JSON.stringify({from:"api",templateId:(0,ai.v4)()})}}}}};return await this.sendMessageWithTyping(e.number,c,{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async locationMessage(e){return await this.sendMessageWithTyping(e.number,{locationMessage:{degreesLatitude:e.latitude,degreesLongitude:e.longitude,name:e?.name,address:e?.address}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async listMessage(e){return await this.sendMessageWithTyping(e.number,{listMessage:{title:e.title,description:e.description,buttonText:e?.buttonText,footerText:e?.footerText,sections:e.sections,listType:2}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async contactMessage(e){let t={},i=l(o=>{let n=`BEGIN:VCARD
VERSION:3.0
N:${o.fullName}
FN:${o.fullName}
`;return o.organization&&(n+=`ORG:${o.organization};
`),o.email&&(n+=`EMAIL:${o.email}
`),o.url&&(n+=`URL:${o.url}
`),o.wuid||(o.wuid=K(o.phoneNumber)),n+=`item1.TEL;waid=${o.wuid}:${o.phoneNumber}
item1.X-ABLabel:Celular
END:VCARD`,n},"vcard");return e.contact.length===1?t.contactMessage={displayName:e.contact[0].fullName,vcard:i(e.contact[0])}:t.contactsArrayMessage={displayName:`${e.contact.length} contacts`,contacts:e.contact.map(o=>({displayName:o.fullName,vcard:i(o)}))},await this.sendMessageWithTyping(e.number,{...t},{})}async reactionMessage(e){return await this.sendMessageWithTyping(e.key.remoteJid,{reactionMessage:{key:e.key,text:e.reaction}})}async whatsappNumber(e){let t={groups:[],broadcast:[],users:[]};e.numbers.forEach(m=>{let S=K(m);(0,k.isJidGroup)(S)?t.groups.push({number:m,jid:S}):S==="status@broadcast"?t.broadcast.push({number:m,jid:S}):t.users.push({number:m,jid:S})});let i=[];i.push(...t.broadcast.map(({jid:m,number:S})=>new Ge(m,!1,S)));let o=await Promise.all(t.groups.map(async({jid:m,number:S})=>{let T=await this.findGroup({groupJid:m},"inner");return T?new Ge(T.id,!0,S,T?.subject):new Ge(m,!1,S)}));i.push(...o);let n=await this.prismaRepository.contact.findMany({where:{instanceId:this.instanceId,remoteJid:{in:t.users.map(({jid:m})=>m)}}}),r=t.users.map(({jid:m})=>m.replace("+","")),c=await Cp(r),p=new Set(c.flatMap(m=>m.jidOptions)),u=r.filter(m=>!p.has(m)),d=[],f=u.filter(m=>!m.includes("@lid"));f.length>0&&(this.logger.verbose(`Checking ${f.length} numbers via Baileys (not found in cache)`),d=await this.client.onWhatsApp(...f));let g=await Promise.all(t.users.map(async m=>{let S=c.find(N=>N.jidOptions.includes(m.jid.replace("+","")));if(S)return this.logger.verbose(`Number ${m.number} found in cache`),new Ge(S.remoteJid,!0,m.number,n.find(N=>N.remoteJid===S.remoteJid)?.pushName,S.lid||(S.remoteJid.includes("@lid")?"lid":void 0));if(m.jid.includes("@lid"))return new Ge(m.jid,!0,m.number,n.find(N=>N.remoteJid===m.jid)?.pushName,"lid");let T=null;if(m.number.startsWith("55")){let N=m.number.slice(4,5)==="9"&&m.number.length===13?m.number:`${m.number.slice(0,4)}9${m.number.slice(4)}`,I=m.number.length===12?m.number:m.number.slice(0,4)+m.number.slice(5);T=d.find(C=>C.jid===`${N}@s.whatsapp.net`||C.jid===`${I}@s.whatsapp.net`)}if(!T&&(m.number.startsWith("52")||m.number.startsWith("54"))){let N="";m.number.startsWith("52")&&(N="1"),m.number.startsWith("54")&&(N="9");let I=m.number.slice(2,3)===N&&m.number.length===13?m.number:`${m.number.slice(0,2)}${N}${m.number.slice(2)}`,C=m.number.length===12?m.number:m.number.slice(0,2)+m.number.slice(3);T=d.find(M=>M.jid===`${I}@s.whatsapp.net`||M.jid===`${C}@s.whatsapp.net`)}T||(T=d.find(N=>N.jid===m.jid));let A=T?.jid||m.jid;return new Ge(A,!!T?.exists,m.number,n.find(N=>N.remoteJid===A)?.pushName,void 0)}));i.push(...g);let y=i.filter(m=>m.exists?!c?.find(T=>T.jidOptions.includes(m.jid.replace("+",""))):!1);return y.length>0&&(this.logger.verbose(`Salvando ${y.length} n\xFAmeros no cache`),await Nt(y.map(m=>({remoteJid:m.jid,lid:m.lid==="lid"?"lid":void 0})))),i}async markMessageAsRead(e){try{let t=[];return e.readMessages.forEach(i=>{((0,k.isJidGroup)(i.remoteJid)||(0,k.isPnUser)(i.remoteJid))&&t.push({remoteJid:i.remoteJid,fromMe:i.fromMe,id:i.id})}),await this.client.readMessages(t),{message:"Read messages",read:"success"}}catch(t){throw new $("Read messages fail",t.toString())}}async getLastMessage(e){let t={key:{remoteJid:e},instanceId:this.instance.id},i=await this.prismaRepository.message.findMany({where:t,orderBy:{messageTimestamp:"desc"},take:1});if(i.length===0)throw new G("Messages not found");let o=i.pop();for(let n of i)n.messageTimestamp>=o.messageTimestamp&&(o=n);return o}async archiveChat(e){try{let t=e.lastMessage,i=e.chat;if(!t&&i?t=await this.getLastMessage(i):(t=e.lastMessage,t.messageTimestamp=t?.messageTimestamp??Date.now(),i=t?.key?.remoteJid),!t||Object.keys(t).length===0)throw new G("Last message not found");return await this.client.chatModify({archive:e.archive,lastMessages:[t]},K(i)),{chatId:i,archived:!0}}catch(t){throw new $({archived:!1,message:["An error occurred while archiving the chat. Open a calling.",t.toString()]})}}async markChatUnread(e){try{let t=e.lastMessage,i=e.chat;if(!t&&i?t=await this.getLastMessage(i):(t=e.lastMessage,t.messageTimestamp=t?.messageTimestamp??Date.now(),i=t?.key?.remoteJid),!t||Object.keys(t).length===0)throw new G("Last message not found");return await this.client.chatModify({markRead:!1,lastMessages:[t]},K(i)),{chatId:i,markedChatUnread:!0}}catch(t){throw new $({markedChatUnread:!1,message:["An error occurred while marked unread the chat. Open a calling.",t.toString()]})}}async deleteMessage(e){try{let t=await this.client.sendMessage(e.remoteJid,{delete:e});if(t){let i=t.message?.protocolMessage?.key?.id;if(i){let o=b.get("DATABASE").DELETE_DATA.LOGICAL_MESSAGE_DELETE,n=await this.prismaRepository.message.findFirst({where:{key:{path:["id"],equals:i}}});if(o){if(!n)return t;let r=typeof n?.key=="object"&&n.key!==null?n.key:{};if(n=await this.prismaRepository.message.update({where:{id:n.id},data:{key:{...r,deleted:!0},status:"DELETED"}}),this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE){let c={messageId:n.id,keyId:i,remoteJid:t.key.remoteJid,fromMe:t.key.fromMe,participant:t.key?.participant,status:"DELETED",instanceId:this.instanceId};await this.prismaRepository.messageUpdate.create({data:c})}}else{if(!n)return t;await this.prismaRepository.message.deleteMany({where:{id:n.id}})}this.sendDataWebhook(R.MESSAGES_DELETE,{id:n.id,instanceId:n.instanceId,key:n.key,messageType:n.messageType,status:"DELETED",source:n.source,messageTimestamp:n.messageTimestamp,pushName:n.pushName,participant:n.participant,message:n.message})}}return t}catch(t){throw new $("Error while deleting message for everyone",t?.toString())}}async mapMediaType(e){return{imageMessage:"image",videoMessage:"video",documentMessage:"document",stickerMessage:"sticker",audioMessage:"audio",ptvMessage:"video"}[e]||null}async getBase64FromMediaMessage(e,t=!1){try{let i=e?.message,o=e?.convertToMp4??!1,n=i?.message?i:await this.getMessage(i.key,!0);if(!n)throw"Message not found";for(let g of zl)n.message[g]&&(n.message=n.message[g].message);if("messageContextInfo"in n.message&&Object.keys(n.message).length===1)return this.logger.verbose("Message contains only messageContextInfo, skipping media processing"),null;let r,c;if(n.message?.templateMessage){let g=n.message.templateMessage.hydratedTemplate||n.message.templateMessage.hydratedFourRowTemplate;for(let y of Dn)if(g[y]){r=g[y],c=y,n.message={[y]:{...g[y],url:g[y].staticUrl}};break}if(!r)throw"Template message does not contain a supported media type"}else{for(let g of Dn)if(r=n.message[g],r){c=g;break}if(!r)throw"The message is not of the media type"}typeof r.mediaKey=="object"&&(n.message[c].mediaKey=Uint8Array.from(Object.values(r.mediaKey)));let p;try{p=await(0,k.downloadMediaMessage)({key:n?.key,message:n?.message},"buffer",{},{logger:(0,it.default)({level:"error"}),reuploadRequest:this.client.updateMediaMessage})}catch{this.logger.error("Download Media failed, trying to retry in 5 seconds..."),await new Promise(y=>setTimeout(y,5e3));let g=Object.keys(n.message).find(y=>y.endsWith("Message"));if(!g)throw new Error("Could not determine mediaType for fallback");try{let y=await(0,k.downloadContentFromMessage)({mediaKey:n.message?.[g]?.mediaKey,directPath:n.message?.[g]?.directPath,url:`https://mmg.whatsapp.net${n?.message?.[g]?.directPath}`},await this.mapMediaType(g),{}),m=[];for await(let S of y)m.push(S);p=Buffer.concat(m),this.logger.info("Download Media with downloadContentFromMessage was successful!")}catch(y){throw this.logger.error("Download Media with downloadContentFromMessage also failed!"),y}}let u=(0,k.getContentType)(n.message),d=Ot.default.extension(r?.mimetype),f=r?.fileName||`${n.key.id}.${d}`||`${(0,ai.v4)()}.${d}`;if(o&&u==="audioMessage")try{let g=await this.processAudioMp4(p.toString("base64"));if(Buffer.isBuffer(g))return{mediaType:c,fileName:f,caption:r.caption,size:{fileLength:r.fileLength,height:r.height,width:r.width},mimetype:"audio/mp4",base64:g.toString("base64"),buffer:t?g:null}}catch(g){throw this.logger.error("Error converting audio to mp4:"),this.logger.error(g),new w("Failed to convert audio to MP4")}return{mediaType:c,fileName:f,caption:r.caption,size:{fileLength:r.fileLength,height:r.height,width:r.width},mimetype:r.mimetype,base64:p.toString("base64"),buffer:t?p:null}}catch(i){throw this.logger.error("Error processing media message:"),this.logger.error(i),new w(i.toString())}}async fetchPrivacySettings(){let e=await this.client.fetchPrivacySettings();return{readreceipts:e.readreceipts,profile:e.profile,status:e.status,online:e.online,last:e.last,groupadd:e.groupadd}}async updatePrivacySettings(e){try{return await this.client.updateReadReceiptsPrivacy(e.readreceipts),await this.client.updateProfilePicturePrivacy(e.profile),await this.client.updateStatusPrivacy(e.status),await this.client.updateOnlinePrivacy(e.online),await this.client.updateLastSeenPrivacy(e.last),await this.client.updateGroupsAddPrivacy(e.groupadd),this.reloadConnection(),{update:"success",data:{readreceipts:e.readreceipts,profile:e.profile,status:e.status,online:e.online,last:e.last,groupadd:e.groupadd}}}catch(t){throw new $("Error updating privacy settings",t.toString())}}async fetchBusinessProfile(e){try{let t=e?K(e):this.instance.wuid,i=await this.client.getBusinessProfile(t);return i?{isBusiness:!0,...i}:{isBusiness:!1,message:"Not is business profile",...(await this.whatsappNumber({numbers:[t]}))?.shift()}}catch(t){throw new $("Error updating profile name",t.toString())}}async updateProfileName(e){try{return await this.client.updateProfileName(e),{update:"success"}}catch(t){throw new $("Error updating profile name",t.toString())}}async updateProfileStatus(e){try{return await this.client.updateProfileStatus(e),{update:"success"}}catch(t){throw new $("Error updating profile status",t.toString())}}async updateProfilePicture(e){try{let t;if((0,ee.isURL)(e)){let i=new Date().getTime(),o=new URL(e);o.searchParams.set("timestamp",i.toString());let n=o.toString(),r={responseType:"arraybuffer"};this.localProxy?.enabled&&(r={...r,httpsAgent:ke({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})}),t=(await Be.default.get(n,r)).data}else if((0,ee.isBase64)(e))t=Buffer.from(e,"base64");else throw new w('"profilePicture" must be a url or a base64');return await this.client.updateProfilePicture(this.instance.wuid,t),this.reloadConnection(),{update:"success"}}catch(t){throw new $("Error updating profile picture",t.toString())}}async removeProfilePicture(){try{return await this.client.removeProfilePicture(this.instance.wuid),this.reloadConnection(),{update:"success"}}catch(e){throw new $("Error removing profile picture",e.toString())}}async blockUser(e){try{let{number:t}=e,i=(await this.whatsappNumber({numbers:[t]}))?.shift();if(!i.exists&&!(0,k.isJidGroup)(i.jid)&&!i.jid.includes("@broadcast"))throw new w(i);let o=i.jid;return await this.client.updateBlockStatus(o,e.status),{block:"success"}}catch(t){throw new $("Error blocking user",t.toString())}}async formatUpdateMessage(e){try{if(!this.configService.get("DATABASE").SAVE_DATA.NEW_MESSAGE)return e;let t=await this.getMessage(e.key,!0);return t?.messageType==="conversation"||t?.messageType==="extendedTextMessage"?{text:e.text}:t?.messageType==="imageMessage"?{image:t?.message?.imageMessage,caption:e.text}:t?.messageType==="videoMessage"?{video:t?.message?.videoMessage,caption:e.text}:null}catch(t){throw this.logger.error(t),new w(t.toString())}}async updateMessage(e){let t=K(e.number),i=await this.formatUpdateMessage(e);if(!i)throw this.logger.error("Message not compatible"),new w("Message not compatible");try{let o=await this.getMessage(e.key,!0);if(this.configService.get("DATABASE").SAVE_DATA.NEW_MESSAGE){if(!o)throw new G("Message not found");if(o?.key?.remoteJid!==t)throw new w("RemoteJid does not match");if(o?.messageTimestamp>Date.now()+9e5)throw new w("Message is older than 15 minutes")}let n=await this.client.sendMessage(t,{...i,edit:e.key});if(n){let r=n?.message?.protocolMessage||n?.message?.editedMessage?.message?.protocolMessage;if(r){this.sendDataWebhook(R.SEND_MESSAGE_UPDATE,r),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("send.message.update",{instanceName:this.instance.name,instanceId:this.instance.id},r);let c=n.message?.protocolMessage?.key?.id;if(c&&this.configService.get("DATABASE").SAVE_DATA.NEW_MESSAGE){let p=await this.prismaRepository.message.findFirst({where:{key:{path:["id"],equals:c}}});if(!p)throw new G("Message not found");if(p.key.valueOf().fromMe||new w("You cannot edit others messages"),p.key.valueOf()?.deleted&&new w("You cannot edit deleted messages"),o.messageType==="conversation"||o.messageType==="extendedTextMessage"?o.message.conversation=e.text:o.message[o.messageType].caption=e.text,p=await this.prismaRepository.message.update({where:{id:p.id},data:{message:o.message,status:"EDITED",messageTimestamp:Math.floor(Date.now()/1e3)}}),this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE){let u={messageId:p.id,keyId:c,remoteJid:n.key.remoteJid,fromMe:n.key.fromMe,participant:n.key?.participant,status:"EDITED",instanceId:this.instanceId};await this.prismaRepository.messageUpdate.create({data:u})}}}}return n}catch(o){throw this.logger.error(o),o}}async fetchLabels(){return(await this.prismaRepository.label.findMany({where:{instanceId:this.instanceId}})).map(t=>({color:t.color,name:t.name,id:t.labelId,predefinedId:t.predefinedId}))}async handleLabel(e){let t=await this.whatsappNumber({numbers:[e.number]});if(t.length===0)throw new G("Number not found");let i=t[0];if(!i.exists)throw new G("Number is not on WhatsApp");try{if(e.action==="add")return await this.client.addChatLabel(i.jid,e.labelId),await this.addLabel(e.labelId,this.instanceId,i.jid),{numberJid:i.jid,labelId:e.labelId,add:!0};if(e.action==="remove")return await this.client.removeChatLabel(i.jid,e.labelId),await this.removeLabel(e.labelId,this.instanceId,i.jid),{numberJid:i.jid,labelId:e.labelId,remove:!0}}catch(o){throw new w(`Unable to ${e.action} label to chat`,o.toString())}}async updateGroupMetadataCache(e){try{let t=await this.client.groupMetadata(e),i=this.configService.get("CACHE");return(i?.REDIS?.ENABLED&&i?.REDIS?.URI!==""||i?.LOCAL?.ENABLED)&&(this.logger.verbose(`Updating cache for group: ${e}`),await Wr.set(e,{timestamp:Date.now(),data:t})),t}catch(t){return this.logger.error(t),null}}async createGroup(e){try{let t=(await this.whatsappNumber({numbers:e.participants})).filter(n=>n.exists).map(n=>n.jid),{id:i}=await this.client.groupCreate(e.subject,t);return e?.description&&await this.client.groupUpdateDescription(i,e.description),e?.promoteParticipants&&await this.updateGParticipant({groupJid:i,action:"promote",participants:t}),await this.client.groupMetadata(i)}catch(t){throw this.logger.error(t),new $("Error creating group",t.toString())}}async updateGroupPicture(e){try{let t;if((0,ee.isURL)(e.image)){let i=new Date().getTime(),o=new URL(e.image);o.searchParams.set("timestamp",i.toString());let n=o.toString(),r={responseType:"arraybuffer"};this.localProxy?.enabled&&(r={...r,httpsAgent:ke({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})}),t=(await Be.default.get(n,r)).data}else if((0,ee.isBase64)(e.image))t=Buffer.from(e.image,"base64");else throw new w('"profilePicture" must be a url or a base64');return await this.client.updateProfilePicture(e.groupJid,t),{update:"success"}}catch(t){throw new $("Error update group picture",t.toString())}}async updateGroupSubject(e){try{return await this.client.groupUpdateSubject(e.groupJid,e.subject),{update:"success"}}catch(t){throw new $("Error updating group subject",t.toString())}}async updateGroupDescription(e){try{return await this.client.groupUpdateDescription(e.groupJid,e.description),{update:"success"}}catch(t){throw new $("Error updating group description",t.toString())}}async findGroup(e,t="out"){try{let i=await this.client.groupMetadata(e.groupJid);if(!i)return this.logger.error("Group not found"),null;let o=await this.profilePicture(i.id);return{id:i.id,subject:i.subject,subjectOwner:i.subjectOwner,subjectTime:i.subjectTime,pictureUrl:o.profilePictureUrl,size:i.participants.length,creation:i.creation,owner:i.owner,desc:i.desc,descId:i.descId,restrict:i.restrict,announce:i.announce,participants:i.participants,isCommunity:i.isCommunity,isCommunityAnnounce:i.isCommunityAnnounce,linkedParent:i.linkedParent}}catch(i){if(t==="inner")return;throw new G("Error fetching group",i.toString())}}async fetchAllGroups(e){let t=Object.values(await this?.client?.groupFetchAllParticipating()),i=[];for(let o of t){let n=await this.profilePicture(o.id),r={id:o.id,subject:o.subject,subjectOwner:o.subjectOwner,subjectTime:o.subjectTime,pictureUrl:n?.profilePictureUrl,size:o.participants.length,creation:o.creation,owner:o.owner,desc:o.desc,descId:o.descId,restrict:o.restrict,announce:o.announce,isCommunity:o.isCommunity,isCommunityAnnounce:o.isCommunityAnnounce,linkedParent:o.linkedParent};e.getParticipants=="true"&&(r.participants=o.participants),i=[...i,r]}return i}async inviteCode(e){try{let t=await this.client.groupInviteCode(e.groupJid);return{inviteUrl:`https://chat.whatsapp.com/${t}`,inviteCode:t}}catch(t){throw new G("No invite code",t.toString())}}async inviteInfo(e){try{return await this.client.groupGetInviteInfo(e.inviteCode)}catch{throw new G("No invite info",e.inviteCode)}}async sendInvite(e){try{let i=(await this.inviteCode({groupJid:e.groupJid})).inviteUrl,o=e.numbers.map(p=>K(p)),c={conversation:`${e.description??""}

${i}`};for await(let p of o)await this.sendMessageWithTyping(p,c);return{send:!0,inviteUrl:i}}catch{throw new G("No send invite")}}async acceptInviteCode(e){try{return{accepted:!0,groupJid:await this.client.groupAcceptInvite(e.inviteCode)}}catch(t){throw new G("Accept invite error",t.toString())}}async revokeInviteCode(e){try{return{revoked:!0,inviteCode:await this.client.groupRevokeInvite(e.groupJid)}}catch(t){throw new G("Revoke error",t.toString())}}async findParticipants(e){try{let t=(await this.client.groupMetadata(e.groupJid)).participants,i=await this.prismaRepository.contact.findMany({where:{instanceId:this.instanceId,remoteJid:{in:t.map(r=>r.id)}}}),o=t.map(r=>{let c=i.find(p=>p.remoteJid===r.id);return{...r,name:r.name??c?.pushName,imgUrl:r.imgUrl??c?.profilePicUrl}}),n=o.filter(r=>r.id.includes("@s.whatsapp"));return n&&await Nt(n.map(r=>({remoteJid:r.id}))),{participants:o}}catch(t){throw console.error(t),new G("No participants",t.toString())}}async updateGParticipant(e){try{let t=e.participants.map(o=>K(o));return{updateParticipants:await this.client.groupParticipantsUpdate(e.groupJid,t,e.action)}}catch(t){throw new w("Error updating participants",t.toString())}}async updateGSetting(e){try{return{updateSetting:await this.client.groupSettingUpdate(e.groupJid,e.action)}}catch(t){throw new w("Error updating setting",t.toString())}}async toggleEphemeral(e){try{return await this.client.groupToggleEphemeral(e.groupJid,e.expiration),{success:!0}}catch(t){throw new w("Error updating setting",t.toString())}}async leaveGroup(e){try{return await this.client.groupLeave(e.groupJid),{groupJid:e.groupJid,leave:!0}}catch(t){throw new w("Unable to leave the group",t.toString())}}async templateMessage(){throw new Error("Method not available in the Baileys service")}deserializeMessageBuffers(e){if(e==null)return e;if(typeof e=="object"&&!Array.isArray(e)&&!Buffer.isBuffer(e)){let t=Object.keys(e);if(t.every(o=>!isNaN(Number(o)))&&t.length>0){let o=t.sort((n,r)=>Number(n)-Number(r)).map(n=>e[n]);return new Uint8Array(o)}}if(Buffer.isBuffer(e))return new Uint8Array(e);if(Array.isArray(e))return e.map(t=>this.deserializeMessageBuffers(t));if(typeof e=="object"){let t={};for(let i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=this.deserializeMessageBuffers(e[i]));return t}return e}prepareMessage(e){let t=(0,k.getContentType)(e.message),i=e?.message[t],o={key:e.key,pushName:e.pushName||(e.key.fromMe?"Voc\xEA":e?.participant||(e.key?.participant?e.key.participant.split("@")[0]:null)),status:re[e.status],message:this.deserializeMessageBuffers({...e.message}),contextInfo:this.deserializeMessageBuffers(i?.contextInfo),messageType:t||"unknown",messageTimestamp:Rt.default.isLong(e.messageTimestamp)?e.messageTimestamp.toNumber():e.messageTimestamp,instanceId:this.instanceId,source:(0,k.getDevice)(e.key.id)};!o.status&&e.key.fromMe===!1&&(o.status=re[3]),o.message.extendedTextMessage&&(o.messageType="conversation",o.message.conversation=o.message.extendedTextMessage.text,delete o.message.extendedTextMessage),o.message.documentWithCaptionMessage&&(o.messageType="documentMessage",o.message.documentMessage=o.message.documentWithCaptionMessage.message.documentMessage,delete o.message.documentWithCaptionMessage);let n=o?.contextInfo?.quotedMessage;return n&&(n.extendedTextMessage&&(n.conversation=n.extendedTextMessage.text,delete n.extendedTextMessage),n.documentWithCaptionMessage&&(n.documentMessage=n.documentWithCaptionMessage.message.documentMessage,delete n.documentWithCaptionMessage)),o}async syncChatwootLostMessages(){if(this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled){let e=await this.findChatwoot(),t=l(r=>this.prepareMessage(r),"prepare");this.chatwootService.syncLostMessages({instanceName:this.instance.name},e,t);let i=(0,ni.createId)(),o="chatwoot:syncLostMessages";await this.chatwootService.getCache()?.hSet(o,this.instance.name,i);let n=kp.default.schedule("0,30 * * * *",async()=>{let r=this.chatwootService.getCache();if(r){let c=await r.hGet(o,this.instance.name);if(c&&c!==i){this.logger.info(`Stopping syncChatwootLostMessages cron - ID mismatch: ${i} vs ${c}`),n.stop();return}}this.chatwootService.syncLostMessages({instanceName:this.instance.name},e,t)});n.start()}}async updateMessagesReadedByTimestamp(e,t){if(t==null)return 0;let i=await this.prismaRepository.$executeRaw`
      UPDATE "Message"
      SET "status" = ${re[4]}
      WHERE "instanceId" = ${this.instanceId}
      AND "key"->>'remoteJid' = ${e}
      AND ("key"->>'fromMe')::boolean = false
      AND "messageTimestamp" <= ${t}
      AND ("status" IS NULL OR "status" = ${re[3]})
    `;return i?(i>0&&this.updateChatUnreadMessages(e),i):0}async updateChatUnreadMessages(e){let[t,i]=await Promise.all([this.prismaRepository.chat.findFirst({where:{remoteJid:e}}),this.prismaRepository.$queryRaw`
        SELECT COUNT(*)::int as count FROM "Message"
        WHERE "instanceId" = ${this.instanceId}
        AND "key"->>'remoteJid' = ${e}
        AND ("key"->>'fromMe')::boolean = false
        AND "status" = ${re[3]}
      `.then(o=>o[0]?.count||0)]);return t&&t.unreadMessages!==i&&await this.prismaRepository.chat.update({where:{id:t.id},data:{unreadMessages:i}}),i}async addLabel(e,t,i){let o=(0,ni.createId)();await this.prismaRepository.$executeRawUnsafe(`INSERT INTO "Chat" ("id", "instanceId", "remoteJid", "labels", "createdAt", "updatedAt")
       VALUES ($4, $2, $3, to_jsonb(ARRAY[$1]::text[]), NOW(), NOW()) ON CONFLICT ("instanceId", "remoteJid")
     DO
      UPDATE
          SET "labels" = (
          SELECT to_jsonb(array_agg(DISTINCT elem))
          FROM (
          SELECT jsonb_array_elements_text("Chat"."labels") AS elem
          UNION
          SELECT $1::text AS elem
          ) sub
          ),
          "updatedAt" = NOW();`,e,t,i,o)}async removeLabel(e,t,i){let o=(0,ni.createId)();await this.prismaRepository.$executeRawUnsafe(`INSERT INTO "Chat" ("id", "instanceId", "remoteJid", "labels", "createdAt", "updatedAt")
       VALUES ($4, $2, $3, '[]'::jsonb, NOW(), NOW()) ON CONFLICT ("instanceId", "remoteJid")
     DO
      UPDATE
          SET "labels" = COALESCE (
          (
          SELECT jsonb_agg(elem)
          FROM jsonb_array_elements_text("Chat"."labels") AS elem
          WHERE elem <> $1
          ),
          '[]'::jsonb
          ),
          "updatedAt" = NOW();`,e,t,i,o)}async baileysOnWhatsapp(e){return await this.client.onWhatsApp(e)}async baileysProfilePictureUrl(e,t,i){return await this.client.profilePictureUrl(e,t,i)}async baileysAssertSessions(e){return await this.client.assertSessions(e)}async baileysCreateParticipantNodes(e,t,i){let o=await this.client.createParticipantNodes(e,t,i);return{...o,nodes:o.nodes.map(r=>({...r,content:r.content?.map(c=>({...c,content:c.content instanceof Uint8Array?Buffer.from(c.content).toString("base64"):c.content}))}))}}async baileysSendNode(e){return console.log("stanza",JSON.stringify(e)),await this.client.sendNode(e)}async baileysGetUSyncDevices(e,t,i){return await this.client.getUSyncDevices(e,t,i)}async baileysGenerateMessageTag(){return await this.client.generateMessageTag()}async baileysSignalRepositoryDecryptMessage(e,t,i){try{let o=Buffer.from(i,"base64"),n=await this.client.signalRepository.decryptMessage({jid:e,type:t,ciphertext:o});return n instanceof Uint8Array?Buffer.from(n).toString("base64"):n}catch(o){throw this.logger.error("Error decrypting message:"),this.logger.error(o),o}}async baileysGetAuthState(){return{me:this.client.authState.creds.me,account:this.client.authState.creds.account}}async fetchCatalog(e,t){let i=t.number?K(t.number):this.client?.user?.id,o=t.limit||10,n=null,r=(await this.whatsappNumber({numbers:[i]}))?.shift();if(!r.exists)throw new w(r);try{let c=(await this.whatsappNumber({numbers:[i]}))?.shift(),p=await this.fetchBusinessProfile(c?.jid),u=await this.getCatalog({jid:c?.jid,limit:o,cursor:n}),d=u.nextPageCursor,f=d?JSON.parse(atob(d)):null,g=f?.pagination_cursor?JSON.parse(atob(f.pagination_cursor)):null,y=g?.fetcher_has_more===!0,m=u.products||[],S=0;for(;y&&S<4;)u=await this.getCatalog({jid:c?.jid,limit:o,cursor:d}),d=u.nextPageCursor,f=d?JSON.parse(atob(d)):null,g=f?.pagination_cursor?JSON.parse(atob(f.pagination_cursor)):null,y=g?.fetcher_has_more===!0,m=[...m,...u.products],S++;return{wuid:c?.jid||i,numberExists:c?.exists,isBusiness:p.isBusiness,catalogLength:m.length,catalog:m}}catch(c){return console.log(c),{wuid:i,name:null,isBusiness:!1}}}async getCatalog({jid:e,limit:t,cursor:i}){try{e=e?K(e):this.instance.wuid;let o=await this.client.getCatalog({jid:e,limit:t,cursor:i});return o||{products:void 0,nextPageCursor:void 0}}catch(o){throw new $("Error getCatalog",o.toString())}}async fetchCollections(e,t){let i=t.number?K(t.number):this.client?.user?.id,o=t.limit<=20?t.limit:20,n=(await this.whatsappNumber({numbers:[i]}))?.shift();if(!n.exists)throw new w(n);try{let r=(await this.whatsappNumber({numbers:[i]}))?.shift(),c=await this.fetchBusinessProfile(r?.jid),p=await this.getCollections(r?.jid,o);return{wuid:r?.jid||i,name:r?.name,numberExists:r?.exists,isBusiness:c.isBusiness,collectionsLength:p?.length,collections:p}}catch{return{wuid:i,name:null,isBusiness:!1}}}async getCollections(e,t){try{e=e?K(e):this.instance.wuid;let i=await this.client.getCollections(e,t);return i?i.collections:[{id:void 0,name:void 0,products:[],status:void 0}]}catch(i){throw new $("Error getCatalog",i.toString())}}async fetchMessages(e){let t=e?.where?.key,i={};e?.where?.messageTimestamp&&e.where.messageTimestamp.gte&&e.where.messageTimestamp.lte&&(i.messageTimestamp={gte:Math.floor(new Date(e.where.messageTimestamp.gte).getTime()/1e3),lte:Math.floor(new Date(e.where.messageTimestamp.lte).getTime()/1e3)});let o=await this.prismaRepository.message.count({where:{instanceId:this.instanceId,id:e?.where?.id,source:e?.where?.source,messageType:e?.where?.messageType,...i,AND:[t?.id?{key:{path:["id"],equals:t?.id}}:{},t?.fromMe?{key:{path:["fromMe"],equals:t?.fromMe}}:{},t?.participant?{key:{path:["participant"],equals:t?.participant}}:{},{OR:[t?.remoteJid?{key:{path:["remoteJid"],equals:t?.remoteJid}}:{},t?.remoteJidAlt?{key:{path:["remoteJidAlt"],equals:t?.remoteJidAlt}}:{}]}]}});e?.offset||(e.offset=50),e?.page||(e.page=1);let r=(await this.prismaRepository.message.findMany({where:{instanceId:this.instanceId,id:e?.where?.id,source:e?.where?.source,messageType:e?.where?.messageType,...i,AND:[t?.id?{key:{path:["id"],equals:t?.id}}:{},t?.fromMe?{key:{path:["fromMe"],equals:t?.fromMe}}:{},t?.participant?{key:{path:["participant"],equals:t?.participant}}:{},{OR:[t?.remoteJid?{key:{path:["remoteJid"],equals:t?.remoteJid}}:{},t?.remoteJidAlt?{key:{path:["remoteJidAlt"],equals:t?.remoteJidAlt}}:{}]}]},orderBy:{messageTimestamp:"desc"},skip:e.offset*(e?.page===1?0:e?.page-1),take:e.offset,select:{id:!0,key:!0,pushName:!0,messageType:!0,message:!0,messageTimestamp:!0,instanceId:!0,source:!0,contextInfo:!0,MessageUpdate:{select:{status:!0}}}})).map(c=>{let p=c.key;if(!c.pushName){if(p.fromMe)c.pushName="Voc\xEA";else if(c.contextInfo){let u=c.contextInfo;u.participant?c.pushName=u.participant.split("@")[0]:p.participant&&(c.pushName=p.participant.split("@")[0])}}return c});return{messages:{total:o,pages:Math.ceil(o/e.offset),currentPage:e.page,records:r}}}};l(Kr,"BaileysStartupService");var ci=Kr;var jr=class jr{constructor(s,e){a(this,"prismaRepository");a(this,"waMonitor");this.prisma=s,this.monitor=e}set prisma(s){this.prismaRepository=s}get prisma(){return this.prismaRepository}set monitor(s){this.waMonitor=s}get monitor(){return this.waMonitor}init(s,e){if(!s.token&&s.integration===J.WHATSAPP_BUSINESS)throw new w("token is required");return s.integration===J.WHATSAPP_BUSINESS?new $s(e.configService,e.eventEmitter,e.prismaRepository,e.cache,e.chatwootCache,e.baileysCache,e.providerFiles):s.integration===J.EVOLUTION?new Us(e.configService,e.eventEmitter,e.prismaRepository,e.cache,e.chatwootCache):s.integration===J.WHATSAPP_BAILEYS?new ci(e.configService,e.eventEmitter,e.prismaRepository,e.cache,e.chatwootCache,e.baileysCache,e.providerFiles):null}};l(jr,"ChannelController");var ot=jr;var Hr=class Hr extends ot{constructor(e,t){super(e,t);a(this,"logger",new O("EvolutionController"));a(this,"integrationEnabled")}async receiveWebhook(e){let t=e.numberId;if(!t){this.logger.error("WebhookService -> receiveWebhookEvolution -> numberId not found");return}let i=await this.prismaRepository.instance.findFirst({where:{number:t}});if(!i){this.logger.error("WebhookService -> receiveWebhook -> instance not found");return}return await this.waMonitor.waInstances[i.name].connectToWhatsapp(e),{status:"success"}}};l(Hr,"EvolutionController");var li=Hr;var Up=x(require("axios"));var Yr=class Yr extends ot{constructor(e,t){super(e,t);a(this,"logger",new O("MetaController"));a(this,"integrationEnabled")}async receiveWebhook(e){if(e.object==="whatsapp_business_account"){if(e.entry[0]?.changes[0]?.field==="message_template_status_update"){let t=await this.prismaRepository.template.findFirst({where:{templateId:`${e.entry[0].changes[0].value.message_template_id}`}});if(!t){console.log("template not found");return}let{webhookUrl:i}=t;await Up.default.post(i,e.entry[0].changes[0].value,{headers:{"Content-Type":"application/json"}});return}e.entry?.forEach(async t=>{let i=t.changes[0].value.metadata.phone_number_id;if(!i)return this.logger.error("WebhookService -> receiveWebhookMeta -> numberId not found"),{status:"success"};let o=await this.prismaRepository.instance.findFirst({where:{number:i}});return o?(await this.waMonitor.waInstances[o.name].connectToWhatsapp(e),{status:"success"}):(this.logger.error("WebhookService -> receiveWebhookMeta -> instance not found"),{status:"success"})})}return{status:"success"}}};l(Yr,"MetaController");var pi=Yr;var Qr=class Qr{constructor(s){a(this,"waMonitor");this.waMonitor=s}async onWhatsapp({instanceName:s},e){return this.waMonitor.waInstances[s].baileysOnWhatsapp(e?.jid)}async profilePictureUrl({instanceName:s},e){return this.waMonitor.waInstances[s].baileysProfilePictureUrl(e?.jid,e?.type,e?.timeoutMs)}async assertSessions({instanceName:s},e){return this.waMonitor.waInstances[s].baileysAssertSessions(e?.jids,e?.force)}async createParticipantNodes({instanceName:s},e){return this.waMonitor.waInstances[s].baileysCreateParticipantNodes(e?.jids,e?.message,e?.extraAttrs)}async getUSyncDevices({instanceName:s},e){return this.waMonitor.waInstances[s].baileysGetUSyncDevices(e?.jids,e?.useCache,e?.ignoreZeroDevices)}async generateMessageTag({instanceName:s}){return this.waMonitor.waInstances[s].baileysGenerateMessageTag()}async sendNode({instanceName:s},e){return this.waMonitor.waInstances[s].baileysSendNode(e?.stanza)}async signalRepositoryDecryptMessage({instanceName:s},e){return this.waMonitor.waInstances[s].baileysSignalRepositoryDecryptMessage(e?.jid,e?.type,e?.ciphertext)}async getAuthState({instanceName:s}){return this.waMonitor.waInstances[s].baileysGetAuthState()}};l(Qr,"BaileysController");var ui=Qr;function $p(h){return h.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}l($p,"normalizeString");function Fp(h,s){let e=s.split(" ").reduce((i,o)=>{let[n,...r]=o.split(":"),c=r.join(":");return i[n]||(i[n]=[]),i[n].push(c),i},{}),t=$p(h);return Object.entries(e).every(([i,o])=>o.some(n=>n.split(",").every(c=>{let p=$p(c);switch(i.toLowerCase()){case"contains":return t.includes(p);case"notcontains":return!t.includes(p);case"startswith":return t.startsWith(p);case"endswith":return t.endsWith(p);case"exact":return t===p;default:return!1}})))}l(Fp,"advancedOperatorsSearch");var Wp=l(async(h,s,e)=>{let t=await h.findFirst({where:{enabled:!0,triggerType:{in:["all","none"]},instanceId:e}});if(t)return t;let i=await h.findMany({where:{enabled:!0,triggerType:"advanced",instanceId:e}});for(let y of i)if(Fp(s,y.triggerValue))return y;let o=await h.findFirst({where:{enabled:!0,triggerType:"keyword",triggerOperator:"equals",triggerValue:s,instanceId:e}});if(o)return o;let n=await h.findMany({where:{enabled:!0,triggerType:"keyword",triggerOperator:"regex",instanceId:e}}),r=null;for(let y of n)if(new RegExp(y.triggerValue).test(s)){r=y;break}if(r)return r;let c=await h.findMany({where:{enabled:!0,triggerType:"keyword",triggerOperator:"startsWith",instanceId:e}}),p=null;for(let y of c)if(s.startsWith(y.triggerValue)){p=y;break}if(p)return p;let u=await h.findMany({where:{enabled:!0,triggerType:"keyword",triggerOperator:"endsWith",instanceId:e}}),d=null;for(let y of u)if(s.endsWith(y.triggerValue)){d=y;break}if(d)return d;let f=await h.findMany({where:{enabled:!0,triggerType:"keyword",triggerOperator:"contains",instanceId:e}}),g=null;for(let y of f)if(s.includes(y.triggerValue)){g=y;break}return g||null},"findBotByTrigger");var zr=class zr{constructor(s,e){a(this,"prismaRepository");a(this,"waMonitor");a(this,"logger",new O("ChatbotController"));this.prisma=s,this.monitor=e}set prisma(s){this.prismaRepository=s}get prisma(){return this.prismaRepository}set monitor(s){this.waMonitor=s}get monitor(){return this.waMonitor}async emit({instance:s,remoteJid:e,msg:t,pushName:i,isIntegration:o=!1}){let n={instance:s,remoteJid:e,msg:t,pushName:i,isIntegration:o};Ae.emit(n),ye.emit(n),ie.emit(n),Te.emit(n),Ie.emit(n),Ce.emit(n),be.emit(n)}processDebounce(s,e,t,i,o){s[t]?(s[t].message+=`
${e}`,this.logger.log("message debounced: "+s[t].message),clearTimeout(s[t].timeoutId)):s[t]={message:e,timeoutId:null},s[t].timeoutId=setTimeout(()=>{let n=s[t].message;this.logger.log("Debounce complete. Processing message: "+n),delete s[t],o(n)},i*1e3)}checkIgnoreJids(s,e){if(s&&s.length>0){let t=!1,i=!1;return s.includes("@g.us")&&(t=!0),s.includes("@s.whatsapp.net")&&(i=!0),t&&e.endsWith("@g.us")?(this.logger.warn("Ignoring message from group: "+e),!0):i&&e.endsWith("@s.whatsapp.net")?(this.logger.warn("Ignoring message from contact: "+e),!0):s.includes(e)?(this.logger.warn("Ignoring message from jid: "+e),!0):!1}return!1}async getSession(s,e){let t=await this.prismaRepository.integrationSession.findFirst({where:{remoteJid:s,instanceId:e.instanceId},orderBy:{createdAt:"desc"}});if(t){if(t.status!=="closed"&&!t.botId)return this.logger.warn("Session is already opened in another integration"),null;t.botId||(t=null)}return t}async findBotTrigger(s,e,t,i){let o=null;if(i)o=await s.findFirst({where:{id:i.botId}});else if(o=await Wp(s,e,t.instanceId),!o)return null;return o}};l(zr,"ChatbotController");var Pt=zr;var Jp=require("class-validator");var Xr=class Xr{constructor(s,e){a(this,"chatwootService");a(this,"configService");this.chatwootService=s,this.configService=e}async createChatwoot(s,e){if(!this.configService.get("CHATWOOT").ENABLED)throw new w("Chatwoot is disabled");if(e?.enabled){if(!(0,Jp.isURL)(e.url,{require_tld:!1}))throw new w("url is not valid");if(!e.accountId)throw new w("accountId is required");if(!e.token)throw new w("token is required");if(e.signMsg!==!0&&e.signMsg!==!1)throw new w("signMsg is required");e.signMsg===!1&&(e.signDelimiter=null)}(!e.nameInbox||e.nameInbox==="")&&(e.nameInbox=s.instanceName);let t=await this.chatwootService.create(s,e),i=this.configService.get("SERVER").URL;return{...t,webhook_url:`${i}/chatwoot/webhook/${encodeURIComponent(s.instanceName)}`}}async findChatwoot(s){if(!this.configService.get("CHATWOOT").ENABLED)throw new w("Chatwoot is disabled");let e=await this.chatwootService.find(s),t=this.configService.get("SERVER").URL;return Object.keys(e||{}).length===0?{enabled:!1,url:"",accountId:"",token:"",signMsg:!1,nameInbox:"",webhook_url:""}:{...e,webhook_url:`${t}/chatwoot/webhook/${encodeURIComponent(s.instanceName)}`}}async receiveWebhook(s,e){if(!this.configService.get("CHATWOOT").ENABLED)throw new w("Chatwoot is disabled");return this.chatwootService.receiveWebhook(s,e)}};l(Xr,"ChatwootController");var di=Xr;var Zr=class Zr extends Pt{constructor(e,t){super(e,t);a(this,"logger");a(this,"integrationEnabled");a(this,"botRepository");a(this,"settingsRepository");a(this,"sessionRepository");a(this,"userMessageDebounce",{});this.sessionRepository=this.prismaRepository.integrationSession}async createBot(e,t){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id);if(!t.expire||!t.keywordFinish||!t.delayMessage||!t.unknownMessage||!t.listeningFromMe||!t.stopBotFromMe||!t.keepOpen||!t.debounceTime||!t.ignoreJids||!t.splitMessages||!t.timePerChar){let n=await this.settingsRepository.findFirst({where:{instanceId:i}});(t.expire===void 0||t.expire===null)&&(t.expire=n?.expire),(t.keywordFinish===void 0||t.keywordFinish===null)&&(t.keywordFinish=n?.keywordFinish),(t.delayMessage===void 0||t.delayMessage===null)&&(t.delayMessage=n?.delayMessage),(t.unknownMessage===void 0||t.unknownMessage===null)&&(t.unknownMessage=n?.unknownMessage),(t.listeningFromMe===void 0||t.listeningFromMe===null)&&(t.listeningFromMe=n?.listeningFromMe),(t.stopBotFromMe===void 0||t.stopBotFromMe===null)&&(t.stopBotFromMe=n?.stopBotFromMe),(t.keepOpen===void 0||t.keepOpen===null)&&(t.keepOpen=n?.keepOpen),(t.debounceTime===void 0||t.debounceTime===null)&&(t.debounceTime=n?.debounceTime),(t.ignoreJids===void 0||t.ignoreJids===null)&&(t.ignoreJids=n?.ignoreJids),(t.splitMessages===void 0||t.splitMessages===null)&&(t.splitMessages=n?.splitMessages??!1),(t.timePerChar===void 0||t.timePerChar===null)&&(t.timePerChar=n?.timePerChar??0),n||await this.settings(e,{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,ignoreJids:t.ignoreJids,splitMessages:t.splitMessages,timePerChar:t.timePerChar})}if(await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",instanceId:i}})&&t.triggerType==="all")throw new Error(`You already have a ${this.integrationName} with an "All" trigger, you cannot have more bots while it is active`);if(t.triggerType==="keyword"){if(!t.triggerOperator||!t.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,instanceId:i}}))throw new Error("Trigger already exists")}if(t.triggerType==="advanced"){if(!t.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:t.triggerValue,instanceId:i}}))throw new Error("Trigger already exists")}try{let n={enabled:t?.enabled,description:t.description,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,instanceId:i,triggerType:t.triggerType,triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,ignoreJids:t.ignoreJids,splitMessages:t.splitMessages,timePerChar:t.timePerChar,...this.getAdditionalBotData(t)};return await this.botRepository.create({data:n})}catch(n){throw this.logger.error(n),new Error(`Error creating ${this.integrationName}`)}}async findBot(e){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(i=>i.id);try{return await this.botRepository.findMany({where:{instanceId:t}})}catch(i){throw this.logger.error(i),new Error(`Error finding ${this.integrationName}`)}}async fetchBot(e,t){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);try{let i=await this.botRepository.findUnique({where:{id:t}});return i||null}catch(i){throw this.logger.error(i),new Error(`Error fetching ${this.integrationName}`)}}async settings(e,t){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);try{let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(c=>c.id),o=await this.settingsRepository.findFirst({where:{instanceId:i}}),n=this.getFallbackFieldName(),r={expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,ignoreJids:t.ignoreJids,splitMessages:t.splitMessages,timePerChar:t.timePerChar,[n]:t.fallbackId};if(o){let c=await this.settingsRepository.update({where:{id:o.id},data:r});return{...c,fallbackId:c[n]}}else{let c=await this.settingsRepository.create({data:{...r,Instance:{connect:{id:i}}}});return{...c,fallbackId:c[n]}}}catch(i){throw this.logger.error(i),new Error("Error setting default settings")}}async fetchSettings(e){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);try{let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),i=await this.settingsRepository.findFirst({where:{instanceId:t},include:{Fallback:!0}}),o=this.getFallbackFieldName();return i?{...i,fallbackId:i[o],fallback:i.Fallback}:{expire:300,keywordFinish:"bye",delayMessage:1e3,unknownMessage:"Sorry, I dont understand",listeningFromMe:!0,stopBotFromMe:!0,keepOpen:!1,debounceTime:1,ignoreJids:[],splitMessages:!1,timePerChar:0,fallbackId:"",fallback:null}}catch(t){throw this.logger.error(t),new Error("Error fetching settings")}}async changeStatus(e,t){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);try{let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(p=>p.id),o=await this.settingsRepository.findFirst({where:{instanceId:i}}),n=t.remoteJid,r=t.status,c=await this.getSession(n,e);if(this.integrationName==="Typebot"){let p={remoteJid:n,status:r,session:c};this.waMonitor.waInstances[e.instanceName].sendDataWebhook(R.TYPEBOT_CHANGE_STATUS,p)}if(r==="delete")return await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{bot:{remoteJid:n,status:r}};if(r==="closed")return o?.keepOpen?await this.sessionRepository.updateMany({where:{remoteJid:n,botId:{not:null}},data:{status:"closed"}}):await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{bot:{...e,bot:{remoteJid:n,status:r}}};{let p=await this.sessionRepository.updateMany({where:{instanceId:i,remoteJid:n,botId:{not:null}},data:{status:r}});return{bot:{...e,bot:{remoteJid:n,status:r,session:p}}}}}catch(i){throw this.logger.error(i),new Error(`Error changing ${this.integrationName} status`)}}async fetchSessions(e,t,i){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);try{let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(c=>c.id),n=await this.botRepository.findFirst({where:{id:t}});if(n&&n.instanceId!==o)throw new Error(`${this.integrationName} not found`);let r=this.getIntegrationType();return await this.sessionRepository.findMany({where:{instanceId:o,remoteJid:i,botId:n?t:{not:null},type:r}})}catch(o){throw this.logger.error(o),new Error("Error fetching sessions")}}async ignoreJid(e,t){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);try{let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(c=>c.id),o=await this.settingsRepository.findFirst({where:{instanceId:i}});if(!o)throw new Error("Settings not found");let n=o?.ignoreJids||[];if(t.action==="add"){if(n.includes(t.remoteJid))return{ignoreJids:n};n.push(t.remoteJid)}else n=n.filter(c=>c!==t.remoteJid);return{ignoreJids:(await this.settingsRepository.update({where:{id:o.id},data:{ignoreJids:n}})).ignoreJids}}catch(i){throw this.logger.error(i),new Error("Error setting default settings")}}async updateBot(e,t,i){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);try{let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(p=>p.id),n=await this.botRepository.findFirst({where:{id:t}});if(!n)throw new Error(`${this.integrationName} not found`);if(n.instanceId!==o)throw new Error(`${this.integrationName} not found`);if(i.triggerType==="all"&&await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",id:{not:t},instanceId:o}}))throw new Error(`You already have a ${this.integrationName} with an "All" trigger, you cannot have more bots while it is active`);if(await this.validateNoDuplicatesOnUpdate(t,o,i),i.triggerType==="keyword"){if(!i.triggerOperator||!i.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:i.triggerOperator,triggerValue:i.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}if(i.triggerType==="advanced"){if(!i.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:i.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}let r={enabled:i?.enabled,description:i.description,expire:i.expire,keywordFinish:i.keywordFinish,delayMessage:i.delayMessage,unknownMessage:i.unknownMessage,listeningFromMe:i.listeningFromMe,stopBotFromMe:i.stopBotFromMe,keepOpen:i.keepOpen,debounceTime:i.debounceTime,instanceId:o,triggerType:i.triggerType,triggerOperator:i.triggerOperator,triggerValue:i.triggerValue,ignoreJids:i.ignoreJids,splitMessages:i.splitMessages,timePerChar:i.timePerChar,...this.getAdditionalUpdateFields(i)};return await this.botRepository.update({where:{id:t},data:r})}catch(o){throw this.logger.error(o),new Error(`Error updating ${this.integrationName}`)}}async deleteBot(e,t){if(!this.integrationEnabled)throw new w(`${this.integrationName} is disabled`);try{let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error(`${this.integrationName} not found`);if(o.instanceId!==i)throw new Error(`${this.integrationName} not found`);return await this.prismaRepository.integrationSession.deleteMany({where:{botId:t}}),await this.botRepository.delete({where:{id:t}}),{bot:{id:t}}}catch(i){throw this.logger.error(i),new Error(`Error deleting ${this.integrationName} bot`)}}async emit({instance:e,remoteJid:t,msg:i}){if(this.integrationEnabled)try{let o=await this.settingsRepository.findFirst({where:{instanceId:e.instanceId}});if(this.checkIgnoreJids(o?.ignoreJids,t))return;let n=await this.getSession(t,e),r=Ls(i),c=await this.findBotTrigger(this.botRepository,r,e,n);if(!c){let M=await this.settingsRepository.findFirst({where:{instanceId:e.instanceId}}),v=this.getFallbackBotId(M);if(v)c=await this.botRepository.findFirst({where:{id:v}});else return}if(!c)return;let p=c.expire,u=c.keywordFinish,d=c.delayMessage,f=c.unknownMessage,g=c.listeningFromMe,y=c.stopBotFromMe,m=c.keepOpen,S=c.debounceTime,T=c.ignoreJids,A=c.splitMessages,N=c.timePerChar;p==null&&(p=o.expire),u==null&&(u=o.keywordFinish),d==null&&(d=o.delayMessage),f==null&&(f=o.unknownMessage),g==null&&(g=o.listeningFromMe),y==null&&(y=o.stopBotFromMe),m==null&&(m=o.keepOpen),S==null&&(S=o.debounceTime),T==null&&(T=o.ignoreJids),A==null&&(A=o?.splitMessages??!1),N==null&&(N=o?.timePerChar??0);let I=i.key;if(y&&I.fromMe&&n){if(await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"paused"}}),this.integrationName==="Typebot"){let M={remoteJid:t,status:"paused",session:n};this.waMonitor.waInstances[e.instanceName].sendDataWebhook(R.TYPEBOT_CHANGE_STATUS,M)}return}if(!g&&I.fromMe||n&&n.status==="closed")return;let C={...o,expire:p,keywordFinish:u,delayMessage:d,unknownMessage:f,listeningFromMe:g,stopBotFromMe:y,keepOpen:m,debounceTime:S,ignoreJids:T,splitMessages:A,timePerChar:N};S&&S>0?this.processDebounce(this.userMessageDebounce,r,t,S,async M=>{await this.processBot(this.waMonitor.waInstances[e.instanceName],t,c,n,C,M,i?.pushName,i)}):await this.processBot(this.waMonitor.waInstances[e.instanceName],t,c,n,C,r,i?.pushName,i)}catch(o){this.logger.error(o)}}};l(Zr,"BaseChatbotController");var ae=Zr;var ea=class ea extends ae{constructor(e,t,i){super(t,i);a(this,"difyService");a(this,"logger",new O("DifyController"));a(this,"integrationName","Dify");a(this,"integrationEnabled",b.get("DIFY").ENABLED);a(this,"botRepository");a(this,"settingsRepository");a(this,"sessionRepository");a(this,"userMessageDebounce",{});this.difyService=e,this.botRepository=this.prismaRepository.dify,this.settingsRepository=this.prismaRepository.difySetting,this.sessionRepository=this.prismaRepository.integrationSession}getFallbackBotId(e){return e?.fallbackId}getFallbackFieldName(){return"difyIdFallback"}getIntegrationType(){return"dify"}getAdditionalBotData(e){return{botType:e.botType,apiUrl:e.apiUrl,apiKey:e.apiKey}}getAdditionalUpdateFields(e){return{botType:e.botType,apiUrl:e.apiUrl,apiKey:e.apiKey}}async validateNoDuplicatesOnUpdate(e,t,i){if(await this.botRepository.findFirst({where:{id:{not:e},instanceId:t,botType:i.botType,apiUrl:i.apiUrl,apiKey:i.apiKey}}))throw new Error("Dify already exists")}async createBot(e,t){if(!this.integrationEnabled)throw new w("Dify is disabled");let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id);if(await this.botRepository.findFirst({where:{instanceId:i,botType:t.botType,apiUrl:t.apiUrl,apiKey:t.apiKey}}))throw new Error("Dify already exists");return super.createBot(e,t)}async processBot(e,t,i,o,n,r,c,p){await this.difyService.process(e,t,i,o,n,r,c,p)}};l(ea,"DifyController");var hi=ea;var ta=class ta extends ae{constructor(e,t,i){super(t,i);a(this,"evoaiService");a(this,"logger",new O("EvoaiController"));a(this,"integrationName","Evoai");a(this,"integrationEnabled",b.get("EVOAI").ENABLED);a(this,"botRepository");a(this,"settingsRepository");a(this,"sessionRepository");a(this,"userMessageDebounce",{});this.evoaiService=e,this.botRepository=this.prismaRepository.evoai,this.settingsRepository=this.prismaRepository.evoaiSetting,this.sessionRepository=this.prismaRepository.integrationSession}getFallbackBotId(e){return e?.evoaiIdFallback}getFallbackFieldName(){return"evoaiIdFallback"}getIntegrationType(){return"evoai"}getAdditionalBotData(e){return{agentUrl:e.agentUrl,apiKey:e.apiKey}}getAdditionalUpdateFields(e){return{agentUrl:e.agentUrl,apiKey:e.apiKey}}async validateNoDuplicatesOnUpdate(e,t,i){if(await this.botRepository.findFirst({where:{id:{not:e},instanceId:t,agentUrl:i.agentUrl,apiKey:i.apiKey}}))throw new Error("Evoai already exists")}async createBot(e,t){if(!this.integrationEnabled)throw new w("Evoai is disabled");let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id);if(await this.botRepository.findFirst({where:{instanceId:i,agentUrl:t.agentUrl,apiKey:t.apiKey}}))throw new Error("Evoai already exists");return super.createBot(e,t)}async processBot(e,t,i,o,n,r,c,p){await this.evoaiService.process(e,t,i,o,n,r,c,p)}};l(ta,"EvoaiController");var mi=ta;var sa=x(require("axios")),qp=require("baileys"),Vp=require("class-validator"),ia=require("uuid");var oa=class oa extends ne{constructor(e,t,i,o){super(e,t,"EvoaiService",i);a(this,"openaiService");this.openaiService=o}getBotType(){return"evoai"}async sendMessageToBot(e,t,i,o,n,r,c,p){try{this.logger.debug(`[EvoAI] Sending message to bot with content: ${c}`);let u=c;if(this.isAudioMessage(c)&&p)try{this.logger.debug("[EvoAI] Downloading audio for Whisper transcription");let I=await this.openaiService.speechToText(p,e);I&&(u=`[audio] ${I}`)}catch(I){this.logger.error(`[EvoAI] Failed to transcribe audio: ${I}`)}let d=o.agentUrl;if(!d){this.logger.error("No EvoAI endpoint defined");return}let f=`req-${(0,ia.v4)().substring(0,8)}`,g=n.split("@")[0]||(0,ia.v4)(),y=[{type:"text",text:u}];if(this.isImageMessage(c)&&p){let I=c.split("|");y[0].text=I[2]||c;try{if(p.message.mediaUrl||p.message.base64){let C=p.message.base64||null;if(p.message.mediaUrl&&(0,Vp.isURL)(p.message.mediaUrl)){let M=await sa.default.get(p.message.mediaUrl,{responseType:"arraybuffer"});C=Buffer.from(M.data).toString("base64")}C&&y.push({type:"file",file:{name:p.key.id+".jpeg",mimeType:"image/jpeg",bytes:C}})}else{let C=await(0,qp.downloadMediaMessage)(p,"buffer",{}),M=Buffer.from(C).toString("base64"),v=I[2]||`${p.key?.id||"image"}.jpg`;y.push({type:"file",file:{name:v,mimeType:"image/jpeg",bytes:M}})}}catch(C){this.logger.error(`[EvoAI] Failed to process image: ${C}`)}}let m={jsonrpc:"2.0",id:f,method:"message/send",params:{contextId:t.sessionId,message:{role:"user",parts:y,messageId:g,metadata:{messageKey:p?.key}},metadata:{remoteJid:n,pushName:r,fromMe:p?.key?.fromMe,instanceName:e.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:e.token}}};this.logger.debug(`[EvoAI] Sending request to: ${d}`);let S=JSON.parse(JSON.stringify(m));S?.params?.message?.parts&&(S.params.message.parts=S.params.message.parts.map(I=>I.type==="file"&&I.file&&I.file.bytes?{...I,file:{...I.file,bytes:"[base64 omitted]"}}:I)),this.logger.debug(`[EvoAI] Payload: ${JSON.stringify(S)}`),e.integration===J.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(n),await e.client.sendPresenceUpdate("composing",n));let T=await sa.default.post(d,m,{headers:{"x-api-key":o.apiKey,"Content-Type":"application/json"}});this.logger.debug(`[EvoAI] Response: ${JSON.stringify(T.data)}`),e.integration===J.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",n);let A,N=T?.data?.result;if(N?.artifacts&&Array.isArray(N.artifacts)&&N.artifacts.length>0){let I=N.artifacts[0];if(I?.parts&&Array.isArray(I.parts)){let C=I.parts.find(M=>M.type==="text"&&M.text);C&&(A=C.text)}}this.logger.debug(`[EvoAI] Extracted message to send: ${A}`),A&&await this.sendMessageWhatsApp(e,n,A,i,!0)}catch(u){this.logger.error(`[EvoAI] Error sending message: ${u?.response?.data?JSON.stringify(u.response.data):u}`);return}}};l(oa,"EvoaiService");var gi=oa;var na=class na extends ae{constructor(e,t,i){super(t,i);a(this,"evolutionBotService");a(this,"logger",new O("EvolutionBotController"));a(this,"integrationName","EvolutionBot");a(this,"integrationEnabled",!0);a(this,"botRepository");a(this,"settingsRepository");a(this,"sessionRepository");a(this,"userMessageDebounce",{});this.evolutionBotService=e,this.botRepository=this.prismaRepository.evolutionBot,this.settingsRepository=this.prismaRepository.evolutionBotSetting,this.sessionRepository=this.prismaRepository.integrationSession}getFallbackBotId(e){return e?.botIdFallback}getFallbackFieldName(){return"botIdFallback"}getIntegrationType(){return"evolution"}getAdditionalBotData(e){return{apiUrl:e.apiUrl,apiKey:e.apiKey}}getAdditionalUpdateFields(e){return{apiUrl:e.apiUrl,apiKey:e.apiKey}}async validateNoDuplicatesOnUpdate(e,t,i){if(await this.botRepository.findFirst({where:{id:{not:e},instanceId:t,apiUrl:i.apiUrl,apiKey:i.apiKey}}))throw new Error("Evolution Bot already exists")}async processBot(e,t,i,o,n,r,c,p){await this.evolutionBotService.process(e,t,i,o,n,r,c,p)}};l(na,"EvolutionBotController");var fi=na;var Gp=x(require("axios"));var ra=class ra extends ne{constructor(e,t,i,o){super(e,t,"EvolutionBotService",i);a(this,"openaiService");this.openaiService=o}getBotType(){return"evolution"}async sendMessageToBot(e,t,i,o,n,r,c,p){try{let u={inputs:{sessionId:t.id,remoteJid:n,pushName:r,fromMe:p?.key?.fromMe,instanceName:e.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:e.token},query:c,conversation_id:t.sessionId===n?void 0:t.sessionId,user:n};if(this.isAudioMessage(c)&&p)try{this.logger.debug("[EvolutionBot] Downloading audio for Whisper transcription");let A=await this.openaiService.speechToText(p,e);A&&(u.query=`[audio] ${A}`)}catch(A){this.logger.error(`[EvolutionBot] Failed to transcribe audio: ${A}`)}if(this.isImageMessage(c)&&p){let A=c.split("|");p.message.mediaUrl||p.message.base64?u.files=[{type:"image",url:p.message.base64||p.message.mediaUrl}]:u.files=[{type:"image",url:A[1].split("?")[0]}],u.query=A[2]||c}e.integration===J.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(n),await e.client.sendPresenceUpdate("composing",n));let d=o.apiUrl;if(!d){this.logger.error("No Evolution Bot endpoint defined");return}let f={"Content-Type":"application/json"};o.apiKey&&(f={...f,Authorization:`Bearer ${o.apiKey}`});let g={...u,inputs:{...u.inputs,apiKey:u.inputs.apiKey?"[REDACTED]":void 0}},y=await Gp.default.post(d,u,{headers:f});e.integration===J.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",n);let m=y?.data?.message,S=y?.data?.linkPreview,T=typeof S=="boolean"?S:!0;if(m&&typeof m=="string"&&m.startsWith("'")&&m.endsWith("'")){let A=m.slice(1,-1);A.includes("'")||(m=A)}m?await this.sendMessageWhatsApp(e,n,m,i,T):this.logger.warn("[EvolutionBot] No message content received from bot response"),j("/message/sendText")}catch(u){this.logger.error(`Error in sendMessageToBot: ${u.message||JSON.stringify(u)}`);return}}};l(ra,"EvolutionBotService");var yi=ra;var aa=class aa extends ae{constructor(e,t,i){super(t,i);a(this,"flowiseService");a(this,"logger",new O("FlowiseController"));a(this,"integrationName","Flowise");a(this,"integrationEnabled",b.get("FLOWISE").ENABLED);a(this,"botRepository");a(this,"settingsRepository");a(this,"sessionRepository");a(this,"userMessageDebounce",{});this.flowiseService=e,this.botRepository=this.prismaRepository.flowise,this.settingsRepository=this.prismaRepository.flowiseSetting,this.sessionRepository=this.prismaRepository.integrationSession}getFallbackBotId(e){return e?.flowiseIdFallback}getFallbackFieldName(){return"flowiseIdFallback"}getIntegrationType(){return"flowise"}getAdditionalBotData(e){return{apiUrl:e.apiUrl,apiKey:e.apiKey}}getAdditionalUpdateFields(e){return{apiUrl:e.apiUrl,apiKey:e.apiKey}}async validateNoDuplicatesOnUpdate(e,t,i){if(await this.botRepository.findFirst({where:{id:{not:e},instanceId:t,apiUrl:i.apiUrl,apiKey:i.apiKey}}))throw new Error("Flowise already exists")}async processBot(e,t,i,o,n,r,c,p){await this.flowiseService.processBot(e,t,i,o,n,r,c,p)}async createBot(e,t){if(!this.integrationEnabled)throw new w("Flowise is disabled");let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id);if(await this.botRepository.findFirst({where:{instanceId:i,apiUrl:t.apiUrl,apiKey:t.apiKey}}))throw new Error("Flowise already exists");return super.createBot(e,t)}};l(aa,"FlowiseController");var wi=aa;var Kp=x(require("axios"));var ca=class ca extends ne{constructor(e,t,i,o){super(e,t,"FlowiseService",i);a(this,"openaiService");this.openaiService=o}getBotType(){return"flowise"}async processBot(e,t,i,o,n,r,c,p){await this.process(e,t,i,o,n,r,c,p)}async sendMessageToBot(e,t,i,o,n,r,c,p){let u={question:c,overrideConfig:{sessionId:n,vars:{messageId:p?.key?.id,fromMe:p?.key?.fromMe,remoteJid:n,pushName:r,instanceName:e.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:e.token}}};if(this.isAudioMessage(c)&&p)try{this.logger.debug("[Flowise] Downloading audio for Whisper transcription");let m=await this.openaiService.speechToText(p,e);m&&(u.question=`[audio] ${m}`)}catch(m){this.logger.error(`[Flowise] Failed to transcribe audio: ${m}`)}if(this.isImageMessage(c)){let m=c.split("|");p.message.mediaUrl||p.message.base64?u.uploads=[{data:p.message.base64||p.message.mediaUrl,type:"url",name:"Flowise.png",mime:"image/png"}]:(u.uploads=[{data:m[1].split("?")[0],type:"url",name:"Flowise.png",mime:"image/png"}],u.question=m[2]||c)}e.integration===J.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(n),await e.client.sendPresenceUpdate("composing",n));let d={"Content-Type":"application/json"};o.apiKey&&(d={...d,Authorization:`Bearer ${o.apiKey}`});let f=o.apiUrl;if(!f){this.logger.error("No Flowise endpoint defined");return}let g=await Kp.default.post(f,u,{headers:d});e.integration===J.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",n);let y=g?.data?.text;y&&await this.sendMessageWhatsApp(e,n,y,i,!0)}};l(ca,"FlowiseService");var Ei=ca;var la=class la extends ae{constructor(e,t,i){super(t,i);a(this,"n8nService");a(this,"logger",new O("N8nController"));a(this,"integrationName","N8n");a(this,"integrationEnabled",b.get("N8N").ENABLED);a(this,"botRepository");a(this,"settingsRepository");a(this,"sessionRepository");a(this,"userMessageDebounce",{});this.n8nService=e,this.botRepository=this.prismaRepository.n8n,this.settingsRepository=this.prismaRepository.n8nSetting,this.sessionRepository=this.prismaRepository.integrationSession}getFallbackBotId(e){return e?.fallbackId}getFallbackFieldName(){return"n8nIdFallback"}getIntegrationType(){return"n8n"}getAdditionalBotData(e){return{webhookUrl:e.webhookUrl,basicAuthUser:e.basicAuthUser,basicAuthPass:e.basicAuthPass}}getAdditionalUpdateFields(e){return{webhookUrl:e.webhookUrl,basicAuthUser:e.basicAuthUser,basicAuthPass:e.basicAuthPass}}async validateNoDuplicatesOnUpdate(e,t,i){if(await this.botRepository.findFirst({where:{id:{not:e},instanceId:t,webhookUrl:i.webhookUrl,basicAuthUser:i.basicAuthUser,basicAuthPass:i.basicAuthPass}}))throw new Error("N8n already exists")}async createBot(e,t){if(!this.integrationEnabled)throw new w("N8n is disabled");let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id);if(await this.botRepository.findFirst({where:{instanceId:i,webhookUrl:t.webhookUrl,basicAuthUser:t.basicAuthUser,basicAuthPass:t.basicAuthPass}}))throw new Error("N8n already exists");return super.createBot(e,t)}async processBot(e,t,i,o,n,r,c,p){await this.n8nService.process(e,t,i,o,n,r,c,p)}};l(la,"N8nController");var Si=la;var jp=x(require("axios"));var pa=class pa extends ne{constructor(e,t,i,o){super(e,t,"N8nService",i);a(this,"openaiService");this.openaiService=o}getBotType(){return"n8n"}async sendMessageToBot(e,t,i,o,n,r,c,p){try{if(!t){this.logger.error("Session is null in sendMessageToBot");return}let u=o.webhookUrl,d={chatInput:c,sessionId:t.sessionId,remoteJid:n,pushName:r,keyId:p?.key?.id,fromMe:p?.key?.fromMe,quotedMessage:p?.contextInfo?.quotedMessage,instanceName:e.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:e.token};if(this.isAudioMessage(c)&&p)try{this.logger.debug("[N8n] Downloading audio for Whisper transcription");let m=await this.openaiService.speechToText(p,e);m&&(d.chatInput=`[audio] ${m}`)}catch(m){this.logger.error(`[N8n] Failed to transcribe audio: ${m}`)}let f={};if(o.basicAuthUser&&o.basicAuthPass){let m=Buffer.from(`${o.basicAuthUser}:${o.basicAuthPass}`).toString("base64");f.Authorization=`Basic ${m}`}let g=await jp.default.post(u,d,{headers:f}),y=g?.data?.output||g?.data?.answer;await this.sendMessageWhatsApp(e,n,y,i,!0),await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{status:"opened",awaitUser:!0}})}catch(u){this.logger.error(u.response?.data||u);return}}};l(pa,"N8nService");var Ti=pa;var Hp=x(require("openai"));var ua=class ua extends ae{constructor(e,t,i){super(t,i);a(this,"openaiService");a(this,"logger",new O("OpenaiController"));a(this,"integrationName","Openai");a(this,"integrationEnabled",b.get("OPENAI").ENABLED);a(this,"botRepository");a(this,"settingsRepository");a(this,"sessionRepository");a(this,"userMessageDebounce",{});a(this,"client");a(this,"credsRepository");this.openaiService=e,this.botRepository=this.prismaRepository.openaiBot,this.settingsRepository=this.prismaRepository.openaiSetting,this.sessionRepository=this.prismaRepository.integrationSession,this.credsRepository=this.prismaRepository.openaiCreds}getFallbackBotId(e){return e?.openaiIdFallback}getFallbackFieldName(){return"openaiIdFallback"}getIntegrationType(){return"openai"}getAdditionalBotData(e){return{openaiCredsId:e.openaiCredsId,botType:e.botType,assistantId:e.assistantId,functionUrl:e.functionUrl,model:e.model,systemMessages:e.systemMessages,assistantMessages:e.assistantMessages,userMessages:e.userMessages,maxTokens:e.maxTokens}}getAdditionalUpdateFields(e){return{openaiCredsId:e.openaiCredsId,botType:e.botType,assistantId:e.assistantId,functionUrl:e.functionUrl,model:e.model,systemMessages:e.systemMessages,assistantMessages:e.assistantMessages,userMessages:e.userMessages,maxTokens:e.maxTokens}}async validateNoDuplicatesOnUpdate(e,t,i){let o={id:{not:e},instanceId:t};if(i.botType==="assistant"){if(!i.assistantId)throw new Error("Assistant ID is required");o={...o,assistantId:i.assistantId,botType:i.botType}}else if(i.botType==="chatCompletion"){if(!i.model)throw new Error("Model is required");if(!i.maxTokens)throw new Error("Max tokens is required");o={...o,model:i.model,maxTokens:i.maxTokens,botType:i.botType}}else throw new Error("Bot type is required");if(await this.botRepository.findFirst({where:o}))throw new Error("OpenAI Bot already exists")}async createBot(e,t){if(!this.integrationEnabled)throw new w("Openai is disabled");let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(c=>c.id),o={instanceId:i};if(t.botType==="assistant"){if(!t.assistantId)throw new Error("Assistant ID is required");o={...o,assistantId:t.assistantId,botType:t.botType}}else if(t.botType==="chatCompletion"){if(!t.model)throw new Error("Model is required");if(!t.maxTokens)throw new Error("Max tokens is required");o={...o,model:t.model,maxTokens:t.maxTokens,botType:t.botType}}else throw new Error("Bot type is required");if(await this.botRepository.findFirst({where:o}))throw new Error("Openai Bot already exists");let r=await this.settingsRepository.findFirst({where:{instanceId:i}});return r?!r.openaiCredsId&&t.openaiCredsId&&await this.settingsRepository.update({where:{id:r.id},data:{OpenaiCreds:{connect:{id:t.openaiCredsId}}}}):await this.settings(e,{openaiCredsId:t.openaiCredsId,expire:t.expire||300,keywordFinish:t.keywordFinish||"bye",delayMessage:t.delayMessage||1e3,unknownMessage:t.unknownMessage||"Sorry, I dont understand",listeningFromMe:t.listeningFromMe!==void 0?t.listeningFromMe:!0,stopBotFromMe:t.stopBotFromMe!==void 0?t.stopBotFromMe:!0,keepOpen:t.keepOpen!==void 0?t.keepOpen:!1,debounceTime:t.debounceTime||1,ignoreJids:t.ignoreJids||[],speechToText:!1}),super.createBot(e,t)}async processBot(e,t,i,o,n,r,c,p){await this.openaiService.process(e,t,i,o,n,r,c,p)}async createOpenaiCreds(e,t){if(!this.integrationEnabled)throw new w("Openai is disabled");let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id);if(!t.apiKey)throw new w("API Key is required");if(!t.name)throw new w("Name is required");if(await this.credsRepository.findFirst({where:{apiKey:t.apiKey}}))throw new w("This API key is already registered. Please use a different API key.");if(await this.credsRepository.findFirst({where:{name:t.name,instanceId:i}}))throw new w("This credential name is already in use. Please choose a different name.");try{return await this.credsRepository.create({data:{name:t.name,apiKey:t.apiKey,instanceId:i}})}catch(r){throw this.logger.error(r),new Error("Error creating openai creds")}}async findOpenaiCreds(e){if(!this.integrationEnabled)throw new w("Openai is disabled");let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id);return await this.credsRepository.findMany({where:{instanceId:t},include:{OpenaiAssistant:!0}})}async deleteCreds(e,t){if(!this.integrationEnabled)throw new w("Openai is disabled");let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.credsRepository.findFirst({where:{id:t}});if(!o)throw new Error("Openai Creds not found");if(o.instanceId!==i)throw new Error("Openai Creds not found");try{return await this.credsRepository.delete({where:{id:t}}),{openaiCreds:{id:t}}}catch(n){throw this.logger.error(n),new Error("Error deleting openai creds")}}async settings(e,t){if(!this.integrationEnabled)throw new w("Openai is disabled");try{let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(c=>c.id),o=await this.settingsRepository.findFirst({where:{instanceId:i}}),n=t.keywordFinish,r={expire:t.expire,keywordFinish:n,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,ignoreJids:t.ignoreJids,splitMessages:t.splitMessages,timePerChar:t.timePerChar,openaiIdFallback:t.fallbackId,OpenaiCreds:t.openaiCredsId?{connect:{id:t.openaiCredsId}}:void 0,speechToText:t.speechToText};if(o){let c=await this.settingsRepository.update({where:{id:o.id},data:r});return{...c,fallbackId:c.openaiIdFallback}}else{let c=await this.settingsRepository.create({data:{...r,Instance:{connect:{id:i}}}});return{...c,fallbackId:c.openaiIdFallback}}}catch(i){throw this.logger.error(i),new Error("Error setting default settings")}}async getModels(e,t){if(!this.integrationEnabled)throw new w("Openai is disabled");let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id);if(!i)throw new Error("Instance not found");let o;if(t){let n=await this.credsRepository.findFirst({where:{id:t,instanceId:i}});if(!n)throw new Error("OpenAI credentials not found for the provided ID");o=n.apiKey}else{let n=await this.settingsRepository.findFirst({where:{instanceId:i},include:{OpenaiCreds:!0}});if(!n)throw new Error("Settings not found");if(!n.OpenaiCreds)throw new Error("OpenAI credentials not found. Please create credentials and associate them with the settings.");o=n.OpenaiCreds.apiKey}try{return this.client=new Hp.default({apiKey:o}),(await this.client.models.list())?.body?.data}catch(n){throw this.logger.error(n),new Error("Error fetching models")}}};l(ua,"OpenaiController");var Ai=ua;var Yp=x(require("axios"));var da=class da extends ae{constructor(e,t,i){super(t,i);a(this,"typebotService");a(this,"logger",new O("TypebotController"));a(this,"integrationName","Typebot");a(this,"integrationEnabled",b.get("TYPEBOT").ENABLED);a(this,"botRepository");a(this,"settingsRepository");a(this,"sessionRepository");a(this,"userMessageDebounce",{});this.typebotService=e,this.botRepository=this.prismaRepository.typebot,this.settingsRepository=this.prismaRepository.typebotSetting,this.sessionRepository=this.prismaRepository.integrationSession}getFallbackBotId(e){return e?.typebotIdFallback}getFallbackFieldName(){return"typebotIdFallback"}getIntegrationType(){return"typebot"}getAdditionalBotData(e){return{url:e.url,typebot:e.typebot}}getAdditionalUpdateFields(e){return{url:e.url,typebot:e.typebot}}async validateNoDuplicatesOnUpdate(e,t,i){if(await this.botRepository.findFirst({where:{url:i.url,typebot:i.typebot,id:{not:e},instanceId:t}}))throw new Error("Typebot already exists")}async processBot(e,t,i,o,n,r,c,p){await this.typebotService.processTypebot(e,t,p,o,i,i.url,n.expire,i.typebot,n.keywordFinish,n.delayMessage,n.unknownMessage,n.listeningFromMe,n.stopBotFromMe,n.keepOpen,r,{})}async startBot(e,t){if(!this.integrationEnabled)throw new w("Typebot is disabled");if(t.remoteJid==="status@broadcast")return;let i=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}});if(!i)throw new Error("Instance not found");let o=t.remoteJid,n=t.url,r=t.typebot,c=t.startSession,p=t.variables,u=t?.typebot?.expire,d=t?.typebot?.keywordFinish,f=t?.typebot?.delayMessage,g=t?.typebot?.unknownMessage,y=t?.typebot?.listeningFromMe,m=t?.typebot?.stopBotFromMe,S=t?.typebot?.keepOpen,T=t?.typebot?.debounceTime,A=t?.typebot?.ignoreJids,N=await this.settingsRepository.findFirst({where:{instanceId:i.id}});if(this.checkIgnoreJids(N?.ignoreJids,o))throw new Error("Jid not allowed");(!u||!d||!f||!g||!y||!m||!S||!T||!A)&&(u==null&&(u=N.expire),d==null&&(d=N.keywordFinish),f==null&&(f=N.delayMessage),g==null&&(g=N.unknownMessage),y==null&&(y=N.listeningFromMe),m==null&&(m=N.stopBotFromMe),S==null&&(S=N.keepOpen),T==null&&(T=N.debounceTime),A==null&&(A=N.ignoreJids),N||await this.settings(e,{expire:u,keywordFinish:d,delayMessage:f,unknownMessage:g,listeningFromMe:y,stopBotFromMe:m,keepOpen:S,debounceTime:T,ignoreJids:A}));let I={};if(p?.length&&p.forEach(C=>{I[C.name]=C.value}),c){let C=await this.botRepository.findFirst({where:{url:n,typebot:r,instanceId:i.id}});C||(C=await this.botRepository.create({data:{enabled:!0,url:n,typebot:r,instanceId:i.id,expire:u,keywordFinish:d,delayMessage:f,unknownMessage:g,listeningFromMe:y,stopBotFromMe:m,keepOpen:S}})),await this.prismaRepository.integrationSession.deleteMany({where:{remoteJid:o,instanceId:i.id,botId:{not:null}}}),await this.typebotService.processTypebot(this.waMonitor.waInstances[i.name],o,null,null,C,n,u,r,d,f,g,y,m,S,"init",I)}else{let C=Math.floor(Math.random()*1e10).toString();try{let M=b.get("TYPEBOT").API_VERSION,v,L;M==="latest"?(v=`${t.url}/api/v1/typebots/${t.typebot}/startChat`,L={prefilledVariables:I}):(v=`${t.url}/api/v1/sendMessage`,L={startParams:{publicId:t.typebot,prefilledVariables:I}});let B=await Yp.default.post(v,L);await this.typebotService.sendWAMessage(i,null,{expire:u,keywordFinish:d,delayMessage:f,unknownMessage:g,listeningFromMe:y,stopBotFromMe:m,keepOpen:S},o,B.data.messages,B.data.input,B.data.clientSideActions),this.waMonitor.waInstances[e.instanceName].sendDataWebhook(R.TYPEBOT_START,{remoteJid:o,url:v,typebot:r,variables:p,sessionId:C})}catch(M){this.logger.error(M);return}}return{typebot:{...e,typebot:{url:n,remoteJid:o,typebot:r,prefilledVariables:I}}}}};l(da,"TypebotController");var bi=da;var Qp=require("kafkajs");var jt=class jt{constructor(s,e,t,i){a(this,"prismaRepository");a(this,"waMonitor");a(this,"integrationStatus");a(this,"integrationName");this.prisma=s,this.monitor=e,this.status=t,this.name=i}set prisma(s){this.prismaRepository=s}get prisma(){return this.prismaRepository}set monitor(s){this.waMonitor=s}get monitor(){return this.waMonitor}set name(s){this.integrationName=s}get name(){return this.integrationName}set status(s){this.integrationStatus=s}get status(){return this.integrationStatus}async set(s,e){if(this.status)return e[this.name]?.enabled?e[this.name].events.length===0&&(e[this.name].events=jt.events):e[this.name].events=[],this.prisma[this.name].upsert({where:{instanceId:this.monitor.waInstances[s].instanceId},update:{enabled:e[this.name]?.enabled,events:e[this.name].events},create:{enabled:e[this.name]?.enabled,events:e[this.name].events,instanceId:this.monitor.waInstances[s].instanceId}})}async get(s){if(!this.status)return;if(this.monitor.waInstances[s]===void 0)return null;let e=await this.prisma[this.name].findUnique({where:{instanceId:this.monitor.waInstances[s].instanceId}});return e||null}};l(jt,"EventController"),a(jt,"events",["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","SEND_MESSAGE_UPDATE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS","REMOVE_INSTANCE","LOGOUT_INSTANCE","INSTANCE_CREATE","INSTANCE_DELETE","STATUS_INSTANCE"]);var Y=jt;var ha=class ha extends Y{constructor(e,t){super(e,t,b.get("KAFKA")?.ENABLED,"kafka");a(this,"kafkaClient",null);a(this,"producer",null);a(this,"consumer",null);a(this,"logger",new O("KafkaController"));a(this,"reconnectAttempts",0);a(this,"maxReconnectAttempts",10);a(this,"reconnectDelay",5e3);a(this,"isReconnecting",!1)}async init(){this.status&&await this.connect()}async connect(){try{let e=b.get("KAFKA"),t={clientId:e.CLIENT_ID||"evolution-api",brokers:e.BROKERS||["localhost:9092"],connectionTimeout:e.CONNECTION_TIMEOUT||3e3,requestTimeout:e.REQUEST_TIMEOUT||3e4,retry:{initialRetryTime:100,retries:8}};e.SASL?.ENABLED&&(t.sasl={mechanism:e.SASL.MECHANISM||"plain",username:e.SASL.USERNAME,password:e.SASL.PASSWORD}),e.SSL?.ENABLED&&(t.ssl={rejectUnauthorized:e.SSL.REJECT_UNAUTHORIZED!==!1,ca:e.SSL.CA?[e.SSL.CA]:void 0,key:e.SSL.KEY,cert:e.SSL.CERT}),this.kafkaClient=new Qp.Kafka(t);let i={maxInFlightRequests:1,idempotent:!0,transactionTimeout:3e4};this.producer=this.kafkaClient.producer(i),await this.producer.connect(),e.GLOBAL_ENABLED&&await this.initGlobalConsumer(),this.reconnectAttempts=0,this.isReconnecting=!1,this.logger.info("Kafka initialized successfully"),e.AUTO_CREATE_TOPICS&&await this.createTopics()}catch(e){throw this.logger.error({local:"KafkaController.connect",message:"Failed to connect to Kafka",error:e.message||e}),this.scheduleReconnect(),e}}async initGlobalConsumer(){try{let e=b.get("KAFKA"),t={groupId:e.CONSUMER_GROUP_ID||"evolution-api-consumers",sessionTimeout:3e4,heartbeatInterval:3e3};this.consumer=this.kafkaClient.consumer(t),await this.consumer.connect();let i=e.EVENTS;if(i){let o=Object.keys(i).filter(n=>i[n]);for(let n of o){let r=this.getTopicName(n,!0);await this.consumer.subscribe({topic:r})}await this.consumer.run({eachMessage:l(async({topic:n,message:r})=>{try{let c=JSON.parse(r.value?.toString()||"{}");this.logger.debug(`Received message from topic ${n}: ${JSON.stringify(c)}`)}catch(c){this.logger.error(`Error processing message from topic ${n}: ${c}`)}},"eachMessage")}),this.logger.info("Global Kafka consumer initialized")}}catch(e){this.logger.error(`Failed to initialize global Kafka consumer: ${e}`)}}async createTopics(){try{let e=b.get("KAFKA"),t=this.kafkaClient.admin();await t.connect();let i=[];if(e.GLOBAL_ENABLED&&e.EVENTS){let o=Object.keys(e.EVENTS).filter(n=>e.EVENTS[n]);for(let n of o){let r=this.getTopicName(n,!0);i.push({topic:r,numPartitions:e.NUM_PARTITIONS||1,replicationFactor:e.REPLICATION_FACTOR||1})}}i.length>0&&(await t.createTopics({topics:i,waitForLeaders:!0}),this.logger.info(`Created ${i.length} Kafka topics`)),await t.disconnect()}catch(e){this.logger.error(`Failed to create Kafka topics: ${e}`)}}getTopicName(e,t=!1,i){let n=b.get("KAFKA").TOPIC_PREFIX||"evolution";return t?`${n}.global.${e.toLowerCase().replace(/_/g,".")}`:`${n}.${i}.${e.toLowerCase().replace(/_/g,".")}`}handleConnectionLoss(){this.isReconnecting||(this.cleanup(),this.scheduleReconnect())}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){this.logger.error(`Maximum reconnect attempts (${this.maxReconnectAttempts}) reached. Stopping reconnection attempts.`);return}if(this.isReconnecting)return;this.isReconnecting=!0,this.reconnectAttempts++;let e=this.reconnectDelay*Math.pow(2,Math.min(this.reconnectAttempts-1,5));this.logger.info(`Scheduling Kafka reconnection attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${e}ms`),setTimeout(async()=>{try{this.logger.info(`Attempting to reconnect to Kafka (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),await this.connect(),this.logger.info("Successfully reconnected to Kafka")}catch(t){this.logger.error({local:"KafkaController.scheduleReconnect",message:`Reconnection attempt ${this.reconnectAttempts} failed`,error:t.message||t}),this.isReconnecting=!1,this.scheduleReconnect()}},e)}async ensureConnection(){return this.producer?!0:(this.logger.warn("Kafka producer is not available, attempting to reconnect..."),this.isReconnecting||this.scheduleReconnect(),!1)}async emit({instanceName:e,origin:t,event:i,data:o,serverUrl:n,dateTime:r,sender:c,apiKey:p,integration:u,extra:d}){if(u&&!u.includes("kafka")||!this.status)return;if(!await this.ensureConnection()){this.logger.warn(`Failed to emit event ${i} for instance ${e}: No Kafka connection`);return}let f=await this.get(e),g=f?.events,y=b.get("KAFKA").GLOBAL_ENABLED,m=b.get("KAFKA").EVENTS,S=i.replace(/[.-]/gm,"_").toUpperCase(),T=b.get("LOG").LEVEL.includes("WEBHOOKS"),A={...d??{},event:i,instance:e,data:o,server_url:n,date_time:r,sender:c,apikey:p,timestamp:Date.now()},N=JSON.stringify(A);if(f?.enabled&&this.producer&&Array.isArray(g)&&g.includes(S)){let I=this.getTopicName(i,!1,e),C=0;for(;C<3;)try{if(await this.producer.send({topic:I,messages:[{key:e,value:N,headers:{event:i,instance:e,origin:t,timestamp:r}}]}),T){let M={local:`${t}.sendData-Kafka`,...A};this.logger.log(M)}break}catch(M){this.logger.error({local:"KafkaController.emit",message:`Error publishing local Kafka message (attempt ${C+1}/3)`,error:M.message||M}),C++,C>=3&&this.handleConnectionLoss()}}if(y&&m[S]&&this.producer){let I=this.getTopicName(i,!0),C=0;for(;C<3;)try{if(await this.producer.send({topic:I,messages:[{key:`${e}-${i}`,value:N,headers:{event:i,instance:e,origin:t,timestamp:r}}]}),T){let M={local:`${t}.sendData-Kafka-Global`,...A};this.logger.log(M)}break}catch(M){this.logger.error({local:"KafkaController.emit",message:`Error publishing global Kafka message (attempt ${C+1}/3)`,error:M.message||M}),C++,C>=3&&this.handleConnectionLoss()}}}async cleanup(){try{this.consumer&&(await this.consumer.disconnect(),this.consumer=null),this.producer&&(await this.producer.disconnect(),this.producer=null),this.kafkaClient=null}catch(e){this.logger.warn({local:"KafkaController.cleanup",message:"Error during cleanup",error:e.message||e}),this.producer=null,this.consumer=null,this.kafkaClient=null}}};l(ha,"KafkaController");var Ii=ha;var Mi=require("nats");var ma=class ma extends Y{constructor(e,t){super(e,t,b.get("NATS")?.ENABLED,"nats");a(this,"natsClient",null);a(this,"logger",new O("NatsController"));a(this,"sc",(0,Mi.StringCodec)())}async init(){if(this.status)try{let e=b.get("NATS").URI;this.natsClient=await(0,Mi.connect)({servers:e}),this.logger.info("NATS initialized"),b.get("NATS")?.GLOBAL_ENABLED&&await this.initGlobalSubscriptions()}catch(e){throw this.logger.error("Failed to connect to NATS:"),this.logger.error(e),e}}async emit({instanceName:e,origin:t,event:i,data:o,serverUrl:n,dateTime:r,sender:c,apiKey:p,integration:u,extra:d}){if(u&&!u.includes("nats")||!this.status||!this.natsClient)return;let f=await this.get(e),g=f?.events,y=b.get("NATS").GLOBAL_ENABLED,m=b.get("NATS").EVENTS,S=b.get("NATS").PREFIX_KEY,T=i.replace(/[.-]/gm,"_").toUpperCase(),A=b.get("LOG").LEVEL.includes("WEBHOOKS"),N={...d??{},event:i,instance:e,data:o,server_url:n,date_time:r,sender:c,apikey:p};if(f?.enabled&&Array.isArray(g)&&g.includes(T)){let I=`${e}.${i.toLowerCase()}`;try{if(this.natsClient.publish(I,this.sc.encode(JSON.stringify(N))),A){let C={local:`${t}.sendData-NATS`,...N};this.logger.log(C)}}catch(C){this.logger.error(`Failed to publish to NATS (instance): ${C}`)}}if(y&&m[T])try{let I=S?`${S}.${i.toLowerCase()}`:i.toLowerCase();if(this.natsClient.publish(I,this.sc.encode(JSON.stringify(N))),A){let C={local:`${t}.sendData-NATS-Global`,...N};this.logger.log(C)}}catch(I){this.logger.error(`Failed to publish to NATS (global): ${I}`)}}async initGlobalSubscriptions(){this.logger.info("Initializing global subscriptions");let e=b.get("NATS").EVENTS,t=b.get("NATS").PREFIX_KEY;if(!e){this.logger.warn("No events to initialize on NATS");return}let i=Object.keys(e);for(let o of i){if(e[o]===!1)continue;let n=t?`${t}.${o.toLowerCase()}`:o.toLowerCase();try{let r=this.natsClient.subscribe(n);this.logger.info(`Subscribed to: ${n}`),(async()=>{for await(let c of r)try{let p=JSON.parse(this.sc.decode(c.data));this.logger.debug(`Received message on ${n}:`),this.logger.debug(p)}catch(p){this.logger.error(`Error processing message on ${n}:`),this.logger.error(p)}})()}catch(r){this.logger.error(`Failed to subscribe to ${n}:`),this.logger.error(r)}}}};l(ma,"NatsController");var Ci=ma;var vi=x(require("pusher"));var ga=class ga extends Y{constructor(e,t){super(e,t,b.get("PUSHER")?.ENABLED,"pusher");a(this,"logger",new O("PusherController"));a(this,"pusherClients",{});a(this,"globalPusherClient",null);a(this,"pusherConfig",b.get("PUSHER"));this.init()}async init(){if(!this.status)return;if(this.pusherConfig.GLOBAL?.ENABLED){let{APP_ID:t,KEY:i,SECRET:o,CLUSTER:n,USE_TLS:r}=this.pusherConfig.GLOBAL;t&&i&&o&&n&&(this.globalPusherClient=new vi.default({appId:t,key:i,secret:o,cluster:n,useTLS:r}),this.logger.info("Pusher global client initialized"))}(await this.prismaRepository.instance.findMany({where:{Pusher:{isNot:null}},include:{Pusher:!0}})).forEach(t=>{t.Pusher.enabled&&t.Pusher.appId&&t.Pusher.key&&t.Pusher.secret&&t.Pusher.cluster?(this.pusherClients[t.name]=new vi.default({appId:t.Pusher.appId,key:t.Pusher.key,secret:t.Pusher.secret,cluster:t.Pusher.cluster,useTLS:t.Pusher.useTLS}),this.logger.info(`Pusher client initialized for instance ${t.name}`)):(delete this.pusherClients[t.name],this.logger.warn(`Pusher client disabled or misconfigured for instance ${t.name}`))})}async set(e,t){t.pusher?.enabled?t.pusher.events.length===0&&(t.pusher.events=Y.events):t.pusher.events=[];let i=await this.prisma.pusher.upsert({where:{instanceId:this.monitor.waInstances[e].instanceId},update:{enabled:t.pusher.enabled,events:t.pusher.events,appId:t.pusher.appId,key:t.pusher.key,secret:t.pusher.secret,cluster:t.pusher.cluster,useTLS:t.pusher.useTLS},create:{enabled:t.pusher.enabled,events:t.pusher.events,instanceId:this.monitor.waInstances[e].instanceId,appId:t.pusher.appId,key:t.pusher.key,secret:t.pusher.secret,cluster:t.pusher.cluster,useTLS:t.pusher.useTLS}});return i.enabled&&i.appId&&i.key&&i.secret&&i.cluster?(this.pusherClients[e]=new vi.default({appId:i.appId,key:i.key,secret:i.secret,cluster:i.cluster,useTLS:i.useTLS}),this.logger.info(`Pusher client initialized for instance ${e}`)):(delete this.pusherClients[e],this.logger.warn(`Pusher client disabled or misconfigured for instance ${e}`)),i}async emit({instanceName:e,origin:t,event:i,data:o,serverUrl:n,dateTime:r,sender:c,apiKey:p,local:u,integration:d,extra:f}){if(d&&!d.includes("pusher")||!this.status)return;let g=await this.get(e),y=i.replace(/[.-]/gm,"_").toUpperCase(),m=b.get("LOG").LEVEL.includes("WEBHOOKS"),S=i.replace(/_/g,".").toLowerCase(),T={...f??{},event:i,instance:e,data:o,destination:g?.appId||this.pusherConfig.GLOBAL?.APP_ID,date_time:r,sender:c,server_url:n,apikey:p};i=="qrcode.updated"&&delete T.data.qrcode.base64;let A=JSON.stringify(T),N=Buffer.byteLength(A,"utf8");if(N>10240){this.logger.error({local:`${t}.sendData-Pusher`,message:"Payload size exceeds Pusher limit",event:i,instanceName:e,payloadSize:N});return}if(u&&g&&g.enabled){let C=g.events;if(Array.isArray(C)&&C.includes(y)){m&&this.logger.log({local:`${t}.sendData-Pusher`,appId:g.appId,...T});try{let M=this.pusherClients[e];M?M.trigger(e,S,T):this.logger.error(`Pusher client not found for instance ${e}`)}catch(M){this.logger.error({local:`${t}.sendData-Pusher`,message:M?.message,error:M})}}}if(this.pusherConfig.GLOBAL?.ENABLED&&this.pusherConfig.EVENTS[y]){m&&this.logger.log({local:`${t}.sendData-Pusher-Global`,appId:this.pusherConfig.GLOBAL?.APP_ID,...T});try{this.globalPusherClient?this.globalPusherClient.trigger(e,S,T):this.logger.error("Global Pusher client not initialized")}catch(M){this.logger.error({local:`${t}.sendData-Pusher-Global`,message:M?.message,error:M})}}}};l(ga,"PusherController");var Ni=ga;var zp=x(require("amqplib/callback_api"));var fa=class fa extends Y{constructor(e,t){super(e,t,b.get("RABBITMQ")?.ENABLED,"rabbitmq");a(this,"amqpChannel",null);a(this,"amqpConnection",null);a(this,"logger",new O("RabbitmqController"));a(this,"reconnectAttempts",0);a(this,"maxReconnectAttempts",10);a(this,"reconnectDelay",5e3);a(this,"isReconnecting",!1)}async init(){this.status&&await this.connect()}async connect(){return new Promise((e,t)=>{let i=b.get("RABBITMQ").URI,o=b.get("RABBITMQ").FRAME_MAX,n=b.get("RABBITMQ").EXCHANGE_NAME,r=new URL(i),c={protocol:r.protocol.slice(0,-1),hostname:r.hostname,port:r.port||5672,username:r.username||"guest",password:r.password||"guest",vhost:r.pathname.slice(1)||"/",frameMax:o,heartbeat:30};zp.connect(c,(p,u)=>{if(p){this.logger.error({local:"RabbitmqController.connect",message:"Failed to connect to RabbitMQ",error:p.message||p}),t(p);return}u.on("error",d=>{this.logger.error({local:"RabbitmqController.connectionError",message:"RabbitMQ connection error",error:d.message||d}),this.handleConnectionLoss()}),u.on("close",()=>{this.logger.warn("RabbitMQ connection closed"),this.handleConnectionLoss()}),u.createChannel((d,f)=>{if(d){this.logger.error({local:"RabbitmqController.createChannel",message:"Failed to create RabbitMQ channel",error:d.message||d}),t(d);return}f.on("error",y=>{this.logger.error({local:"RabbitmqController.channelError",message:"RabbitMQ channel error",error:y.message||y}),this.handleConnectionLoss()}),f.on("close",()=>{this.logger.warn("RabbitMQ channel closed"),this.handleConnectionLoss()});let g=n;f.assertExchange(g,"topic",{durable:!0,autoDelete:!1}),this.amqpConnection=u,this.amqpChannel=f,this.reconnectAttempts=0,this.isReconnecting=!1,this.logger.info("AMQP initialized successfully"),e()})})}).then(()=>{b.get("RABBITMQ")?.GLOBAL_ENABLED&&this.initGlobalQueues()}).catch(e=>{throw this.logger.error({local:"RabbitmqController.init",message:"Failed to initialize AMQP",error:e.message||e}),this.scheduleReconnect(),e})}handleConnectionLoss(){this.isReconnecting||(this.cleanup(),this.scheduleReconnect())}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){this.logger.error(`Maximum reconnect attempts (${this.maxReconnectAttempts}) reached. Stopping reconnection attempts.`);return}if(this.isReconnecting)return;this.isReconnecting=!0,this.reconnectAttempts++;let e=this.reconnectDelay*Math.pow(2,Math.min(this.reconnectAttempts-1,5));this.logger.info(`Scheduling RabbitMQ reconnection attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${e}ms`),setTimeout(async()=>{try{this.logger.info(`Attempting to reconnect to RabbitMQ (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),await this.connect(),this.logger.info("Successfully reconnected to RabbitMQ")}catch(t){this.logger.error({local:"RabbitmqController.scheduleReconnect",message:`Reconnection attempt ${this.reconnectAttempts} failed`,error:t.message||t}),this.isReconnecting=!1,this.scheduleReconnect()}},e)}set channel(e){this.amqpChannel=e}get channel(){return this.amqpChannel}async ensureConnection(){return this.amqpChannel?!0:(this.logger.warn("AMQP channel is not available, attempting to reconnect..."),this.isReconnecting||this.scheduleReconnect(),!1)}async emit({instanceName:e,origin:t,event:i,data:o,serverUrl:n,dateTime:r,sender:c,apiKey:p,integration:u,extra:d}){if(u&&!u.includes("rabbitmq")||!this.status)return;if(!await this.ensureConnection()){this.logger.warn(`Failed to emit event ${i} for instance ${e}: No AMQP connection`);return}let f=await this.get(e),g=f?.events,y=b.get("RABBITMQ").GLOBAL_ENABLED,m=b.get("RABBITMQ").EVENTS,S=b.get("RABBITMQ").PREFIX_KEY,T=b.get("RABBITMQ").EXCHANGE_NAME,A=i.replace(/[.-]/gm,"_").toUpperCase(),N=b.get("LOG").LEVEL.includes("WEBHOOKS"),I={...d??{},event:i,instance:e,data:o,server_url:n,date_time:r,sender:c,apikey:p};if(f?.enabled&&this.amqpChannel&&Array.isArray(g)&&g.includes(A)){let C=e??T,M=0;for(;M<3;)try{await this.amqpChannel.assertExchange(C,"topic",{durable:!0,autoDelete:!1});let v=i.replace(/_/g,".").toLowerCase(),L=`${e}.${v}`;if(await this.amqpChannel.assertQueue(L,{durable:!0,autoDelete:!1,arguments:{"x-queue-type":"quorum"}}),await this.amqpChannel.bindQueue(L,C,v),await this.amqpChannel.publish(C,i,Buffer.from(JSON.stringify(I))),N){let B={local:`${t}.sendData-RabbitMQ`,...I};this.logger.log(B)}break}catch(v){this.logger.error({local:"RabbitmqController.emit",message:`Error publishing local RabbitMQ message (attempt ${M+1}/3)`,error:v.message||v}),M++,M>=3&&this.handleConnectionLoss()}}if(y&&m[A]&&this.amqpChannel){let C=T,M=0;for(;M<3;)try{await this.amqpChannel.assertExchange(C,"topic",{durable:!0,autoDelete:!1});let v=S?`${S}.${i.replace(/_/g,".").toLowerCase()}`:i.replace(/_/g,".").toLowerCase();if(await this.amqpChannel.assertQueue(v,{durable:!0,autoDelete:!1,arguments:{"x-queue-type":"quorum"}}),await this.amqpChannel.bindQueue(v,C,i),await this.amqpChannel.publish(C,i,Buffer.from(JSON.stringify(I))),N){let L={local:`${t}.sendData-RabbitMQ-Global`,...I};this.logger.log(L)}break}catch(v){this.logger.error({local:"RabbitmqController.emit",message:`Error publishing global RabbitMQ message (attempt ${M+1}/3)`,error:v.message||v}),M++,M>=3&&this.handleConnectionLoss()}}}async initGlobalQueues(){if(this.logger.info("Initializing global queues"),!await this.ensureConnection()){this.logger.error("Cannot initialize global queues: No AMQP connection");return}let e=b.get("RABBITMQ").EXCHANGE_NAME,t=b.get("RABBITMQ").EVENTS,i=b.get("RABBITMQ").PREFIX_KEY;if(!t){this.logger.warn("No events to initialize on AMQP");return}let o=Object.keys(t);for(let n of o)if(t[n]!==!1)try{let r=i!==""?`${i}.${n.replace(/_/g,".").toLowerCase()}`:`${n.replace(/_/g,".").toLowerCase()}`,c=e;await this.amqpChannel.assertExchange(c,"topic",{durable:!0,autoDelete:!1}),await this.amqpChannel.assertQueue(r,{durable:!0,autoDelete:!1,arguments:{"x-queue-type":"quorum"}}),await this.amqpChannel.bindQueue(r,c,n),this.logger.info(`Global queue initialized: ${r}`)}catch(r){this.logger.error({local:"RabbitmqController.initGlobalQueues",message:`Failed to initialize global queue for event ${n}`,error:r.message||r}),this.handleConnectionLoss();break}}async cleanup(){try{this.amqpChannel&&(await this.amqpChannel.close(),this.amqpChannel=null),this.amqpConnection&&(await this.amqpConnection.close(),this.amqpConnection=null)}catch(e){this.logger.warn({local:"RabbitmqController.cleanup",message:"Error during cleanup",error:e.message||e}),this.amqpChannel=null,this.amqpConnection=null}}};l(fa,"RabbitmqController");var _i=fa;var Ke=require("@aws-sdk/client-sqs");var ya=class ya extends Y{constructor(e,t){super(e,t,b.get("SQS")?.ENABLED,"sqs");a(this,"sqs");a(this,"logger",new O("SqsController"))}async init(){if(!this.status)return;let e=b.get("SQS");this.sqs=new Ke.SQS({credentials:{accessKeyId:e.ACCESS_KEY_ID,secretAccessKey:e.SECRET_ACCESS_KEY},region:e.REGION}),this.logger.info("SQS initialized");let t=b.get("SQS");if(this.sqs&&t.GLOBAL_ENABLED){let i=Object.keys(t.EVENTS).filter(o=>t.EVENTS[o]);await this.saveQueues(t.GLOBAL_PREFIX_NAME,i,!0)}}set channel(e){this.sqs=e}get channel(){return this.sqs}async set(e,t){if(!this.status||b.get("SQS").GLOBAL_ENABLED)return;t[this.name]?.enabled?t[this.name].events.length===0&&(t[this.name].events=Y.events):t[this.name].events=[],await this.saveQueues(e,t[this.name].events,t[this.name]?.enabled);let i={where:{instanceId:this.monitor.waInstances[e].instanceId},update:{enabled:t[this.name]?.enabled,events:t[this.name].events},create:{enabled:t[this.name]?.enabled,events:t[this.name].events,instanceId:this.monitor.waInstances[e].instanceId}};return console.log("*** payload: ",i),this.prisma[this.name].upsert(i)}async emit({instanceName:e,origin:t,event:i,data:o,serverUrl:n,dateTime:r,sender:c,apiKey:p,integration:u,extra:d}){if(!(u&&!u.includes("sqs"))&&this.status&&this.sqs){let f=b.get("SERVER"),g=b.get("SQS"),y=i.replace(/[.-]/gm,"_").toUpperCase(),m=[];if(g.GLOBAL_ENABLED)m=Object.keys(g.EVENTS).filter(S=>g.EVENTS[S]);else{let S=await this.get(e);S?.enabled&&Array.isArray(S?.events)&&(m=S?.events)}if(Array.isArray(m)&&m.includes(y)){let S=g.GLOBAL_ENABLED?g.GLOBAL_PREFIX_NAME:e,T=g.GLOBAL_ENABLED&&g.GLOBAL_FORCE_SINGLE_QUEUE?"singlequeue":`${i.replace(".","_").toLowerCase()}`,A=`${S}_${T}.fifo`,N=`https://sqs.${g.REGION}.amazonaws.com/${g.ACCOUNT_ID}/${A}`,I={...d??{},event:i,instance:e,dataType:"json",data:o,server:f.NAME,server_url:n,date_time:r,sender:c,apikey:p},C=JSON.stringify(I),M=Buffer.byteLength(C,"utf8");if(M>g.MAX_PAYLOAD_SIZE){if(!b.get("S3").ENABLE){this.logger.error(`${e} - ${T} - SQS ignored: payload (${M} bytes) exceeds SQS size limit (${g.MAX_PAYLOAD_SIZE} bytes) and S3 storage is not enabled.`);return}let W=Buffer.from(C,"utf8"),q=`messages/${e}_${T}_${Date.now()}.json`;await We(q,W,M,{"Content-Type":"application/json","Cache-Control":"no-store"});let X=await Pe(q);I.data={fileUrl:X},I.dataType="s3"}let v=g.GLOBAL_ENABLED?`${f.NAME}-${T}-${e}`:"evolution",L=g.GLOBAL_ENABLED,B={MessageBody:JSON.stringify(I),MessageGroupId:v,QueueUrl:N,...!L&&{MessageDeduplicationId:`${e}_${T}_${Date.now()}`}};this.sqs.sendMessage(B,W=>{if(W)this.logger.error({local:`${t}.sendData-SQS`,params:JSON.stringify(I),sqsUrl:N,message:W?.message,hostName:W?.hostname,code:W?.code,stack:W?.stack,name:W?.name,url:A,server_url:n});else if(b.get("LOG").LEVEL.includes("WEBHOOKS")){let q={local:`${t}.sendData-SQS`,...I};this.logger.log(q)}})}}}async saveQueues(e,t,i){if(i){let o=b.get("SQS"),n=await this.listQueues(e);console.log("eventsFinded",n);for(let r of t){let c=o.GLOBAL_ENABLED&&o.GLOBAL_FORCE_SINGLE_QUEUE?"singlequeue":r.toLowerCase();if(n.includes(c)){this.logger.info(`A queue para o evento "${c}" j\xE1 existe. Ignorando cria\xE7\xE3o.`);continue}let p=`${e}_${c}.fifo`;try{let u=o.GLOBAL_ENABLED,d=new Ke.CreateQueueCommand({QueueName:p,Attributes:{FifoQueue:"true",...u&&{ContentBasedDeduplication:"true"}}}),f=await this.sqs.send(d);this.logger.info(`Queue ${p} criada: ${f.QueueUrl}`)}catch(u){this.logger.error(`Erro ao criar queue ${p}: ${u.message}`)}if(o.GLOBAL_ENABLED&&o.GLOBAL_FORCE_SINGLE_QUEUE)break}}}async listQueues(e){let t=[];try{let i=new Ke.ListQueuesCommand({QueueNamePrefix:`${e}_`}),o=await this.sqs.send(i);o.QueueUrls&&o.QueueUrls.length>0&&(t=o.QueueUrls.map(n=>{let r=n.split("/");return r[r.length-1]}))}catch(i){this.logger.error(`Erro ao listar filas para ${e}: ${i.message}`);return}return t.map(i=>i.startsWith(`${e}_`)&&i.endsWith(".fifo")?i.substring(e.length+1,i.length-5).toLowerCase():"").filter(i=>i!=="")}async removeQueuesByInstance(e){try{let t=new Ke.ListQueuesCommand({QueueNamePrefix:`${e}_`}),i=await this.sqs.send(t);if(!i.QueueUrls||i.QueueUrls.length===0){this.logger.info(`No queues found for ${e}`);return}for(let o of i.QueueUrls)try{let n=new Ke.DeleteQueueCommand({QueueUrl:o});await this.sqs.send(n),this.logger.info(`Queue ${o} deleted`)}catch(n){this.logger.error(`Error deleting queue ${o}: ${n.message}`)}}catch(t){this.logger.error(`Error listing queues for ${e}: ${t.message}`)}}};l(ya,"SqsController");var Ri=ya;var wa=x(require("axios")),Xp=x(require("jsonwebtoken"));var Ea=class Ea extends Y{constructor(e,t){super(e,t,!0,"webhook");a(this,"logger",new O("WebhookController"))}async set(e,t){return t.webhook?.enabled?t.webhook.events.length===0&&(t.webhook.events=Y.events):t.webhook.events=[],this.prisma.webhook.upsert({where:{instanceId:this.monitor.waInstances[e].instanceId},update:{enabled:t.webhook?.enabled,events:t.webhook?.events,url:t.webhook?.url,headers:t.webhook?.headers,webhookBase64:t.webhook.base64,webhookByEvents:t.webhook.byEvents},create:{enabled:t.webhook?.enabled,events:t.webhook?.events,instanceId:this.monitor.waInstances[e].instanceId,url:t.webhook?.url,headers:t.webhook?.headers,webhookBase64:t.webhook.base64,webhookByEvents:t.webhook.byEvents}})}async emit({instanceName:e,origin:t,event:i,data:o,serverUrl:n,dateTime:r,sender:c,apiKey:p,local:u,integration:d,extra:f}){if(d&&!d.includes("webhook"))return;let g=await this.get(e),y=b.get("WEBHOOK"),m=g?.events,S={...g?.headers||{}};if(S&&"jwt_key"in S){let M=S.jwt_key,v=this.generateJwtToken(M);S.Authorization=`Bearer ${v}`,delete S.jwt_key}let T=i.replace(/[.-]/gm,"_").toUpperCase(),A=T.replace(/_/gm,"-").toLowerCase(),N=b.get("LOG").LEVEL.includes("WEBHOOKS"),I=/^(https?:\/\/)/,C={...f??{},event:i,instance:e,data:o,destination:g?.url||`${y.GLOBAL.URL}/${A}`,date_time:r,sender:c,server_url:n,apikey:p};if(u&&g?.enabled&&Array.isArray(m)&&m.includes(T)){let M;if(g?.webhookByEvents?M=`${g?.url}/${A}`:M=g?.url,N){let v={local:`${t}.sendData-Webhook`,url:M,...C};this.logger.log(v)}try{if(g?.enabled&&I.test(g.url)){let v=wa.default.create({baseURL:M,headers:S,timeout:y.REQUEST?.TIMEOUT_MS??3e4});await this.retryWebhookRequest(v,C,`${t}.sendData-Webhook`,M,n)}}catch(v){this.logger.error({local:`${t}.sendData-Webhook`,message:`Todas as tentativas falharam: ${v?.message}`,hostName:v?.hostname,syscall:v?.syscall,code:v?.code,error:v?.errno,stack:v?.stack,name:v?.name,url:M,server_url:n})}}if(y.GLOBAL?.ENABLED&&y.EVENTS[T]){let M=y.GLOBAL.URL;if(y.GLOBAL.WEBHOOK_BY_EVENTS&&(M=`${M}/${A}`),N){let v={local:`${t}.sendData-Webhook-Global`,url:M,...C};this.logger.log(v)}try{if(I.test(M)){let v=wa.default.create({baseURL:M,timeout:y.REQUEST?.TIMEOUT_MS??3e4});await this.retryWebhookRequest(v,C,`${t}.sendData-Webhook-Global`,M,n)}}catch(v){this.logger.error({local:`${t}.sendData-Webhook-Global`,message:`Todas as tentativas falharam: ${v?.message}`,hostName:v?.hostname,syscall:v?.syscall,code:v?.code,error:v?.errno,stack:v?.stack,name:v?.name,url:M,server_url:n})}}}async retryWebhookRequest(e,t,i,o,n,r,c){let p=b.get("WEBHOOK"),u=r??p.RETRY?.MAX_ATTEMPTS??10,d=c??p.RETRY?.INITIAL_DELAY_SECONDS??5,f=p.RETRY?.USE_EXPONENTIAL_BACKOFF??!0,g=p.RETRY?.MAX_DELAY_SECONDS??300,y=p.RETRY?.JITTER_FACTOR??.2,m=p.RETRY?.NON_RETRYABLE_STATUS_CODES??[400,401,403,404,422],S=0;for(;S<u;)try{await e.post("",t),S>0&&this.logger.log({local:`${i}`,message:`Sucesso no envio ap\xF3s ${S+1} tentativas`,url:o});return}catch(T){S++;let A=T.code==="ECONNABORTED";if(T?.response?.status&&m.includes(T.response.status))throw this.logger.error({local:`${i}`,message:`Erro n\xE3o recuper\xE1vel (${T.response.status}): ${T?.message}. Cancelando retentativas.`,statusCode:T?.response?.status,url:o,server_url:n}),T;if(this.logger.error({local:`${i}`,message:`Tentativa ${S}/${u} falhou: ${A?"Timeout da requisi\xE7\xE3o":T?.message}`,hostName:T?.hostname,syscall:T?.syscall,code:T?.code,isTimeout:A,statusCode:T?.response?.status,error:T?.errno,stack:T?.stack,name:T?.name,url:o,server_url:n}),S===u)throw T;let N=d;if(f){N=Math.min(d*Math.pow(2,S-1),g);let I=N*y*(Math.random()*2-1);N=Math.max(d,N+I)}this.logger.log({local:`${i}`,message:`Aguardando ${N.toFixed(1)} segundos antes da pr\xF3xima tentativa`,url:o}),await new Promise(I=>setTimeout(I,N*1e3))}}generateJwtToken(e){try{let t={iat:Math.floor(Date.now()/1e3),exp:Math.floor(Date.now()/1e3)+600,app:"evolution",action:"webhook"};return Xp.sign(t,e,{algorithm:"HS256"})}catch(t){throw this.logger.error({local:"WebhookController.generateJwtToken",message:`JWT generation failed: ${t?.message}`}),t}}};l(Ea,"WebhookController");var Oi=Ea;var Zp=require("socket.io");var Sa=class Sa extends Y{constructor(e,t){super(e,t,b.get("WEBSOCKET")?.ENABLED,"websocket");a(this,"io");a(this,"corsConfig");a(this,"logger",new O("WebsocketController"));this.cors=b.get("CORS").ORIGIN}init(e){this.status&&(this.socket=new Zp.Server(e,{cors:{origin:this.cors},allowRequest:l(async(t,i)=>{try{let o=new URL(t.url||"","http://localhost"),n=new URLSearchParams(o.search),{remoteAddress:r}=t.socket,p=b.get("WEBSOCKET").ALLOWED_HOSTS||"127.0.0.1,::1,::ffff:127.0.0.1",d=p.trim()==="*"||p.split(",").map(y=>y.trim()).includes(r);if(n.has("EIO")&&d)return i(null,!0);let f=n.get("apikey")||t.headers.apikey;if(!f)return this.logger.error("Connection rejected: apiKey not provided"),i("apiKey is required",!1);if(!await this.prismaRepository.instance.findFirst({where:{token:f}})){let y=b.get("AUTHENTICATION").API_KEY.KEY;if(f!==y)return this.logger.error("Connection rejected: invalid global token"),i("Invalid global token",!1)}i(null,!0)}catch(o){this.logger.error("Authentication error:"),this.logger.error(o),i("Authentication error",!1)}},"allowRequest")}),this.socket.on("connection",t=>{this.logger.info("User connected"),t.on("disconnect",()=>{this.logger.info("User disconnected")}),t.on("sendNode",async i=>{try{await this.waMonitor.waInstances[i.instanceId].baileysSendNode(i.stanza),this.logger.info("Node sent successfully")}catch(o){this.logger.error("Error sending node:"),this.logger.error(o)}})}),this.logger.info("Socket.io initialized"))}set cors(e){this.corsConfig=e}get cors(){return this.corsConfig?.includes("*")?"*":this.corsConfig}set socket(e){this.io=e}get socket(){return this.io}async emit({instanceName:e,origin:t,event:i,data:o,serverUrl:n,dateTime:r,sender:c,apiKey:p,integration:u,extra:d}){if(u&&!u.includes("websocket")||!this.status)return;let f=i.replace(/[.-]/gm,"_").toUpperCase(),g=b.get("LOG").LEVEL.includes("WEBSOCKET"),y={...d??{},event:i,instance:e,data:o,server_url:n,date_time:r,sender:c,apikey:p};b.get("WEBSOCKET")?.GLOBAL_EVENTS&&(this.socket.emit(i,y),g&&this.logger.log({local:`${t}.sendData-WebsocketGlobal`,...y}));try{let m=await this.get(e);if(!m?.enabled)return;Array.isArray(m?.events)&&m?.events.includes(f)&&(this.socket.of(`/${e}`).emit(i,y),g&&this.logger.log({local:`${t}.sendData-Websocket`,...y}))}catch(m){g&&this.logger.log(m)}}};l(Sa,"WebsocketController");var Pi=Sa;var Ta=class Ta{constructor(s,e){a(this,"prismaRepository");a(this,"waMonitor");a(this,"websocketController");a(this,"webhookController");a(this,"rabbitmqController");a(this,"natsController");a(this,"sqsController");a(this,"pusherController");a(this,"kafkaController");this.prisma=s,this.monitor=e,this.websocket=new Pi(s,e),this.webhook=new Oi(s,e),this.rabbitmq=new _i(s,e),this.nats=new Ci(s,e),this.sqs=new Ri(s,e),this.pusher=new Ni(s,e),this.kafka=new Ii(s,e)}set prisma(s){this.prismaRepository=s}get prisma(){return this.prismaRepository}set monitor(s){this.waMonitor=s}get monitor(){return this.waMonitor}set websocket(s){this.websocketController=s}get websocket(){return this.websocketController}set webhook(s){this.webhookController=s}get webhook(){return this.webhookController}set rabbitmq(s){this.rabbitmqController=s}get rabbitmq(){return this.rabbitmqController}set nats(s){this.natsController=s}get nats(){return this.natsController}set sqs(s){this.sqsController=s}get sqs(){return this.sqsController}set pusher(s){this.pusherController=s}get pusher(){return this.pusherController}set kafka(s){this.kafkaController=s}get kafka(){return this.kafkaController}init(s){this.websocket.init(s),this.rabbitmq.init(),this.nats.init(),this.sqs.init(),this.pusher.init(),this.kafka.init()}async emit(s){await this.websocket.emit(s),await this.rabbitmq.emit(s),await this.nats.emit(s),await this.sqs.emit(s),await this.webhook.emit(s),await this.pusher.emit(s),await this.kafka.emit(s)}async setInstance(s,e){e.websocket&&await this.websocket.set(s,{websocket:{enabled:!0,events:e.websocket?.events}}),e.rabbitmq&&await this.rabbitmq.set(s,{rabbitmq:{enabled:!0,events:e.rabbitmq?.events}}),e.nats&&await this.nats.set(s,{nats:{enabled:!0,events:e.nats?.events}}),e.sqs&&await this.sqs.set(s,{sqs:{enabled:!0,events:e.sqs?.events}}),e.webhook&&await this.webhook.set(s,{webhook:{enabled:!0,events:e.webhook?.events,url:e.webhook?.url,headers:e.webhook?.headers,base64:e.webhook?.base64,byEvents:e.webhook?.byEvents}}),e.pusher&&await this.pusher.set(s,{pusher:{enabled:!0,events:e.pusher?.events,appId:e.pusher?.appId,key:e.pusher?.key,secret:e.pusher?.secret,cluster:e.pusher?.cluster,useTLS:e.pusher?.useTLS}}),e.kafka&&await this.kafka.set(s,{kafka:{enabled:!0,events:e.kafka?.events}})}};l(Ta,"EventManager");var xi=Ta;var Aa=class Aa{constructor(s){a(this,"s3Service");this.s3Service=s}async getMedia(s,e){return this.s3Service.getMedia(s,e)}async getMediaUrl(s,e){return this.s3Service.getMediaUrl(s,e)}};l(Aa,"S3Controller");var ki=Aa;var ba=class ba{constructor(s){a(this,"prismaRepository");a(this,"logger",new O("S3Service"));this.prismaRepository=s}async getMedia(s,e){try{let t={instanceId:s.instanceId,...e},i=await this.prismaRepository.media.findMany({where:t,select:{id:!0,fileName:!0,type:!0,mimetype:!0,createdAt:!0,Message:!0}});if(!i||i.length===0)throw"Media not found";return i}catch(t){throw new w(t)}}async getMediaUrl(s,e){let t=(await this.getMedia(s,{id:e.id}))[0];return{mediaUrl:await Pe(t.fileName,e.expiry),...t}}};l(ba,"S3Service");var Di=ba;var je=x(require("axios")),eu=require("child_process");var Ia=class Ia{constructor(s){a(this,"configService");a(this,"logger",new O("ProviderFiles"));a(this,"baseUrl");a(this,"globalApiToken");a(this,"config",Object.freeze(this.configService.get("PROVIDER")));this.configService=s,this.baseUrl=`http://${this.config.HOST}:${this.config.PORT}/session/${this.config.PREFIX}`,this.globalApiToken=this.configService.get("AUTHENTICATION").API_KEY.KEY}get isEnabled(){return!!this.config?.ENABLED}async onModuleInit(){if(this.config.ENABLED){let s=`http://${this.config.HOST}:${this.config.PORT}`;try{if((await je.default.options(s+"/ping"))?.data!="pong")throw new Error("Offline file provider.");await je.default.post(`${s}/session`,{group:this.config.PREFIX},{headers:{apikey:this.globalApiToken}})}catch(e){this.logger.error(["Failed to connect to the file server",e?.message,e?.stack]);let t=process.pid;(0,eu.execFileSync)("kill",["-9",`${t}`])}}}async onModuleDestroy(){}async create(s){try{let e=await je.default.post(`${this.baseUrl}`,{instance:s},{headers:{apikey:this.globalApiToken}});return[{status:e.status,data:e?.data}]}catch(e){return[{status:e?.response?.status,data:e?.response?.data},e]}}async write(s,e,t){try{let i=await je.default.post(`${this.baseUrl}/${s}/${e}`,t,{headers:{apikey:this.globalApiToken}});return[{status:i.status,data:i?.data}]}catch(i){return[{status:i?.response?.status,data:i?.response?.data},i]}}async read(s,e){try{let t=await je.default.get(`${this.baseUrl}/${s}/${e}`,{headers:{apikey:this.globalApiToken}});return[{status:t.status,data:t?.data}]}catch(t){return[{status:t?.response?.status,data:t?.response?.data},t]}}async delete(s,e){try{let t=await je.default.delete(`${this.baseUrl}/${s}/${e}`,{headers:{apikey:this.globalApiToken}});return[{status:t.status,data:t?.data}]}catch(t){return[{status:t?.response?.status,data:t?.response?.data},t]}}async allInstances(){try{let s=await je.default.get(`${this.baseUrl}/list-instances`,{headers:{apikey:this.globalApiToken}});return[{status:s.status,data:s?.data}]}catch(s){return[{status:s?.response?.status,data:s?.response?.data},s]}}async removeSession(s){try{let e=await je.default.delete(`${this.baseUrl}/${s}`,{headers:{apikey:this.globalApiToken}});return[{status:e.status,data:e?.data}]}catch(e){return[{status:e?.response?.status,data:e?.response?.data},e]}}};l(Ia,"ProviderFiles");var Li=Ia;var tu=require("@prisma/client");var Ca=class Ca{constructor(){a(this,"where");a(this,"sort");a(this,"page");a(this,"offset")}};l(Ca,"Query");var ht=Ca,Ma=class Ma extends tu.PrismaClient{constructor(e){super();a(this,"configService");a(this,"logger",new O("PrismaRepository"));this.configService=e}async onModuleInit(){await this.$connect(),this.logger.info("Repository:Prisma - ON")}async onModuleDestroy(){await this.$disconnect(),this.logger.warn("Repository:Prisma - OFF")}};l(Ma,"PrismaRepository");var Bi=Ma;var su=require("child_process"),va=require("fs"),Ui=require("path");var Na=class Na{constructor(s,e,t,i,o,n,r){a(this,"eventEmitter");a(this,"configService");a(this,"prismaRepository");a(this,"providerFiles");a(this,"cache");a(this,"chatwootCache");a(this,"baileysCache");a(this,"db",{});a(this,"redis",{});a(this,"logger",new O("WAMonitoringService"));a(this,"waInstances",{});a(this,"delInstanceTimeouts",{});a(this,"providerSession");this.eventEmitter=s,this.configService=e,this.prismaRepository=t,this.providerFiles=i,this.cache=o,this.chatwootCache=n,this.baileysCache=r,this.removeInstance(),this.noConnection(),Object.assign(this.db,e.get("DATABASE")),Object.assign(this.redis,e.get("CACHE")),this.providerSession=Object.freeze(e.get("PROVIDER"))}delInstanceTime(s){let e=this.configService.get("DEL_INSTANCE");typeof e=="number"&&e>0&&(this.delInstanceTimeouts[s]&&clearTimeout(this.delInstanceTimeouts[s]),this.delInstanceTimeouts[s]=setTimeout(async()=>{try{this.waInstances[s]?.connectionStatus?.state!=="open"&&(this.waInstances[s]?.connectionStatus?.state==="connecting"?(await this.waInstances[s].integration===J.WHATSAPP_BAILEYS&&(await this.waInstances[s]?.client?.logout("Log out instance: "+s),this.waInstances[s]?.client?.ws?.close(),this.waInstances[s]?.client?.end(void 0)),this.eventEmitter.emit("remove.instance",s,"inner")):this.eventEmitter.emit("remove.instance",s,"inner"))}finally{delete this.delInstanceTimeouts[s]}},1e3*60*e))}clearDelInstanceTime(s){this.delInstanceTimeouts[s]&&(clearTimeout(this.delInstanceTimeouts[s]),delete this.delInstanceTimeouts[s])}async instanceInfo(s){if(s&&s.length>0){let o=s?s.filter(n=>!this.waInstances[n]):[];if(o.length>0)throw new G(`Instance${o.length>1?"s":""} "${o.join(", ")}" not found`)}let e=this.configService.get("DATABASE").CONNECTION.CLIENT_NAME,t=s&&s.length>0?{name:{in:s},clientName:e}:{clientName:e};return await this.prismaRepository.instance.findMany({where:t,include:{Chatwoot:!0,Proxy:!0,Rabbitmq:!0,Nats:!0,Sqs:!0,Websocket:!0,Setting:!0,_count:{select:{Message:!0,Contact:!0,Chat:!0}}}})}async instanceInfoById(s,e){let t;if(s){if(t=await this.prismaRepository.instance.findFirst({where:{id:s}}).then(o=>o?.name),!t)throw new G(`Instance "${s}" not found`)}else if(e&&(t=await this.prismaRepository.instance.findFirst({where:{number:e}}).then(o=>o?.name),!t))throw new G(`Instance "${e}" not found`);if(!t)throw new G(`Instance "${s}" not found`);if(t&&!this.waInstances[t])throw new G(`Instance "${t}" not found`);let i=t?[t]:null;return this.instanceInfo(i)}async cleaningUp(s){let e;if(this.db.SAVE_DATA.INSTANCE&&await this.prismaRepository.instance.findFirst({where:{name:s}})){let i=await this.prismaRepository.instance.update({where:{name:s},data:{connectionStatus:"close"}});(0,va.rmSync)((0,Ui.join)(Kt,i.id),{recursive:!0,force:!0}),e=i.id,await this.prismaRepository.session.deleteMany({where:{sessionId:i.id}})}this.redis.REDIS.ENABLED&&this.redis.REDIS.SAVE_INSTANCES&&(await this.cache.delete(s),e&&await this.cache.delete(e)),this.providerSession?.ENABLED&&await this.providerFiles.removeSession(s)}async cleaningStoreData(s){if(this.configService.get("CHATWOOT").ENABLED){let t=(0,Ui.join)(Mp,"chatwoot",s);(0,su.execFileSync)("rm",["-rf",t])}let e=await this.prismaRepository.instance.findFirst({where:{name:s}});e&&((0,va.rmSync)((0,Ui.join)(Kt,e.id),{recursive:!0,force:!0}),await this.prismaRepository.session.deleteMany({where:{sessionId:e.id}}),await this.prismaRepository.chat.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.contact.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.messageUpdate.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.message.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.webhook.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.chatwoot.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.proxy.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.rabbitmq.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.nats.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.sqs.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.integrationSession.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.typebot.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.websocket.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.setting.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.label.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.instance.delete({where:{name:s}}))}async loadInstance(){try{this.providerSession?.ENABLED?await this.loadInstancesFromProvider():this.db.SAVE_DATA.INSTANCE?await this.loadInstancesFromDatabasePostgres():this.redis.REDIS.ENABLED&&this.redis.REDIS.SAVE_INSTANCES&&await this.loadInstancesFromRedis()}catch(s){this.logger.error(s)}}async saveInstance(s){try{let e=await this.configService.get("DATABASE").CONNECTION.CLIENT_NAME;await this.prismaRepository.instance.create({data:{id:s.instanceId,name:s.instanceName,ownerJid:s.ownerJid,profileName:s.profileName,profilePicUrl:s.profilePicUrl,connectionStatus:s.integration&&s.integration===J.WHATSAPP_BAILEYS?"close":s.status??"open",number:s.number,integration:s.integration||J.WHATSAPP_BAILEYS,token:s.hash,clientName:e,businessId:s.businessId}})}catch(e){this.logger.error(e)}}deleteInstance(s){try{this.eventEmitter.emit("remove.instance",s,"inner")}catch(e){this.logger.error(e)}}async setInstance(s){let e=Is.init(s,{configService:this.configService,eventEmitter:this.eventEmitter,prismaRepository:this.prismaRepository,cache:this.cache,chatwootCache:this.chatwootCache,baileysCache:this.baileysCache,providerFiles:this.providerFiles});e&&(e.setInstance({instanceId:s.instanceId,instanceName:s.instanceName,integration:s.integration,token:s.token,number:s.number,businessId:s.businessId,ownerJid:s.ownerJid}),s.connectionStatus==="open"||s.connectionStatus==="connecting"?(this.logger.info(`Auto-connecting instance "${s.instanceName}" (status: ${s.connectionStatus})`),await e.connectToWhatsapp()):this.logger.info(`Skipping auto-connect for instance "${s.instanceName}" (status: ${s.connectionStatus||"close"})`),this.waInstances[s.instanceName]=e)}async loadInstancesFromRedis(){let s=await this.cache.keys();s?.length>0&&await Promise.all(s.map(async e=>{let t=await this.prismaRepository.instance.findUnique({where:{id:e.split(":")[1]}});if(!t)return;let i={instanceId:e.split(":")[1],instanceName:e.split(":")[2],integration:t.integration,token:t.token,number:t.number,businessId:t.businessId,connectionStatus:t.connectionStatus};this.setInstance(i)}))}async loadInstancesFromDatabasePostgres(){let s=await this.configService.get("DATABASE").CONNECTION.CLIENT_NAME,e=await this.prismaRepository.instance.findMany({where:{clientName:s}});e.length!==0&&await Promise.all(e.map(async t=>{this.setInstance({instanceId:t.id,instanceName:t.name,integration:t.integration,token:t.token,number:t.number,businessId:t.businessId,ownerJid:t.ownerJid,connectionStatus:t.connectionStatus})}))}async loadInstancesFromProvider(){let[s]=await this.providerFiles.allInstances();s?.data&&await Promise.all(s?.data?.map(async e=>{let t=await this.prismaRepository.instance.findUnique({where:{id:e}});this.setInstance({instanceId:t.id,instanceName:t.name,integration:t.integration,token:t.token,businessId:t.businessId,connectionStatus:t.connectionStatus})}))}removeInstance(){this.eventEmitter.on("remove.instance",async s=>{try{await this.waInstances[s]?.sendDataWebhook(R.REMOVE_INSTANCE,null),this.clearDelInstanceTime(s),this.cleaningUp(s),this.cleaningStoreData(s)}finally{this.logger.warn(`Instance "${s}" - REMOVED`)}try{delete this.waInstances[s]}catch(e){this.logger.error(e)}}),this.eventEmitter.on("logout.instance",async s=>{try{await this.waInstances[s]?.sendDataWebhook(R.LOGOUT_INSTANCE,null),this.clearDelInstanceTime(s),this.configService.get("CHATWOOT").ENABLED&&this.waInstances[s]?.clearCacheChatwoot(),this.cleaningUp(s)}finally{this.logger.warn(`Instance "${s}" - LOGOUT`)}})}noConnection(){this.eventEmitter.on("no.connection",async s=>{try{await this.waInstances[s]?.client?.logout("Log out instance: "+s),this.waInstances[s]?.client?.ws?.close(),this.waInstances[s].instance.qrcode={count:0},this.waInstances[s].stateConnection.state="close"}catch(e){this.logger.error({localError:"noConnection",warn:"Error deleting instance from memory.",error:e})}finally{this.logger.warn(`Instance "${s}" - NOT CONNECTION`)}})}};l(Na,"WAMonitoringService");var $i=Na;var _a=class _a{constructor(s){a(this,"waMonitor");a(this,"logger",new O("ProxyService"));this.waMonitor=s}create(s,e){return this.waMonitor.waInstances[s.instanceName].setProxy(e),{proxy:{...s,proxy:e}}}async find(s){try{let e=await this.waMonitor.waInstances[s.instanceName].findProxy();if(Object.keys(e).length===0)throw new Error("Proxy not found");return e}catch{return null}}};l(_a,"ProxyService");var Fi=_a;var Ra=class Ra{constructor(s){a(this,"waMonitor");a(this,"logger",new O("SettingsService"));this.waMonitor=s}async create(s,e){return await this.waMonitor.waInstances[s.instanceName].setSettings(e),{settings:{...s,settings:e}}}async find(s){try{let e=await this.waMonitor.waInstances[s.instanceName].findSettings();if(Object.keys(e).length===0)throw new Error("Settings not found");return e}catch{return null}}};l(Ra,"SettingsService");var Wi=Ra;var Ht=x(require("axios"));var Oa=class Oa{constructor(s,e,t){a(this,"waMonitor");a(this,"prismaRepository");a(this,"configService");a(this,"logger",new O("TemplateService"));a(this,"businessId");a(this,"token");this.waMonitor=s,this.prismaRepository=e,this.configService=t}async find(s){let e=await this.waMonitor.waInstances[s.instanceName].instance;if(!e)throw new Error("Instance not found");this.businessId=e.businessId,this.token=e.token;let t=await this.requestTemplate({},"GET");if(!t)throw new Error("Error to create template");return t.data}async create(s,e){try{let t=await this.waMonitor.waInstances[s.instanceName].instance;if(!t)throw new Error("Instance not found");this.businessId=t.businessId,this.token=t.token;let i={name:e.name,category:e.category,allow_category_change:e.allowCategoryChange,language:e.language,components:e.components},o=await this.requestTemplate(i,"POST");if(!o||o.error){if(o&&o.error){let r=new Error(o.error.message||"WhatsApp API Error");throw r.template=o.error,r}throw new Error("Error to create template")}return await this.prismaRepository.template.create({data:{templateId:o.id,name:e.name,template:o,webhookUrl:e.webhookUrl,instanceId:t.id}})}catch(t){throw this.logger.error("Error in create template: "+t),t}}async edit(s,e){let t=await this.waMonitor.waInstances[s.instanceName].instance;if(!t)throw new Error("Instance not found");this.businessId=t.businessId,this.token=t.token;let i={};typeof e.category=="string"&&(i.category=e.category),typeof e.allowCategoryChange=="boolean"&&(i.allow_category_change=e.allowCategoryChange),typeof e.ttl=="number"&&(i.time_to_live=e.ttl),e.components&&(i.components=e.components);let o=await this.requestEditTemplate(e.templateId,i);if(!o||o.error){if(o&&o.error){let n=new Error(o.error.message||"WhatsApp API Error");throw n.template=o.error,n}throw new Error("Error to edit template")}return o}async delete(s,e){let t=await this.waMonitor.waInstances[s.instanceName].instance;if(!t)throw new Error("Instance not found");this.businessId=t.businessId,this.token=t.token;let i=await this.requestDeleteTemplate({name:e.name,hsm_id:e.hsmId});if(!i||i.error){if(i&&i.error){let o=new Error(i.error.message||"WhatsApp API Error");throw o.template=i.error,o}throw new Error("Error to delete template")}try{await this.prismaRepository.template.deleteMany({where:{OR:[{name:e.name,instanceId:t.id},e.hsmId?{templateId:e.hsmId,instanceId:t.id}:void 0].filter(Boolean)}})}catch(o){this.logger.warn(`Failed to cleanup local template records after delete: ${o?.message||String(o)}`)}return i}async requestTemplate(s,e){try{let t=this.configService.get("WA_BUSINESS").URL,i=this.configService.get("WA_BUSINESS").VERSION;t=`${t}/${i}/${this.businessId}/message_templates`;let o={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`};if(e==="GET")return(await Ht.default.get(t,{headers:o})).data;if(e==="POST")return(await Ht.default.post(t,s,{headers:o})).data}catch(t){if(this.logger.error("WhatsApp API request error: "+(t.response?.data?JSON.stringify(t.response?.data):t.message)),t.response?.data)return t.response.data;throw new Error(`Connection error: ${t.message}`)}}async requestEditTemplate(s,e){try{let t=this.configService.get("WA_BUSINESS").URL,i=this.configService.get("WA_BUSINESS").VERSION;t=`${t}/${i}/${s}`;let o={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`};return(await Ht.default.post(t,e,{headers:o})).data}catch(t){if(this.logger.error("WhatsApp API request error: "+(t.response?.data?JSON.stringify(t.response?.data):t.message)),t.response?.data)return t.response.data;throw new Error(`Connection error: ${t.message}`)}}async requestDeleteTemplate(s){try{let e=this.configService.get("WA_BUSINESS").URL,t=this.configService.get("WA_BUSINESS").VERSION;e=`${e}/${t}/${this.businessId}/message_templates`;let i={Authorization:`Bearer ${this.token}`};return(await Ht.default.delete(e,{headers:i,params:s})).data}catch(e){if(this.logger.error("WhatsApp API request error: "+(e.response?.data?JSON.stringify(e.response?.data):e.message)),e.response?.data)return e.response.data;throw new Error(`Connection error: ${e.message}`)}}};l(Oa,"TemplateService");var Ji=Oa;var um=new O("WA MODULE"),qi=null;b.get("CHATWOOT").ENABLED&&(qi=new tt(new ze(b,lt.name).getEngine()));var Vi=new tt(new ze(b,"instance").getEngine()),iu=new tt(new ze(b,"baileys").getEngine()),Pa=null;b.get("PROVIDER").ENABLED&&(Pa=new Li(b));var F=new Bi(b),U=new $i(Rn,b,F,Pa,Vi,qi,iu),dm=new Di(F),xa=new ki(dm),hm=new Ji(U,F,b),Yt=new Os(hm),mm=new Fi(U),Gi=new Ns(mm,U),ou=new lt(U,b,F,qi),Ki=new di(ou,b),nu=new Wi(U),ka=new Rs(nu),He=new bs(U,b,F,Rn,ou,nu,Gi,Vi,qi,iu,Pa),we=new _s(U),ru=new Ss(U),Q=new Ts(U),Da=new Es(U),oe=new As(U),La=new Cs(U),H=new xi(F,U),qe=new Pt(F,U),Is=new ot(F,U),au=new li(F,U),cu=new pi(F,U),Ue=new ui(U),mt=new It(U,F,b),ie=new Ai(mt,F,U),gm=new Ct(U,b,F,mt),ye=new bi(gm,F,U),fm=new bt(U,F,b,mt),Te=new hi(fm,F,U),ym=new yi(U,F,b,mt),Ae=new fi(ym,F,U),wm=new Ei(U,F,b,mt),be=new wi(wm,F,U),Em=new Ti(U,F,b,mt),Ie=new Si(Em,F,U),Sm=new gi(U,F,b,mt),Ce=new mi(Sm,F,U);um.info("Module - ON");var Tm=new O("GUARD");async function Am(h,s,e){let t=b.get("AUTHENTICATION").API_KEY,i=h.get("apikey"),o=b.get("DATABASE");if(!i)throw new ct;if(t.KEY===i)return e();if((h.originalUrl.includes("/instance/create")||h.originalUrl.includes("/instance/fetchInstances"))&&!i)throw new wt("Missing global api key","The global api key must be set");let n=h.params;try{if(n?.instanceName){if((await F.instance.findUnique({where:{name:n.instanceName}})).token===i)return e()}else if(h.originalUrl.includes("/instance/fetchInstances")&&o.SAVE_DATA.INSTANCE&&await F.instance.findFirst({where:{token:i}}))return e()}catch(r){Tm.error(r)}throw new ct}l(Am,"apikey");var Ba={apikey:Am};async function lu(h){try{let s=b.get("CACHE"),e=!!U.waInstances[h];if(s.REDIS.ENABLED&&s.REDIS.SAVE_INSTANCES){let t=await Vi.has(h);return e||t}return e||(await F.instance.findMany({where:{name:h}})).length>0}catch(s){throw new $(s?.toString())}}l(lu,"getInstance");async function pu(h,s,e){if(h.originalUrl.includes("/instance/create")||h.originalUrl.includes("/instance/fetchInstances"))return e();let t=h.params;if(!t?.instanceName)throw new w('"instanceName" not provided.');if(!await lu(t.instanceName))throw new G(`The "${t.instanceName}" instance does not exist`);e()}l(pu,"instanceExistsGuard");async function uu(h,s,e){if(h.originalUrl.includes("/instance/create")){let t=h.body;if(await lu(t.instanceName))throw new wt(`This name "${t.instanceName}" is already in use.`);U.waInstances[t.instanceName]&&delete U.waInstances[t.instanceName]}e()}l(uu,"instanceLoggedGuard");var xt,bm=(xt=class{collectTelemetry(s,e,t){j(s.path),t()}},l(xt,"Telemetry"),xt),du=bm;var Eu=require("express");var KA=require("express-async-errors");var kt=require("jsonschema");var Qt=new O("Validate"),Ua=class Ua{constructor(){}routerPath(s,e=!0){let t="/"+s;return e&&(t+="/:instanceName"),t}async dataValidate(s){let{request:e,schema:t,ClassRef:i,execute:o}=s,n=new i,r=e.body,c=e.params;e?.query&&Object.keys(e.query).length>0&&Object.assign(c,e.query),e.originalUrl.includes("/instance/create")&&Object.assign(c,r),Object.assign(n,r);let p=t?(0,kt.validate)(n,t):{valid:!0,errors:[]};if(!p.valid){let u=p.errors.map(({stack:d,schema:f})=>{let g;return f.description?g=f.description:g=d.replace("instance.",""),g});throw Qt.error(u),new w(u)}return await o(c,n)}async groupNoValidate(s){let{request:e,ClassRef:t,schema:i,execute:o}=s,n=e.params,r=new t;Object.assign(r,e.body);let c=(0,kt.validate)(r,i);if(!c.valid){let p=c.errors.map(({property:u,stack:d,schema:f})=>{let g;return f.description?g=f.description:g=d.replace("instance.",""),{property:u.replace("instance.",""),message:g}});throw Qt.error([...p]),new w(...p)}return await o(n,r)}async groupValidate(s){let{request:e,ClassRef:t,schema:i,execute:o}=s,n=e.params,r=e.body,c=r?.groupJid;if(!c)if(e.query?.groupJid)c=e.query.groupJid;else throw new w("The group id needs to be informed in the query",'ex: "groupJid=120362@g.us"');c.endsWith("@g.us")||(c=c+"@g.us"),Object.assign(r,{groupJid:c});let p=new t;Object.assign(p,r);let u=(0,kt.validate)(p,i);if(!u.valid){let d=u.errors.map(({property:f,stack:g,schema:y})=>{let m;return y.description?m=y.description:m=g.replace("instance.",""),{property:f.replace("instance.",""),message:m}});throw Qt.error([...d]),new w(...d)}return await o(n,p)}async inviteCodeValidate(s){let{request:e,ClassRef:t,schema:i,execute:o}=s,n=e.query;if(!n?.inviteCode)throw new w("The group invite code id needs to be informed in the query",'ex: "inviteCode=F1EX5QZxO181L3TMVP31gY" (Obtained from group join link)');let r=e.params,c=e.body,p=new t;Object.assign(c,n),Object.assign(p,c);let u=(0,kt.validate)(p,i);if(!u.valid){let d=u.errors.map(({property:f,stack:g,schema:y})=>{let m;return y.description?m=y.description:m=g.replace("instance.",""),{property:f.replace("instance.",""),message:m}});throw Qt.error([...d]),new w(...d)}return await o(r,p)}async getParticipantsValidate(s){let{request:e,ClassRef:t,schema:i,execute:o}=s,n=e.query;if(!n?.getParticipants)throw new w("The getParticipants needs to be informed in the query");let r=e.params,c=e.body,p=new t;Object.assign(c,n),Object.assign(p,c);let u=(0,kt.validate)(p,i);if(!u.valid){let d=u.errors.map(({property:f,stack:g,schema:y})=>{let m;return y.description?m=y.description:m=g.replace("instance.",""),{property:f.replace("instance.",""),message:m}});throw Qt.error([...d]),new w(...d)}return await o(r,p)}};l(Ua,"RouterBroker");var D=Ua;var hu=require("express");var $a=class $a extends D{constructor(e){super();a(this,"configService");a(this,"router",(0,hu.Router)());this.configService=e,this.router.post(this.routerPath("webhook/evolution",!1),async(t,i)=>{let{body:o}=t,n=await au.receiveWebhook(o);return i.status(200).json(n)})}};l($a,"EvolutionRouter");var ji=$a;var mu=require("express");var Fa=class Fa extends D{constructor(e){super();a(this,"configService");a(this,"router",(0,mu.Router)());this.configService=e,this.router.get(this.routerPath("webhook/meta",!1),async(t,i)=>{t.query["hub.verify_token"]===e.get("WA_BUSINESS").TOKEN_WEBHOOK?i.send(t.query["hub.challenge"]):i.send("Error, wrong validation token")}).post(this.routerPath("webhook/meta",!1),async(t,i)=>{let{body:o}=t,n=await cu.receiveWebhook(o);return i.status(200).json(n)})}};l(Fa,"MetaRouter");var Hi=Fa;var Wa=class Wa{constructor(){a(this,"enabled");a(this,"accountId");a(this,"token");a(this,"url");a(this,"nameInbox");a(this,"signMsg");a(this,"signDelimiter");a(this,"number");a(this,"reopenConversation");a(this,"conversationPending");a(this,"mergeBrazilContacts");a(this,"importContacts");a(this,"importMessages");a(this,"daysLimitImportMessages");a(this,"autoCreate");a(this,"organization");a(this,"logo");a(this,"ignoreJids")}};l(Wa,"ChatwootDto");var Yi=Wa;function gu(h){return class extends h{constructor(){super(...arguments);a(this,"chatwootAccountId");a(this,"chatwootToken");a(this,"chatwootUrl");a(this,"chatwootSignMsg");a(this,"chatwootReopenConversation");a(this,"chatwootConversationPending");a(this,"chatwootMergeBrazilContacts");a(this,"chatwootImportContacts");a(this,"chatwootImportMessages");a(this,"chatwootDaysLimitImportMessages");a(this,"chatwootNameInbox");a(this,"chatwootOrganization");a(this,"chatwootLogo");a(this,"chatwootAutoCreate")}}}l(gu,"ChatwootInstanceMixin");var Ja=class Ja{constructor(){a(this,"webhook");a(this,"websocket");a(this,"sqs");a(this,"rabbitmq");a(this,"nats");a(this,"pusher");a(this,"kafka")}};l(Ja,"EventDto");var ce=Ja;function fu(h){return class extends h{constructor(){super(...arguments);a(this,"webhook");a(this,"websocket");a(this,"sqs");a(this,"rabbitmq");a(this,"nats");a(this,"pusher");a(this,"kafka")}}}l(fu,"EventInstanceMixin");var qa=class qa extends fu(gu(class{})){};l(qa,"IntegrationDto");var Qi=qa;var Va=class Va extends Qi{constructor(){super(...arguments);a(this,"instanceName");a(this,"instanceId");a(this,"qrcode");a(this,"businessId");a(this,"number");a(this,"integration");a(this,"token");a(this,"status");a(this,"ownerJid");a(this,"connectionStatus");a(this,"profileName");a(this,"profilePicUrl");a(this,"rejectCall");a(this,"msgCall");a(this,"groupsIgnore");a(this,"alwaysOnline");a(this,"readMessages");a(this,"readStatus");a(this,"syncFullHistory");a(this,"wavoipToken");a(this,"proxyHost");a(this,"proxyPort");a(this,"proxyProtocol");a(this,"proxyUsername");a(this,"proxyPassword");a(this,"webhook");a(this,"chatwootAccountId");a(this,"chatwootConversationPending");a(this,"chatwootAutoCreate");a(this,"chatwootDaysLimitImportMessages");a(this,"chatwootImportContacts");a(this,"chatwootImportMessages");a(this,"chatwootLogo");a(this,"chatwootMergeBrazilContacts");a(this,"chatwootNameInbox");a(this,"chatwootOrganization");a(this,"chatwootReopenConversation");a(this,"chatwootSignMsg");a(this,"chatwootToken");a(this,"chatwootUrl")}};l(Va,"InstanceDto");var _=Va,Ga=class Ga{constructor(){a(this,"presence")}};l(Ga,"SetPresenceDto");var zi=Ga;var Ka=require("uuid");var Im=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),P={$id:(0,Ka.v4)(),type:"object",properties:{instanceName:{type:"string"},token:{type:"string"},number:{type:"string",pattern:"^\\d+[\\.@\\w-]+"},businessId:{type:"string"},qrcode:{type:"boolean"},Integration:{type:"string",enum:Object.values(J)},rejectCall:{type:"boolean"},msgCall:{type:"string"},groupsIgnore:{type:"boolean"},alwaysOnline:{type:"boolean"},readMessages:{type:"boolean"},readStatus:{type:"boolean"},syncFullHistory:{type:"boolean"},wavoipToken:{type:"string"},proxyHost:{type:"string"},proxyPort:{type:"string"},proxyProtocol:{type:"string"},proxyUsername:{type:"string"},proxyPassword:{type:"string"},webhookUrl:{type:"string"},webhookByEvents:{type:"boolean"},webhookBase64:{type:"boolean"},webhookEvents:{type:"array",minItems:0,items:{type:"string",enum:["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","SEND_MESSAGE_UPDATE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS"]}},rabbitmqEnabled:{type:"boolean"},rabbitmqEvents:{type:"array",minItems:0,items:{type:"string",enum:["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","SEND_MESSAGE_UPDATE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS"]}},natsEnabled:{type:"boolean"},natsEvents:{type:"array",minItems:0,items:{type:"string",enum:["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","SEND_MESSAGE_UPDATE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS"]}},sqsEnabled:{type:"boolean"},sqsEvents:{type:"array",minItems:0,items:{type:"string",enum:["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","SEND_MESSAGE_UPDATE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS"]}},chatwootAccountId:{type:"string"},chatwootToken:{type:"string"},chatwootUrl:{type:"string"},chatwootSignMsg:{type:"boolean"},chatwootReopenConversation:{type:"boolean"},chatwootConversationPending:{type:"boolean"},chatwootImportContacts:{type:"boolean"},chatwootNameInbox:{type:"string"},chatwootMergeBrazilContacts:{type:"boolean"},chatwootImportMessages:{type:"boolean"},chatwootDaysLimitImportMessages:{type:"number"}},...Im("instanceName")},yu={$id:(0,Ka.v4)(),type:"object",properties:{presence:{type:"string",enum:["unavailable","available","composing","recording","paused"]}},required:["presence"]};var wu=require("express");var ja=class ja extends D{constructor(...e){super();a(this,"router",(0,wu.Router)());this.router.post(this.routerPath("onWhatsapp"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.onWhatsapp(n,t.body),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("profilePictureUrl"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.profilePictureUrl(n,t.body),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("assertSessions"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.assertSessions(n,t.body),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("createParticipantNodes"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.createParticipantNodes(n,t.body),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("getUSyncDevices"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.getUSyncDevices(n,t.body),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("generateMessageTag"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.generateMessageTag(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("sendNode"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.sendNode(n,t.body),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("signalRepositoryDecryptMessage"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.signalRepositoryDecryptMessage(n,t.body),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("getAuthState"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ue.getAuthState(n),"execute")});i.status(E.OK).json(o)})}};l(ja,"BaileysRouter");var Xi=ja;var Ha=class Ha{constructor(s,...e){a(this,"router");this.router=(0,Eu.Router)(),this.router.use("/",new ji(s).router),this.router.use("/",new Hi(s).router),this.router.use("/baileys",new Xi(...e).router)}};l(Ha,"ChannelRouter");var Zi=Ha;var Su={type:"object",properties:{number:{type:"string"},limit:{type:"number"}}},Tu={type:"object",properties:{number:{type:"string"},limit:{type:"number"}}};var le=require("uuid");var me=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),Cm={type:"string",description:"Invalid format"},Au={$id:(0,le.v4)(),type:"object",properties:{numbers:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",description:'"numbers" must be an array of numeric strings'}}}},bu={$id:(0,le.v4)(),type:"object",properties:{readMessages:{type:"array",minItems:1,uniqueItems:!0,items:{properties:{id:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]},remoteJid:{type:"string"}},required:["id","fromMe","remoteJid"],...me("id","remoteJid")}}},required:["readMessages"]},Iu={$id:(0,le.v4)(),type:"object",properties:{chat:{type:"string"},lastMessage:{type:"object",properties:{key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id","fromMe","remoteJid"],...me("id","remoteJid")},messageTimestamp:{type:"integer",minLength:1}},required:["key"],...me("messageTimestamp")},archive:{type:"boolean",enum:[!0,!1]}},required:["archive"]},Cu={$id:(0,le.v4)(),type:"object",properties:{chat:{type:"string"},lastMessage:{type:"object",properties:{key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id","fromMe","remoteJid"],...me("id","remoteJid")},messageTimestamp:{type:"integer",minLength:1}},required:["key"],...me("messageTimestamp")}},required:["lastMessage"]},Mu={$id:(0,le.v4)(),type:"object",properties:{id:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]},remoteJid:{type:"string"},participant:{type:"string"}},required:["id","fromMe","remoteJid"],...me("id","remoteJid","participant")},zt={$id:(0,le.v4)(),type:"object",properties:{number:{type:"string"},picture:{type:"string"}}},vu={$id:(0,le.v4)(),type:"object",properties:{number:{type:"string"},text:{type:"string"},key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id","fromMe","remoteJid"],...me("id","remoteJid")}},...me("number","text","key")},Nu={$id:(0,le.v4)(),type:"object",properties:{number:{...Cm},delay:{type:"number"},presence:{type:"string",enum:["unavailable","available","composing","recording","paused"]}},required:["number","presence","delay"]},_u={$id:(0,le.v4)(),type:"object",properties:{number:{type:"string"},status:{type:"string",enum:["block","unblock"]}},required:["number","status"],...me("number","status")},Ya={$id:(0,le.v4)(),type:"object",properties:{where:{type:"object",properties:{_id:{type:"string",minLength:1},pushName:{type:"string",minLength:1},id:{type:"string",minLength:1},remoteJid:{type:"string",minLength:1}},...me("_id","id","pushName","remoteJid")}}},Ru={$id:(0,le.v4)(),type:"object",properties:{where:{type:"object",properties:{_id:{type:"string",minLength:1},key:{type:"object",if:{propertyNames:{enum:["fromMe","remoteJid","id"]}},then:{properties:{remoteJid:{type:"string",minLength:1,description:"The property cannot be empty"},id:{type:"string",minLength:1,description:"The property cannot be empty"},fromMe:{type:"boolean",enum:[!0,!1]}}}},message:{type:"object"}},...me("_id")},limit:{type:"integer"}}},Ou={$id:(0,le.v4)(),type:"object",properties:{where:{type:"object",properties:{_id:{type:"string"},remoteJid:{type:"string"},id:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]},participant:{type:"string"},status:{type:"string",enum:["ERROR","PENDING","SERVER_ACK","DELIVERY_ACK","READ","PLAYED"]}},...me("_id","remoteJid","id","status")},limit:{type:"integer"}}},Pu={$id:(0,le.v4)(),type:"object",properties:{readreceipts:{type:"string",enum:["all","none"]},profile:{type:"string",enum:["all","contacts","contact_blacklist","none"]},status:{type:"string",enum:["all","contacts","contact_blacklist","none"]},online:{type:"string",enum:["all","match_last_seen"]},last:{type:"string",enum:["all","contacts","contact_blacklist","none"]},groupadd:{type:"string",enum:["all","contacts","contact_blacklist","none"]}},required:["readreceipts","profile","status","online","last","groupadd"],...me("readreceipts","profile","status","online","last","groupadd")},xu={$id:(0,le.v4)(),type:"object",properties:{name:{type:"string"}},...me("name")},ku={$id:(0,le.v4)(),type:"object",properties:{status:{type:"string"}},...me("status")},Du={type:"object",properties:{wuid:{type:"string"},name:{type:"string"},picture:{type:"string"},status:{type:"string"},isBusiness:{type:"boolean"}}};var Me=require("uuid");var Ne=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),Lu={$id:(0,Me.v4)(),type:"object",properties:{subject:{type:"string"},description:{type:"string"},profilePicture:{type:"string"},promoteParticipants:{type:"boolean",enum:[!0,!1]},participants:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",minLength:10,pattern:"\\d+",description:'"participants" must be an array of numeric strings'}}},required:["subject","participants"],...Ne("subject","description","profilePicture")},Xt={$id:(0,Me.v4)(),type:"object",properties:{groupJid:{type:"string",pattern:"^[\\d-]+@g.us$"}},required:["groupJid"],...Ne("groupJid")},Bu={$id:(0,Me.v4)(),type:"object",properties:{getParticipants:{type:"string",enum:["true","false"]}},required:["getParticipants"],...Ne("getParticipants")},Uu={$id:(0,Me.v4)(),type:"object",properties:{groupJid:{type:"string"},description:{type:"string"},numbers:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",minLength:10,pattern:"\\d+",description:'"numbers" must be an array of numeric strings'}}},required:["groupJid","description","numbers"],...Ne("groupJid","description","numbers")},$u={$id:(0,Me.v4)(),type:"object",properties:{inviteCode:{type:"string",pattern:"^[a-zA-Z0-9]{22}$"}},required:["inviteCode"],...Ne("inviteCode")},Fu={$id:(0,Me.v4)(),type:"object",properties:{inviteCode:{type:"string",pattern:"^[a-zA-Z0-9]{22}$"}},required:["inviteCode"],...Ne("inviteCode")},Wu={$id:(0,Me.v4)(),type:"object",properties:{groupJid:{type:"string"},action:{type:"string",enum:["add","remove","promote","demote"]},participants:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",minLength:10,pattern:"\\d+",description:'"participants" must be an array of numeric strings'}}},required:["groupJid","action","participants"],...Ne("groupJid","action")},Ju={$id:(0,Me.v4)(),type:"object",properties:{groupJid:{type:"string"},action:{type:"string",enum:["announcement","not_announcement","locked","unlocked"]}},required:["groupJid","action"],...Ne("groupJid","action")},qu={$id:(0,Me.v4)(),type:"object",properties:{groupJid:{type:"string"},expiration:{type:"number",enum:[0,86400,604800,7776e3]}},required:["groupJid","expiration"],...Ne("groupJid","expiration")},Vu={$id:(0,Me.v4)(),type:"object",properties:{groupJid:{type:"string"},image:{type:"string"}},required:["groupJid","image"],...Ne("groupJid","image")},Gu={$id:(0,Me.v4)(),type:"object",properties:{groupJid:{type:"string"},subject:{type:"string"}},required:["groupJid","subject"],...Ne("groupJid","subject")},Ku={$id:(0,Me.v4)(),type:"object",properties:{groupJid:{type:"string"},description:{type:"string"}},required:["groupJid","description"],...Ne("groupJid","description")};var ju=require("uuid");var Mm=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),vm={type:"string",description:"Invalid format"},Hu={$id:(0,ju.v4)(),type:"object",properties:{number:{...vm},labelId:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["number","labelId","action"],...Mm("number","labelId","action")};var ge=require("uuid");var Dt=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),_e={type:"string",description:"Invalid format"},Yu={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},name:{type:"string"},language:{type:"string"},components:{type:"array"},webhookUrl:{type:"string"}},required:["name","language"]},Ye={properties:{key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id"],...Dt("id")},message:{type:"object"}}},Qu={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},isVideo:{type:"boolean",enum:[!0,!1]},callDuration:{type:"integer",minimum:1,maximum:15}},required:["number","callDuration"]},zu={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},text:{type:"string"},linkPreview:{type:"boolean"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","text"]},Xu={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},mediatype:{type:"string",enum:["image","document","video","audio"]},mimetype:{type:"string"},media:{type:"string"},fileName:{type:"string"},caption:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","mediatype"]},Zu={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},video:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number"]},ed={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},audio:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number"]},td={$id:(0,ge.v4)(),type:"object",properties:{type:{type:"string",enum:["text","image","audio","video"]},content:{type:"string"},caption:{type:"string"},backgroundColor:{type:"string"},font:{type:"integer",minimum:0,maximum:5},statusJidList:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"statusJidList" must be an array of numeric strings'}},allContacts:{type:"boolean",enum:[!0,!1]}},required:["type"]},sd={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},sticker:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number"]},id={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},latitude:{type:"number"},longitude:{type:"number"},name:{type:"string"},address:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","latitude","longitude","name","address"]},od={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},contact:{type:"array",items:{type:"object",properties:{fullName:{type:"string"},wuid:{type:"string",minLength:10,pattern:"\\d+",description:'"wuid" must be a numeric string'},phoneNumber:{type:"string",minLength:10},organization:{type:"string"},email:{type:"string"},url:{type:"string"}},required:["fullName","phoneNumber"],...Dt("fullName")},minItems:1,uniqueItems:!0}},required:["number","contact"]},nd={$id:(0,ge.v4)(),type:"object",properties:{key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id","remoteJid","fromMe"],...Dt("id","remoteJid")},reaction:{type:"string"}},required:["key","reaction"]},rd={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},name:{type:"string"},selectableCount:{type:"integer",minimum:0,maximum:10},values:{type:"array",minItems:2,maxItems:10,uniqueItems:!0,items:{type:"string"}},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","name","selectableCount","values"]},ad={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},title:{type:"string"},description:{type:"string"},footerText:{type:"string"},buttonText:{type:"string"},sections:{type:"array",minItems:1,uniqueItems:!0,items:{type:"object",properties:{title:{type:"string"},rows:{type:"array",minItems:1,uniqueItems:!0,items:{type:"object",properties:{title:{type:"string"},description:{type:"string"},rowId:{type:"string"}},required:["title","rowId"],...Dt("title","description","rowId")}}},required:["title","rows"],...Dt("title")}},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","title","footerText","buttonText","sections"]},cd={$id:(0,ge.v4)(),type:"object",properties:{number:{..._e},thumbnailUrl:{type:"string"},title:{type:"string"},description:{type:"string"},footer:{type:"string"},buttons:{type:"array",items:{type:"object",properties:{type:{type:"string",enum:["reply","copy","url","call","pix"]},displayText:{type:"string"},id:{type:"string"},url:{type:"string"},phoneNumber:{type:"string"},currency:{type:"string"},name:{type:"string"},keyType:{type:"string",enum:["phone","email","cpf","cnpj","random"]},key:{type:"string"}},required:["type"],...Dt("id","url","phoneNumber")}},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...Ye},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number"]};var ld=require("uuid");var Nm=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),pd={$id:(0,ld.v4)(),type:"object",properties:{enabled:{type:"boolean",enum:[!0,!1]},host:{type:"string"},port:{type:"string"},protocol:{type:"string"},username:{type:"string"},password:{type:"string"}},required:["enabled","host","port","protocol"],...Nm("enabled","host","port","protocol")};var ud=require("uuid");var _m=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),dd={$id:(0,ud.v4)(),type:"object",properties:{rejectCall:{type:"boolean"},msgCall:{type:"string"},groupsIgnore:{type:"boolean"},alwaysOnline:{type:"boolean"},readMessages:{type:"boolean"},readStatus:{type:"boolean"},syncFullHistory:{type:"boolean"},wavoipToken:{type:"string"}},required:["rejectCall","groupsIgnore","alwaysOnline","readMessages","readStatus","syncFullHistory"],..._m("rejectCall","groupsIgnore","alwaysOnline","readMessages","readStatus","syncFullHistory")};var hd=require("uuid");var Rm=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),md={$id:(0,hd.v4)(),type:"object",properties:{name:{type:"string"},category:{type:"string",enum:["AUTHENTICATION","MARKETING","UTILITY"]},allowCategoryChange:{type:"boolean"},language:{type:"string"},components:{type:"array"},webhookUrl:{type:"string"}},required:["name","category","language","components"],...Rm("name","category","language","components")};var gd=require("uuid");var Om=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),fd={$id:(0,gd.v4)(),type:"object",properties:{name:{type:"string"},hsmId:{type:"string"}},required:["name"],...Om("name")};var yd=require("uuid");var Pm=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),wd={$id:(0,yd.v4)(),type:"object",properties:{templateId:{type:"string"},category:{type:"string",enum:["AUTHENTICATION","MARKETING","UTILITY"]},allowCategoryChange:{type:"boolean"},ttl:{type:"number"},components:{type:"array"}},required:["templateId"],...Pm("templateId")};var Ed=require("uuid");var xm=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),Sd={$id:(0,Ed.v4)(),type:"object",properties:{enabled:{type:"boolean",enum:[!0,!1]},accountId:{type:"string"},token:{type:"string"},url:{type:"string"},signMsg:{type:"boolean",enum:[!0,!1]},signDelimiter:{type:["string","null"]},nameInbox:{type:["string","null"]},reopenConversation:{type:"boolean",enum:[!0,!1]},conversationPending:{type:"boolean",enum:[!0,!1]},autoCreate:{type:"boolean",enum:[!0,!1]},importContacts:{type:"boolean",enum:[!0,!1]},mergeBrazilContacts:{type:"boolean",enum:[!0,!1]},importMessages:{type:"boolean",enum:[!0,!1]},daysLimitImportMessages:{type:"number"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","accountId","token","url","signMsg","reopenConversation","conversationPending"],...xm("enabled","accountId","token","url","signMsg","reopenConversation","conversationPending")};var Zt=require("uuid");var eo=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),Qa={$id:(0,Zt.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},botType:{type:"string",enum:["chatBot","textGenerator","agent","workflow"]},apiUrl:{type:"string"},apiKey:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["enabled","botType","triggerType"],...eo("enabled","botType","triggerType")},Td={$id:(0,Zt.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...eo("remoteJid","status")},Ad={$id:(0,Zt.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},difyIdFallback:{type:"string"},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","splitMessages","timePerChar"],...eo("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","splitMessages","timePerChar")},bd={$id:(0,Zt.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...eo("remoteJid","action")};var es=require("uuid");var to=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),za={$id:(0,es.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},agentUrl:{type:"string"},apiKey:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["enabled","agentUrl","triggerType"],...to("enabled","agentUrl","triggerType")},Id={$id:(0,es.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...to("remoteJid","status")},Cd={$id:(0,es.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},botIdFallback:{type:"string"},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","splitMessages","timePerChar"],...to("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","splitMessages","timePerChar")},Md={$id:(0,es.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...to("remoteJid","action")};var ts=require("uuid");var so=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),Xa={$id:(0,ts.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},apiUrl:{type:"string"},apiKey:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["enabled","apiUrl","triggerType"],...so("enabled","apiUrl","triggerType")},vd={$id:(0,ts.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...so("remoteJid","status")},Nd={$id:(0,ts.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},botIdFallback:{type:"string"},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","splitMessages","timePerChar"],...so("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","splitMessages","timePerChar")},_d={$id:(0,ts.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...so("remoteJid","action")};var ss=require("uuid");var io=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),Za={$id:(0,ss.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},apiUrl:{type:"string"},apiKey:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["enabled","apiUrl","triggerType"],...io("enabled","apiUrl","triggerType")},Rd={$id:(0,ss.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...io("remoteJid","status")},Od={$id:(0,ss.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},flowiseIdFallback:{type:"string"},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids"],...io("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids")},Pd={$id:(0,ss.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...io("remoteJid","action")};var is=require("uuid");var oo=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),ec={$id:(0,is.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},webhookUrl:{type:"string"},basicAuthUser:{type:"string"},basicAuthPassword:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["enabled","webhookUrl","triggerType"],...oo("enabled","webhookUrl","triggerType")},xd={$id:(0,is.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...oo("remoteJid","status")},kd={$id:(0,is.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},botIdFallback:{type:"string"},splitMessages:{type:"boolean"},timePerChar:{type:"integer"}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","splitMessages","timePerChar"],...oo("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","splitMessages","timePerChar")},Dd={$id:(0,is.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...oo("remoteJid","action")};var Lt=require("uuid");var os=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),tc={$id:(0,Lt.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},openaiCredsId:{type:"string"},botType:{type:"string",enum:["assistant","chatCompletion"]},assistantId:{type:"string"},functionUrl:{type:"string"},model:{type:"string"},systemMessages:{type:"array",items:{type:"string"}},assistantMessages:{type:"array",items:{type:"string"}},userMessages:{type:"array",items:{type:"string"}},maxTokens:{type:"integer"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","openaiCredsId","botType","triggerType"],...os("enabled","openaiCredsId","botType","triggerType")},Ld={$id:(0,Lt.v4)(),type:"object",properties:{name:{type:"string"},apiKey:{type:"string"}},required:["name","apiKey"],...os("name","apiKey")},Bd={$id:(0,Lt.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...os("remoteJid","status")},Ud={$id:(0,Lt.v4)(),type:"object",properties:{openaiCredsId:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},speechToText:{type:"boolean"},ignoreJids:{type:"array",items:{type:"string"}},openaiIdFallback:{type:"string"}},required:["openaiCredsId","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids"],...os("openaiCredsId","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids")},$d={$id:(0,Lt.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...os("remoteJid","action")};var Bt=require("uuid");var ns=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),sc={$id:(0,Bt.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},url:{type:"string"},typebot:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","url","typebot","triggerType"],...ns("enabled","url","typebot","triggerType")},Fd={$id:(0,Bt.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...ns("remoteJid","status")},Wd={$id:(0,Bt.v4)(),type:"object",properties:{remoteJid:{type:"string"},url:{type:"string"},typebot:{type:"string"}},required:["remoteJid","url","typebot"],...ns("remoteJid","url","typebot")},Jd={$id:(0,Bt.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},typebotIdFallback:{type:"string"},ignoreJids:{type:"array",items:{type:"string"}}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe"],...ns("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe")},qd={$id:(0,Bt.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...ns("remoteJid","action")};var Hd=require("uuid");var Vd=require("uuid");var km=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),Gd={$id:(0,Vd.v4)(),type:"object",properties:{pusher:{type:"object",properties:{enabled:{type:"boolean"},appId:{type:"string"},key:{type:"string"},secret:{type:"string"},cluster:{type:"string"},useTLS:{type:"boolean"},events:{type:"array",minItems:0,items:{type:"string",enum:Y.events}}},required:["enabled","appId","key","secret","cluster","useTLS"],...km("enabled","appId","key","secret","cluster","useTLS")}},required:["pusher"]};var Kd=require("uuid");var Dm=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),jd={$id:(0,Kd.v4)(),type:"object",properties:{webhook:{type:"object",properties:{enabled:{type:"boolean"},url:{type:"string"},headers:{type:"object"},byEvents:{type:"boolean"},base64:{type:"boolean"},events:{type:"array",minItems:0,items:{type:"string",enum:Y.events}}},required:["enabled","url"],...Dm("enabled","url")}},required:["webhook"]};var $e={$id:(0,Hd.v4)(),type:"object",properties:{websocket:{$ref:"#/$defs/event"},rabbitmq:{$ref:"#/$defs/event"},nats:{$ref:"#/$defs/event"},sqs:{$ref:"#/$defs/event"},kafka:{$ref:"#/$defs/event"}},$defs:{event:{type:"object",properties:{enabled:{type:"boolean",enum:[!0,!1]},events:{type:"array",minItems:0,items:{type:"string",enum:Y.events}}},required:["enabled"]}}};var Yd=require("express");var ic=class ic extends D{constructor(...e){super();a(this,"router",(0,Yd.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Sd,ClassRef:Yi,execute:l((n,r)=>Ki.createChatwoot(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ki.findChatwoot(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("webhook"),async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l((n,r)=>Ki.receiveWebhook(n,r),"execute")});i.status(E.OK).json(o)})}};l(ic,"ChatwootRouter");var no=ic;var oc=class oc{constructor(){a(this,"remoteJid");a(this,"action")}};l(oc,"IgnoreJidDto");var pe=oc;var nc=class nc{constructor(){a(this,"enabled");a(this,"description");a(this,"expire");a(this,"keywordFinish");a(this,"delayMessage");a(this,"unknownMessage");a(this,"listeningFromMe");a(this,"stopBotFromMe");a(this,"keepOpen");a(this,"debounceTime");a(this,"triggerType");a(this,"triggerOperator");a(this,"triggerValue");a(this,"ignoreJids");a(this,"splitMessages");a(this,"timePerChar")}};l(nc,"BaseChatbotDto");var ue=nc,rc=class rc{constructor(){a(this,"expire");a(this,"keywordFinish");a(this,"delayMessage");a(this,"unknownMessage");a(this,"listeningFromMe");a(this,"stopBotFromMe");a(this,"keepOpen");a(this,"debounceTime");a(this,"ignoreJids");a(this,"splitMessages");a(this,"timePerChar");a(this,"fallbackId")}};l(rc,"BaseChatbotSettingDto");var de=rc;var ac=class ac extends ue{constructor(){super(...arguments);a(this,"botType");a(this,"apiUrl");a(this,"apiKey")}};l(ac,"DifyDto");var rs=ac,cc=class cc extends de{constructor(){super(...arguments);a(this,"difyIdFallback")}};l(cc,"DifySettingDto");var ro=cc;var Qd=require("express");var lc=class lc extends D{constructor(...e){super();a(this,"router",(0,Qd.Router)());this.router.post(this.routerPath("create"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Qa,ClassRef:rs,execute:l((n,r)=>Te.createBot(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Te.findBot(n),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetch/:difyId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Te.fetchBot(n,t.params.difyId),"execute")});i.status(E.OK).json(o)}).put(this.routerPath("update/:difyId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Qa,ClassRef:rs,execute:l((n,r)=>Te.updateBot(n,t.params.difyId,r),"execute")});i.status(E.OK).json(o)}).delete(this.routerPath("delete/:difyId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Te.deleteBot(n,t.params.difyId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("settings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Ad,ClassRef:ro,execute:l((n,r)=>Te.settings(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Te.fetchSettings(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Td,ClassRef:_,execute:l((n,r)=>Te.changeStatus(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSessions/:difyId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Te.fetchSessions(n,t.params.difyId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:bd,ClassRef:pe,execute:l((n,r)=>Te.ignoreJid(n,r),"execute")});i.status(E.OK).json(o)})}};l(lc,"DifyRouter");var ao=lc;var pc=class pc{constructor(){a(this,"name");a(this,"apiKey")}};l(pc,"OpenaiCredsDto");var co=pc,uc=class uc extends ue{constructor(){super(...arguments);a(this,"openaiCredsId");a(this,"botType");a(this,"assistantId");a(this,"functionUrl");a(this,"model");a(this,"systemMessages");a(this,"assistantMessages");a(this,"userMessages");a(this,"maxTokens")}};l(uc,"OpenaiDto");var as=uc,dc=class dc extends de{constructor(){super(...arguments);a(this,"openaiCredsId");a(this,"openaiIdFallback");a(this,"speechToText")}};l(dc,"OpenaiSettingDto");var lo=dc;var zd=require("express");var hc=class hc extends D{constructor(...e){super();a(this,"router",(0,zd.Router)());this.router.post(this.routerPath("creds"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Ld,ClassRef:co,execute:l((n,r)=>ie.createOpenaiCreds(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("creds"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ie.findOpenaiCreds(n),"execute")});i.status(E.OK).json(o)}).delete(this.routerPath("creds/:openaiCredsId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ie.deleteCreds(n,t.params.openaiCredsId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("create"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:tc,ClassRef:as,execute:l((n,r)=>ie.createBot(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ie.findBot(n),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetch/:openaiBotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ie.fetchBot(n,t.params.openaiBotId),"execute")});i.status(E.OK).json(o)}).put(this.routerPath("update/:openaiBotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:tc,ClassRef:as,execute:l((n,r)=>ie.updateBot(n,t.params.openaiBotId,r),"execute")});i.status(E.OK).json(o)}).delete(this.routerPath("delete/:openaiBotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ie.deleteBot(n,t.params.openaiBotId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("settings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Ud,ClassRef:lo,execute:l((n,r)=>ie.settings(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ie.fetchSettings(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Bd,ClassRef:_,execute:l((n,r)=>ie.changeStatus(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSessions/:openaiBotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ie.fetchSessions(n,t.params.openaiBotId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:$d,ClassRef:pe,execute:l((n,r)=>ie.ignoreJid(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("getModels"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ie.getModels(n,t.query.openaiCredsId),"execute")});i.status(E.OK).json(o)})}};l(hc,"OpenaiRouter");var po=hc;var mc=class mc extends ue{constructor(){super(...arguments);a(this,"url");a(this,"typebot")}};l(mc,"TypebotDto");var cs=mc,gc=class gc extends de{constructor(){super(...arguments);a(this,"typebotIdFallback")}};l(gc,"TypebotSettingDto");var uo=gc;var Xd=require("express");var fc=class fc extends D{constructor(...e){super();a(this,"router",(0,Xd.Router)());this.router.post(this.routerPath("create"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:sc,ClassRef:cs,execute:l((n,r)=>ye.createBot(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ye.findBot(n),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetch/:typebotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ye.fetchBot(n,t.params.typebotId),"execute")});i.status(E.OK).json(o)}).put(this.routerPath("update/:typebotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:sc,ClassRef:cs,execute:l((n,r)=>ye.updateBot(n,t.params.typebotId,r),"execute")});i.status(E.OK).json(o)}).delete(this.routerPath("delete/:typebotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ye.deleteBot(n,t.params.typebotId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("settings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Jd,ClassRef:uo,execute:l((n,r)=>ye.settings(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ye.fetchSettings(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("start"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Wd,ClassRef:_,execute:l((n,r)=>ye.startBot(n,r),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Fd,ClassRef:_,execute:l((n,r)=>ye.changeStatus(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSessions/:typebotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>ye.fetchSessions(n,t.params.typebotId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:qd,ClassRef:pe,execute:l((n,r)=>ye.ignoreJid(n,r),"execute")});i.status(E.OK).json(o)})}};l(fc,"TypebotRouter");var ho=fc;var ih=require("express");var Zd=require("express");var yc=class yc extends ue{constructor(){super(...arguments);a(this,"agentUrl");a(this,"apiKey")}};l(yc,"EvoaiDto");var ls=yc,wc=class wc extends de{constructor(){super(...arguments);a(this,"evoaiIdFallback")}};l(wc,"EvoaiSettingDto");var mo=wc;var Ec=class Ec extends D{constructor(...e){super();a(this,"router",(0,Zd.Router)());this.router.post(this.routerPath("create"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:za,ClassRef:ls,execute:l((n,r)=>Ce.createBot(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ce.findBot(n),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetch/:evoaiId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ce.fetchBot(n,t.params.evoaiId),"execute")});i.status(E.OK).json(o)}).put(this.routerPath("update/:evoaiId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:za,ClassRef:ls,execute:l((n,r)=>Ce.updateBot(n,t.params.evoaiId,r),"execute")});i.status(E.OK).json(o)}).delete(this.routerPath("delete/:evoaiId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ce.deleteBot(n,t.params.evoaiId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("settings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Cd,ClassRef:mo,execute:l((n,r)=>Ce.settings(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ce.fetchSettings(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Id,ClassRef:_,execute:l((n,r)=>Ce.changeStatus(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSessions/:evoaiId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ce.fetchSessions(n,t.params.evoaiId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Md,ClassRef:pe,execute:l((n,r)=>Ce.ignoreJid(n,r),"execute")});i.status(E.OK).json(o)})}};l(Ec,"EvoaiRouter");var go=Ec;var eh=require("express");var Sc=class Sc extends ue{constructor(){super(...arguments);a(this,"apiUrl");a(this,"apiKey")}};l(Sc,"EvolutionBotDto");var ps=Sc,Tc=class Tc extends de{constructor(){super(...arguments);a(this,"botIdFallback")}};l(Tc,"EvolutionBotSettingDto");var fo=Tc;var Ac=class Ac extends D{constructor(...e){super();a(this,"router",(0,eh.Router)());this.router.post(this.routerPath("create"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Xa,ClassRef:ps,execute:l((n,r)=>Ae.createBot(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ae.findBot(n),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetch/:evolutionBotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ae.fetchBot(n,t.params.evolutionBotId),"execute")});i.status(E.OK).json(o)}).put(this.routerPath("update/:evolutionBotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Xa,ClassRef:ps,execute:l((n,r)=>Ae.updateBot(n,t.params.evolutionBotId,r),"execute")});i.status(E.OK).json(o)}).delete(this.routerPath("delete/:evolutionBotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ae.deleteBot(n,t.params.evolutionBotId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("settings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Nd,ClassRef:fo,execute:l((n,r)=>Ae.settings(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ae.fetchSettings(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:vd,ClassRef:_,execute:l((n,r)=>Ae.changeStatus(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSessions/:evolutionBotId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ae.fetchSessions(n,t.params.evolutionBotId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:_d,ClassRef:pe,execute:l((n,r)=>Ae.ignoreJid(n,r),"execute")});i.status(E.OK).json(o)})}};l(Ac,"EvolutionBotRouter");var yo=Ac;var th=require("express");var bc=class bc extends ue{constructor(){super(...arguments);a(this,"apiUrl");a(this,"apiKey")}};l(bc,"FlowiseDto");var us=bc,Ic=class Ic extends de{constructor(){super(...arguments);a(this,"flowiseIdFallback")}};l(Ic,"FlowiseSettingDto");var wo=Ic;var Cc=class Cc extends D{constructor(...e){super();a(this,"router",(0,th.Router)());this.router.post(this.routerPath("create"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Za,ClassRef:us,execute:l((n,r)=>be.createBot(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>be.findBot(n),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetch/:flowiseId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>be.fetchBot(n,t.params.flowiseId),"execute")});i.status(E.OK).json(o)}).put(this.routerPath("update/:flowiseId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Za,ClassRef:us,execute:l((n,r)=>be.updateBot(n,t.params.flowiseId,r),"execute")});i.status(E.OK).json(o)}).delete(this.routerPath("delete/:flowiseId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>be.deleteBot(n,t.params.flowiseId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("settings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Od,ClassRef:wo,execute:l((n,r)=>be.settings(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>be.fetchSettings(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Rd,ClassRef:_,execute:l((n,r)=>be.changeStatus(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSessions/:flowiseId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>be.fetchSessions(n,t.params.flowiseId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Pd,ClassRef:pe,execute:l((n,r)=>be.ignoreJid(n,r),"execute")});i.status(E.OK).json(o)})}};l(Cc,"FlowiseRouter");var Eo=Cc;var sh=require("express");var Mc=class Mc extends ue{constructor(){super(...arguments);a(this,"webhookUrl");a(this,"basicAuthUser");a(this,"basicAuthPass")}};l(Mc,"N8nDto");var ds=Mc,vc=class vc extends de{};l(vc,"N8nSettingDto");var So=vc;var Nc=class Nc extends D{constructor(...e){super();a(this,"router",(0,sh.Router)());this.router.post(this.routerPath("create"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:ec,ClassRef:ds,execute:l((n,r)=>Ie.createBot(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ie.findBot(n),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetch/:n8nId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ie.fetchBot(n,t.params.n8nId),"execute")});i.status(E.OK).json(o)}).put(this.routerPath("update/:n8nId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:ec,ClassRef:ds,execute:l((n,r)=>Ie.updateBot(n,t.params.n8nId,r),"execute")});i.status(E.OK).json(o)}).delete(this.routerPath("delete/:n8nId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ie.deleteBot(n,t.params.n8nId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("settings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:kd,ClassRef:So,execute:l((n,r)=>Ie.settings(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ie.fetchSettings(n),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:xd,ClassRef:_,execute:l((n,r)=>Ie.changeStatus(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchSessions/:n8nId"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Ie.fetchSessions(n,t.params.n8nId),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Dd,ClassRef:pe,execute:l((n,r)=>Ie.ignoreJid(n,r),"execute")});i.status(E.OK).json(o)})}};l(Nc,"N8nRouter");var To=Nc;var _c=class _c{constructor(...s){a(this,"router");this.router=(0,ih.Router)(),this.router.use("/evolutionBot",new yo(...s).router),this.router.use("/chatwoot",new no(...s).router),this.router.use("/typebot",new ho(...s).router),this.router.use("/openai",new po(...s).router),this.router.use("/dify",new ao(...s).router),this.router.use("/flowise",new Eo(...s).router),this.router.use("/n8n",new To(...s).router),this.router.use("/evoai",new go(...s).router)}};l(_c,"ChatbotRouter");var Ao=_c;var oh=require("express");var Rc=class Rc extends D{constructor(...e){super();a(this,"router",(0,oh.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:$e,ClassRef:ce,execute:l((n,r)=>H.kafka.set(n.instanceName,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>H.kafka.get(n.instanceName),"execute")});i.status(E.OK).json(o)})}};l(Rc,"KafkaRouter");var bo=Rc;var nh=require("express");var Oc=class Oc extends D{constructor(...e){super();a(this,"router",(0,nh.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:$e,ClassRef:ce,execute:l((n,r)=>H.nats.set(n.instanceName,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>H.nats.get(n.instanceName),"execute")});i.status(E.OK).json(o)})}};l(Oc,"NatsRouter");var Io=Oc;var rh=require("express");var Pc=class Pc extends D{constructor(...e){super();a(this,"router",(0,rh.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Gd,ClassRef:ce,execute:l((n,r)=>H.pusher.set(n.instanceName,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>H.pusher.get(n.instanceName),"execute")});i.status(E.OK).json(o)})}};l(Pc,"PusherRouter");var Co=Pc;var ah=require("express");var xc=class xc extends D{constructor(...e){super();a(this,"router",(0,ah.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:$e,ClassRef:ce,execute:l((n,r)=>H.rabbitmq.set(n.instanceName,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>H.rabbitmq.get(n.instanceName),"execute")});i.status(E.OK).json(o)})}};l(xc,"RabbitmqRouter");var Mo=xc;var ch=require("express");var kc=class kc extends D{constructor(...e){super();a(this,"router",(0,ch.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:$e,ClassRef:ce,execute:l((n,r)=>H.sqs.set(n.instanceName,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>H.sqs.get(n.instanceName),"execute")});i.status(E.OK).json(o)})}};l(kc,"SqsRouter");var vo=kc;var lh=require("express");var Dc=class Dc extends D{constructor(e,...t){super();a(this,"configService");a(this,"router",(0,lh.Router)());this.configService=e,this.router.post(this.routerPath("set"),...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:jd,ClassRef:ce,execute:l((r,c)=>H.webhook.set(r.instanceName,c),"execute")});o.status(E.CREATED).json(n)}).get(this.routerPath("find"),...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:P,ClassRef:_,execute:l(r=>H.webhook.get(r.instanceName),"execute")});o.status(E.OK).json(n)})}};l(Dc,"WebhookRouter");var No=Dc;var ph=require("express");var Lc=class Lc extends D{constructor(...e){super();a(this,"router",(0,ph.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:$e,ClassRef:ce,execute:l((n,r)=>H.websocket.set(n.instanceName,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>H.websocket.get(n.instanceName),"execute")});i.status(E.OK).json(o)})}};l(Lc,"WebsocketRouter");var _o=Lc;var uh=require("express");var Bc=class Bc{constructor(s,...e){a(this,"router");this.router=(0,uh.Router)(),this.router.use("/webhook",new No(s,...e).router),this.router.use("/websocket",new _o(...e).router),this.router.use("/rabbitmq",new Mo(...e).router),this.router.use("/nats",new Io(...e).router),this.router.use("/pusher",new Co(...e).router),this.router.use("/sqs",new vo(...e).router),this.router.use("/kafka",new bo(...e).router)}};l(Bc,"EventRouter");var Ro=Bc;var Uc=class Uc{constructor(){a(this,"id");a(this,"type");a(this,"messageId");a(this,"expiry")}};l(Uc,"MediaDto");var hs=Uc;var $c=require("uuid");var dh=l((...h)=>{let s={};return h.forEach(e=>s[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...h]}},then:{properties:s}}},"isNotEmpty"),hh={$id:(0,$c.v4)(),type:"object",properties:{id:{type:"string"},type:{type:"string"},messageId:{type:"integer"}},...dh("id","type","messageId")},mh={$id:(0,$c.v4)(),type:"object",properties:{id:{type:"string",pattern:"\\d+",minLength:1},expiry:{type:"string",pattern:"\\d+",minLength:1}},...dh("id"),required:["id"]};var gh=require("express");var Fc=class Fc extends D{constructor(...e){super();a(this,"router",(0,gh.Router)());this.router.post(this.routerPath("getMedia"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:hh,ClassRef:hs,execute:l((n,r)=>xa.getMedia(n,r),"execute")});i.status(E.CREATED).json(o)}).post(this.routerPath("getMediaUrl"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:mh,ClassRef:hs,execute:l((n,r)=>xa.getMediaUrl(n,r),"execute")});i.status(E.OK).json(o)})}};l(Fc,"S3Router");var Oo=Fc;var fh=require("express");var Wc=class Wc{constructor(...s){a(this,"router");this.router=(0,fh.Router)(),this.router.use("/s3",new Oo(...s).router)}};l(Wc,"StorageRouter");var Po=Wc;var vh=require("express"),An=x(require("fs")),Nh=x(require("mime-types")),rt=x(require("path"));function nt(h,s){let e=h.template||h,t=e.error_user_title||e.message||"Unknown error",i=e.error_user_msg||e.message||"Unknown error";return{status:E.BAD_REQUEST,error:"Bad Request",message:t,details:{whatsapp_error:i,whatsapp_code:e.code||"UNKNOWN_ERROR",error_user_title:t,error_user_msg:i,error_type:e.type||"UNKNOWN",error_subcode:e.error_subcode||null,fbtrace_id:e.fbtrace_id||null,context:s,type:"whatsapp_api_error"},timestamp:new Date().toISOString()}}l(nt,"createMetaErrorResponse");var yh=require("express");var Jc=class Jc extends D{constructor(...e){super();a(this,"router",(0,yh.Router)());this.router.post(this.routerPath("getCatalog"),...e,async(t,i)=>{try{let o=await this.dataValidate({request:t,schema:Su,ClassRef:et,execute:l((n,r)=>Da.fetchCatalog(n,r),"execute")});return i.status(E.OK).json(o)}catch(o){console.error("Business catalog error:",o);let n=nt(o,"business_catalog");return i.status(n.status).json(n)}}).post(this.routerPath("getCollections"),...e,async(t,i)=>{try{let o=await this.dataValidate({request:t,schema:Tu,ClassRef:et,execute:l((n,r)=>Da.fetchCollections(n,r),"execute")});return i.status(E.OK).json(o)}catch(o){console.error("Business collections error:",o);let n=nt(o,"business_collections");return i.status(n.status).json(n)}})}};l(Jc,"BusinessRouter");var xo=Jc;var Vc=class Vc{constructor(){a(this,"number")}};l(Vc,"Metadata");var qc=Vc,Gc=class Gc extends qc{constructor(){super(...arguments);a(this,"isVideo");a(this,"callDuration")}};l(Gc,"OfferCallDto");var ko=Gc;var wh=require("express");var Kc=class Kc extends D{constructor(...e){super();a(this,"router",(0,wh.Router)());this.router.post(this.routerPath("offer"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Qu,ClassRef:ko,execute:l((n,r)=>ru.offerCall(n,r),"execute")});return i.status(E.CREATED).json(o)})}};l(Kc,"CallRouter");var Do=Kc;var Eh=require("express");var jc=class jc extends D{constructor(...e){super();a(this,"router",(0,Eh.Router)());this.router.post(this.routerPath("whatsappNumbers"),...e,async(t,i)=>{try{let o=await this.dataValidate({request:t,schema:Au,ClassRef:Ws,execute:l((n,r)=>Q.whatsappNumber(n,r),"execute")});return i.status(E.OK).json(o)}catch(o){return console.log(o),i.status(E.BAD_REQUEST).json(o)}}).post(this.routerPath("markMessageAsRead"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:bu,ClassRef:Vs,execute:l((n,r)=>Q.readMessage(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("archiveChat"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Iu,ClassRef:Gs,execute:l((n,r)=>Q.archiveChat(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("markChatUnread"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Cu,ClassRef:Ks,execute:l((n,r)=>Q.markChatUnread(n,r),"execute")});return i.status(E.CREATED).json(o)}).delete(this.routerPath("deleteMessageForEveryone"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Mu,ClassRef:Hs,execute:l((n,r)=>Q.deleteMessage(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("fetchProfilePictureUrl"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:zt,ClassRef:et,execute:l((n,r)=>Q.fetchProfilePicture(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("getBase64FromMediaMessage"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:null,ClassRef:Fs,execute:l((n,r)=>Q.getBase64FromMediaMessage(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("updateMessage"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:vu,ClassRef:zs,execute:l((n,r)=>Q.updateMessage(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("sendPresence"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Nu,ClassRef:Qs,execute:l((n,r)=>Q.sendPresence(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("updateBlockStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:_u,ClassRef:Xs,execute:l((n,r)=>Q.blockUser(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("findContacts"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Ya,ClassRef:ht,execute:l((n,r)=>Q.fetchContacts(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("findMessages"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Ru,ClassRef:ht,execute:l((n,r)=>Q.fetchMessages(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("findStatusMessage"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Ou,ClassRef:ht,execute:l((n,r)=>Q.fetchStatusMessage(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("findChats"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Ya,ClassRef:ht,execute:l((n,r)=>Q.fetchChats(n,r),"execute")});return i.status(E.OK).json(o)}).get(this.routerPath("findChatByRemoteJid"),...e,async(t,i)=>{let o=t.params,{remoteJid:n}=t.query;if(!n)return i.status(E.BAD_REQUEST).json({error:"remoteJid is a required query parameter"});let r=await Q.findChatByRemoteJid(o,n);return i.status(E.OK).json(r)}).post(this.routerPath("fetchBusinessProfile"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:zt,ClassRef:vt,execute:l((n,r)=>Q.fetchBusinessProfile(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("fetchProfile"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Du,ClassRef:et,execute:l((n,r)=>Q.fetchProfile(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("updateProfileName"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:xu,ClassRef:Js,execute:l((n,r)=>Q.updateProfileName(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("updateProfileStatus"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:ku,ClassRef:qs,execute:l((n,r)=>Q.updateProfileStatus(n,r),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("updateProfilePicture"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:zt,ClassRef:vt,execute:l((n,r)=>Q.updateProfilePicture(n,r),"execute")});return i.status(E.OK).json(o)}).delete(this.routerPath("removeProfilePicture"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:zt,ClassRef:vt,execute:l(n=>Q.removeProfilePicture(n),"execute")});return i.status(E.OK).json(o)}).get(this.routerPath("fetchPrivacySettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:null,ClassRef:_,execute:l(n=>Q.fetchPrivacySettings(n),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("updatePrivacySettings"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Pu,ClassRef:js,execute:l((n,r)=>Q.updatePrivacySettings(n,r),"execute")});return i.status(E.CREATED).json(o)})}};l(jc,"ChatRouter");var Lo=jc;var Hc=class Hc{constructor(){a(this,"subject");a(this,"participants");a(this,"description");a(this,"promoteParticipants")}};l(Hc,"CreateGroupDto");var Bo=Hc,Yc=class Yc{constructor(){a(this,"groupJid");a(this,"image")}};l(Yc,"GroupPictureDto");var Uo=Yc,Qc=class Qc{constructor(){a(this,"groupJid");a(this,"subject")}};l(Qc,"GroupSubjectDto");var $o=Qc,zc=class zc{constructor(){a(this,"groupJid");a(this,"description")}};l(zc,"GroupDescriptionDto");var Fo=zc,Xc=class Xc{constructor(){a(this,"groupJid")}};l(Xc,"GroupJid");var xe=Xc,Zc=class Zc{constructor(){a(this,"getParticipants")}};l(Zc,"GetParticipant");var Wo=Zc,el=class el{constructor(){a(this,"inviteCode")}};l(el,"GroupInvite");var Jo=el,tl=class tl{constructor(){a(this,"inviteCode")}};l(tl,"AcceptGroupInvite");var qo=tl,sl=class sl{constructor(){a(this,"groupJid");a(this,"description");a(this,"numbers")}};l(sl,"GroupSendInvite");var Vo=sl,il=class il extends xe{constructor(){super(...arguments);a(this,"action");a(this,"participants")}};l(il,"GroupUpdateParticipantDto");var Go=il,ol=class ol extends xe{constructor(){super(...arguments);a(this,"action")}};l(ol,"GroupUpdateSettingDto");var Ko=ol,nl=class nl extends xe{constructor(){super(...arguments);a(this,"expiration")}};l(nl,"GroupToggleEphemeralDto");var jo=nl;var Sh=require("express");var rl=class rl extends D{constructor(...e){super();a(this,"router",(0,Sh.Router)());this.router.post(this.routerPath("create"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Lu,ClassRef:Bo,execute:l((n,r)=>oe.createGroup(n,r),"execute")});i.status(E.CREATED).json(o)}).post(this.routerPath("updateGroupSubject"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Gu,ClassRef:$o,execute:l((n,r)=>oe.updateGroupSubject(n,r),"execute")});i.status(E.CREATED).json(o)}).post(this.routerPath("updateGroupPicture"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Vu,ClassRef:Uo,execute:l((n,r)=>oe.updateGroupPicture(n,r),"execute")});i.status(E.CREATED).json(o)}).post(this.routerPath("updateGroupDescription"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Ku,ClassRef:Fo,execute:l((n,r)=>oe.updateGroupDescription(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("findGroupInfos"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Xt,ClassRef:xe,execute:l((n,r)=>oe.findGroupInfo(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("fetchAllGroups"),...e,async(t,i)=>{let o=await this.getParticipantsValidate({request:t,schema:Bu,ClassRef:Wo,execute:l((n,r)=>oe.fetchAllGroups(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("participants"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Xt,ClassRef:xe,execute:l((n,r)=>oe.findParticipants(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("inviteCode"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Xt,ClassRef:xe,execute:l((n,r)=>oe.inviteCode(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("inviteInfo"),...e,async(t,i)=>{let o=await this.inviteCodeValidate({request:t,schema:$u,ClassRef:Jo,execute:l((n,r)=>oe.inviteInfo(n,r),"execute")});i.status(E.OK).json(o)}).get(this.routerPath("acceptInviteCode"),...e,async(t,i)=>{let o=await this.inviteCodeValidate({request:t,schema:Fu,ClassRef:qo,execute:l((n,r)=>oe.acceptInviteCode(n,r),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("sendInvite"),...e,async(t,i)=>{let o=await this.groupNoValidate({request:t,schema:Uu,ClassRef:Vo,execute:l((n,r)=>oe.sendInvite(n,r),"execute")});i.status(E.OK).json(o)}).post(this.routerPath("revokeInviteCode"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Xt,ClassRef:xe,execute:l((n,r)=>oe.revokeInviteCode(n,r),"execute")});i.status(E.CREATED).json(o)}).post(this.routerPath("updateParticipant"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Wu,ClassRef:Go,execute:l((n,r)=>oe.updateGParticipate(n,r),"execute")});i.status(E.CREATED).json(o)}).post(this.routerPath("updateSetting"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:Ju,ClassRef:Ko,execute:l((n,r)=>oe.updateGSetting(n,r),"execute")});i.status(E.CREATED).json(o)}).post(this.routerPath("toggleEphemeral"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:qu,ClassRef:jo,execute:l((n,r)=>oe.toggleEphemeral(n,r),"execute")});i.status(E.CREATED).json(o)}).delete(this.routerPath("leaveGroup"),...e,async(t,i)=>{let o=await this.groupValidate({request:t,schema:{},ClassRef:xe,execute:l((n,r)=>oe.leaveGroup(n,r),"execute")});i.status(E.OK).json(o)})}};l(rl,"GroupRouter");var Ho=rl;var Th=require("express");var al=class al extends D{constructor(e,...t){super();a(this,"configService");a(this,"router",(0,Th.Router)());this.configService=e,this.router.post("/create",...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:P,ClassRef:_,execute:l(r=>He.createInstance(r),"execute")});return o.status(E.CREATED).json(n)}).post(this.routerPath("restart"),...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:null,ClassRef:_,execute:l(r=>He.restartInstance(r),"execute")});return o.status(E.OK).json(n)}).get(this.routerPath("connect"),...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:null,ClassRef:_,execute:l(r=>He.connectToWhatsapp(r),"execute")});return o.status(E.OK).json(n)}).get(this.routerPath("connectionState"),...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:null,ClassRef:_,execute:l(r=>He.connectionState(r),"execute")});return o.status(E.OK).json(n)}).get(this.routerPath("fetchInstances",!1),...t,async(i,o)=>{let n=i.get("apikey"),r=await this.dataValidate({request:i,schema:null,ClassRef:_,execute:l(c=>He.fetchInstances(c,n),"execute")});return o.status(E.OK).json(r)}).post(this.routerPath("setPresence"),...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:yu,ClassRef:zi,execute:l((r,c)=>He.setPresence(r,c),"execute")});return o.status(E.CREATED).json(n)}).delete(this.routerPath("logout"),...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:null,ClassRef:_,execute:l(r=>He.logout(r),"execute")});return o.status(E.OK).json(n)}).delete(this.routerPath("delete"),...t,async(i,o)=>{let n=await this.dataValidate({request:i,schema:null,ClassRef:_,execute:l(r=>He.deleteInstance(r),"execute")});return o.status(E.OK).json(n)})}};l(al,"InstanceRouter");var Yo=al;var cl=class cl{constructor(){a(this,"id");a(this,"name");a(this,"color");a(this,"predefinedId")}};l(cl,"LabelDto");var Qo=cl,ll=class ll{constructor(){a(this,"number");a(this,"labelId");a(this,"action")}};l(ll,"HandleLabelDto");var zo=ll;var Ah=require("express");var pl=class pl extends D{constructor(...e){super();a(this,"router",(0,Ah.Router)());this.router.get(this.routerPath("findLabels"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:null,ClassRef:Qo,execute:l(n=>La.fetchLabels(n),"execute")});return i.status(E.OK).json(o)}).post(this.routerPath("handleLabel"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Hu,ClassRef:zo,execute:l((n,r)=>La.handleLabel(n,r),"execute")});return i.status(E.OK).json(o)})}};l(pl,"LabelRouter");var Xo=pl;var ul=class ul{constructor(){a(this,"enabled");a(this,"host");a(this,"port");a(this,"protocol");a(this,"username");a(this,"password")}};l(ul,"ProxyDto");var Zo=ul;var bh=require("express");var dl=class dl extends D{constructor(...e){super();a(this,"router",(0,bh.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:pd,ClassRef:Zo,execute:l((n,r)=>Gi.createProxy(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:P,ClassRef:_,execute:l(n=>Gi.findProxy(n),"execute")});i.status(E.OK).json(o)})}};l(dl,"ProxyRouter");var en=dl;var hl=class hl{constructor(){a(this,"number");a(this,"delay");a(this,"quoted");a(this,"linkPreview");a(this,"mentionsEveryOne");a(this,"mentioned");a(this,"encoding");a(this,"notConvertSticker")}};l(hl,"Metadata");var ve=hl,ml=class ml extends ve{constructor(){super(...arguments);a(this,"text")}};l(ml,"SendTextDto");var tn=ml;var gl=class gl extends ve{constructor(){super(...arguments);a(this,"type");a(this,"content");a(this,"statusJidList");a(this,"allContacts");a(this,"caption");a(this,"backgroundColor");a(this,"font")}};l(gl,"SendStatusDto");var sn=gl,fl=class fl extends ve{constructor(){super(...arguments);a(this,"name");a(this,"selectableCount");a(this,"values");a(this,"messageSecret")}};l(fl,"SendPollDto");var on=fl,yl=class yl extends ve{constructor(){super(...arguments);a(this,"mediatype");a(this,"mimetype");a(this,"caption");a(this,"fileName");a(this,"media")}};l(yl,"SendMediaDto");var ms=yl,wl=class wl extends ve{constructor(){super(...arguments);a(this,"video")}};l(wl,"SendPtvDto");var nn=wl,El=class El extends ve{constructor(){super(...arguments);a(this,"sticker")}};l(El,"SendStickerDto");var rn=El;var Sl=class Sl extends ve{constructor(){super(...arguments);a(this,"thumbnailUrl");a(this,"title");a(this,"description");a(this,"footer");a(this,"buttons")}};l(Sl,"SendButtonsDto");var an=Sl,Tl=class Tl extends ve{constructor(){super(...arguments);a(this,"latitude");a(this,"longitude");a(this,"name");a(this,"address")}};l(Tl,"SendLocationDto");var cn=Tl;var Al=class Al extends ve{constructor(){super(...arguments);a(this,"title");a(this,"description");a(this,"footerText");a(this,"buttonText");a(this,"sections")}};l(Al,"SendListDto");var ln=Al;var bl=class bl extends ve{constructor(){super(...arguments);a(this,"name");a(this,"language");a(this,"components");a(this,"webhookUrl")}};l(bl,"SendTemplateDto");var pn=bl,Il=class Il extends ve{constructor(){super(...arguments);a(this,"contact")}};l(Il,"SendContactDto");var un=Il,Cl=class Cl{constructor(){a(this,"key");a(this,"reaction")}};l(Cl,"SendReactionDto");var dn=Cl;var Ih=require("express"),Ml=x(require("multer"));var gs=(0,Ml.default)({storage:Ml.default.memoryStorage()}),vl=class vl extends D{constructor(...e){super();a(this,"router",(0,Ih.Router)());this.router.post(this.routerPath("sendTemplate"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:Yu,ClassRef:pn,execute:l((n,r)=>we.sendTemplate(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("sendText"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:zu,ClassRef:tn,execute:l((n,r)=>we.sendText(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("sendMedia"),...e,gs.single("file"),async(t,i)=>{let o=t.body,n=await this.dataValidate({request:t,schema:Xu,ClassRef:ms,execute:l(r=>we.sendMedia(r,o,t.file),"execute")});return i.status(E.CREATED).json(n)}).post(this.routerPath("sendPtv"),...e,gs.single("file"),async(t,i)=>{let o=t.body,n=await this.dataValidate({request:t,schema:Zu,ClassRef:nn,execute:l(r=>we.sendPtv(r,o,t.file),"execute")});return i.status(E.CREATED).json(n)}).post(this.routerPath("sendWhatsAppAudio"),...e,gs.single("file"),async(t,i)=>{let o=t.body,n=await this.dataValidate({request:t,schema:ed,ClassRef:ms,execute:l(r=>we.sendWhatsAppAudio(r,o,t.file),"execute")});return i.status(E.CREATED).json(n)}).post(this.routerPath("sendStatus"),...e,gs.single("file"),async(t,i)=>{let o=t.body,n=await this.dataValidate({request:t,schema:td,ClassRef:sn,execute:l(r=>we.sendStatus(r,o,t.file),"execute")});return i.status(E.CREATED).json(n)}).post(this.routerPath("sendSticker"),...e,gs.single("file"),async(t,i)=>{let o=t.body,n=await this.dataValidate({request:t,schema:sd,ClassRef:rn,execute:l(r=>we.sendSticker(r,o,t.file),"execute")});return i.status(E.CREATED).json(n)}).post(this.routerPath("sendLocation"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:id,ClassRef:cn,execute:l((n,r)=>we.sendLocation(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("sendContact"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:od,ClassRef:un,execute:l((n,r)=>we.sendContact(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("sendReaction"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:nd,ClassRef:dn,execute:l((n,r)=>we.sendReaction(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("sendPoll"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:rd,ClassRef:on,execute:l((n,r)=>we.sendPoll(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("sendList"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:ad,ClassRef:ln,execute:l((n,r)=>we.sendList(n,r),"execute")});return i.status(E.CREATED).json(o)}).post(this.routerPath("sendButtons"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:cd,ClassRef:an,execute:l((n,r)=>we.sendButtons(n,r),"execute")});return i.status(E.CREATED).json(o)})}};l(vl,"MessageRouter");var hn=vl;var Nl=class Nl{constructor(){a(this,"rejectCall");a(this,"msgCall");a(this,"groupsIgnore");a(this,"alwaysOnline");a(this,"readMessages");a(this,"readStatus");a(this,"syncFullHistory");a(this,"wavoipToken")}};l(Nl,"SettingsDto");var mn=Nl;var Ch=require("express");var _l=class _l extends D{constructor(...e){super();a(this,"router",(0,Ch.Router)());this.router.post(this.routerPath("set"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:dd,ClassRef:mn,execute:l((n,r)=>ka.createSettings(n,r),"execute")});i.status(E.CREATED).json(o)}).get(this.routerPath("find"),...e,async(t,i)=>{let o=await this.dataValidate({request:t,schema:null,ClassRef:_,execute:l(n=>ka.findSettings(n),"execute")});i.status(E.OK).json(o)})}};l(_l,"SettingsRouter");var gn=_l;var Rl=class Rl{constructor(){a(this,"name");a(this,"category");a(this,"allowCategoryChange");a(this,"language");a(this,"components");a(this,"webhookUrl")}};l(Rl,"TemplateDto");var fn=Rl,Ol=class Ol{constructor(){a(this,"templateId");a(this,"category");a(this,"allowCategoryChange");a(this,"ttl");a(this,"components")}};l(Ol,"TemplateEditDto");var yn=Ol,Pl=class Pl{constructor(){a(this,"name");a(this,"hsmId")}};l(Pl,"TemplateDeleteDto");var wn=Pl;var Mh=require("express");var xl=class xl extends D{constructor(e,...t){super();a(this,"configService");a(this,"router",(0,Mh.Router)());this.configService=e,this.router.post(this.routerPath("create"),...t,async(i,o)=>{try{let n=await this.dataValidate({request:i,schema:md,ClassRef:fn,execute:l((r,c)=>Yt.createTemplate(r,c),"execute")});o.status(E.CREATED).json(n)}catch(n){console.error("Template creation error:",n);let r=nt(n,"template_creation");o.status(r.status).json(r)}}).post(this.routerPath("edit"),...t,async(i,o)=>{try{let n=await this.dataValidate({request:i,schema:wd,ClassRef:yn,execute:l((r,c)=>Yt.editTemplate(r,c),"execute")});o.status(E.OK).json(n)}catch(n){console.error("Template edit error:",n);let r=nt(n,"template_edit");o.status(r.status).json(r)}}).delete(this.routerPath("delete"),...t,async(i,o)=>{try{let n=await this.dataValidate({request:i,schema:fd,ClassRef:wn,execute:l((r,c)=>Yt.deleteTemplate(r,c),"execute")});o.status(E.OK).json(n)}catch(n){console.error("Template delete error:",n);let r=nt(n,"template_delete");o.status(r.status).json(r)}}).get(this.routerPath("find"),...t,async(i,o)=>{try{let n=await this.dataValidate({request:i,schema:P,ClassRef:_,execute:l(r=>Yt.findTemplate(r),"execute")});o.status(E.OK).json(n)}catch(n){console.error("Template find error:",n);let r=nt(n,"template_find");o.status(r.status).json(r)}})}};l(xl,"TemplateRouter");var En=xl;var Tn=x(require("express")),kl=x(require("path"));var Dl=class Dl extends D{constructor(){super();a(this,"router");this.router=(0,Tn.Router)();let e=kl.default.join(process.cwd(),"manager","dist"),t=kl.default.join(e,"index.html");this.router.use(Tn.default.static(e)),this.router.get("*",(i,o)=>{o.sendFile(t)})}};l(Dl,"ViewsRouter");var Sn=Dl;var E=(function(h){return h[h.OK=200]="OK",h[h.CREATED=201]="CREATED",h[h.NOT_FOUND=404]="NOT_FOUND",h[h.FORBIDDEN=403]="FORBIDDEN",h[h.BAD_REQUEST=400]="BAD_REQUEST",h[h.UNAUTHORIZED=401]="UNAUTHORIZED",h[h.INTERNAL_SERVER_ERROR=500]="INTERNAL_SERVER_ERROR",h})(E||{}),fs=(0,vh.Router)(),Bl=b.get("SERVER"),_h=b.get("DATABASE"),Ee=[pu,uu,Ba.apikey],Lm=new du,Rh=JSON.parse(An.default.readFileSync("./package.json","utf8")),Bm=l((h,s,e)=>{let i=b.get("METRICS").ALLOWED_IPS?.split(",").map(n=>n.trim())||["127.0.0.1"],o=[h.ip,h.connection.remoteAddress,h.socket.remoteAddress,h.headers["x-forwarded-for"]].filter(n=>n!==void 0);if(i.filter(n=>o.includes(n))===0)return s.status(403).send("Forbidden: IP not allowed");e()},"metricsIPWhitelist"),Um=l((h,s,e)=>{let t=b.get("METRICS"),i=t.USER,o=t.PASSWORD;if(!i||!o)return s.status(500).send("Metrics authentication not configured");let n=h.get("Authorization");if(!n||!n.startsWith("Basic "))return s.set("WWW-Authenticate",'Basic realm="Evolution API Metrics"'),s.status(401).send("Authentication required");let r=Buffer.from(n.slice(6),"base64").toString(),[c,p]=r.split(":");if(c!==i||p!==o)return s.status(401).send("Invalid credentials");e()},"metricsBasicAuth"),Ll=b.get("METRICS");if(Ll.ENABLED){let h=[];Ll.ALLOWED_IPS&&h.push(Bm),Ll.AUTH_REQUIRED&&h.push(Um),fs.get("/metrics",...h,async(s,e)=>{e.set("Content-Type","text/plain; version=0.0.4; charset=utf-8"),e.set("Cache-Control","no-cache, no-store, must-revalidate");let t=l(p=>String(p??"").replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"'),"escapeLabel"),i=[],o=_h.CONNECTION.CLIENT_NAME||"unknown",n=Bl.URL||"";i.push("# HELP evolution_environment_info Environment information"),i.push("# TYPE evolution_environment_info gauge"),i.push(`evolution_environment_info{version="${t(Rh.version)}",clientName="${t(o)}",serverUrl="${t(n)}"} 1`);let r=U&&U.waInstances||{},c=Object.entries(r);i.push("# HELP evolution_instances_total Total number of instances"),i.push("# TYPE evolution_instances_total gauge"),i.push(`evolution_instances_total ${c.length}`),i.push("# HELP evolution_instance_up 1 if instance state is open, else 0"),i.push("# TYPE evolution_instance_up gauge"),i.push("# HELP evolution_instance_state Instance state as a labelled metric"),i.push("# TYPE evolution_instance_state gauge");for(let[p,u]of c){let d=u?.connectionStatus?.state||"unknown",f=u?.integration||"",g=d==="open"?1:0;i.push(`evolution_instance_up{instance="${t(p)}",integration="${t(f)}"} ${g}`),i.push(`evolution_instance_state{instance="${t(p)}",integration="${t(f)}",state="${t(d)}"} 1`)}e.send(i.join(`
`)+`
`)})}Bl.DISABLE_MANAGER||fs.use("/manager",new Sn().router);fs.get("/assets/*",(h,s)=>{let e=h.params[0];if(!e||e.includes("..")||e.includes("\\")||rt.default.isAbsolute(e))return s.status(403).send("Forbidden");let t=rt.default.join(process.cwd(),"manager","dist"),i=rt.default.join(t,"assets"),o=rt.default.join(i,e),n=rt.default.resolve(o),r=rt.default.resolve(i);if(!n.startsWith(r+rt.default.sep)&&n!==r)return s.status(403).send("Forbidden");An.default.existsSync(n)?(s.set("Content-Type",Nh.default.lookup(n)||"text/css"),s.send(An.default.readFileSync(n))):s.status(404).send("File not found")});fs.use((h,s,e)=>Lm.collectTelemetry(h,s,e)).get("/",async(h,s)=>{s.status(200).json({status:200,message:"Welcome to the Evolution API, it is working!",version:Rh.version,clientName:_h.CONNECTION.CLIENT_NAME,manager:Bl.DISABLE_MANAGER?void 0:`${h.protocol}://${h.get("host")}/manager`,documentation:"https://doc.evolution-api.com",whatsappWebVersion:(await Zs({})).version.join(".")})}).post("/verify-creds",Ba.apikey,async(h,s)=>{let e=b.get("FACEBOOK");return s.status(200).json({status:200,message:"Credentials are valid",facebookAppId:e.APP_ID,facebookConfigId:e.CONFIG_ID,facebookUserToken:e.USER_TOKEN})}).use("/instance",new Yo(b,...Ee).router).use("/message",new hn(...Ee).router).use("/call",new Do(...Ee).router).use("/chat",new Lo(...Ee).router).use("/business",new xo(...Ee).router).use("/group",new Ho(...Ee).router).use("/template",new En(b,...Ee).router).use("/settings",new gn(...Ee).router).use("/proxy",new en(...Ee).router).use("/label",new Xo(...Ee).router).use("",new Zi(b,...Ee).router).use("",new Ro(b,...Ee).router).use("",new Ao(...Ee).router).use("",new Po(...Ee).router);0&&(module.exports={HttpStatus,router});
/**
 * 
 *  @author jrCleber                                                             
 *  @filename use-multi-file-auth-state-provider-files.ts                              
 *  Developed by: Cleber Wilson                                                  
 *  Creation date: May 31, 2024                                                 
 *  Contact: contato@codechat.dev                                                
 * 
 *  @copyright  Cleber Wilson 2023. All rights reserved.                        
 *  Licensed under the Apache License, Version 2.0                               
 *                                                                               
 *   @license "https://github.com/code-chat-br/whatsapp-api/blob/main/LICENSE"   
 *                                                                               
 *  You may not use this file except in compliance with the License.             
 *  You may obtain a copy of the License at                                      
 *                                                                               
 *     http://www.apache.org/licenses/LICENSE-2.0                                
 *                                                                               
 *  Unless required by applicable law or agreed to in writing, software          
 *  distributed under the License is distributed on an "AS IS" BASIS,            
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.     
 *                                                                               
 *  See the License for the specific language governing permissions and          
 *  limitations under the License.                                               
 *                                                                               
 *  @type {AuthState}                                                            
 *  @function useMultiFileAuthStateRedisDb                                       
 *  @returns {Promise<AuthState>}                                                
 * 
 *  @important                                                                   
 *  For any future changes to the code in this file, it is recommended to        
 *  contain, together with the modification, the information of the developer    
 *  who changed it and the date of modification.                                 
 * 
 */
//# sourceMappingURL=index.router.js.map
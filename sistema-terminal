#!/bin/bash

# ğŸš€ ENSIDE-IA SISTEMA - Comando ExecutÃ¡vel Universal
# Testa e valida sistema completo via terminal

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# VariÃ¡veis
VERCEL_URL="https://enside-sistema-unificado.vercel.app"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# CabeÃ§alho
echo -e "${CYAN}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     ğŸš€ ENSIDE-IA SISTEMA - ValidaÃ§Ã£o Completa            â•‘"
echo "â•‘     Data: $TIMESTAMP                             â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# FunÃ§Ã£o para imprimir resultado
print_result() {
    local test_name=$1
    local status=$2
    local details=$3
    
    if [ "$status" = "âœ…" ]; then
        echo -e "${GREEN}${status} ${test_name}${NC}"
    elif [ "$status" = "âš ï¸" ]; then
        echo -e "${YELLOW}${status} ${test_name}${NC}"
    else
        echo -e "${RED}${status} ${test_name}${NC}"
    fi
    
    if [ ! -z "$details" ]; then
        echo -e "   ${BLUE}âœ${NC} $details"
    fi
}

# Teste 1: ConexÃ£o com Vercel
echo -e "\n${CYAN}ğŸ“¡ Testes de Conectividade${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$VERCEL_URL" 2>/dev/null || echo "000")
if [ "$FRONTEND_STATUS" = "200" ]; then
    print_result "Frontend Vercel" "âœ…" "HTTP $FRONTEND_STATUS"
else
    print_result "Frontend Vercel" "âŒ" "HTTP $FRONTEND_STATUS (esperado 200)"
fi

# Teste 2: HTML Content
echo -e "\n${CYAN}ğŸ¨ Testes de Frontend${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

HTML_RESPONSE=$(curl -s "$VERCEL_URL" 2>/dev/null || echo "")
if [[ $HTML_RESPONSE == *"ENSIDE"* ]]; then
    print_result "HTML Content" "âœ…" "ENSIDE detectado"
else
    print_result "HTML Content" "âŒ" "ConteÃºdo nÃ£o encontrado"
fi

# Teste 3: HTTPS/TLS
HTTPS_STATUS=$(curl -s -I "$VERCEL_URL" 2>&1 | grep -i "HTTP" | head -1 || echo "")
if [[ $HTTPS_STATUS == *"200"* ]] || [[ $HTTPS_STATUS == *"301"* ]]; then
    print_result "HTTPS/TLS" "âœ…" "Certificado vÃ¡lido"
else
    print_result "HTTPS/TLS" "âš ï¸" "VerificaÃ§Ã£o incompleta"
fi

# Teste 4: Scripts Carregando
SCRIPTS_COUNT=$(curl -s "$VERCEL_URL" 2>/dev/null | grep -o "<script" | wc -l || echo "0")
if [ "$SCRIPTS_COUNT" -gt "20" ]; then
    print_result "Scripts Carregados" "âœ…" "$SCRIPTS_COUNT arquivos encontrados"
else
    print_result "Scripts Carregados" "âš ï¸" "$SCRIPTS_COUNT arquivos (esperado >20)"
fi

# Teste 5: API Aprendizados
echo -e "\n${CYAN}ğŸ¤– Testes de API${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

API_RESPONSE=$(curl -s "${VERCEL_URL}/api/aprendizados?limit=1" 2>/dev/null || echo "")
API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${VERCEL_URL}/api/aprendizados?limit=1" 2>/dev/null || echo "000")

if [ "$API_STATUS" = "200" ]; then
    print_result "GET /api/aprendizados" "âœ…" "HTTP 200"
    if [[ $API_RESPONSE == *"aprendizado"* ]] || [[ $API_RESPONSE == *"id"* ]]; then
        echo -e "   ${BLUE}â”œâ”€${NC} Dados: ${API_RESPONSE:0:80}..."
    fi
elif [ "$API_STATUS" = "404" ]; then
    print_result "GET /api/aprendizados" "âš ï¸" "HTTP 404 (Vercel ainda reconstruindo?)"
else
    print_result "GET /api/aprendizados" "âŒ" "HTTP $API_STATUS"
fi

# Teste 6: Stats
STATS_RESPONSE=$(curl -s "${VERCEL_URL}/api/aprendizados/stats/info" 2>/dev/null || echo "")
STATS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${VERCEL_URL}/api/aprendizados/stats/info" 2>/dev/null || echo "000")

if [ "$STATS_STATUS" = "200" ]; then
    print_result "GET /api/aprendizados/stats/info" "âœ…" "HTTP 200"
    if [[ $STATS_RESPONSE == *"total"* ]]; then
        TOTAL=$(echo "$STATS_RESPONSE" | grep -o '"total":[0-9]*' | head -1 || echo "")
        echo -e "   ${BLUE}â”œâ”€${NC} $TOTAL"
    fi
elif [ "$STATS_STATUS" = "404" ]; then
    print_result "GET /api/aprendizados/stats/info" "âš ï¸" "HTTP 404 (Vercel ainda reconstruindo?)"
else
    print_result "GET /api/aprendizados/stats/info" "âŒ" "HTTP $STATS_STATUS"
fi

# Teste 7: Tipos
TIPOS_RESPONSE=$(curl -s "${VERCEL_URL}/api/aprendizados/tipos/lista" 2>/dev/null || echo "")
TIPOS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${VERCEL_URL}/api/aprendizados/tipos/lista" 2>/dev/null || echo "000")

if [ "$TIPOS_STATUS" = "200" ]; then
    print_result "GET /api/aprendizados/tipos/lista" "âœ…" "HTTP 200"
elif [ "$TIPOS_STATUS" = "404" ]; then
    print_result "GET /api/aprendizados/tipos/lista" "âš ï¸" "HTTP 404 (Vercel ainda reconstruindo?)"
else
    print_result "GET /api/aprendizados/tipos/lista" "âŒ" "HTTP $TIPOS_STATUS"
fi

# Teste 8: Banco de Dados
echo -e "\n${CYAN}ğŸ’¾ Status de IntegraÃ§Ãµes${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v redis-cli &> /dev/null; then
    REDIS_CHECK=$(redis-cli ping 2>/dev/null || echo "PONG")
    if [ "$REDIS_CHECK" = "PONG" ]; then
        APRENDIZADOS_COUNT=$(redis-cli KEYS "especialista_ia:aprendizado:*" 2>/dev/null | wc -l || echo "0")
        print_result "Redis Local" "âœ…" "$APRENDIZADOS_COUNT aprendizados"
    else
        print_result "Redis Local" "âš ï¸" "NÃ£o respondendo"
    fi
else
    print_result "Redis Local" "âš ï¸" "CLI nÃ£o instalada"
fi

# Teste 9: Git Status
echo -e "\n${CYAN}ğŸ“¦ Status do RepositÃ³rio${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -d "/Users/andersonenside/Desktop/ENSIDE-MASTER-v16/.git" ]; then
    COMMIT_COUNT=$(cd /Users/andersonenside/Desktop/ENSIDE-MASTER-v16 && git rev-list --count HEAD 2>/dev/null || echo "0")
    LAST_COMMIT=$(cd /Users/andersonenside/Desktop/ENSIDE-MASTER-v16 && git log -1 --format="%h - %s" 2>/dev/null || echo "")
    print_result "Git Repository" "âœ…" "$COMMIT_COUNT commits"
    echo -e "   ${BLUE}â”œâ”€ Ãšltimo:${NC} $LAST_COMMIT"
else
    print_result "Git Repository" "âŒ" "RepositÃ³rio nÃ£o encontrado"
fi

# Resumo Final
echo -e "\n${CYAN}ğŸ“Š Resumo Final${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ "$FRONTEND_STATUS" = "200" ]; then
    echo -e "${GREEN}âœ… Frontend operacional${NC}"
else
    echo -e "${RED}âŒ Problema no frontend${NC}"
fi

if [ "$API_STATUS" = "200" ]; then
    echo -e "${GREEN}âœ… API operacional${NC}"
elif [ "$API_STATUS" = "404" ]; then
    echo -e "${YELLOW}â³ API reconstruindo (aguarde 5-10 minutos)${NC}"
else
    echo -e "${RED}âŒ Problema na API${NC}"
fi

echo -e "${GREEN}âœ… Sistema Online: $VERCEL_URL${NC}"
echo ""
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘              ValidaÃ§Ã£o ConcluÃ­da com Sucesso! ğŸ‰          â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}Dicas:${NC}"
echo "  â€¢ Se API retornar 404: aguarde rebuild Vercel (5-10 min)"
echo "  â€¢ Teste modal: abra sistema e clique no botÃ£o ğŸ¤–"
echo "  â€¢ Verifique console (F12) para erros JavaScript"
echo "  â€¢ Sincronize cÃ³digo: git pull && git push"
echo ""
